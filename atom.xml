<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Haldirçš„åšå®¢</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://haldir65.github.io/"/>
  <updated>2020-03-18T22:24:14.500Z</updated>
  <id>https://haldir65.github.io/</id>
  
  <author>
    <name>Haldir</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexoéƒ¨ç½²ä¸ªäººåšå®¢è®°å½•</title>
    <link href="https://haldir65.github.io/2217/01/08/2017-01-08-trouble-shooting-with-my-blog/"/>
    <id>https://haldir65.github.io/2217/01/08/2017-01-08-trouble-shooting-with-my-blog/</id>
    <published>2217-01-08T18:01:01.000Z</published>
    <updated>2020-03-18T22:24:14.500Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨ hexo å†™åšå®¢ä»¥æ¥ï¼Œè®°å½•ä¸‹æ¥çš„é—®é¢˜è¶Šæ¥è¶Šå¤šã€‚åªå¸Œæœ›ä¸‹æ¬¡å†ç¢°åˆ°åŒæ ·çš„é—®é¢˜æ—¶ï¼Œä¸è¦å†å»æµªè´¹æ—¶é—´å»æŸ¥æ‰¾ã€‚å¦‚æœæƒ³è¦ç»™è‡ªå·±çš„ blog ä¸€ä¸ªå€¼å¾—ç½®é¡¶çš„æ–‡ç« çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸€ç¯‡è®°å½•ä½¿ç”¨ hexo è¿‡ç¨‹ä¸­çš„ä¸€äº›è§£å†³é—®é¢˜çš„æ–¹æ³•çš„æ–‡ç« æ˜¯å†åˆé€‚ä¸è¿‡çš„äº†ã€‚</br><br><img src="https://api1.foster66.xyz/static/imgs/40164340_40164340_1414330224938_mthumb.jpg" alt=""></p><a id="more"></a><h2 id="1-ç»å¸¸æ›´æ–°-yilia-çš„-theme"><a href="#1-ç»å¸¸æ›´æ–°-yilia-çš„-theme" class="headerlink" title="1. ç»å¸¸æ›´æ–° yilia çš„ theme"></a>1. ç»å¸¸æ›´æ–° yilia çš„ theme</h2><p><a href="https://github.com/litten/hexo-theme-yilia">yilia</a>ä¸»é¢˜ç»å¸¸ä¼šæ›´æ–°ï¼ŒåŠæ—¶æ›´æ–° theme ä¼šå‘ç°å¾ˆå¤šæ–°çš„ç‰¹æ€§åŠ bug fix</p><h2 id="2-éƒ¨ç½²ç›¸å…³"><a href="#2-éƒ¨ç½²ç›¸å…³" class="headerlink" title="2. éƒ¨ç½²ç›¸å…³"></a>2. éƒ¨ç½²ç›¸å…³</h2><ul><li>éƒ¨ç½²åˆ° github</li></ul><pre><code class="javascript">hexo clean //æ¸…é™¤ç¼“å­˜hexo g -d //ä¸€æ­¥åˆ°ä½ = hexo g + hexo dhexo s //localost:4000æœ¬åœ°é¢„è§ˆ</code></pre><ul><li>éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°çš„ä¸€äº›é”™è¯¯</li></ul><pre><code class="javascript">$ hexo g -dINFO  Start processingERROR Process failed: _posts/2016-12-10-adb-command.mdYAMLException: can not read a block mapping entry; a multiline key may not be an implicit key at line 3, column 11:    categories:  [æŠ€æœ¯]              ^    at generateError (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:162:10)    at throwError (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:168:9)    at readBlockMapping (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:1040:9)    at composeNode (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:1326:12)    at readDocument (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:1488:3)    at loadDocuments (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:1544:5)    at Object.load (D:\Blog\github\node_modules\hexo\node_modules\js-yaml\lib\js-yaml\loader.js:1561:19)    at parseYAML (D:\Blog\github\node_modules\hexo\node_modules\hexo-front-matter\lib\front_matter.js:80:21)    at parse (D:\Blog\github\node_modules\hexo\node_modules\hexo-front-matter\lib\front_matter.js:56:12)    at D:\Blog\github\node_modules\hexo\lib\plugins\processor\post.js:52:18    at tryCatcher (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\util.js:16:23)    at Promise._settlePromiseFromHandler (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:507:35)    at Promise._settlePromise (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:567:18)    at Promise._settlePromise0 (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:612:10)    at Promise._settlePromises (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:691:18)    at Promise._fulfill (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:636:18)    at PromiseArray._resolve (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:125:19)    at PromiseArray._promiseFulfilled (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:143:14)    at PromiseArray._iterate (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:113:31)    at PromiseArray.init [as _init] (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:77:10)    at Promise._settlePromise (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:564:21)    at Promise._settlePromise0 (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:612:10)    at Promise._settlePromises (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:691:18)    at Promise._fulfill (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:636:18)    at PromiseArray._resolve (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:125:19)    at PromiseArray._promiseFulfilled (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:143:14)    at Promise._settlePromise (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:572:26)    at Promise._settlePromise0 (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:612:10)    at Promise._settlePromises (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:691:18)    at Promise._fulfill (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:636:18)    at Promise._resolveCallback (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:431:57)    at Promise._settlePromiseFromHandler (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:522:17)    at Promise._settlePromise (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:567:18)    at Promise._settlePromise0 (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:612:10)    at Promise._settlePromises (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:691:18)    at Promise._fulfill (D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\promise.js:636:18)    at D:\Blog\github\node_modules\hexo\node_modules\bluebird\js\release\nodeback.js:42:21    at D:\Blog\github\node_modules\hexo\node_modules\hexo-fs\node_modules\graceful-fs\graceful-fs.js:78:16    at tryToString (fs.js:455:3)    at FSReqWrap.readFileAfterClose [as oncomplete] (fs.js:442:12)INFO  Files loaded in 1.48 sINFO  Generated: sitemap.xmlINFO  Generated: atom.xmlINFO  Generated: 2017/01/08/2017-01-08-trouble-shooting-with-my-blog/index.htmlINFO  Generated: index.htmlINFO  4 files generated in 2.26 sINFO  Deploying: git</code></pre><p>æ‰¾äº†å¥½ä¹…ï¼Œæœ‰è¯´â€_config.xmlâ€ æ–‡ä»¶ æœ‰ç©ºæ ¼çš„ï¼Œæœ‰è¯´ title è¢«ä¹±æ”¹çš„ï¼Œè¯•äº†å¥½é•¿æ—¶é—´ï¼Œæ”¹æˆè¿™æ ·å°±ä¸å†æŠ¥é”™äº†ã€‚æ‰€ä»¥ï¼Œ<strong>å†’å·åé¢ä¸€å®šè¦åŠ ç©ºæ ¼ï¼Œè‹±æ–‡åŠè§’çš„</strong></p><pre><code>---title: adbå¸¸ç”¨å‘½ä»¤æ‰‹å†Œdate: 2016-12-10 21:14:14tags: - android - adb---</code></pre><p>tags æœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§æ˜¯ä¸Šé¢è¿™æ ·å‰é¢åŠ æ¨ªæ å¦ä¸€ç§é•¿è¿™æ ·ï¼Œå†™æˆæ•°ç»„å½¢å¼</p><pre><code>---title: my awesometitledate: 2017-05-07 16:48:01categories: blogtags: [linux,python]---</code></pre><h2 id="3-ä¸€äº›åŠŸèƒ½çš„å®ç°"><a href="#3-ä¸€äº›åŠŸèƒ½çš„å®ç°" class="headerlink" title="3. ä¸€äº›åŠŸèƒ½çš„å®ç°"></a>3. ä¸€äº›åŠŸèƒ½çš„å®ç°</h2><ul><li>ç½®é¡¶åŠŸèƒ½å°† node_modules/hexo-generator-index/lib/generator.js çš„æ–‡ä»¶å†…å®¹æ›¿æ¢æˆä»¥ä¸‹å†…å®¹</li></ul><pre><code class="javascript">&quot;use strict&quot;;var pagination = require(&quot;hexo-pagination&quot;);module.exports = function(locals) {  var config = this.config;  var posts = locals.posts;  posts.data = posts.data.sort(function(a, b) {    if (a.top &amp;&amp; b.top) {      // ä¸¤ç¯‡æ–‡ç« topéƒ½æœ‰å®šä¹‰      if (a.top == b.top)        return b.date - a.date; // è‹¥topå€¼ä¸€æ ·åˆ™æŒ‰ç…§æ–‡ç« æ—¥æœŸé™åºæ’      else return b.top - a.top; // å¦åˆ™æŒ‰ç…§topå€¼é™åºæ’    } else if (a.top &amp;&amp; !b.top) {      // ä»¥ä¸‹æ˜¯åªæœ‰ä¸€ç¯‡æ–‡ç« topæœ‰å®šä¹‰ï¼Œé‚£ä¹ˆå°†æœ‰topçš„æ’åœ¨å‰é¢ï¼ˆè¿™é‡Œç”¨å¼‚æˆ–æ“ä½œå±…ç„¶ä¸è¡Œ233ï¼‰      return -1;    } else if (!a.top &amp;&amp; b.top) {      return 1;    } else return b.date - a.date; // éƒ½æ²¡å®šä¹‰æŒ‰ç…§æ–‡ç« æ—¥æœŸé™åºæ’  });  var paginationDir = config.pagination_dir || &quot;page&quot;;  return pagination(&quot;&quot;, posts, {    perPage: config.index_generator.per_page,    layout: [&quot;index&quot;, &quot;archive&quot;],    format: paginationDir + &quot;/%d/&quot;,    data: {      __index: true    }  });};</code></pre><ul><li>åŒæ—¶åœ¨æ–‡ç« å¼€å¤´æ·»åŠ  top : 1 å³å¯ ï¼Œå®é™…æ’åºæŒ‰ç…§è¿™ä¸ªæ•°å­—ä»å¤§åˆ°å°æ’åº</li></ul><p>å¦ä¸€ç§åšæ³•æ˜¯æ‰‹åŠ¨å°†dateæ”¹å¤§ï¼Œæ—¥æœŸè¶Šé åçš„è¶Šåœ¨å‰é¢ã€‚</p><pre><code class="java"> title: Hexoç½®é¡¶æ–‡ç« date: 2016-11-11 23:26:22tags:[ç½®é¡¶]categories: Hexotop: 0 # 0æˆ–è€…1</code></pre><p>ä¸ªäººå»ºè®®ï¼šç½®é¡¶ä¸è¦å¤ªå¤š</p><h2 id="4-SublimeText-çš„ä¸€äº›å¿«æ·é”®"><a href="#4-SublimeText-çš„ä¸€äº›å¿«æ·é”®" class="headerlink" title="4. SublimeText çš„ä¸€äº›å¿«æ·é”®"></a>4. SublimeText çš„ä¸€äº›å¿«æ·é”®</h2><p>ç”±äºæ–‡ç« å¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨ SublimeText å†™çš„ï¼ŒTyproa è¿™ç§æ‰€è§å³æ‰€å¾—çš„ç¼–è¾‘å™¨ä¹Ÿä¸é”™ï¼Œä½†å¯¹äºæŒæ¡ MardkDown è¯­æ³•æ²¡æœ‰å¸®åŠ©ã€‚è¿™é‡Œæ‘˜å½•ä¸€äº› SubLimeText çš„å¿«æ·é”®ã€‚</p><blockquote><p><strong>Ctrl+Shift+Pï¼šæ‰“å¼€å‘½ä»¤é¢æ¿</strong><br>Ctrl+Pï¼šæœç´¢é¡¹ç›®ä¸­çš„æ–‡ä»¶<br>Ctrl+Gï¼šè·³è½¬åˆ°ç¬¬å‡ è¡Œ<br>Ctrl+Wï¼šå…³é—­å½“å‰æ‰“å¼€æ–‡ä»¶ CTRL+F4 ä¹Ÿå¯ä»¥<br>Ctrl+Shift+Wï¼šå…³é—­æ‰€æœ‰æ‰“å¼€æ–‡ä»¶<br>Ctrl+Shift+Vï¼šç²˜è´´å¹¶æ ¼å¼åŒ–<br>Ctrl+Dï¼šé€‰æ‹©å•è¯ï¼Œé‡å¤å¯å¢åŠ é€‰æ‹©ä¸‹ä¸€ä¸ªç›¸åŒçš„å•è¯<br><strong>Ctrl+Lï¼šé€‰æ‹©è¡Œï¼Œé‡å¤å¯ä¾æ¬¡å¢åŠ é€‰æ‹©ä¸‹ä¸€è¡Œ</strong><br><strong>Alt+Shift+æ•°å­—ï¼šåˆ†å±æ˜¾ç¤º</strong><br><strong>Ctrl+Shift+Lï¼šé€‰æ‹©å¤šè¡Œ</strong><br><strong>Ctrl+Shift+Dï¼šå¤åˆ¶ç²˜è´´å½“å‰è¡Œ</strong><br><strong>Ctrl+Xï¼šåˆ é™¤å½“å‰è¡Œ</strong><br><strong>Ctrl+Shift+å·¦ç®­å¤´ å¾€å·¦è¾¹é€‰æ‹©å†…å®¹</strong><br><strong>Shift+å‘å·¦ç®­å¤´ å‘å·¦é€‰æ‹©æ–‡æœ¬</strong><br><strong>Ctrl+B ç¼–è¯‘ï¼ŒmarkDown ç”Ÿæˆ html æ–‡ä»¶</strong><br><strong>Alt+2 åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª Tabï¼ˆæ‰“å¼€çš„æ–‡ä»¶ï¼Œè®°å¾— chrome æ˜¯ ctrl+2ï¼‰</strong><br><strong>Ctrl+Rï¼šå‰å¾€ å¯¹åº”çš„æ–¹æ³•çš„å®ç°*</strong><br><strong>å¿«é€ŸåŠ ä¸Š[] é€‰ä¸­å•è¯æŒ‰ [ å³å¯</strong><br><strong>æ‰¹é‡æ›´æ”¹å½“å‰é¡µé¢ç›¸åŒçš„å•è¯ alt+F3 </strong><br><strong>Ctrl+Enter åœ¨ä¸‹ä¸€è¡Œæ’å…¥æ–°çš„ä¸€è¡Œ</strong><br><strong>Ctrl+Shift+Enter åœ¨ä¸Šä¸€è¡Œæ’å…¥æ–°çš„ä¸€è¡Œ</strong><br><strong>Shift+ å‘ä¸Šç®­å¤´ å‘ä¸Šé€‰ä¸­å¤šè¡Œ</strong></p></blockquote><blockquote><p>Ctrl+Shift+Dï¼šå¤åˆ¶ç²˜è´´å½“å‰è¡Œ Ctrl+Shift+Enterï¼šåœ¨å½“å‰è¡Œå‰æ’å…¥æ–°è¡Œ<br>Ctrl+Mï¼šè·³è½¬åˆ°å¯¹åº”æ‹¬å·<br>Ctrl+Uï¼šè½¯æ’¤é”€ï¼Œæ’¤é”€å…‰æ ‡ä½ç½®<br>Ctrl+Jï¼šé€‰æ‹©æ ‡ç­¾å†…å®¹<br>Ctrl+Fï¼šæŸ¥æ‰¾å†…å®¹<br>Ctrl+Shift+Fï¼šæŸ¥æ‰¾å¹¶æ›¿æ¢<br>Ctrl+Hï¼šæ›¿æ¢<br>Ctrl+Nï¼šæ–°å»ºçª—å£<br>Ctrl+K+Bï¼šå¼€å…³ä¾§æ <br>Ctrl+Shift+Mï¼šé€‰ä¸­å½“å‰æ‹¬å·å†…å®¹ï¼Œé‡å¤å¯é€‰ç€æ‹¬å·æœ¬èº«<br>Ctrl+F2ï¼šè®¾ç½®/åˆ é™¤æ ‡è®°<br>Ctrl+/ï¼šæ³¨é‡Šå½“å‰è¡Œ<br>Ctrl+Shift+/ï¼šå½“å‰ä½ç½®æ’å…¥æ³¨é‡Š<br>Ctrl+Alt+/ï¼šå—æ³¨é‡Šï¼Œå¹¶ Focus åˆ°é¦–è¡Œï¼Œå†™æ³¨é‡Šè¯´æ˜ç”¨çš„<br>Ctrl+Shift+Aï¼šé€‰æ‹©å½“å‰æ ‡ç­¾å‰åï¼Œä¿®æ”¹æ ‡ç­¾ç”¨çš„<br>F11ï¼šå…¨å±<br>Shift+F11ï¼šå…¨å±å…æ‰“æ‰°æ¨¡å¼ï¼Œåªç¼–è¾‘å½“å‰æ–‡ä»¶<br>Alt+F3ï¼šé€‰æ‹©æ‰€æœ‰ç›¸åŒ<br>Alt+.ï¼šé—­åˆæ ‡ç­¾<br>Shift+å³é”®æ‹–åŠ¨ï¼šå…‰æ ‡å¤šä¸ï¼Œç”¨æ¥æ›´æ”¹æˆ–æ’å…¥åˆ—å†…å®¹<br>Alt+æ•°å­—ï¼šåˆ‡æ¢æ‰“å¼€ç¬¬ N ä¸ªæ–‡ä»¶é¼ æ ‡çš„å‰è¿›åé€€é”®å¯åˆ‡æ¢ Tab æ–‡ä»¶æŒ‰ Ctrlï¼Œä¾æ¬¡ç‚¹å‡»æˆ–é€‰å–ï¼Œå¯éœ€è¦ç¼–è¾‘çš„å¤šä¸ªä½ç½®æŒ‰ Ctrl+Shift+ä¸Šä¸‹é”®ï¼Œå¯æ›¿æ¢è¡Œ</p></blockquote><p>vscodeçš„å¿«æ·é”®æœ€é‡è¦çš„ä¸€ä¸ªæ˜¯ctrl+shift+p(ç›¸å½“äºsublimeé‡Œé¢çš„å‘½ä»¤æ¨¡å¼),ctrl+påªæ˜¯åœ¨å…¨å±€æŸ¥æ‰¾æ–‡ä»¶</p><h2 id="5-title-ä¸èƒ½ä»¥-å¼€å¤´"><a href="#5-title-ä¸èƒ½ä»¥-å¼€å¤´" class="headerlink" title="5. title ä¸èƒ½ä»¥[]å¼€å¤´"></a>5. title ä¸èƒ½ä»¥[]å¼€å¤´</h2><p>å‰é¢åŠ ä¸Š###ç¡®å®èƒ½å¤Ÿè®©å­—å·å˜å¤§ï¼Œä½†ä¸è¦å†™ 4 ä¸ª#ï¼Œåé¢çš„å­—æ¯ä¼šå¤§å°å†™ä¸åˆ†çš„</p><h2 id="6-markdown-è¯­æ³•"><a href="#6-markdown-è¯­æ³•" class="headerlink" title="6. markdown è¯­æ³•"></a>6. markdown è¯­æ³•</h2><p>MarkDown é¡µé¢å†…éƒ¨è·³è½¬<br><a href="http://www.cnblogs.com/JohnTsai/p/4027229.html">MarkDown æŠ€å·§ï¼šä¸¤ç§æ–¹å¼å®ç°é¡µå†…è·³è½¬</a></p><blockquote><p><em>ä¸€ä¸ªæ˜Ÿæ˜ŸåŒ…èµ·æ¥æ˜¯æ–œä½“å­—</em><br><strong>ä¸¤ä¸ªæ˜Ÿæ˜ŸåŒ…èµ·æ¥æ˜¯ç²—ä½“å­—</strong><br><strong><em><em>é‚£ä¹ˆä¸‰ä¸ªæ˜Ÿæ˜Ÿå‘¢</em></em></strong></p></blockquote><p>â€œâ€”â€œ ä¸‰æ ¹æ¨ªæ æ˜¯åˆ†å‰²çº¿</p><h2 id="æˆ‘æ˜¯åˆ†å‰²çº¿ä¸Šé¢"><a href="#æˆ‘æ˜¯åˆ†å‰²çº¿ä¸Šé¢" class="headerlink" title="æˆ‘æ˜¯åˆ†å‰²çº¿ä¸Šé¢"></a>æˆ‘æ˜¯åˆ†å‰²çº¿ä¸Šé¢</h2><p>æˆ‘åœ¨åˆ†å‰²çº¿ä¸‹é¢</p><p><code>é”®ç›˜ESCä¸‹é¢é‚£ä¸ªé”®æŒ‰ä¸¤ä¸‹æ˜¯codeçš„æ„æ€</code> å’Œ<code>ä¸€ä¸ªhtml code tag</code> åŒæ ·çš„æ•ˆæœ</p><p>å½©è‰²çš„å­—</p><font color="red">0</font>ã€<font color="orange">10</font>ã€<font color="green">20</font>ã€<font color="blue">30</font>ã€<font color="Purple">40</font><p>ä¸‹åˆ’çº¿è¦æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥ï¼Œ åŠ è½¬ä¹‰å­—ç¬¦å°±è¡Œäº†<br>__proto__</p><h2 id="7-github-æäº¤-commit-çš„æ—¶å€™æ˜¾ç¤º-Emoji"><a href="#7-github-æäº¤-commit-çš„æ—¶å€™æ˜¾ç¤º-Emoji" class="headerlink" title="7.github æäº¤ commit çš„æ—¶å€™æ˜¾ç¤º Emoji"></a>7.github æäº¤ commit çš„æ—¶å€™æ˜¾ç¤º Emoji</h2><p>é“¾æ¥<a href="https://www.webpagefx.com/tools/emoji-cheat-sheet/">åœ¨æ­¤</a></p><h2 id="8-æ¢ç”µè„‘äº†æ€ä¹ˆåŠ"><a href="#8-æ¢ç”µè„‘äº†æ€ä¹ˆåŠ" class="headerlink" title="8.æ¢ç”µè„‘äº†æ€ä¹ˆåŠ"></a>8.æ¢ç”µè„‘äº†æ€ä¹ˆåŠ</h2><p>äº²æµ‹ï¼ŒæŠŠæ•´ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å…¨éƒ¨å¤åˆ¶ç²˜è´´åˆ°æ–°ç”µè„‘ä¸Šï¼Œè£…ä¸Š nodeï¼Œç„¶åè£…ä¸Š hexoï¼Œè®°å¾—å‹¾é€‰æ·»åŠ åˆ° PATH,ç„¶åå°±å¯ä»¥äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å°æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥å¤åˆ¶ç²˜è´´å¯èƒ½è¦åå‡ åˆ†é’Ÿã€‚</p><h2 id="9-æœ‰æ—¶å€™å†™çš„ä»£ç ä¼šç»™ä½ åœ¨æ¯ä¸€è¡Œå‰é¢åŠ ä¸Š-true"><a href="#9-æœ‰æ—¶å€™å†™çš„ä»£ç ä¼šç»™ä½ åœ¨æ¯ä¸€è¡Œå‰é¢åŠ ä¸Š-true" class="headerlink" title="9. æœ‰æ—¶å€™å†™çš„ä»£ç ä¼šç»™ä½ åœ¨æ¯ä¸€è¡Œå‰é¢åŠ ä¸Š true"></a>9. æœ‰æ—¶å€™å†™çš„ä»£ç ä¼šç»™ä½ åœ¨æ¯ä¸€è¡Œå‰é¢åŠ ä¸Š true</h2><p>æ¯”å¦‚å†™ä¸€æ®µ css çš„ä»£ç æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™é¢„è§ˆä¼šç»™æ¯ä¸€è¡Œå‰é¢åŠ ä¸Šä¸€ä¸ª trueï¼Œè§£å†³åŠæ³•ï¼šç”¨ TAB é”®ç¼©è¿›å³å¯</p><h2 id="10-markdown-live-æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„-node-module"><a href="#10-markdown-live-æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„-node-module" class="headerlink" title="10. markdown-live æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ node module"></a>10. markdown-live æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ node module</h2><p><a href="https://www.npmjs.com/package/markdown-live">é¡¹ç›®åœ°å€</a><br><strong>å‰ææ˜¯å®‰è£…äº† node</strong></p><blockquote><p>npm install -g markdown-live</p></blockquote><blockquote><p>md-live</p></blockquote><p><br><br><strong><em>ç¼–è¾‘mdæ–‡ä»¶çš„åŒæ—¶ï¼Œä¿å­˜å°±ä¼šåŒæ­¥åˆ·æ–°ç½‘é¡µé¢„è§ˆï¼Œéå¸¸å¥½ç”¨</em></strong></p><h2 id="11-å¦‚æœè¿è¡Œ-hexo-g-ç”Ÿæˆçš„-index-html-æ˜¯ç©ºçš„"><a href="#11-å¦‚æœè¿è¡Œ-hexo-g-ç”Ÿæˆçš„-index-html-æ˜¯ç©ºçš„" class="headerlink" title="11. å¦‚æœè¿è¡Œ hexo g ç”Ÿæˆçš„ index.html æ˜¯ç©ºçš„"></a>11. å¦‚æœè¿è¡Œ hexo g ç”Ÿæˆçš„ index.html æ˜¯ç©ºçš„</h2><p>è¾“å‡º</p><blockquote><p>WARN No layout: tags/service/index.html<br>åŸå› æ˜¯ themes/æ–‡ä»¶å¤¹ä¸‹æ²¡æœ‰ clone å¯¹åº”çš„ä¸»é¢˜</p></blockquote><p>æ¢æˆtravisä¹‹åï¼Œåœ¨travis.ymlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†</p><pre><code class="config">cache:  yarn: true  directories:  - node_modules  - themes</code></pre><p>caheä¹Ÿå°±æ„å‘³ç€åç»­ï¼Œæ‰€æœ‰å¯¹äºthemesæ–‡ä»¶å¤¹ä¸­çš„_config.ymlæ–‡ä»¶çš„ä¿®æ”¹éƒ½ä¸ä¼šç”Ÿæ•ˆã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä¸€ééå°è¯•æ›´æ”¹themeæ–‡ä»¶å¤¹ä¸­_configæ–‡ä»¶ä¸ç”Ÿæ•ˆçš„åŸå› ã€‚<br>æ‰€ä»¥è¦ä¹ˆå»æ‰cache ï¼Œè¦ä¹ˆè‡ªå·±å†™bash scriptä¸€è¡Œè¡Œçš„æ”¹ã€‚</p><h2 id="12-markdownå†™è¡¨æ ¼"><a href="#12-markdownå†™è¡¨æ ¼" class="headerlink" title="12. markdownå†™è¡¨æ ¼"></a>12. markdownå†™è¡¨æ ¼</h2><p>ç›´æ¥åœ¨atomä¸‹é¢æ•²tableï¼Œå°±ä¼šè‡ªåŠ¨æç¤ºå‡ºæ¥çš„</p><table><thead><tr><th>ä¸€ä¸ªæ™®é€šæ ‡é¢˜</th><th>ä¸€ä¸ªæ™®é€šæ ‡é¢˜</th><th>ä¸€ä¸ªæ™®é€šæ ‡é¢˜</th></tr></thead><tbody><tr><td>çŸ­æ–‡æœ¬</td><td>ä¸­ç­‰æ–‡æœ¬</td><td>ç¨å¾®é•¿ä¸€ç‚¹çš„æ–‡æœ¬</td></tr><tr><td>ç¨å¾®é•¿ä¸€ç‚¹çš„æ–‡æœ¬</td><td>çŸ­æ–‡æœ¬</td><td>ä¸­ç­‰æ–‡æœ¬</td></tr></tbody></table><p>ä¸­é—´çš„è™šçº¿å·¦è¾¹çš„å†’å·è¡¨ç¤ºä¸‹é¢çš„å•å…ƒæ ¼å·¦å¯¹é½ï¼Œå†’å·æ”¾å³è¾¹å°±å³å¯¹é½ï¼Œå·¦å³éƒ½æ”¾ä¸€ä¸ªå°±è¡¨ç¤ºå±…ä¸­</p><p>vscodeçš„è¿”å›ä¸Šä¸€ä¸ªæ–‡ä»¶å¿«æ·é”®æ˜¯ctrl + -<br>multiple cursorçš„å¿«æ·é”®æ˜¯ctrl + d</p><h2 id="13-travis-ciè‡ªåŠ¨éƒ¨ç½²çš„ä¸€äº›é—®é¢˜"><a href="#13-travis-ciè‡ªåŠ¨éƒ¨ç½²çš„ä¸€äº›é—®é¢˜" class="headerlink" title="13 . travis ciè‡ªåŠ¨éƒ¨ç½²çš„ä¸€äº›é—®é¢˜"></a>13 . travis ciè‡ªåŠ¨éƒ¨ç½²çš„ä¸€äº›é—®é¢˜</h2><p><a href="https://github.com/travis-ci/travis.rb/issues/437">travis ciåŠ å¯†æ–‡ä»¶æ— æ³•åœ¨travisä»¥å¤–çš„åœ°æ–¹è§£å¯†ï¼Œå› ä¸ºkey,valueéƒ½å­˜åœ¨travisçš„æ•°æ®åº“äº†</a></p><p><a href="https://github.com/travis-ci/travis-ci/issues/9668">travisåŠ å¯†æ–‡ä»¶åç”¨opensslè§£å¯†å‡ºç°iv undefinedçš„é”™è¯¯</a></p><p>iv undefined</p><blockquote><p>travis env list<br>encrypted_476ad15a8e52_key=[secure]<br>encrypted_476ad15a8e52_iv=[secure]<br>æ˜æ˜æ˜¯å­˜åœ¨çš„</p></blockquote><p>åœ¨linux é‡Œé¢è¿è¡Œtravis endpoint<br>æœç„¶æ˜¯ API endpoint: <a href="https://api.travis-ci.org/">https://api.travis-ci.org/</a><br>è€Œæ–°çš„endpointåº”è¯¥æ˜¯ <a href="https://api.travis-ci.com/">https://api.travis-ci.com/</a><br>äºæ˜¯travis encrypt-file â€“help</p><blockquote><p>â€“pro  short-cut for â€“api-endpoint â€˜<a href="https://api.travis-ci.com/&#39;">https://api.travis-ci.com/&#39;</a><br>â€“org short-cut for â€“api-endpoint â€˜<a href="https://api.travis-ci.org/&#39;">https://api.travis-ci.org/&#39;</a></p></blockquote><p>æ‰€ä»¥</p><blockquote><p>travis encrypt-file super_secret.txt åº”è¯¥æ”¹æˆ<br>travis encrypt-file super_secret.txt â€“pro</p></blockquote><p>å› ä¸ºé»˜è®¤çš„$encrypted_476ad15a8e52_keyå…¶å®å·²ç»å­˜å‚¨åœ¨travis-ci.orgä¸Šäº†<br>æ‰€ä»¥åœ¨travis-ci.comä¸Šçš„é¡¹ç›®å½“ç„¶æ‰¾ä¸åˆ°</p><p><a href="https://github.com/openwrtio/openwrtio.github.io/blob/mkdocs/.travis.yml">è‡ªåŠ¨éƒ¨ç½²çš„å¦ä¸€ä¸ªå®ä¾‹</a></p><h2 id="14-hexo-serveræœ¬åœ°é¢„è§ˆå‡ºç°çš„é—®é¢˜"><a href="#14-hexo-serveræœ¬åœ°é¢„è§ˆå‡ºç°çš„é—®é¢˜" class="headerlink" title="14. hexo serveræœ¬åœ°é¢„è§ˆå‡ºç°çš„é—®é¢˜"></a>14. hexo serveræœ¬åœ°é¢„è§ˆå‡ºç°çš„é—®é¢˜</h2><p><a href="Refused to execute script from" title="http://localhost:4000/slider.e37972.js&#39; because its MIME type (&#39;text/html">hexo s æœ¬åœ°é¢„è§ˆæ ·å¼åŠ è½½å¤±è´¥</a> is not executable, and strict MIME type checking is enabled.)</p><p>hexo serverçš„æ„æ€æ˜¯ç±»ä¼¼äºexpressçš„serve staticåŠŸèƒ½ï¼Œ<a href="https://hexo.io/zh-cn/docs/server.html">é»˜è®¤åªå¤„ç†publicæ–‡ä»¶ä¸‹çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœæœ¬åœ°è¿è¡Œhexo s å‡ºç°404çš„è¯ï¼Œç›´æ¥copyåˆ°publicæ–‡ä»¶å¤¹ä¸‹å°±å¯ä»¥äº†</a>æ³¨æ„hexo clearä¼šåˆ æ‰publicæ–‡ä»¶å¤¹</p><p>[Refused to Execute Script From Because Its MIME Type (Text/plain) Is Not Executable, and Strict MIME Type Checking Is Enabled]è¿™å¥è¯çš„æ„æ€,è¿™å…¶å®æ˜¯æˆ‘æœ¬åœ°è·‘hexo serverçš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªxx.jsæ–‡ä»¶ï¼Œæ‰€ä»¥expressè¿”å›äº†ä¸€ä¸ªç±»ä¼¼äº404çš„plain textï¼ˆè€Œä¸æ˜¯jsæ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥å°±å‡ºè¿™ä¸ªé—®é¢˜äº†ã€‚</p><h2 id="15-yiliaçš„ä¸»é¢˜é‡Œé¢badjs-reportçš„é—®é¢˜"><a href="#15-yiliaçš„ä¸»é¢˜é‡Œé¢badjs-reportçš„é—®é¢˜" class="headerlink" title="15. yiliaçš„ä¸»é¢˜é‡Œé¢badjs reportçš„é—®é¢˜"></a>15. yiliaçš„ä¸»é¢˜é‡Œé¢badjs reportçš„é—®é¢˜</h2><p>yiliaçš„ä¸»é¢˜é‡Œé¢æœ‰ä¸€ä¸ªbadjsçš„reportï¼Œå»æ‰çš„æ–¹æ³•ï¼š<br>cd åˆ°themes/yiliaé‡Œé¢,rm -rf source/ , ç„¶åæŠŠsource-srcé‡Œé¢çš„report.jsé‡Œé¢çš„ä¸œè¥¿åˆ æ‰ã€‚yarn install ,yarn dist ,ç„¶åå›åˆ°ä¸Šå±‚ç›®å½•ã€‚hexo clean , hexo gå°±å¯ä»¥äº†ã€‚<br>å…¶å®çœ‹ä¸‹é‡Œé¢ï¼Œå°±æ˜¯ä¸€ä¸ªwebpackçš„é…ç½®ï¼Œè‡ªå·±é‡æ–°ç¼–è¯‘ä¸€ä¸‹å°±å¥½äº†ã€‚ç¼–è¯‘åä¼šåœ¨sourceé‡Œé¢é‡æ–°ç”Ÿæˆéœ€è¦çš„jsæ–‡ä»¶ã€‚<br>å¥‡æ€ªçš„æ˜¯åœ¨windowsä¸Šç¼–è¯‘å¤±è´¥ï¼Œåœ¨linuxä¸Šç¼–è¯‘å¤±è´¥ï¼Œåœ¨macä¸Šç»ˆäºæˆåŠŸäº†ã€‚</p><h2 id="16-hexo-server"><a href="#16-hexo-server" class="headerlink" title="16. hexo server"></a>16. hexo server</h2><p><a href="https://stackoverflow.com/questions/22475849/node-js-what-is-enospc-error-and-how-to-solve">enospcçš„è§£å†³æ–¹å¼</a><br>ç”±äºéœ€è¦ç›‘å¬å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥linuxä¸‹å…è®¸ç›‘å¬çš„æ–‡ä»¶æ•°æœ‰ä¸ªä¸Šé™ï¼Œè¿™é‡Œä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥äº†</p><h2 id="17-hexoè‡ªå¸¦çš„ä»£ç é«˜äº®æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå¥½çš„åœ°æ–¹"><a href="#17-hexoè‡ªå¸¦çš„ä»£ç é«˜äº®æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå¥½çš„åœ°æ–¹" class="headerlink" title="17. hexoè‡ªå¸¦çš„ä»£ç é«˜äº®æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå¥½çš„åœ°æ–¹"></a>17. hexoè‡ªå¸¦çš„ä»£ç é«˜äº®æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå¥½çš„åœ°æ–¹</h2><p>æ”¹ç”¨highlightjså°±å¯ä»¥äº†ã€‚<br>é¦–å…ˆè¦æŠŠæœ€å¤–é¢çš„_config.ymlé‡Œé¢çš„é«˜äº®å…³æ‰</p><pre><code>highlight:  enable: false</code></pre><p>ç”±äºæœ€ç»ˆç”Ÿæˆçš„htmlæ–‡ä»¶ä¸­å¼•ç”¨çš„æ˜¯themeä¸­webpack -p æ‰“å‡ºæ¥çš„jsæ–‡ä»¶ï¼Œæ‰€ä»¥ç…§ç€highlightjsçš„è¯´æ˜ä¿®æ”¹ä¸€ä¸‹yiliaçš„æºç ï¼Œsource-srcç›®å½•ï¼Œnpm install highlight.js â€“saveé‡æ–°yarn distå°±å¥½äº†ã€‚yiliaçš„themeä¿®æ”¹è¿˜ç®—ç®€å•ã€‚</p><h2 id="18-hexoæ¸²æŸ“mdæ–‡ä»¶æ—¶æœ‰äº›ç‰¹å®šå­—ç¬¦ä¸²æ˜¯ä¸èƒ½å†™çš„"><a href="#18-hexoæ¸²æŸ“mdæ–‡ä»¶æ—¶æœ‰äº›ç‰¹å®šå­—ç¬¦ä¸²æ˜¯ä¸èƒ½å†™çš„" class="headerlink" title="18. hexoæ¸²æŸ“mdæ–‡ä»¶æ—¶æœ‰äº›ç‰¹å®šå­—ç¬¦ä¸²æ˜¯ä¸èƒ½å†™çš„"></a>18. hexoæ¸²æŸ“mdæ–‡ä»¶æ—¶æœ‰äº›ç‰¹å®šå­—ç¬¦ä¸²æ˜¯ä¸èƒ½å†™çš„</h2><p>hexoæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªjsæ¨¡æ¿æ¸²æŸ“å·¥å…·ï¼Œå’Œjinjaï¼Œhandlerbarsè¿™ä¸€ç±»æ¨¡æ¿ä¸€æ ·ï¼Œç»å¸¸ä¼šç”¨èŠ±æ‹¬å·åŒ…èµ·æ¥è¡¨ç¤ºä¸€ä¸ªå˜é‡<br>ä¸‹é¢è¿™ä¸ªï¼Œç¾å…ƒç¬¦å·åŠ ä¸€ä¸ªèŠ±æ‹¬å·æŠ±èµ·æ¥çš„äº•å·å°±ä¸èƒ½å•ç‹¬æ‹¿å‡ºæ¥å†™</p><pre><code>${#} </code></pre><p>æŠ¥çš„é”™å¤§æ¦‚é•¿è¿™æ ·</p><pre><code>Template render error: (unknown path) [Line 101, Column 142]  unexpected token: }}</code></pre><p><a href="https://github.com/hexojs/hexo/issues/2384#issuecomment-277494121">åŸå› æ˜¯è¿™ç§çœ‹ä¸Šå»åƒæ˜¯å¼•ç”¨ä¸€ä¸ªå˜é‡çš„ä¸œè¥¿æ˜¯æŸäº›jsåº“çš„ä¿ç•™syntax</a></p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="http://yanhuili.github.io/2016/11/21/hexo%E5%8D%9A%E6%96%87%E7%BD%AE%E9%A1%B6%E6%8A%80%E5%B7%A7/">Hexo åšæ–‡ç½®é¡¶æŠ€å·§</a></li><li><a href="http://www.daqianduan.com/4820.html">SublimeText å¿«æ·é”®</a></li><li><a href="http://itmyhome.com/markdown/article/syntax/emphasis.html">MarkDown è¯­æ³•å­¦èµ·æ¥å¾ˆå¿«çš„</a></li><li><a href="https://blessing.studio/deploy-hexo-blog-automatically-with-travis-ci/">travis è‡ªåŠ¨éƒ¨ç½²</a></li><li><a href="https://docs.travis-ci.com/user/legacy-services-to-github-apps-migration-guide/">Legacy GitHub Services to GitHub Apps Migration Guide 2018å¹´10æœˆ1å·ä¹‹åä¸å†æ”¯æŒ Legacy GitHub Service</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨ hexo å†™åšå®¢ä»¥æ¥ï¼Œè®°å½•ä¸‹æ¥çš„é—®é¢˜è¶Šæ¥è¶Šå¤šã€‚åªå¸Œæœ›ä¸‹æ¬¡å†ç¢°åˆ°åŒæ ·çš„é—®é¢˜æ—¶ï¼Œä¸è¦å†å»æµªè´¹æ—¶é—´å»æŸ¥æ‰¾ã€‚å¦‚æœæƒ³è¦ç»™è‡ªå·±çš„ blog ä¸€ä¸ªå€¼å¾—ç½®é¡¶çš„æ–‡ç« çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸€ç¯‡è®°å½•ä½¿ç”¨ hexo è¿‡ç¨‹ä¸­çš„ä¸€äº›è§£å†³é—®é¢˜çš„æ–¹æ³•çš„æ–‡ç« æ˜¯å†åˆé€‚ä¸è¿‡çš„äº†ã€‚&lt;/br&gt;&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/40164340_40164340_1414330224938_mthumb.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="blog" scheme="https://haldir65.github.io/categories/blog/"/>
    
    
      <category term="ç½®é¡¶" scheme="https://haldir65.github.io/tags/%E7%BD%AE%E9%A1%B6/"/>
    
      <category term="hexo" scheme="https://haldir65.github.io/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>å³åˆ»å¤‡å¿˜å½•</title>
    <link href="https://haldir65.github.io/2046/12/18/2017-12-18-random-new-thoughts/"/>
    <id>https://haldir65.github.io/2046/12/18/2017-12-18-random-new-thoughts/</id>
    <published>2046-12-18T22:58:14.000Z</published>
    <updated>2020-03-18T22:24:14.508Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€ä¸ªå¾…åŠäº‹é¡¹çš„ä»“åº“<br><img src="https://api1.foster66.xyz/static/imgs/girlfriend lake green nature water cold.jpg" alt=""></p><a id="more"></a><h3 id="æœŸå¾…èƒ½å¤Ÿå®Œæˆçš„"><a href="#æœŸå¾…èƒ½å¤Ÿå®Œæˆçš„" class="headerlink" title="æœŸå¾…èƒ½å¤Ÿå®Œæˆçš„"></a>æœŸå¾…èƒ½å¤Ÿå®Œæˆçš„</h3><ul><li><a href="https://juejin.im/post/5a0c1956f265da430a501f51">ä¸ªäººåˆ†äº«â€“web å‰ç«¯å­¦ä¹ èµ„æºåˆ†äº«</a></li><li><a href="https://huangxuan.me/2017/02/09/nextgen-web-pwa/">PWA æ‰€ä»£è¡¨çš„ Web å¼€å‘åº”æ˜¯æœªæ¥</a>æ®è¯´Electronè¦è¢«PWAå¹²æ‰</li><li><a href="https://segmentfault.com/a/1190000003818163">js å¾ªç¯é—­åŒ…çš„è§£å†³æ–¹æ³•</a></li><li>[ ] shadowsocks-androidæºç ï¼ˆæ®è¯´æ˜¯èµ·äº†ä¸€ä¸ªcè¿›ç¨‹å®ˆæŠ¤ï¼‰</li><li>[ ] chromium netç§»æ¤åˆ°Androidå¹³å°<a href="https://github.com/GoogleChromeLabs/cronet-sample">cronetæ˜¯æœ€ç®€å•çš„æ–¹å¼</a> <a href="https://console.cloud.google.com/storage/browser/chromium-cronet?pli=1">æ›´å¤šä¸‹è½½ä»“åº“</a></li><li>[ ] <a href="http://lokeshdhakar.com/projects/lightbox2/">lightboxä¸€ä¸ªå¾ˆå¥½çœ‹çš„jså›¾ç‰‡æŸ¥çœ‹åº“</a></li><li>[ ] <a href="https://github.com/wangpengfei15975/skPlayer/">ä¸€ä¸ªå¾ˆå¥½çœ‹çš„h5éŸ³ä¹æ’­æ”¾å™¨</a></li><li>[ ] <a href="https://www.js-css.cn/a/jscode/album/2014/0915/1319.html">ä»¿é—¨æˆ·ç½‘ç«™jsç›¸å†Œ</a>ï¼Œ <a href="https://www.js-css.cn/a/jscode/album/2014/0914/1318.html">jsç›¸å†Œ2</a></li><li>[ ] <a href="http://python.jobbole.com/82270/">å…«å¤§æ’åºç®—æ³•çš„pythonå®ç°</a></li><li>[ ] <a href="https://www.jianshu.com/p/a4ab102fa4ac">å¦‚ä½•åœ¨å®¿ä¸»Appä¸­æå–ä¸€ä¸ªapkæ–‡ä»¶å¹¶åŠ è½½ä»£ç å’Œèµ„æº</a></li><li>[ ] nodejs ,go ,protobuf rpc(protoæ›´å¤šçš„æ˜¯ä½œä¸ºä¸€ç§åè®®æ¥è¿›è¡Œrpcæ•°æ®ä¼ è¾“)</li><li>[ ] Coordinator behaviorä»¥åŠscrollåŸç†</li><li>[ ] instagramå¥½åƒé€šè¿‡æ³¨è§£çš„æ–¹å¼è‡ªå·±å†™äº†ä¸€ä¸ªjsonè§£æå™¨<a href="https://github.com/Instagram/ig-json-parser">ig-json-parser</a></li><li>[ ] when it comes to design , how do we translate px, pt, em  into sp,dp and others(è®¾è®¡æ–¹é¢çš„ï¼Œå„ç§å•ä½ä¹‹é—´çš„è½¬æ¢)?</li><li>[ ] mqttæ¥å…¥å®è·µ<a href="https://github.com/mcxiaoke/mqtt">mqttæ˜¯å»ºç«‹åœ¨tcpåŸºç¡€ä¸Šçš„åº”ç”¨å±‚åè®®</a>ï¼Œ<a href="https://github.com/netty/netty">netty</a>ä¹Ÿåšäº†å®ç°</li><li>[ ] <a href="https://www.youtube.com/watch?v=jYuK1qzFrJg">Kotlin Coroutines Tutorial (STABLE VERSION) </a></li><li>[ ] å®‡å®™ç¬¬ä¸€ideç†Ÿæ‚‰ä½¿ç”¨</li><li>[ ] python code generator(ä»£ç ç”Ÿæˆå™¨)</li><li>[ ] awkï¼Œæ­£åˆ™è¡¨è¾¾å¼è¿˜æœ‰æ•°æ®åº“è¿™äº›ä¹Ÿç®—ä¸€é—¨ç¼–ç¨‹è¯­è¨€</li><li>[ ]Luaè„šæœ¬æ˜¯ä¸€ä¸ªå¾ˆè½»é‡çº§çš„è„šæœ¬ï¼Œä¹Ÿæ˜¯å·ç§°æ€§èƒ½æœ€é«˜çš„è„šæœ¬ã€‚è·¯ç”±å™¨ä¸Šéƒ½æœ‰è¿è¡Œç¯å¢ƒï¼Œè¯­æ³•å’Œcè¯­è¨€å·®ä¸å¤šã€‚åœ¨<del>nginx</del>openrestyé…ç½®æ–‡ä»¶ä¸­ä¹Ÿå¯ä½¿ç”¨ã€‚luaè¿˜å¯ä»¥å’Œjavaä»£ç äº’ç›¸è°ƒç”¨ï¼Œè¿˜æ‰¾åˆ°äº†ä¸€ä¸ª<a href="https://github.com/sanyouyugan/Mas">å°†luaç§»æ¤åˆ°androidå¹³å°</a>çš„é¡¹ç›®</li><li><a href="https://juejin.im/post/5baf8ae8f265da0ae92a7df5">è…¾è®¯çš„mmkvæ˜¯shared preferenceçš„æœ‰æ•ˆæ›¿ä»£å“</a> mmapçš„ä½¿ç”¨å€¼å¾—å­¦ä¹ </li><li><a href="https://www.jianshu.com/p/5f9a7bc902e1">ç®€å•çš„ç»„ä»¶åŒ–æ–¹æ¡ˆ</a></li><li><a href="https://www.tianmaying.com/tutorial/AndroidMVC">mvc,mvp,mvvm</a>è¿™äº›å…³é”®æœ¯è¯­çš„æŒæ¡è¿˜æ˜¯å¿…è¦çš„</li><li>Parcelable æ˜¯æ€ä¹ˆå®ç°è·¨è¿›ç¨‹çš„? ipcå¹¶ä¸ä»…é™äºåå°ï¼Œå®¢æˆ·ç«¯ä¸åŒè¿›ç¨‹é—´ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„æ¦‚å¿µã€‚</li><li>Perlè¢«ç§°ä¸ºè„šæœ¬è¯­è¨€ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå¤„ç†æ–‡æœ¬å’Œæ­£åˆ™çš„èƒ½åŠ›æ¯”è¾ƒå¼ºã€‚å­¦ä¹ perl5å°±å¯ä»¥äº†ã€‚</li><li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">Spring Boot application.yml</a> å†™æ³•</li><li><a href="https://segmentfault.com/a/1190000017864721">åç«¯é¢è¯•é¢˜</a></li><li>thrift æºç è§£æï¼Œrpcæ¡†æ¶ï¼ˆæ¯”æ–¹è¯´äººè„¸è¯†åˆ«åº”ç”¨å°±å¯ä»¥ç”¨javaè°ƒç”¨pythonæœåŠ¡ï¼‰è¿™ç§rpcè¿‡ç¨‹è‚¯å®šè¦è€ƒè™‘å­—èŠ‚åºçš„é—®é¢˜ã€‚</li><li>å¾®æœåŠ¡æ¡†æ¶ <del>dubbo</del> kubernetes, Spring Cloudâ€¦.</li><li>[ ] java BitSetè¿™ä¸ªclassçš„ä½¿ç”¨åŠæ•ˆç‡</li><li>[ ] å…³äºtextViewæºç çš„è§£æè¦è¡¥ä¸Š</li><li>[ ] <a href="http://blog.httrack.com/blog/2013/08/23/catching-posix-signals-on-android/">Replacing JNI Crashes by Exceptions on Android</a></li></ul><h3 id="å·²å®Œæˆ"><a href="#å·²å®Œæˆ" class="headerlink" title="å·²å®Œæˆ"></a>å·²å®Œæˆ</h3><ul><li>ç”¨ express è½¬æ¥ä¸€ä¸ªçŸ¥ä¹ Apiï¼Œæ·»åŠ  Access-control-allow-origin,æˆ–è®¸è¿˜å¯ä»¥ç”¨ redis ç¼“å­˜æ•°æ®ç»“æœï¼ˆä¸€ä¸ªå°±å¥½ï¼‰ç”±æ­¤æƒ³åˆ°ä¸€ç¯‡æ–‡ç« â€How to use Python to build a restful Web Serviceâ€.åªä¸è¿‡ç”¨çš„æ˜¯ Tornado</li><li>git hook (github travis æŒç»­é›†æˆï¼Œgit push ä¼šè§¦å‘æœåŠ¡å™¨çš„ä¸€ç³»åˆ—æ“ä½œ)</li><li>åŸºäºå‰åç«¯åˆ†ç¦»çš„ç†å¿µï¼Œåå°åªè´Ÿè´£æä¾›æ•°æ®ï¼Œrender page çš„ä»»åŠ¡åº”è¯¥äº¤ç»™å‰ç«¯ã€‚ï¼ˆæ‰€ä»¥ç”¨ express-handlebars å†™é¡µé¢çš„æ–¹å¼å†™ç€å¾ˆç´¯ï¼‰</li><li>é›†æˆ travis-ciï¼Œè®°å¾— after-success script çš„ç»“æœå¹¶ä¸ä¼šå½±å“ build çš„ç»“æœï¼ˆå³ï¼Œafter-success æ‰§è¡Œè„šæœ¬å‘ç”Ÿäº†é”™è¯¯ï¼Œåœ¨æ—¥å¿—é‡Œæœ‰è¾“å‡º errorï¼Œä½†å®é™…æ˜¾ç¤ºçš„ build result ä»ä¸º successï¼‰ï¼Œè¿˜æœ‰ travis çš„è¾“å‡º log éœ€è¦é»˜è®¤æ˜¯æŠ˜å çš„ï¼Œè¦å±•å¼€æ‰èƒ½çœ‹æ¸…æ¥šï¼Œä½†åœ¨ afterSuccess é‡Œé¢çš„æŒ‡ä»¤çš„è¾“å‡ºä¸€å®šæ˜¯æœ‰çš„ã€‚</li><li>éšä¾¿æ”¾ä¸€ä¸ªæ–‡ä»¶åˆ°/usr/bin/å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–‡ä»¶åæ¥èµ·è¿™ä¸ªå‘½ä»¤äº†å—ï¼Ÿï¼ˆå®é™…æ“ä½œåªéœ€è¦å»ºç«‹ä¸€ä¸ªsymbolic linkå°±å¥½äº†ï¼‰</li><li>å•ä¸ªç½‘å¡æœ€å¤š65535ä¸ªç«¯å£ï¼Œc10Kã€‚<a href="https://www.zhihu.com/question/66553828">65536å…¶å®ä¸æ˜¯æ“ä½œç³»ç»Ÿé™åˆ¶çš„ï¼Œè€Œæ˜¯tcpåè®®å°±åªç»™portç•™äº†2ä¸ªbytesç»™source portï¼Œåªç•™äº†2ä¸ªbytesç»™destination port</a>ç«¯å£å·å†™åœ¨tcpåŒ…é‡Œï¼Œipåœ°å€ä¸æ˜¯ï¼Œipåœ°å€æ˜¯ipå±‚çš„äº‹æƒ…</li><li>oAuth2åŸç†ï¼Œå…¶å®æµç¨‹ä¸Šå’Œå¾ˆå¤šå®¢æˆ·ç«¯çš„å¾®ä¿¡ç™»é™†ï¼Œæ–°æµªå¾®åšç™»é™†å¾ˆåƒçš„</li><li>åœ¨Androidæ‰‹æœºä¸Šå°è¯•ç”¨ä¸€ä¸ªunix domain socketç”¨äºlocalhostè¿›ç¨‹é—´ipc(å…¶å®å°±æ˜¯ä¿è¯ç«¯å£å·ä¸€è‡´ï¼Œç»™ç½‘ç»œæƒé™å°±å¥½äº†)ã€‚æœ‰ä¸€ä¸ª<a href="https://github.com/jnr/jnr-unixsocket">jnr</a>é¡¹ç›®ï¼Œç”¨jniçš„æ–¹å¼æä¾›äº†å„ä¸ªå¹³å°ä¸Šçš„unix domain socketçš„javaè°ƒç”¨å®ç°ã€‚</li><li>å†™ groovy ç”¨intelijå…¨å®¶æ¡¶å°±å¯ä»¥äº†ï¼Œgroovyçš„<a href="https://www.tutorialspoint.com/groovy/groovy_closures.htm">è¯­æ³•</a>å…¶å®æ²¡ä»€ä¹ˆï¼Œä¸»è¦æ˜¯äº†è§£ç¼–è¯‘çš„æµç¨‹å’ŒåŸºæœ¬åŸç†ï¼Œè¿™ä¸ªéœ€è¦çœ‹<a href="https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:build_phases">official doc</a></li><li><a href="https://github.com/JLLK/gradle-android-maindexlist-plugin">å¼€å‘gradle pluginä¼˜åŒ–MultiDex</a>ã€‚é•¿è¿œæ¥çœ‹ï¼Œ5.0ä»¥åçš„æ‰‹æœºè¶Šæ¥è¶Šå¤šï¼ŒMultiDexä¹Ÿä¸å€¼å¾—è¿‡äºå…³æ³¨ã€‚</li><li>intelij ç‚¹å‡»run å®é™…è°ƒç”¨çš„command lineæ˜¯ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯javacï¼Œç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶æ”¾åˆ°äº†targetæ–‡ä»¶å¤¹ï¼Œç´§æ¥ç€ç”¨javaå‘½ä»¤å¸¦ä¸Šä¸€å¤§ä¸²classpathå»è°ƒç”¨ä¸»å‡½æ•°</li><li><a href="https://fucknmb.com/2017/05/11/Android-Studio-Library%E6%A8%A1%E5%9D%97%E4%B8%ADNative%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8Cdebug%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/">Android Studio ç¼–è¯‘è¿‡ç¨‹</a>ï¼Œå…¶å®å°±æ˜¯gradle assembleXXX å¥½äº†ä¹‹åadb pushåˆ°æ‰‹æœºä¸Šï¼Œå†å®‰è£…ï¼Œæœ€åèµ·ä¸»ç•Œé¢</li><li><a href="http://mouxuejie.com/blog/2016-06-21/multidex-compile-and-dex-source-analysis/">Android ç¼–è¯‘åŠ Dex è¿‡ç¨‹æºç åˆ†æ</a></li><li><a href="http://www.wangyuwei.me/">å¦‚ä½•è°ƒè¯• Android æ‰“åŒ…æµç¨‹ï¼Ÿ</a>ï¼Œä¸€ä¸ªremoteçš„äº‹</li><li><a href="https://github.com/chenenyu/img-optimizer-gradle-plugin">ä¸€ä¸ªç”¨äºä¼˜åŒ– png å›¾ç‰‡çš„ gradle æ’ä»¶</a>ï¼Œç”¨æ¥çœ‹ groovy è¯­æ³•æŒºå¥½çš„ã€‚ä»¥åŠ <a href="http://yuanfentiank789.github.io/2017/09/20/%E5%9C%A8AndroidStudio%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89Gradle%E6%8F%92%E4%BB%B6/">How to write gradle plugin</a></li><li>XSS æ”»å‡»,DOM basedå’ŒStored XSS,åŸºæœ¬ä¸Šå°±æ˜¯ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„è¾“å…¥ï¼Œé™¤äº†åˆæ³•è¾“å…¥ä»¥å¤–ä¸€å¾‹è¿‡æ»¤æ‰</li></ul><ul><li>Websocket nodejsï¼Œå±€é™æ€§å°±æ˜¯å‰åå°éƒ½å¾—ç”¨socket.ioçš„åº“ã€‚å‰ç«¯æ˜¯æµè§ˆå™¨çš„è¯è¿˜å¥½ï¼Œappçš„è¯java,Androidéƒ½æœ‰å¯¹åº”çš„å®ç°.[å…¶å®å°±æ˜¯socket io] </li><li>[ä½¿ç”¨Spring bootåå°æä¾›protobufæ¥å£å®ç°å®¢æˆ·ç«¯é€šä¿¡] ä¸è¦ä½¿ç”¨protobf-gradle-pluginäº†ã€‚ç›´æ¥å†™è„šæœ¬ç”¨protocå»ç”Ÿæˆæ–‡ä»¶ï¼ŒæŒ‡å®šç”Ÿæˆæ–‡ä»¶çš„è·¯å¾„è¦å’Œprotoé‡Œé¢å†™çš„åŒ…åå¯¹çš„ä¸Šã€‚å¦å¤–å°±æ˜¯å®¢æˆ·ç«¯å’Œserverç«¯ä¾èµ–çš„protobufç‰ˆæœ¬ä»¥åŠprotocå·¥å…·çš„ç‰ˆæœ¬å¾—ä¸€è‡´ï¼Œæ¯”å¦‚éƒ½æ˜¯3.5ã€‚è¿˜æœ‰å°±æ˜¯protocçš„è¯­æ³•ï¼Œä»€ä¹ˆimportçš„æ¯”è¾ƒçƒ¦ã€‚</li><li>[X] ä½¿ç”¨jinja2ç”Ÿæˆæ–‡ä»¶ã€‚<a href="https://github.com/guokr/swagger-py-codegen">ä¸€ä¸ªæ¯”è¾ƒå¥½ç©çš„ä»£ç ç”Ÿæˆå™¨</a></li><li>[X] URL Encoding,å°±æ˜¯é‚£ä¸ªåœ¨ç½‘å€é‡ŒæŠŠå­—ç¬¦è½¬æˆç™¾åˆ†å·åŠ ä¸ŠUTF-8çš„<a href="http://www.ruanyifeng.com/blog/2010/02/url_encoding.html">æ‰¾åˆ°äº†é˜®ä¸€å³°è€å¸ˆçš„è§£é‡Š</a></li><li>[X] é€šè¿‡file inputä¸Šä¼ å›¾ç‰‡ï¼ŒåŸç”Ÿajaxä»¥åŠAjaxï¼Œè‡ªå·±æ­å»ºä¸Šä¼ æœåŠ¡å™¨<a href="https://zhuanlan.zhihu.com/p/24513281?refer=flask">å¤§æ¦‚èƒ½çŒœåˆ°æš´é£å½±éŸ³çš„å±€åŸŸç½‘ä¼ è¾“å®ç°äº†</a>ç”¨flaskçš„è¯è‡ªå·±æ­å»ºå¥½åå°æœ€ç®€å•äº†ï¼Œæœ€å¤šå†ä½¿ç”¨flask-wtfå’Œflask-uploadè§„èŒƒæ“ä½œ</li><li>[X]Promise é“¾å¼è°ƒç”¨ä¸ç»ˆæ­¢ï¼Œå¼‚å¸¸å¤„ç†(åªæ˜¯ä¸€ä¸ªå·¥å…·è€Œå·²)</li><li>[X] Android åº”ç”¨æ¥å…¥buglyçƒ­ä¿®å¤ï¼Œä¸Šçº¿ä¹‹åå°±ä¸ç”¨èƒŒé”…äº†ï¼ˆæœ‰å…´è¶£çœ‹çœ‹sevenZip.jarï¼Œæš‚æ—¶æ²¡çœ‹ï¼‰</li><li>[X] <a href="http://normanmaurer.me/blog/2013/11/09/The-hidden-performance-costs-of-instantiating-Throwables/">nettyä½œè€…çš„åšå®¢</a>ä»¥åŠjvm çš„inlineç­‰ä¼˜åŒ–</li><li>[ ] <a href="https://seisman.github.io/how-to-write-makefile/introduction.html">å¦‚ä½•å†™makefile</a>å…¶å®<a href="http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/">è¿™ä¸ªæ›´åŠ friendly</a></li><li>[X] <a href="https://www.jianshu.com/p/534741f5151c">libmp3lameç§»æ¤åˆ°Android</a>,è¯¥æ•™ç¨‹é’ˆå¯¹çš„lameç‰ˆæœ¬æ˜¯3.99.5</li><li><a href="https://sspai.com/post/31500">scheme è¿™ä¸œè¥¿ç®—è·¨å®¢æˆ·ç«¯å¹³å°çš„</a>ï¼Œæ¯”å¦‚åœ¨ App ä¸­è°ƒèµ·æ”¯ä»˜å®(ç”¨çš„æ˜¯ alipayqr://)ã€‚å…¶å®å°±æ˜¯ä¸€ä¸ªç³»ç»Ÿå†…è·¨åº”ç”¨è°ƒç”¨ã€‚<a href="http://blog.csdn.net/qq_23547831/article/details/51685310">ç”¨æ³•</a><br>è¿™ä¸ªä¸»è¦æ˜¯ios appä¹‹é—´é€šä¿¡çš„åè®®ï¼Œä»¥åŠå¿«é€Ÿè·³è½¬æŸä¸ªappæŸä¸ªé¡µé¢çš„åŠŸèƒ½å®ç°ï¼Œè¿˜æœ‰x-callback-URLè¿™æ ·ç±»ä¼¼çš„åè®®ã€‚ä¸è¿‡æœ‰äº†3d-touchï¼ˆè‹¹æœåæ¥åˆæŠŠ3D-Touchå¹²æ‰äº†ï¼‰ä¹‹åï¼Œå¾ˆå¤šappéƒ½èƒ½é•¿æŒ‰å›¾æ ‡è¿›å…¥é¡µé¢ï¼Œæ‰€ä»¥url schemeè¿™ä¸ªåŠŸèƒ½åªèƒ½è¯´æ˜¯ä¸å¤å¾€æ—¥è¾‰ç…Œäº†</li><li>[X]linuxçš„sedå‘½ä»¤(æ–‡æœ¬æ›¿æ¢æ¯”è¾ƒå¸¸ç”¨)</li><li><a href="https://juejin.im/post/59fffdb76fb9a0450a66bd58">nio</a> è¿˜æ˜¯nettyå¥½ã€‚ä¹Ÿå¯ä»¥çœ‹ç‚¹åˆ«çš„<a href="http://ifeve.com/java-nio%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89-java-nio-files/">å¹¶å‘ç¼–ç¨‹ç½‘</a></li><li>[X]js çš„async await,å°±æ˜¯ä¸€ä¸ªasyncä¿®é¥°ä¸€ä¸ªmethodï¼Œé‡Œé¢éšä¾¿å†™await, await on ä¸€ä¸ªPromiseå°±å¯ä»¥äº†</li><li>[X] Linuxä¸‹TCPå»¶è¿Ÿç¡®è®¤æœºåˆ¶ ä»¥åŠsocket timeoutçš„éƒ¨åˆ†åŸå› ï¼ˆnet.ipv4.tcp_syn_retriesï¼Œå¦‚æœ TCP æ¡æ‰‹çš„ SYN åŒ…è¶…æ—¶é‡è¯•æŒ‰ç…§ 2 çš„å¹‚æ¥ backoffï¼‰</li><li>[X]cè¯­è¨€çš„<a href="https://yq.aliyun.com/articles/413601">libeventä½¿ç”¨æ•™ç¨‹</a> eventloopï¼Œæ·»åŠ å›è°ƒï¼Œå¤§è‡´çš„æµç¨‹å°±æ˜¯è¿™æ ·</li><li>[X] <a href="http://www.ruanyifeng.com/blog/2018/07/indexeddb.html">indexed DB</a>,æµè§ˆå™¨ç«¯æ•°æ®åº“ï¼Œè¿˜æ˜¯ç”¨ç¬¬ä¸‰æ–¹åº“å¥½</li><li>[X] <a href="http://forums.justlinux.com/showthread.php?3261-Block-size-vs-page-size">block size vs page size</a> Pageæ˜¯å†…å­˜ç›¸å…³ï¼Œblockæ˜¯ç¡¬ç›˜ç›¸å…³çš„</li><li>[X] python çš„asyncio(eventloop , generator, coroutine)</li><li>[X]<a href="https://vim.rtorr.com/">Vim cheet sheet</a> vimå¤šç”¨ç”¨å°±ç†Ÿæ‚‰äº†ã€‚</li><li>[X] python dunder classå¤ä¹ ã€‚çŸ¥é“æœ‰python descriptorè¿™å›äº‹å°±è¡Œäº†ã€‚</li><li>[X] formè¡¨å•å¯ä»¥è·¨åŸŸä¸€ä¸ªæ˜¯å†å²åŸå› è¦ä¿æŒå…¼å®¹æ€§ï¼ˆå°±æ˜¯è¯´è·¨åŸŸè¿™ä»¶äº‹ï¼Œä¸€ä¸ªåŸŸåçš„ JS ï¼Œåœ¨æœªç»å…è®¸çš„æƒ…å†µä¸‹ï¼Œä¸å¾—è¯»å–å¦ä¸€ä¸ªåŸŸåçš„å†…å®¹ã€‚ä½†æµè§ˆå™¨å¹¶ä¸é˜»æ­¢ä½ å‘å¦ä¸€ä¸ªåŸŸåå‘é€è¯·æ±‚ã€‚æ‰€ä»¥postçš„è¡¨å•å¯ä»¥å‘å‡ºå»ï¼Œä½†æ˜¯åˆ«æŒ‡æœ›èƒ½å¤Ÿæ‹¿åˆ°responseï¼‰</li><li>[X] a new article on open-gl intro(åœ¨Androidå¹³å°ä¸Šè¦å’ŒMediaCodecç›¸å…³çš„éŸ³è§†é¢‘æ ¼å¼ç»“åˆç€æ¥ä¸€èµ·çœ‹)</li><li>[X] JavaScriptä¸­new FileReader(å±äºhtml5çš„ä¸œè¥¿)ï¼Œä»¥åŠcanvas api(lineTo,quardToè¿™äº›éƒ½æ˜¯ç›¸è¿‘çš„),ä»¥åŠ<a href="https://juejin.im/post/5a98c5c26fb9a028d82b34ee">jsè¿›è¡Œå›¾ç‰‡ç¼©æ”¾å’Œè£å‰ª</a> </li><li>[X] tcp-proxyå®ç”¨æ•™ç¨‹ </li><li>[X]Exoplayer and the MediaCodec api<a href="https://medium.com/androiddevelopers/building-a-video-player-app-in-android-part-3-5-19543ea9d416">building-a-video-player-app-in-android</a> </li><li><a href="https://www.youtube.com/watch?v=g3F7Imjcd4k">AC2016è…¾è®¯å‰ç«¯æŠ€æœ¯å¤§ä¼š 1 1 1 H5ç›´æ’­é‚£äº›äº‹</a></li><li>[X] tcp-proxyå®ç”¨æ•™ç¨‹(tcp replay or udp relay)</li><li>[X] render-script utility</li><li>[X]Cè¯­è¨€forkè¿›ç¨‹ä»¥åŠè¿›ç¨‹ä¹‹é—´é€šä¿¡çš„å¥—è·¯</li><li>[X] flex,grid. cssçš„box-sizeçœŸæ˜¯å‘äºº</li><li>[X] rxjavaæ˜¯å¦‚ä½•åˆ‡æ¢çº¿ç¨‹çš„ä»¥åŠæºç è§£æï¼ŒObserveOnObserverå’ŒObservableSubscribeOnå®ä¾‹æ˜¯æ¡¥æ¢</li><li>[X] jdk7å¼€å§‹æä¾›fork join poolæ–¹æ³•ï¼Œå°†ä»»åŠ¡åˆ†é…åˆ°å¤šä¸ªçº¿ç¨‹ä¸Šå¤„ç†(ä¸é€‚åˆioå¯†é›†å‹æ“ä½œ)</li><li>[X] <a href="https://github.com/keerath/openjdk-8-source/blob/master/jdk/src/windows/native/java/net/SocketOutputStream.c">openjdkçš„Cè¯­è¨€å®ç°å¯ä»¥éšä¾¿è°ƒå‡ å¤„æ¥çœ‹çœ‹</a></li><li>[X] å®‰è£…å¹¶ä½¿ç”¨MAT åˆ†æjavaåº”ç”¨å†…å­˜ã€‚</li><li>[X]how does jvm parse class file and the code structure of .class file(how do we manipulate .class file like in asm) ç…§ç€ä¸€ä¸ªjava classfile viewerçœ‹ç»“æ„å°±å¯ä»¥äº†ï¼Œå¦‚æœä¸æ˜¯æ‰“ç®—æ·±å…¥è™šæ‹Ÿæœºçš„è¯ï¼Œæ²¡å¿…è¦ã€‚</li><li>[X] javaçš„aspectJæ•™ç¨‹(AspectJ å±äºé™æ€ç»‡å…¥ï¼Œæ˜¯åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆä»£ç†ç±»ï¼Œæ€§èƒ½ä¼˜äºåŠ¨æ€ç»‡å…¥)ã€‚Spring AOPä¸AspectJ å®ç°åŸç†ä¸Šå¹¶ä¸å®Œå…¨ä¸€è‡´. Springæä¾›äº†ä¸¤ç§æ–¹å¼æ¥ç”Ÿæˆä»£ç†å¯¹è±¡: JdkProxy(åŸºäºjdkåŠ¨æ€ä»£ç†,å‰ææ˜¯ç›®æ ‡æ˜¯æœ‰æ¥å£çš„)å’ŒCglib(åŸºäºasmï¼Œç”¨äºå®ç°å¯¹ç±»çš„ä»£ç†)ã€‚å®é™…ä¸Šï¼ŒSpring åªæ˜¯ä½¿ç”¨äº†ä¸ AspectJ ä¸€æ ·çš„æ³¨è§£ï¼Œæ²¡æœ‰ä½¿ç”¨ AspectJ çš„ç¼–è¯‘å™¨ ï¼Œè½¬å‘é‡‡ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯çš„å®ç°åŸç†æ¥æ„å»º Spring AOP çš„å†…éƒ¨æœºåˆ¶ï¼ˆåŠ¨æ€ç»‡å…¥ï¼‰ï¼Œè¿™æ˜¯ä¸ AspectJï¼ˆé™æ€ç»‡å…¥ï¼‰æœ€æ ¹æœ¬çš„åŒºåˆ«ã€‚</li><li>[X] jsçš„é—­åŒ…ï¼ˆclosureï¼‰ç­‰é¢è¯•å¸¸è°ˆ <a href="https://stackoverflow.com/questions/111102/how-do-javascript-closures-work?rq=1">closure under the hood</a></li><li>[X] build a program that use libcurl , sudo apt install liccurl4-openssl-dev<br>,ç¼–è¯‘æ—¶ä½¿ç”¨gcc -lcurl,curl performæ˜¯åŒæ­¥çš„ã€‚</li><li>[X]<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition">content-disposition</a></li><li>[x] ç”¨æ­£åˆ™æ£€æµ‹æˆ–è€…è§£æjson(jQueryæºç é‡Œæœ‰) åœ¨çº¿æ­£åˆ™æ£€æµ‹ç½‘ç«™ï¼Œä¹Ÿå°±æ˜¯Jsä¸­çš„Regå¯¹è±¡</li><li>[X] Reduxå’ŒFluxå¾ˆåƒ,react context api(æ„Ÿè§‰æœ‰ç‚¹åƒè§‚å¯Ÿè€…æ¨¡å¼)</li><li><a href="https://css-tricks.com/NetMag/FluidWidthVideo/Article-FluidWidthVideo.php">embeed video with iframe</a></li><li>jdk8 standard Library implementation detail(javaä»£ç çš„å®ç° â€“&gt; hotspotä»£ç çš„cè¯­è¨€å®ç°) å¾ˆå¤šéƒ½æ˜¯c++å†™çš„</li><li>[X] ç†Ÿç»ƒæŒæ¡java8çš„stream,lambda,optionalç­‰è¯­æ³•ã€‚è¿˜æ˜¯è¦å¤šå¤šç»ƒä¹ </li></ul><h3 id="Good-For-Nothing"><a href="#Good-For-Nothing" class="headerlink" title="Good For Nothing"></a>Good For Nothing</h3><ul><li>[ ] ç”¨GDBè°ƒè¯•ç¨‹åº</li><li>[ ] npm install graphql(mostly a server side javascript stuff)</li><li>ä½¿ç”¨ express æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</li><li><a href="https://juejin.im/post/5a157b7a5188257bfe457ff0">åŸºäº Docker æ‰“é€ å‰ç«¯æŒç»­é›†æˆå¼€å‘ç¯å¢ƒ</a></li><li>vS Code Vender Prefix plugin =&gt; auto prefix loader</li><li>å‰åç«¯åˆ†ç¦»</li><li>sqlæ¼æ´</li><li><a href="https://cloud.tencent.com/developer/article/1004755">æ·±å…¥æµ…å‡ºè…¾è®¯äº‘ CDNï¼šç¼“å­˜ç¯‡</a>ä¸ç®¡SSDç›˜æˆ–è€…SATAç›˜éƒ½æœ‰æœ€å°çš„æ“ä½œå•ä½ï¼Œå¯èƒ½æ˜¯512Bï¼Œ4KBï¼Œ8KBã€‚å¦‚æœè¯»å†™è¿‡ç¨‹ä¸­ä¸è¿›è¡Œå¯¹é½ï¼Œåº•å±‚çš„ç¡¬ä»¶æˆ–è€…é©±åŠ¨å°±éœ€è¦æ›¿åº”ç”¨å±‚æ¥åšå¯¹é½æ“ä½œï¼Œå¹¶å°†ä¸€æ¬¡è¯»å†™æ“ä½œåˆ†è£‚ä¸ºå¤šæ¬¡è¯»å†™æ“ä½œã€‚</li><li>Androidè¿›ç¨‹çš„<a href="https://juejin.im/post/5a646211f265da3e3f4cc997">åŠ è½½æµç¨‹</a></li><li>å‰åç«¯åŒæ„</li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-nginx-with-ssl-as-a-reverse-proxy-for-jenkins">install nginx , jenkin ci, deploying nginx in docker(Http Load Balaning with Docker and nginx)</a></li><li>[ ] ç½‘æ˜“äº‘éŸ³ä¹API</li><li>[X] Djangoéƒ¨ç½²ä¸ªäººç½‘ç«™(Gunicornï¼ŒNginx)ã€‚djangoå†™templateå°±ä¸æ˜¯å‰åç«¯åˆ†ç¦»äº†</li><li>[ ] Docker<a href="https://medium.com/@elye.project/intro-to-docker-building-android-app-cb7fb1b97602">intro-to-docker-building-android-app</a> è¿™ç¯‡æ–‡ç« å…¶å®æ˜¯ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯Build docker image(docker build xxxx),å¦ä¸€ä¸ªæ˜¯run (docker run xxx)</li><li>[ ] <a href="https://blog.csdn.net/u013553529/article/details/53856800">å’Œç½‘é¡µç±»ä¼¼ï¼ŒActivityä¹Ÿæœ‰ä¸€ä¸ªrefererçš„æ¦‚å¿µ</a>ï¼Œç”¨äºåˆ¤æ–­å½“å‰é¡µé¢æ˜¯ç”±è°å‘èµ·è¯·æ±‚çš„<br>OpenTypeÂ® is a cross-platform font file format developed jointly by Adobe and Microsoft.</li><li>[ ]<a href="https://blog.securem.eu/serverside/2015/08/25/setting-up-owncloud-server-in-a-docker-container/">deploying owncloud using docker</a></li><li><a href="https://doc.owncloud.org/server/10.0/admin_manual/installation/docker/">owncloudå®˜æ–¹çš„é…åˆdockerå®‰è£…æ•™ç¨‹</a>ç½‘ç›˜è¿™ç§ä¸œè¥¿çœ‹ä¸ªäººå–œå¥½äº†</li><li>[ ]CloudFlare cdnè§£æä»¥åŠDNSé˜²æŠ¤ </li><li>[ ] <a href="https://www.tutorialspoint.com/python/python_further_extensions.htm">python c extension</a> </li><li>[ ] <a href="https://github.com/elliotforbes/tutorialedge-rest-api">æœ€ç®€å•çš„ä¸€ä¸ªç”¨goå†™å‡ºæ¥çš„rest apiå¤§æ¦‚é•¿è¿™æ ·</a></li><li>[ ]<a href="https://lxneng.com/posts/201">åˆ†è¯å™¨</a></li><li>[ ]<a href="http://www.wklken.me/posts/2015/04/26/elk-for-nginx-log.html">LOGSTASH+ELASTICSEARCH+KIBANAå¤„ç†NGINXè®¿é—®æ—¥å¿—</a>ELKå…¨å®¶æ¡¶, logstashæ¥ç®¡è½¯ä»¶æ—¥å¿—</li><li>[ ] <a href="https://gist.github.com/quexer/3619237">å¦‚ä½•ç¼–å†™ jQuery æ’ä»¶</a></li><li>netfilteræ¡†æ¶(imbedded in linux server)</li><li>[] javaå®ç°lambdaçš„åŸç†<a href="https://colobu.com/2014/11/06/secrets-of-java-8-lambda/">invokedynamicä»¥åŠLambdaMetafactoryç­‰</a></li><li>[ ] libuv,elfæ–‡ä»¶æ ¼å¼è§£æ</li><li>[X] <a href="https://www.infoq.cn/article/deep-in-websocket-protocol">WebSocketåè®®åŠæ•°æ®å¸§</a></li><li>[ ] linuxç¯å¢ƒä¸‹å¤šè¿›ç¨‹é€šè®¯æ–¹å¼(ç®¡é“ï¼Œå…±äº«å†…å­˜ï¼Œä¿¡å·,unix domian socket)</li><li>[ ] play around with xposed</li><li>[ ] python guiç¼–ç¨‹</li><li>[ ] æ¥æ¥æ¥ï¼Œ<a href="https://www.youtube.com/watch?v=DUNkdl0Jhgs">æ‰‹å†™ä¸€ä¸ªvm</a></li><li>[ ]<a href="https://www.youtube.com/watch?v=M8LiOANu3Nk">How the JVM compiles bytecode into machine code</a></li><li>[ ] <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/windows_build_instructions.md#System-requirements">chromiumæä¾›äº†å¦‚ä½•åœ¨windowsä¸Šç¼–è¯‘chromiumçš„æ•™ç¨‹</a></li><li>iviewï¼ŒelementUi</li><li>[ ]ä¸€è‡´æ€§å“ˆå¸ŒåŸç†</li><li>[ ] <a href="http://afghl.github.io/2018/06/17/distributed-lock-and-granarity.html">ä½¿ç”¨rediså®ç°ä½ç²’åº¦çš„åˆ†å¸ƒå¼é”</a></li><li>[ ] python sendall will block? what if tcp buffer is full , like when advertised windows size is zero. <a href="https://www.brianstorti.com/tcp-flow-control/">tcp flow control</a></li><li>[ ] rust and WebAssembly, <a href="https://www.ibm.com/developerworks/cn/web/wa-lo-webassembly-status-and-reality/index.html"> WebAssembly å¹¶ä¸æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œè€Œæ˜¯ä¸€ä»½å­—èŠ‚ç æ ‡å‡†ï¼Œéœ€è¦ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å‡ºå­—èŠ‚ç æ”¾åˆ° WebAssembly è™šæ‹Ÿæœºä¸­æ‰èƒ½è¿è¡Œï¼Œ æµè§ˆå™¨å‚å•†éœ€è¦åšçš„å°±æ˜¯æ ¹æ® WebAssembly è§„èŒƒå®ç°è™šæ‹Ÿæœº</a></li></ul><p><a href="https://jsonplaceholder.typicode.com/">jsonplaceholder</a>æ‡’å¾—è‡ªå·±å†™apiçš„è¯<br>å°±ç”¨è¿™ä¸ªå§</p><script>console.log("hey there")</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€ä¸ªå¾…åŠäº‹é¡¹çš„ä»“åº“&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/girlfriend lake green nature water cold.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="tools" scheme="https://haldir65.github.io/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>javaScriptä¸­çš„common mistakes</title>
    <link href="https://haldir65.github.io/2020/01/29/2020-01-29-javascript-the-weird-parts/"/>
    <id>https://haldir65.github.io/2020/01/29/2020-01-29-javascript-the-weird-parts/</id>
    <published>2020-01-29T17:20:16.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>javaScriptä¸­çš„ä¸€äº›å®¹æ˜“çŠ¯é”™çš„åœ°æ–¹ ğŸ‚ ğŸˆ ğŸ… ğŸ¦ ğŸŒ¶ ğŸ¥’ ğŸ‘ çœŸæ˜¯ä¸€é—¨ç¥å¥‡çš„è¯­è¨€<br>ğŸ‰ ğŸŒ®<br><img src="https://api1.foster66.xyz/static/imgs/guoqing_ZH-CN10903461145_1920x1080.jpg" alt=""></p><a id="more"></a><p><a href="https://www.w3schools.com/js/js_let.asp">ä»w3schoolå­¦åˆ°ä¸€äº›æ–°çš„çŸ¥è¯†</a></p><h3 id="5ç§åŸºæœ¬æ•°æ®ç±»å‹"><a href="#5ç§åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="5ç§åŸºæœ¬æ•°æ®ç±»å‹"></a>5ç§åŸºæœ¬æ•°æ®ç±»å‹</h3><pre><code>stringnumberbooleanobjectfunction</code></pre><h4 id="6ç§object-ç±»å‹"><a href="#6ç§object-ç±»å‹" class="headerlink" title="6ç§object ç±»å‹"></a>6ç§object ç±»å‹</h4><pre><code>ObjectDateArrayStringNumberBoolean</code></pre><h3 id="ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œä¸å«valueçš„ç±»å‹"><a href="#ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œä¸å«valueçš„ç±»å‹" class="headerlink" title="ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œä¸å«valueçš„ç±»å‹"></a>ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œä¸å«valueçš„ç±»å‹</h3><pre><code class="js">nullundefined</code></pre><p>ä½¿ç”¨typeofå…³é”®å­—å¯ä»¥æŸ¥çœ‹å¯¹åº”çš„ç±»å‹ï¼Œtypeofæ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œè¿”å›å€¼ä¸€å®šæ˜¯ä¸€ä¸ªstring</p><pre><code class="js">typeof &quot;John&quot;                 // Returns &quot;string&quot;typeof 3.14                   // Returns &quot;number&quot;typeof NaN                    // Returns &quot;number&quot;typeof false                  // Returns &quot;boolean&quot;typeof [1,2,3,4]              // Returns &quot;object&quot;typeof {name:&#39;John&#39;, age:34}  // Returns &quot;object&quot;typeof new Date()             // Returns &quot;object&quot;typeof function () {}         // Returns &quot;function&quot;typeof myCar                  // Returns &quot;undefined&quot; *typeof null                   // Returns &quot;object&quot;typeof undefined              // Return &quot;undefined&quot;</code></pre><p>ä½†æ˜¯typeofæ— æ³•åˆ¤æ–­ä¸€ä¸ªobjectæ˜¯ä¸æ˜¯arrayæˆ–è€…æ˜¯ä¸æ˜¯date</p><pre><code class="js">function isArray(myArray) {  return myArray.constructor.toString().indexOf(&quot;Array&quot;) &gt; -1;}//æˆ–è€…function isArray(myArray) {  return myArray.constructor === Array;}// å†æˆ–è€…Array.isArray() //The isArray() method checks whether an object is an array//Dateå°±å¾—è¿™ä¹ˆåˆ¤æ–­function isDate(myDate) {  return myDate.constructor === Date;}//stringè½¬intï¼Œå±…ç„¶è¿™ä¹Ÿè¡ŒparseInt(&quot;10 years&quot;)10parseFloat(&#39;20.12HAHA1&#39;)// 20.12//ä¸€äº›è‡ªåŠ¨çš„ç±»å‹è½¬æ¢çš„ç»“æœå°±è®©äººçœ‹ä¸æ‡‚äº†&quot;5&quot; + 2 // &quot;52&quot;&quot;5&quot; - 2  // 3// numberè½¬stringlet n = 10.001n.toFixed(2) // &quot;10.00&quot; å¯ä»¥è®¤ä¸ºtoFixedå°±æ˜¯ä¿ç•™å°æ•°ç‚¹åå‡ ä½æ•°å­—äº†n.toFixed(3) // &quot;10.001&quot;n.toPrecision(6) // &quot;10.0030&quot; å¯ä»¥è®¤ä¸ºtoPrecisionæ˜¯è¿å¸¦æ•´æ•°ä½ä¿ç•™å‡ ä½æ•°å­—</code></pre><h3 id="ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹"><a href="#ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹" class="headerlink" title="ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹"></a>ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹</h3><p><a href="https://stackoverflow.com/questions/5849256/javascript-different-return-types">Javascript: Different return types</a></p><pre><code class="js">somefn = function(e) {    switch (e.type)     {       case &#39;mousedown&#39;:         return false;       case &#39;mousemove&#39;:         return {x:10, y:20};    } };somefn({type: &#39;foo&#39;});  //undefined</code></pre><p>ä»¥ä¸Šå‡½æ•°å®Œå…¨å¯ä»¥è¿è¡Œ</p><h2 id="ç¥å¥‡çš„hoist"><a href="#ç¥å¥‡çš„hoist" class="headerlink" title="ç¥å¥‡çš„hoist"></a>ç¥å¥‡çš„hoist</h2><p><a href="https://www.w3schools.com/js/js_hoisting.asp">Hoisting is JavaScriptâ€™s default behavior of moving all declarations to the top of the current scope (to the top of the current script or the current function</a> ä¸€ä¸ªå˜é‡å¯ä»¥å…ˆä½¿ç”¨å†å£°æ˜ï¼ˆä½¿ç”¨varå…³é”®å­—çš„è¯ï¼‰ï¼Œä½†æ˜¯Variables and constants declared with let or const are not hoisted!</p><h3 id="hoistingå¯¹äºå‡½æ•°ä¹Ÿæœ‰å½±å“"><a href="#hoistingå¯¹äºå‡½æ•°ä¹Ÿæœ‰å½±å“" class="headerlink" title="hoistingå¯¹äºå‡½æ•°ä¹Ÿæœ‰å½±å“"></a>hoistingå¯¹äºå‡½æ•°ä¹Ÿæœ‰å½±å“</h3><p><a href="https://stackoverflow.com/questions/336859/var-functionname-function-vs-function-functionname?rq=1">var functionName = function() {} vs function functionName() {}</a> è¿™ä¿©æœ‰ä»€ä¹ˆåŒºåˆ«</p><pre><code class="js">// functionOne å¦‚æœæ²¡æœ‰èµ°åˆ°è¿™ä¸€è¡Œçš„è¯æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„// TypeError: functionOne is not a functionfunctionOne();//ä¸‹é¢è¿™ä¸ªå…¶å®è¿™ä¸ªå«åš&quot;Anonymous&quot; function Expressionvar functionOne = function() {  console.log(&quot;Hello!&quot;);};</code></pre><pre><code class="js">// å› ä¸ºhoistçš„åŸå› ï¼Œ functionTwoçš„å®šä¹‰ä¼šè¢«æŒªåˆ°æœ€ä¸Šé¢// Outputs: &quot;Hello!&quot;functionTwo();function functionTwo() {  console.log(&quot;Hello!&quot;);}// hoistçš„å­˜åœ¨ä¹Ÿå°±æ„å‘³ç€ï¼Œ ä¸‹é¢è¿™æ®µï¼Œæ— è®ºtestæ˜¯trueè¿˜æ˜¯false ï¼Œå¤–éƒ¨éƒ½èƒ½å¤Ÿè°ƒç”¨åˆ°functionThreeï¼Œé™¤éæ˜¯use-strictif (test) {   // Error or misbehavior   function functionThree() { doSomething(); }}</code></pre><p>This is called a Function Expression:</p><pre><code class="js">var getRectArea = function(width, height) {    return width * height;};console.log(&quot;Area of Rectangle: &quot; + getRectArea(3,4));// This should return the following result in the console: // Area of Rectangle: 12</code></pre><p>This is called a Function Declaration:</p><pre><code class="js">var w = 5;var h = 6;function RectArea(width, height) {  //declaring the function  return area = width * height;}                                   //note you do not need ; after }RectArea(w,h);                      //calling or executing the functionconsole.log(&quot;Area of Rectangle: &quot; + area);// This should return the following result in the console: // Area of Rectangle: 30</code></pre><h2 id="letå’Œvarçš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯block-scope"><a href="#letå’Œvarçš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯block-scope" class="headerlink" title="letå’Œvarçš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯block scope"></a>letå’Œvarçš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯block scope</h2><pre><code class="js">{  var x = 2;}// x CAN be used here{  let x = 2;}// x can NOT be used here</code></pre><pre><code class="js">var i = 5;for (var i = 0; i &lt; 10; i++) {  // some statements}// Here i is 10let i = 5;for (let i = 0; i &lt; 10; i++) {  // some statements}// Here i is 5</code></pre><h3 id="ES6çš„classçš„å¯ä»¥è‡ªå®šä¹‰getå’Œsetæ–¹æ³•"><a href="#ES6çš„classçš„å¯ä»¥è‡ªå®šä¹‰getå’Œsetæ–¹æ³•" class="headerlink" title="ES6çš„classçš„å¯ä»¥è‡ªå®šä¹‰getå’Œsetæ–¹æ³•"></a>ES6çš„classçš„å¯ä»¥è‡ªå®šä¹‰getå’Œsetæ–¹æ³•</h3><pre><code class="js">class Car {  constructor(brand) {    this.carname = brand;  }  get cnam() {    return this.carname;  }  set cnam(x) {    this.carname = x;  }}mycar = new Car(&quot;Ford&quot;);mycar.cnam;mycar.cnam();//ä¸éœ€è¦è¿™æ ·å†™</code></pre><p>å¦å¤–ï¼Œgetå’Œsetæ–¹æ³•ä¸èƒ½å–å’ŒfieldNameä¸€æ ·çš„ï¼Œä¾‹å¦‚è¿™é‡Œçš„carname()ï¼Œæ‰€ä»¥å¾ˆå¤šå¼€å‘è€…å–œæ¬¢è¿™ä¹ˆå¹²<br>å˜é‡åå‰é¢åŠ ä¸ª_ï¼Œä¾‹å¦‚_carnameï¼Œè¿™æ ·getå’Œsetæ–¹æ³•å°±å¯ä»¥ç”¨å¯¹åº”çš„åå­—äº†ã€‚</p><pre><code class="js">class Car {  constructor(brand) {    this._carname = brand;  }  get carname() {    return this._carname;  }  set carname(x) {    this._carname = x;  }}mycar = new Car(&quot;Ford&quot;);mycar.carname;//è¿™æ ·å°±å¯ä»¥äº†</code></pre><h3 id="stringå’ŒString-â€œâ€-è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„"><a href="#stringå’ŒString-â€œâ€-è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„" class="headerlink" title="stringå’ŒString(â€œâ€)è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„"></a>stringå’ŒString(â€œâ€)è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„</h3><pre><code class="js">var x = &quot;John&quot;;             var y = new String(&quot;John&quot;);(x === y) // is false because x is a string and y is an object.var x = new String(&quot;John&quot;);             var y = new String(&quot;John&quot;);(x == y) // is false because you cannot compare objects.</code></pre><p>æ‰€ä»¥å°½é‡ä½¿ç”¨primitivesï¼Œä¸è¦ä½¿ç”¨Number, String,Booleanè¿™ç§object</p><pre><code>Use {} instead of new Object()Use &quot;&quot; instead of new String()Use 0 instead of new Number()Use false instead of new Boolean()Use [] instead of new Array()Use /()/ instead of new RegExp()Use function (){} instead of new Function()</code></pre><h3 id="jsé‡Œé¢variableçš„ç±»å‹æ˜¯å¯ä»¥æ”¹å˜çš„"><a href="#jsé‡Œé¢variableçš„ç±»å‹æ˜¯å¯ä»¥æ”¹å˜çš„" class="headerlink" title="jsé‡Œé¢variableçš„ç±»å‹æ˜¯å¯ä»¥æ”¹å˜çš„"></a>jsé‡Œé¢variableçš„ç±»å‹æ˜¯å¯ä»¥æ”¹å˜çš„</h3><pre><code class="js">var x = &quot;Hello&quot;;     // typeof x is a stringx = 5;               // changes typeof x to a number</code></pre><h3 id="es6é‡Œé¢å‡½æ•°çš„argumentå¯ä»¥å¸¦defaultå‚æ•°"><a href="#es6é‡Œé¢å‡½æ•°çš„argumentå¯ä»¥å¸¦defaultå‚æ•°" class="headerlink" title="es6é‡Œé¢å‡½æ•°çš„argumentå¯ä»¥å¸¦defaultå‚æ•°"></a>es6é‡Œé¢å‡½æ•°çš„argumentå¯ä»¥å¸¦defaultå‚æ•°</h3><pre><code class="js">function (a=1, b=1) { /*function code*/ }</code></pre><h3 id="ä¸è¦ç”¨evalï¼Œä¸å®‰å…¨"><a href="#ä¸è¦ç”¨evalï¼Œä¸å®‰å…¨" class="headerlink" title="ä¸è¦ç”¨evalï¼Œä¸å®‰å…¨"></a>ä¸è¦ç”¨evalï¼Œä¸å®‰å…¨</h3><h3 id="ä½¿ç”¨ifçš„æ—¶å€™è¦æ³¨æ„"><a href="#ä½¿ç”¨ifçš„æ—¶å€™è¦æ³¨æ„" class="headerlink" title="ä½¿ç”¨ifçš„æ—¶å€™è¦æ³¨æ„"></a>ä½¿ç”¨ifçš„æ—¶å€™è¦æ³¨æ„</h3><pre><code class="js">var x = 0;if (x = 0)</code></pre><p>å› ä¸ºè¿™æ˜¯ä¸€ä¸ªassignment,è€ŒAn assignment always returns the value of the assignment.æ‰€ä»¥ç­‰åŒäºtrue</p><h3 id="switch-caseç”¨çš„æ¯”è¾ƒæ˜¯"><a href="#switch-caseç”¨çš„æ¯”è¾ƒæ˜¯" class="headerlink" title="switch caseç”¨çš„æ¯”è¾ƒæ˜¯==="></a>switch caseç”¨çš„æ¯”è¾ƒæ˜¯===</h3><pre><code class="js">var x = 10;switch(x) {  case 10: alert(&quot;Hello&quot;);}// ä¸ç”Ÿæ•ˆvar x = 10;switch(x) {  case &quot;10&quot;: alert(&quot;Hello&quot;);}</code></pre><h3 id="å’Œæ‰€æœ‰çš„è®¡ç®—æœºè¯­è¨€ä¸€æ ·éƒ½å­˜åœ¨æµ®ç‚¹æ•°ç²¾ç¡®åº¦é—®é¢˜"><a href="#å’Œæ‰€æœ‰çš„è®¡ç®—æœºè¯­è¨€ä¸€æ ·éƒ½å­˜åœ¨æµ®ç‚¹æ•°ç²¾ç¡®åº¦é—®é¢˜" class="headerlink" title="å’Œæ‰€æœ‰çš„è®¡ç®—æœºè¯­è¨€ä¸€æ ·éƒ½å­˜åœ¨æµ®ç‚¹æ•°ç²¾ç¡®åº¦é—®é¢˜"></a>å’Œæ‰€æœ‰çš„è®¡ç®—æœºè¯­è¨€ä¸€æ ·éƒ½å­˜åœ¨æµ®ç‚¹æ•°ç²¾ç¡®åº¦é—®é¢˜</h3><pre><code class="js">var x = 0.1;var y = 0.2;var z = x + y            // the result in z will not be 0.3// 0.30000000000000004//è¿™æ˜¯ä¸€ç§è§£å†³åŠæ³•var z = (x * 10 + y * 10) / 10;       // z will be 0.3</code></pre><h3 id="variableçš„ç±»å‹å˜åŒ–æ˜¯è‡ªåŠ¨çš„"><a href="#variableçš„ç±»å‹å˜åŒ–æ˜¯è‡ªåŠ¨çš„" class="headerlink" title="variableçš„ç±»å‹å˜åŒ–æ˜¯è‡ªåŠ¨çš„"></a>variableçš„ç±»å‹å˜åŒ–æ˜¯è‡ªåŠ¨çš„</h3><p>ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯objectå˜æˆäº†array</p><pre><code class="js">var person = [];person[&quot;firstName&quot;] = &quot;John&quot;;person[&quot;lastName&quot;] = &quot;Doe&quot;;person[&quot;age&quot;] = 46;var x = person.length;      // person.length will return 0var y = person[0];          // person[0] will return undefined</code></pre><h3 id="Undefined-is-Not-Null-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªobjectå­˜åœ¨"><a href="#Undefined-is-Not-Null-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªobjectå­˜åœ¨" class="headerlink" title="Undefined is Not Null(å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªobjectå­˜åœ¨)"></a>Undefined is Not Null(å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªobjectå­˜åœ¨)</h3><pre><code class="js">if (typeof myObj === &quot;undefined&quot;) // You can test if an object exists by testing if the type is undefined:// incorrect !if (myObj === null) //But you cannot test if an object is null, because this will throw an error if the object is undefined:// To solve this problem, you must test if an object is not null, and not undefined.// incorrect !if (myObj !== null &amp;&amp; typeof myObj !== &quot;undefined&quot;) // correctã€‚ è¦å…ˆåˆ¤æ–­undefinedå†åˆ¤æ–­nullif (typeof myObj !== &quot;undefined&quot; &amp;&amp; myObj !== null) </code></pre><h3 id="ä¸€ç§åœ¨htmlæ–‡ä»¶ä¸­æŠŠscript-tagå†™åœ¨åº•éƒ¨æ¥åŠ å¿«loadçš„æ–¹å¼"><a href="#ä¸€ç§åœ¨htmlæ–‡ä»¶ä¸­æŠŠscript-tagå†™åœ¨åº•éƒ¨æ¥åŠ å¿«loadçš„æ–¹å¼" class="headerlink" title="ä¸€ç§åœ¨htmlæ–‡ä»¶ä¸­æŠŠscript tagå†™åœ¨åº•éƒ¨æ¥åŠ å¿«loadçš„æ–¹å¼"></a>ä¸€ç§åœ¨htmlæ–‡ä»¶ä¸­æŠŠscript tagå†™åœ¨åº•éƒ¨æ¥åŠ å¿«loadçš„æ–¹å¼</h3><pre><code>Putting your scripts at the bottom of the page body lets the browser load the page first.While a script is downloading, the browser will not start any other downloads. In addition all parsing and rendering activity might be blocked.The HTTP specification defines that browsers should not download more than two components in parallel.</code></pre><p>An alternative is to use defer=â€trueâ€ in the script tag. The defer attribute specifies that the script should be executed after the page has finished parsing, but it only works for external scripts.</p><pre><code class="js">&lt;script&gt;window.onload = function() {  var element = document.createElement(&quot;script&quot;);  element.src = &quot;myScript.js&quot;;  document.body.appendChild(element);};&lt;/script&gt;</code></pre><h2 id="bind-call-this"><a href="#bind-call-this" class="headerlink" title="bind, call, this"></a>bind, call, this</h2><p><a href="https://stackoverflow.com/a/31922712">javascript-call-apply-vs-bind</a></p><h3 id="jsä¸­çš„this"><a href="#jsä¸­çš„this" class="headerlink" title="jsä¸­çš„this"></a>jsä¸­çš„this</h3><p>In HTML event handlers, this refers to the HTML element that received the event:</p><pre><code class="html">&lt;button onclick=&quot;this.style.display=&#39;none&#39;&quot;&gt;  Click to Remove Me!&lt;/button&gt;</code></pre><p>ä½†æ˜¯ä½¿ç”¨applyå’Œcallä¹Ÿå¯ä»¥æ”¹å˜thisçš„è¯­ä¹‰</p><pre><code class="js">var person1 = {  fullName: function() {    return this.firstName + &quot; &quot; + this.lastName;  }}var person2 = {  firstName:&quot;John&quot;,  lastName: &quot;Doe&quot;,}person1.fullName.call(person2);  // Will return &quot;John Doe&quot;</code></pre><p>With call(), an object can use a method belonging to another object.<br>someFunction.callå°±æ˜¯æŠŠåŸæœ¬å±äºä¸€ä¸ªobjectçš„æ–¹æ³•æ‹¿è¿‡æ¥å¥—ç”¨åœ¨å¦ä¸€ä¸ªobjectä¸Š</p><p><strong>With a regular function this represents the object that calls the function:</strong><br><strong>With an arrow function this represents the owner of the function:</strong></p><p><a href="https://stackoverflow.com/a/10115970">js çš„functionçš„bindæ–¹æ³•</a> ä¾‹å¦‚ç»™documentçš„ä¸€ä¸ªelementæ·»åŠ ç‚¹å‡»callbackçš„æ—¶å€™ï¼Œclickæ–¹æ³•æ‰§è¡Œæ—¶çš„thiså·²ç»ä¸æ˜¯æ‰€é¢„æƒ³çš„thisäº†ï¼Œå› æ­¤ï¼Œéœ€è¦bind(this)ï¼Œå½“ç„¶æœ‰äº†arrow functionä¹‹åï¼Œä¸éœ€è¦bindäº†</p><pre><code class="js">Button.prototype.hookEvent(element) {  // Use bind() to ensure &#39;this&#39; is the &#39;this&#39; inside click()  element.addEventListener(&#39;click&#39;, this.click.bind(this));};//ORButton.prototype.hookEvent(element) {  // Use a new variable for &#39;this&#39; since &#39;this&#39; inside the function  // will not be the &#39;this&#39; inside hookEvent()  var me = this;  element.addEventListener(&#39;click&#39;, function() { me.click() });}//OR Button.prototype.hookEvent(element) {  // =&gt; functions do not change &#39;this&#39;, so you can use it directly  element.addEventListener(&#39;click&#39;, () =&gt; this.click());}</code></pre><p>letå’Œvarçš„åŒºåˆ«ä¹Ÿåœ¨è¿™é‡Œæœ‰ä½“ç°</p><pre><code class="js">function buildList(list) {    var result = [];    for (var i = 0; i &lt; list.length; i++) { // æŠŠvaræ¢æˆletå°±ä¸ä¼šéƒ½å˜æˆ2äº†        var item = &#39;item&#39; + i;        result.push( function() {console.log(item + &#39; &#39; + list[i])} );    }    return result;}function testList() {    var fnlist = buildList([1,2,3]);    // Using j only to help prevent confusion -- could use i.    for (var j = 0; j &lt; fnlist.length; j++) {        fnlist[j]();    }}testList() //logs &quot;item2 undefined&quot; 3 times</code></pre><h2 id="ProtoType"><a href="#ProtoType" class="headerlink" title="ProtoType"></a>ProtoType</h2><p><strong>prototypeçš„æ„æ€å¤§æ¦‚å°±æ˜¯åŠ¨æ€çš„ç»™ä¸€ä¸ªobjectæ·»åŠ instanceæ–¹æ³•æˆ–è€…fieldã€‚ä¸æ˜¯staticæ–¹æ³•</strong><br>åœ¨consoleé‡Œé¢ï¼Œæ¯ä¸€ä¸ªobjectéƒ½èƒ½çœ‹åˆ°ä¸€ä¸ª__proto__ fieldï¼Œæ‰€ä»¥å°±ç®—es6å‡ºç°äº†classï¼Œclass methodä¹Ÿä¸æ˜¯å®šä¹‰åœ¨classä¸Šçš„ï¼Œè€Œæ˜¯å®šä¹‰åœ¨__proto__å¯¹è±¡ä¸Šçš„<br><a href="https://reactjs.org/docs/typechecking-with-proptypes.html">JavaScript is a prototype-based language</a>  javaScriptä¸­classä¼¼ä¹æ˜¯syntax sugarï¼Œä½¿ç”¨getProtoTypeOfå¯ä»¥çœ‹å‡ºæ¥classçš„æ–¹æ³•æœ€ç»ˆéƒ½å®šä¹‰åˆ°äº†__proto__å¯¹è±¡ä¸Šäº†ã€‚Constructorä¹Ÿåªæ˜¯ä¸€ä¸ªå®šä¹‰åœ¨__proto__ä¸Šçš„function</p><pre><code class="js">class Person {    constructor(firstName, lastName) {        this.firstName = firstName;        this.lastName = lastName;    }    getFullName() {        return this.firstName + &quot; &quot; + this.lastName;    }}//There are two function declarations above: One for the constructor, which gets the name Person, and one for getFullName, which is a function assigned to Person.prototype.firstName: undefinedlastName: undefined__proto__:constructor: class Personarguments: (...)caller: (...)length: 2prototype: {constructor: Æ’, getFullName: Æ’}name: &quot;Person&quot; // åªæ˜¯ä¸€ä¸ªfunction__proto__: Æ’ ()[[FunctionLocation]]: VM40:2[[Scopes]]: Scopes[2]getFullName: Æ’ getFullName()arguments: (...)caller: (...)length: 0name: &quot;getFullName&quot;__proto__: Æ’ ()[[FunctionLocation]]: VM40:7[[Scopes]]: Scopes[2]</code></pre><h3 id="Object-prototype"><a href="#Object-prototype" class="headerlink" title="Object.prototype"></a>Object.prototype</h3><p>è¿™äº›éƒ½æ˜¯ES5å°±æœ‰çš„ç‰¹æ€§<a href="https://www.w3schools.com/js/js_object_prototypes.asp">prototypes</a><br>Object.defineProperty() is a new Object method in ES5.</p><p>It lets you define an object property and/or change a propertyâ€™s value and/or metadata.</p><pre><code class="js">// Create an Object:var person = {  firstName: &quot;John&quot;,  lastName : &quot;Doe&quot;,  language : &quot;NO&quot;,};// Change a Property:Object.defineProperty(person, &quot;language&quot;, {  value: &quot;EN&quot;,  writable : true,  enumerable : true,  configurable : true});// Enumerate Propertiesvar txt = &quot;&quot;;for (var x in person) {  txt += person[x] + &quot;&lt;br&gt;&quot;;}document.getElementById(&quot;demo&quot;).innerHTML = txt;// Adding or changing an object propertyObject.defineProperty(object, property, descriptor)// Adding or changing many object propertiesObject.defineProperties(object, descriptors)// Accessing PropertiesObject.getOwnPropertyDescriptor(object, property)// Returns all properties as an arrayObject.getOwnPropertyNames(object)// Returns enumerable properties as an arrayObject.keys(object)// Accessing the prototypeObject.getPrototypeOf(object)// Prevents adding properties to an objectObject.preventExtensions(object)// Returns true if properties can be added to an objectObject.isExtensible(object)// Prevents changes of object properties (not values)Object.seal(object)// Returns true if object is sealedObject.isSealed(object)// Prevents any changes to an objectObject.freeze(object)// Returns true if object is frozenObject.isFrozen(object)</code></pre><h3 id="es6çš„spread-syntax"><a href="#es6çš„spread-syntax" class="headerlink" title="es6çš„spread syntax"></a>es6çš„spread syntax</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">Spread syntax </a></p><pre><code>Spread syntax allows an iterable such as an array expression or string to be expanded in places where zero or more arguments (for function calls) or elements (for array literals) are expected, or an object expression to be expanded in places where zero or more key-value pairs (for object literals) are expected.</code></pre><p>syntax</p><pre><code class="js">// For function calls:myFunction(...iterableObj);//For array literals or strings:[...iterableObj, &#39;4&#39;, &#39;five&#39;, 6]; // For object literals (new in ECMAScript 2018):let objClone = { ...obj };</code></pre><h3 id="ä½†æ˜¯ä¸è¦è·Ÿdestructuring-assignmentæ··æ·†äº†"><a href="#ä½†æ˜¯ä¸è¦è·Ÿdestructuring-assignmentæ··æ·†äº†" class="headerlink" title="ä½†æ˜¯ä¸è¦è·Ÿdestructuring assignmentæ··æ·†äº†"></a>ä½†æ˜¯ä¸è¦è·Ÿdestructuring assignmentæ··æ·†äº†</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destructuring assignment</a><br>The destructuring assignment syntax is a JavaScript expression that makes it possible to unpack values from arrays, or properties from objects, into distinct variables.</p><pre><code class="js">let a, b, rest;[a, b] = [10, 20];console.log(a);// expected output: 10console.log(b);// expected output: 20[a, b, ...rest] = [10, 20, 30, 40, 50];console.log(rest);// expected output: Array [30,40,50]</code></pre><p>åƒæäº†kotlinçš„triple<br>æœ‰äº†spread operatorï¼Œarray.pushå¯ä»¥æ¢ä¸€ç§å†™æ³•</p><pre><code class="js">const arr1 = [0, 1, 2];const arr2 = [3, 4, 5];//  Append all items from arr2 onto arr1arr1 = arr1.concat(arr2);const arr1 = [0, 1, 2];const arr2 = [3, 4, 5];arr1 = [...arr1, ...arr2]; //  arr1 is now [0, 1, 2, 3, 4, 5]</code></pre><p>objectçš„shallow cloneä¹Ÿå˜äº†</p><pre><code class="js">const obj1 = { foo: &#39;bar&#39;, x: 42 };const obj2 = { foo: &#39;baz&#39;, y: 13 };const clonedObj = { ...obj1 };// Object { foo: &quot;bar&quot;, x: 42 }const mergedObj = { ...obj1, ...obj2 };// æ³¨æ„è¿™é‡Œfooè¢«è¦†ç›–äº†// Object { foo: &quot;baz&quot;, x: 42, y: 13 }</code></pre><p><a href="https://www.w3schools.com/js/js_conventions.asp">ä¸€äº›ä»£ç è§„èŒƒ</a> è¿™äº›åªæ˜¯ä¹ æƒ¯ï¼Œä¸€äº›æ¨èçš„è®¾ç½®ï¼Œä¸å¼ºæ±‚ã€‚å„ä¸ªè¯­è¨€ç¤¾åŒºéƒ½æœ‰è‡ªå·±çš„è§„èŒƒã€‚</p><pre><code>Underscores:Many programmers prefer to use underscores (date_of_birth), especially in SQL databases.Underscores are often used in PHP documentation.PascalCase:PascalCase is often preferred by C programmers.camelCase:camelCase is used by JavaScript itself, by jQuery, and other JavaScript libraries.</code></pre><p><a href="https://github.com/reduxjs/redux/blob/master/examples/todos/src/reducers/todos.js">æŒ‘ä¸€ä¸ªreduxçš„reducerä»£ç æ¥çœ‹</a> es6æˆ–è€…æ›´é«˜çš„è¯­æ³•ï¼Œä¹ æƒ¯å°±å¥½</p><pre><code class="js">const todos = (state = [], action) =&gt; { // arrow function,  å‚æ•°çš„é»˜è®¤å€¼   switch (action.type) {    case &#39;ADD_TODO&#39;:      return [        ...state, // spread å°±æ˜¯æŠŠä¸€ä¸ªiterable objectæ‹†æ•£ es 2018çš„        {          id: action.id,          text: action.text,          completed: false        }      ]    case &#39;TOGGLE_TODO&#39;:      return state.map(todo =&gt;        (todo.id === action.id)          ? {...todo, completed: !todo.completed} // æ‹†å¼€ä¸€ä¸ªtodo objï¼Œè¿”å›ä¸€ä¸ªæ–°çš„obj,completedè¢«è¦†ç›–ï¼Ÿ          : todo      )    default:      return state  }}export default todos</code></pre><h3 id="arrow-functionçš„syntax"><a href="#arrow-functionçš„syntax" class="headerlink" title="arrow functionçš„syntax"></a>arrow functionçš„syntax</h3><p>Basic syntax</p><pre><code class="js">(param1, param2, â€¦, paramN) =&gt; { statements } (param1, param2, â€¦, paramN) =&gt; expression// equivalent to: =&gt; { return expression; }// Parentheses are optional when there&#39;s only one parameter name:(singleParam) =&gt; { statements }singleParam =&gt; { statements }// The parameter list for a function with no parameters should be written with a pair of parentheses.() =&gt; { statements }</code></pre><p>// Advanced syntax</p><pre><code class="js">// Parenthesize the body of a function to return an object literal expression:params =&gt; ({foo: bar})// Rest parameters and default parameters are supported(param1, param2, ...rest) =&gt; { statements } // å…¶ä»–è¯­è¨€å¸¸è§çš„var argsä¹Ÿæœ‰(param1 = defaultValue1, param2, â€¦, paramN = defaultValueN) =&gt; { statements }// Destructuring within the parameter list is also supportedvar f = ([a, b] = [1, 2], {x: c} = {x: a + b}) =&gt; a + b + c;f(); // 6</code></pre><h3 id="å› ä¸ºåˆ°å¤„æ˜¯undefinedï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¼ å‚ä¹Ÿæœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•"><a href="#å› ä¸ºåˆ°å¤„æ˜¯undefinedï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¼ å‚ä¹Ÿæœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•" class="headerlink" title="å› ä¸ºåˆ°å¤„æ˜¯undefinedï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¼ å‚ä¹Ÿæœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•"></a>å› ä¸ºåˆ°å¤„æ˜¯undefinedï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¼ å‚ä¹Ÿæœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•</h3><p>çœ‹ä¸Šå»ç…§ç€shellçš„pipeå»ç†è§£å°±æ˜¯äº†</p><pre><code class="js">obj.dispatch(someMethod(maybeUndefined || {}));method &amp;&amp; method()//ä¾‹å¦‚é€‰æ‹©æ€§çš„æ˜¾ç¤ºæŸä¸ªViewå¯ä»¥è¿™ä¹ˆå¹²&lt;View&gt;  {show &amp;&amp; &lt;Warning style={styles.warning}&gt;è¿™ä¸€å—åªæœ‰åœ¨showçš„æ—¶å€™æ‰ä¼šæ˜¾ç¤º&lt;/Warning&gt;}&lt;/View&gt;</code></pre><p>å†™è¿‡reduxä»£ç ä¹‹åå°±ä¼šç¢°ä¸Šè¿ç»­å¤šä¸ªarrow function<br>ä¾‹å¦‚<a href="https://redux.js.org/advanced/middleware">reduxçš„æ–‡æ¡£ä¸Š</a>å°±æœ‰è¿™ç§å¥‡æ€ªçš„å†™æ³•</p><pre><code class="js">const logger = store =&gt; next =&gt; action =&gt; {  console.log(&#39;dispatching&#39;, action)  let result = next(action)  console.log(&#39;next state&#39;, store.getState())  return result}const crashReporter = store =&gt; next =&gt; action =&gt; {  try {    return next(action)  } catch (err) {    console.error(&#39;Caught an exception!&#39;, err)    Raven.captureException(err, {      extra: {        action,        state: store.getState()      }    })    throw err  }}</code></pre><p>[è¿™ä¸ªå«åšcurried function](<a href="https://stackoverflow.com/questions/32782922/what-do-multiple-arrow-functions-mean-in-javascriptï¼‰">https://stackoverflow.com/questions/32782922/what-do-multiple-arrow-functions-mean-in-javascriptï¼‰</a><br>ç®€å•æ¥è®²ï¼Œä¸‹é¢è¿™ä¿©æ˜¯ä¸€æ ·çš„</p><pre><code class="js">const noOpMiddleware = store =&gt; next =&gt; action =&gt; {  return next(action)}const noOpMiddleware = function(store) {  return function(next) {    return function(action) {      return next(action)    }  }}</code></pre><h3 id="è¿˜æœ‰method-xxx-yyy"><a href="#è¿˜æœ‰method-xxx-yyy" class="headerlink" title="è¿˜æœ‰method(xxx)(yyy)"></a>è¿˜æœ‰method(xxx)(yyy)</h3><p><a href="https://redux.js.org/basics/example">redux basic</a></p><pre><code class="js">export default connect(  mapStateToProps,  mapDispatchToProps)(TodoList)</code></pre><p>å…¶å®æ˜¯connectè¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼ŒTodoListæ˜¯è¯¥å‡½æ•°çš„å‚æ•°ï¼Œä»…æ­¤è€Œå·²ã€‚å› ä¸ºå‡½æ•°é‡Œé¢è¿”å›å‡½æ•°æ˜¯å®Œå…¨å¯ä»¥çš„</p><h3 id="æ€æ ·åœ¨ä¸€ä¸ªå‡½æ•°é‡Œæ£€æŸ¥optional-Argumentsæ˜¯å¦ä¼ äº†"><a href="#æ€æ ·åœ¨ä¸€ä¸ªå‡½æ•°é‡Œæ£€æŸ¥optional-Argumentsæ˜¯å¦ä¼ äº†" class="headerlink" title="æ€æ ·åœ¨ä¸€ä¸ªå‡½æ•°é‡Œæ£€æŸ¥optional Argumentsæ˜¯å¦ä¼ äº†"></a>æ€æ ·åœ¨ä¸€ä¸ªå‡½æ•°é‡Œæ£€æŸ¥optional Argumentsæ˜¯å¦ä¼ äº†</h3><p>jsçš„å‡½æ•°å‚æ•°ä¼¼ä¹æ²¡æœ‰ä¸€ä¸ªæ˜¯requiredçš„ã€‚<br>å†…ç½®çš„å…³é”®è¯æœ‰ä¸€ä¸ª<strong>arguments</strong><br><a href="https://stackoverflow.com/questions/411352/how-best-to-determine-if-an-argument-is-not-sent-to-the-javascript-function"></a><br>ç®€å•ç²—æš´çš„æ–¹å¼æ˜¯</p><blockquote><p>argument2 === â€œundefinedâ€</p></blockquote><p><strong><em>cool ğŸ‘ kids </em></strong>ä¼šç”¨ä¸¤æ ¹ç«–çº¿ï¼Œä»¥æ­¤æä¾›defaultå€¼ï¼Œåæ­£æ˜¯çŸ­è·¯çš„</p><pre><code class="js">Using the || operator has become standard practice - all the cool kids do it - but be careful: The default value will be triggered if the argument evaluates to false, which means it might actually be undefined, null, false, 0, &#39;&#39; (or anything else for which Boolean(...) returns false).</code></pre><h3 id="Object-xxx"><a href="#Object-xxx" class="headerlink" title="Object.xxx"></a>Object.xxx</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">Object æ˜¯standard built in object</a></br><br>å¸¸ç”¨çš„æ–¹æ³•å…¶å®å°±é‚£ä¹ˆå‡ ä¸ª</p><pre><code class="js">1. Object.create()2. Object.keys() // å¸¸å¸¸ç”¨äºè¿­ä»£ä¸€ä¸ªObjectçš„æ‰€æœ‰keyï¼Œä¾‹å¦‚ï¼š// Iterate through the keysObject.keys(employees).forEach(key =&gt; {    let value = employees[key];     console.log(`${key}: ${value}`);});3. Object.values()// Initialize an objectconst session = {    id: 1,    time: `26-July-2018`,    device: &#39;mobile&#39;,    browser: &#39;Chrome&#39;};// Get all values of the objectconst values = Object.values(session);console.log(values);//Output//[1, &quot;26-July-2018&quot;, &quot;mobile&quot;, &quot;Chrome&quot;]4. Object.entries()// Initialize an objectconst operatingSystem = {    name: &#39;Ubuntu&#39;,    version: 18.04,    license: &#39;Open Source&#39;};// Get the object key/value pairsconst entries = Object.entries(operatingSystem);console.log(entries);// Output// [//     [&quot;name&quot;, &quot;Ubuntu&quot;]//     [&quot;version&quot;, 18.04]//     [&quot;license&quot;, &quot;Open Source&quot;]// ]5.Object.Assign()// Initialize an objectconst name = {    firstName: &#39;Philip&#39;,    lastName: &#39;Fry&#39;};// Initialize another objectconst details = {    job: &#39;Delivery Boy&#39;,    employer: &#39;Planet Express&#39;};// Merge the objectsconst character = Object.assign(name, details);console.log(character);// Output// {firstName: &quot;Philip&quot;, lastName: &quot;Fry&quot;, job: &quot;Delivery Boy&quot;, employer: &quot;Planet Express&quot;}Assignä¹Ÿå¯ä»¥ç”¨spread operatoræ¥ä»£æ›¿ï¼š// Initialize an objectconst name = {    firstName: &#39;Philip&#39;,    lastName: &#39;Fry&#39;};// Initialize another objectconst details = {    job: &#39;Delivery Boy&#39;,    employer: &#39;Planet Express&#39;};// Merge the object with the spread operatorconst character = {...name, ...details} // åˆ‡è®°ï¼Œshallow copy!!console.log(character);// Output// {firstName: &quot;Philip&quot;, lastName: &quot;Fry&quot;, job: &quot;Delivery Boy&quot;, employer: &quot;Planet Express&quot;}</code></pre><p>è¿˜æœ‰ï¼Œä¾‹å¦‚Object.freezeï¼ˆæŠŠæ‰€æœ‰çš„fieldå˜æˆunmodifiableçš„ï¼‰ï¼ŒObject.sealç¦æ­¢å†ç»™è¿™ä¸ªobjectæ·»åŠ æ–°çš„field</p><h3 id="assignä¹Ÿå¯ä»¥æ›´æ”¹éƒ¨åˆ†å±æ€§ï¼Œä¾‹å¦‚reduxçš„reducerä¸­ç»å¸¸è¿™ä¹ˆå¹²"><a href="#assignä¹Ÿå¯ä»¥æ›´æ”¹éƒ¨åˆ†å±æ€§ï¼Œä¾‹å¦‚reduxçš„reducerä¸­ç»å¸¸è¿™ä¹ˆå¹²" class="headerlink" title="assignä¹Ÿå¯ä»¥æ›´æ”¹éƒ¨åˆ†å±æ€§ï¼Œä¾‹å¦‚reduxçš„reducerä¸­ç»å¸¸è¿™ä¹ˆå¹²"></a>assignä¹Ÿå¯ä»¥æ›´æ”¹éƒ¨åˆ†å±æ€§ï¼Œä¾‹å¦‚reduxçš„reducerä¸­ç»å¸¸è¿™ä¹ˆå¹²</h3><pre><code class="js">const obj = {  something: &#39;some value&#39;,  other: &#39;the original value&#39;}// Object.assign copies properties from all the objects// onto the first object from left to right.const newObject = Object.assign({}, obj, { something: &#39;some other value&#39; })</code></pre><h2 id="Array-xxx"><a href="#Array-xxx" class="headerlink" title="Array.xxx"></a>Array.xxx</h2><p>jsçš„arrayçš„ä¸€äº›æ–¹æ³•ï¼Œéƒ½æ˜¯å¾ˆæ—©å°±æœ‰çš„<br><a href="https://www.w3schools.com/js/js_array_iteration.asp">js array</a></br><br>ä¾‹å¦‚map,reduceå’ŒreduceRightä¸ä¼šæ›´æ”¹åŸæœ‰çš„arrayã€‚</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">Array.prototype</a></br><br>map,filterè¿™äº›æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„arrayå¯ä»¥ç†è§£ï¼Œä½†æ˜¯ä¸‹é¢è¿™äº›å¾ˆè¯¡å¼‚äº†<br>concatè¿”å›çš„æ˜¯ä¸€ä¸ªnew Array,<br>pushæ–¹æ³•è¿”å›çš„æ˜¯æ–°çš„length,ä¹Ÿå°±æ˜¯åŸæ¥çš„length+1 </p><pre><code class="js">Array.prototype.concat //The concat() method is used to merge two or more arrays. This method does not change the existing arrays, but instead returns a new array.The Array.from() method creates a new, shallow-copied Array instance from an array-like or iterable object.The Array.map() method creates a new array populated with the results of calling a provided function on every element in the calling array.</code></pre><pre><code class="js">Array.isArrayArray.pop //ç§»é™¤æœ€åä¸€ä¸ªArray.shift //ç§»é™¤ç¬¬ä¸€ä¸ªArray.unshift  // insertAtFirstArray.push  // add at tail</code></pre><h3 id="splice"><a href="#splice" class="headerlink" title="splice"></a>splice</h3><pre><code class="js">splice(index number, number of items to remove, items to add) //å¯ä»¥add ä¹Ÿå¯ä»¥removeï¼Œ ä¹Ÿå¯ä»¥åŒæ—¶add remove.// æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯optionalçš„1. add elementlet fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ];// Splice a new item number into index position 1fish.splice(1, 0, &quot;manta ray&quot;);// fish;//Output// [ &#39;piranha&#39;, &#39;manta ray&#39;, &#39;barracuda&#39;, &#39;koi&#39;, &#39;eel&#39; ]2. remove elementlet fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ];// Remove two items, starting at index position 1fish.splice(1, 2);// fish;//Output// [ &#39;piranha&#39;, &#39;eel&#39; ]3. add and removelet fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ];// Remove two items and add onefish.splice(1, 2, &quot;manta ray&quot;);// fish;// Output// [ &#39;piranha&#39;, &#39;manta ray&#39;, &#39;eel&#39; ]</code></pre><h3 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h3><p>å¯ä»¥è®¤ä¸ºæ˜¯æˆªå–arrayä¸­çš„ä¸€éƒ¨åˆ†å§</p><pre><code class="js">const animals = [&#39;ant&#39;, &#39;bison&#39;, &#39;camel&#39;, &#39;duck&#39;, &#39;elephant&#39;];console.log(animals.slice(2));// expected output: Array [&quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;]console.log(animals.slice(2, 4));// expected output: Array [&quot;camel&quot;, &quot;duck&quot;]console.log(animals.slice(1, 5));// expected output: Array [&quot;bison&quot;, &quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;]</code></pre><h3 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h3><pre><code class="js">// Function to sort numbers by sizeconst sortNumerically = (a, b) =&gt; {  return a - b;}numbers.sort(sortNumerically);</code></pre><h3 id="ForEachæ–¹æ³•çš„arrow-Fuctionæœ€å¤šä¸‰ä¸ªå‚æ•°ï¼Œåä¿©æ˜¯optionalçš„"><a href="#ForEachæ–¹æ³•çš„arrow-Fuctionæœ€å¤šä¸‰ä¸ªå‚æ•°ï¼Œåä¿©æ˜¯optionalçš„" class="headerlink" title="ForEachæ–¹æ³•çš„arrow Fuctionæœ€å¤šä¸‰ä¸ªå‚æ•°ï¼Œåä¿©æ˜¯optionalçš„"></a>ForEachæ–¹æ³•çš„arrow Fuctionæœ€å¤šä¸‰ä¸ªå‚æ•°ï¼Œåä¿©æ˜¯optionalçš„</h3><pre><code class="js">fruits.forEach(function(item, index, array) {  console.log(item, index)})</code></pre><h2 id="string-equalsæ–¹æ³•æœ‰æ²¡æœ‰å‘¢"><a href="#string-equalsæ–¹æ³•æœ‰æ²¡æœ‰å‘¢" class="headerlink" title="string.equalsæ–¹æ³•æœ‰æ²¡æœ‰å‘¢"></a>string.equalsæ–¹æ³•æœ‰æ²¡æœ‰å‘¢</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Comparison_Operators">Comparison operators</a></p><pre><code class="js">// true as both operands are type String (i.e. string primitives):&#39;foo&#39; === &#39;foo&#39;var a = new String(&#39;foo&#39;);var b = new String(&#39;foo&#39;);// false as a and b are type Object and reference different objectsa == b // false as a and b are type Object and reference different objectsa === b // true as a and &#39;foo&#39; are of different type and, the Object (a) // is converted to String &#39;foo&#39; before comparisona == &#39;foo&#39;</code></pre><p>æˆ–è€…ç”¨lodashçš„ _.isEqual(value, other)æ–¹æ³•ï¼Œè¿”å›true æˆ–è€…false</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://github.com/getify/You-Dont-Know-JS/">You-Dont-Know-JS</a><br><a href="https://babeljs.io/docs/en/learn#ecmascript-2015-features">complete es6 features</a><br><a href="https://stackoverflow.com/questions/208105/how-do-i-remove-a-property-from-a-javascript-object?rq=1">how-do-i-remove-a-property-from-a-javascript-object</a><br><a href="https://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-deep-clone-an-object-in-javascript?rq=1">javascript clone ,shallow copyå¯ä»¥ä½¿ç”¨JSON.stringfyï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨lodashçš„deepcloneå‡½æ•°</a><br><a href="https://stackoverflow.com/questions/1335851/what-does-use-strict-do-in-javascript-and-what-is-the-reasoning-behind-it?rq=1">strict-mode</a><br><a href="https://stackoverflow.com/questions/111102/how-do-javascript-closures-work?rq=1"> In JavaScript, if you use the function keyword inside another function, you are creating a closure</a> </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;javaScriptä¸­çš„ä¸€äº›å®¹æ˜“çŠ¯é”™çš„åœ°æ–¹ ğŸ‚ ğŸˆ ğŸ… ğŸ¦ ğŸŒ¶ ğŸ¥’ ğŸ‘ çœŸæ˜¯ä¸€é—¨ç¥å¥‡çš„è¯­è¨€&lt;br&gt;ğŸ‰ ğŸŒ®&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/guoqing_ZH-CN10903461145_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="å‰ç«¯" scheme="https://haldir65.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>jdké›†åˆç±»æºç åˆ†æ[queue]</title>
    <link href="https://haldir65.github.io/2019/09/15/2019-09-15-collections-Refuled-02/"/>
    <id>https://haldir65.github.io/2019/09/15/2019-09-15-collections-Refuled-02/</id>
    <published>2019-09-15T10:30:47.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>queueçš„ä¸€äº›å®ç°ç±»åŠä½¿ç”¨åœºæ™¯åˆ†æ<br><img src="https://api1.foster66.xyz/static/imgs/RioGrande_ZH-CN8091224199_1920x1080.jpg" alt=""><br><a id="more"></a></p><h2 id="Queueåœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨"><a href="#Queueåœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨" class="headerlink" title="Queueåœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨"></a>Queueåœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨</h2><p>BlockingQueueæ˜¯ä¸€ä¸ªæ¥å£ï¼Œjdkä¸­å®ç°äº†è¯¥æ¥å£çš„classåŒ…æ‹¬</p><p>ArrayBlockingQueue<br>LinkedBlockingQueue<br>LinkedBlockingDeque<br>LinkedTransferQueue<br>SynchronousQueue<br>PriorityBlockingQueue<br>DelayQueue</p><p>BlockingQueueæä¾›äº†å››ç§åº”å¯¹ç­–ç•¥æ¥å¤„ç†è¿™ç§èµ„æºä¸èƒ½è¢«ç«‹å³æ»¡è¶³çš„åœºæ™¯</p><table><thead><tr><th style="text-align:left">ç©ºå€¼</th><th style="text-align:left">æŠ›å‡ºå¼‚å¸¸</th><th style="text-align:left">è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼</th><th style="text-align:left">é˜»å¡</th><th style="text-align:left">è°ƒç”¨è€…æä¾›ä¸€ä¸ªè¶…æ—¶</th></tr></thead><tbody><tr><td style="text-align:left">æ’å…¥</td><td style="text-align:left">add(e)</td><td style="text-align:left">offer(e)</td><td style="text-align:left">put(e)</td><td style="text-align:left">put(e, time ,timeUnit)</td></tr><tr><td style="text-align:left">ç§»é™¤</td><td style="text-align:left">remove()</td><td style="text-align:left">poll()</td><td style="text-align:left">take()</td><td style="text-align:left">poll(time,timeUnit)</td></tr><tr><td style="text-align:left">æ£€æŸ¥</td><td style="text-align:left">element()</td><td style="text-align:left">peek()</td><td style="text-align:left">ä¸å¯ç”¨</td><td style="text-align:left">ä¸å¯ç”¨</td></tr></tbody></table><p>jdkçš„ThreadPoolExecutorçš„æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ä¸€ä¸ªBlockingQueue<Runnable> workQueueï¼Œä¸€ä¸ªé˜»å¡å¼çš„é˜Ÿåˆ— ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ·»åŠ ä»»åŠ¡å’Œè·å–ä»»åŠ¡çš„è¿‡ç¨‹éƒ½æ˜¯é˜»å¡çš„ã€‚<br>jdkä¸­æä¾›çš„çº¿ç¨‹æ± é€‰æ‹©çš„é˜Ÿåˆ—ï¼š<br>newCachedThreadPoolä½¿ç”¨äº†SynchronousQueue(æ¯ä¸€ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯¹åº”ç§»é™¤æ“ä½œ)<br>newFixedThreadPoolä½¿ç”¨äº†LinkedBlockingQueue(è¿™ä¸ªé˜Ÿåˆ—æ˜¯æ— ç•Œçš„)ï¼Œå¹²æ´»çš„çº¿ç¨‹å°±é‚£ä¹ˆå¤šï¼Œä»»åŠ¡å¤šäº†å°±åŠ å…¥é˜Ÿåˆ—å¥½äº†</p><p>queueçš„é‡è¦æ€§åœ¨äºï¼Œåœ¨çº¿ç¨‹æ± (ThreadPoolExecutor)ä¸­ï¼Œè·å–ä»»åŠ¡ä½¿ç”¨çš„æ˜¯queueçš„<strong>poll</strong>æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä½¿ç”¨çš„æ˜¯queueçš„<strong>offer</strong>æ–¹æ³•ã€‚</p><h2 id="ArrayBlockingQueueçš„å®ç°ï¼š"><a href="#ArrayBlockingQueueçš„å®ç°ï¼š" class="headerlink" title="ArrayBlockingQueueçš„å®ç°ï¼š"></a>ArrayBlockingQueueçš„å®ç°ï¼š</h2><p>ArrayBlockingQueueæ˜¯ä¸€ä¸ªç”±æ•°ç»„å®ç°çš„ <strong>æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚è¯¥é˜Ÿåˆ—é‡‡ç”¨ <strong><em>FIFO</em></strong> çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºæ·»åŠ ã€‚</p><p>ä¸»è¦çš„æˆå‘˜å˜é‡å°±è¿™ä¹ˆå‡ ä¸ª</p><pre><code class="java">final Object[] items;/** items index for next take, poll, peek or remove */int takeIndex;  //ä¸‹ä¸€æ¬¡ä»é˜Ÿåˆ—ä¸­å–çš„index/** items index for next put, offer, or add */int putIndex;  // ä¸‹ä¸€æ¬¡å¾€é˜Ÿåˆ—ä¸­æ·»åŠ çš„index/** Number of elements in the queue */int count;final ReentrantLock lock; //è¯»å†™æ“ä½œéƒ½è¦æ‹¿åˆ°è¿™ä¸ªé”/** Condition for waiting takes */private final Condition notEmpty;/** Condition for waiting puts */private final Condition notFull;</code></pre><ol><li>å…¥åˆ—æ ¸å¿ƒæ–¹æ³•æ˜¯ä¸€ä¸ªprivateæ–¹æ³•enqueue(put ,offeréƒ½ä»£ç†ç»™äº†è¿™ä¸ªæ–¹æ³•)<br>å‡ºåˆ—çš„æ ¸å¿ƒæ–¹æ³•æ˜¯dequeue(take, poll,peekå’Œremoveæ–¹æ³•éƒ½ä»£ç†ç»™äº†è¿™ä¸ªæ–¹æ³•)</li><li>è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨æ˜¯è¢«åŒ…åœ¨ä¸€ä¸ªlock.lockå’Œlock.unlockä¸­çš„ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„çš„ã€‚</li><li>æ„é€ å‡½æ•°å¯ä»¥ä¼ ä¸€ä¸ªfairè¿›æ¥ã€‚enqueueæ–¹æ³•é‡Œé¢è¿˜æœ‰ä¸€ä¸ªnotEmpty.signal()ï¼Œ å…¶å®å°±æ˜¯å…¸å‹çš„é€šçŸ¥æ¶ˆè´¹è€…ã€‚åŒç†ï¼Œdequeueé‡Œé¢æœ‰ä¸ªnotFull.signal()ï¼Œå°±æ˜¯é€šçŸ¥ç”Ÿäº§è€…</li><li>åº•å±‚çš„æ•°ç»„æ˜¯ä¸ä¼šè‡ªåŠ¨æ‰©å®¹çš„ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æ·»åŠ å…ƒç´ ï¼Œè¶…å‡ºäº†åº•å±‚æ•°ç»„çš„é•¿åº¦çš„è¯ã€‚offerä¼šreturn false, putä¼šblockå½“å‰çº¿ç¨‹ï¼Œaddä¼šthrow new IllegalStateException(â€œQueue fullâ€);</li><li>takeIndexå¯ä»¥çœ‹åšæ˜¯fifoé˜Ÿåˆ—çš„head, putIndexå¯ä»¥çœ‹åšæ˜¯fifoé˜Ÿåˆ—çš„tailï¼Œå› ä¸ºæ•°ç»„æœ¬èº«æ²¡æœ‰é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œæ‰€ä»¥éœ€è¦äººä¸ºå»ç»´æŠ¤ä¸¤æ ¹æŒ‡é’ˆã€‚å¯ä»¥è®¤ä¸ºä»»ä½•æ—¶å€™ï¼Œåº•å±‚çš„æ•°ç»„ä¸­æ˜¯æœ‰ä¸€ä¸ªåŒºé—´æ˜¯å­˜æ”¾å…ƒç´ çš„ã€‚å…¶ä½™ä½ç½®éƒ½æ˜¯ç©ºçš„ã€‚æ¯”å¦‚éå†æ‰€æœ‰å…ƒç´ çš„æ–¹å¼æ˜¯ä»å–ä¸€ä¸ªint i, ä»takeIndexå¼€å§‹ä¸€ç›´åˆ°putIndex(ä¸­é€”å‡å¦‚ç¢°åˆ°äº†i= items.lengthï¼Œiå˜ä¸º0)ã€‚takeIndexå’ŒputIndexè°å¤§è°å°ä¸ä¸€å®šï¼Œéƒ½æ˜¯ä»0å¼€å§‹çš„ï¼Œå¹¶ä¸”éƒ½ä¼šå¾€åè‡ªå¢ï¼Œä¸€æ—¦è§¦ç¢°åˆ°items.lengthï¼Œä»0å†æ¥ã€‚æ‰€ä»¥éå†æ‰€æœ‰å…ƒç´ çš„è¿‡ç¨‹å°±åƒæ˜¯takeIndexå»è¿½èµ¶putIndexã€‚<br>è¿™ç§åšæ³•åº”è¯¥å«åšä¸¤æ ¹æŒ‡é’ˆå¾ªç¯ä»æ•°ç»„ä¸­å–å…ƒç´ ã€‚</li></ol><h2 id="LinkedBlockingQueueçš„å®ç°"><a href="#LinkedBlockingQueueçš„å®ç°" class="headerlink" title="LinkedBlockingQueueçš„å®ç°"></a>LinkedBlockingQueueçš„å®ç°</h2><p>LinkedBlockingQueueæ˜¯Executorsä¸­ä½¿ç”¨çš„åˆ›å»ºçº¿ç¨‹æ± çš„é™æ€æ–¹æ³•ä¸­ä½¿ç”¨çš„å‚æ•°ï¼Œæ˜¾ç„¶æ›´æ¨èä½¿ç”¨ã€‚ä¸»è¦ç”¨çš„æ˜¯ä¸¤ä¸ªæ–¹æ³•ï¼Œ<br>putæ–¹æ³•åœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ä¼šé˜»å¡ç›´åˆ°æœ‰é˜Ÿåˆ—æˆå‘˜è¢«æ¶ˆè´¹ï¼Œtakeæ–¹æ³•åœ¨é˜Ÿåˆ—ç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰é˜Ÿåˆ—æˆå‘˜è¢«æ”¾è¿›æ¥ã€‚å®˜æ–¹æ–‡æ¡£æåˆ°äº†ï¼Œ <strong>LinkedBlockingQueueçš„ååé‡é€šå¸¸è¦é«˜äºåŸºäºæ•°ç»„çš„é˜Ÿåˆ—ï¼Œä½†åœ¨å¤§å¤šæ•°å¹¶å‘åº”ç”¨ç¨‹åºä¸­ï¼Œå…¶å¯é¢„çŸ¥çš„æ€§èƒ½è¦ä½ä¸€äº›</strong> ï¼Œ å†…éƒ¨çš„lockåªèƒ½æ˜¯unfairçš„ã€‚</p><p>LinkedBlockingQueueæ˜¯ç”¨å•å‘é“¾è¡¨å®ç°çš„ï¼Œä¸»è¦çš„æˆå‘˜å˜é‡åŒ…æ‹¬:</p><pre><code class="java">    /** The capacity bound, or Integer.MAX_VALUE if none */    private final int capacity;    /** Current number of elements */    private final AtomicInteger count = new AtomicInteger();    /**     * Head of linked list.     * Invariant: head.item == null     */    transient Node&lt;E&gt; head;    /**     * Tail of linked list.     * Invariant: last.next == null     */    private transient Node&lt;E&gt; last;    /** Lock held by take, poll, etc */    private final ReentrantLock takeLock = new ReentrantLock();    /** Wait queue for waiting takes */    private final Condition notEmpty = takeLock.newCondition();    /** Lock held by put, offer, etc */    private final ReentrantLock putLock = new ReentrantLock();    /** Wait queue for waiting puts */    private final Condition notFull = putLock.newCondition();</code></pre><p>ä¸»è¦å°±æ˜¯headå’Œlastä¸¤æ ¹æŒ‡é’ˆï¼Œå¤–åŠ ä¸€ä¸ªAtomicIntegerè®°å½•sizeï¼Œtakeé”å’Œputé”ä»¥åŠå¯¹åº”çš„ç”¨äºå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ä»¬çš„conditionã€‚headå’Œlastçš„ç‰¹å¾æ˜¯å…¶item = null</p><p>æ ¸å¿ƒæ–¹æ³•æ˜¯enqueueå’Œdequeue</p><pre><code class="java">    /**     * Links node at end of queue.     *     * @param node the node     */    private void enqueue(Node&lt;E&gt; node) {        // assert putLock.isHeldByCurrentThread();        // assert last.next == null;        last = last.next = node;    }    //è¿™é‡Œåº”è¯¥æ˜¯å…ˆæ‰§è¡Œå³è¾¹é‚£ä¸ª=ï¼Œå†æ‰§è¡Œå·¦è¾¹é‚£ä¸ª= ï¼Œ ä¹Ÿå°±æ˜¯æ‰€æœ‰çš„å…¥åˆ—å…ƒç´ éƒ½æ˜¯ä»¥nextçš„æ–¹å¼è¢«æ·»åŠ åˆ°å½“å‰çš„lastçš„nextä½ç½®ä¸Š    /**     * Removes a node from head of queue.     *     * @return the node     */    private E dequeue() {        // assert takeLock.isHeldByCurrentThread();        // assert head.item == null;        Node&lt;E&gt; h = head;        Node&lt;E&gt; first = h.next;        h.next = h; // help GC  //headè‡ªå·±æŒ‡å‘è‡ªå·±ï¼Ÿ        head = first;        E x = first.item;        first.item = null; //headåé¢çš„å…ƒç´ å°±æ˜¯è¦è¢«ç§»é™¤çš„å…ƒç´         return x;    }</code></pre><ol><li>å…¥åˆ—çš„å‰ææ˜¯putLock.isHeldByCurrentThread()ï¼Œå‡ºåˆ—çš„å‰ææ˜¯takeLock.isHeldByCurrentThread()</li><li>å¦‚æœè¦è·å–ï¼ˆtakeï¼‰ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦è·å– takeLock é”ï¼Œä½†æ˜¯è·å–äº†é”è¿˜ä¸å¤Ÿï¼Œå¦‚æœé˜Ÿåˆ—æ­¤æ—¶ä¸ºç©ºï¼Œè¿˜éœ€è¦é˜Ÿåˆ—ä¸ä¸ºç©ºï¼ˆnotEmptyï¼‰è¿™ä¸ªæ¡ä»¶ï¼ˆConditionï¼‰ã€‚</li><li>å¦‚æœè¦æ’å…¥ï¼ˆputï¼‰ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦è·å– putLock é”ï¼Œä½†æ˜¯è·å–äº†é”è¿˜ä¸å¤Ÿï¼Œå¦‚æœé˜Ÿåˆ—æ­¤æ—¶å·²æ»¡ï¼Œè¿˜éœ€è¦é˜Ÿåˆ—ä¸æ˜¯æ»¡çš„ï¼ˆnotFullï¼‰è¿™ä¸ªæ¡ä»¶ï¼ˆConditionï¼‰ã€‚</li></ol><hr><p>ä»¥ä¸Šçš„ArrayBlockingQueueå’ŒLinkedBlockingQueueéƒ½è¿˜ç®—ç®€å•ï¼ŒSynchronousQueueçš„å®ç°åˆ™è¾ƒä¸ºå¤æ‚</p><h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p>Priority queue represented as a balanced binary heapï¼ŒThe element with the lowest value is in queue[0]ï¼ˆæ‰€ä»¥æ˜¯ä¸€ä¸ªå¹³è¡¡å°é¡¶å †ï¼‰</p><h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p>å¹¶å‘åŒ…ä¸‹é¢çš„å»¶æ—¶é˜»å¡é˜Ÿåˆ—ï¼Œé™„å¸¦ä¸€ä¸ªDelayedæ¥å£ç”¨äºç”¨äºå®ç°å®šæ—¶ä»»åŠ¡</p><pre><code class="java">public interface Delayed extends Comparable&lt;Delayed&gt; {    long getDelay(TimeUnit unit);}public class DelayQueue&lt;E extends Delayed&gt; extends AbstractQueue&lt;E&gt;    implements BlockingQueue&lt;E&gt; {    }</code></pre><p>é˜Ÿåˆ—ä¸­çš„å…ƒç´ éƒ½å®ç°äº†Delayedçš„æ¥å£ï¼Œé€šè¿‡getDelayæ–¹æ³•å®ç°å»¶è¿Ÿè°ƒåº¦ã€‚åœ¨queue.take()çš„æ—¶å€™è¢«addè¿›queueçš„å…ƒç´ æŒ‰ç…§getDelayçš„è¿”å›å€¼æ’åºï¼Œè¶Šæ—©åˆ°æœŸçš„å…ƒç´ è¶Šå…ˆå‡ºé˜Ÿã€‚</p><p>ScheduledThreadPoolExecutorä¸­ä½¿ç”¨äº†å†…éƒ¨å®ç°ç±»DelayedWorkQueueï¼Œè€Œæ˜¯ä½¿ç”¨æ•°ç»„åˆå®ç°äº†ä¸€éä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚<a href="http://cmsblogs.com/?p=4769">è¯¦ç»†ä»‹ç»</a></p><h2 id="ArrayDeque"><a href="#ArrayDeque" class="headerlink" title="ArrayDeque"></a>ArrayDeque</h2><p>åŒç«¯é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå®ƒçš„ä¸¤ç«¯éƒ½å¯ä»¥è¿›å‡ºå…ƒç´ ï¼Œæ•…è€Œå¾—ååŒç«¯é˜Ÿåˆ—ã€‚ArrayDequeæ˜¯ä¸€ç§ä»¥æ•°ç»„æ–¹å¼å®ç°çš„åŒç«¯é˜Ÿåˆ—ï¼Œå®ƒæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚<br>Dequeæ˜¯ä¸€ä¸ªæ¥å£,å®šä¹‰äº†addFirst,addLast, removeFirst, removeLastç­‰æ“ä½œï¼Œå› æ­¤å¯ä»¥ä»ä¸¤ç«¯è¿›è¡Œæ“ä½œã€‚</p><ol><li>ArrarDequeçš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥ä¼ å…¥sizeï¼Œé»˜è®¤åˆå§‹å®¹é‡æ˜¯16ï¼Œæœ€å°å®¹é‡æ˜¯8ã€‚å¿…é¡»æ˜¯2çš„å¹‚</li><li>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªelements(Object[]) ,åŒæ—¶è¿˜æœ‰ä¸¤æ ¹æŒ‡é’ˆheadï¼ˆä¸‹ä¸€æ¬¡removeå’Œpopçš„ä½ç½®ï¼‰å’Œtail(ä¸‹ä¸€æ¬¡addçš„ä½ç½®)</li><li>addæ“ä½œç­‰åŒäºaddLastã€‚</li><li>headå’Œtailéƒ½æ˜¯ä»0å¼€å§‹çš„ã€‚addLastæ“ä½œä½¿å¾—tail+1ï¼Œheadä¸å˜ã€‚ç¬¬ä¸€æ¬¡addFirstæ“ä½œä½¿å¾—headä»0å˜ä¸ºlength-1ï¼ˆæ¯”å¦‚è¯´7ï¼‰ï¼Œéšåçš„addFirstæ“ä½œä½¿å¾—headé€’å‡ã€‚å½“head==tailçš„æ—¶å€™ï¼ŒdoubleCapacityã€‚</li><li>getFirstçš„åšæ³•</li></ol><pre><code class="java">(E) elements[head];</code></pre><p>getLastç”¨çš„æ˜¯è¿™æ ·çš„</p><pre><code class="java">(E) elements[(tail - 1) &amp; (elements.length - 1)];</code></pre><p>é€šè¿‡å–æ¨¡çš„æ–¹å¼è®©å¤´å°¾æŒ‡é’ˆåœ¨æ•°ç»„èŒƒå›´å†…å¾ªç¯ï¼Œx &amp; (len â€“ 1) = x % lenï¼Œä½¿ç”¨&amp;çš„æ–¹å¼æ›´å¿«ï¼›è¿™ä¹Ÿæ˜¯æ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„æŒ‡æ•°å¹‚çš„åŸå› ã€‚<br>6.doubleCapacity(æ‰©å®¹çš„æ–¹å¼æœ‰ç‚¹ç»•)ï¼Œæ‰©å®¹æ—¶,head==tailã€‚ä»¥headä¸ºè¾¹ç•Œï¼Œå³è¾¹çš„æŒªåˆ°x2ä¹‹åæ•°ç»„çš„æœ€å¼€å¤´ï¼Œå·¦è¾¹çš„è·Ÿç€æŒªåˆ°ä¸Šè¿°æ•°æ®çš„åé¢ï¼Œè¿™æ ·å¡«æ»¡x2æ•°ç»„çš„å·¦åŠéƒ¨åˆ†ï¼ŒåŒæ—¶ä¿è¯äº†head=0ï¼Œtailåœ¨æœ€å°¾éƒ¨ã€‚</p><ol start="7"><li>é€šè¿‡å–æ¨¡çš„æ–¹å¼è®©å¤´å°¾æŒ‡é’ˆåœ¨æ•°ç»„èŒƒå›´å†…å¾ªç¯ï¼ˆheadå¾€å·¦èµ°ï¼Œtailå¾€å³èµ°ï¼Œä¸¤è€…ç›¸é‡åæ‰©å®¹ï¼‰</li></ol><p><a href="http://cmsblogs.com/?p=4771">è¯¦ç»†ä»‹ç»</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;queueçš„ä¸€äº›å®ç°ç±»åŠä½¿ç”¨åœºæ™¯åˆ†æ&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/RioGrande_ZH-CN8091224199_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>jdké›†åˆç±»æºç åˆ†æ[list]</title>
    <link href="https://haldir65.github.io/2019/09/14/2019-09-14-collections-Refuled-01/"/>
    <id>https://haldir65.github.io/2019/09/14/2019-09-14-collections-Refuled-01/</id>
    <published>2019-09-14T15:44:09.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>æºç ï¼Œä»¥åŠjdk8ä¸­çš„ä¸€äº›æœ‰ç”¨çš„methodã€‚</p><p><img src="https://api1.foster66.xyz/static/imgs/SainteVictoireCezanneBirthday_ZH-CN8216109812_1920x1080.jpg" alt=""><br><a id="more"></a></p><pre><code class="java">public interface List&lt;E&gt; extends Collection&lt;E&gt; {}</code></pre><p>Listçš„å®ç°ç±»åŒ…æ‹¬ArrayList,LinkedList,CopyOnWriteArrayList,ä»¥åŠä¸¤ä¸ªä¸æ€ä¹ˆç”¨çš„ç±»<del>stackå’ŒVector</del></p><h3 id="1-ArrayList"><a href="#1-ArrayList" class="headerlink" title="1. ArrayList"></a>1. ArrayList</h3><h3 id="2-LinkedList"><a href="#2-LinkedList" class="headerlink" title="2. LinkedList"></a>2. LinkedList</h3><h3 id="3-CopyOnWriteArrayList"><a href="#3-CopyOnWriteArrayList" class="headerlink" title="3.  CopyOnWriteArrayList"></a>3.  CopyOnWriteArrayList</h3><p>å†…éƒ¨æ•°ç»„æ˜¯ä¸€ä¸ªvolatileçš„ã€‚<br>æ‰€æœ‰çš„mutateæ“ä½œéƒ½è¢«ä¸€ä¸ªReentrantLockä¿æŠ¤(all mutative<br> operations ({@code add}, {@code set}, and so on) are implemented by<br> making a fresh copy of the underlying array.) æ­¤ç±»æ“ä½œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„arrayï¼Œå†é€šè¿‡setArrayæ–¹æ³•è®¾ç½®è¿™ä¸ªvolatileçš„å€¼<br>æ‰€æœ‰çš„émutateæ“ä½œ(get, size ,indexOfç­‰)éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªgetArrayæ–¹æ³•å…ˆè·å–åˆ°è¿™ä¸ª<br><a href="https://stackoverflow.com/a/2950898">ç¡®è®¤CopyOnWriteArrayListæ˜¯çº¿ç¨‹å®‰å…¨çš„</a>ã€‚ ä»»ä¸€çº¿ç¨‹å¯¹ç»“æ„çš„ä¿®æ”¹éƒ½ä¼šç›´æ¥è¢«åç»­çš„è¯»çš„çº¿ç¨‹çœ‹åˆ°ã€‚ ç¼ºç‚¹å°±æ˜¯è¿™ç§å®¹å™¨åªé€‚ç”¨äºread å¤š writeå°‘çš„åœºæ™¯ã€‚</p><blockquote><p>An important detail is that volatile only applies to the array reference itself, not to the content of the array. However because all changes to the array are made before its reference is published, the volatile guarantees extend to the content of the array</p></blockquote><p>volatileåªæ˜¯ä¿è¯äº†æ•°ç»„çš„æŒ‡é’ˆæ˜¯volatileçš„ï¼Œä½†äº‹å®ä¸Šå› ä¸ºä¿®æ”¹arrayå¼•ç”¨çš„åœ°æ–¹åªæœ‰setArrayæ–¹æ³•ï¼ˆæ”¹æ–¹æ³•åŒ…åœ¨é”é‡Œï¼ŒåŒæ—¶åªæœ‰ä¸€æ¡çº¿ç¨‹å¯ä»¥è°ƒç”¨ï¼‰ã€‚å› æ­¤arrayçš„å†…å®¹äº‹å®ä¸Šç­‰åŒäºæ˜¯volatileçš„ã€‚<br>ç”±äºhappen-beforeåŸåˆ™çš„å­˜åœ¨ï¼Œadd(obj)ä¸€å®šå‘ç”Ÿåœ¨indexOf(obj)ä¹‹å‰ã€‚</p><p><strong><em>è¿˜æ˜¯æœ‰å´©çš„å¯èƒ½</em></strong><br>å…·ä½“å°±æ˜¯CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ã€‚(CopyOnWriteArrayListåªæ˜¯ä¿è¯äº†readèƒ½å¤Ÿåæ˜ ä¸Šä¸€æ¬¡writeçš„ç»“æœ)<br>æ¯”å¦‚äº²æµ‹ä¸‹é¢è¿™æ®µä»£ç ä¼šå´©</p><pre><code class="java">public class CrashOfCopyOnWriteArrayList {    void test(){        CopyOnWriteArrayList&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;();        for(int i = 0; i&lt;10000; i++){            list.add(&quot;string&quot; + i);        }        new Thread(new Runnable() {            @Override            public void run() {                while (true) {                    int size = list.size();                    if (size &gt; 0) {                        String content = list.get(size - 1); //å´©åœ¨è¿™é‡Œçš„æ•°ç»„è¶Šç•Œ                    }else {                        break;                    }                }            }        }).start();        new Thread(new Runnable() {            @Override            public void run() {                while (true) {                    if(list.size() &lt;= 0){                        break;                    }                    list.remove(0);                }            }        }).start();    }    public static void main(String[] args) {        new CrashOfCopyOnWriteArrayList().test();    }}</code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://cmsblogs.com/?p=4781">ã€æ­»ç£• Java é›†åˆã€‘â€” æ€»ç»“ç¯‡</a><br>[Javaé›†åˆæ¡†æ¶å¸¸è§é¢è¯•é¢˜](<a href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/java/collection/Javaé›†åˆæ¡†æ¶å¸¸è§é¢è¯•é¢˜.mdï¼‰">https://github.com/Snailclimb/JavaGuide/blob/master/docs/java/collection/Javaé›†åˆæ¡†æ¶å¸¸è§é¢è¯•é¢˜.mdï¼‰</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æºç ï¼Œä»¥åŠjdk8ä¸­çš„ä¸€äº›æœ‰ç”¨çš„methodã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/SainteVictoireCezanneBirthday_ZH-CN8216109812_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>openjdkæºç è§£æ[äºŒ]</title>
    <link href="https://haldir65.github.io/2019/09/06/2019-09-06-openjdk-codegrep_02/"/>
    <id>https://haldir65.github.io/2019/09/06/2019-09-06-openjdk-codegrep_02/</id>
    <published>2019-09-06T21:06:23.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>æ¶‰åŠsocketçš„ä¸€äº›class,java.net.xxx<br><img src="https://api1.foster66.xyz/static/imgs/may1_ZH-CN8582006115_1920x1080.jpg" alt=""></p><a id="more"></a><p>java socketç¼–ç¨‹ä¸»è¦æ˜¯tcpå’Œudpç¼–ç¨‹ï¼Œæ¶‰åŠåˆ°çš„classåŒ…æ‹¬socket(tcp client)å’ŒServerSocket(tcp server)ä»¥åŠDatagramSocket(udp)ï¼Œä¸»è¦çš„ç±»éƒ½åœ¨java.netè¿™ä¸ªpackageä¸‹é¢ã€‚<br>å¸¸ç”¨çš„åŒ…æ‹¬ï¼šå¤„ç†httpè¯·æ±‚çš„HttpURLConnectionï¼Œä»£è¡¨èµ„æºåœ°å€çš„URL(ä¸æ˜¯URI)ï¼ŒSocketInputStreamå’ŒSocketOutputStreamã€‚</p><h2 id="URLæ˜¯å¯¹ä¸€ä»½èµ„æºåœ°å€çš„è¡¨ç¤º"><a href="#URLæ˜¯å¯¹ä¸€ä»½èµ„æºåœ°å€çš„è¡¨ç¤º" class="headerlink" title="URLæ˜¯å¯¹ä¸€ä»½èµ„æºåœ°å€çš„è¡¨ç¤º"></a>URLæ˜¯å¯¹ä¸€ä»½èµ„æºåœ°å€çš„è¡¨ç¤º</h2><pre><code class="java">public class URLDemo {    public static void main(String[] args) {        try {            URL url = new URL(&quot;https://www.baidu.com/abced.html?language=zh_CN#ssss-libev&quot;);            System.out.println(url);            System.out.println(url.getProtocol()); // https            System.out.println(url.getHost()); // www.baidu.com            System.out.println(url.getPort()); // -1            System.out.println(url.getDefaultPort()); // 443            System.out.println(url.getFile()); // /abced.html?language=zh_CN            System.out.println(url.getPath()); // /abced.html            System.out.println(url.getQuery()); // language=zh_CN            System.out.println(url.getRef()); // ssss-libev        } catch (MalformedURLException e) {            e.printStackTrace();        }    }}</code></pre><h2 id="tcp-socket"><a href="#tcp-socket" class="headerlink" title="tcp socket"></a>tcp socket</h2><p>Socketå’ŒServerSocketï¼Œè¿™ä¿©ä¸€ä¸ªä»£è¡¨tcpé€šä¿¡çš„å®¢æˆ·ç«¯ï¼Œä¸€ä¸ªä»£è¡¨æœåŠ¡ç«¯ã€‚ä»æºç æ¥çœ‹,ServerSocketå’Œsocketå†…éƒ¨åˆ†åˆ«æŒæœ‰ä¸€ä¸ªSocketImplå¯¹è±¡ï¼Œç”¨äºå°†å¯¹åº”çš„æ–¹æ³•ä»£ç†ç»™nativeæ–¹æ³•ã€‚</p><h3 id="ServerSocket"><a href="#ServerSocket" class="headerlink" title="ServerSocket"></a>ServerSocket</h3><p>ä¸»è¦çš„æ–¹æ³•åŒ…æ‹¬</p><pre><code class="java">//å‡ ä¸ªæ„é€ å‡½æ•°public ServerSocket() throws IOException;public ServerSocket(int port) throws IOException;public ServerSocket(int port, int backlog, InetAddress bindAddr) throws IOException ;//ç»‘å®šç«¯å£public void bind(SocketAddress endpoint) throws IOExceptionpublic void bind(SocketAddress endpoint, int backlog) throws IOException//å¼€å§‹æ¥å—clientçš„è¯·æ±‚public Socket accept() throws IOException //è¿˜æœ‰ä¸€äº›è®¾ç½®è¶…æ—¶ä»€ä¹ˆçš„public synchronized void setSoTimeout(int timeout) throws SocketExceptionpublic void setReuseAddress(boolean on) throws SocketException public synchronized void setReceiveBufferSize (int size) throws SocketException</code></pre><p>åˆ†åˆ«æ¥çœ‹ï¼š<br>æ„é€ å‡½æ•°ä¸­é»˜è®¤åˆ›å»ºäº†ä¸€ä¸ªSocksSocketImplï¼ˆè¿™æ˜¯ä¸€ä¸ªSOCKS (V4 &amp; V5) TCP socket implementationï¼Œå°±æ˜¯ä¸€ä¸ªæ”¯æŒsocksåè®®çš„socketå®ç°ï¼‰ã€‚<br>SocksSocketImplç»§æ‰¿è‡ªPlainSocketImplç»§æ‰¿è‡ªAbstractPlainSocketImplã€‚<br>æ³¨æ„è¿™äº›çˆ¶ç±»ä¸­éƒ½æœ‰ä¸€æ®µstatic ä»£ç å—ï¼Œæ‰€ä»¥åˆ›å»ºäº†å­ç±»çš„æ—¶å€™è¿™äº›çˆ¶ç±»çš„ä»£ç å—éƒ½ä¼šè¢«æ‰§è¡Œï¼š</p><pre><code class="java">class PlainSocketImpl extends AbstractPlainSocketImpl{    static {        initProto();    }    static native void initProto();}abstract class AbstractPlainSocketImpl extends SocketImpl{    static {        java.security.AccessController.doPrivileged(            new java.security.PrivilegedAction&lt;Void&gt;() {                public Void run() {                    System.loadLibrary(&quot;net&quot;);                     return null;                }            });    }}</code></pre><p><a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/solaris/native/java/net/PlainSocketImpl.c">initProtoä¸»è¦æ˜¯ä¸ºäº†cache filed id</a></p><p>æ¥ä¸‹æ¥æ˜¯bindæ–¹æ³•,serverSocketä¸­çš„å®ç°æ˜¯</p><pre><code class="java">getImpl().bind(epoint.getAddress(), epoint.getPort());getImpl().listen(backlog); //è¿™ä¸ªbacklogé»˜è®¤æ˜¯50</code></pre><p>æ‰€ä»¥æ˜¯åŒæ—¶åšäº†ä¸¤ä»¶äº‹ï¼Œbindå’Œlistenã€‚åˆ†åˆ«è°ƒç”¨åˆ°äº†:</p><pre><code class="java">native void socketBind(InetAddress address, int port)    throws IOException;native void socketListen(int count) throws IOException;</code></pre><p>å¯¹åº”çš„cè¯­è¨€å®ç°æ˜¯:<br><a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/solaris/native/java/net/PlainSocketImpl.c#L618">socketListen</a></p><pre><code class="c">JNIEXPORT void JNICALLJava_java_net_PlainSocketImpl_socketListen (JNIEnv *env, jobject this,                                            jint count){    /* this FileDescriptor fd field */    jobject fdObj = (*env)-&gt;GetObjectField(env, this, psi_fdID);    /* fdObj&#39;s int fd field */    int fd;    if (IS_NULL(fdObj)) {        JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,                        &quot;Socket closed&quot;);        return;    } else {        fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);    }    /*     * Workaround for bugid 4101691 in Solaris 2.6. See 4106600.     * If listen backlog is Integer.MAX_VALUE then subtract 1.     */    if (count == 0x7fffffff)        count -= 1;    if (JVM_Listen(fd, count) == JVM_IO_ERR) {        NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;SocketException&quot;,                       &quot;Listen failed&quot;);    }}</code></pre><p>æ‰€ä»¥æ˜¯è°ƒç”¨äº†JVM_Listenè¿™ä¸ªæ–¹æ³•,å†å¾€ä¸‹å°±æ˜¯cppäº†ï¼Œåœ¨/hotspot/src/share/vm/prims/jvm.cppè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œè°ƒç”¨çš„æ˜¯os:listenå‡½æ•°ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è™šæ‹Ÿæœºçš„å®ç°äº†ã€‚<br>ä¸å‡ºæ„å¤–çš„ï¼ŒJVM_Bindè¿™ä¸ªæ–¹æ³•ä¹Ÿå‡ºç°åœ¨jvm.cppè¿™ä¸ªæ–¹æ³•ä¸­ã€‚</p><blockquote><p>åœ¨hostspotä¸­ï¼Œosæ˜¯ä¸€ä¸ªå°è£…ç‰¹å®šæ“ä½œç³»ç»Ÿè¡Œä¸ºçš„é™æ€ç±»ï¼Œå…¶å®ç°å¤šåœ¨hotspot/src/osä¸­ã€‚</p></blockquote><p>ä»¥linuxä¸ºä¾‹ï¼Œå®ç°åœ¨<a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/hotspot/src/os/linux/vm/os_linux.inline.hpp">os_linux.inline.hpp</a></p><pre><code class="c++">inline int os::bind(int fd, struct sockaddr* him, socklen_t len) {  return ::bind(fd, him, len);}</code></pre><p>åº”è¯¥æ˜¯è°ƒç”¨äº†<a href="https://linux.die.net/man/2/bind">bind</a>è¿™ä¸ªlinuxå‡½æ•°ã€‚</p><h3 id="udp-socket"><a href="#udp-socket" class="headerlink" title="udp socket"></a>udp socket</h3><p>tbd, å®åœ¨å¤ªå¤šäº†</p><h3 id="socketXXXStream"><a href="#socketXXXStream" class="headerlink" title="socketXXXStream"></a>socketXXXStream</h3><p>å¤§éƒ¨åˆ†çš„nativeæ–¹æ³•éƒ½åœ¨plainSocketImpl.javaä¸­</p><pre><code class="java">native void socketCreate(boolean isServer) throws IOException;native void socketConnect(InetAddress address, int port, int timeout)    throws IOException;native void socketBind(InetAddress address, int port)    throws IOException;native void socketListen(int count) throws IOException;native void socketAccept(SocketImpl s) throws IOException;native int socketAvailable() throws IOException; native void socketClose0(boolean useDeferredClose) throws IOException;native void socketShutdown(int howto) throws IOException;static native void initProto();native void socketSetOption0(int cmd, boolean on, Object value)    throws SocketException;native int socketGetOption(int opt, Object iaContainerObj) throws SocketException;native void socketSendUrgentData(int data) throws IOException;</code></pre><p>ä¸Šé¢çš„æ–¹æ³•åŸºæœ¬ä¸Šçœ‹åå­—å°±èƒ½è·Ÿå¯¹åº”çš„javaæ–¹æ³•å¯¹ä¸Šå·ï¼Œè¿™é‡Œè¯´ä¸€ä¸ªsocketAvailable,è¿™ä¸ªåº”è¯¥æ˜¯å¯¹åº”socketInputStreamçš„available(è¿™ä¸ªæ–¹æ³•æ˜¯inputStreamè¦æ±‚çš„)ã€‚<br>é‚£ä¹ˆå®ƒçš„å¯¹åº”çš„c++æ–¹æ³•æ˜¯JVM_SocketAvailable</p><pre><code class="c++">int os::socket_available(int fd, jint *pbytes) {  // Linux doc says EINTR not returned, unlike Solaris  int ret = ::ioctl(fd, FIONREAD, pbytes);  //%% note ioctl can return 0 when successful, JVM_SocketAvailable  // is expected to return 0 on failure and 1 on success to the jdk.  return (ret &lt; 0) ? 0 : 1;}</code></pre><p>æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¿”å›çš„è¦ä¹ˆæ˜¯0è¦ä¹ˆæ˜¯1ï¼Ÿ<br>çœ‹ä¸€ä¸‹oracleçš„<a href="https://docs.oracle.com/javase/9/docs/api/java/io/InputStream.html#available">java doc</a></p><pre><code>public int availableâ€‹()              throws IOExceptionReturns an estimate of the number of bytes that can be read (or skipped over) from this input stream without blocking by the next invocation of a method for this input stream. The next invocation might be the same thread or another thread. A single read or skip of this many bytes will not block, but may read or skip fewer bytes.Note that while some implementations of InputStream will return the total number of bytes in the stream, many will not. It is never correct to use the return value of this method to allocate a buffer intended to hold all data in this stream.A subclass&#39; implementation of this method may choose to throw an IOException if this input stream has been closed by invoking the close() method.The available method for class InputStream always returns 0.This method should be overridden by subclasses.</code></pre><p>ä¹Ÿå°±æ˜¯è¯´å¤šæ•°subclassçš„å®ç°ä¸­è¿”å›çš„å€¼ï¼Œæ˜¯é ä¸ä½çš„ï¼Œå¯èƒ½ä¼šå°ã€‚æ‰€ä»¥ä¾èµ–è¿™ä¸ªè¿”å›å€¼allocateä¸€ä¸ªbufferåŒºå­˜å‚¨åº•å±‚çš„æ•°æ®æ˜¯ä¸æ­£ç¡®çš„ã€‚</p><h3 id="tbd"><a href="#tbd" class="headerlink" title="tbd"></a>tbd</h3><p>è¿™ä¹ˆå†™ä¸‹å»ï¼Œè™šæ‹Ÿæœºçš„ä¸œè¥¿å¤ªå¤šäº†ã€‚ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.zfl9.com/java-socket.html">java socketç¼–ç¨‹</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ¶‰åŠsocketçš„ä¸€äº›class,java.net.xxx&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/may1_ZH-CN8582006115_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>automakeæ•™ç¨‹</title>
    <link href="https://haldir65.github.io/2019/08/25/2019-08-25-autotools-tutorials/"/>
    <id>https://haldir65.github.io/2019/08/25/2019-08-25-autotools-tutorials/</id>
    <published>2019-08-25T08:46:19.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>autotoolsçš„ä½¿ç”¨æ–¹å¼<br><img src="https://api1.foster66.xyz/static/imgs/SeaCliffBridge_ZH-CN5362667487_1920x1080.jpg" alt=""><br><a id="more"></a></p><h2 id="1-ä»€ä¹ˆæ˜¯AutoTools"><a href="#1-ä»€ä¹ˆæ˜¯AutoTools" class="headerlink" title="1.ä»€ä¹ˆæ˜¯AutoTools"></a>1.ä»€ä¹ˆæ˜¯AutoTools</h2><p>The GNU build system, also known as the Autotools, is a suite of programming tools designed to assist in making source code packages portable to many Unix-like systems.â€”â€”Wikipedia</p><p>ä»ä½¿ç”¨ä¸Šæ¥è®²ï¼Œå¤šæ•°unixè½¯ä»¶çš„å®‰è£…æ–¹å¼éƒ½æ˜¯ä¸‹è½½ä¸€ä¸ªtarball,configureï¼Œmake,make installï¼Œå°±è¿™ä¹ˆç®€å•ã€‚èƒŒåä½¿ç”¨çš„å°±æ˜¯autotoolsã€‚ ä¸»è¦å°±æ˜¯ä¸ºäº†ç”ŸæˆMakefileã€‚</p><h2 id="ä»æœ€ç®€å•çš„helloworldå¼€å§‹è¯´èµ·å§"><a href="#ä»æœ€ç®€å•çš„helloworldå¼€å§‹è¯´èµ·å§" class="headerlink" title="ä»æœ€ç®€å•çš„helloworldå¼€å§‹è¯´èµ·å§"></a>ä»æœ€ç®€å•çš„helloworldå¼€å§‹è¯´èµ·å§</h2><p><a href="https://blog.csdn.net/thalo1204/article/details/49183911">å‚è€ƒ</a> æœ€ç»ˆå¯ä»¥ç”Ÿæˆä¸€ä¸ªtar.gzã€‚<br>ï¼ˆéœ€è¦æ‰‹å†™çš„å°±åªæœ‰Makefile.amæ–‡ä»¶ï¼Œconfigure.acæ–‡ä»¶æ˜¯ä»configure.scanæ–‡ä»¶é‡å‘½åå¤–åŠ ä¿®æ”¹ä¸€ç‚¹ç‚¹è¿‡æ¥çš„ï¼‰</p><p>åˆ›å»ºä¸‰ä»½æ–‡ä»¶:</p><blockquote><p>cat main.c</p></blockquote><pre><code class="c">#include &lt;stdio.h&gt;intmain(int argc, char* argv[]){    printf(&quot;Hello world\n&quot;);    return 0;}</code></pre><blockquote><p>cat Makefile.am</p></blockquote><pre><code>AUTOMAKE_OPTIONS = foreignbin_PROGRAMS = helloworldhelloworld_SOURCES = main.c</code></pre><blockquote><p>cat configure.ac</p></blockquote><pre><code>AC_INIT([helloworld], [0.1], [myemail@example.com])AM_INIT_AUTOMAKEAC_PROG_CCAC_CONFIG_FILES([Makefile])AC_OUTPUT</code></pre><p>ä¾æ¬¡æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š<br>aclocal # Set up an m4 environment<br>autoconf # Generate configure from configure.ac<br>automake â€“add-missing # Generate Makefile.in from Makefile.am<br>./configure # Generate Makefile from Makefile.in<br>make dist # ä¼šç”Ÿæˆä¸€ä¸ª.tar.gzæ–‡ä»¶<br>make distcheck # Use Makefile to build and test a tarball to distribute</p><p>æƒ³è¦ä½¿ç”¨ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„è¯, sudo make install(ä¼šå¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ° /usr/bin/localæ–‡ä»¶å¤¹ä¸­) ï¼Œæ”¾å¿ƒ make uninstall  ä¹Ÿæœ‰ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç»™åˆ é™¤æ‰</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>GNU Autotools ä¸€èˆ¬æŒ‡çš„æ˜¯3ä¸ª GNU å·¥å…·åŒ…ï¼šAutoconfï¼ŒAutomake å’Œ Libtool<br>å®ƒä»¬èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¦å…ˆä» GNU å¼€æºè½¯ä»¶çš„ Build ç³»ç»Ÿè¯´èµ·ã€‚ä¸€èˆ¬æ¥è¯´ã€‚GNU è½¯ä»¶çš„å®‰è£…è¿‡ç¨‹éƒ½æ˜¯ï¼š</p><p>è§£å‹æºä»£ç åŒ…<br>./configure<br>make<br>make installï¼ˆå¯èƒ½è¦åˆ‡rootç”¨æˆ·ï¼‰<br>è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ éœ€è¦æœ‰ä¸€ä¸ª configure è„šæœ¬ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ä¸€ä¸ª Makefile æ–‡ä»¶ã€‚</p><p>è€Œ Autoconf å’Œ Automake å°±æ˜¯ä¸€å¥—è‡ªåŠ¨ç”Ÿæˆ configure è„šæœ¬å’Œ Makefile æ–‡ä»¶çš„å·¥å…·ã€‚</p><p>åœ¨ubuntuä¸Šå®‰è£…autoconf,automake,libtool:</p><blockquote><p>sudo apt install build-essential autoconf automake libtool libtool-bin autotools-dev</p></blockquote><p>configureæ–‡ä»¶æ˜¯ç”¨autoconfæ ¹æ®configure.acåˆ›å»ºå‡ºæ¥çš„ï¼Œè€Œconfigure.acèƒ½ç”¨autoscanè‡ªåŠ¨åˆ›å»ºå‡ºæ¥</p><p>éšä¾¿åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹</p><p>$ ls<br>epoch.c Makefile</p><p>$ cat epoch.c</p><pre><code class="c">#include &lt;stdio.h&gt;#include &lt;sys/time.h&gt;#include &lt;time.h&gt;#include &quot;config.h&quot;double get_epoch(){  double sec;  #ifdef HAVE_GETTIMEOFDAY     struct timeval tv;     gettimeofday(&amp;tv, NULL);     sec = tv.tv_sec;     sec += tv.tv_usec / 1000000.0;  #else     sec = time(NULL);  #endif  return sec;}int main(int argc, char* argv[]){   printf(&quot;%f\n&quot;, get_epoch());   return 0;}</code></pre><p>è¿™ä¹ˆå†™çš„åŸå› æ˜¯gettimeofday()è¿™ä¸ªå‡½æ•°ä¸æ˜¯åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šéƒ½æœ‰ï¼Œè¿™ç§æ—¶å€™å°±è¦ç”¨time()å‡½æ•°äº†ã€‚</p><p>$ cat Makefile</p><pre><code># Makefile: A standard Makefile for epoch.call: epochclean:    rm Â­f epoch</code></pre><p>è¿™æ ·å…¶å®å·²ç»å¯ä»¥ç›´æ¥makeç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚ä½†æ˜¯æˆ‘ä»¬ç”¨autoconfæ¥ç”Ÿæˆè¯•ä¸€ä¸‹</p><ol><li>ç”Ÿæˆconfig.hæ–‡ä»¶<br>config.hæ–‡ä»¶æ˜¯configureå‘½ä»¤æ ¹æ®config.h.inæ–‡ä»¶ç”Ÿæˆçš„ï¼Œconfig.h.inæ–‡ä»¶æ˜¯ç”±autoheaderï¼ˆCçš„source codeï¼‰ä¸­ç”Ÿæˆçš„ï¼ˆæ€»ä¹‹ä¹Ÿæ˜¯è‡ªåŠ¨çš„ï¼‰<br>$ ls<br>epoch.c Makefile<br>$ autoscan<br>$ ls<br>autoscan.log  configure.scan  epoch.c  Makefile<br>$  mv configure.scan configure.ac<br>$ ls<br>autoscan.log  configure.ac  epoch.c  Makefile<br>$ autoheader<br>$ ls<br>autom4te.cache  autoscan.log  config.h.in  configure.ac  epoch.c  Makefile<br>$  mv Makefile Makefile.in<br>$ autoconf<br>$ ls<br>autom4te.cache  autoscan.log  config.h.in  configure  configure.ac  epoch.c  Makefile.in<br>$ ./configure<br>checking for gccâ€¦ gcc<br>checking whether the C compiler worksâ€¦ yes<br>checking for C compiler default output file nameâ€¦ a.out<br>checking for suffix of executablesâ€¦<br>checking whether we are cross compilingâ€¦ no<br>checking for suffix of object filesâ€¦ o<br>checking whether we are using the GNU C compilerâ€¦ yes<br>checking whether gcc accepts -gâ€¦ yes<br>checking for gcc option to accept ISO C89â€¦ none needed<br>checking how to run the C preprocessorâ€¦ gcc -E<br>checking for grep that handles long lines and -eâ€¦ /bin/grep<br>checking for egrepâ€¦ /bin/grep -E<br>checking for ANSI C header filesâ€¦ yes<br>checking for sys/types.hâ€¦ yes<br>checking for sys/stat.hâ€¦ yes<br>checking for stdlib.hâ€¦ yes<br>checking for string.hâ€¦ yes<br>checking for memory.hâ€¦ yes<br>checking for strings.hâ€¦ yes<br>checking for inttypes.hâ€¦ yes<br>checking for stdint.hâ€¦ yes<br>checking for unistd.hâ€¦ yes<br>checking sys/time.h usabilityâ€¦ yes<br>checking sys/time.h presenceâ€¦ yes<br>checking for sys/time.hâ€¦ yes<br>checking for gettimeofdayâ€¦ yes<br>configure: creating ./config.status<br>config.status: creating Makefile<br>config.status: creating config.h<br>$  ls<br>autom4te.cache  autoscan.log  config.h  config.h.in  config.log  config.status  configure  configure.ac  epoch.c  Makefile  Makefile.in<br>$ make<br>$ ls<br>autom4te.cache  config.h     config.log     configure     epoch    Makefile<br>autoscan.log    config.h.in  config.status  configure.ac  epoch.c  Makefile.in<br>$  ./epoch<br>1544345416.704451</li></ol><p>//åˆ°æ­¤ç»“æŸï¼ˆè¿™æ ·åšçš„æ„ä¹‰åœ¨äºä¸€ä»½ä»£ç å°±èƒ½å¤Ÿæ‹¥æœ‰å¤šå¹³å°å…¼å®¹æ€§ï¼‰</p><p>å¦ä¸€ç§æ–¹å¼<br>æ‰‹åŠ¨åˆ›é€ â€œMakefile.amâ€æ–‡ä»¶<br>$ cat Makefile.am</p><h1 id="Makefile-am-for-epoch-c"><a href="#Makefile-am-for-epoch-c" class="headerlink" title="Makefile.am for epoch.c"></a>Makefile.am for epoch.c</h1><p>bin_PROGRAMS=epoch<br>epoch_SOURCES=epoch.c</p><p>$ ls<br>epoch.c  Makefile.am</p><p>$ autoscan<br>$  mv configure.scan configure.ac<br>$ autoheader<br>$ ls<br>autom4te.cache  autoscan.log  config.h.in  configure.ac  epoch.c  Makefile.am<br>$ vim configure.ac<br>æ”¹æˆè¿™æ ·</p><pre><code>#                                               -*- Autoconf -*-# Process this file with autoconf to produce a configure script.AC_PREREQ([2.69])AC_INIT([FULL-PACKAGE-NAME], [VERSION], [BUG-REPORT-ADDRESS])AM_INIT_AUTOMAKEAC_CONFIG_SRCDIR([epoch.c])AC_CONFIG_HEADERS([config.h])# Checks for programs.AC_PROG_CC# Checks for libraries.# Checks for header files.AC_CHECK_HEADERS([sys/time.h])# Checks for typedefs, structures, and compiler characteristics.AC_HEADER_TIME# Checks for library functions.AC_CHECK_FUNCS([gettimeofday])AC_CONFIG_FILES([Makefile])AC_OUTPUT</code></pre><p>å…¶å®å°±æ˜¯åŠ äº†AM_INIT_AUTOMAKEè¿™ä¸€è¡Œè¿˜æœ‰AC_HEADER_TIME<br>$ aclocal<br>$ automake Â­Â­addÂ­missing Â­Â­copy<br>$ autoconf<br>$ ./configure åœ¨è¿™ä¸€æ­¥å› ä¸ºæ²¡æœ‰ç”ŸæˆMakefile.inæ‰€ä»¥åœä¸‹æ¥äº†</p><h3 id="pkg-config"><a href="#pkg-config" class="headerlink" title="pkg-config"></a>pkg-config</h3><p>pkg-configæ˜¯èƒ½å¤Ÿä»ä¸€ä¸ªconfigæ–‡ä»¶ä¸­è¯»å–åˆ°ä¸€ä¸ªlibraryçš„ç›¸å…³ä¿¡æ¯çš„toolï¼Œè¯¥configæ–‡ä»¶ç”±libraryæä¾›ï¼Œç”¨äºæè¿°è¯¥libraryçš„include dirï¼Œbinary dirç­‰ä¿¡æ¯ã€‚<br><a href="https://people.freedesktop.org/~dbn/pkg-config-guide.html">å…·ä½“æ•™ç¨‹</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://thoughtbot.com/blog/the-magic-behind-configure-make-make-install">helloworld</a><br><a href="https://www.gnu.org/software/automake/manual/automake.html">autotoolsæ•™ç¨‹</a><br><a href="http://www.idryman.org/blog/2016/03/10/autoconf-tutorial-1/">Autoconf Tutorial Part-1</a><br><a href="https://digitalleaves.com/blog/2017/12/build-cross-platform-c-project-autotools/">another autotools tutorial</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;autotoolsçš„ä½¿ç”¨æ–¹å¼&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/SeaCliffBridge_ZH-CN5362667487_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="tools" scheme="https://haldir65.github.io/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>mavençš„ä¸€äº›ä¸œè¥¿</title>
    <link href="https://haldir65.github.io/2019/08/11/2019-08-11-maven-related-topics/"/>
    <id>https://haldir65.github.io/2019/08/11/2019-08-11-maven-related-topics/</id>
    <published>2019-08-11T11:13:17.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://api1.foster66.xyz/static/imgs/FreshSalt_ZH-CN12818759319_1920x1080.jpg" alt=""></p><p>mavençš„ä¸€äº›ä¸œè¥¿<br><a id="more"></a></p><p>mavenå®˜ç½‘æä¾›çš„é€šè¿‡å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®çš„æ–¹æ³•</p><pre><code class="shell">mvn -B archetype:generate -DarchetypeGroupId=org.apache.maven.archetypes -DgroupId=com.mycompany.app -DartifactId=my-app//ä¸Šè¿°å‘½ä»¤ç”Ÿæˆçš„æ–‡ä»¶å¤¹å°±è¶³å¤Ÿäº†ï¼Œè¿pom.xmlä¹Ÿå¸®å¿™ç”Ÿæˆå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å»å¤åˆ¶ç²˜è´´pomé‡Œé¢çš„å†…å®¹mvn compile ##å¼€å§‹ç¼–è¯‘// æˆ–è€…è¿™ä¸¤æ¡ç›´æ¥æ”¶å·¥mvn archetype:generate -DgroupId=com.websystique.maven -DartifactId=SampleMavenJavaProject -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=falsemvn -q clean compile exec:java  -Dexec.mainClass=&quot;com.websystique.maven.App&quot;</code></pre><p><a href="https://maven.apache.org/guides/getting-started/index.html#How_do_I_make_my_first_Maven_project">maven getting startedæ˜¯å¾ˆå‹å¥½çš„æ•™ç¨‹</a></p><p>çœ‹å®Œè¿™ä¿©å†ä¸ä¼šå°±æ˜¯è ¢<br><a href="https://www.youtube.com/watch?v=pt3uB0sd5kY">jetbrainåœ¨youtubeä¸Šçš„æ•™ç¨‹</a><br><a href="https://www.packtpub.com/mapt/book/application_development/9781785286124/2/ch02lvl1sec24/creating-a-new-maven-project-in-intellij-idea">Creating a new Maven project in IntelliJ IDEA</a></p><p>create from archetypeå¯ä»¥é€‰æ‹©org.apache.maven.archetypes:maven-archetype-quickstart(çœŸçš„åªæœ‰ä¸€ä¸ªhello world)<br><a href="https://start.spring.io/">å¦‚æœæ˜¯springçš„è¯ï¼Œç›´æ¥ç”¨è¿™ä¸ªç½‘ç«™æ›´åŠ æ–¹ä¾¿</a></p><p>intelij ideaé‡Œé¢é»˜è®¤çš„mavenæºæœ‰<br><code>https://repo.maven.apache.org/maven2</code><br>å’Œ<code>http://download.java.net/maven/1</code><br>è¿™ä¿©ç½‘ç«™å›½å†…ä¼¼ä¹è¢«å¢™ï¼Œæœ€å¥½<a href="https://stackoverflow.com/questions/1784132/intellij-community-cant-use-http-proxy-for-maven/26483623#26483623">åŠ ä»£ç†</a> å°±æ˜¯åœ¨.m2/settings.xmlä¸­æŒ‡å®šæœ¬åœ°proxyã€‚å¦‚æœä½ çš„ä»£ç†å¤Ÿå¿«çš„è¯ï¼Œä¿®æ”¹pom.xmlçš„åŒæ—¶ï¼Œåº”è¯¥èƒ½å¤Ÿå¾ˆå¿«çš„å¼€å§‹ä¸‹è½½æ–°çš„ä¾èµ–<br>intelijå†…ç½®äº†maven, ç”±äºç½‘é€Ÿçš„åŸå› ï¼Œä¸æƒ³æµªè´¹æ—¶é—´çš„è¯è¿˜æ˜¯ç»™MavenåŠ ä»£ç†:<br>åœ¨~/.m2/settings.xmlä¸­æ‰¾åˆ°è¿™ä¸€æ®µï¼Œè¿™ä¸€æ®µåŸæœ¬æ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œç«¯å£å’Œhostæ ¹æ®ä»£ç†è®¾ç½®ã€‚~/.m2/settings.xmlè¿™ä¸ªæ–‡ä»¶å¦‚æœä¸å­˜åœ¨ï¼Œå°±å»intelijçš„å®‰è£…ç›®å½•é‡Œé¢copyä¸€ä¸ªå‡ºæ¥<br>æ¯”å¦‚è¿™æ ·ï¼š</p><pre><code class="xml"> &lt;proxies&gt;    &lt;proxy&gt;      &lt;id&gt;optional&lt;/id&gt;      &lt;active&gt;true&lt;/active&gt;      &lt;protocol&gt;http&lt;/protocol&gt;      &lt;host&gt;127.0.0.1&lt;/host&gt;      &lt;port&gt;1080&lt;/port&gt;      &lt;nonProxyHosts&gt;local.net|some.host.com&lt;/nonProxyHosts&gt;    &lt;/proxy&gt;  &lt;/proxies&gt;</code></pre><h3 id="æˆ–è€…ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„æº"><a href="#æˆ–è€…ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„æº" class="headerlink" title="æˆ–è€…ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„æº"></a>æˆ–è€…ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„æº</h3><p>å®é™…æ“ä½œä¸­ï¼Œä½¿ç”¨é˜¿é‡Œäº‘çš„mavené•œåƒä¼¼ä¹æ›´å¿«</p><pre><code class="xml"> &lt;mirrors&gt;   &lt;mirror&gt;         &lt;id&gt;alimaven&lt;/id&gt;         &lt;name&gt;aliyun maven&lt;/name&gt;         &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;         &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;   &lt;/mirror&gt; &lt;/mirrors&gt;</code></pre><p>æ‰“å¼€é¡¹ç›®åï¼Œåœ¨Intellij å³ä¾§æœ‰ä¸ªMaven projectsï¼Œç‚¹å¼€åï¼Œæœ‰ä¸ªLifecycleï¼Œå†ç‚¹å¼€ï¼Œå¯ä»¥çœ‹åˆ°clean , validate, compile, â€¦.ï¼Œå³å‡»cleanï¼Œé€‰ä¸­Run â€˜project[clean]â€™ï¼Œè¿™é‡Œçš„projectæ˜¯æˆ‘ä»¬çš„é¡¹ç›®å®é™…çš„åå­—ã€‚<br>å¦‚æœä¸‹è½½å¤±è´¥äº†çš„è¯ï¼Œå¯ä»¥é€‰æ‹©cleanï¼Œç„¶åå°±ä¼šå¼€å§‹è‡ªå·±é‡æ–°ä¸‹è½½</p><p>GroupIdç±»ä¼¼äºä½ çš„åŒ…åï¼ŒArtifictIdç±»ä¼¼äºä½ çš„applicationName</p><h2 id="mavenæ˜¯å¦‚ä½•è§£å†³ç‰ˆæœ¬å†²çªçš„-åŒä¸€ä¸ªpackageï¼Œä¸åŒç‰ˆæœ¬åŒæ—¶å­˜åœ¨"><a href="#mavenæ˜¯å¦‚ä½•è§£å†³ç‰ˆæœ¬å†²çªçš„-åŒä¸€ä¸ªpackageï¼Œä¸åŒç‰ˆæœ¬åŒæ—¶å­˜åœ¨" class="headerlink" title="mavenæ˜¯å¦‚ä½•è§£å†³ç‰ˆæœ¬å†²çªçš„(åŒä¸€ä¸ªpackageï¼Œä¸åŒç‰ˆæœ¬åŒæ—¶å­˜åœ¨)"></a>mavenæ˜¯å¦‚ä½•è§£å†³ç‰ˆæœ¬å†²çªçš„(åŒä¸€ä¸ªpackageï¼Œä¸åŒç‰ˆæœ¬åŒæ—¶å­˜åœ¨)</h2><p>tbd<br>gradleä¹Ÿæœ‰ä¸€å¥—è§£å†³æ–¹æ¡ˆï¼Œivyä¹Ÿæœ‰<br>java 9 çš„moduleç³»ç»Ÿæ²¡æœ‰</p><p>maven ä¸­ä½¿ç”¨jaråŒ…çš„å¤šä¸ªç‰ˆæœ¬å®¹æ˜“é€ æˆä¾èµ–é—®é¢˜ï¼Œè§£å†³é—®é¢˜çš„æ–¹å¼å¯ä»¥å°†ä½¿ç”¨jaråŒ…çš„ç‰ˆæœ¬æ’é™¤æ‰ï¼Œæ¯”å¦‚dubboä½¿ç”¨netty 4.0.33ç‰ˆæœ¬å¯ä»¥å°†dubboæ’é™¤æ‰nettyä¾èµ–ï¼Œè¿™æ ·å…¶ä»–jaråŒ…å°±ä¸ä¼šå¼•ç”¨åˆ°netty4.0.33ç‰ˆæœ¬äº†ã€‚</p><pre><code class="xml">&lt;dependency&gt;    &lt;groupId&gt;com.jd&lt;/groupId&gt;    &lt;artifactId&gt;jsf&lt;/artifactId&gt;    &lt;version&gt;1.6.0&lt;/version&gt;    &lt;exclusions&gt;        &lt;exclusion&gt;            &lt;groupId&gt;io.netty&lt;/groupId&gt;            &lt;artifactId&gt;netty-all&lt;/artifactId&gt;        &lt;/exclusion&gt;    &lt;/exclusions&gt;&lt;/dependency&gt;</code></pre><h3 id="mavenä¸­å¦‚ä½•é¡ºå¸¦æŠŠnativeçš„libraryä¹Ÿç»™æ‰“è¿›å»ã€‚"><a href="#mavenä¸­å¦‚ä½•é¡ºå¸¦æŠŠnativeçš„libraryä¹Ÿç»™æ‰“è¿›å»ã€‚" class="headerlink" title="mavenä¸­å¦‚ä½•é¡ºå¸¦æŠŠnativeçš„libraryä¹Ÿç»™æ‰“è¿›å»ã€‚"></a>mavenä¸­å¦‚ä½•é¡ºå¸¦æŠŠnativeçš„libraryä¹Ÿç»™æ‰“è¿›å»ã€‚</h3><p>å¯ä»¥å‚è€ƒnetty-transport-native-unix-common ä¸­çš„åšæ³•ï¼Œå†™ä¸€ä¸ªmakefileï¼Œä½¿ç”¨mavenæ’ä»¶è°ƒç”¨ç³»ç»Ÿçš„gccå‘½ä»¤ï¼Œä¼ å‚ã€‚æœ€ç»ˆæ‰“åŒ…</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/FreshSalt_ZH-CN12818759319_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;mavençš„ä¸€äº›ä¸œè¥¿&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å„ç§ç¼–ç¨‹è¯­è¨€ä¸cã€c++çš„äº¤äº’</title>
    <link href="https://haldir65.github.io/2019/07/31/2019-07-31-interops-between-c-and-other-languages/"/>
    <id>https://haldir65.github.io/2019/07/31/2019-07-31-interops-between-c-and-other-languages/</id>
    <published>2019-07-31T22:11:55.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://api1.foster66.xyz/static/imgs/SutherlandFalls_ZH-CN4602884079_1920x1080.jpg" alt=""><br><a id="more"></a></p><h2 id="1-cpython"><a href="#1-cpython" class="headerlink" title="1. cpython"></a>1. cpython</h2><h3 id="1-1-pythonä¸­è°ƒç”¨Cã€C-ä»£ç "><a href="#1-1-pythonä¸­è°ƒç”¨Cã€C-ä»£ç " class="headerlink" title="1.1 pythonä¸­è°ƒç”¨Cã€C++ä»£ç "></a>1.1 pythonä¸­è°ƒç”¨Cã€C++ä»£ç </h3><p>æ–¹æ³•ä¸€ï¼š<br>Pythonä¸­çš„ctypesæ¨¡å—å¯èƒ½æ˜¯è°ƒç”¨Cæ–¹æ³•æœ€ç®€å•çš„ä¸€ç§ã€‚ctypesæ¨¡å—æä¾›äº†å’ŒCè¯­è¨€å…¼å®¹çš„æ•°æ®ç±»å‹äº†å‡½æ•°æ¥åŠ è½½dllæˆ–è€…soæ–‡ä»¶ã€‚</p><p>cè¯­è¨€ä»£ç : add.c</p><pre><code class="c">#include &lt;stdio.h&gt;int add_int(int, int);float add_float(float, float);int add_int(int num1, int num2){    return num1 + num2;}float add_float(float num1, float num2){    return num1 + num2;}</code></pre><p>ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªadder.soçš„æ–‡ä»¶</p><p>#For Linux<br>$  gcc -shared -Wl,-soname,adder -o adder.so -fPIC add.c</p><p>#For Mac<br>$ gcc -shared -Wl,-install_name,adder.so -o adder.so -fPIC add.c</p><p>pythonä»£ç </p><pre><code class="python">from ctypes import *#load the shared object fileadder = CDLL(&#39;./adder.so&#39;)#Find sum of integersres_int = adder.add_int(4,5)print &quot;Sum of 4 and 5 = &quot; + str(res_int)#Find sum of floatsa = c_float(5.5)b = c_float(4.1)add_float = adder.add_floatadd_float.restype = c_floatprint &quot;Sum of 5.5 and 4.1 = &quot;, str(add_float(a, b))</code></pre><p>æ–¹æ³•äºŒï¼šPython/C APIï¼ˆc python extension  ï¼‰<br>å…¶å®å°±æ˜¯è‡ªå·±å†™python c extensionäº†</p><pre><code class="python">#Though it looks like an ordinary python import, the addList module is implemented in Cimport addListl = [1,2,3,4,5]print &quot;Sum of List - &quot; + str(l) + &quot; = &quot; +  str(addList.add(l))</code></pre><pre><code class="c">//Python.h has all the required function definitions to manipulate the Python objects#include &lt;Python.h&gt;//This is the function that is called from your python codestatic PyObject* addList_add(PyObject* self, PyObject* args){    PyObject * listObj;    //The input arguments come as a tuple, we parse the args to get the various variables    //In this case it&#39;s only one list variable, which will now be referenced by listObj    if (! PyArg_ParseTuple( args, &quot;O&quot;, &amp;listObj ))        return NULL;    //length of the list    long length = PyList_Size(listObj);    //iterate over all the elements    int i, sum =0;    for (i = 0; i &lt; length; i++) {        //get an element out of the list - the element is also a python objects        PyObject* temp = PyList_GetItem(listObj, i);        //we know that object represents an integer - so convert it into C long        long elem = PyInt_AsLong(temp);        sum += elem;    }    //value returned back to python code - another python object    //build value here converts the C long to a python integer    return Py_BuildValue(&quot;i&quot;, sum);}//This is the docstring that corresponds to our &#39;add&#39; function.static char addList_docs[] =&quot;add(  ): add all elements of the list\n&quot;;/* This table contains the relavent info mapping -   &lt;function-name in python module&gt;, &lt;actual-function&gt;,   &lt;type-of-args the function expects&gt;, &lt;docstring associated with the function&gt; */static PyMethodDef addList_funcs[] = {    {&quot;add&quot;, (PyCFunction)addList_add, METH_VARARGS, addList_docs},    {NULL, NULL, 0, NULL}};/*   addList is the module name, and this is the initialization block of the module.   &lt;desired module name&gt;, &lt;the-info-table&gt;, &lt;module&#39;s-docstring&gt; */PyMODINIT_FUNC initaddList(void){    Py_InitModule3(&quot;addList&quot;, addList_funcs,            &quot;Add all ze lists&quot;);}</code></pre><h3 id="1-2-Cã€C-è°ƒç”¨pythonä»£ç "><a href="#1-2-Cã€C-è°ƒç”¨pythonä»£ç " class="headerlink" title="1.2 Cã€C++è°ƒç”¨pythonä»£ç "></a>1.2 Cã€C++è°ƒç”¨pythonä»£ç </h3><p>å‚è€ƒä¸Šé¢çš„python c extensionæ–¹æ³•ï¼Œå¯ä»¥åœ¨cè¯­è¨€ä¸­æ“ä½œpythonå¯¹è±¡</p><h3 id="1-3-pythonè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"><a href="#1-3-pythonè°ƒç”¨ç³»ç»Ÿæ–¹æ³•" class="headerlink" title="1.3 pythonè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"></a>1.3 pythonè°ƒç”¨ç³»ç»Ÿæ–¹æ³•</h3><pre><code class="py">##ã€€ç¬¬ä¸€ç§os.system(command)## ç¬¬äºŒç§import subprocesssubprocess.Popen(args, bufsize=0, executable=None, stdin=None, stdout=None, stderr=None, preexec_fn=None, close_fds=False, shell=False, cwd=None, env=None, universal_newlines=False, startupinfo=None, creationflags=0)subprocess.call([&quot;cmd&quot;, &quot;arg1&quot;, &quot;arg2&quot;],shell=True)</code></pre><p>ç›®å‰pythonå®˜æ–¹æ¨èçš„è°ƒç”¨æ–¹æ³•çš„æ–¹å¼è¿˜æ˜¯subprocessã€‚</p><p>cython(python c extension)å’Œcpython(cè¯­è¨€å®ç°çš„pythonï¼‰æ˜¯ä¸¤ä»¶äº‹</p><h2 id="2-javascript"><a href="#2-javascript" class="headerlink" title="2. javascript"></a>2. javascript</h2><h3 id="2-1-javascriptè°ƒç”¨Cã€C-ä»£ç "><a href="#2-1-javascriptè°ƒç”¨Cã€C-ä»£ç " class="headerlink" title="2.1 javascriptè°ƒç”¨Cã€C++ä»£ç "></a>2.1 javascriptè°ƒç”¨Cã€C++ä»£ç </h3><p>é¦–å…ˆï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œcè¯­è¨€çš„ä»£ç ï¼Œä¼¼ä¹å¯ä»¥å°†Cç¼–æˆWebAssemblyåœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚<br>è€Œåœ¨Node jsä¸­ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://nodejs.org/api/n-api.html">n-api</a>è¿™ä¸ªmoduleã€‚</p><blockquote><p>N-API (pronounced N as in the letter, followed by API) is an API for building native Addons. It is independent from the underlying JavaScript runtime (for example, V8) and is maintained as part of Node.js itself. This API will be Application Binary Interface (ABI) stable across versions of Node.js. It is intended to insulate Addons from changes in the underlying JavaScript engine and allow modules compiled for one major version to run on later major versions of Node.js without recompilation. </p></blockquote><p>å°±æ˜¯è¯´ä¿æŒäº†binary compatibilityï¼Œæ¯”å¦‚è¯´åœ¨node6ä¸Šç¼–è¯‘é€šè¿‡ä¹‹åï¼Œå‡å¦‚åé¢å‡ºäº†node10ï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ä¹Ÿèƒ½ç»§ç»­è¿è¡Œã€‚</p><p>node-gyp(gypæ˜¯generate your projectçš„æ„æ€)å¯ä»¥ç¼–è¯‘ç”Ÿæˆnode js addonï¼Œå…¶å®ä¹Ÿå°±æ˜¯åœ¨hostæœºå™¨ä¸Šç”Ÿæˆå¯¹åº”çš„æœºå™¨ç <br>ä¸‹é¢çœ‹å¦‚ä½•ä½¿ç”¨:<br><a href="https://medium.com/@tarkus/how-to-call-c-c-code-from-node-js-86a773033892">how-to-call-c-c-code-from-node-js</a><br>å¾ˆå¤šå¤§å‹jsé¡¹ç›®éƒ½æœ‰ä¸€ä¸ªbinging.gypæ–‡ä»¶ï¼ˆä¸€å®šæ˜¯è¿™ä¸ªåå­—ï¼‰</p><p><a href="https://jameshfisher.com/2019/04/20/nodejs-addon-hello-world/">node js addon</a> åœ¨jsä»£ç ä¸­è¿˜æ˜¯importçš„æ–¹å¼</p><p><a href="https://www.youtube.com/watch?v=O4Rlq_NSkoM">youtubeä¸Šæœ‰ä¸€ä¸ª2019å¹´çš„windowsä¸Šçš„æ•™ç¨‹</a></p><p>gypå…¶å®æ˜¯ä¸€ä¸ªç”¨æ¥ç”Ÿæˆé¡¹ç›®æ–‡ä»¶çš„å·¥å…·ï¼Œä¸€å¼€å§‹æ˜¯è®¾è®¡ç»™chromiumé¡¹ç›®ä½¿ç”¨çš„ï¼Œåæ¥å¤§å®¶å‘ç°æ¯”è¾ƒå¥½ç”¨å°±ç”¨åˆ°äº†å…¶ä»–åœ°æ–¹ã€‚ç”Ÿæˆé¡¹ç›®æ–‡ä»¶åå°±å¯ä»¥è°ƒç”¨GCC, vsbuild, xcodeç­‰ç¼–è¯‘å¹³å°æ¥ç¼–è¯‘ã€‚è‡³äºä¸ºä»€ä¹ˆè¦æœ‰node-gypï¼Œæ˜¯ç”±äºnodeç¨‹åºä¸­éœ€è¦è°ƒç”¨ä¸€äº›å…¶ä»–è¯­è¨€ç¼–å†™çš„å·¥å…·ç”šè‡³æ˜¯dllï¼Œéœ€è¦å…ˆç¼–è¯‘ä¸€ä¸‹ï¼Œå¦åˆ™å°±ä¼šæœ‰è·¨å¹³å°çš„é—®é¢˜ï¼Œä¾‹å¦‚åœ¨windowsä¸Šè¿è¡Œçš„è½¯ä»¶copyåˆ°macä¸Šå°±ä¸èƒ½ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæºç æ”¯æŒï¼Œç¼–è¯‘ä¸€ä¸‹ï¼Œåœ¨macä¸Šè¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚</p><h3 id="2-2-Cã€C-è°ƒç”¨javascriptä»£ç "><a href="#2-2-Cã€C-è°ƒç”¨javascriptä»£ç " class="headerlink" title="2.2 Cã€C++è°ƒç”¨javascriptä»£ç "></a>2.2 Cã€C++è°ƒç”¨javascriptä»£ç </h3><p><a href="https://stackoverflow.com/questions/2713289/how-to-execute-javascript-function-in-c">JavaScript is not a compiled language</a> æ‰€ä»¥è¿™ä¹ˆåšè™½ç„¶å¯è¡Œï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ã€‚ä¸”ç½‘ä¸Šçš„æ•™ç¨‹å¤šæ•°æ˜¯c++çš„ã€‚</p><h3 id="2-3-javascriptè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"><a href="#2-3-javascriptè°ƒç”¨ç³»ç»Ÿæ–¹æ³•" class="headerlink" title="2.3 javascriptè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"></a>2.3 javascriptè°ƒç”¨ç³»ç»Ÿæ–¹æ³•</h3><p>åœ¨node js ä¸­å¯ä»¥ä½¿ç”¨<a href="https://nodejs.org/api/child_process.html#child_process_child_process_execfile_file_args_options_callback">child_processæ¨¡å—</a></p><pre><code class="c">// myProgram.c#include &lt;stdio.h&gt;int main(void){    puts(&quot;4&quot;);    return 0;}</code></pre><p>gcc -o myProgram myProgram.c</p><pre><code class="js">const { exec } = require(&quot;child_process&quot;);exec(&quot;./myProgram&quot;, (error, stdout, stderr) =&gt; console.log(stdout));</code></pre><h2 id="3-java"><a href="#3-java" class="headerlink" title="3. java"></a>3. java</h2><p>å…¶å®å°±æ˜¯jniäº†ï¼Œ<a href="https://medium.com/@bschlining/a-simple-java-native-interface-jni-example-in-java-and-scala-68fdafe76f5f">To be honest, if you have any other choice besides using JNI, do that other thing.</a><br>å¦‚æœä¸æ˜¯æ²¡æœ‰javaçš„è§£å†³æ–¹æ³•ï¼Œä¸è¦ä½¿ç”¨jniï¼Œä¸€ä¸ªæ˜¯éº»çƒ¦ï¼Œå¦ä¸€ä¸ªæ˜¯æˆ‘ä»¬å½»åº•å¤±å»äº†è·¨å¹³å°å…¼å®¹æ€§</p><p><a href="https://www.zfl9.com/java-jni.html">è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘è§è¯†è¿‡çš„æœ€æ–°æ‰‹å‹å¥½çš„jniè§£é‡Š</a></p><p>JNIçš„æµç¨‹ç½‘ä¸Šæœ‰ä¸€å¤§å †ï¼Œæ³¨æ„çš„æ˜¯ä¸åŒçš„å¹³å°gccçš„å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸‰æ­¥ç›´æ¥æå®š,åœ¨linuxä¸Šäº²æµ‹è¿™æ ·æ˜¯å¯ä»¥çš„</p><pre><code class="shell">## ç”Ÿæˆå¤´æ–‡ä»¶å…¶å®ä¹Ÿå¾ˆç®€å•javac -h . HelloJNI2.java ## å…ˆæ˜¯ç”Ÿæˆ.oæ–‡ä»¶gcc -c -I /usr/lib/jvm/java-8-openjdk-amd64/include -I /usr/lib/jvm/java-8-openjdk-amd64/include/linux jni/hellojni.c  ## ç„¶åæ‰“æˆsharedLibrarygcc -rdynamic -shared -o libhellojni.so hellojni.o## åœ¨intelijé‡Œé¢classæ–‡ä»¶éƒ½æ”¾åœ¨target/classesç›®å½•ä¸‹ï¼Œè¿™ä¹ˆä¸€å¥è¯å°±èƒ½æŠŠä»£ç è·‘èµ·æ¥java -cp .:target/classes com.me.harris.jupiter.channel.HelloJNI</code></pre><p>è¿™ä¸¤æ­¥èµ°å®Œï¼Œå°±åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†libhellojni.soæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹javaä»£ç è¿™è¾¹<br>ä½¿ç”¨System.loadLibraryçš„å‰ææ˜¯æŠŠè¿™ä¸ªsoæ–‡ä»¶æ‰”åˆ°/usr/libè¿™ä¸€ç±»çš„æ–‡ä»¶å¤¹é‡Œé¢ï¼Œæˆ–è€…ä½¿ç”¨-Djava.library.pathæŒ‡å®š<br>å…·ä½“ç‚¹çš„è¯ï¼š</p><pre><code class="java">System.out.println(System.getProperty(&quot;java.library.path&quot;));// æ‰“å°å‡ºæ¥ /usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib// loadLibrary(&quot;hello&quot;)å°±æ˜¯å»ä¸Šè¿°ç›®å½•é‡Œé¢æ‰¾ä¸€ä¸ªå«åšlibhello.soçš„æ–‡ä»¶ï¼Œæ²¡æœ‰çš„è¯å°±æŠ¥é”™//java -cp . -Djava.library.path=/NATIVE_SHARED_LIB_FOLDER com.xxx.xxxString currentDir = System.getProperty(&quot;user.dir&quot;); //è¿™ä¸ªå°±æ˜¯pwdSystem.load(currentDir+&quot;/&quot;+&quot;libhellojni.so&quot;); //loadåˆ™æ˜¯ç»™å‡ºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„,è¿™é‡Œé¢çš„æ–œçº¿ç…§è¯´ä¹Ÿè¦ä¾æ®å¹³å°åŒºåˆ†çš„,System.getProperty(&quot;line.separator&quot;)</code></pre><h3 id="3-1-javaè°ƒç”¨Cã€C-ä»£ç "><a href="#3-1-javaè°ƒç”¨Cã€C-ä»£ç " class="headerlink" title="3.1 javaè°ƒç”¨Cã€C++ä»£ç "></a>3.1 javaè°ƒç”¨Cã€C++ä»£ç </h3><p><a href="https://www.baeldung.com/jni">è¯¦ç»†æ•™ç¨‹</a><br>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„</p><h3 id="3-2-Cã€C-è°ƒç”¨javaä»£ç "><a href="#3-2-Cã€C-è°ƒç”¨javaä»£ç " class="headerlink" title="3.2 Cã€C++è°ƒç”¨javaä»£ç "></a>3.2 Cã€C++è°ƒç”¨javaä»£ç </h3><p>cã€c++å±‚è°ƒç”¨javaä¹Ÿæ˜¯å¯ä»¥çš„,ç”šè‡³å¯ä»¥åœ¨nativeå±‚åˆ›å»ºä¸€ä¸ªjavaå®ä¾‹è¿”å›ç»™javaå±‚ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªjavaå¯¹è±¡çš„æ–¹æ³•è‡³å°‘åŒ…æ‹¬new,unsafe,Constructor.newInstanceä»¥åŠjniã€‚ unsafeçš„æ–¹å¼åªæ˜¯åˆ†é…å†…å­˜ï¼Œå¹¶ä¸è°ƒç”¨æ„é€ å‡½æ•°ã€‚</p><pre><code class="java">//1. ç”¨newå…³é”®å­—ï¼Œè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„//2. ç”¨unsafeUnsafe#allocateInstance(Class&lt;?&gt;) //3. ç”¨java.lang.reflect.Constructor.newInstance(Object... initargs) public T newInstance(Object... initargs) throws InstantiationException,IllegalAccessException, IllegalArgumentException, InvocationTargetException// 4.jniç›´æ¥æ“ä½œ//å…³é”®å°±è¿™ä¹ˆä¸€å¥ï¼Œæ³¨æ„è¿™ä¸€å¥æ˜¯ä¸ä¼šè°ƒç”¨åˆ°æ— å‚çš„æ„é€ å‡½æ•°çš„ã€‚env-&gt;AllocObject(userDataClass);</code></pre><p>å¥½å¥‡çœ‹äº†çœ¼unsafeçš„<a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/tip/src/share/vm/prims/unsafe.cpp">hotspotæºç </a> åŸæ¥ç”¨çš„ä¹Ÿæ˜¯AllocObject</p><pre><code class="cpp">UNSAFE_ENTRY(jobject, Unsafe_AllocateInstance(JNIEnv *env, jobject unsafe, jclass cls))  UnsafeWrapper(&quot;Unsafe_AllocateInstance&quot;);  {    ThreadToNativeFromVM ttnfv(thread);    return env-&gt;AllocObject(cls);  }UNSAFE_END</code></pre><p>æ¯”æ–¹è¯´å…¥å£æ–‡ä»¶å«åšcom.me.harris.jupiter.channel.HelloJNI2.java<br>ç”Ÿæˆçš„å¤´æ–‡ä»¶å°±å«åš<br>com_me_harris_jupiter_channel_HelloJNI2.h<br>g++çš„å‚æ•°æœ‰ä¸€ç‚¹ç‚¹åŒºåˆ«</p><pre><code class="shell">g++ -c -fPIC -I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux com_me_harris_jupiter_channel_HelloJNI2.cpp -o com_me_harris_jupiter_channel_HelloJNI2.og++ -shared -fPIC -o libnative.so com_me_harris_jupiter_channel_HelloJNI2.o -lcmv libnative.so  jnijava -cp .:target/classes -Djava.library.path=jni com.me.harris.jupiter.channel.HelloJNI2 ## javaå‘½ä»¤è¡Œå‚æ•°ä¸€ä¸ªæ¯”è¾ƒçƒ¦äººçš„åœ°æ–¹å°±æ˜¯com.example.Mainè¿™ä¸ªclasséå¾—è¦å»ä¸€ä¸ªcom/exampleæ–‡ä»¶å¤¹ä¸‹é¢æœ‰è¿™ä¸ªclassæ–‡ä»¶##cpçš„æ„æ€å°±æ˜¯classpathäº†ï¼Œè¿™ä¸ªå‘½ä»¤è¦èƒ½è·‘æˆåŠŸï¼Œå‰ææ˜¯targetæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªcom/me/harris/jupiter/channel/è¿™ä¹ˆä¸€è¿ä¸²çš„æ–‡ä»¶å¤¹ </code></pre><p><a href="https://github.com/Haldir65/scripts/tree/master/jnistuff">è‡ªå·±å‚è€ƒç€å†™äº†jniçš„ä¸€äº›ç”¨ä¾‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç…§ç€oracleçš„docä¸€ä¸ªä¸ªå»å°è¯•å‚æ•°å’Œæ–¹æ³•äº†</a></p><h3 id="3-3-javaè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"><a href="#3-3-javaè°ƒç”¨ç³»ç»Ÿæ–¹æ³•" class="headerlink" title="3.3 javaè°ƒç”¨ç³»ç»Ÿæ–¹æ³•"></a>3.3 javaè°ƒç”¨ç³»ç»Ÿæ–¹æ³•</h3><p>javaæœ‰ä¸€ä¸ªProcess api<br>javaä¸­Processçš„Api<br>å…³é”®è¯ï¼šProcessBuilder , java9æä¾›äº†æ–°çš„Apiã€‚å¦å¤–è¿˜æœ‰Runtime.execè¿™ä¸ªæ–¹æ³•<br>äº²æµ‹ï¼Œä¸‹é¢çš„å‘½ä»¤å¯ä»¥åœ¨macä¸Šæ‰§è¡Œuname -a å‘½ä»¤</p><pre><code class="java">//ç”¨ProcessBuilderæ˜¯ä¸€ç§åšæ³• try {        Runtime r = Runtime.getRuntime();        Process p = r.exec(&quot;uname -a&quot;);        p.waitFor();        BufferedReader b = new BufferedReader(new InputStreamReader(p.getInputStream()));        String line = &quot;&quot;;        while ((line = b.readLine()) != null) {            System.out.println(line);        }        b.close();    }catch (IOException | InterruptedException e){    }//  ä¸‹é¢è¿™ä¸ªä¹Ÿè¡ŒString s = null;try {    // run the Unix &quot;ps -ef&quot; command    // using the Runtime exec method:    Process p = Runtime.getRuntime().exec(&quot;ps -ef&quot;);    BufferedReader stdInput = new BufferedReader(new            InputStreamReader(p.getInputStream()));    BufferedReader stdError = new BufferedReader(new            InputStreamReader(p.getErrorStream()));    // read the output from the command    System.out.println(&quot;Here is the standard output of the command:\n&quot;);    while ((s = stdInput.readLine()) != null) {        System.out.println(s);    }    // read any errors from the attempted command    System.out.println(&quot;Here is the standard error of the command (if any):\n&quot;);    while ((s = stdError.readLine()) != null) {        System.out.println(s);    }    System.exit(0);}catch (IOException e) {    System.out.println(&quot;exception happened - here&#39;s what I know: &quot;);    e.printStackTrace();    System.exit(-1);}</code></pre><p>åªä¸è¿‡å¾ˆå°‘è§è¿‡ç”¨javaå»è°ƒç”¨ç³»ç»Ÿæ¥å£çš„</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/SutherlandFalls_ZH-CN4602884079_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å †å¤–å†…å­˜ï¼ŒweakHashMapä»¥åŠå››ç§å¼•ç”¨ç±»å‹çš„ç ”ç©¶</title>
    <link href="https://haldir65.github.io/2019/07/28/2019-07-28-from-directByteBuffer-to-PhantomReference/"/>
    <id>https://haldir65.github.io/2019/07/28/2019-07-28-from-directByteBuffer-to-PhantomReference/</id>
    <published>2019-07-28T22:34:37.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>DirectByteBufferï¼ˆå †å¤–å†…å­˜ï¼‰æ˜¯åˆ†é…åœ¨jvmä»¥å¤–çš„å†…å­˜ï¼Œè¿™ä¸ªjavaå¯¹è±¡æœ¬èº«æ˜¯å—jvm gcæ§åˆ¶çš„ï¼Œä½†æ˜¯å…¶æŒ‡å‘çš„å †å¤–å†…å­˜æ˜¯å¦‚ä½•å›æ”¶çš„<br><img src="https://api1.foster66.xyz/static/imgs/JovianCloudscape_EN-AU11726040455_1920x1080.jpg" alt=""><br><a id="more"></a></p><p>javaä¸­æœ‰å››ç§å¼•ç”¨</p><p>Strong Reference<br>Soft Reference ï¼ˆè½¯å¼•ç”¨ï¼‰<br>Weak Reference ï¼ˆå¼±å¼•ç”¨ï¼‰<br>PhantomReference Referenceï¼ˆè™šå¼•ç”¨ï¼‰</p><p>é™¤äº†å¼ºå¼•ç”¨ï¼Œå¦å¤–ä¸‰ä¸ªclasséƒ½ç»§æ‰¿è‡ªReferenceè¿™ä¸ªçˆ¶ç±»ï¼Œå…¶æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ª</p><pre><code class="java">//referent ä¸ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡Reference(T referent) {    this(referent, null);}//ReferenceQueueå¯¹è±¡ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—//GC åœ¨æ£€æµ‹åˆ°appropriate reachability changesä¹‹åï¼Œ//ä¼šæŠŠå¼•ç”¨å¯¹è±¡æœ¬èº«æ·»åŠ åˆ°è¿™ä¸ªqueueä¸­ï¼Œä¾¿äºæ¸…ç†å¼•ç”¨å¯¹è±¡æœ¬èº«Reference(T referent, ReferenceQueue&lt;? super T&gt; queue) {    this.referent = referent;    this.queue = (queue == null) ? ReferenceQueue.NULL : queue;}</code></pre><p>è°ƒç”¨è™šå¼•ç”¨çš„getæ–¹æ³•ï¼Œæ€»ä¼šè¿”å›nullï¼Œä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸åŒçš„æ˜¯ï¼Œè™šå¼•ç”¨è¢«enqueuedæ—¶ï¼ŒGC å¹¶ä¸ä¼šè‡ªåŠ¨æ¸…ç†è™šå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ï¼Œåªæœ‰å½“æŒ‡å‘è¯¥å¯¹è±¡çš„æ‰€æœ‰è™šå¼•ç”¨å…¨éƒ¨è¢«æ¸…ç†ï¼ˆenqueuedåï¼‰åæˆ–å…¶æœ¬èº«ä¸å¯è¾¾æ—¶ï¼Œè¯¥å¯¹è±¡æ‰ä¼šè¢«æ¸…ç†ã€‚</p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«gcå›æ”¶ã€‚<br>è½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨å¿…é¡»å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œå½“gcå›æ”¶è¿™ä¸ªè½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡æ—¶ï¼Œä¼šæŠŠè¿™ä¸ªè½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨æ”¾åˆ°è¿™ä¸ªå¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚<br>æ¯”å¦‚ï¼Œä¸Šè¿°çš„Entryæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œå®ƒå¼•ç”¨çš„å¯¹è±¡æ˜¯keyï¼Œå½“keyè¢«å›æ”¶æ—¶ï¼ŒEntryä¼šè¢«æ”¾åˆ°queueä¸­ã€‚</p><h2 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h2><pre><code class="java">public class WeakHashMap&lt;K,V&gt;    extends AbstractMap&lt;K,V&gt;    implements Map&lt;K,V&gt; {        private final ReferenceQueue&lt;Object&gt; queue = new ReferenceQueue&lt;&gt;();    /**     * Constructs a new, empty &lt;tt&gt;WeakHashMap&lt;/tt&gt; with the default initial     * capacity (16) and load factor (0.75).     */    public WeakHashMap() {        this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR);    }    //è¿™æ˜¯openjdk1.8çš„æºç     //è‡³å°‘ä»æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºæ¥ï¼Œé»˜è®¤çš„å®¹é‡æ˜¯16ã€‚    }</code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯å†…éƒ¨æœ‰ä¸€ä¸ªReferenceQueueã€‚<br>WeakHashMapçš„æ ¸å¿ƒå®šä¹‰æ˜¯ï¼š ä¸€æ—¦keyä¸å†è¢«å¤–éƒ¨æŒæœ‰ï¼Œè¿™ä¸ªEntryå°†åœ¨æœªæ¥çš„æŸä¸€æ—¶åˆ»è¢«å¹²æ‰ã€‚<br><a href="https://docs.oracle.com/javase/8/docs/api/java/util/WeakHashMap.html">oracle java doc for weakHashMap</a>ä¸­æåˆ°ï¼ŒWeakHashMapçš„keyæœ€å¥½æ˜¯é‚£ç§equalsæ˜¯ç›´æ¥ä½¿ç”¨==çš„ï¼Œå½“ç„¶ä½¿ç”¨Stringè¿™ç§equalsæ˜¯æ¯”è¾ƒå®é™…å†…å®¹çš„ä¹Ÿå¯ä»¥ã€‚ä½†ä¼šå¸¦æ¥ä¸€äº›confusingçš„ç°è±¡ã€‚</p><blockquote><p>This class is intended primarily for use with key objects whose equals methods test for object identity using the == operator. Once such a key is discarded it can never be recreated, so it is impossible to do a lookup of that key in a WeakHashMap at some later time and be surprised that its entry has been removed. This class will work perfectly well with key objects whose equals methods are not based upon object identity, such as String instances. With such recreatable key objects, however, the automatic removal of WeakHashMap entries whose keys have been discarded may prove to be confusing.</p></blockquote><p>åœ¨å†…éƒ¨ç»“æ„æ–¹é¢ï¼Œå’Œjdk1.7çš„HashMapå·®ä¸å¤šï¼Œéƒ½æ˜¯æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œå†²çª<br>WeakHashMapå¥‡æ€ªçš„ç‚¹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­å°±çŸ¥é“äº†</p><pre><code class="java">public class TestWeakHashMap{    private String str1 = new String(&quot;newString1&quot;); //this entry will be removed soon    private String str2 = &quot;literalString2&quot;;    private String str3 = &quot;literalString3&quot;;    private String str4 = new String(&quot;newString4&quot;); //this entry will be removed soon    private Map map = new WeakHashMap();     void testGC() throws IOException    {        map.put(str1, new Object());        map.put(str2, new Object());        map.put(str3, new Object());        map.put(str4, new Object());        /**         * Discard the strong reference to all the keys         */        str1 = null;        str2 = null;        str3 = null;        str4 = null;        while (true) {            System.gc();            /**             * Verify Full GC with the -verbose:gc option             * We expect the map to be emptied as the strong references to             * all the keys are discarded.             */            System.out.println(&quot;map.size(); = &quot; + map.size() + &quot;  &quot; + map);            // map.size(); = 2  {literalString3=java.lang.Object@266474c2, literalString2=java.lang.Object@6f94fa3e}        }    }    public static void main(String[] args) {        try {            new TestWeakHashMap().testGC();        } catch (IOException e) {            e.printStackTrace();        }    }}</code></pre><p>è¿™é‡Œæä¸€å¥ï¼Œå¦‚æœæ˜¯ç”¨string.internæå‡ºæ¥çš„keyï¼Œé‚£ä¹ˆæ°¸è¿œéƒ½ä¸ä¼šè¢«ç§»é™¤ã€‚</p><p>WeakHashMapçœ‹ä¸Šå»å°±åƒæœ‰ä¸€æ¡ä¸“é—¨çš„çº¿ç¨‹åœ¨åå°æ‚„æ‚„çš„æ¸…ç†é‚£äº›keyå·²ç»æ²¡æœ‰å…¶ä»–å¼•ç”¨çš„Entryã€‚<br>è¿™ä¸ªæ¸…ç†Entryçš„æ–¹æ³•å«åšexpungeStaleEntriesï¼Œå°±æ˜¯ä¸“é—¨ç”¨äºæ¸…é™¤é‚£äº›å¤±æ•ˆçš„Entryçš„ã€‚WeakHashmapä¸­çš„keyè¢«åŒ…è¿›ä¸€ä¸ªWeakReferenceä¸­ï¼Œ<strong>å½“è¿™ä¸ªreferenceå‡ºç°åœ¨ReferenceQueueä¸­çš„æ—¶å€™ï¼Œå°±æ„å‘³ç€è¿™ä¸ªkeyå·²ç»æ²¡æœ‰åœ°æ–¹ç”¨åˆ°äº†</strong>ã€‚ä½†æ˜¯è¿™ä¸ªWeakReferenceå¯¹è±¡è¿˜è¦å¹²æ‰ï¼ŒexpungeStaleEntrieså°±æ˜¯ä»queueä¸­å–å‡ºæ‰€æœ‰çš„WeakReference(Entry)ï¼Œè¿™é‡Œå½“ç„¶ä¸ä¼šè°ƒç”¨WeakReferenceçš„getæ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨hashï¼Œæ‰¾åˆ°å…¶åœ¨tablesä¸­çš„ä½ç½®ï¼Œå†ä»é“¾è¡¨ä¸­æ‰¾åˆ°è¿™ä¸ªentryï¼Œnullæ‰value(å› ä¸ºvalueè¢«entryå¼ºå¼•ç”¨ï¼Œè¿™ä¸€æ­¥åªæ˜¯å¸®åŠ©gc)ï¼Œå°†è¿™ä¸ªentryä»é“¾è¡¨ä¸­ç§»é™¤ã€‚(é‚£ä¹ˆè¿™ä¸ªWeakReferenceå¯¹è±¡å°±å½»åº•æ²¡æœ‰ä»»ä½•å¼•ç”¨äº†ï¼Œåé¢gcä¼šfreeæ‰è¿™éƒ¨åˆ†çš„memory)</p><p>è¿™ä¸ªæ–¹æ³•ä¼šåœ¨å¾ˆå¤šæ–¹æ³•é‡Œç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨åˆ°<br>put,get,size,removeå‡ ä¹æ‰€æœ‰çš„crudæ–¹æ³•éƒ½ä¼šåœ¨æ–¹æ³•çš„æœ€å¼€å¤´è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥ç§»é™¤staleçš„Entryã€‚</p><p>ä¸Šé¢è¯´åˆ°<strong>å¥½åƒæœ‰ä¸€æ¡çº¿ç¨‹ä¸“é—¨åœ¨åå°æ‚„æ‚„çš„æŠŠä¸ç”¨çš„referenceæ”¾åˆ°queueé‡Œé¢</strong>ï¼Œè¿™æ¡çº¿ç¨‹æ˜¯å­˜åœ¨çš„ã€‚<br>java.lang.ref.Reference.ReferenceHandler,æ˜¯Referenceçš„private static å†…éƒ¨class</p><pre><code class="java"> /* High-priority thread to enqueue pending References     */private static class ReferenceHandler extends Thread {   public void run() {            while (true) {                tryHandlePending(true);            }        }}//ä¸Šé¢çš„æ³¨é‡Šæåˆ°high priorityï¼Œå¤šé«˜çš„ä¼˜å…ˆçº§å‘¢ã€‚//è¿™æ®µè¯å†™åœ¨Reference.javaé‡Œé¢ static {        ThreadGroup tg = Thread.currentThread().getThreadGroup();        for (ThreadGroup tgn = tg;             tgn != null;             tg = tgn, tgn = tg.getParent());        Thread handler = new ReferenceHandler(tg, &quot;Reference Handler&quot;);        /* If there were a special system-only priority greater than         * MAX_PRIORITY, it would be used here         */        handler.setPriority(Thread.MAX_PRIORITY); //æ€»ä¹‹å°±æ˜¯å¾ˆé«˜çš„ä¼˜å…ˆçº§        handler.setDaemon(true); // å®ˆæŠ¤çº¿ç¨‹ä¸€èˆ¬åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åœ¨åå°æä¾›ä¸€ç§é€šç”¨æœåŠ¡çš„çº¿ç¨‹        handler.start();}</code></pre><h2 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹:"></a>é‡ç‚¹:</h2><p>å››ç§çŠ¶æ€(å‡ºå¤„è§å‚è€ƒ)</p><p>æ¯ä¸€æ—¶åˆ»ï¼ŒReferenceå¯¹è±¡éƒ½å¤„äºä¸‹é¢å››ç§çŠ¶æ€ä¸­ã€‚è¿™å››ç§çŠ¶æ€ç”¨Referenceçš„æˆå‘˜å˜é‡queueä¸nextï¼ˆç±»ä¼¼äºå•é“¾è¡¨ä¸­çš„nextï¼‰æ¥è¡¨ç¤ºã€‚</p><blockquote><p>ReferenceQueue&lt;? super T&gt; queue;<br>Reference next;</p></blockquote><ul><li><font color="red">Active</font>ã€‚æ–°åˆ›å»ºçš„å¼•ç”¨å¯¹è±¡éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œåœ¨ GC æ£€æµ‹åˆ°å¼•ç”¨å¯¹è±¡å·²ç»åˆ°è¾¾åˆé€‚çš„reachabilityæ—¶ï¼ŒGC ä¼šæ ¹æ®å¼•ç”¨å¯¹è±¡æ˜¯å¦åœ¨åˆ›å»ºæ—¶åˆ¶å®šReferenceQueueå‚æ•°è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼Œå¦‚æœæŒ‡å®šäº†ï¼Œé‚£ä¹ˆè½¬ç§»åˆ°Pendingï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œè½¬ç§»åˆ°Inactiveã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­</li></ul><blockquote><p>//å¦‚æœæ„é€ å‚æ•°ä¸­æ²¡æŒ‡å®šqueueï¼Œé‚£ä¹ˆqueueä¸ºReferenceQueue.NULLï¼Œå¦åˆ™ä¸ºæ„é€ å‚æ•°ä¸­ä¼ é€’è¿‡æ¥çš„queue<br>queue = ReferenceQueue || ReferenceQueue.NULL<br>next = null</p></blockquote><ul><li><font color="orange">Pending</font>ã€‚pending-Referenceåˆ—è¡¨ä¸­çš„å¼•ç”¨éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œå®ƒä»¬ç­‰ç€è¢«å†…éƒ¨çº¿ç¨‹ReferenceHandlerå¤„ç†ï¼ˆä¼šè°ƒç”¨ReferenceQueue.enqueueæ–¹æ³•ï¼‰ã€‚æ²¡æœ‰æ³¨å†Œçš„å®ä¾‹ä¸ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­</li></ul><blockquote><p>//æ„é€ å‚æ•°å‚æ•°ä¸­ä¼ é€’è¿‡æ¥çš„queue<br>queue = ReferenceQueue<br>next = è¯¥queueä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æœæ˜¯è¯¥é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆä¸ºthis</p></blockquote><ul><li><p><font color="green">Enqueued</font>ã€‚è°ƒç”¨ReferenceQueue.enqueuedæ–¹æ³•åçš„å¼•ç”¨å¤„äºè¿™ä¸ªçŠ¶æ€ä¸­ã€‚æ²¡æœ‰æ³¨å†Œçš„å®ä¾‹ä¸ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€(å°±æ˜¯æ²¡æœ‰èµ°ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°çš„é‚£ç§)ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­</p><blockquote><p>queue = ReferenceQueue.ENQUEUED<br>next = è¯¥queueä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æœæ˜¯è¯¥é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆä¸ºthis</p></blockquote></li><li><p><font color="blue">Inactive</font>ã€‚æœ€ç»ˆçŠ¶æ€ï¼Œå¤„äºè¿™ä¸ªçŠ¶æ€çš„å¼•ç”¨å¯¹è±¡ï¼ŒçŠ¶æ€ä¸ä¼šå†æ”¹å˜ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­</p><blockquote><p>queue = ReferenceQueue.NULL<br>next = this</p></blockquote></li></ul><p>æœ‰äº†è¿™äº›çº¦æŸï¼ŒGC åªéœ€è¦æ£€æµ‹nextå­—æ®µå°±å¯ä»¥çŸ¥é“æ˜¯å¦éœ€è¦å¯¹è¯¥å¼•ç”¨å¯¹è±¡é‡‡å–ç‰¹æ®Šå¤„ç†</p><blockquote><p>å¦‚æœnextä¸ºnullï¼Œé‚£ä¹ˆè¯´æ˜è¯¥å¼•ç”¨ä¸ºActiveçŠ¶æ€<br>å¦‚æœnextä¸ä¸ºnullï¼Œé‚£ä¹ˆ GC åº”è¯¥æŒ‰å…¶æ­£å¸¸é€»è¾‘å¤„ç†è¯¥å¼•ç”¨ï¼ˆå°±æ˜¯èµ°åŠ å…¥queueé‚£ä¸€å¥—ï¼‰ã€‚</p></blockquote><h3 id="å¦‚æœæ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆäº‹åç¨‹åºå‘˜å¯ä»¥é€šè¿‡è¯¥é˜Ÿåˆ—æ¸…ç†å¼•ç”¨"><a href="#å¦‚æœæ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆäº‹åç¨‹åºå‘˜å¯ä»¥é€šè¿‡è¯¥é˜Ÿåˆ—æ¸…ç†å¼•ç”¨" class="headerlink" title="å¦‚æœæ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆäº‹åç¨‹åºå‘˜å¯ä»¥é€šè¿‡è¯¥é˜Ÿåˆ—æ¸…ç†å¼•ç”¨"></a>å¦‚æœæ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆäº‹åç¨‹åºå‘˜å¯ä»¥é€šè¿‡è¯¥é˜Ÿåˆ—æ¸…ç†å¼•ç”¨</h3><h3 id="å¦‚æœæ„é€ å‡½æ•°ä¸­æ²¡æœ‰æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆ-GC-ä¼šè‡ªåŠ¨æ¸…ç†å¼•ç”¨"><a href="#å¦‚æœæ„é€ å‡½æ•°ä¸­æ²¡æœ‰æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆ-GC-ä¼šè‡ªåŠ¨æ¸…ç†å¼•ç”¨" class="headerlink" title="å¦‚æœæ„é€ å‡½æ•°ä¸­æ²¡æœ‰æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆ GC ä¼šè‡ªåŠ¨æ¸…ç†å¼•ç”¨"></a>å¦‚æœæ„é€ å‡½æ•°ä¸­æ²¡æœ‰æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆ GC ä¼šè‡ªåŠ¨æ¸…ç†å¼•ç”¨</h3><p><strong><em>tryHandlePendingä¼šå°†å½“å‰çš„staticçš„ä¸€ä¸ªReference(pending)åŠ å…¥åˆ°r.queueé‡Œé¢,åŒæ—¶è®¾ç½®pendingä¸ºpending.discoveredã€‚(è¿™ä¸ªdiscoveredæ˜¯vmèµ‹å€¼çš„ï¼Œgcç»™javaå±‚ç•™äº†ä¸ªå£å­ï¼Œå°†æ²¡æœ‰å…¶ä»–å¼•ç”¨çš„Referenceèµ‹å€¼åˆ°è¿™é‡Œäº†ï¼Œå‰ææ˜¯Referenceæ˜¯è°ƒç”¨å¸¦ReferenceQueueçš„æ„é€ å‡½æ•°åˆ›å»ºçš„)</em></strong><br>è¿™é‡Œå¤´è‚¯å®šæœ‰jniè°ƒç”¨ï¼Œå…·ä½“åŸç†ä¸æ¸…æ¥šã€‚</p><p>tryHandlePendingåˆ¤æ–­æå–å‡ºæ¥çš„Referenceæ˜¯å¦æ˜¯Cleanerè¿™ä¸ªclassï¼Œ<br>å¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥è°ƒç”¨Cleaner.cleanï¼ˆï¼‰<br>å¦åˆ™æ‰§è¡Œå°†è¿™ä¸ªReferenceåŠ å…¥åˆ°Queueï¼ˆè¿™ä¸ªReferenceçš„Queueï¼‰é‡Œé¢</p><pre><code class="java">public class Cleaner    extends PhantomReference&lt;Object&gt;{    // cleanerä¸€èˆ¬ç”¨è¿™ç§é™æ€å‡½æ•°åˆ›å»ºå‡ºæ¥å¯ä»¥è®¤ä¸ºæ˜¯æä¾›ä¸€ä¸ªå›è°ƒäº†    public static Cleaner create(Object ob, Runnable thunk) {        if (thunk == null)            return null;        return add(new Cleaner(ob, thunk));    }}</code></pre><p>è‡³äºä¸ºä»€ä¹ˆtryHandlePendingè¿™ä¸ªæ–¹æ³•ä»è¿™ä¸ªé“¾è¡¨é‡Œé¢æå…ƒç´ çš„æ—¶å€™ä¼šæå‡ºæ¥ä¸€ä¸ªCleanerå‘¢ï¼Œå› ä¸ºCleaneréƒ½æ˜¯è¿™ä¹ˆåˆ›å»ºå‡ºæ¥çš„ï¼Œéƒ½æ˜¯ç”¨å¸¦Queueçš„æ„é€ å‡½æ•°åˆ›å»ºçš„ã€‚</p><pre><code class="java">private Cleaner(Object referent, Runnable thunk) {    super(referent, dummyQueue); //è¿™ä¸ªSuperæ˜¯PhantomReferenceï¼Œå†å¾€ä¸Šæ˜¯Reference    this.thunk = thunk;}</code></pre><p>PhantomReferenceæ˜¯æœ€å¼±çš„å¼•ç”¨äº†ã€‚<br>DirectByteBufferæ˜¯è¿™æ ·åˆ›å»ºCleanerçš„ï¼š</p><blockquote><p>cleaner = Cleaner.create(this, new Deallocator(base, size, cap));</p></blockquote><p>Deallocatorçš„runæ–¹æ³•é‡Œé¢å°±æ˜¯è°ƒç”¨Unsafeçš„æ–¹æ³•æ ¹æ®addresså»freeå†…å­˜<br>ï¼Œè¿™å°±æ˜¯nioçš„DirectByteBufferæ˜¯å¦‚ä½•ç®¡ç†å †å¤–å†…å­˜çš„åŸç†äº†ã€‚</p><p>äºæ˜¯stackoverflowä¸Šå°±å‡ºç°äº†â€å¦‚ä½•é‡Šæ”¾DirectByteBufferçš„native memoryâ€çš„æ–¹æ¡ˆ</p><pre><code class="java">import sun.misc.Cleaner;import sun.nio.ch.DirectBuffer;public static void clean(ByteBuffer bb) {    if(bb == null) return;    Cleaner cleaner = ((DirectBuffer) bb).cleaner();    if (cleaner != null) cleaner.clean();}</code></pre><pre><code class="java">import sun.misc.Cleaner;import java.lang.reflect.Field;import java.nio.ByteBuffer;...public static void main(String[] args) throws Exception {    ByteBuffer direct = ByteBuffer.allocateDirect(1024);    Field cleanerField = direct.getClass().getDeclaredField(&quot;cleaner&quot;);    cleanerField.setAccessible(true);    Cleaner cleaner = (Cleaner) cleanerField.get(direct);    cleaner.clean();}</code></pre><p>ä¸æ³¨æ„å°±ç”¨åˆ°äº†sunçš„packageäº†ï¼Œå› ä¸ºsun.xxxè¿™äº›packageä¸‹é¢çš„classéƒ½æ˜¯åœ¨rt.jaré‡Œé¢ï¼Œç”±BootStrapClassLaoderåŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¿™ä¸ªpackageã€‚ä¸è¿‡å¥½åƒjava9å¼€å§‹sunè¿™ä¸ªåŒ…ä¸‹é¢çš„ä¸œè¥¿é»˜è®¤ä¸èƒ½ç”¨äº†ã€‚</p><h3 id="ç»éªŒ"><a href="#ç»éªŒ" class="headerlink" title="ç»éªŒ"></a>ç»éªŒ</h3><ol><li>WeakHashMapçš„keyå€¾å‘äºä½¿ç”¨é‚£ç§equalsæ˜¯ç›´æ¥æ¯”è¾ƒ==çš„ï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°hashCodeçš„é‚£ä¸€å¥—</li><li>debugçš„æ—¶å€™æœ‰æ—¶å€™ä¼šçœ‹è§â€œReference Handlerâ€è¿™ä¹ˆä¸€æ¡çº¿ç¨‹ï¼Œå°±æ˜¯è´Ÿè´£è¿­ä»£å¼•ç”¨é“¾è¡¨çš„</li><li>Referenceçš„æ„é€ å‡½æ•°å¦‚æœä¼ å…¥äº†ReferenceQueueï¼Œç›¸å½“äºç»™è¿™ä¸ªReferenceçš„gcäº‹ä»¶æŒ‚äº†ä¸ªé’©å­,å¤§è‡´ç›¸å½“äºreference.addWillGCListenerï¼ŒDirectByteBufferå°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚å¾ˆç†Ÿæ‚‰æ˜¯å—ï¼Œfinalizerï¼ˆåªæ˜¯æ›´åŠ è½»é‡çº§ï¼‰ã€‚</li><li>WeakHashMapçš„valueæ˜¯å¼ºå¼•ç”¨ï¼Œä¸è¦å»æŒæœ‰keyã€‚</li></ol><h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>ä»æ³¨é‡Šé‡Œé¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œjava.lan.refè¿™ä¸‹é¢çš„å¾ˆå¤šclassæ˜¯Mark Reinholdå†™çš„ã€‚</p><p>Mark Reinhold is Chief Architect of the Java Platform Group at Oracle. His past contributions to the platform include character-stream readers and writers, reference objects, shutdown hooks, the NIO high-performance I/O APIs, library generification, and service loaders. Mark was the lead engineer for the JDK 1.2 and 5.0 releases, the JCP specification lead for Java SE 6, and both the project and specification lead for JDK 7 (Java SE 7) and JDK 8 (Java SE 8). He currently leads the JDK 9 and Jigsaw projects in the OpenJDK Community, where he also serves on the Governing Board. Mark holds a Ph.D. in computer science from the Massachusetts Institute of Technology.</p><p>Brian Goetz is the Java Language Architect at Oracle, and was the specification lead for JSR-335 (Lambda Expressions for the Java Programming Language.) He is the author of the best-selling Java Concurrency in Practice, as well as over 75 articles on Java development, and has been fascinated by programming since Jimmy Carter was President.</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://liujiacai.net/blog/2015/09/27/java-weakhashmap/">java WeakHashMap</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;DirectByteBufferï¼ˆå †å¤–å†…å­˜ï¼‰æ˜¯åˆ†é…åœ¨jvmä»¥å¤–çš„å†…å­˜ï¼Œè¿™ä¸ªjavaå¯¹è±¡æœ¬èº«æ˜¯å—jvm gcæ§åˆ¶çš„ï¼Œä½†æ˜¯å…¶æŒ‡å‘çš„å †å¤–å†…å­˜æ˜¯å¦‚ä½•å›æ”¶çš„&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/JovianCloudscape_EN-AU11726040455_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
      <category term="tbd" scheme="https://haldir65.github.io/tags/tbd/"/>
    
  </entry>
  
  <entry>
    <title>Tomcatéƒ¨åˆ†æºç è§£æ</title>
    <link href="https://haldir65.github.io/2019/07/28/2019-07-28-tomcat-source-code-grep/"/>
    <id>https://haldir65.github.io/2019/07/28/2019-07-28-tomcat-source-code-grep/</id>
    <published>2019-07-28T21:50:29.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/apache/tomcat">Tomcat</a>æºç è§£æ</p><p><img src="https://api1.foster66.xyz/static/imgs/LetchworthSP_EN-AU14482052774_1920x1080.jpg" alt=""><br><a id="more"></a></p><p>tomcatçš„ä½¿ç”¨å¾ˆç®€å•ï¼Œwindowsä¸‹åŒå‡»é‚£ä¸ªstartup.batæˆ–è€…cd åˆ°binç›®å½•ï¼Œè¿è¡Œcatlina runå°±å¯ä»¥äº†ã€‚é…ç½®çš„è¯ï¼Œç”¨xmlæ–‡ä»¶å°±å¯ä»¥äº†ï¼Œé™æ€æ–‡ä»¶æ”¾åœ¨webapp/ç›®å½•ä¸‹ã€‚ã€‚</p><p>ä»Spring-bootæ”¯æŒçš„embedded servlet containerå°±èƒ½çœ‹å‡ºæ¥ï¼Œtomcatçš„æ›¿ä»£å“æœ‰ä¸å°‘<br>spring-boot-starter-undertow,<br>spring-boot-starter-jetty,<br>spring-boot-starter-tomcat </p><p><strong><font color="red">æºç ç‰ˆæœ¬tomcat 9.0.21</font></strong></p><h2 id="ä»mainå‡½æ•°å¼€å§‹å§"><a href="#ä»mainå‡½æ•°å¼€å§‹å§" class="headerlink" title="ä»mainå‡½æ•°å¼€å§‹å§"></a>ä»mainå‡½æ•°å¼€å§‹å§</h2><p>tomcatçš„ä¸»å‡½æ•°åœ¨org.apache.catalina.startup.Bootstrapè¿™ä¸ªæ–‡ä»¶ä¸­</p><pre><code class="java">public final class Bootstrap {    public static void main(String args[]) {        Bootstrap bootstrap = new Bootstrap();        try {            bootstrap.init();        } catch (Throwable t) {            t.printStackTrace();            return;        }        //æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®ä¸åŒçš„commandæ‰§è¡Œå¯¹åº”çš„start,stopç­‰å‘½ä»¤          try {            String command = &quot;start&quot;;            if (args.length &gt; 0) {                command = args[args.length - 1];            }            if (command.equals(&quot;startd&quot;)) {                args[args.length - 1] = &quot;start&quot;;                daemon.load(args);                daemon.start();            } else if (command.equals(&quot;stopd&quot;)) {                args[args.length - 1] = &quot;stop&quot;;                daemon.stop();            } else if (command.equals(&quot;start&quot;)) {                daemon.setAwait(true);                daemon.load(args);                daemon.start();                if (null == daemon.getServer()) {                    System.exit(1);                }            } else if (command.equals(&quot;stop&quot;)) {                daemon.stopServer(args);            } else if (command.equals(&quot;configtest&quot;)) {                daemon.load(args);                if (null == daemon.getServer()) {                    System.exit(1);                }                System.exit(0);            } else {                log.warn(&quot;Bootstrap: command \&quot;&quot; + command + &quot;\&quot; does not exist.&quot;);            }        }    }}</code></pre><h2 id="initçš„è°ƒç”¨æ ˆ"><a href="#initçš„è°ƒç”¨æ ˆ" class="headerlink" title="initçš„è°ƒç”¨æ ˆ"></a>initçš„è°ƒç”¨æ ˆ</h2><p>Tomcatèƒ½å¤Ÿå¤„ç†ajp(ä¸å¸¸ç”¨ï¼Œæ— è§†)å’Œhttpåè®®ã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼ŒServeråªæœ‰ä¸€ä¸ªServiceç»„ä»¶ï¼ŒServiceç»„ä»¶å…ˆåå¯¹Engineã€Connectorè¿›è¡Œåˆå§‹åŒ–ã€‚è€ŒEngineç»„ä»¶å¹¶ä¸ä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹å­å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒHostã€Contextã€Wrapperå®¹å™¨çš„åˆå§‹åŒ–æ˜¯åœ¨starté˜¶æ®µå®Œæˆçš„ã€‚tomcaté»˜è®¤ä¼šå¯ç”¨HTTP1.1å’ŒAJPçš„Connectorè¿æ¥å™¨ï¼Œè¿™ä¸¤ç§åè®®é»˜è®¤ä½¿ç”¨Http11NioProtocolã€AJPNioProtocolè¿›è¡Œå¤„ç†</p><blockquote><p>Connectorçš„ä¸»è¦åŠŸèƒ½ï¼Œæ˜¯æ¥æ”¶è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºRequestå’ŒResponseå¯¹è±¡ç”¨äºå’Œè¯·æ±‚ç«¯äº¤æ¢æ•°æ®ï¼›ç„¶ååˆ†é…çº¿ç¨‹è®©Engineï¼ˆä¹Ÿå°±æ˜¯Servletå®¹å™¨ï¼‰æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶æŠŠäº§ç”Ÿçš„Requestå’ŒResponseå¯¹è±¡ä¼ ç»™Engineã€‚å½“Engineå¤„ç†å®Œè¯·æ±‚åï¼Œä¹Ÿä¼šé€šè¿‡Connectorå°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p></blockquote><p>ProtocolHandleræ˜¯å¤„ç†HTTP1.1åè®®çš„ç±»(å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£)ï¼Œå®ç°çš„å­ç±»æœ‰ä¸¤ä¸ªï¼ŒAbstractProtocolå’ŒHttp11NioProtocolï¼ˆç»§æ‰¿äºAbstractProtocolï¼‰<br>AbstractProtocolæ˜¯åŸºæœ¬çš„å®ç°ï¼Œå¯ä»¥è®¤ä¸ºè¿™ä¸ªç±»æŠŠä¸»è¦çš„æ´»éƒ½å¹²äº†ï¼Œè€ŒNIOé»˜è®¤ä½¿ç”¨çš„æ˜¯Http11NioProtocolã€‚</p><p>åœ¨AbstractProtocolçš„initæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†endpoint.init();endPointæ˜¯æŠ½è±¡ç±»ï¼Œå®ç°ç±»åŒ…æ‹¬NioEndpointå’ŒNio2Endpointã€‚Endpointçš„ä¸»è¦å·¥ä½œæ˜¯å®Œæˆç«¯å£å’Œåœ°å€çš„ç»‘å®šç›‘å¬ã€‚</p><pre><code class="java">// NioEndPoint.javaprivate volatile ServerSocketChannel serverSock = null;// ServerSocketChannelæ˜¯nioçš„ä¸€ä¸ªç±»ï¼Œç”¨äºç›‘å¬å¤–æ¥è¯·æ±‚çš„protected void initServerSocket() throws Exception {serverSock = ServerSocketChannel.open();        socketProperties.setProperties(serverSock.socket()); // è¿™é‡Œé¢è®¾äº†æ˜¯å¦è¦setReuseAddressï¼Œè®¾ç½®setSoTimeoutä¸ºå¤šå°‘        InetSocketAddress addr = new InetSocketAddress(getAddress(), getPortWithOffset());        serverSock.socket().bind(addr,getAcceptCount()); //è¿™é‡Œå°±æ˜¯socket.bindçš„åœ°æ–¹äº†}// Nio2Endpoint.java@Overridepublic void bind() throws Exception {    serverSock = AsynchronousServerSocketChannel.open(threadGroup);    socketProperties.setProperties(serverSock);    InetSocketAddress addr = new InetSocketAddress(getAddress(), getPortWithOffset());    serverSock.bind(addr, getAcceptCount());}</code></pre><p>å¯ä»¥çœ‹å‡ºæ¥NioEndPointå’ŒNio2EndPointåœ¨ç»‘å®šsocketçš„æ—¶å€™çš„åŒºåˆ«æ˜¯åè€…ç”¨çš„æ˜¯jdk1.7çš„AsynchronousServerSocketChannelï¼Œè€ŒServerSocketChannelæ˜¯jdk1.4å°±æœ‰çš„ã€‚javaçš„ioæ“ä½œåˆ†ä¸ºbio,nio,nio2ï¼Œtomcat8.5å¼€å§‹å»æ‰äº†bioï¼ˆå°±æ˜¯é‚£ç§é˜»å¡å¼ioï¼‰çš„æ”¯æŒã€‚</p><p>åœ¨ socketProperties.setPropertiesé‡Œé¢ï¼Œè®¾ç½®äº†socketçš„è¶…æ—¶æ—¶é—´ï¼Œå¾ˆå¥½å¥‡åˆ°åº•æ˜¯å¤šå°‘<br>åœ¨Constants.javaä¸­</p><pre><code class="java">public static final int DEFAULT_CONNECTION_TIMEOUT = 60000; </code></pre><p><strong>æ‰€ä»¥æ˜¯1åˆ†é’Ÿ?</strong></p><p>æ¥ç€NioEndPoint.javaçš„Bindæ–¹æ³•æ¥çœ‹ï¼Œèµ°åˆ°äº†selectorPool.open(getName());<br>è¿™é‡Œé¢å°±æ˜¯å¯åŠ¨äº†ä¸€æ¡çº¿ç¨‹,NioBlockingSelector.BlockPollerç»§æ‰¿è‡ªThreadã€‚å¯¹åº”çš„runæ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯selectoré‚£ä¸€å¥—(selector.selectedKeys()è·å¾—ä¸€ä¸ªIterator<SelectionKey> ï¼Œæ ¹æ®æ˜¯read,writeè¿˜æ˜¯connectçš„å½¢å¼å»åˆ¤æ–­)ã€‚æ³¨æ„ï¼Œæ­¤åˆ»å·²ç»å¼€å§‹selectäº†ã€‚selectè‡ªèº«æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ä¸€æ—¦æœ‰ioäº‹ä»¶åˆ°æ¥ï¼Œå°±ä¼šå°†äº‹ä»¶äº¤ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œæ‰€ä»¥å¹¶å‘æ€§èƒ½æ˜¯å¯ä»¥çš„ã€‚</p><p><a href="https://www.cnblogs.com/kismetv/p/7806063.html">å‚è€ƒ</a></p><font color="red">Tomcatå¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ï¼šåœ¨accepté˜Ÿåˆ—ä¸­æ¥æ”¶è¿æ¥ï¼ˆå½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸OSå®Œæˆä¸‰æ¬¡æ¡æ‰‹å»ºç«‹äº†è¿æ¥ï¼Œåˆ™OSå°†è¯¥è¿æ¥æ”¾å…¥accepté˜Ÿåˆ—ï¼‰ï¼›åœ¨è¿æ¥ä¸­è·å–è¯·æ±‚çš„æ•°æ®ï¼Œç”Ÿæˆrequestï¼›è°ƒç”¨servletå®¹å™¨å¤„ç†è¯·æ±‚ï¼›è¿”å›responseã€‚</font><p>çº¿ç¨‹æ± çš„é…ç½®æ˜¯å¯ä»¥é€šè¿‡server.xmlé…ç½®çš„</p><pre><code class="xml">&lt;Executor name=&quot;tomcatThreadPool&quot; namePrefix =&quot;catalina-exec-&quot; maxThreads=&quot;150&quot; minSpareThreads=&quot;4&quot; /&gt;&lt;Connector executor=&quot;tomcatThreadPool&quot; port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; acceptCount=&quot;1000&quot; /&gt;</code></pre><p><font color="red">Connectorä¸­çš„å‡ ä¸ªå‚æ•°åŠŸèƒ½å¦‚ä¸‹ï¼š</font></p><ul><li><p>acceptCount<br>accepté˜Ÿåˆ—çš„é•¿åº¦ï¼›å½“accepté˜Ÿåˆ—ä¸­è¿æ¥çš„ä¸ªæ•°è¾¾åˆ°acceptCountæ—¶ï¼Œé˜Ÿåˆ—æ»¡ï¼Œè¿›æ¥çš„è¯·æ±‚ä¸€å¾‹è¢«æ‹’ç»ã€‚é»˜è®¤å€¼æ˜¯100ã€‚<br>å…³äºè¿™ä¸ª100ï¼Œæˆ‘è®°å¾—2017å¹´çš„æ—¶å€™ï¼Œå…¬å¸åç«¯è€å¤§åœ¨ä¸€æ¬¡å†…éƒ¨æŠ€æœ¯åˆ†äº«çš„ç‚¹è¯„ç¯èŠ‚æé—®ä¸€å¸®åç«¯è¿™ä¸ªå‚æ•°æ˜¯å¤šå°‘ï¼Œå…¶å½“æ—¶è¿˜æåˆ°è¿™ä¸ªExecutorâ€œå°±æ˜¯æ¥å®¢â€çš„(åŸè¯å¦‚æ­¤)ã€‚ä¸¤å¹´åå›è¿‡å¤´æ¥å†æ¥çœ‹è¿™æ®µï¼ŒæŒºæœ‰è¶£çš„ã€‚</p></li><li><p>maxConnections<br>Tomcatåœ¨ä»»æ„æ—¶åˆ»æ¥æ”¶å’Œå¤„ç†çš„æœ€å¤§è¿æ¥æ•°ã€‚å½“Tomcatæ¥æ”¶çš„è¿æ¥æ•°è¾¾åˆ°maxConnectionsæ—¶ï¼ŒAcceptorçº¿ç¨‹ä¸ä¼šè¯»å–accepté˜Ÿåˆ—ä¸­çš„è¿æ¥ï¼›è¿™æ—¶accepté˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç€ï¼Œç›´åˆ°Tomcatæ¥æ”¶çš„è¿æ¥æ•°å°äºmaxConnectionsã€‚å¦‚æœè®¾ç½®ä¸º-1ï¼Œåˆ™è¿æ¥æ•°ä¸å—é™åˆ¶ã€‚</p></li><li><p>maxThreads<br>è¯·æ±‚å¤„ç†çº¿ç¨‹çš„æœ€å¤§æ•°é‡ã€‚é»˜è®¤å€¼æ˜¯200ï¼ˆTomcat7å’Œ8éƒ½æ˜¯çš„ï¼‰ã€‚å¦‚æœè¯¥Connectorç»‘å®šäº†Executorï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºè¯¥Connectorå°†ä½¿ç”¨ç»‘å®šçš„Executorï¼Œè€Œä¸æ˜¯å†…ç½®çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œä»»åŠ¡ã€‚<br>maxThreadsè§„å®šçš„æ˜¯æœ€å¤§çš„çº¿ç¨‹æ•°ç›®ï¼Œå¹¶ä¸æ˜¯å®é™…runningçš„CPUæ•°é‡ï¼›å®é™…ä¸Šï¼ŒmaxThreadsçš„å¤§å°æ¯”CPUæ ¸å¿ƒæ•°é‡è¦å¤§å¾—å¤šã€‚è¿™æ˜¯å› ä¸ºï¼Œå¤„ç†è¯·æ±‚çš„çº¿ç¨‹çœŸæ­£ç”¨äºè®¡ç®—çš„æ—¶é—´å¯èƒ½å¾ˆå°‘ï¼Œå¤§å¤šæ•°æ—¶é—´å¯èƒ½åœ¨é˜»å¡ï¼Œå¦‚ç­‰å¾…æ•°æ®åº“è¿”å›æ•°æ®ã€ç­‰å¾…ç¡¬ç›˜è¯»å†™æ•°æ®ç­‰ã€‚å› æ­¤ï¼Œåœ¨æŸä¸€æ—¶åˆ»ï¼Œåªæœ‰å°‘æ•°çš„çº¿ç¨‹çœŸæ­£çš„åœ¨ä½¿ç”¨ç‰©ç†CPUï¼Œå¤§å¤šæ•°çº¿ç¨‹éƒ½åœ¨ç­‰å¾…ï¼›å› æ­¤çº¿ç¨‹æ•°è¿œå¤§äºç‰©ç†æ ¸å¿ƒæ•°æ‰æ˜¯åˆç†çš„ã€‚<br>æ¢å¥è¯è¯´ï¼ŒTomcaté€šè¿‡ä½¿ç”¨æ¯”CPUæ ¸å¿ƒæ•°é‡å¤šå¾—å¤šçš„çº¿ç¨‹æ•°ï¼Œå¯ä»¥ä½¿CPUå¿™ç¢Œèµ·æ¥ï¼Œå¤§å¤§æé«˜CPUçš„åˆ©ç”¨ç‡ã€‚<br>é»˜è®¤å€¼ä¸è¿æ¥å™¨ä½¿ç”¨çš„åè®®æœ‰å…³ï¼šNIOçš„é»˜è®¤å€¼æ˜¯10000ï¼ŒAPR/nativeçš„é»˜è®¤å€¼æ˜¯8192ï¼Œè€ŒBIOçš„é»˜è®¤å€¼ä¸ºmaxThreadsï¼ˆå¦‚æœé…ç½®äº†Executorï¼Œåˆ™é»˜è®¤å€¼æ˜¯Executorçš„maxThreadsï¼‰ã€‚<br>åœ¨windowsä¸‹ï¼ŒAPR/nativeçš„maxConnectionså€¼ä¼šè‡ªåŠ¨è°ƒæ•´ä¸ºè®¾ç½®å€¼ä»¥ä¸‹æœ€å¤§çš„1024çš„æ•´æ•°å€ï¼›å¦‚è®¾ç½®ä¸º2000ï¼Œåˆ™æœ€å¤§å€¼å®é™…æ˜¯1024ã€‚</p></li></ul><hr><p><font color="red">Executorçš„ä¸»è¦å±æ€§åŒ…æ‹¬ï¼š</font></p><ul><li>nameï¼šè¯¥çº¿ç¨‹æ± çš„æ ‡è®°</li><li>maxThreadsï¼šçº¿ç¨‹æ± ä¸­æœ€å¤§æ´»è·ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼200ï¼ˆTomcat7å’Œ8éƒ½æ˜¯ï¼‰</li><li>minSpareThreadsï¼šçº¿ç¨‹æ± ä¸­ä¿æŒçš„æœ€å°çº¿ç¨‹æ•°ï¼Œæœ€å°å€¼æ˜¯25</li><li>maxIdleTimeï¼šçº¿ç¨‹ç©ºé—²çš„æœ€å¤§æ—¶é—´ï¼Œå½“ç©ºé—²è¶…è¿‡è¯¥å€¼æ—¶å…³é—­çº¿ç¨‹ï¼ˆé™¤éçº¿ç¨‹æ•°å°äºminSpareThreadsï¼‰ï¼Œå•ä½æ˜¯msï¼Œé»˜è®¤å€¼60000ï¼ˆ1åˆ†é’Ÿï¼‰</li><li>daemonï¼šæ˜¯å¦åå°çº¿ç¨‹ï¼Œé»˜è®¤å€¼true</li><li>threadPriorityï¼šçº¿ç¨‹ä¼˜å…ˆçº§ï¼Œé»˜è®¤å€¼5</li><li>namePrefixï¼šçº¿ç¨‹åå­—çš„å‰ç¼€ï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹åå­—ä¸ºï¼šnamePrefix+çº¿ç¨‹ç¼–å·</li></ul><hr><p>è¿™äº›å‚æ•°çš„è°ƒä¼˜æœ‰ä¸€äº›ç»éªŒ:<br>ï¼ˆ1ï¼‰maxThreadsçš„è®¾ç½®æ—¢ä¸åº”ç”¨çš„ç‰¹ç‚¹æœ‰å…³ï¼Œä¹Ÿä¸æœåŠ¡å™¨çš„CPUæ ¸å¿ƒæ•°é‡æœ‰å…³ã€‚é€šè¿‡å‰é¢ä»‹ç»å¯ä»¥çŸ¥é“ï¼ŒmaxThreadsæ•°é‡åº”è¯¥è¿œå¤§äºCPUæ ¸å¿ƒæ•°é‡ï¼›è€Œä¸”CPUæ ¸å¿ƒæ•°è¶Šå¤§ï¼ŒmaxThreadsåº”è¯¥è¶Šå¤§ï¼›åº”ç”¨ä¸­CPUè¶Šä¸å¯†é›†ï¼ˆIOè¶Šå¯†é›†ï¼‰ï¼ŒmaxThreadsåº”è¯¥è¶Šå¤§ï¼Œä»¥ä¾¿èƒ½å¤Ÿå……åˆ†åˆ©ç”¨CPUã€‚å½“ç„¶ï¼ŒmaxThreadsçš„å€¼å¹¶ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå¦‚æœmaxThreadsè¿‡å¤§ï¼Œé‚£ä¹ˆCPUä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´ç”¨äºçº¿ç¨‹çš„åˆ‡æ¢ï¼Œæ•´ä½“æ•ˆç‡ä¼šé™ä½ã€‚<br>ï¼ˆ2ï¼‰maxConnectionsçš„è®¾ç½®ä¸Tomcatçš„è¿è¡Œæ¨¡å¼æœ‰å…³ã€‚<del/>å¦‚æœtomcatä½¿ç”¨çš„æ˜¯BIOï¼Œé‚£ä¹ˆmaxConnectionsçš„å€¼åº”è¯¥ä¸maxThreadsä¸€è‡´</del>ï¼›å¦‚æœtomcatä½¿ç”¨çš„æ˜¯NIOï¼ŒmaxConnectionså€¼åº”è¯¥è¿œå¤§äºmaxThreadsã€‚<br>ï¼ˆ3ï¼‰é€šè¿‡å‰é¢çš„ä»‹ç»å¯ä»¥çŸ¥é“ï¼Œè™½ç„¶tomcatåŒæ—¶å¯ä»¥å¤„ç†çš„è¿æ¥æ•°ç›®æ˜¯maxConnectionsï¼Œä½†æœåŠ¡å™¨ä¸­å¯ä»¥åŒæ—¶æ¥æ”¶çš„è¿æ¥æ•°ä¸ºmaxConnections+acceptCount ã€‚acceptCountçš„è®¾ç½®ï¼Œä¸åº”ç”¨åœ¨è¿æ¥è¿‡é«˜æƒ…å†µä¸‹å¸Œæœ›åšå‡ºä»€ä¹ˆååº”æœ‰å…³ç³»ã€‚å¦‚æœè®¾ç½®è¿‡å¤§ï¼Œåé¢è¿›å…¥çš„è¯·æ±‚ç­‰å¾…æ—¶é—´ä¼šå¾ˆé•¿ï¼›å¦‚æœè®¾ç½®è¿‡å°ï¼Œåé¢è¿›å…¥çš„è¯·æ±‚ç«‹é©¬è¿”å›connection refusedã€‚</p><p>èµ°åˆ°è¿™é‡Œï¼Œæ˜¯ä»BootStrap.init -&gt; Catalina.init-&gt; â€¦æ€»ä¹‹ä¸­é—´å°äº†å¾ˆå¤šå±‚ç»„ä»¶â€¦ -&gt; æ–¹æ³•çš„è°ƒç”¨æ ˆ</p><h2 id="startæ–¹æ³•çš„è°ƒç”¨æ ˆ"><a href="#startæ–¹æ³•çš„è°ƒç”¨æ ˆ" class="headerlink" title="startæ–¹æ³•çš„è°ƒç”¨æ ˆ"></a>startæ–¹æ³•çš„è°ƒç”¨æ ˆ</h2><p>å’Œinitä¸€æ ·,bootStrapçš„startæ–¹æ³•è¢«ä»£ç†ç»™äº†catalinaçš„startæ–¹æ³•<br>Catalina.java</p><pre><code class="java">public void start() {    try {        getServer().start();    } catch (LifecycleException e) {        //....        return;    }    if (shutdownHook == null) {        shutdownHook = new CatalinaShutdownHook();    }    //ç”¨äºå®‰å…¨çš„å…³é—­æœåŠ¡    Runtime.getRuntime().addShutdownHook(shutdownHook);     if (await) { //è¿™ä¸ªæ˜¯true            await(); //å…¶ç›®çš„åœ¨äºè®©tomcatåœ¨shutdownç«¯å£é˜»å¡ç›‘å¬å…³é—­å‘½ä»¤            stop();    }}</code></pre><p>ä¸Šé¢çš„getServerè¿”å›çš„æ˜¯serverçš„é»˜è®¤å®ç°StandardServerï¼Œåè€…çš„startInternalä¸­åˆä¼šèµ°åˆ°StandardServiceï¼Œçš„startInternalï¼Œè¿™é‡Œé¢ä¼š</p><ol><li>è°ƒç”¨Engine.start</li><li>å¯åŠ¨çº¿ç¨‹æ± </li><li>å¯åŠ¨Connector</li></ol><p>ä¸€ä¸ªä¸ªæ¥çœ‹<br>Engine<br>StandardEngineã€StandardHostã€StandardContextã€StandardWrapperå„ä¸ªå®¹å™¨å­˜åœ¨çˆ¶å­å…³ç³»ï¼Œä¸€ä¸ªçˆ¶å®¹å™¨åŒ…å«å¤šä¸ªå­å®¹å™¨ï¼Œå¹¶ä¸”ä¸€ä¸ªå­å®¹å™¨å¯¹åº”ä¸€ä¸ªçˆ¶å®¹å™¨ã€‚Engineæ˜¯é¡¶å±‚çˆ¶å®¹å™¨ï¼Œå®ƒä¸å­˜åœ¨çˆ¶å®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒStandardEngineåªæœ‰ä¸€ä¸ªå­å®¹å™¨StandardHostï¼Œä¸€ä¸ªStandardContextå¯¹åº”ä¸€ä¸ªwebappåº”ç”¨ï¼Œè€Œä¸€ä¸ªStandardWrapperå¯¹åº”ä¸€ä¸ªwebappé‡Œé¢çš„ä¸€ä¸ª Servletã€‚<br><a href="https://blog.csdn.net/Dwade_mia/article/details/79244157">å‚è€ƒ</a><br>StandardEngineçš„startInternalè°ƒç”¨åˆ°çˆ¶ç±»ContainerBaseçš„startInternalæ–¹æ³•ã€‚å…·ä½“å®ç°å°±æ˜¯ç»™ä¸€ä¸ªçº¿ç¨‹æ± å»è·‘æ‰€æœ‰childçš„å¯åŠ¨ä»»åŠ¡ã€‚å½“å‰çº¿ç¨‹é€šè¿‡Future.getæ–¹æ³•é˜»å¡ç­‰å¾…æ‰€æœ‰childåˆå§‹åŒ–å®Œæ¯•ã€‚<br>ä¸€ä¸ªchild(StandardHost)å°±æ˜¯ä¸€ä¸ªwebappï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶å‘å»åˆå§‹åŒ–å„ä¸ªwebapp<br><strong>server.xml</strong></p><pre><code class="xml">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; startStopThreads=&quot;4&quot;&gt;  &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;         prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;         pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;&lt;/Host&gt;</code></pre><p>ç„¶åå¯åŠ¨PipeLineï¼ˆPipelineæ˜¯ç®¡é“ç»„ä»¶ï¼Œç”¨äºå°è£…äº†ä¸€ç»„æœ‰åºçš„Valveï¼Œä¾¿äºValveé¡ºåºåœ°ä¼ é€’æˆ–è€…å¤„ç†è¯·æ±‚ï¼Œå°±æ˜¯å¤„ç†è¯·æ±‚çš„å‰åæ‹¦æˆªå™¨ï¼‰ã€‚<br>ValveåŒ…æ‹¬</p><ul><li>AccessLogValve(é»˜è®¤å¼€å¯ï¼Œç”¨äºè®°å½•è¯·æ±‚æ—¥å¿—)ï¼Œ</li><li>RemoteAddrValveï¼Œå¯ä»¥åšè®¿é—®æ§åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶IPé»‘ç™½åå• </li><li>RemoteIpValveï¼Œä¸»è¦ç”¨äºå¤„ç† X-Forwarded-For è¯·æ±‚å¤´ï¼Œç”¨æ¥è¯†åˆ«é€šè¿‡HTTPä»£ç†æˆ–è´Ÿè½½å‡è¡¡æ–¹å¼è¿æ¥åˆ°WebæœåŠ¡å™¨çš„å®¢æˆ·ç«¯æœ€åŸå§‹çš„IPåœ°å€çš„HTTPè¯·æ±‚å¤´å­—æ®µ</li></ul><p>åŠ è½½å­å®¹å™¨çš„æ–¹æ³•æ˜¯åœ¨HostConfig(å®ç°äº†LifecycleListenerï¼Œåœ¨startä¸­å¯åŠ¨Contextå®¹å™¨)å¤„ç†çš„ã€‚<br>HostConfig.java</p><pre><code class="java">    protected void deployApps() {        File appBase = host.getAppBaseFile();        File configBase = host.getConfigBaseFile();        String[] filteredAppPaths = filterAppPaths(appBase.list());        // Deploy XML descriptors from configBase        deployDescriptors(configBase, configBase.list());        // Deploy WARs        deployWARs(appBase, filteredAppPaths);        // Deploy expanded folders        deployDirectories(appBase, filteredAppPaths);    }</code></pre><p>deployWARsä¹Ÿæ˜¯ä¸¢(submit)Nä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œç„¶åè°ƒç”¨future.getä½¿å¾—å½“å‰çº¿ç¨‹é˜»å¡ç›´åˆ°æ‹¿åˆ°ç»“æœã€‚è¿™ä¸ªä»»åŠ¡å…¶å®å°±æ˜¯è§£å‹waræ–‡ä»¶(warå°±æ˜¯zipæ–‡ä»¶æ”¹äº†ä¸ªåç¼€),è¿™ä¸ªä»»åŠ¡åŒ…æ‹¬ï¼Œè°ƒç”¨javaå¤„ç†å‹ç¼©æ–‡ä»¶çš„API(JarEntry)å»è·å–æ–‡ä»¶å†…å®¹ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„<br>deployDirectoriesæ–¹æ³•çš„æ³¨é‡Šæ˜¯ï¼ˆDeploy exploded webapps.ï¼‰ï¼Œå°±æ˜¯è¯´è§£å‹å®Œæˆä¹‹ååšçš„äº‹æƒ…ã€‚è¿™é‡Œé¢åˆæ˜¯executor.submitï¼Œç„¶åfuture.geté‚£ä¸€å¥—ä¸œè¥¿(tomcaté‡Œä¼¼ä¹å¾ˆå¤šç”¨è¿™ç§æ–¹å¼ç­‰å¾…å¤šä¸ªä»»åŠ¡å®Œæˆ)ã€‚<br>deployWarså’ŒdeployDirectoriesä¸­éƒ½å‡ºç°äº†</p><blockquote><p>context = (Context) digester.parse(xml); //æ‰€ä»¥Contextæ˜¯å¯¹xmlæ–‡ä»¶çš„æè¿°ï¼Ÿ</p></blockquote><h2 id="NioEndPointå’ŒNioEndPoint2è¿™ä¿©æ˜¯å¦‚ä½•å®ç°ä»socketæ¥å—è¯·æ±‚å¹¶å°†å…¶è½¬åŒ–ä¸ºhttpè¯·æ±‚çš„ï¼Ÿ"><a href="#NioEndPointå’ŒNioEndPoint2è¿™ä¿©æ˜¯å¦‚ä½•å®ç°ä»socketæ¥å—è¯·æ±‚å¹¶å°†å…¶è½¬åŒ–ä¸ºhttpè¯·æ±‚çš„ï¼Ÿ" class="headerlink" title="NioEndPointå’ŒNioEndPoint2è¿™ä¿©æ˜¯å¦‚ä½•å®ç°ä»socketæ¥å—è¯·æ±‚å¹¶å°†å…¶è½¬åŒ–ä¸ºhttpè¯·æ±‚çš„ï¼Ÿ"></a>NioEndPointå’ŒNioEndPoint2è¿™ä¿©æ˜¯å¦‚ä½•å®ç°ä»socketæ¥å—è¯·æ±‚å¹¶å°†å…¶è½¬åŒ–ä¸ºhttpè¯·æ±‚çš„ï¼Ÿ</h2><h3 id="NioEndPoint"><a href="#NioEndPoint" class="headerlink" title="NioEndPoint"></a>NioEndPoint</h3><p>æ¥çœ‹NioEndPointçš„æ³¨é‡Š<br>NIO tailored thread pool, providing the following services:</p><ul><li>Socket acceptor thread</li><li>Socket poller thread</li><li>Worker threads pool<br>When switching to Java 5, thereâ€™s an opportunity to use the virtual machineâ€™s thread pool.ï¼ˆè¿™æ®µä¼¼ä¹æ˜¯ä½¿ç”¨äº†System.inheritedChannelè¿™ä¸ªæ–¹æ³•ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•çš„ä»‹ç»éå¸¸å°‘ï¼‰</li></ul><pre><code class="java">public class NioEndpoint extends AbstractJsseEndpoint&lt;NioChannel,SocketChannel&gt; {}// SocketChannel,ByteChannel,ScatteringByteChannel,GatheringByteChannelæ˜¯nioçš„classpublic class NioChannel implements ByteChannel, ScatteringByteChannel, GatheringByteChannel {}</code></pre><p>ä»æ³¨é‡Šæ¥çœ‹,NioEndPointçš„åŠŸèƒ½åŒ…æ‹¬(ç›‘å¬socketçš„çº¿ç¨‹ï¼Œpollçš„çº¿ç¨‹ï¼Œä»¥åŠä¸€ä¸ªå·¥ä½œåˆ†å‘çš„çº¿ç¨‹æ± )<br>ç›‘å¬æ˜¯è¿™ä¸€æ®µ:</p><pre><code class="java">serverSock = ServerSocketChannel.open();serverSock.socket().bind(addr,getAcceptCount()); //bindæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯requested maximum length of the queue of incoming connections.å°±æ˜¯è¿æ¥ç­‰å¾…é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦</code></pre><p>pollåœ¨è¿™é‡Œï¼Œåªæœ‰ä¸€æ¡çº¿ç¨‹</p><pre><code class="java">protected static class BlockPoller extends Thread {    //çº¿ç¨‹åå­—å«åš â€œâ€    poller.setName(name + &quot;-BlockPoller&quot;);    // ç»“æœä¸€èˆ¬æ˜¯ NioBlockingSelector.BlockPoller    public void run() {        while (run &amp;&amp; iterator != null &amp;&amp; iterator.hasNext()) {                    SelectionKey sk = iterator.next();                    NioSocketWrapper socketWrapper = (NioSocketWrapper) sk.attachment();                    try {                        iterator.remove();                        sk.interestOps(sk.interestOps() &amp; (~sk.readyOps()));                        if (sk.isReadable()) {                            countDown(socketWrapper.getReadLatch()); //è¿™é‡Œå°±æ˜¯é€šçŸ¥åœ¨ç­‰å¾…çš„Pollerçº¿ç¨‹ï¼Œå¯ä»¥å¼€å§‹è¯»äº†                        }                        if (sk.isWritable()) { //è¿™é‡Œæ˜¯é€šçŸ¥åœ¨ç­‰å¾…çš„Pollerçº¿ç¨‹ï¼Œå¯ä»¥å¼€å§‹å†™äº†                            countDown(socketWrapper.getWriteLatch());                        }                    } catch (CancelledKeyException ckx) {                        sk.cancel();                        countDown(socketWrapper.getReadLatch());                        countDown(socketWrapper.getWriteLatch());                    }                }    }}</code></pre><p>æ‰€ä»¥BlockPollerï¼ˆçº¿ç¨‹åNioBlockingSelector.BlockPollerï¼‰è¿™æ¡çº¿ç¨‹çš„ä½œç”¨ä¸»è¦å°±æ˜¯å¾ªç¯ç›‘å¬æ˜¯å¦æœ‰äº‹æƒ…å‘ç”Ÿï¼Œæœ‰äº‹æƒ…å‘ç”Ÿä¹‹åä½¿ç”¨CountDownLatch.countDownï¼Œè®©æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¼€å§‹è¯»ã€‚<br>é‚£ä¹ˆæ˜¯å“ªæ¡çº¿ç¨‹åœ¨ç­‰å¾…ï¼Ÿçº¿ç¨‹æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹ç­‰å¾…çš„ï¼Ÿ<br>åœ¨Http11InputBuffer.fillæ–¹æ³•ä¸­</p><pre><code class="java">nRead = socketWrapper.read(block, byteBuffer); // æ­¤æ—¶è¿è¡Œåœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œçº¿ç¨‹//è¿™ä¸ªæ–¹æ³•è°ƒç”¨åˆ°äº†NioBlockingSelector.readæ–¹æ³• while (!timedout) {        if (keycount &gt; 0) { //only read if we were registered for a read            read = socket.read(buf);            if (read != 0) {                break; //å¦‚æœè¯»å–åˆ°äº†ä¸€äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä¸èµ°ä¸‹é¢é‚£ä¸€å¥—            }        }        try {            if (att.getReadLatch()==null || att.getReadLatch().getCount()==0) {            att.startReadLatch(1); //åˆ›å»ºä¸€ä¸ªCountDownLatch(1)            }            poller.add(att,SelectionKey.OP_READ, reference); //æ³¨å†Œä¸€ä¸‹æ„Ÿå…´è¶£çš„äº‹ä»¶            att.awaitReadLatch(AbstractEndpoint.toTimeout(readTimeout), TimeUnit.MILLISECONDS);             //åœ¨è¿™é‡Œå¼€å§‹ç­‰å¾…        } catch (InterruptedException ignore) {            // Ignore        }}//è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Œä½œä¸ºä¸€ä¸ªè¯»æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰è¯»å–åˆ°ä¸œè¥¿ï¼Œæ˜¯ä¸æ˜¯å°±éœ€è¦å†™ä¸€ä¸ªwhileå¾ªç¯ï¼Œè¿™ä¼šæµªè´¹å¾ˆå¤šcpu cycleï¼Œè¿˜ä¸å¦‚æ³¨å†Œä¸€ä¸‹äº‹ä»¶ï¼ŒæŠŠè½®è¯¢çš„ä»»åŠ¡äº¤ç»™osã€‚</code></pre><p>æ‰€ä»¥ç­‰å¾…çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªCountDownLatch(1)ï¼Œç­‰åœ¨é‚£é‡Œã€‚äºæ­¤åŒæ—¶BlockPollerçº¿ç¨‹ä¸€ç›´åœ¨è·‘ï¼Œå‘ç°æ–°çš„Readäº‹ä»¶ï¼Œä»attachMent(SocketWrapperä¸­è·å–è¿™ä¸ªCountDownLatchï¼ŒcountDownä¸€ä¸‹ï¼Œè¿™é‡Œå°±èƒ½å¤Ÿæ¢å¤ç»§ç»­æ‰§è¡Œ)</p><p>ä»ç³»ç»Ÿçš„ready keysä¸­è·å–äº‹ä»¶:<br>processKey -&gt; AbstractEndPoint.processSocket -&gt; Executor.execute(SocketProcessorBase)(åœ¨è¿™é‡Œå¼€å§‹åˆ†å‘åˆ°å·¥ä½œçº¿ç¨‹æ± ) -&gt; NioEndPoint.SocketProcessor.doRun -&gt; AbstractProtocol.ConnectionHandler.process -&gt; Processor.process -&gt; AbstractProcessorLight.process -&gt; Http11Processor.service(SocketWrapperBase&lt;?&gt; socketWrapper) -&gt; Http11InputBuffer.parseRequestLine(è¿™é‡Œå°±å¼€å§‹è¯»å–Http1.1è¯·æ±‚ï¼Œæ¯”è¾ƒå¤æ‚)</p><p>èµ°åˆ°Http11InputBufferè¯´æ˜ä¸€å®šæ˜¯http1.1çš„è¯·æ±‚æ ¼å¼äº†(ä½†è¿™æœ‰å¯èƒ½æ˜¯webSocketæˆ–è€…http2çš„upgradeè¯·æ±‚)ï¼Œåœ¨å“ªé‡Œåˆ¤æ–­æ˜¯äº¤ç»™http1.1è¿˜æ˜¯http2.0è¿˜æ˜¯ajpåè®®ï¼Ÿåœ¨AbstractProcessorLight.processä¸­åˆ¤æ–­äº†å¦‚æœsocket.status == SocketEvent.OPEN_READ(å°±æ˜¯è¯´è¿™æ˜¯ä¸€ä¸ªè¿æ¥ä¸Šçš„ï¼Œåˆšåˆšå‡†å¤‡å¥½å¯ä»¥è¯»çš„è¿æ¥ï¼Œæ‰€ä»¥é»˜è®¤ç›´æ¥äº¤ç»™http1.1å»å¤„ç†äº†ï¼Œå°±ç®—æ˜¯http2åé¢è¿˜æ˜¯å¯ä»¥upgradeçš„)</p><p>ä¸Šé¢æåˆ°NioSocketWrapperæ˜¯ä¸€ä¸ªattachMentï¼Œè¿™ä¸ªç±»çš„å®ä¾‹çš„åˆ›å»ºæ˜¯åœ¨Acceptorä¸­å‘ç”Ÿçš„ã€‚<br>åœ¨NioEndPoint.javaçš„startInternalæ–¹æ³•ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µ</p><pre><code class="java"> // Start poller threadpoller = new Poller(); //è¿™ä¸ªPollerå’Œä¸Šé¢çš„BlockingPollerä¸ä¸€æ ·Thread pollerThread = new Thread(poller, getName() + &quot;-ClientPoller&quot;);pollerThread.setPriority(threadPriority);pollerThread.setDaemon(true);pollerThread.start();startAcceptorThread();protected void startAcceptorThread() {    acceptor = new Acceptor&lt;&gt;(this);     String threadName = getName() + &quot;-Acceptor&quot;;    acceptor.setThreadName(threadName);    Thread t = new Thread(acceptor, threadName);    t.setPriority(getAcceptorThreadPriority());    t.setDaemon(getDaemon());    t.start();}</code></pre><p>æ‰€ä»¥è‡³å°‘åˆæ‹‰èµ·äº†ä¸¤æ¡çº¿ç¨‹ã€‚å…ˆæ¥çœ‹Acceptorè¿™ä¸ªçº¿ç¨‹,åœ¨runä¸­åšçš„äº‹æƒ…ï¼š</p><pre><code class="java">socket = endpoint.serverSocketAccept();endpoint.setSocketOptions() //NioEndpoint.setSocketOptionsNioSocketWrapper socketWrapper = new NioSocketWrapper(channel, this);channel.setSocketWrapper(socketWrapper);socketWrapper.setReadTimeout(getConnectionTimeout());socketWrapper.setWriteTimeout(getConnectionTimeout());socketWrapper.setKeepAliveLeft(NioEndpoint.this.getMaxKeepAliveRequests());socketWrapper.setSecure(isSSLEnabled());poller.register(channel, socketWrapper); //è¿™é‡Œé¢è®¾å®šäº†NioSockertWrapperçš„interestOpsä¸ºSelectionKey.OP_READ//NioEndpoint.Poller.registerPollerEvent r = null;r = new PollerEvent(socket, OP_REGISTER); // PollerEventå®ç°äº†runnableï¼Œåœ¨runé‡Œé¢addEvent(r); //å¾€ä¸€ä¸ªSynchronizedQueueé‡Œé¢offeräº‹ä»¶</code></pre><p>æ€»ç»“ä¸€ä¸‹ï¼ŒAcceptorè¿™æ¡çº¿ç¨‹å°±æ˜¯ä¸æ–­åœ°æ¥å—æ–°çš„Socketï¼Œå¹¶åˆ›å»ºNioSockertWrapperå¯¹è±¡ï¼Œæ³¨å†ŒNioSockertWrapperçš„interestOpsä¸ºSelectionKey.OP_REGISTERï¼ˆä½†è¿™é‡Œè¿˜æ²¡æœ‰è°ƒç”¨ç³»ç»Ÿapiå»æ³¨å†Œï¼Œæ³¨æ„è¿™é‡Œæ˜¯OP_REGISTERï¼‰</p><p>å†æ¥çœ‹ClientPollerè¿™æ¡çº¿ç¨‹:<br>ClientPolleræ˜¯å…ˆäºAcceptorçº¿ç¨‹è·‘èµ·æ¥çš„ï¼Œçœ‹ä¸€ä¸‹runæ–¹æ³•çš„å®ç°<br>NioEndPoint.Poller.run</p><pre><code class="java"> public void run() {   while (true) {    hasEvents = events();     int keyCount = selector.select(selectorTimeout);     while (iterator != null &amp;&amp; iterator.hasNext()) {                    SelectionKey sk = iterator.next();                    NioSocketWrapper socketWrapper = (NioSocketWrapper) sk.attachment();                    // Attachment may be null if another thread has called                    // cancelledKey()                    if (socketWrapper == null) {                        iterator.remove();                    } else {                        iterator.remove();                        processKey(sk, socketWrapper); //è¿™é‡Œæ˜¯å¤„ç†å…·ä½“çš„äº‹ä»¶çš„ï¼Œä¼šå°†ä¸šåŠ¡é€»è¾‘åˆ†å‘ç»™çº¿ç¨‹æ±                     }                }    // Process timeouts    timeout(keyCount,hasEvents);   } }   //ä»SynchronizedQueueé‡Œé¢å–å‡ºPollEventï¼Œä¸€ä¸ªä¸ªæ‰§è¡Œpublic boolean events() {            boolean result = false;            PollerEvent pe = null;            for (int i = 0, size = events.size(); i &lt; size &amp;&amp; (pe = events.poll()) != null; i++ ) {                try {                    pe.run();                    pe.reset();                } catch ( Throwable x ) {                    log.error(sm.getString(&quot;endpoint.nio.pollerEventError&quot;), x);                }            }            return result;}//PollEventçš„runæ–¹æ³•é‡Œé¢å°±æœ‰è°ƒç”¨java nioç³»ç»Ÿapiäº†PollEvent.run```java @Overridepublic void run() {    if (interestOps == OP_REGISTER) {        try {            socket.getIOChannel().register(socket.getSocketWrapper().getPoller().getSelector(), SelectionKey.OP_READ, socket.getSocketWrapper()); //è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†nioçš„api        } catch (Exception x) {            log.error(sm.getString(&quot;endpoint.nio.registerFail&quot;), x);        }    }else {        // ã€‚ã€‚    }    }// å…·ä½“è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•æ˜¯:AbstractSelectableChannel.register(Selector sel, int ops,                                       Object att)    //ä¸‰ä¸ªå‚æ•°ï¼Œæœ€åä¸€ä¸ªæ˜¯attachMentï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢BlockPolleråœ¨runæ–¹æ³•ä¸­æå–å‡ºæ¥çš„attachment//å›åˆ°timeoutæ–¹æ³•é‡Œï¼Œæ³¨é‡Šè¯´è¯¥æ–¹æ³•åœ¨Pollerçš„æ¯ä¸€ä¸ªloopä¸­éƒ½ä¼šè¢«è°ƒç”¨ã€‚protected void timeout(int keyCount, boolean hasEvents) {        long now = System.currentTimeMillis();    // This method is called on every loop of the Poller. Don&#39;t process    // timeouts on every loop of the Poller since that would create too    // much load and timeouts can afford to wait a few seconds.    // However, do process timeouts if any of the following are true:    // - the selector simply timed out (suggests there isn&#39;t much load)    // - the nextExpiration time has passed    // - the server socket is being closed    //è¿™é‡Œé¢ä¸»è¦çš„åˆ¤æ–­æ˜¯å¦æ˜¯è¯»è¶…æ—¶æˆ–è€…å†™è¶…æ—¶äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒCancelKey}</code></pre><p>ClientPollerçº¿ç¨‹å°±æ˜¯è´Ÿè´£æ‰§è¡ŒSelectoré‚£ä¸€å¥—ï¼Œå‡ºç°äº‹ä»¶ä¹‹åå°±åˆ†å‘ç»™å·¥ä½œçº¿ç¨‹ï¼ˆSocketProcessorï¼‰ï¼Œå·¥ä½œçº¿ç¨‹çš„åå­—æ˜¯è¿™ä¹ˆèµ·çš„:</p><blockquote><p>TaskThreadFactory tf = new TaskThreadFactory(getName() + â€œ-exec-â€œ, daemon, getThreadPriority());</p></blockquote><p>æ‰€ä»¥åœ¨æ–­ç‚¹é‡Œé¢èƒ½å¤Ÿçœ‹åˆ°http-nio-8080-exec-1 ,http-nio-8080-exec-2â€¦è¿™ä¸ªçº¿ç¨‹æ± å°±æ˜¯ä¸»è¦çš„å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çº¿ç¨‹ã€‚</p><h2 id="tomcatç±»åŠ è½½å™¨-é‡ç‚¹"><a href="#tomcatç±»åŠ è½½å™¨-é‡ç‚¹" class="headerlink" title="tomcatç±»åŠ è½½å™¨(é‡ç‚¹)"></a>tomcatç±»åŠ è½½å™¨(é‡ç‚¹)</h2><p>é¦–å…ˆï¼ŒTomcatçš„ç±»åŠ è½½æœºåˆ¶æ˜¯è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ï¼ˆwebappClassLoaderåŠ è½½è‡ªå·±çš„ç›®å½•ä¸‹çš„classæ–‡ä»¶ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚ï¼‰</p><p>Tomcaté‡Œé¢ä¸»è¦çš„classLoaderåŒ…æ‹¬ï¼š<br>CommonClassLoader  /common/<em> ä¸‹é¢çš„class<br>CatalinaClassLoader   /server/</em> ä¸‹é¢çš„classå½’å®ƒ<br>SharedClassLoader  /shared/<em> ä¸‹é¢çš„å½’å®ƒ<br>WebappClassLoader  /WebApp/WEB-INF/</em> ä¸‹é¢çš„å½’å®ƒ æ¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºå¯¹åº”ä¸€ä¸ªWebAppç±»åŠ è½½å™¨ï¼Œæ¯ä¸€ä¸ªjspæ–‡ä»¶å¯¹åº”ä¸€ä¸ªjspç±»åŠ è½½å™¨ã€‚</p><p>åœ¨org.apache.catalina.startup.BootStrap.javaä¸­ï¼Œæœ‰åˆå§‹åŒ–classLoaderçš„æ–¹æ³•</p><pre><code class="java">initClassLoaders();Thread.currentThread().setContextClassLoader(catalinaLoader);SecurityClassLoad.securityClassLoad(catalinaLoader);</code></pre><p>å½“ä¸€ä¸ªåº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šä¸ºå…¶åˆ›å»ºå¯¹åº”çš„WebappClassLoader<br>StandardContext.startInternal</p><pre><code class="java">if (getLoader() == null) {        WebappLoader webappLoader = new WebappLoader(getParentClassLoader());        webappLoader.setDelegate(getDelegate());         setLoader(webappLoader);    }</code></pre><p>classLoaderæœ€ç»ˆæ˜¯ç”¨æ¥loadClassçš„ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨WebAppClassLoaderBase.loadClassæ–¹æ³•ä¸­ã€‚ä½¿ç”¨äº†ä¸€ä¸ª</p><blockquote><p>clazz = Class.forName(name, false, parent); // class.forNameè¿˜æœ‰ä¸€ä¸ªä¸‰ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚ã€‚ã€‚ã€‚</p></blockquote><p>tbd</p><h2 id="tomcatæ”¯æŒå¼€å¯sendFile"><a href="#tomcatæ”¯æŒå¼€å¯sendFile" class="headerlink" title="tomcatæ”¯æŒå¼€å¯sendFile"></a>tomcatæ”¯æŒå¼€å¯sendFile</h2><p><a href="https://httpd.apache.org/docs/2.4/mod/core.html#enablesendfile">apacheæ”¯æŒzero-copy</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/Dwade_mia/column/info/18882">tomcatæºç è§£æ</a><br><a href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html">tomcatå®˜æ–¹æ–‡æ¡£å…³äºclassloaderçš„è§£é‡Š </a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://github.com/apache/tomcat&quot;&gt;Tomcat&lt;/a&gt;æºç è§£æ&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/LetchworthSP_EN-AU14482052774_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
      <category term="tbd" scheme="https://haldir65.github.io/tags/tbd/"/>
    
  </entry>
  
  <entry>
    <title>Pythonä¸­çš„é›†åˆç±»</title>
    <link href="https://haldir65.github.io/2019/07/26/2019-07-26-python-collections/"/>
    <id>https://haldir65.github.io/2019/07/26/2019-07-26-python-collections/</id>
    <published>2019-07-26T22:21:38.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½æœ‰æˆç†Ÿçš„é›†åˆç±»ï¼Œæ¯”å¦‚Javaæœ‰å¾ˆä¼˜ç§€çš„é›†åˆï¼ˆè‡ªåŠ¨æ‰©å®¹ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œå¹¶å‘é›†åˆç±»ï¼‰ï¼ŒPythonä¹Ÿä¸ä¾‹å¤–ã€‚<br><img src="https://api1.foster66.xyz/static/imgs/WorldWaterDay_EN-AU11747740536_1920x1080.jpg" alt=""><br><a id="more"></a></p><h2 id="1-namedtuple"><a href="#1-namedtuple" class="headerlink" title="1. namedtuple()"></a>1. namedtuple()</h2><pre><code class="python">plain_tuple = (10,11,12,13)plain_tuple[0]##10plain_tuple[3]##13</code></pre><p>æ™®é€šçš„tupleåªèƒ½æ ¹æ®ä¸‹æ ‡æ¥è·å–å…ƒç´ <br>namedtupleä½¿å¾—å¤–éƒ¨èƒ½å¤Ÿä»¥è‡ªå®šä¹‰çš„keyè·å–value</p><pre><code class="python">from collections import namedtuplefruit = namedtuple(&#39;fruit&#39;,&#39;number variety color&#39;)guava = fruit(number=2,variety=&#39;HoneyCrisp&#39;,color=&#39;green&#39;)apple = fruit(number=5,variety=&#39;Granny Smith&#39;,color=&#39;red&#39;)##guava.color##&#39;green&#39;##apple.variety##&#39;Granny Smith&#39;</code></pre><h2 id="2-Counter"><a href="#2-Counter" class="headerlink" title="2. Counter"></a>2. Counter</h2><p>Counteræ˜¯dictçš„å­ç±»</p><pre><code class="python">from collections import Counterc = Counter(&#39;abcacdabcacd&#39;)print(c)## Counter({&#39;a&#39;: 4, &#39;c&#39;: 4, &#39;b&#39;: 2, &#39;d&#39;: 2}) å…¶å®å°±æ˜¯è®¡ç®—æ¯ä¸€ä¸ªå­—æ¯å‡ºç°äº†å‡ æ¬¡lst = [5,6,7,1,3,9,9,1,2,5,5,7,7]c = Counter(lst)print(c)## Counter({5: 3, 7: 3, 1: 2, 9: 2, 6: 1, 3: 1, 2: 1})s = &#39;the lazy dog jumped over another lazy dog&#39;words = s.split()print(Counter(words).most_common(3))##[(&#39;lazy&#39;, 2), (&#39;dog&#39;, 2), (&#39;the&#39;, 1)] most_commonæ˜¯counterçš„ä¸€ä¸ªæ–¹æ³•ï¼Œç»™å‡ºå‰nä¸ªå‡ºç°æ¬¡æ•°æœ€å¤šçš„</code></pre><h2 id="3-defaultdict"><a href="#3-defaultdict" class="headerlink" title="3. defaultdict"></a>3. defaultdict</h2><pre><code class="python">d = {}print(d[&#39;A&#39;]) ##   print(d[&#39;A&#39;]) KeyError: &#39;A&#39;   from collections import defaultdicts = [(&#39;yellow&#39;, 1), (&#39;blue&#39;, 2), (&#39;yellow&#39;, 3), (&#39;blue&#39;, 4), (&#39;red&#39;, 1)]d = defaultdict(list) ## å°†ä¸€ä¸ªlistè½¬æˆdictçš„æ–¹å¼for k, v in s:    d[k].append(v)sorted(d.items())</code></pre><h2 id="4-OrderedDict"><a href="#4-OrderedDict" class="headerlink" title="4.OrderedDict"></a>4.OrderedDict</h2><p>OrderedDictæ˜¯dictionaryçš„å­ç±»ï¼Œè¿­ä»£é¡ºåºä¸åˆå§‹inserté¡ºåºä¿æŒä¸€è‡´ã€‚å…³äºpythonçš„dictionaryï¼Œ2.xçš„æ—¶å€™æ˜¯æœ‰åºçš„ï¼Œ3.0-3.5çš„æ—¶å€™æ˜¯æ— åºçš„ï¼Œ3.6å¼€å§‹åˆå˜å¾—æœ‰åºäº†ã€‚<a href="https://www.youtube.com/watch?v=p33CVV29OG8">Modern Dictionaries by Raymond Hettinger</a></p><pre><code class="python">d = {&#39;banana&#39;: 3, &#39;apple&#39;: 4, &#39;pear&#39;: 1, &#39;orange&#39;: 2}for k,v in d.items():    print(&quot;key = {0}, value = {1}&quot;.format(k,v))##key = banana, value = 3# key = apple, value = 4# key = pear, value = 1# key = orange, value = 2    d = OrderedDict(sorted(d.items(), key=lambda t: t[0]))for k,v in d.items():    print(&quot;key = {0}, value = {1}&quot;.format(k,v))  # key = apple, value = 4# key = banana, value = 3# key = orange, value = 2# key = pear, value = 1</code></pre><p><a href="https://stackoverflow.com/questions/327311/how-are-pythons-built-in-dictionaries-implemented">python3.6å¼€å§‹dictionaryæ˜¯æœ‰åºçš„</a> ä»¥åŠå…¶å®ç°ç»†èŠ‚ï¼ˆä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼‰</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://towardsdatascience.com/pythons-collections-module-high-performance-container-data-types-cb4187afb5fc">python collections</a><br><a href="https://docs.python.org/zh-cn/3/library/collections.html">official docs for python builtin collections</a></p><p><a href="https://docs.python.org/zh-cn/3/library/collections.html">official docs</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½æœ‰æˆç†Ÿçš„é›†åˆç±»ï¼Œæ¯”å¦‚Javaæœ‰å¾ˆä¼˜ç§€çš„é›†åˆï¼ˆè‡ªåŠ¨æ‰©å®¹ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œå¹¶å‘é›†åˆç±»ï¼‰ï¼ŒPythonä¹Ÿä¸ä¾‹å¤–ã€‚&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/WorldWaterDay_EN-AU11747740536_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="python" scheme="https://haldir65.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>dockerå­¦ä¹ ç¬”è®°</title>
    <link href="https://haldir65.github.io/2019/07/21/2019-07-21-docker-cheatsheet/"/>
    <id>https://haldir65.github.io/2019/07/21/2019-07-21-docker-cheatsheet/</id>
    <published>2019-07-21T20:18:17.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>dockerç›¸å…³çš„çŸ¥è¯†ç‚¹<br><img src="https://api1.foster66.xyz/static/imgs/ship_docking_along_side_bay.jpg" alt=""><br><a id="more"></a></p><blockquote><p>sudo apt install docker-compose</p></blockquote><p>é¦–å…ˆçš„é¦–å…ˆï¼Œdockerå‘½ä»¤ç”¨sudoæƒé™è¿è¡Œï¼Œä¼šå°‘å¾ˆå¤šéº»çƒ¦<br>docker image æ˜¯snapshot, è€Œcontaineræ˜¯docker imageçš„è¿è¡Œå®ä¾‹</p><p>youtube ä¸Šæœ‰äººåœ¨ Digital Ocean çš„ vps ä¸Šå®‰è£… dockerï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå¤æ‚çš„æ“ä½œç³»ç»Ÿæ‰“åŒ…æˆä¸€ä¸ªä¸‹è½½å³ç”¨çš„å®¹å™¨ã€‚è¿›å…¥å®¹å™¨ä¸­ï¼Œå¯ä»¥åƒåœ¨å®é™…çš„æ“ä½œç³»ç»Ÿä¸­ä¸€æ ·è¿è¡ŒæŒ‡ä»¤ã€‚æ‰€ä»¥è™šæ‹ŸåŒ–çš„æœºå™¨éšæ—¶å¯ä»¥ä½¿ç”¨å…¶ä»–æ“ä½œç³»ç»Ÿã€‚<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04">how-to-install-and-use-docker-on-ubuntu-16-04</a></p><p>dockerå¸¸ç”¨çš„å‘½ä»¤æœ‰é‚£ä¹ˆå‡ æ¡</p><blockquote><p>docker run hello-world<br>docker search ubuntu<br>docker pull ubuntu<br>docker run ubuntu ## è¿›å…¥ubuntuè¿™ä¸ªcontainer<br>docker images<br>docker run -it ubuntu<br>exit</p></blockquote><h2 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h2><p>ä½¿ç”¨docker-compose.ymlçš„æ–¹å¼è¦æ¯”è¾“å…¥dockerå‘½ä»¤æ¥çš„ç®€å•çš„å¤šã€‚å°±æ˜¯å°†å‚æ•°å†™å…¥docker-compose.ymlè¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åè¿è¡Œdocker-compose up -då‘½ä»¤çš„æ–¹å¼ã€‚</p><p>docker run -p 3000:3000 -ti dummy-app ## æ¯æ¬¡éƒ½éœ€è¦è¾“å…¥ä¸€å¤§æ®µå‘½ä»¤è¡Œå‚æ•°å¾ˆçƒ¦äººçš„ï¼Œæ‰€ä»¥æŠŠé…ç½®å†™åœ¨ä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶é‡Œé¢ï¼Œæ¯æ¬¡åªéœ€è¦docker-compose upå°±å¯ä»¥äº†ã€‚</p><h2 id="è¿™ä¸¤æ¡å‘½ä»¤ç”¨äºè‡ªå·±åœ¨æœ¬åœ°æ‰“ä¸€ä¸ªdocker-image"><a href="#è¿™ä¸¤æ¡å‘½ä»¤ç”¨äºè‡ªå·±åœ¨æœ¬åœ°æ‰“ä¸€ä¸ªdocker-image" class="headerlink" title="è¿™ä¸¤æ¡å‘½ä»¤ç”¨äºè‡ªå·±åœ¨æœ¬åœ°æ‰“ä¸€ä¸ªdocker image"></a>è¿™ä¸¤æ¡å‘½ä»¤ç”¨äºè‡ªå·±åœ¨æœ¬åœ°æ‰“ä¸€ä¸ªdocker image</h2><p>docker build -t <your username>/node-web-app .<br>docker build -t packsdkandroiddocker.image -f ./scripts/PackSdkDockerfile .</p><h2 id="æ³¨æ„ä½ ä¿®æ”¹äº†Dockerfileä¹‹åè¦é‡æ–°è·‘ä¸€édocker-build-t-node-web-app"><a href="#æ³¨æ„ä½ ä¿®æ”¹äº†Dockerfileä¹‹åè¦é‡æ–°è·‘ä¸€édocker-build-t-node-web-app" class="headerlink" title="æ³¨æ„ä½ ä¿®æ”¹äº†Dockerfileä¹‹åè¦é‡æ–°è·‘ä¸€édocker build -t /node-web-app ."></a>æ³¨æ„ä½ ä¿®æ”¹äº†Dockerfileä¹‹åè¦é‡æ–°è·‘ä¸€édocker build -t <your username>/node-web-app .</h2><p><a href="https://stackoverflow.com/questions/18804124/docker-updating-image-along-when-dockerfile-changes">æ¯æ¬¡ä¿®æ”¹ä¹‹åé‡æ–°æ‰“image</a></p><p>dockerä¼šåœ¨/var/lib/dockeræ–‡ä»¶å¤¹é‡Œåƒæ‰å¤§é‡ç©ºé—´ï¼Œé‡Šæ”¾ç©ºé—´çš„è¯</p><blockquote><p>docker system prune -a</p></blockquote><p><a href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/">ç”¨docker hostä¸€ä¸ªnode js app</a>ã€‚å®æµ‹ä¸‹æ¥imageå¤§å°åœ¨600MBå·¦å³ï¼Œå†…å­˜å ç”¨200MBå·¦å³ã€‚</p><p><a href="https://medium.com/@kahana.hagai/docker-compose-with-node-js-and-mongodb-dbdadab5ce0a">ç”¨dockerè¿è¡Œä¸€ä¸ªnode mongodbåº”ç”¨</a> äº²æµ‹æœ‰æ•ˆ<br><a href="https://hub.docker.com/r/mhart/alpine-node/">nodeçš„å®˜æ–¹imageå¤ªå¤§äº†ï¼Œalpine-nodeå ç”¨çš„ç£ç›˜ç©ºé—´æ›´å°</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://linuxconfig.org/how-to-launch-containers-with-docker-compose">how-to-launch-containers-with-docker-compose</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dockerç›¸å…³çš„çŸ¥è¯†ç‚¹&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/ship_docking_along_side_bay.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="tools" scheme="https://haldir65.github.io/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>openjdkæºç è§£æ[ä¸€]</title>
    <link href="https://haldir65.github.io/2019/07/13/2019-07-13-openjdk-codegrep_01/"/>
    <id>https://haldir65.github.io/2019/07/13/2019-07-13-openjdk-codegrep_01/</id>
    <published>2019-07-13T21:06:23.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/windows/native/java/net/SocketOutputStream.c">openjdk</a>éƒ¨åˆ†æºç è§£æ(æ–‡ä»¶IO),javaå±‚ä»¥åŠcè¯­è¨€å±‚çš„åˆ†æ<br><img src="https://api1.foster66.xyz/static/imgs/BlueShark_EN-AU12265881842_1920x1080.jpg" alt=""></p><a id="more"></a><h2 id="File-IO"><a href="#File-IO" class="headerlink" title="File IO"></a>File IO</h2><p>IOUtils<br>FileChannel</p><h2 id="å›é¡¾ä¸€ä¸‹Cè¯­è¨€æä¾›çš„æ“ä½œæ–‡ä»¶çš„api"><a href="#å›é¡¾ä¸€ä¸‹Cè¯­è¨€æä¾›çš„æ“ä½œæ–‡ä»¶çš„api" class="headerlink" title="å›é¡¾ä¸€ä¸‹Cè¯­è¨€æä¾›çš„æ“ä½œæ–‡ä»¶çš„api"></a>å›é¡¾ä¸€ä¸‹Cè¯­è¨€æä¾›çš„æ“ä½œæ–‡ä»¶çš„api</h2><p>1 .è¯»å†™(åˆ›å»º)æ–‡ä»¶</p><pre><code class="c">#include &lt;stdio.h&gt; FILE *fopen( const char * filename, const char * mode ); //å®šä¹‰åœ¨æ ‡å‡†ä¸­çš„ï¼Œæ‰€ä»¥æ˜¯è·¨å¹³å°çš„int fclose( FILE *fp ); //å…³é—­æ–‡ä»¶</code></pre><table><thead><tr><th>æ¨¡å¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>r</td><td>æ‰“å¼€ä¸€ä¸ªå·²æœ‰çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å–æ–‡ä»¶ã€‚</td></tr><tr><td>w</td><td>æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨çš„ç¨‹åºä¼šä»æ–‡ä»¶çš„å¼€å¤´å†™å…¥å†…å®¹ã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯¥ä¼šè¢«æˆªæ–­ä¸ºé›¶é•¿åº¦ï¼Œé‡æ–°å†™å…¥ã€‚</td></tr><tr><td>a</td><td>æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä»¥è¿½åŠ æ¨¡å¼å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨çš„ç¨‹åºä¼šåœ¨å·²æœ‰çš„æ–‡ä»¶å†…å®¹ä¸­è¿½åŠ å†…å®¹ã€‚</td></tr><tr><td>r+</td><td>æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚</td></tr><tr><td>w+</td><td>æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ–‡ä»¶ä¼šè¢«æˆªæ–­ä¸ºé›¶é•¿åº¦ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚</td></tr><tr><td>a+</td><td>æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚è¯»å–ä¼šä»æ–‡ä»¶çš„å¼€å¤´å¼€å§‹ï¼Œå†™å…¥åˆ™åªèƒ½æ˜¯è¿½åŠ æ¨¡å¼ã€‚</td></tr></tbody></table><pre><code class="c">int fputs( const char *s, FILE *fp ); //å°†å­—ç¬¦ä¸²så†™å…¥æ–‡ä»¶ä¸­char *fgets( char *buf, int n, FILE *fp ); //ä»fpæŒ‡å‘çš„è¾“å…¥æµä¸­è¯»å–n-1ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”è‡ªåŠ¨è¿½åŠ ä¸€ä¸ª null å­—ç¬¦æ¥ç»ˆæ­¢å­—ç¬¦ä¸²</code></pre><p>å›åˆ°javaè¿™ä¸€ç«¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶File file = new File(â€œc:\somefile.txtâ€) åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªjava objectã€‚<br>Fileçš„ä¸€äº›æ–¹æ³•ä»£ç†ç»™äº†FileSystemè¿™ä¸ªæŠ½è±¡ç±»ï¼Œåœ¨unixå¹³å°ä¸Šçš„å®ç°æ˜¯UnixFileSystem.javaã€‚</p><p>ä¾‹å¦‚File.existsæ–¹æ³•ï¼Œæœ€ç»ˆè¿›å…¥FileSystem.getBooleanAttributes0ã€‚è¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•,å¯¹åº”çš„å®ç°åœ¨<a href="https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/solaris/native/java/io/UnixFileSystem_md.c">UnixFileSystem_md.c</a>ä¸­</p><pre><code class="c">static jbooleanstatMode(const char *path, int *mode){    struct stat64 sb;    if (stat64(path, &amp;sb) == 0) {        *mode = sb.st_mode;        return JNI_TRUE;    }    return JNI_FALSE;}JNIEXPORT jint JNICALLJava_java_io_UnixFileSystem_getBooleanAttributes0(JNIEnv *env, jobject this,                                                  jobject file){    jint rv = 0;    WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {        int mode;        if (statMode(path, &amp;mode)) {            int fmt = mode &amp; S_IFMT;            rv = (jint) (java_io_FileSystem_BA_EXISTS                  | ((fmt == S_IFREG) ? java_io_FileSystem_BA_REGULAR : 0)                  | ((fmt == S_IFDIR) ? java_io_FileSystem_BA_DIRECTORY : 0));        }    } END_PLATFORM_STRING(env, path);    return rv;}// S_IFMTæ˜¯ä¸€ä¸ªæ©ç ï¼Œ S_IFREGè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œ S_IFDIRè¡¨ç¤ºæ˜¯ä¸€ä¸ªç›®å½•ã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ªintï¼ˆå…¶ä¸­4ä½è¢«åˆ†åˆ«ç”¨äºå­˜å‚¨BA_HIDDENï¼ŒBA_DIRECTORYï¼ŒBA_REGULARï¼ŒBA_EXISTSï¼‰ï¼Œè¶³ä»¥è¡¨è¾¾æ–‡ä»¶çš„è¿™å‡ ç§å¸¸ç”¨å±æ€§ã€‚javaå±‚è·å–å¯¹åº”çš„å±æ€§åï¼Œè¿›è¡Œä½è¿ç®—å°±èƒ½çŸ¥é“è¿™ä¸ªæ–‡ä»¶çš„å±æ€§äº†ã€‚</code></pre><p>æ–‡ä»¶è¯»å†™ä»¥åŠFileDescriptor<br>æ–‡ä»¶æè¿°ç¬¦åœ¨unixç³»ç»Ÿä¸Šæ˜¯éè´Ÿçš„intï¼Œç”¨äºä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ã€‚javaå±‚çš„FileDescriptorä¸­åŒ…è£¹äº†ä¸€ä¸ªint fdã€‚<br>è¯»å†™æ–‡ä»¶éƒ½éœ€è¦é€šè¿‡FileInputStreamè¿›è¡Œï¼Œæ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ªopenæ–¹æ³•ï¼Œå¯¹åº”cè¯­è¨€çš„æ–¹æ³•åœ¨<br><a href="https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/native/java/io/FileInputStream.c">FileInputStream.c</a>ä¸­</p><pre><code class="c">JNIEXPORT void JNICALLJava_java_io_FileInputStream_open(JNIEnv *env, jobject this, jstring path) {    fileOpen(env, this, path, fis_fd, O_RDONLY);}</code></pre><p>fileOpençš„å®ç°åœ¨<a href="https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/solaris/native/java/io/io_util_md.c">io_util_md.c</a>ä¸­</p><pre><code class="c">voidfileOpen(JNIEnv *env, jobject this, jstring path, jfieldID fid, int flags){    WITH_PLATFORM_STRING(env, path, ps) {        FD fd;#if defined(__linux__) || defined(_ALLBSD_SOURCE)        /* Remove trailing slashes, since the kernel won&#39;t */        char *p = (char *)ps + strlen(ps) - 1;        while ((p &gt; ps) &amp;&amp; (*p == &#39;/&#39;))            *p-- = &#39;\0&#39;;#endif        fd = JVM_Open(ps, flags, 0666);         if (fd &gt;= 0) {            SET_FD(this, fd, fid);        } else {            throwFileNotFoundException(env, path);        }    } END_PLATFORM_STRING(env, ps);}</code></pre><p>JVM_OPENæ˜¯jvmçš„æ–¹æ³•ï¼Œä¸å±äºjdkäº†ï¼Œè¦å»hotSpoté‡Œé¢æŸ¥çœ‹å¯¹åº”çš„å®ç°ï¼š<br>//  åœ¨/hotspot/src/share/vm/prims/jvm.cpp ï¼ˆcppæˆ‘ä¸ç†Ÿï¼Œæ®è¯´è¿™é‡Œé¢æœ€ç»ˆèµ°çš„æ˜¯ open64æ–¹æ³•ï¼‰</p><p><strong>è¿™é‡Œè¦æä¸€å¥ï¼Œjvmä¸æ­¢oracleä¸€å®¶</strong>ï¼Œè¿˜åŒ…æ‹¬OpenJDKï¼ŒSUN JVMï¼ŒIBM JVMï¼Œéƒ½æ˜¯å¯¹java specificationçš„implementationã€‚</p><h3 id="æ–‡ä»¶è¯»å†™"><a href="#æ–‡ä»¶è¯»å†™" class="headerlink" title="æ–‡ä»¶è¯»å†™"></a>æ–‡ä»¶è¯»å†™</h3><p>javaè¿™è¾¹è¯»å–æ–‡ä»¶ç”¨çš„æ˜¯FileInputStreamï¼Œä¸‹é¢æ–¹æ³•è¡¨ç¤ºè¯»å–ä¸€ä¸ªByte</p><pre><code class="java">private native int read0() throws IOException; </code></pre><p>å¯¹åº”openjdkçš„å®ç°åœ¨<a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/native/java/io/FileInputStream.c">FileInputStream.c</a>æ–‡ä»¶ä¸­</p><pre><code class="c">JNIEXPORT jint JNICALLJava_java_io_FileInputStream_read0(JNIEnv *env, jobject this) {    return readSingle(env, this, fis_fd);}</code></pre><p><a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/native/java/io/io_util.c">readSingleåœ¨io_util.cä¸­</a></p><pre><code class="c">jintreadSingle(JNIEnv *env, jobject this, jfieldID fid) {    jint nread;    char ret;    FD fd = GET_FD(this, fid);    if (fd == -1) {        JNU_ThrowIOException(env, &quot;Stream Closed&quot;);        return -1;    }    nread = IO_Read(fd, &amp;ret, 1);    if (nread == 0) { /* EOF */        return -1;    } else if (nread == -1) { /* error */        JNU_ThrowIOExceptionWithLastError(env, &quot;Read error&quot;);    }    return ret &amp; 0xFF;}// IO_ReadæŒ‡å‘io_util_md.cä¸­çš„handleReadæ–¹æ³•ssize_thandleRead(FD fd, void *buf, jint len){    ssize_t result;    RESTARTABLE(read(fd, buf, len), result);    return result;}</code></pre><blockquote><p>cè¯­è¨€çš„readæ–¹æ³•:</p><pre><code>å¤´æ–‡ä»¶ï¼š#include &lt;unistd.h&gt;å®šä¹‰å‡½æ•°ï¼šssize_t read(int fd, void * buf, size_t count);å‡½æ•°è¯´æ˜ï¼šread()ä¼šæŠŠå‚æ•°fd æ‰€æŒ‡çš„æ–‡ä»¶ä¼ é€count ä¸ªå­—èŠ‚åˆ°buf æŒ‡é’ˆæ‰€æŒ‡çš„å†…å­˜ä¸­. è‹¥å‚æ•°count ä¸º0, åˆ™read()ä¸ä¼šæœ‰ä½œç”¨å¹¶è¿”å›0. è¿”å›å€¼ä¸ºå®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°, å¦‚æœè¿”å›0, è¡¨ç¤ºå·²åˆ°è¾¾æ–‡ä»¶å°¾æˆ–æ˜¯æ— å¯è¯»å–çš„æ•°æ®,æ­¤å¤–æ–‡ä»¶è¯»å†™ä½ç½®ä¼šéšè¯»å–åˆ°çš„å­—èŠ‚ç§»åŠ¨.</code></pre></blockquote><p>cloneæ–¹æ³•è¦æ±‚è¿™ä¸ªclassæ˜¯implement cloneableæ¥å£çš„ï¼Œé¦–å…ˆå°±æ˜¯æ£€æŸ¥æ˜¯å¦å®ç°äº†cloneableæ¥å£ã€‚ï¼ˆæ•°ç»„è¢«è®¤ä¸ºæ˜¯å®ç°äº†è¯¥æ¥å£ï¼‰<br>Objectå¹¶æœªå®ç°cloneableæ¥å£ï¼ŒObject.cloneæ–¹æ³•æ˜¯ä¸€ä¸ªprotectedçš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå…³æ³¨è¿™ä¸ªæ–¹æ³•çš„java docï¼Œè¯´ç›´æ¥è°ƒç”¨object.cloneä¼šæŠ›å¼‚å¸¸ï¼Œä¸è¿‡ç›®å‰çœ‹æ¥ï¼Œå¤–éƒ¨ä¹Ÿæ²¡æœ‰åŠæ³•ç›´æ¥è°ƒç”¨åˆ°ä¸€ä¸ªobject.cloneæ–¹æ³•ã€‚<br><a href="https://stackoverflow.com/questions/12032292/is-it-possible-to-find-the-source-for-a-java-native-method">super.cloneæ–¹æ³•åœ¨openjdkä¸­çš„å®ç°</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://fansunion.blog.csdn.net/article/details/13252309">openjdkæ˜¯å¦‚ä½•è¯»å–.classæ–‡ä»¶çš„</a><br><a href="https://hunterzhao.io/">openjdkæºç åˆ†æ</a><br><a href="https://github.com/openjdk-mirror/jdk7u-hotspot">hotspotæºç </a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/windows/native/java/net/SocketOutputStream.c&quot;&gt;openjdk&lt;/a&gt;éƒ¨åˆ†æºç è§£æ(æ–‡ä»¶IO),javaå±‚ä»¥åŠcè¯­è¨€å±‚çš„åˆ†æ&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/BlueShark_EN-AU12265881842_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AbstractQueuedSynchronizeræºç åˆ†æ</title>
    <link href="https://haldir65.github.io/2019/07/05/2019-07-05-abstractQueuedSynchronizer/"/>
    <id>https://haldir65.github.io/2019/07/05/2019-07-05-abstractQueuedSynchronizer/</id>
    <published>2019-07-05T08:59:54.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äºjava.util.concurrent.locks.AbstractQueuedSynchronizer,è¿™ä¸ªç±»æ˜¯jucçš„åŸºç¡€ã€‚ReentrantLockä¸­ï¼ŒThreadPoolExecutorä¸­ï¼ŒCountDownLatchä¸­éƒ½æœ‰ç”¨åˆ°ã€‚<br><img src="https://api1.foster66.xyz/static/imgs/CapeBretonSunset_EN-AU10231293487_1920x1080.jpg" alt=""><br><a id="more"></a></p><p>å…ˆçœ‹java docä¸­æ˜¯æ€æ ·æè¿°çš„å§:<br><strong>Provides a framework for implementing blocking locks and related synchronizers (semaphores, events, etc) that rely on first-in-first-out (FIFO) wait queues. </strong></p><!--more--><p>é€šå¸¸ä½¿ç”¨ReentrantLockçš„æ—¶å€™ï¼Œéƒ½æ˜¯è¿™æ ·çš„</p><pre><code class="java">reentrantLock.lock();try {    // æ‰§è¡Œä»£ç ...} finally {// é‡Šæ”¾é”reentrantLock.unlock();}</code></pre><p>æ¥çœ‹çœ‹å†…éƒ¨å®ç°<br>ReentrantLock.lockæ–¹æ³•</p><pre><code class="java"> public void lock() {        sync.lock();}/**    * Sync object for non-fair locks     é»˜è®¤æ˜¯éå…¬å¹³çš„Syncï¼Œéå¸¸çŸ­ï¼Œä¸»è¦çš„é€»è¾‘éƒ½åœ¨çˆ¶ç±»AQSä¸­*/static final class NonfairSync extends Sync {    /**        * Performs lock.  Try immediate barge, backing up to normal        * acquire on failure.        */    final void lock() {        if (compareAndSetState(0, 1))            setExclusiveOwnerThread(Thread.currentThread());        else            acquire(1);    }    protected final boolean tryAcquire(int acquires) {        return nonfairTryAcquire(acquires);    }}static final class FairSync extends Sync {        final void lock() {            acquire(1);        }    public final void acquire(int arg) {        if (!tryAcquire(arg) &amp;&amp;            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))            selfInterrupt();    }}</code></pre><p><a href="https://javadoop.com/post/AbstractQueuedSynchronizer">acquireè¿™ä¸ªæ–¹æ³•ä¸»è¦åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œå†™çš„éå¸¸å¥½</a>ã€‚è¿™ç¯‡æ–‡ç« åˆ†æçš„æ˜¯FairSync,ä½†NonFairSyncçš„åŒºåˆ«å¹¶ä¸å¤§ï¼Œæ¯”æ–¹è¯´å…¬å¹³é”éµå®ˆå…ˆæ¥ååˆ°ï¼ˆæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šäº‰ç€å»æ’é˜Ÿåˆ°tailï¼‰ï¼Œéå…¬å¹³é”åˆ™æ˜¯ä¸Šæ¥å°±è¯•ç€ç”¨casæŠ¢é”(æŠ¢æˆåŠŸçš„è¯å°±setExclusiveOwner)ï¼Œä¸æˆåŠŸçš„è¯æ‰èµ°æ’é˜Ÿé‚£ä¸€å¥—</p><p>æŒ‚èµ·çº¿ç¨‹å’Œå”¤é†’çº¿ç¨‹ä½¿ç”¨çš„æ˜¯<br>LockSupport.park(this);<br>LockSupport.unpark(s.thread);<br>æ ¹æ®ç½‘ä¸Šçš„åˆ†æï¼Œåœ¨nativeå±‚ä½¿ç”¨çš„æ˜¯cppçš„pthread_mutexï¼Œä¸æ˜¯å¯ä»¥é‡å…¥çš„(ä¹Ÿå°±æ˜¯ä¸è¦ä¹±æ¥ï¼Œlockå’Œunlockä¸€å®šè¦é…å¯¹ä½¿ç”¨)</p><p>ä½¿ç”¨åˆ°äº†AbstractQueuedSynchronizerçš„ç±»åŒ…æ‹¬reentrantLockä¸­çš„Sync, ThreadPoolExecutorä¸­çš„workerï¼ŒCountDownLatchä¸­çš„Sync,Semaphore.Syncã€‚ä»¥ä¸‹åˆ†åˆ«å±•å¼€è¿™äº›ç±»çš„å™è¿°</p><h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>éå¸¸å¸¸è§çš„é”ï¼Œæ³¨æ„çš„æ˜¯ä¸€å®šè¦åœ¨finallyé‡Œé¢é‡Šæ”¾æ‰é”ã€‚å†…éƒ¨åŒ…å«ä¸€ä¸ªSyncé™æ€ç±»ã€‚<br>ä¸Šè¿°å·²ç»æåˆ°äº†ReentrantLockæ˜¯å¦‚ä½•é€šè¿‡Syncå®Œæˆlockä»¥åŠåç»­èŠ‚ç‚¹çš„å”¤é†’çš„</p><h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><p>ä¸»çº¿ç¨‹å¯åŠ¨å‡ æ¡çº¿ç¨‹åŒæ—¶èµ·è·‘ï¼Œå¸Œæœ›ä¸»çº¿ç¨‹ä¸è¦æ€¥ç€é€€å‡ºï¼Œç­‰å…¶ä»–çº¿ç¨‹è·‘å®Œï¼Œä¸»çº¿ç¨‹å†æ¢å¤è¿è¡Œï¼Œè¿™ç§åœºæ™¯ç”¨CountDownLatchå¯ä»¥ï¼Œç”¨CyclicBarrierå¯ä»¥ï¼Œç”¨Phaserä¹Ÿå¯ä»¥ã€‚å‚è€ƒ<a href="https://www.javadoop.com/post/phaser-tutorial">Phaser ä½¿ç”¨ä»‹ç»</a>ä¸­çš„ç¤ºä¾‹ä»£ç </p><p>ä½¿ç”¨CountDownLatchçš„è¯</p><pre><code class="java">// 1. è®¾ç½® count ä¸º 1CountDownLatch latch = new CountDownLatch(1);for (int i = 0; i &lt; 10; i++) {    new Thread(() -&gt; {        try {            // 2. æ¯ä¸ªçº¿ç¨‹éƒ½ç­‰åœ¨æ …æ è¿™é‡Œï¼Œç­‰å¾…æ”¾å¼€æ …æ ï¼Œä¸ä¼šå› ä¸ºæœ‰äº›çº¿ç¨‹å…ˆå¯åŠ¨å°±å…ˆè·‘è·¯äº†            latch.await();            // doWork();        } catch (InterruptedException ignore) {        }    }).start();}doSomethingELse(); // ç¡®ä¿åœ¨ä¸‹é¢çš„ä»£ç æ‰§è¡Œä¹‹å‰ï¼Œä¸Šé¢æ¯ä¸ªçº¿ç¨‹éƒ½åˆ°äº† await() ä¸Šã€‚// 3. æ”¾å¼€æ …æ latch.countDown();</code></pre><p>CountDownLatch.java</p><pre><code class="java">public void await() throws InterruptedException {    sync.acquireSharedInterruptibly(1);}public void countDown() {    sync.releaseShared(1);}</code></pre><p>awaitä¸­ä½¿å½“å‰çº¿ç¨‹åœä¸‹æ¥çš„æ–¹æ³•åœ¨doAcquireSharedInterruptiblyä¸­ï¼Œè€Œå”¤é†’çº¿ç¨‹çš„æ–¹æ³•åœ¨releaseSharedä¸­ã€‚CountDownLatchå› ä¸ºæœ‰ä¸€ä¸ªcountçš„æ¦‚å¿µï¼Œæ‰€ä»¥åœ¨è°ƒç”¨releaseSharedä¹‹å‰æ€»æ˜¯ä¼šåˆ¤æ–­å½“å‰countæ˜¯å¦å·²ç»åˆ°è¾¾äº†0ã€‚å› ä¸ºä¸€æ—¦åˆ°è¾¾äº†0ï¼Œé‚£ä¹ˆåœ¨ç­‰å¾…çš„çº¿ç¨‹(è°ƒç”¨äº†awaitçš„çº¿ç¨‹å°±å¯ä»¥æ¢å¤è¿è¡Œ)ã€‚</p><blockquote><p>CountDoownLatchçš„åŸç†ï¼š <strong>AQS å…±äº«æ¨¡å¼çš„å…¸å‹ä½¿ç”¨ï¼Œæ„é€ å‡½æ•°ä¸­çš„ 1 æ˜¯è®¾ç½®ç»™ AQS çš„ state çš„ã€‚latch.await() æ–¹æ³•ä¼šé˜»å¡ï¼Œè€Œ latch.countDown() æ–¹æ³•å°±æ˜¯ç”¨æ¥å°† stateâ€“ çš„ï¼Œå‡åˆ° 0 ä»¥åï¼Œå”¤é†’æ‰€æœ‰çš„é˜»å¡åœ¨ await() æ–¹æ³•ä¸Šçš„çº¿ç¨‹ã€‚</strong></p></blockquote><h3 id="CyclicBarrier-æ¥å®ç°è¿™ç§å‡ æ¡çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æ›´ç®€å•"><a href="#CyclicBarrier-æ¥å®ç°è¿™ç§å‡ æ¡çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æ›´ç®€å•" class="headerlink" title="CyclicBarrier æ¥å®ç°è¿™ç§å‡ æ¡çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æ›´ç®€å•"></a>CyclicBarrier æ¥å®ç°è¿™ç§å‡ æ¡çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æ›´ç®€å•</h3><pre><code class="java">// 1. æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº† 10 ä¸ª partiesCyclicBarrier barrier = new CyclicBarrier(10);for (int i = 0; i &lt; 10; i++) {    executorService.submit(() -&gt; {        try {            // 2. æ¯ä¸ªçº¿ç¨‹&quot;æŠ¥å‘Š&quot;è‡ªå·±åˆ°äº†ï¼Œ            //    å½“ç¬¬10ä¸ªçº¿ç¨‹åˆ°çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½åˆ°é½äº†ï¼Œä¸€èµ·é€šè¿‡            barrier.await();            // doWork()        } catch (InterruptedException | BrokenBarrierException ex) {            ex.printStackTrace();        }    });}</code></pre><h3 id="Phaserå…¶å®æ˜¯ç”¨åˆ°çš„æ¯”è¾ƒå°‘çš„"><a href="#Phaserå…¶å®æ˜¯ç”¨åˆ°çš„æ¯”è¾ƒå°‘çš„" class="headerlink" title="Phaserå…¶å®æ˜¯ç”¨åˆ°çš„æ¯”è¾ƒå°‘çš„"></a>Phaserå…¶å®æ˜¯ç”¨åˆ°çš„æ¯”è¾ƒå°‘çš„</h3><pre><code class="java">Phaser phaser = new Phaser();// 1. æ³¨å†Œä¸€ä¸ª partyphaser.register();for (int i = 0; i &lt; 10; i++) {    phaser.register();    executorService.submit(() -&gt; {        // 2. æ¯ä¸ªçº¿ç¨‹åˆ°è¿™é‡Œè¿›è¡Œé˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾æ …æ         phaser.arriveAndAwaitAdvance();        // doWork()    });}phaser.arriveAndAwaitAdvance();</code></pre><p>ä¸Šè¿°ä»£ç ä¸­phaser.registerè¢«è°ƒç”¨äº†11æ¬¡ï¼Œå°±åƒå¼€ä¼šä¸€æ ·ï¼Œæ‰€æœ‰äººéƒ½åˆ°é½äº†æ‰èƒ½å¼€å§‹</p><h2 id="ThreadPoolExecutor-Worker"><a href="#ThreadPoolExecutor-Worker" class="headerlink" title="ThreadPoolExecutor.Worker"></a>ThreadPoolExecutor.Worker</h2><h2 id="Semaphere"><a href="#Semaphere" class="headerlink" title="Semaphere"></a>Semaphere</h2><p>Semaphereçš„æ„é€ å‡½æ•°ä¸­å¯ä»¥ä¼ ä¸€ä¸ªintå‚æ•°,ç”¨äºæ ‡è¯†åŒæ—¶æœ€å¤šæœ‰å‡ æ¡çº¿ç¨‹å¯ä»¥è·å¾—permitï¼ˆä¹Ÿå°±æ˜¯åŒæ—¶æœ€å¤šæœ‰å‡ æ¡çº¿ç¨‹è¿›å…¥acquireå’Œreleaseä¹‹é—´çš„ä»£ç å—ä¸­ï¼‰</p><pre><code class="java">semaphere.acquire();// æ“ä½œæ•°æ®semaphere.release();</code></pre><p>å‡å¦‚æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†1ï¼Œé‚£ä¹ˆè¿™ä¸ªsemaphoreå®é™…ä¸Šæ˜¯ä¸€ä¸ªlockæˆ–è€…è¯´mutexï¼Œå¦‚æœå¤§äºä¸€ï¼Œé‚£ä¹ˆåŒæ—¶è¿›å…¥è¿™æ®µä»£ç å—é‡Œçš„çº¿ç¨‹å°±æœ‰å¤šä¸ªäº†ï¼Œå°±éœ€è¦å®ç°è‡ªå·±çš„åŒæ­¥é€»è¾‘ã€‚ï¼ˆrace conditionï¼Œå¾€å¾€è¦åŠ ä¸€æ®µsleepå°±èƒ½å¿«é€Ÿé‡ç°ï¼Œæ¯”å¦‚ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªint 0 è‡ªå¢ï¼Œé‚£ä¹ˆææœ‰å¯èƒ½å¾—åˆ°çš„ç»“æœæ˜¯1è€Œä¸æ˜¯é¢„æœŸçš„2ï¼Œå› ä¸ºå„è‡ªçœ‹åˆ°çš„éƒ½æ˜¯0ï¼‰</p><h2 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h2><p>Exchangeræ˜¯æˆåŒæˆå¯¹ä½¿ç”¨çš„ï¼Œæ”¯æŒæ³›å‹ï¼Œä¸¤æ¡çº¿ç¨‹åŒæ—¶å¼€è·‘ï¼Œå…ˆåˆ°çš„ä¼šç­‰ç€ï¼Œä¸¤ä¸ªéƒ½åˆ°äº†ä¹‹åï¼Œäº’ç›¸äº¤æ¢æ³›å‹çš„æ•°æ®</p><h2 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h2><p>jucé‡Œé¢æ²¡æœ‰cè¯­è¨€é‚£æ ·çš„mutexï¼Œä¸è¿‡Reentrantlockè¿™ç§å®é™…ä¸Šå°±å‘æŒ¥äº†mutexçš„ä½œç”¨ã€‚</p><h2 id="tbd"><a href="#tbd" class="headerlink" title="tbd"></a>tbd</h2><p>ä½¿ç”¨AQSçš„æ™®éæ–¹å¼æ˜¯è‡ªå·±ç»§æ‰¿å®ç°ä¸€ä¸ªSyncï¼ˆå†™ä¸€ä¸ªè¯•è¯•çœ‹ï¼ŸTomcaté‡Œé¢å°±æœ‰ï¼‰</p><p><a href="https://juejin.im/post/5dd4bc97f265da0bc53c7d41">ç®€æ˜æ¦‚æ‹¬</a></p><ol><li>AQSæœ‰ä¸ªä¸´ç•Œå˜é‡state,å½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°state==0æ—¶, è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹è¿›å…¥äº†ä¸´ç•Œä»£ç (è·å–åˆ°é”), å¹¶åŸå­åœ°æŠŠè¿™ä¸ªå˜é‡å€¼+1</li><li>æ²¡èƒ½è¿›å…¥ä¸´ç•ŒåŒº(è·å–é”å¤±è´¥)çš„çº¿ç¨‹, ä¼šåˆ©ç”¨CASçš„æ–¹å¼æ·»åŠ åˆ°åˆ°CLHé˜Ÿåˆ—å°¾å», å¹¶è¢«LockSupport.parkæŒ‚èµ·.</li><li>å½“çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™, ä¼šå”¤é†’headèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„çº¿ç¨‹(æœ‰äº›çº¿ç¨‹canceläº†å°±ä¸éœ€è¦å”¤é†’äº†)</li><li>è¢«å”¤é†’çš„çº¿ç¨‹æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„å‰ç½®èŠ‚ç‚¹æ˜¯ä¸æ˜¯headèŠ‚ç‚¹(CLHé˜Ÿåˆ—çš„headèŠ‚ç‚¹å°±æ˜¯ä¹‹å‰æ‹¿åˆ°é”çš„çº¿ç¨‹èŠ‚ç‚¹)çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹,<br>å¦‚æœä¸æ˜¯åˆ™ç»§ç»­æŒ‚èµ·, å¦‚æœæ˜¯çš„è¯, ä¸å…¶ä»–çº¿ç¨‹é‡æ–°äº‰å¤ºä¸´ç•Œå˜é‡,å³é‡å¤ç¬¬1æ­¥</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://javadoop.com/post/AbstractQueuedSynchronizer-2">ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å…³äºjava.util.concurrent.locks.AbstractQueuedSynchronizer,è¿™ä¸ªç±»æ˜¯jucçš„åŸºç¡€ã€‚ReentrantLockä¸­ï¼ŒThreadPoolExecutorä¸­ï¼ŒCountDownLatchä¸­éƒ½æœ‰ç”¨åˆ°ã€‚&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/CapeBretonSunset_EN-AU10231293487_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="java" scheme="https://haldir65.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•-æ•°ç»„å…¨æ’åˆ—</title>
    <link href="https://haldir65.github.io/2019/04/03/2019-04-03-algorithm-array-permutation/"/>
    <id>https://haldir65.github.io/2019/04/03/2019-04-03-algorithm-array-permutation/</id>
    <published>2019-04-03T13:44:25.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>é—®é¢˜æè¿°<br><a id="more"></a></p><p>å…¨æ’åˆ—è¡¨ç¤ºæŠŠé›†åˆä¸­å…ƒç´ çš„æ‰€æœ‰æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ’åˆ—èµ·æ¥ï¼Œä½¿ç”¨P(n, n) = n!è¡¨ç¤ºnä¸ªå…ƒç´ å…¨æ’åˆ—çš„ä¸ªæ•°ã€‚P(n, n)ä¸­çš„ç¬¬ä¸€ä¸ªnè¡¨ç¤ºå…ƒç´ çš„ä¸ªæ•°ï¼Œç¬¬äºŒä¸ªnè¡¨ç¤ºå–å¤šå°‘ä¸ªå…ƒç´ è¿›è¡Œæ’åˆ—ã€‚<br>æ¯”æ–¹è¯´[1,2,3]è¿™ä¸ªæ•°ç»„ï¼Œå…¨æ’åˆ—å°±æœ‰è¿™6ç§ç»“æœ</p><pre><code>[1,2,3][1,3,2][2,1,3][2,3,1][3,1,2][3,2,1]</code></pre><p>ç»™å®šä¸€ä¸ªnä¸ªå…ƒç´ æ•°ç»„ï¼Œå…¶å…¨æ’åˆ—çš„è¿‡ç¨‹å¯ä»¥æè¿°å¦‚ä¸‹ï¼š<br>ï¼ˆ1ï¼‰ä»»æ„å–ä¸€ä¸ªå…ƒç´ æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œåˆ™æœ‰nç§é€‰æ‹©ï¼›<br>ï¼ˆ2ï¼‰å†å‰©ä¸‹çš„n-1ä¸ªå…ƒç´ ä¸­å†å–ä¸€ä¸ªå…ƒç´ æ”¾åœ¨ç¬¬äºŒä¸ªä½ç½®åˆ™æœ‰n-1ç§é€‰æ‹©ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åšå¯¹n-1ä¸ªå…ƒç´ è¿›è¡Œå…¨æ’åˆ—ï¼›<br>ï¼ˆ3ï¼‰é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°å¯¹æœ€åä¸€ä¸ªå…ƒç´ è¿›è¡Œå…¨æ’åˆ—ï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ æ”¾åœ¨æœ€åä¸€ä¸ªä½ç½®ï¼Œå…¨æ’åˆ—ç»“æŸã€‚</p><p>ä»¥æ•°ç»„{1,2,3}ä¸ºä¾‹ï¼Œå…¶å…¨æ’åˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š<br>ï¼ˆ1ï¼‰1åé¢è·Ÿï¼ˆ2,3ï¼‰çš„å…¨æ’åˆ—ï¼›<br>ï¼ˆ2ï¼‰2åé¢è·Ÿï¼ˆ1,3ï¼‰çš„å…¨æ’åˆ—ï¼›<br>ï¼ˆ3ï¼‰3åé¢è·Ÿï¼ˆ1,2ï¼‰çš„å…¨æ’åˆ—ã€‚</p><h2 id="é€’å½’ç‰ˆæœ¬çš„å®ç°"><a href="#é€’å½’ç‰ˆæœ¬çš„å®ç°" class="headerlink" title="é€’å½’ç‰ˆæœ¬çš„å®ç°"></a>é€’å½’ç‰ˆæœ¬çš„å®ç°</h2><pre><code class="CPP">#include &lt;iostream&gt;using namespace std;int sum=0; //å…¨æ’åˆ—ä¸ªæ•°//æ‰“å°æ•°ç»„å†…å®¹void print(int array[],int len){    printf(&quot;{&quot;);    for(int i=0; i&lt;len;++i)        cout&lt;&lt;array[i]&lt;&lt;&quot; &quot;;    printf(&quot;}\n&quot;);}//å®ç°ä¸¤æ•°äº¤æ¢void swap(int* o,int i,int j){    int tmp = o[i];    o[i] = o[j];    o[j] = tmp;}//é€’å½’å®ç°æ•°ç»„å…¨æ’åˆ—å¹¶æ‰“å°void permutation(int array[],int len,int index){    if(index==len){//å…¨æ’åˆ—ç»“æŸ        ++sum;        print(array,len);    }    else        for(int i=index;i&lt;len;++i){            //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢è‡³å½“å‰indexä¸‹æ ‡å¤„            swap(array,index,i);            //ä»¥é€’å½’çš„æ–¹å¼å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œå…¨æ’åˆ—            permutation(array,len,index+1);            //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢å›åŸå¤„            swap(array,index,i);        }}int main(){    int array[3]={1,2,3};    permutation(array,3,0);    cout&lt;&lt;&quot;sum:&quot;&lt;&lt;sum&lt;&lt;endl;    getchar();}</code></pre><h3 id="è€ƒè™‘æ•°ç»„å…ƒç´ ä¸­æœ‰é‡å¤çš„å…ƒç´ "><a href="#è€ƒè™‘æ•°ç»„å…ƒç´ ä¸­æœ‰é‡å¤çš„å…ƒç´ " class="headerlink" title="è€ƒè™‘æ•°ç»„å…ƒç´ ä¸­æœ‰é‡å¤çš„å…ƒç´ "></a>è€ƒè™‘æ•°ç»„å…ƒç´ ä¸­æœ‰é‡å¤çš„å…ƒç´ </h3><p>å¯¹äº[1,2,2]è¿™ç§æ•°ç»„ï¼ŒæŠŠç¬¬ä¸€ä¸ªæ•°1å’Œç¬¬äºŒä¸ªæ•°2äº’æ¢å¾—åˆ°[2,1,2],æ¥ä¸‹æ¥ç¬¬ä¸€ä¸ªæ•°1ä¸ç¬¬ä¸‰ä¸ªæ•°2äº’æ¢å°±æ²¡æœ‰å¿…è¦äº†ã€‚å†è€ƒè™‘[2,1,2]ï¼Œç¬¬äºŒä¸ªæ•°ä¸ç¬¬ä¸‰ä¸ªæ•°äº’æ¢å¾—åˆ°[2,2,1],è‡³æ­¤å…¨æ’åˆ—ç»“æŸã€‚</p><font color="red">è¿™æ ·æˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†åœ¨å…¨æ’åˆ—ä¸­å»æ‰é‡å¤çš„è§„åˆ™â€”â€”å»é‡çš„å…¨æ’åˆ—å°±æ˜¯ä»ç¬¬ä¸€ä¸ªæ•°å­—èµ·æ¯ä¸ªæ•°åˆ†åˆ«ä¸å®ƒåé¢éé‡å¤å‡ºç°çš„æ•°å­—äº¤æ¢ã€‚</font><p>ä¿®æ”¹ä»£ç å¦‚ä¸‹:</p><pre><code class="cpp">//æ˜¯å¦äº¤æ¢bool isSwap(int array[],int len,int index){        for(int i=index+1;i&lt;len;++i)//ä»è¿™ä¸ªindexå¼€å§‹ï¼Œå¾€åä¸€æ—¦å‡ºç°äº†å’Œè¯¥æ•°å­—é‡å¤çš„ï¼Œä¸ç”¨äº’æ¢äº†            if(array[index]==array[i])                return false;        return true;}//é€’å½’å®ç°æœ‰é‡å¤å…ƒç´ çš„æ•°ç»„å…¨æ’åˆ—void permutation(int array[],int len,int index){    if(index==len){//å…¨æ’åˆ—ç»“æŸ        ++sum;        print(array,len); //å¦‚æœåªæœ‰ä¸€ä¸ªçš„è¯ï¼Œé‚£å¿…ç„¶å·²æ˜¯å…¨æ’åˆ—å®Œæˆäº†çš„    }    else        for(int i=index;i&lt;len;++i){            if(isSwap(array,len,i)){ //æ–°å¢åˆ¤æ–­æ˜¯å¦äº¤æ¢                //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢è‡³å½“å‰indexä¸‹æ ‡å¤„                swap(array,index,i);                //ä»¥é€’å½’çš„æ–¹å¼å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œå…¨æ’åˆ—                permutation(array,len,index+1);//å›ºå®šå½“å‰çš„é¦–ä½å…ƒç´ ï¼Œé€’å½’æ±‚å‰©ä¸‹çš„å…¨æ’åˆ—ç§ç±»                //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢å›åŸå¤„                swap(array,index,i);            }        }}</code></pre><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://blog.csdn.net/k346k346/article/details/51154786">æ•°ç»„çš„å…¨æ’åˆ—</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é—®é¢˜æè¿°&lt;br&gt;
    
    </summary>
    
    
      <category term="ç®—æ³•" scheme="https://haldir65.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•-Top-Ké—®é¢˜</title>
    <link href="https://haldir65.github.io/2019/03/30/2019-03-30-algorithm-top-K/"/>
    <id>https://haldir65.github.io/2019/03/30/2019-03-30-algorithm-top-K/</id>
    <published>2019-03-30T22:17:37.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>10äº¿ä¸ªæ•°ä¸­æ‰¾å‡ºæœ€å¤§çš„10000ä¸ªæ•°ï¼ˆtop Ké—®é¢˜ï¼‰</p><a id="more"></a><h2 id="1-ç›´æ¥æ’åºç„¶åå–æœ€å¤§çš„Kä¸ªæ•°"><a href="#1-ç›´æ¥æ’åºç„¶åå–æœ€å¤§çš„Kä¸ªæ•°" class="headerlink" title="1. ç›´æ¥æ’åºç„¶åå–æœ€å¤§çš„Kä¸ªæ•°"></a>1. ç›´æ¥æ’åºç„¶åå–æœ€å¤§çš„Kä¸ªæ•°</h2><p>æ€»çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N<em>logN)+O(K)=O(N</em>logN)ã€‚è¯¥ç®—æ³•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><p>å¿«é€Ÿæ’åºçš„å¹³å‡å¤æ‚åº¦ä¸ºO(N*logN)ï¼Œä½†æœ€åæ—¶é—´å¤æ‚åº¦ä¸ºO(n2)ï¼Œä¸èƒ½å§‹ç»ˆä¿è¯è¾ƒå¥½çš„å¤æ‚åº¦<br>åªéœ€è¦å‰kå¤§æˆ–kå°çš„æ•°,ï¼Œå®é™…å¯¹å…¶ä½™ä¸éœ€è¦çš„æ•°ä¹Ÿè¿›è¡Œäº†æ’åºï¼Œæµªè´¹äº†å¤§é‡æ’åºæ—¶é—´</p><h2 id="2-åˆ©ç”¨å¿«é€Ÿæ’åºçš„ç‰¹ç‚¹"><a href="#2-åˆ©ç”¨å¿«é€Ÿæ’åºçš„ç‰¹ç‚¹" class="headerlink" title="2. åˆ©ç”¨å¿«é€Ÿæ’åºçš„ç‰¹ç‚¹"></a>2. åˆ©ç”¨å¿«é€Ÿæ’åºçš„ç‰¹ç‚¹</h2><p>åœ¨æ•°ç»„ä¸­éšæœºæ‰¾ä¸€ä¸ªå…ƒç´ keyï¼Œå°†æ•°ç»„åˆ†æˆä¸¤éƒ¨åˆ†Saå’ŒSbï¼Œå…¶ä¸­Saçš„å…ƒç´ &gt;=keyï¼ŒSbçš„å…ƒç´ &lt;key</p><p>è‹¥Saä¸­å…ƒç´ çš„ä¸ªæ•°å¤§äºæˆ–ç­‰äºkï¼Œåˆ™åœ¨Saä¸­æŸ¥æ‰¾æœ€å¤§çš„kä¸ªæ•°<br>è‹¥Saä¸­å…ƒç´ çš„ä¸ªæ•°å°äºkï¼Œå…¶ä¸ªæ•°ä¸ºlenï¼Œåˆ™åœ¨Sbä¸­æŸ¥æ‰¾k-lenä¸ªæ•°å­—</p><pre><code class="java">public static int findTopK(int[] array, int left, int right, int k) {    int index = -1;    if (left &lt; right) {        int pos = partition(array, left, right);        int len = pos - left + 1;        if (len == k) {            index = pos;        } else if (len &lt; k) {//Saä¸­å…ƒç´ ä¸ªæ•°å°äºKï¼Œåˆ°Sbä¸­æŸ¥æ‰¾k-lenä¸ªæ•°å­—            index = findTopK(array, pos + 1, right, k - len);        } else {//Saä¸­å…ƒç´ çš„ä¸ªæ•°å¤§äºæˆ–ç­‰äºk            index = findTopK(array, left, pos - 1, k);        }    }    return index;}/** * æŒ‰åŸºå‡†ç‚¹åˆ’åˆ†æ•°ç»„ï¼Œå·¦è¾¹çš„å…ƒç´ å¤§äºåŸºå‡†ç‚¹ï¼Œå³è¾¹çš„å…ƒç´ å°äºåŸºå‡†ç‚¹ * * @param array * @param left * @param right * @return */public static int partition(int[] array, int left, int right) {    int x = array[left];//åŸºå‡†ç‚¹ï¼Œéšæœºé€‰æ‹©    do {        while (array[right] &lt; x &amp;&amp; left &lt; right)//ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºå‡†ç‚¹å¤§çš„å…ƒç´             right--;        if (left &lt; right) {            array[left] = array[right];//å¤§å…ƒç´ å‰ç§»            left++;         }        while (array[left] &gt;= x &amp;&amp; left &lt; right) //ä»å‰å‘åæ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºå‡†ç‚¹å°çš„å…ƒç´             left++;        if (left &lt; right) {            array[right] = array[left];//å°å…ƒç´ åç§»            right--;        }    } while (left &lt; right);    array[left] = x;    return left;}</code></pre><h2 id="3-å°é¡¶å †"><a href="#3-å°é¡¶å †" class="headerlink" title="3. å°é¡¶å †"></a>3. å°é¡¶å †</h2><p>å †æ’åºåœ¨å¤„ç†æµ·é‡æ•°æ®çš„æ—¶å€™ååˆ†æœ‰æ•ˆ<br>æŸ¥æ‰¾æœ€å¤§çš„Kä¸ªæ•°ï¼Œå…¶å®å°±æ˜¯å»ºç«‹ä¸€ä¸ªå¤§å°ä¸ºKçš„å°é¡¶å †ï¼Œæ¯æ¬¡å‡ºç°æ¯”é¡¶éƒ¨å¤§çš„å…ƒç´ æ—¶ï¼Œæ›¿æ¢ï¼Œå¹¶é‡æ–°è°ƒæ•´å †<br>ä»£ç å®ç°å¦‚ä¸‹<br>ä¸‹é¢è¿™ä¸ªæ˜¯æ‰¾å‡ºæœ€å°çš„Kä¸ªå…ƒç´ ï¼Œå¹¶ä¸”æ˜¯æ„å»ºå¤§é¡¶å †</p><pre><code class="java">public static int[] findTopK(int[] array, int k) {    int heapArray[] = new int[k];    for (int i = 0; i &lt; k; i++) {        heapArray[i] = array[i];    }    buildMaxHeap(heapArray);    for (int i = k; i &lt; array.length; i++) {        if (array[i] &lt; heapArray[0]) {            heapArray[0] = array[i];//æ›´æ–°å †é¡¶            adjustMaxHeap(heapArray, 0, heapArray.length);        }    }    return heapArray;}/** * æ„å»ºå°é¡¶å † * * @param array */public static void buildMaxHeap(int[] array) {    for (int i = array.length / 2 - 1; i &gt;= 0; i--) {        adjustMaxHeap(array, i, array.length);    }}/** * è°ƒæ•´å †ç»“æ„ * * @param array * @param root   æ ¹èŠ‚ç‚¹ * @param length */public static void adjustMaxHeap(int[] array, int root, int length) {    int left = root * 2 + 1; //å·¦èŠ‚ç‚¹ä¸‹æ ‡ï¼Œæ•°ç»„ä¸‹æ ‡ä»0å¼€å§‹ï¼Œæ‰€ä»¥åŠ 1    int right = left + 1; //å³èŠ‚ç‚¹ä¸‹æ ‡    int largest = root;// å­˜æ”¾ä¸‰ä¸ªèŠ‚ç‚¹ä¸­æœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡    if (left &lt; length &amp;&amp; array[left] &gt; array[root]) { //å·¦èŠ‚ç‚¹å¤§äºæ ¹èŠ‚ç‚¹ï¼Œæ›´æ–°æœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡        largest = left;    }    if (right &lt; length &amp;&amp; array[right] &gt; array[largest]) {//å³èŠ‚ç‚¹å¤§äºæ ¹èŠ‚ç‚¹ï¼Œæœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡        largest = right;    }    if (root != largest) {        swap(array, largest, root);        adjustMaxHeap(array, largest, length);    }}/** * äº¤æ¢ * * @param arr * @param i * @param j */public static void swap(int[] arr, int i, int j) {    int temp = arr[i];    arr[i] = arr[j];    arr[j] = temp;}</code></pre><p>ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N * logk)</p><h2 id="4-å‡å¦‚æ•°æ®çš„æœ€å¤§å€¼å’Œæœ€å°å€¼å·®è·ä¸å¤§ï¼Œéƒ½æ˜¯æ•´æ•°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œç»“æŸåå¯¹è¿™ä¸ªæ•°ç»„ä»åå¾€å‰ç»Ÿè®¡ï¼Œç¢°åˆ°countå¤§äº0çš„è¯´æ˜å‡ºç°è¿‡ï¼Œç»Ÿè®¡åˆ°äº†Kä¸ªå°±ç»“æŸ"><a href="#4-å‡å¦‚æ•°æ®çš„æœ€å¤§å€¼å’Œæœ€å°å€¼å·®è·ä¸å¤§ï¼Œéƒ½æ˜¯æ•´æ•°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œç»“æŸåå¯¹è¿™ä¸ªæ•°ç»„ä»åå¾€å‰ç»Ÿè®¡ï¼Œç¢°åˆ°countå¤§äº0çš„è¯´æ˜å‡ºç°è¿‡ï¼Œç»Ÿè®¡åˆ°äº†Kä¸ªå°±ç»“æŸ" class="headerlink" title="4. å‡å¦‚æ•°æ®çš„æœ€å¤§å€¼å’Œæœ€å°å€¼å·®è·ä¸å¤§ï¼Œéƒ½æ˜¯æ•´æ•°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œç»“æŸåå¯¹è¿™ä¸ªæ•°ç»„ä»åå¾€å‰ç»Ÿè®¡ï¼Œç¢°åˆ°countå¤§äº0çš„è¯´æ˜å‡ºç°è¿‡ï¼Œç»Ÿè®¡åˆ°äº†Kä¸ªå°±ç»“æŸ"></a>4. å‡å¦‚æ•°æ®çš„æœ€å¤§å€¼å’Œæœ€å°å€¼å·®è·ä¸å¤§ï¼Œéƒ½æ˜¯æ•´æ•°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œç»“æŸåå¯¹è¿™ä¸ªæ•°ç»„ä»åå¾€å‰ç»Ÿè®¡ï¼Œç¢°åˆ°countå¤§äº0çš„è¯´æ˜å‡ºç°è¿‡ï¼Œç»Ÿè®¡åˆ°äº†Kä¸ªå°±ç»“æŸ</h2><pre><code class="java">public static List&lt;Integer&gt; findTopK(int[] array, int k) {    int max = array[0];    for (int i = 0; i &lt; array.length; i++) {        if (max &lt; array[i]) {            max = array[i];        }    }    int count[] = new int[max + 1];    for (int i = 0; i &lt; array.length; i++) {        count[array[i]] += 1;    }    List&lt;Integer&gt; topKList = new ArrayList&lt;&gt;();    for (int sumCount = 0, j = count.length - 1; j &gt;= 0; j--) {        int c = count[j];        sumCount += c;        if (c &gt; 0) {            for (int i = 0; i &lt; c; i++) {                topKList.add(j);            }        }        if (sumCount &gt;= k) {            break;        }    }    return topKList;}</code></pre><p>è¯¥ç®—æ³•è¿˜å¯ä»¥ç”¨bitmapç®—æ³•ä¼˜åŒ–ï¼Œç”¨ä¸€ä¸ªintè¡¨ç¤º32ä¸ªæ•´æ•°ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;10äº¿ä¸ªæ•°ä¸­æ‰¾å‡ºæœ€å¤§çš„10000ä¸ªæ•°ï¼ˆtop Ké—®é¢˜ï¼‰&lt;/p&gt;
    
    </summary>
    
    
      <category term="ç®—æ³•" scheme="https://haldir65.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>ä»setContentViewå¼€å§‹è°ˆçš„æ¸²æŸ“æµç¨‹</title>
    <link href="https://haldir65.github.io/2019/03/29/2019-03-29-from-setcontentview-to-rendering/"/>
    <id>https://haldir65.github.io/2019/03/29/2019-03-29-from-setcontentview-to-rendering/</id>
    <published>2019-03-29T09:25:01.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>è°ˆä¸€è°ˆViewçš„æ¸²æŸ“æµç¨‹å§<br><img src="https://api1.foster66.xyz/static/imgs/TamarackCones_EN-AU12178466392_1920x1080.jpg" alt=""></p><a id="more"></a><h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>ä¸è´Ÿè´£æ§åˆ¶è§†å›¾ï¼Œå®ƒä¸»è¦æ§åˆ¶ç”Ÿå‘½å‘¨æœŸå’Œå¤„ç†äº‹ä»¶ã€‚Activityä¸­é€šè¿‡æŒæœ‰PhoneWindowæ¥æ§åˆ¶è§†å›¾,è€Œäº‹ä»¶åˆ™æ˜¯é€šè¿‡WindowCallbackæ¥ä¼ è¾¾ç»™Activityçš„<br>Windowï¼ˆå”¯ä¸€å®ç°ç±»æ˜¯PhoneWindowï¼‰ã€‚PhoneWindowæ˜¯åœ¨activityçš„attachä¸­newå‡ºæ¥çš„ï¼Œå¹¶ä¸”è®¾ç½®äº†PhoneWindow.setCallback(this)ã€‚å¤§è‡´ä»£ç å¦‚ä¸‹</p><pre><code class="java">//activity.javafinal void attach(Context context, ActivityThread aThread,        Instrumentation instr, IBinder token, int ident,        Application application, Intent intent, ActivityInfo info,        CharSequence title, Activity parent, String id,        NonConfigurationInstances lastNonConfigurationInstances,        Configuration config, String referrer, IVoiceInteractor voiceInteractor,        Window window, ActivityConfigCallback activityConfigCallback) {    attachBaseContext(context);    mWindow = new PhoneWindow(this, window, activityConfigCallback);//åˆ›å»ºä¸€ä¸ªwindow    mWindow.setWindowControllerCallback(this);    mWindow.setCallback(this); //ç”¨äºå‘activityåˆ†å‘ç‚¹å‡»æˆ–è€…çŠ¶æ€æ”¹å˜äº‹ä»¶    mWindow.setOnWindowDismissedCallback(this);    mWindow.setWindowManager(    (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),    mToken, mComponent.flattenToString(),    (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);//è®¾ç½®windowManagerå¯¹è±¡    }</code></pre><p>PhoneWindowä¸­æŒæœ‰äº†DecorViewï¼ŒDecorViewæ˜¯æœ€é¡¶å±‚çš„è§†å›¾</p><h3 id="PhoneWindowå’ŒmContentParent"><a href="#PhoneWindowå’ŒmContentParent" class="headerlink" title="PhoneWindowå’ŒmContentParent"></a>PhoneWindowå’ŒmContentParent</h3><p>DecorViewç»§æ‰¿è‡ªFrameLayoutï¼Œå†…éƒ¨åªæœ‰ä¸€ä¸ªLinearLayoutçš„childï¼ˆmContentParentï¼‰,è¿™ä¸ªlinearLayoutä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯ViewStub(actionBar)ï¼Œä¸€ä¸ªFrameLayout(æ ‡é¢˜æ ),ä¸€ä¸ªandroid.R.id.contentçš„FrameLayout.<br>Activityçš„setContentViewèµ°åˆ°äº†PhoneWindowçš„setContentViewä¸­</p><pre><code class="java">// PhoneWindow.java  @Override    public void setContentView(int layoutResID) {        installDecor();        //æœ‰æ‰€åˆ å‡        mLayoutInflater.inflate(layoutResID, mContentParent);    }    private void installDecor() {         if (mDecor == null) {            mDecor = generateDecor(-1); //newä¸€ä¸ªDecorViewå‡ºæ¥        }         if (mContentParent == null) {            mContentParent = generateLayout(mDecor); //æ ¹æ®ä¸åŒçš„themeåˆ›å»ºDecorViewçš„child        }    }    protected DecorView generateDecor(int featureId) {        return new DecorView(context, featureId, this, getAttributes());//DecorViewä¹Ÿå°±æŒæœ‰äº†windowå¯¹è±¡    }    protected ViewGroup generateLayout(DecorView decor) {        // Inflate the window decor.        int layoutResource;        //æ ¹æ®ä¸åŒçš„themeï¼Œå¯èƒ½å‡ºç°çš„layoutResourceæœ‰        layoutResource = R.layout.screen_swipe_dismiss;        layoutResource = R.layout.screen_title_icons;        layoutResource = R.layout.screen_progress;        layoutResource = R.layout.screen_custom_title;        layoutResource = a.getResourceId(                    R.styleable.Window_windowActionBarFullscreenDecorLayout,                    R.layout.screen_action_bar);        layoutResource = R.layout.screen_title;        layoutResource = R.layout.screen_simple_overlay_action_mode;        layoutResource = R.layout.screen_simple;        //è¿™äº›å¯èƒ½çš„layoutResourceå°±æ˜¯DecorViewçš„childçš„å¸ƒå±€æ–‡ä»¶        mDecor.onResourcesLoaded(mLayoutInflater, layoutResource); //è¿™é‡Œé¢ç›´æ¥layoutInflaterè¿™ä¸ªå¸ƒå±€æ–‡ä»¶ï¼ŒdeocorViewå»addè¿™ä¸ªView        ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);//åœ¨è¿™ä¸ªæ–°åˆ›å»ºçš„å¸ƒå±€ä¸­æ‰¾android.R.id.content    }    //installDecorèµ°å®Œè¿™ä¸ªmContentParentä¹Ÿå°±æ‰¾åˆ°äº†    //ä¸Šé¢è¯´é“PhoneWindowçš„setContentViewå¤§è‡´ä¸¤å¥è¯ï¼ŒinstallDecor()å’ŒmLayoutInflater.inflate(layoutResID, mContentParent);    //äºæ˜¯mLayoutInflater.inflate(layoutResID, mContentParent);å°±æ˜¯æŠŠå¼€å‘è€…å†™çš„layoutResæ–‡ä»¶å¯¹åº”çš„viewåˆ›å»ºå‡ºæ¥å¹¶ä¸”æ·»åŠ åˆ°mContentParentä¸­</code></pre><p><img src="https://api1.foster66.xyz/static/imgs/window_manager_02.png" alt=""></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™çš„viewä¹Ÿå°±è¢«æ·»åŠ åˆ°android.R.id.contentè¿™ä¸ªFrameLayouté‡Œäº†ï¼Œè¿™æ—¶åº”è¯¥åœ¨onCreateé‡Œé¢ã€‚æ ¹æ®ActivityThreadåœ¨<a href="http://androidxref.com/6.0.1_r10/xref/frameworks/base/core/java/android/app/ActivityThread.java#handleLaunchActivity">6.0çš„ä»£ç </a></p><pre><code class="java">//ActivityThread.javaprivate void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) {   Activity a = performLaunchActivity(r, customIntent);      if (a != null) {         handleResumeActivity(r.token, false, r.isForward,!r.activity.mFinished &amp;&amp; !r.startsNotResumed);      }}final void handleResumeActivity(IBinder token,boolean clearHide, boolean isForward, boolean reallyResume) {      ActivityClientRecord r = performResumeActivity(token, clearHide);//è¿™é‡Œé¢å°±æ˜¯æ­£å¸¸çš„onResume      if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) {        r.window = r.activity.getWindow();        View decor = r.window.getDecorView();//æ‹¿åˆ°decorView        decor.setVisibility(View.INVISIBLE);//æ”¹ä¸ºä¸å¯è§        ViewManager wm = a.getWindowManager();        WindowManager.LayoutParams l = r.window.getAttributes();        a.mDecor = decor;        l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;        l.softInputMode |= forwardBit;        if (a.mVisibleFromClient) {            a.mWindowAdded = true;            wm.addView(decor, l); //é€šè¿‡windowManagerå»addView,læ˜¯windowManagerçš„layoutparametersï¼ŒViewRootImplä¹Ÿå°±æ˜¯ä»è¿™é‡Œåˆ›å»º        }      }    // The window is now visible if it has been added, we are not        // simply finishing, and we are not starting another activity. //ä¸Šé¢è®¾ç½®INVISIBLEçš„åŸå› ï¼Œè¿™é‡Œä¹Ÿè¯´äº†ï¼Œå¦‚æœæ²¡æœ‰finishï¼Œä¹Ÿæ²¡æœ‰æ­£åœ¨èµ·å¦ä¸€ä¸ªactivityçš„è¯ï¼Œå°±å¯ä»¥è®©è¿™ä¸ªactivityå˜å¾—å¯è§äº†    if (!r.activity.mFinished &amp;&amp; willBeVisible            &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) {       if (r.activity.mVisibleFromClient) {            r.activity.makeVisible();        }    }}//activity.javavoid makeVisible() {    if (!mWindowAdded) {        ViewManager wm = getWindowManager();        wm.addView(mDecor, getWindow().getAttributes());        mWindowAdded = true;    }    mDecor.setVisibility(View.VISIBLE);//é‡æ–°æ”¹æˆvisible}</code></pre><p>åˆ°è¿™é‡Œï¼ˆonResumeèµ°å®Œï¼‰ï¼ŒDecorViewå°±è¢«WindowManagerè°ƒç”¨addViewäº†ã€‚ä¸‹é¢å¼€å§‹è®²è°ƒç”¨WindowManagerçš„addViewè¿™ä¸ªIPCéœ€è¦å‡†å¤‡çš„å‚æ•°å’Œè¿œç«¯å¦‚ä½•æ¥æ”¶è¿™ä¸ªæ”¶åˆ°çš„å‚æ•°</p><h3 id="WindowManagerGlobal"><a href="#WindowManagerGlobal" class="headerlink" title="WindowManagerGlobal"></a>WindowManagerGlobal</h3><p>WindowManageræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶addViewå’ŒremoveViewæ˜¯ç”±WindowManagerImplå»è°ƒç”¨WindowManagerGlobalåšçš„ï¼ˆè®¾è®¡æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ã€‚WindowManagerGlobalæ˜¯appè¿›ç¨‹ä¸­çš„å•ä¾‹ï¼‰<br>WindowManagerGlobalå’ŒWMSäº¤äº’è°ƒç”¨çš„æ˜¯IWindowManageråœ¨WMSä¸­çš„å¯¹åº”å®ç°<br>WindowManagerGlobal.sWindowSessionæ˜¯appè¿›ç¨‹ä¸­æ‰€æœ‰viewRootImplçš„IWindowSession</p><pre><code class="java">//WindowManagerGlobal.java public void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) {        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;        if (parentWindow != null) {            parentWindow.adjustLayoutParamsForSubWindow(wparams);//è¿™é‡Œå°†activityçš„tokenè®¾ç½®åˆ°äº†WindowManager.layoutParamsä¸­        }        ViewRootImpl root;        root = new ViewRootImpl(view.getContext(), display);        view.setLayoutParams(wparams);        // do this last because it fires off messages to start doing things        try {            root.setView(view, wparams, panelParentView);        } catch (RuntimeException e) {            // BadTokenException or InvalidDisplayException, clean up.            if (index &gt;= 0) {                removeViewLocked(index, true);            }            throw e;        }}</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä»activity.setContentView -&gt; åˆ›å»ºDecorViewå’ŒDecorViewçš„childï¼Œä»¥åŠæ‰¾åˆ°android.R.id.contentï¼Œå¾€é‡Œé¢æ·»åŠ è‡ªå®šä¹‰å¸ƒå±€ -&gt; handleResumeActivity(é€šè¿‡windowManager.addViewï¼Œç„¶åmakeVisible) ï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªmessageä¸­å¤„ç†çš„ã€‚WindowManager.addViewè½¬å…¥ViewRootImplçš„setViewæ–¹æ³•,æŠŠdecorViewæ·»åŠ è¿›å»äº†</p><h3 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h3><pre><code class="java">//viewRootImpl.java//é¦–å…ˆéœ€è¦å£°æ˜ViewRootImplä¸æ˜¯Viewpublic final class ViewRootImpl implements ViewParent,        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {}public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {    //è¿™é‡Œçš„viewæ˜¯DecorView     int res; /* = WindowManagerImpl.ADD_OKAY; */    // Schedule the first layout -before- adding to the window    // manager, to make sure we do the relayout before receiving    // any other events from the system.    requestLayout();    //å’ŒwindowManagerServiceæ‰“äº¤é“çš„ipcå°±åœ¨è¿™é‡Œäº†    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,                        getHostVisibility(), mDisplay.getDisplayId(), mWinFrame,                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,                        mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel);    // mWindowSessionæ˜¯WindowManagerGlobalæä¾›çš„ï¼Œå…¨å±€å”¯ä¸€çš„staticå˜é‡                        // mWindowSessionæ˜¯IWindowSessionå¯¹è±¡ï¼ŒIWindowSession.aidlä¸­å®šä¹‰äº†è¿™ä¸ªipcçš„ä¸€ç³»åˆ—æ–¹æ³•    //è¿™ä¸ªmWindowå…¶å®æ˜¯ViewRootImpl.W extends IWindow.Stubï¼Œä¹Ÿå°±æ˜¯WMSè¿œç¨‹è°ƒç”¨è¿›å…¥appè¿›ç¨‹ä¸­çš„ä»£ç†     // Set up the input pipeline.è¿™äº›stageæ˜¯è´£ä»»é“¾æ¨¡å¼å¤„ç†äº‹ä»¶ï¼Œæ¯ä¸€ä¸ªæŒæœ‰å‰ä¸€ä¸ªçš„å¼•ç”¨    CharSequence counterSuffix = attrs.getTitle();    mSyntheticInputStage = new SyntheticInputStage();    InputStage viewPostImeStage = new ViewPostImeInputStage(mSyntheticInputStage); //è¿™ä¸ªæ˜¯å¤„ç†nativeå±‚ä¼ æ¥çš„inputEventçš„    InputStage nativePostImeStage = new NativePostImeInputStage(viewPostImeStage,            &quot;aq:native-post-ime:&quot; + counterSuffix);    InputStage earlyPostImeStage = new EarlyPostImeInputStage(nativePostImeStage);    InputStage imeStage = new ImeInputStage(earlyPostImeStage,            &quot;aq:ime:&quot; + counterSuffix);    InputStage viewPreImeStage = new ViewPreImeInputStage(imeStage);    InputStage nativePreImeStage = new NativePreImeInputStage(viewPreImeStage,            &quot;aq:native-pre-ime:&quot; + counterSuffix);    mFirstInputStage = nativePreImeStage;    mFirstPostImeInputStage = earlyPostImeStage;    mPendingInputEventQueueLengthCounterName = &quot;aq:pending:&quot; + counterSuffix;                    }</code></pre><p>ä¸‹é¢å¼€å§‹å…³æ³¨è¿™ä¸ªipc</p><h3 id="IWindowSession-addToDisplayåšäº†ä»€ä¹ˆ"><a href="#IWindowSession-addToDisplayåšäº†ä»€ä¹ˆ" class="headerlink" title="IWindowSession.addToDisplayåšäº†ä»€ä¹ˆ"></a>IWindowSession.addToDisplayåšäº†ä»€ä¹ˆ</h3><p><a href="https://www.jianshu.com/p/dbbc07218ac1">å‚è€ƒã€Šæ·±å…¥ç†è§£Androidå· Iã€‹- ç¬¬å…«ç«  - Surface- è¯»ä¹¦ç¬”è®°-part2</a></p><h2 id="ä¸‹é¢è¿™äº›éƒ½è¿è¡Œåœ¨system-serverè¿›ç¨‹"><a href="#ä¸‹é¢è¿™äº›éƒ½è¿è¡Œåœ¨system-serverè¿›ç¨‹" class="headerlink" title="ä¸‹é¢è¿™äº›éƒ½è¿è¡Œåœ¨system_serverè¿›ç¨‹"></a>ä¸‹é¢è¿™äº›éƒ½è¿è¡Œåœ¨system_serverè¿›ç¨‹</h2><p><code>frameworks/base/services/core/java/com/android/server/wm/Session.java</code></p><pre><code class="java">final class Session extends IWindowSession.Stub{    @Override    public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,        int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,        Rect outOutsets, InputChannel outInputChannel) {    return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,            outContentInsets, outStableInsets, outOutsets, outInputChannel);    }}</code></pre><p><code>frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</code></p><p>WMSçš„æˆå‘˜å˜é‡åŒ…æ‹¬</p><pre><code class="java">mSessions:ArraySet&lt;Session&gt; //All currently active sessions with clients.ä¸€ä¸ªappåªæœ‰ä¸€ä¸ªsessionmWindowMap:HashMap&lt;IBinder,WindowState&gt; // Mapping from an IWindow IBinder to the server&#39;s Window object.Keyæ˜¯IWindowmTokenMap:HashMap&lt;IBinder,WindowToken&gt; //Mapping from a token IBinder to a WindowToken object.keyåº”è¯¥æ˜¯IApplicationTokenï¼Œæ˜¯ä»WindowManager.LayoutParams.tokenè·¨ipcä¼ å…¥çš„ï¼Œvalueæ˜¯windowTokenã€‚ä¸€ä¸ªwindowToken(èƒŒåå¯¹åº”å”¯ä¸€activity)ï¼Œä¸‹é¢åŒ…å«å¤šä¸ªwindowState(ä¸€ä¸ªactivityå¯ä»¥æœ‰å¤šä¸ªçª—å£ï¼Œæ¯”å¦‚Dialog)</code></pre><p>ä¸€ä¸ªwindowTokenä¸­å­˜æœ‰å¤šä¸ªWindowState(token.windows),è€Œä¸€èˆ¬çš„ï¼Œä¸€ä¸ªWindowStateå°±å¯¹åº”ä¸€ä¸ªwindow.<br>å°±åƒWMSè¦ç®¡ç†å¤šä¸ªapp(WindowToken)ï¼Œæ¯ä¸ªappæœ‰å¤šä¸ªçª—å£(WindowStateï¼Œåœ¨appç«¯å°±æ˜¯ViewRootImpl.W)ï¼Œ</p><pre><code class="java">//windowManagerService.java public int addWindow(Session session, IWindow client, int seq,            WindowManager.LayoutParams attrs, int viewVisibility, int displayId,            Rect outContentInsets, Rect outStableInsets, Rect outOutsets,            InputChannel outInputChannel) {         if (token == null) {             //è¿™å°±æ˜¯ç³»ç»Ÿè¦æ±‚TYPE_APPLICATIONç±»å‹çš„çª—å£ï¼Œè¦æ±‚å¿…é¡»æœ‰activityçš„token,å¦åˆ™ä¼šæŠ›å‡ºBadTokenExceptionå¼‚å¸¸ã€‚Dialogçš„typeæ˜¯TYPE_APPLICATION,æ‰€ä»¥å¿…é¡»è¦åœ¨layoutParamsä¸­å¡«ä¸Šactivityçš„token                if (type &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; type &lt;= LAST_APPLICATION_WINDOW) { //1-99ä¹‹é—´ ,TYPE_APPLICATION=2                    Slog.w(TAG, &quot;Attempted to add application window with unknown token &quot;                          + attrs.token + &quot;.  Aborting.&quot;);                    return WindowManagerGlobal.ADD_BAD_APP_TOKEN;                }            }                // è¿™é‡ŒåŒ…æ‹¬ä¸€ç³»åˆ—çš„æ£€æŸ¥        // 1. çª—å£ç±»å‹å¿…é¡»æ˜¯åˆæ³•èŒƒå›´å†…çš„ï¼Œåº”ç”¨çª—å£ï¼Œå­çª—å£ï¼Œæˆ–è€…ç³»ç»Ÿçª—å£        // 2. å¦‚æœæ˜¯ç³»ç»Ÿçª—å£ï¼Œéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥ã€‚TYPE_TOAST,TYPE_WALLPAPERç­‰ä¸éœ€è¦æƒé™        // 3. å¦‚æœæ˜¯åº”ç”¨çª—å£ï¼Œå…ˆç”¨attrsé‡Œé¢çš„tokenæ£€ç´¢å‡ºæ¥WindowTokenï¼Œå¿…é¡»ä¸èƒ½ä¸ºnullï¼Œè€Œä¸”è¿˜å¾—æ˜¯Activityçš„mAppTokenï¼ŒåŒæ—¶è¯¥Activityè¿˜å¿…é¡»æ²¡æœ‰è¢«finishã€‚åœ¨Activityå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå…ˆé€šè¿‡WMSçš„addAppTokenæ–¹æ³•æ·»åŠ ä¸€ä¸ªAppWindowToken(IApplicationToken.Stub appToken)åˆ°mTokenMapä¸­ï¼ˆActivityStack.startActivityLockedï¼‰ï¼Œå…¶ä¸­keyå°±ç”¨åˆ°äº†IApplicationTokenã€‚è€Œè¿™ä¸ªmAppTokenå°±æ˜¯åœ¨activityçš„attachæ–¹æ³•é‡Œé¢èµ‹å€¼çš„ï¼Œå…·ä½“æ¥è‡ªAMS.(æ‰€ä»¥å°±æ˜¯system_serverè¿›ç¨‹åœ¨å¯åŠ¨ä¸€ä¸ªactivityçš„æ—¶å€™å¾€WMSçš„ä¸€ä¸ªmapé‡Œæ”¾äº†ä¸€ä¸ªnew WindowTokenå¯¹è±¡ã€‚appè¿›ç¨‹åœ¨handleLaunchActivityçš„æ—¶å€™ä¼šæ‹¿åˆ°è¿™ä¸ªappTokenï¼Œäºæ˜¯appè¿›ç¨‹æ‹¿ç€è¿™ä¸ªmAppTokené€šè¿‡ipcåˆ°WMSä¸­å»é—®ï¼Œæœ‰æ²¡æœ‰è¿™ä¸ªmAppTokenå­˜è¿‡ä¸œè¥¿)        WindowState win = new WindowState(this, session, client, token,  attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent);            //åç»­ä¼šå°†è¿™ä¸ªWindowStateæ·»åŠ åˆ°WMSçš„æˆå‘˜ä¸­, token.windows.add(i, win);        // ...        // tokenMapé‡Œé¢æ²¡æœ‰æ‰¾åˆ°        token = new WindowToken(this, attrs.token, -1, false);        //attrså°±æ˜¯layoutParams.tokenå°±é€šè¿‡binder callä¼ å…¥wmsè¿›ç¨‹ï¼Œæ‰€ä»¥tokenå°±æ˜¯activityçš„tokenï¼Œtokenæ˜¯ç»‘å®šåœ¨windowä¸Šï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªactivityæœ‰ä¸€ä¸ª        // ..        if (addToken) {            mTokenMap.put(attrs.token, token);//mTokenMapä¿å­˜æ‰€æœ‰çš„WindowTokenå¯¹è±¡,keyæ˜¯        }        win.attach(); //å°†sessionæ·»åŠ åˆ°mSessionsä¸­        mWindowMap.put(client.asBinder(), win);//è¿™ä¸ªclientæ˜¯IWindowï¼Œå…¶å®å°±æ˜¯ViewRootImpl.Wç±»å¯¹è±¡ä¸ºkey,windowStateä½œä¸ºvalueã€‚è¿™ä¸å°±æ˜¯ä¸€ä¸ªViewRootImplå¯¹åº”ä¸€ä¸ªWindowStateå˜›}// WindowState.javavoid attach() {    if (WindowManagerService.localLOGV) Slog.v(        TAG, &quot;Attaching &quot; + this + &quot; token=&quot; + mToken        + &quot;, list=&quot; + mToken.windows);    mSession.windowAddedLocked();}        //Session.javavoid windowAddedLocked() {        if (mSurfaceSession == null) {            mSurfaceSession = new SurfaceSession();            mService.mSessions.add(this);// windowState.attach -&gt; Session.windowAddedLocked -&gt; WMS.msession.add(session)        }        mNumWindow++;    } // windowToken.java//windowTokenä¼¼ä¹æœ‰ç”¨çš„æ–¹æ³•å°±è¿™ä¹ˆä¸€ä¸ªï¼Œä¹Ÿè¯´æ˜ä¸€ä¸ªwindowTokenå®é™…ä¸Šæœ‰å¤šä¸ªWindow void removeAllWindows() {        for (int winNdx = windows.size() - 1; winNdx &gt;= 0; --winNdx) {            WindowState win = windows.get(winNdx);            if (WindowManagerService.DEBUG_WINDOW_MOVEMENT) Slog.w(WindowManagerService.TAG,                    &quot;removeAllWindows: removing win=&quot; + win);            win.mService.removeWindowLocked(win);        }        windows.clear();    }      </code></pre><p><img src="https://api1.foster66.xyz/static/imgs/window_manager_01.jpeg" alt=""><br>ä¸€èˆ¬çš„ï¼Œæ¯ä¸€ä¸ªwindowéƒ½å¯¹åº”ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œ<br>è¯¥å¯¹è±¡çš„æˆå‘˜ä¸­mClient(final IWindow mClient;)ç”¨äºè·Ÿåº”ç”¨ç«¯äº¤äº’<br>æˆå‘˜å˜é‡mToken(WindowToken mToken;)ç”¨äºè·ŸAMSäº¤äº’</p><p>ViewRootImplä¸­æœ‰é’ˆå¯¹è¿œç¨‹è¿”å›çš„resåˆ¤æ–­çš„é€»è¾‘,ç»“åˆè¿™WindowManagerServiceçš„addViewæ–¹æ³•æŸ¥çœ‹æ›´åŠ æ¸…æ¥š</p><pre><code class="java">//ViewRootImpl.java switch (res) {                case WindowManagerGlobal.ADD_BAD_APP_TOKEN:                case WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN:                    throw new WindowManager.BadTokenException(                            &quot;Unable to add window -- token &quot; + attrs.token                            + &quot; is not valid; is your activity running?&quot;);                case WindowManagerGlobal.ADD_NOT_APP_TOKEN:                    throw new WindowManager.BadTokenException(                            &quot;Unable to add window -- token &quot; + attrs.token                            + &quot; is not for an application&quot;);                case WindowManagerGlobal.ADD_APP_EXITING:                    throw new WindowManager.BadTokenException(                            &quot;Unable to add window -- app for token &quot; + attrs.token                            + &quot; is exiting&quot;);}//windowManagerService.java public int addWindow(Session session, IWindow client,xxx) {     //ä»ä¸€ä¸ªHashMap&lt;IBinder,WindowToken&gt;ä¸­å»get(LayoutParams.attr.token)  WindowToken token = displayContent.getWindowToken(                    hasParent ? parentWindow.mAttrs.token : attrs.token);  //å¦‚æœå‘ç°æ²¡æœ‰windowToken(ä¸€ä¸ªWindowTokenæœ‰å¤šä¸ªwindowState,ä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªwindow)ï¼Œå¼€å§‹æŠ¥é”™   if (token == null) {        if (rootType &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; rootType &lt;= LAST_APPLICATION_WINDOW) { // 1-99ä¹‹é—´ï¼Œå¤šæ•°æ˜¯è¿™é‡Œ            Slog.w(TAG_WM, &quot;Attempted to add application window with unknown token &quot;                    + attrs.token + &quot;.  Aborting.&quot;);            return WindowManagerGlobal.ADD_BAD_APP_TOKEN; // è¿™é‡Œå›åˆ°appè¿›ç¨‹å°±æŠ›is your activity running?        }    }else {            // ..çœç•¥....         if (atoken == null) {                Slog.w(TAG_WM, &quot;Attempted to add window with non-application token &quot;                        + token + &quot;.  Aborting.&quot;);                return WindowManagerGlobal.ADD_NOT_APP_TOKEN;            } else if (atoken.removed) {                Slog.w(TAG_WM, &quot;Attempted to add window with exiting application token &quot;                        + token + &quot;.  Aborting.&quot;);                return WindowManagerGlobal.ADD_APP_EXITING;                //è¿™é‡ŒæŠ›å‡ºä»€ä¹ˆé”™ï¼Œåœ¨ViewRootImplé‡Œé¢å°±æœ‰å¯¹åº”çš„è§£é‡Š    }}</code></pre><p><code>æ·»åŠ Viewåˆ°WMSçš„æµç¨‹</code><br><img src="https://api1.foster66.xyz/static/imgs/window_manager_05.png" alt=""></p><p><code>ä»WMSä¸­RemoveViewçš„æµç¨‹</code><br><img src="https://api1.foster66.xyz/static/imgs/window_manager_04.png" alt=""></p><h3 id="å›åˆ°ViewRootImplçš„setViewæ–¹æ³•-session-addToDisplay"><a href="#å›åˆ°ViewRootImplçš„setViewæ–¹æ³•-session-addToDisplay" class="headerlink" title="å›åˆ°ViewRootImplçš„setViewæ–¹æ³•,session.addToDisplay"></a>å›åˆ°ViewRootImplçš„setViewæ–¹æ³•,session.addToDisplay</h3><pre><code class="java">//ViewRootImpl.javares = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,                    getHostVisibility(), mDisplay.getDisplayId(), mWinFrame,                    mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,                    mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel);//appç«¯åˆ°æœåŠ¡ç«¯//è°ƒç”¨æœåŠ¡ç«¯é€šè¿‡IWindowSession,// IWindowSessionåœ¨serverç«¯çš„å®ç°æ˜¯Sessionfinal IWindowSession mWindowSession;final class Session extends IWindowSession.Stub{    //è¿è¡Œåœ¨system_serverè¿›ç¨‹ï¼Œæ˜¯system_serverçš„binderæœåŠ¡ç«¯}//æœåŠ¡ç«¯åˆ°appç«¯//æ§åˆ¶appç«¯é€šè¿‡IWindowï¼Œappç«¯æä¾›çš„å®ç°å°±æ˜¯Wã€‚final W mWindow;static class W extends IWindow.Stub{    //è¿è¡Œåœ¨appè¿›ç¨‹ï¼Œæ˜¯appç«¯çš„ViewRootImpl.WæœåŠ¡çš„binderä»£ç†å¯¹è±¡    //è¿™ä¸ªWçš„æ„é€ å‡½æ•°æŠŠViewRootImplç”¨weakReferenceåŒ…èµ·æ¥äº†ï¼Œè¿œç¨‹æœ‰æ¶ˆæ¯åˆ°è¾¾çš„æ—¶å€™å°±å»è°ƒç”¨viewRootImplçš„å¯¹åº”æ–¹æ³•}                    </code></pre><p>appç«¯é€šè¿‡IWindowSessionè°ƒç”¨WMSç«¯çš„æ–¹æ³•ï¼ŒWMSç«¯é€šè¿‡IWindow(WindowState.mClient)è°ƒç”¨appç«¯çš„æ–¹æ³•<br><img src="https://api1.foster66.xyz/static/imgs/window_manager_07.png" alt=""></p><h3 id="Windowè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„IPCæœåŠ¡"><a href="#Windowè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„IPCæœåŠ¡" class="headerlink" title="Windowè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„IPCæœåŠ¡"></a>Windowè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„IPCæœåŠ¡</h3><table><thead><tr><th>BinderæœåŠ¡ç«¯</th><th>æ¥å£</th><th>æ‰€åœ¨è¿›ç¨‹</th></tr></thead><tbody><tr><td>WindowManagerService</td><td>IWindowManager</td><td>system_server</td></tr><tr><td>Session</td><td>IWindowSession</td><td>system_server</td></tr><tr><td>ViewRootImpl.W</td><td>IWindow</td><td>appè¿›ç¨‹</td></tr><tr><td>ActivityRecord.Token</td><td>IApplicationToken</td><td>system_server</td></tr></tbody></table><p>ActivityRecord.Token:StartActivityé€šè¿‡binder callè¿›å…¥systemServerè¿›ç¨‹ï¼Œåœ¨AMSä¸­åˆ›å»ºç›¸åº”çš„ActivityRecord.Tokençš„æˆå‘˜å˜é‡appTokenï¼Œç„¶åå°†è¯¥å¯¹è±¡ä¼ é€’åˆ°ActivityThread.</p><p>Tokenè¿™ä¸ªä¸œè¥¿åœ¨å‡ å¤„å‡ºç°äº†ï¼Œ<br>Activityï¼ˆperformLaunchActivityä¸­çš„attachèµ‹å€¼ï¼Œå¯¹åº”AMSä¸­çš„ActivityRecordï¼‰<br>Window(attachæ–¹æ³•é‡Œçš„PhoneWindow.setWindowManagerå»èµ‹å€¼)<br>WindowManager.LayoutParams.token(ç”¨äºIPC)<br>ViewRootImpl, View, View.AttachInfoï¼ˆéƒ½æ˜¯åœ¨dispatchAttachToWindowçš„æ—¶å€™å»è®¾ç½®åˆ°attachInfoçš„ï¼‰ã€‚æ‰€ä»¥ä»»æ„çš„Viewåªè¦è¢«æ·»åŠ äº†ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰attachInfoï¼Œä¹Ÿå°±æœ‰äº†token(attachInfoé‡Œçš„tokenéƒ½æ˜¯ViewRootImplç»™çš„ï¼Œä¹Ÿå°±æ˜¯ViewRootImpl.Wè¿™ä¸ªclassçš„å®ä¾‹)</p><h3 id="ViewRootImplçš„traversal"><a href="#ViewRootImplçš„traversal" class="headerlink" title="ViewRootImplçš„traversal"></a>ViewRootImplçš„traversal</h3><p>ä¸Šé¢æ‰è®²åˆ°handleResumeActivityä¹‹ååˆ›å»ºäº†ä¸€ä¸ªViewRootImpl<br>æ ¹æ®<a href="http://androidxref.com/6.0.1_r10/xref/frameworks/base/core/java/android/app/ActivityThread.java#handleResumeActivity">6.0çš„ä»£ç </a></p><pre><code class="java">//ActivityThread.java public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward,            String reason) {      if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) {                r.window = r.activity.getWindow();//è¿™äº›ä¸œè¥¿éƒ½æ˜¯åœ¨onCreateé‡Œé¢å»åˆ›å»ºå‡ºæ¥çš„                View decor = r.window.getDecorView();                decor.setVisibility(View.INVISIBLE);                ViewManager wm = a.getWindowManager();                WindowManager.LayoutParams l = r.window.getAttributes();                a.mDecor = decor;                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;                l.softInputMode |= forwardBit;                if (a.mVisibleFromClient) {                    a.mWindowAdded = true;                    wm.addView(decor, l);//è¿™é‡Œèµ°è¿›WindowManagerGlobal.addView                }            // If the window has already been added, but during resume            // we started another activity, then don&#39;t yet make the            // window visible.            } else if (!willBeVisible) {                if (localLOGV) Slog.v(                    TAG, &quot;Launch &quot; + r + &quot; mStartedActivity set&quot;);                r.hideForNow = true;            } } }</code></pre><p>å¥½åƒè¿˜æ²¡æœ‰scheduleTraversalå‘¢ã€‚æ¥ç€çœ‹ï¼Œåœ¨WindowManagerGlobalçš„addViewé‡Œé¢åˆ›å»ºäº†ViewRootImplï¼Œåè€…åœ¨setViewçš„æ—¶å€™:</p><pre><code class="java">//WindowManagerGlobal.javaroot = new ViewRootImpl(view.getContext(), display);view.setLayoutParams(wparams);//è¿™é‡Œé¢ç›´æ¥ä¸€ä¸ªrequestLayout//ViewRootImpl.java// Schedule the first layout -before- adding to the windowpublic void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {       // Schedule the first layout -before- adding to the window    // manager, to make sure we do the relayout before receiving    // any other events from the system.    requestLayout(); //è¿™é‡Œåˆè¿›è¡Œäº†ä¸€æ¬¡requestLayout    //è¿™åé¢æ‰æ˜¯å»ipc    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,        getHostVisibility(), mDisplay.getDisplayId(), mWinFrame,        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,        mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel);}//æ¥çœ‹çœ‹ViewRootImplçš„requestLayoutï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ViewParentæ¥å£çš„@Overridepublic void requestLayout() {    if (!mHandlingLayoutInLayoutRequest) {        checkThread();        mLayoutRequested = true;        scheduleTraversals();//ç›´æ¥scheduleTraversaläº†    }}</code></pre><p>scheduleTraversalsé‡Œé¢å°±æ˜¯</p><pre><code class="java">//ViewRootImpl.javavoid scheduleTraversals() {    if (!mTraversalScheduled) {        mTraversalScheduled = true;        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();//PostSyncBarrierï¼Œè¿™ä¹‹ååªæœ‰å¼‚æ­¥æ¶ˆæ¯æ‰èƒ½é€šè¿‡ï¼        mChoreographer.postCallback(                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); // mDisplayEventReceiver.scheduleVsync();è¯·æ±‚ç¡¬ä»¶ç³»ç»ŸVSyncä¿¡å·    }}</code></pre><p>æ¥ä¸‹æ¥å°±æ˜¯mDisplayEventReceiver.onVsyncçš„æ—¶å€™å»doFrame</p><pre><code class="java">//Choreographer.java try {        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;Choreographer#doFrame&quot;);        AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);        mFrameInfo.markInputHandlingStart();        doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos); //æœ€å…ˆå¤„ç†INPUT        mFrameInfo.markAnimationsStart();        doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);//éšåæ˜¯animation        mFrameInfo.markPerformTraversalsStart();        doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);//ç¬¬ä¸‰ä¸ªæ˜¯ViewRootImpl.doTraversalï¼Œåœ¨è¿™é‡ŒViewRootImplä¼šè§£é™¤postSyncBarrier        doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);    } finally {        AnimationUtils.unlockAnimationClock();        Trace.traceEnd(Trace.TRACE_TAG_VIEW);    }</code></pre><p>è¿™æ ·çœ‹æ¥ï¼Œåœ¨ç¬¬ä¸€æ¬¡handleResumeActivityçš„æ—¶å€™ï¼ŒChoreographerä¼šä¸»åŠ¨è®¾å®šä¸€æ¬¡traversalï¼Œåç»­çš„measure,layout,drawä¹Ÿå°±é¡ºç†æˆç« äº†</p><h3 id="Dialog"><a href="#Dialog" class="headerlink" title="Dialog"></a>Dialog</h3><p>å­çª—å£çš„è¯,å…¸å‹çš„ä¾‹å­æ˜¯dialogã€‚ç›´æ¥ä½¿ç”¨Activityçš„windowManagerå’ŒWMSäº¤äº’<br>Dialogçš„æ„é€ å‡½æ•°ä¸­</p><pre><code class="java">//Dialog.java Dialog(@NonNull Context context, @StyleRes int themeResId, boolean createContextThemeWrapper) {    mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);     // æ­¤æ—¶æ‹¿åˆ°çš„æ˜¯Activityçš„windowManager    final Window w = new PhoneWindow(mContext);    mWindow = w;    w.setCallback(this);    w.setWindowManager(mWindowManager, null, null);//è¿™ä¸€æ®µæ˜¯ä¸ºè¿™ä¸ªnewå‡ºæ¥çš„PhoneWindowè®¾ç½®ä¸€ä¸ªwindownManagerã€‚    //ä¹Ÿå°±æ˜¯è¯´Dialogçš„æ˜¾ç¤ºå…¶å®æ˜¯ä½¿ç”¨äº†Activityçš„windowManagerå»è°ƒç”¨WMSçš„æœåŠ¡çš„ï¼Œè€ŒDialogè‡ªèº«çš„windowç”±äºæ²¡æœ‰tokenï¼Œæ‰€ä»¥è¿™ä¸ªwindowå¹¶ä¸èƒ½ç”¨äºå’ŒWMSäº¤äº’ã€‚æ›´å¤šçš„æ˜¯ç”¨äºæŒæœ‰DecorView(æ–°çš„windowçš„DecorView),ç­‰åˆ°iputäº‹ä»¶æ¥åˆ°æ—¶ï¼Œä¼šé€šè¿‡ViewRootImplä¼ é€’åˆ°DecorView(æ–°çš„windowçš„DecorView)ï¼ŒDecorViewå†äº¤ç»™WindowCallback. } //Activity.java void attach(){      mWindow.setWindowManager(                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),                mToken, mComponent.flattenToString(),                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); } //Activity.java  @Override    public Object getSystemService(@ServiceName @NonNull String name) {        if (WINDOW_SERVICE.equals(name)) {            return mWindowManager; //..Activityç›´æ¥åœ¨è¿™é‡Œè®©Dialogè·å–åˆ°è‡ªå·±çš„windowManagerï¼ˆå…¶å¯¹åº”çš„windowå·²ç»å¡«å……å¥½mAppTokenäº†ï¼‰        }        return super.getSystemService(name);    }</code></pre><p><strong>å¦‚æœæ²¡æœ‰tokençš„è¯ï¼ŒViewRootImpl.setViewæ–¹æ³•ä¼šåœ¨è¿œç¨‹å¤±è´¥ã€‚åœ¨Dialog.showä¸­è°ƒç”¨äº†mWindowManager.addView(mDecor, l);è¿™ä¸ªmWindowManagerå…¶å®å·²ç»æ˜¯Activityçš„mWindowManageräº†ã€‚æ‰€ä»¥å¯¹è¿™ä¸ªmWindowManager(å†…éƒ¨ç”¨mParentWindowï¼Œå³Activityçš„window)è°ƒç”¨addViewæ–¹æ³•ã€‚åœ¨WindowManagerGlobalçš„addViewä¸­æœ‰adjustLayoutParamsForSubWindowè¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæœ€é‡è¦çš„å°±æ˜¯ç»™WindowManager.LayoutParams.tokenèµ‹å€¼ã€‚<br>mWindowManager.addView(mDecor, l); -&gt; WindowManagerGlobal.addView -&gt; Window.adjustLayoutParamsForSubWindow(å°±æ˜¯åœ¨è¿™é‡Œä»Activityçš„windowä¸­å–å‡ºtokenèµ‹å€¼ç»™layoutParamsçš„)</strong></p><p>WindowManager.LayoutParamsä¸­æœ‰ä¸‰ç§çª—å£ç±»å‹type</p><ol><li>åº”ç”¨ç¨‹åºçª—å£ï¼šFIRST_APPLICATION_WINDOW - LAST_APPLICATION_WINDOW (1-99)ã€‚ Activityçš„window,Dialogçš„window</li><li>å­çª—å£: FIRST_SUB_WINDOW - LAST_SUB_WINDOW (1000-1999). ä¾‹å¦‚PopupWindowï¼ŒContextMenuï¼ŒoptionMenuã€‚å­çª—å£å¿…é¡»è¦æœ‰ä¸€ä¸ªçˆ¶çª—å£ï¼Œçˆ¶çª—å£å¯ä»¥æ˜¯åº”ç”¨ç¨‹åºçª—å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»æ„ç±»å‹ã€‚çˆ¶çª—å£çš„ä¸å¯è§æ—¶ï¼Œå­çª—å£ä¸å¯è§</li><li>ç³»ç»Ÿçª—å£: FIRST_SYSTEM_WINDOW - LAST_SYSTEM_WINDOW (2000 -2999) Toastï¼Œè¾“å…¥æ³•ç­‰ç­‰ã€‚ç³»ç»Ÿçª—å£ä¸éœ€è¦å¯¹åº”Activityï¼Œæ¯”å¦‚TYPE_SYSTEM_ALERTï¼ŒçŠ¶æ€æ ï¼Œæ¥ç”µæ˜¾ç¤ºï¼Œå±ä¿ç­‰</li></ol><pre><code class="java">// Window.java å½“å‰å®ä¾‹æ˜¯Activityçš„PhoneWindowï¼Œå…¶æˆå‘˜å˜é‡mAppTokenåœ¨activityçš„attachä¸­å°±åˆå§‹åŒ–äº†ï¼Œdebugå‘ç°æ˜¯BinderProxyå®ä¾‹void adjustLayoutParamsForSubWindow(WindowManager.LayoutParams wp) {     if (wp.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;                wp.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) {            //1000-1999 //            if (wp.token == null) {                View decor = peekDecorView();                if (decor != null) {                    wp.token = decor.getWindowToken();//ä»mAttachInfo.mWindowTokenè·å–                }            }        } else if (wp.type &gt;= WindowManager.LayoutParams.FIRST_SYSTEM_WINDOW &amp;&amp;                wp.type &lt;= WindowManager.LayoutParams.LAST_SYSTEM_WINDOW) {            //ç³»ç»Ÿwindow 2000-2999        } else {            //dialogçš„typeå› ä¸ºæ˜¯2ï¼Œæ‰€ä»¥èµ°åˆ°è¿™é‡Œ            if (wp.token == null) {                wp.token = mContainer == null ? mAppToken : mContainer.mAppToken;//Dialogä¼šèµ°åˆ°è¿™é‡Œï¼ŒmAppTokenä¸ä¸ºnull            }        }}</code></pre><h3 id="PopupWindow"><a href="#PopupWindow" class="headerlink" title="PopupWindow"></a>PopupWindow</h3><pre><code class="java">//popupwindowçš„LayoutParams.typeé»˜è®¤æ˜¯private int mWindowLayoutType = WindowManager.LayoutParams.TYPE_APPLICATION_PANEL;// 1000//å¯ä»¥ä¿®æ”¹çš„//PopupWindow.javapublic void showAsDropDown(View anchor, int xoff, int yoff, int gravity) {     final WindowManager.LayoutParams p =                createPopupLayoutParams(anchor.getApplicationWindowToken());}public void showAtLocation(View parent, int gravity, int x, int y) {    mParentRootView = new WeakReference&lt;&gt;(parent.getRootView());    showAtLocation(parent.getWindowToken(), gravity, x, y);}</code></pre><p>å¯ä»¥å‘ç°æ— è®ºæ˜¯showAsDropDownè¿˜æ˜¯showAtLocationå…¨éƒ½æ˜¯éœ€è¦ä»anchorViewæ‹¿åˆ°windowTokençš„   </p><pre><code class="java">  private void invokePopup(WindowManager.LayoutParams p) {        mWindowManager.addView(decorView, p); //è¿™æ—¶å€™çš„på·²ç»å¡«å……äº†token    }</code></pre><h3 id="Toast"><a href="#Toast" class="headerlink" title="Toast"></a>Toast</h3><p>ç”¨IPCå¾€NotificationManagerServiceçš„ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªrunnableï¼Œç³»ç»Ÿå…¨å±€æ‰€æœ‰åº”ç”¨çš„Toastè¯·æ±‚éƒ½è¢«æ·»åŠ åˆ°è¿™é‡Œï¼Œæ’é˜Ÿï¼Œä¸€ä¸ªä¸ªæ¥ï¼Œè¿œç¨‹å†å›è°ƒappè¿›ç¨‹çš„Toast.TN(extends ITransientNotification.Stub)çš„handleShowæ–¹æ³•å»æ·»åŠ ä¸€ä¸ªtypeä¸ºWindowManager.LayoutPrams.TYPE_TOASTçš„viewã€‚<br>å½“ç„¶ï¼Œæ—¶é—´åˆ°äº†è¿œç¨‹è¿˜ä¼šå›è°ƒcancelToastå»ç”¨WMSç§»é™¤Viewã€‚</p><h2 id="doTraversal"><a href="#doTraversal" class="headerlink" title="doTraversal"></a>doTraversal</h2><p>ViewRootImplä¸­çš„doTraversalå¯ä»¥åˆ†æˆä¸‰ä»¶äº‹</p><p>mView.performMeasure<br>mView.performLayout<br>mView.performDraw</p><p>è¿™é‡Œçš„mViewä¹Ÿå°±æ˜¯DecorViewäº†</p><h3 id="measure"><a href="#measure" class="headerlink" title="measure"></a>measure</h3><pre><code class="java">//onMeasureé‡Œçš„ä¸¤ä¸ªå‚æ•°witdthMeasureSpecå’ŒheightMeasureSpecæ˜¯æ€ä¹ˆæ¥çš„  @Override    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {    }//ViewGroup.javaä¸­æœ‰è¿™ä¹ˆä¸€æ®µprotected void measureChildWithMargins(View child,        int parentWidthMeasureSpec, int widthUsed,        int parentHeightMeasureSpec, int heightUsed) {    final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();    final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin                    + widthUsed, lp.width);    final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin                    + heightUsed, lp.height);    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);}//ViewGroup.javapublic static int getChildMeasureSpec(int spec, int padding, int childDimension) { //è¿™ä¸ªchildDimensionå°±æ˜¯lp.widthæˆ–è€…lp.height    int specMode = MeasureSpec.getMode(spec);    int specSize = MeasureSpec.getSize(spec);    int size = Math.max(0, specSize - padding);     //æ‰€ä»¥è¿™ä¸ªsizeå°±æ˜¯å½“å‰è¿™ä¸ªviewGroupçš„measureSpecä¸­çš„size-viewgroupçš„padding-child.lp.marginä¹‹åçš„å€¼    int resultSize = 0;    int resultMode = 0;    switch (specMode) {    // Parent has imposed an exact size on us    case MeasureSpec.EXACTLY:        if (childDimension &gt;= 0) { //å¦‚æœè‡ªå·±æ˜¯EXACTLYï¼Œchildçš„lp.widthæˆ–è€…lp.height&gt;0çš„è¯ï¼Œç”Ÿæˆä¸€ä¸ªsizeä¸ºdimensionåªï¼Œmodeä¸ºEXACTLYçš„ spec            resultSize = childDimension;            resultMode = MeasureSpec.EXACTLY;        } else if (childDimension == LayoutParams.MATCH_PARENT) {            // Child wants to be our size. So be it.            resultSize = size;            resultMode = MeasureSpec.EXACTLY;        } else if (childDimension == LayoutParams.WRAP_CONTENT) {            // Child wants to determine its own size. It can&#39;t be            // bigger than us.            resultSize = size;            resultMode = MeasureSpec.AT_MOST;        }        break;    // Parent has imposed a maximum size on us    case MeasureSpec.AT_MOST:        if (childDimension &gt;= 0) {            // Child wants a specific size... so be it            resultSize = childDimension;            resultMode = MeasureSpec.EXACTLY;        } else if (childDimension == LayoutParams.MATCH_PARENT) {            // Child wants to be our size, but our size is not fixed.            // Constrain child to not be bigger than us.            resultSize = size;            resultMode = MeasureSpec.AT_MOST;        } else if (childDimension == LayoutParams.WRAP_CONTENT) {            // Child wants to determine its own size. It can&#39;t be            // bigger than us.            resultSize = size;            resultMode = MeasureSpec.AT_MOST;        }        break;    return MeasureSpec.makeMeasureSpec(resultSize, resultMode);}</code></pre><h3 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h3><p>è¿™é‡Œå°±æ˜¯è°ƒç”¨onLayoutæ–¹æ³•äº†ï¼ŒFrameLayoutä¼šæ ¹æ®childçš„Gravityæ¨ªå‘æˆ–è€…çºµå‘æ‘†æ”¾ã€‚LinearLayoutä¼šæ ¹æ®è‡ªå·±çš„orientationï¼Œä»ä¸Šåˆ°ä¸‹æˆ–è€…ä»å·¦åˆ°å³è¿›è¡Œæ‘†æ”¾ã€‚</p><h3 id="draw"><a href="#draw" class="headerlink" title="draw"></a>draw</h3><pre><code class="java">public void draw(Canvas canvas) {  . . .   // ç»˜åˆ¶èƒŒæ™¯ï¼Œåªæœ‰dirtyOpaqueä¸ºfalseæ—¶æ‰è¿›è¡Œç»˜åˆ¶ï¼Œä¸‹åŒ  int saveCount;  if (!dirtyOpaque) {    drawBackground(canvas);  }  . . .   // ç»˜åˆ¶è‡ªèº«å†…å®¹  if (!dirtyOpaque) onDraw(canvas);  // ç»˜åˆ¶å­View  dispatchDraw(canvas);   . . .  // ç»˜åˆ¶æ»šåŠ¨æ¡ç­‰  onDrawForeground(canvas);}</code></pre><p>drawçš„åŸºæœ¬æµç¨‹æ˜¯è¿™æ ·ï¼Œè¿™ä¸ªcanvasæ˜¯ViewRootImplä¸­çš„canvas = mSurface.lockCanvas(dirty);è·å¾—çš„ã€‚ä¸ªäººç†è§£Canvasæ˜¯å­˜å‚¨äº†ä¸€ç³»åˆ—çš„æŒ‡ä»¤ï¼Œå†äº¤ç»™surface</p><h3 id="Choregrapher"><a href="#Choregrapher" class="headerlink" title="Choregrapher"></a>Choregrapher</h3><p>Choregrapheré‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±»FrameDisplayEventReceiver(ç»§æ‰¿è‡ªDisplayEventReceiverï¼ŒDisplayEventReceiveræ˜¯ä¸€ä¸ªæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»)ï¼Œä¸»è¦æä¾›ä¸¤ä¸ªæ–¹æ³•nativeScheduleVsyncå’ŒonVsyncã€‚<br>FrameDisplayEventReceiveråœ¨onVsyncçš„æ—¶å€™ä¼špostä¸€ä¸ªå¼‚æ­¥(ä¹Ÿå°±æ˜¯è¯´ä¸å—syncBarrieré˜»æ‹¦)çš„æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ä¸Šå»è°ƒç”¨Choregrapherçš„doFrameï¼ˆè¿™é‡Œé¢å°±æ˜¯æŠŠä¹‹å‰æ‰€æœ‰é€šè¿‡Choregrapher.postCallbackæ·»åŠ åˆ°é˜Ÿåˆ—çš„äº‹ä»¶æ‹¿å‡ºæ¥ï¼Œåˆ°æœŸäº†å°±æ‰§è¡Œï¼‰</p><p>ä¸»çº¿ç¨‹çš„MessageQueueè¢«syncBarrierå µä½çš„æ˜¾è‘—ç‰¹å¾æ˜¯msg.target==null(ä¹Ÿå°±æ˜¯å¯¹åº”çš„handlerä¸ºnull).  ViewRootImplåœ¨scheduleTraversalsçš„æ—¶å€™ä¼špostSyncBarrierä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªdoTraversalæ˜¯é«˜ä¼˜å…ˆçº§çš„ï¼Œè¿™ä¸€åˆ»èµ·åé¢çš„æ‰€æœ‰ä¸¢åˆ°ä¸»çº¿ç¨‹ä¸Šçš„msgéƒ½è¦ç­‰åˆ°æˆ‘doTraversalå®Œæˆåæ‰æ‰§è¡Œ(å¼‚æ­¥æ¶ˆæ¯ä¾‹å¤–ï¼Œæ‰€ä»¥ä¸Šé¢onVsyncçš„æ¶ˆæ¯å¾—æ˜¯å¼‚æ­¥çš„)ã€‚ä»æ—¶é—´é¡ºåºä¸Šæ¥è®²ï¼Œ<br>ViewRootImpl.scheduleTraversal -&gt; mChoreographer.postCallback -&gt; Choreographerå¼€å§‹scheduleFrameLockedï¼ˆå‡å¦‚æ—¶é—´åˆ°äº†ï¼Œç›´æ¥è°ƒç”¨nativeScheduleVsyncï¼Œå¦åˆ™å‘é€çš„msgå…¨éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå°±æ˜¯ä¸ºäº†è·¨è¿‡ä¹‹å‰çš„barrier.ï¼‰åŒæ ·ï¼Œåœ¨onVsyncçš„æ—¶å€™ï¼Œç”±äºæ­¤æ—¶çš„barrierè¿˜æ²¡ç§»é™¤ï¼Œæ‰€ä»¥å‘å‡ºçš„æ¶ˆæ¯è¿˜å¾—æ˜¯å¼‚æ­¥çš„ã€‚doFrameé‡Œé¢ï¼Œä¸¥æ ¼æŒ‰ç…§input -&gt; animation -&gt; traversalçš„ç±»å‹å»æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯viewRootImplåœ¨scheduleTraversalsçš„æ—¶å€™postçš„callbackè¦è€è€å®å®åœ¨ç¬¬ä¸‰ç»„è¢«æ‰§è¡Œã€‚è€Œåœ¨è½®åˆ°è¿™ä¸ªdoTraversalæ‰§è¡Œçš„æ—¶å€™ï¼Œç»ˆäºå¯ä»¥å»ç§»é™¤barrieräº†ã€‚</p><p>éœ€è¦æŒ‡æ˜çš„æ˜¯ï¼Œæ¯ä¸€æ¬¡scheduleTraversaléƒ½è¦è§¦å‘measure -&gt; layout -&gt; drawè¿™ä¸€å¥—ï¼Œæ‰€ä»¥ï¼Œè€—æ—¶æ˜¯å¾ˆä¸¥é‡çš„ã€‚vsyncä¿¡å·ä¹Ÿä¸æ˜¯ç³»ç»Ÿä¸»åŠ¨å‘å‡ºçš„ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡nativeScheduleVsyncè¯·æ±‚ï¼Œæ‰ä¼šæœ‰ä¸€æ¬¡onVsyncçš„ç›¸åº”çš„ã€‚çœ‹äº†ä¸€ä¸‹ï¼ŒViewRootImplé‡Œé¢çš„setLayoutParamsï¼Œinvalidate,requestLayout,requestFitSystemWindowsç­‰æ–¹æ³•é‡Œé¢éƒ½ä¼šè§¦å‘scheduleTraversalã€‚ æ˜¾ç„¶åœ¨onCreateçš„setContentViewé‡Œé¢ä¼šè‡³å°‘è°ƒç”¨ä¸€æ¬¡ã€‚ç„¶åå°±æ˜¯ç†Ÿæ‚‰çš„performTraversal(measure,layout,draw)ã€‚</p><p>äººä»¬å¸¸è¯´åœ¨onCreateé‡Œé¢è·å–ä¸€ä¸ªViewçš„å®½é«˜æœ‰å››ç§æ–¹å¼ï¼š<br>onPreDraw,onLayoutChange,view.measure.<br>ç¬¬å››ç§å°±æ˜¯ç›´æ¥åœ¨setContentViewåé¢è·Ÿç€postä¸€ä¸ªmsgï¼ŒåŸç†å°±æ˜¯å‰é¢æœ‰ä¸€ä¸ªbarrierï¼Œè¿™ä¸ªbarrierè§£é™¤ä¹‹åæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªmsgå¤§æ¦‚ç‡å°±æ˜¯è¿™ä¸ªmsg(ä¸è€ƒè™‘åˆ«çš„çº¿ç¨‹è¿™ä¹ˆå·§ä¹Ÿæ’è¿›æ¥)ï¼Œè¿™æ—¶å€™ï¼ŒperformTraversalsåˆšåˆšèµ°å®Œï¼Œdrawä¹Ÿèµ°å®Œäº†,æœ€åç»˜åˆ¶æ•°æ®éƒ½ç¼“å­˜åˆ°Surfaceä¸Šã€‚ä½†æ˜¯systemServeré‚£è¾¹ï¼ŒwindowManagerServiceå’ŒsurfaceFlingeré‚£è¾¹è¿˜æ²¡æ¥å¾—åŠå¤„ç†è¿™äº›åˆšdrawçš„æ•°æ®ï¼ˆsurfaceFlingeré‚£è¾¹è¿˜è¦composeï¼Œæ²¡é‚£ä¹ˆå¿«å§ï¼‰ã€‚</p><h3 id="surfaceFlinger"><a href="#surfaceFlinger" class="headerlink" title="surfaceFlinger"></a>surfaceFlinger</h3><p>Androidæ˜¯é€šè¿‡ç³»ç»Ÿçº§è¿›ç¨‹ä¸­çš„SurfaceFlingeræœåŠ¡æ¥æŠŠçœŸæ­£éœ€è¦æ˜¾ç¤ºçš„æ•°æ®æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚SurfaceFlingerçš„ä¸»è¦å·¥ä½œæ˜¯ï¼š<br><img src="https://api1.foster66.xyz/static/imgs/window_manager_06.png" alt=""><br>å“åº”å®¢æˆ·ç«¯äº‹ä»¶ï¼Œåˆ›å»ºLayerä¸å®¢æˆ·ç«¯çš„Surfaceå»ºç«‹è¿æ¥ã€‚<br>æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®åŠå±æ€§ï¼Œä¿®æ”¹Layerå±æ€§ï¼Œå¦‚å°ºå¯¸ã€é¢œè‰²ã€é€æ˜åº¦ç­‰ã€‚<br>å°†åˆ›å»ºçš„Layerå†…å®¹åˆ·æ–°åˆ°å±å¹•ä¸Šã€‚<br>ç»´æŒLayerçš„åºåˆ—ï¼Œå¹¶å¯¹Layeræœ€ç»ˆè¾“å‡ºåšå‡ºè£å‰ªè®¡ç®—ã€‚<br>å› åº”ç”¨å±‚å’Œç³»ç»Ÿå±‚åˆ†åˆ«æ˜¯ä¸¤ä¸ªä¸åŒè¿›ç¨‹ï¼Œéœ€è¦ä¸€ä¸ªè·¨è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶æ¥å®ç°æ•°æ®ä¼ è¾“ï¼Œåœ¨Androidçš„æ˜¾ç¤ºç³»ç»Ÿä¸­ï¼Œä½¿ç”¨äº†Androidçš„åŒ¿åå…±äº«å†…å­˜ï¼šSharedClientã€‚æ¯ä¸€ä¸ªåº”ç”¨å’ŒSurfaceFlingerä¹‹é—´éƒ½ä¼šåˆ›å»ºä¸€ä¸ªSharedClientï¼Œæ¯ä¸ªSharedClientä¸­ï¼Œæœ€å¤šå¯ä»¥åˆ›å»º31ä¸ªSharedBufferStackï¼Œæ¯ä¸ªSurfaceéƒ½å¯¹åº”ä¸€ä¸ªSharedBufferStackï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªwindowã€‚è¿™æ„å‘³ç€ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºæœ€å¤šå¯ä»¥åŒ…å«31ä¸ªçª—å£ï¼ŒåŒæ—¶æ¯ä¸ªSharedBufferStackä¸­åˆåŒ…å«ä¸¤ä¸ª(&lt;4.1)æˆ–ä¸‰ä¸ª(&gt;=4.1)ç¼“å†²åŒºã€‚<br>åº”ç”¨å±‚ç»˜åˆ¶åˆ°ç¼“å†²åŒºï¼ŒSurfaceFlingeræŠŠç¼“å­˜åŒºæ•°æ®æ¸²æŸ“åˆ°å±å¹•ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ä½¿ç”¨Androidçš„åŒ¿åå…±äº«å†…å­˜SharedClientç¼“å­˜éœ€è¦æ˜¾ç¤ºçš„æ•°æ®ã€‚</p><p>WMSè·ŸsurfaceFlingeräº¤äº’çš„è¿‡ç¨‹æ˜¯ï¼ŒWMSå»ºç«‹SurfaceComposerClientï¼Œç„¶åä¼šåœ¨SFä¸­åˆ›å»ºClientä¸ä¹‹å¯¹åº”ï¼Œåç»­é€šè¿‡ISurfaceComposerClientä¸SFé€šä¿¡</p><p>APPå¯ä»¥æ²¡æœ‰Activty,PhoneWindow,DecorViewï¼Œä¾‹å¦‚å¸¦æ‚¬æµ®çª—çš„serviceã€‚</p><p><img src="https://api1.foster66.xyz/static/imgs/window_manager_03.jpeg" alt=""></p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://cloud.tencent.com/developer/article/1070984">å›¾ç‰‡å‡ºè‡ªBugly</a><br><a href="https://www.jianshu.com/p/060b5f68da79">æ·±å…¥ç†è§£Androidä¹‹Viewçš„ç»˜åˆ¶æµç¨‹</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è°ˆä¸€è°ˆViewçš„æ¸²æŸ“æµç¨‹å§&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/TamarackCones_EN-AU12178466392_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="android" scheme="https://haldir65.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>ndkå…¥é—¨ç¬”è®°</title>
    <link href="https://haldir65.github.io/2019/02/13/2019-02-13-ndk-related-topics/"/>
    <id>https://haldir65.github.io/2019/02/13/2019-02-13-ndk-related-topics/</id>
    <published>2019-02-13T18:25:01.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p>androidä¸­ndkåŠjniç¼–å†™æ³¨æ„äº‹é¡¹ï¼ˆæœ¬æ–‡ä¸»è¦è®²CMakeï¼‰<br><img src="https://api1.foster66.xyz/static/imgs/ShanwangpingKarst_EN-AU5360258756_1920x1080.jpg" alt=""><br><a id="more"></a><br>ä¸€äº›å°çªé—¨</p><blockquote><p>cmakeæœ€ç»ˆæ‰§è¡Œçš„å‘½ä»¤åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢.externalNativeBuild/cmake/debug/{abi}/cmake_build_command.txt<br>cmakeç”Ÿæˆçš„.soæ–‡ä»¶åœ¨â€\app\build\intermediates\cmake\debug\obj\arm64-v8aâ€è¿™ä¸ªè·¯å¾„ä¸‹ã€‚<br>CMake ä¸€å…±æœ‰2ç§ç¼–è¯‘å·¥å…·é“¾ - clang å’Œ gccï¼Œgcc å·²ç»åºŸå¼ƒï¼Œclang æ˜¯é»˜è®¤çš„ã€‚</p></blockquote><p><a href="https://developer.android.com/ndk/guides/">ndkå®˜æ–¹å…¥é—¨æŒ‡å—</a></p><p>cpuæ¶æ„</p><pre><code>armeabiarmeabiÂ­v7aarm64Â­v8ax86x86_64mipsmips64</code></pre><p>cmakeäº¤å‰ç¼–è¯‘</p><h3 id="abi-application-binary-interface"><a href="#abi-application-binary-interface" class="headerlink" title="abi(application binary interface)"></a>abi(application binary interface)</h3><p><a href="https://developer.android.com/ndk/guides/abis">abis</a><br>ndkæ”¯æŒçš„abiåŒ…æ‹¬<br>armeabiï¼Œarmeabi-v7aï¼Œarm64-v8aï¼Œx86ï¼Œx86_64ï¼Œmipsï¼Œmips64</p><p><strong><em>NDK 17 ä¸å†æ”¯æŒ ABI: armeabiã€mipsã€mips64</em></strong></p><p>x86è®¾å¤‡ä¸Šï¼Œlibs/x86ç›®å½•ä¸­å¦‚æœå­˜åœ¨.soæ–‡ä»¶çš„è¯ï¼Œä¼šè¢«å®‰è£…ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šé€‰æ‹©armeabi-v7aä¸­çš„.soæ–‡ä»¶ï¼Œå¦‚æœä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™é€‰æ‹©armeabiç›®å½•ä¸­çš„.soæ–‡ä»¶ã€‚</p><p>x86è®¾å¤‡èƒ½å¤Ÿå¾ˆå¥½çš„è¿è¡ŒARMç±»å‹å‡½æ•°åº“ï¼Œä½†å¹¶ä¸ä¿è¯100%ä¸å‘ç”Ÿcrashï¼Œç‰¹åˆ«æ˜¯å¯¹æ—§è®¾å¤‡ã€‚</p><p>64ä½è®¾å¤‡ï¼ˆarm64-v8a, x86_64, mips64ï¼‰èƒ½å¤Ÿè¿è¡Œ32ä½çš„å‡½æ•°åº“ï¼Œä½†æ˜¯ä»¥32ä½æ¨¡å¼è¿è¡Œï¼Œåœ¨64ä½å¹³å°ä¸Šè¿è¡Œ32ä½ç‰ˆæœ¬çš„ARTå’ŒAndroidç»„ä»¶ï¼Œå°†ä¸¢å¤±ä¸“ä¸º64ä½ä¼˜åŒ–è¿‡çš„æ€§èƒ½ï¼ˆARTï¼Œwebviewï¼Œmediaç­‰ç­‰ï¼‰ã€‚<br>æ‰€æœ‰çš„x86/x86_64/armeabi-v7a/arm64-v8aè®¾å¤‡éƒ½æ”¯æŒarmeabiæ¶æ„çš„.soæ–‡ä»¶ï¼Œå› æ­¤ä¼¼ä¹ç§»é™¤å…¶ä»–ABIsçš„.soæ–‡ä»¶æ˜¯ä¸€ä¸ªå‡å°‘APKå¤§å°çš„å¥½æŠ€å·§ã€‚</p><h3 id="abiFilter"><a href="#abiFilter" class="headerlink" title="abiFilter"></a>abiFilter</h3><p><a href="https://developer.android.com/studio/projects/gradle-external-native-builds">åªæƒ³è®©cmakeæ‰“arm64-v8aä¸€ç§archçš„åŒ…æ€ä¹ˆåŠ</a></p><blockquote><p>In most cases, you only need to specify abiFilters in the ndk block, as shown above, because it tells Gradle to both build and package those versions of your native libraries. However, if you want to control what Gradle should build, independently of what you want it to package into your APK, configure another abiFilters flag in the defaultConfig.externalNativeBuild.cmake block (or defaultConfig.externalNativeBuild.ndkBuild block). Gradle builds those ABI configurations but only packages the ones you specify in the defaultConfig.ndk block.</p></blockquote><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯</p><pre><code>android {  ...  defaultConfig {    ...    externalNativeBuild {      cmake {          abiFilters &quot;arm64-v8a&quot; //åªå¸®æˆ‘æ‰“è¿™ä¸ªæ¶æ„çš„å°±å¥½äº†      }      // or ndkBuild {...}    }    // Similar to other properties in the defaultConfig block,    // you can configure the ndk block for each product flavor    // in your build configuration.    ndk {      // Specifies the ABI configurations of your native      // libraries Gradle should build and package with your APK.      abiFilters &#39;x86&#39;, &#39;x86_64&#39;, &#39;armeabi&#39;, &#39;armeabi-v7a&#39;,                   &#39;arm64-v8a&#39; //è¿™äº›æ¶æ„çš„åŒ…æˆ‘å…¨éƒ¨éƒ½è¦æ‰“è¿›apké‡Œé¢    //å½“ç„¶ï¼Œå¦‚æœ externalNativeBuildé‡Œé¢åªæ‰“äº†arm64-v8açš„soæ–‡ä»¶ï¼Œè¿™ç§å†™æ³•å¯¼è‡´æœ€ç»ˆç”Ÿæˆçš„apké‡Œé¢è£…äº†x86ï¼Œx86_64..çš„soæ–‡ä»¶å¤¹ï¼Œä½†å…¶å®é‡Œé¢æ”¾çš„éƒ½æ˜¯arm64-v8açš„soï¼Œå½“ç„¶æ˜¯ä¸è¡Œçš„ã€‚    //é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸å†™abiFilterçš„è¯ï¼Œæ‰€æœ‰æ”¯æŒçš„abiå¯¹åº”çš„soæ–‡ä»¶éƒ½ä¼šæ‰“å‡ºæ¥ï¼Œå¤§å°ç•¥æœ‰å·®å¼‚    }  }  buildTypes {...}  // Use this block to link Gradle to your CMake or ndk-build script.ä¼¼ä¹åªæ˜¯ç”¨æ¥å‘Šè¯‰gradle CMakeList.txtçš„ä½ç½®åœ¨å“ªé‡Œ  externalNativeBuild {       cmake {            path &#39;CMakeLists.txt&#39; //è¿™ä¸ªæ˜¯è¯´æ˜CMakeLists.txtè¿™ä¸ªæ–‡ä»¶åœ¨å“ªé‡Œçš„ï¼Œstudio é‡Œé¢link project with c++ programå°±æ˜¯å¹²è¿™ä¸ªçš„        }  }}</code></pre><p><a href="https://rangaofei.github.io/2018/02/22/shellè„šæœ¬ç”Ÿæˆå®‰å“å…¨abiåŠ¨æ€åº“ä¸é™æ€åº“">æ‰€ä»¥ç°åœ¨çœ‹æ¥è¿™ç§æ‰‹åŠ¨è°ƒç”¨cmakeçš„æ–¹å¼ä¹Ÿæ²¡æœ‰å¤ªå¤§å¿…è¦äº†</a></p><h3 id="abiæ”¯æŒç¼ºå¤±å¯¼è‡´çš„crash"><a href="#abiæ”¯æŒç¼ºå¤±å¯¼è‡´çš„crash" class="headerlink" title="abiæ”¯æŒç¼ºå¤±å¯¼è‡´çš„crash"></a>abiæ”¯æŒç¼ºå¤±å¯¼è‡´çš„crash</h3><p>androidç¬¬ä¸‰æ–¹ sdkæ˜¯ä»¥aarå½¢å¼æä¾›çš„,ç”šè‡³æ˜¯è¿œç¨‹aarï¼Œå¦‚æœè¿™ä¸ªsdkå¯¹abiçš„æ”¯æŒæ¯”è¾ƒå…¨ï¼Œå¯èƒ½ä¼šåŒ…å«armeabi, armeabi-v7a,x86, arm64-v8a,x86_64äº”ç§abi,è€Œä½ åº”ç”¨çš„å…¶å®ƒsoåªæ”¯æŒarmeabi,armeabi-v7aï¼Œx86ä¸‰ç§ï¼Œç›´æ¥å¼•ç”¨sdkçš„aar,ä¼šè‡ªåŠ¨ç¼–è¯‘å‡ºæ”¯æŒ5ç§abiçš„åŒ…ã€‚ä½†æ˜¯åº”ç”¨çš„å…¶å®ƒsoç¼ºå°‘å¯¹å…¶å®ƒä¸¤ç§abiçš„æ”¯æŒï¼Œé‚£ä¹ˆå¦‚æœåº”ç”¨è¿è¡Œäºarm64-v8a,x86_64ä¸ºé¦–é€‰abiçš„è®¾å¤‡ä¸Šæ—¶ï¼Œå°±ä¼šCRASHã€‚<br>æ‰€ä»¥è§£å†³æ–¹æ³•å°±åˆ†ä¸¤ç§<br>ç¬¬ä¸€ç§ï¼š</p><pre><code>productFlavors {      necess {          ndk {              abiFilters &quot;armeabi-v7a&quot;              abiFilters &quot;x86&quot;              abiFilters &quot;armeabi&quot;          }      }      abiall {          ndk {              abiFilters &quot;armeabi-v7a&quot;              abiFilters &quot;x86&quot;              abiFilters &quot;armeabi&quot;              abiFilters &quot;arm64-v8a&quot;              abiFilters &quot;x86_64&quot;          }      }  }  </code></pre><p>ç¬¬äºŒç§ï¼š<br>app/build.gradleä¸­è¿™å¥è¯çš„æ„æ€æ˜¯æŒ‡è®©ç”Ÿæˆçš„apkä¸­åŒ…å«ä¸‹é¢ä¸‰ç§abiçš„soæ–‡ä»¶</p><pre><code class="gradle">defaultConfig {    ndk {        abiFilters &quot;armeabi&quot;, &quot;armeabi-v7a&quot;, &quot;arm64-v8a&quot;    }}</code></pre><p>åœ¨apkæ–‡ä»¶ä¸­ï¼Œsoæ–‡ä»¶æ”¾åœ¨lib/armeabi-v7a lib/x86_64 lib/x86 lib/arm64-v8aè¿™äº›æ–‡ä»¶å¤¹ä¸‹é¢</p><h3 id="æ·»åŠ prebuilt-library"><a href="#æ·»åŠ prebuilt-library" class="headerlink" title="æ·»åŠ prebuilt library"></a>æ·»åŠ prebuilt library</h3><p>Add other prebuilt libraries<br>åœ¨CMakeLists.txtä¸­æ·»åŠ <br>add_library( imported-lib<br>             SHARED<br>             IMPORTED )<br>å…³é”®è¯IMPORTED ï¼Œå°±æ‹¿ffmepgæ¥è¯´ï¼Œé¦–å…ˆåœ¨linuxä¸Šç¼–è¯‘å‡ºä¸åŒabiçš„soæ–‡ä»¶ï¼Œffmpegæœ‰å¥½å‡ ä¸ªsoæ–‡ä»¶ï¼Œæ¯”æ–¹è¯´libavcodec.soè¿™ä¸ªæ–‡ä»¶ã€‚</p><pre><code>Some libraries provide separate packages for specific CPU architectures, or Application Binary Interfaces (ABI), and organize them into separate directories. This approach helps libraries take advantage of certain CPU architectures while allowing you to use only the versions of the library you want. To add multiple ABI versions of a library to your CMake build script, without having to write multiple commands for each version of the library, you can use the ANDROID_ABI path variable. This variable uses a list of the default ABIs that the NDK supports, or a filtered list of ABIs you manually configure Gradle to use. </code></pre><p>æœ‰äº›ç¬¬ä¸‰æ–¹åº“é’ˆå¯¹ä¸åŒçš„cpuæ¶æ„æä¾›äº†ä¸åŒçš„soæ–‡ä»¶</p><pre><code># æ·»åŠ åº“â€”â€”å¤–éƒ¨å¼•å…¥çš„åº“# åº“åç§°ï¼šavcodecï¼ˆä¸éœ€è¦åŒ…å«å‰ç¼€libï¼‰# åº“ç±»å‹ï¼šSHAREDï¼Œè¡¨ç¤ºåŠ¨æ€åº“ï¼Œåç¼€ä¸º.soï¼ˆå¦‚æœæ˜¯STATICï¼Œåˆ™è¡¨ç¤ºé™æ€åº“ï¼Œåç¼€ä¸º.aï¼‰# IMPORTEDè¡¨æ˜æ˜¯å¤–éƒ¨å¼•å…¥çš„åº“set(distribution_DIR ../../../../libs) //è¿™ä¸ªlibsæ–‡ä»¶å¤¹åå­—éšä¾¿å–ï¼Œä¸‹é¢è¦åŒ…å«armeabi-v7a,x86,x86_64ç­‰ä½ æƒ³è¦æ”¯æŒçš„æ¶æ„å¯¹åº”çš„soæ–‡ä»¶ï¼ˆåœ¨Linuxä¸Šç¼–å‡ºæ¥çš„ï¼‰add_library( avcodec        SHARED        IMPORTED)set_target_properties( avcodec        PROPERTIES IMPORTED_LOCATION        ${distribution_DIR}/${ANDROID_ABI}/libavcodec.so) //æœ€ç»ˆgradleç¼–è¯‘çš„æ—¶å€™ä¼šæŠŠabiFilterä¸­æŒ‡å®šçš„cpuæ¶æ„ä¸€ä¸ªä¸ªå»å¯¹åº”çš„æ–‡ä»¶å¤¹å»æ‰¾soæ–‡ä»¶ï¼Œæ‰¾ä¸åˆ°å°±ä¼šæŠ¥é”™include_directories( avcodec/include/ )//å‘Šè¯‰cmakeï¼ŒæŠŠè¿™ä¸ªç›®å½•ä¸‹é¢çš„æ–‡ä»¶å½“åšå¤´æ–‡ä»¶æ‹¿è¿›æ¥ï¼Œä¸ç”¨è‡ªå·±ä¸€ä¸ªä¸ªå»copyäº†ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯recursiveçš„ï¼Œä¹Ÿå°±æ˜¯ç…§é¡¾ä¸åˆ°å­æ–‡ä»¶å¤¹//è¿™ä¸€æ­¥å°±æ˜¯Linkäº†target_link_libraries( native-lib //è¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±çš„libçš„åå­—        avcodec        avfilter        avformat        avutil        swresample        swscale        -landroid        ${log-lib} )        </code></pre><h3 id="é¢„å…ˆç¼–è¯‘å¥½çš„soæ–‡ä»¶æ”¾ç½®çš„ç›®å½•è¦å‘Šè¯‰gradle"><a href="#é¢„å…ˆç¼–è¯‘å¥½çš„soæ–‡ä»¶æ”¾ç½®çš„ç›®å½•è¦å‘Šè¯‰gradle" class="headerlink" title="é¢„å…ˆç¼–è¯‘å¥½çš„soæ–‡ä»¶æ”¾ç½®çš„ç›®å½•è¦å‘Šè¯‰gradle"></a>é¢„å…ˆç¼–è¯‘å¥½çš„soæ–‡ä»¶æ”¾ç½®çš„ç›®å½•è¦å‘Šè¯‰gradle</h3><blockquote><p>f you want Gradle to package prebuilt native libraries with your APK, modify the default source set configuration to include the directory of your prebuilt .so files, as shown below. Keep in mind, you donâ€™t need to do this to include artifacts of CMake build scripts that you link to Gradle.</p></blockquote><pre><code>android {    ...    sourceSets {        main {            jniLibs.srcDirs &#39;imported-lib/src/&#39;, &#39;more-imported-libs/src/&#39;        }    }}</code></pre><h3 id="è°ƒç”¨ndkçš„api"><a href="#è°ƒç”¨ndkçš„api" class="headerlink" title="è°ƒç”¨ndkçš„api"></a>è°ƒç”¨ndkçš„api</h3><p>æ¯”æ–¹è¯´è¿™ç§å¤´æ–‡ä»¶</p><pre><code class="c">#include &lt;android/native_window_jni.h&gt;#include &lt;android/cpu-features.h&gt;#include &lt;android/multinetwork.h&gt;</code></pre><p>native_window_jni åœ¨ndk çš„libandroid.soåº“ä¸­ï¼Œéœ€è¦åœ¨CMakeLists.txtä¸­å¼•å…¥androidåº“ï¼Œåƒè¿™æ ·</p><pre><code>target_link_libraries( my-lib        ...        -landroid        ${log-lib} )</code></pre><p>ä»<a href="https://www.jianshu.com/p/7a165b9f9fad">fmpeg+native_windowå®ç°ä¸‡èƒ½è§†é¢‘æ’­æ”¾å™¨æ’­æ”¾æœ¬åœ°è§†é¢‘</a>æŠ„æ¥ä¸€æ®µcppä»£ç </p><pre><code class="cpp"> extern &quot;C&quot; {    //ç¼–ç     #include &quot;libavcodec/avcodec.h&quot;    //å°è£…æ ¼å¼å¤„ç†    #include &quot;libavformat/avformat.h&quot;    //åƒç´ å¤„ç†    #include &quot;libswscale/swscale.h&quot;    //native_window_jni åœ¨ndk çš„libandroid.soåº“ä¸­ï¼Œéœ€è¦åœ¨CMakeLists.txtä¸­å¼•å…¥androidåº“    #include &lt;android/native_window_jni.h&gt;    #include &lt;unistd.h&gt;//sleepç”¨çš„å¤´æ–‡ä»¶    }    /**        *å°†ä»»æ„æ ¼å¼çš„è§†é¢‘åœ¨æ‰‹æœºä¸Šè¿›è¡Œæ’­æ”¾ï¼Œä½¿ç”¨nativeè¿›è¡Œç»˜åˆ¶        * env:è™šæ‹ŸæœºæŒ‡é’ˆ        * inputStrï¼šè§†é¢‘æ–‡ä»¶è·¯å¾„        * surface: ä»javaå±‚ä¼ é€’è¿‡æ¥çš„SurfaceViewçš„surfaceå¯¹è±¡         */    void ffmpegVideoPlayer(JNIEnv *env, char *inputStr, jobject surface) {        // 1.æ³¨å†Œå„å¤§ç»„ä»¶ï¼Œæ‰§è¡Œffmgpeéƒ½å¿…é¡»è°ƒç”¨æ­¤å‡½æ•°        av_register_all();        //2.å¾—åˆ°ä¸€ä¸ªffmpegçš„ä¸Šä¸‹æ–‡ï¼ˆä¸Šä¸‹æ–‡é‡Œé¢å°è£…äº†è§†é¢‘çš„æ¯”ç‰¹ç‡ï¼Œåˆ†è¾¨ç‡ç­‰ç­‰ä¿¡æ¯...éå¸¸é‡è¦ï¼‰        AVFormatContext *pContext = avformat_alloc_context();        //3.æ‰“å¼€ä¸€ä¸ªè§†é¢‘        if (avformat_open_input(&amp;pContext, inputStr, NULL, NULL) &lt; 0) {            LOGE(&quot;æ‰“å¼€å¤±è´¥&quot;);            return;        }        //4.è·å–è§†é¢‘ä¿¡æ¯ï¼ˆå°†è§†é¢‘ä¿¡æ¯å°è£…åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼‰        if (avformat_find_stream_info(pContext, NULL) &lt; 0) {            LOGE(&quot;è·å–ä¿¡æ¯å¤±è´¥&quot;);            return;        }        //5.ç”¨æ¥è®°ä½è§†é¢‘æµçš„ç´¢å¼•        int video_stream_idx = -1;        //ä»ä¸Šä¸‹æ–‡ä¸­å¯»æ‰¾æ‰¾åˆ°è§†é¢‘æµ        for (int i = 0; i &lt; pContext-&gt;nb_streams; ++i) {            LOGE(&quot;å¾ªç¯  %d&quot;, i);            //codecï¼šæ¯ä¸€ä¸ªæµ å¯¹åº”çš„è§£ç ä¸Šä¸‹æ–‡            //codec_typeï¼šæµçš„ç±»å‹            if (pContext-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {                //å¦‚æœæ‰¾åˆ°çš„æµç±»å‹ == AVMEDIA_TYPE_VIDEO å³è§†é¢‘æµï¼Œå°±å°†å…¶ç´¢å¼•ä¿å­˜ä¸‹æ¥                video_stream_idx = i;            }        }        //è·å–åˆ°è§£ç å™¨ä¸Šä¸‹æ–‡        AVCodecContext *pCodecCtx = pContext-&gt;streams[video_stream_idx]-&gt;codec;        //è·å–è§£ç å™¨ï¼ˆåŠ å¯†è§†é¢‘å°±æ˜¯åœ¨æ­¤å¤„æ— æ³•è·å–ï¼‰        AVCodec *pCodex = avcodec_find_decoder(pCodecCtx-&gt;codec_id);        LOGE(&quot;è·å–è§†é¢‘ç¼–ç  %p&quot;, pCodex);        //6.æ‰“å¼€è§£ç å™¨ã€‚ ï¼ˆffempgç‰ˆæœ¬å‡çº§åå­—å«åšavcodec_open2ï¼‰        if (avcodec_open2(pCodecCtx, pCodex, NULL) &lt; 0) {            LOGE(&quot;è§£ç å¤±è´¥&quot;);            return;        }        //----------------------è§£ç å‰å‡†å¤‡--------------------------------------        //å‡†å¤‡å¼€å§‹è§£ç æ—¶éœ€è¦ä¸€ä¸ªAVPacketå­˜å‚¨æ•°æ®ï¼ˆé€šè¿‡av_mallocåˆ†é…å†…å­˜ï¼‰        AVPacket *packet = (AVPacket *) av_malloc(sizeof(AVPacket));        av_init_packet(packet);//åˆå§‹åŒ–ç»“æ„ä½“        //è§£å°è£…éœ€è¦AVFrame        AVFrame *frame = av_frame_alloc();        //å£°æ˜ä¸€ä¸ªrgb_Frameçš„ç¼“å†²åŒº        AVFrame *rgb_Frame = av_frame_alloc();        //rgb_Frame  çš„ç¼“å†²åŒº åˆå§‹åŒ–        uint8_t *out_buffer = (uint8_t *) av_malloc(                avpicture_get_size(AV_PIX_FMT_RGBA, pCodecCtx-&gt;width, pCodecCtx-&gt;height));        //ç»™ç¼“å†²åŒºè¿›è¡Œæ›¿æ¢        int re = avpicture_fill((AVPicture *) rgb_Frame, out_buffer, AV_PIX_FMT_RGBA, pCodecCtx-&gt;width,                                pCodecCtx-&gt;height);        LOGE(&quot;å®½ %d  é«˜ %d&quot;, pCodecCtx-&gt;width, pCodecCtx-&gt;height);        //æ ¼å¼è½¬ç éœ€è¦çš„è½¬æ¢ä¸Šä¸‹æ–‡ï¼ˆæ ¹æ®å°è£…æ ¼å¼çš„å®½é«˜å’Œç¼–ç æ ¼å¼ï¼Œä»¥åŠéœ€è¦å¾—åˆ°çš„æ ¼å¼çš„å®½é«˜ï¼‰        //pCodecCtx-&gt;pix_fmt å°è£…æ ¼å¼æ–‡ä»¶çš„ä¸Šä¸‹æ–‡        //AV_PIX_FMT_RGBA ï¼š ç›®æ ‡æ ¼å¼ éœ€è¦è·ŸSurfaceViewè®¾å®šçš„æ ¼å¼ç›¸åŒ        //SWS_BICUBIC ï¼šæ¸…æ™°åº¦ç¨å¾®ä½ä¸€ç‚¹çš„ç®—æ³•ï¼ˆè½¬æ¢ç®—æ³•ï¼Œå‰é¢çš„ç®—æ³•æ¸…æ™°åº¦é«˜æ•ˆç‡ä½ï¼Œä¸‹é¢çš„ç®—æ³•æ¸…æ™°åº¦ä½æ•ˆç‡é«˜ï¼‰         //NULL,NULL,NULL ï¼š è¿‡æ»¤å™¨ç­‰        SwsContext *swsContext = sws_getContext(pCodecCtx-&gt;width, pCodecCtx-&gt;height, pCodecCtx-&gt;pix_fmt,                                                pCodecCtx-&gt;width, pCodecCtx-&gt;height, AV_PIX_FMT_RGBA,                                                SWS_BICUBIC, NULL, NULL, NULL        );        int frameCount = 0;        //è·å–nativeWindowå¯¹è±¡,å‡†å¤‡è¿›è¡Œç»˜åˆ¶        ANativeWindow *nativeWindow = ANativeWindow_fromSurface(env, surface);        ANativeWindow_Buffer outBuffer;//ç”³æ˜ä¸€å—ç¼“å†²åŒº ç”¨äºç»˜åˆ¶        //------------------------ä¸€æ¡¢ä¸€å¸§å¼€å§‹è§£ç --------------------        int length = 0;        int got_frame;        while (av_read_frame(pContext, packet) &gt;= 0) {//å¼€å§‹è¯»æ¯ä¸€å¸§çš„æ•°æ®            if (packet-&gt;stream_index == video_stream_idx) {//å¦‚æœè¿™æ˜¯ä¸€ä¸ªè§†é¢‘æµ                //7.è§£å°è£…ï¼ˆå°†packetè§£å‹ç»™frameï¼Œå³ï¼šæ‹¿åˆ°äº†è§†é¢‘æ•°æ®frameï¼‰                length = avcodec_decode_video2(pCodecCtx, frame, &amp;got_frame, packet);//è§£å°è£…å‡½æ•°                LOGE(&quot; è·å¾—é•¿åº¦   %d è§£ç %d  &quot;, length, frameCount++);                if (got_frame &gt; 0) {                    //8.å‡†å¤‡ç»˜åˆ¶                    //é…ç½®ç»˜åˆ¶ä¿¡æ¯ å®½é«˜ æ ¼å¼(è¿™ä¸ªç»˜åˆ¶çš„å®½é«˜ç›´æ¥å†³å®šäº†è§†é¢‘åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„æƒ…å†µï¼Œè¿™æ ·ä¼šå¹³é“ºæ•´ä¸ªå±å¹•ï¼Œå¯ä»¥æ ¹æ®ç‰¹å®šçš„å±å¹•åˆ†è¾¨ç‡å’Œè§†é¢‘å®½é«˜è¿›è¡ŒåŒ¹é…)                    ANativeWindow_setBuffersGeometry(nativeWindow, pCodecCtx-&gt;width, pCodecCtx-&gt;height,                                                     WINDOW_FORMAT_RGBA_8888);                    ANativeWindow_lock(nativeWindow, &amp;outBuffer, NULL);//é”å®šç”»å¸ƒ(outBufferä¸­å°†ä¼šå¾—åˆ°æ•°æ®)                    //9.è½¬ç ï¼ˆè½¬ç ä¸Šä¸‹æ–‡ï¼ŒåŸæ•°æ®ï¼Œä¸€è¡Œæ•°æ®ï¼Œå¼€å§‹ä½ç½®ï¼Œyuvçš„ç¼“å†²æ•°ç»„ï¼Œyuvä¸€è¡Œçš„æ•°æ®ï¼‰                    sws_scale(swsContext, (const uint8_t *const *) frame-&gt;data, frame-&gt;linesize, 0,                              frame-&gt;height, rgb_Frame-&gt;data,                              rgb_Frame-&gt;linesize                    );                    //10.ç»˜åˆ¶                    uint8_t *dst = (uint8_t *) outBuffer.bits; //å®é™…çš„ä½æ•°                    int destStride = outBuffer.stride * 4; //æ‹¿åˆ°ä¸€è¡Œæœ‰å¤šå°‘ä¸ªå­—èŠ‚ RGBA                    uint8_t *src = (uint8_t *) rgb_Frame-&gt;data[0];//åƒç´ æ•°æ®çš„é¦–åœ°å€                    int srcStride = rgb_Frame-&gt;linesize[0]; //å®é™…å†…å­˜ä¸€è¡Œçš„æ•°é‡                    for (int i = 0; i &lt; pCodecCtx-&gt;height; ++i) {                        //å°†rgb_Frameç¼“å†²åŒºé‡Œé¢çš„æ•°æ®ä¸€è¡Œä¸€è¡Œcopyåˆ°windowçš„ç¼“å†²åŒºé‡Œé¢                        //copyåˆ°windowç¼“å†²åŒºçš„æ—¶å€™è¿›è¡Œä¸€äº›åç§»è®¾ç½®å¯ä»¥å°†è§†é¢‘æ’­æ”¾å±…ä¸­                        memcpy(dst + i * destStride, src + i * srcStride, srcStride);                    }                    ANativeWindow_unlockAndPost(nativeWindow);//è§£é”ç”»å¸ƒ                    usleep(1000 * 16);//å¯ä»¥æ ¹æ®å¸§ç‡ä¼‘çœ 16ms                }            }            av_free_packet(packet);//é‡Šæ”¾        }        ANativeWindow_release(nativeWindow);//é‡Šæ”¾window        av_frame_free(&amp;frame);        av_frame_free(&amp;rgb_Frame);        avcodec_close(pCodecCtx);        avformat_free_context(pContext);        free(inputStr);    }</code></pre><h3 id="ffmpegç§»æ¤åˆ°Androidä¸Šï¼ˆå¤šä¸ªabiï¼‰"><a href="#ffmpegç§»æ¤åˆ°Androidä¸Šï¼ˆå¤šä¸ªabiï¼‰" class="headerlink" title="ffmpegç§»æ¤åˆ°Androidä¸Šï¼ˆå¤šä¸ªabiï¼‰"></a>ffmpegç§»æ¤åˆ°Androidä¸Šï¼ˆå¤šä¸ªabiï¼‰</h3><p><a href="https://github.com/ejoker88/FFmpeg-3.4-Android">é¦–å…ˆæ˜¯ç¼–è¯‘ä¸åŒæ¶æ„çš„ffmpeg library</a><br>è¿™ä¸ªåº“ä½¿ç”¨äº†FFmpeg 3.4 å’Œ NDK r16b stable. ç‰ˆæœ¬æ­é…çœŸçš„å¾ˆé‡è¦ï¼Œè¿™ä¸ªè„šæœ¬è¿˜è¦è°ƒç”¨pythonåˆ›å»ºä¸åŒabiçš„toolchainã€‚<br>ä½¿ç”¨ndkç¼–è¯‘ffmpegæ»¡æ»¡çš„éƒ½æ˜¯å‘</p><pre><code>In file included from libavfilter/aeval.c:26:0:./libavutil/avassert.h:30:20: fatal error: stdlib.h: No such file or directory #include &lt;stdlib.h&gt;                    ^å‡ºç°è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºä½¿ç”¨æœ€æ–°ç‰ˆçš„NDKé€ æˆçš„ï¼Œæœ€æ–°ç‰ˆçš„NDkå°†å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è¿›è¡Œäº†åˆ†ç¦»ï¼Œæˆ‘ä»¬æŒ‡å®šçš„sysrootæ–‡ä»¶å¤¹ä¸‹åªæœ‰åº“æ–‡ä»¶ï¼Œè€Œå¤´æ–‡ä»¶æ”¾åœ¨äº†NDKç›®å½•ä¸‹çš„sysrootå†…ï¼Œåªéœ€åœ¨--extra-cflagsä¸­æ·»åŠ  &quot;-isysroot $NDK/sysroot&quot; å³å¯ï¼Œè¿˜æœ‰æœ‰å…³æ±‡ç¼–çš„å¤´æ–‡ä»¶ä¹Ÿè¿›è¡Œäº†åˆ†ç¦»ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡å¹³å°è¿›è¡ŒæŒ‡å®š &quot;-I$NDK/sysroot/usr/include/arm-linux-androideabi&quot;ï¼Œå°† &quot;arm-linux-androideabi&quot; æ”¹ä¸ºéœ€è¦çš„å¹³å°å°±å¯ä»¥ï¼Œç»ˆäºå¯ä»¥é¡ºåˆ©çš„è¿›è¡Œç¼–è¯‘äº†</code></pre><pre><code>nasm/yasm not found or too old. use --disable-x86asm for a crippled build</code></pre><p>è¿™æ˜¯æ±‡ç¼–å·¥å…·æ²¡æœ‰å®‰è£…å¯¼è‡´çš„<br>sudo apt install yasm</p><p><a href="https://github.com/coopsrc/FFPlayerDemo">æ‰¾åˆ°ä¸€ä¸ªç¼–è¯‘ä¸åŒabiçš„soæ–‡ä»¶çš„è„šæœ¬</a><br>armeabi-v7a arm64-v8a x86 x86_64è¿™ä¹ˆå‡ ä¸ªhostæ¯ä¸ªéƒ½è¦èŠ±ä¸Š10åˆ†é’Ÿï¼Œæ‰€ä»¥è¿™ä¸ªè„šæœ¬è·‘èµ·æ¥ä¹‹åå¯ä»¥å»å–æ¯èŒ¶äº†</p><pre><code class="bash">#!/bin/shPREFIX=android-buildHOST_PLATFORM=linux-x86_64COMMON_OPTIONS=&quot;\    --target-os=android \    --disable-static \    --enable-shared \    --enable-small \    --disable-programs \    --disable-ffmpeg \    --disable-ffplay \    --disable-ffprobe \    --disable-doc \    --disable-symver \    --disable-asm \    --enable-decoder=vorbis \    --enable-decoder=opus \    --enable-decoder=flac     &quot;build_all(){    for version in armeabi-v7a arm64-v8a x86 x86_64; do        echo &quot;======== &gt; Start build $version&quot;        case ${version} in        armeabi-v7a )            ARCH=&quot;arm&quot;            CPU=&quot;armv7-a&quot;            CROSS_PREFIX=&quot;$NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/$HOST_PLATFORM/bin/arm-linux-androideabi-&quot;            SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-arm/&quot;            EXTRA_CFLAGS=&quot;-march=armv7-a -mfpu=neon -mfloat-abi=softfp -mvectorize-with-neon-quad&quot;            EXTRA_LDFLAGS=&quot;-Wl,--fix-cortex-a8&quot;        ;;        arm64-v8a )            ARCH=&quot;aarch64&quot;            CPU=&quot;armv8-a&quot;            CROSS_PREFIX=&quot;$NDK_HOME/toolchains/aarch64-linux-android-4.9/prebuilt/$HOST_PLATFORM/bin/aarch64-linux-android-&quot;            SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-arm64/&quot;            EXTRA_CFLAGS=&quot;&quot;            EXTRA_LDFLAGS=&quot;&quot;        ;;        x86 )            ARCH=&quot;x86&quot;            CPU=&quot;i686&quot;            CROSS_PREFIX=&quot;$NDK_HOME/toolchains/x86-4.9/prebuilt/$HOST_PLATFORM/bin/i686-linux-android-&quot;            SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-x86/&quot;            EXTRA_CFLAGS=&quot;&quot;            EXTRA_LDFLAGS=&quot;&quot;        ;;        x86_64 )            ARCH=&quot;x86_64&quot;            CPU=&quot;x86_64&quot;            CROSS_PREFIX=&quot;$NDK_HOME/toolchains/x86_64-4.9/prebuilt/$HOST_PLATFORM/bin/x86_64-linux-android-&quot;            SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-x86_64/&quot;            EXTRA_CFLAGS=&quot;&quot;            EXTRA_LDFLAGS=&quot;&quot;        ;;        esac        echo &quot;-------- &gt; Start clean workspace&quot;        make clean        echo &quot;-------- &gt; Start config makefile&quot;        configuration=&quot;\            --prefix=${PREFIX} \            --libdir=${PREFIX}/libs/${version}            --incdir=${PREFIX}/includes/${version} \            --pkgconfigdir=${PREFIX}/pkgconfig/${version} \            --arch=${ARCH} \            --cpu=${CPU} \            --cross-prefix=${CROSS_PREFIX} \            --sysroot=${SYSROOT} \            --extra-ldexeflags=-pie \            ${COMMON_OPTIONS}            &quot;        echo &quot;-------- &gt; Start config makefile with ${configuration}&quot;        ./configure ${configuration}        echo &quot;-------- &gt; Start make ${version} with -j8&quot;        make j8        echo &quot;-------- &gt; Start install ${version}&quot;        make install        echo &quot;++++++++ &gt; make and install ${version} complete.&quot;    done}echo &quot;-------- Start --------&quot;build_allecho &quot;-------- End --------&quot;</code></pre><p><a href="https://blog.csdn.net/u011485531/article/details/55804380">å¦‚ä½•æŠŠffmpegç”Ÿæˆçš„soæ–‡ä»¶å‹ç¼©å¤§å°</a></p><p>ç„¶åæ‰æ˜¯äº¤å‰ç¼–è¯‘</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.android.com/studio/projects/configure-cmake">configure-cmake</a><br><a href="https://github.com/googlesamples/android-ndk">googlesamples/android-ndk</a><br><a href="https://www.jianshu.com/p/6332418b12b1">Android NDKå¼€å‘æ‰«ç›²åŠæœ€æ–°CMakeçš„ç¼–è¯‘ä½¿ç”¨</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;androidä¸­ndkåŠjniç¼–å†™æ³¨æ„äº‹é¡¹ï¼ˆæœ¬æ–‡ä¸»è¦è®²CMakeï¼‰&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/ShanwangpingKarst_EN-AU5360258756_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="android" scheme="https://haldir65.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>Cè¯­è¨€ä¸­å¤šè¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼</title>
    <link href="https://haldir65.github.io/2019/01/30/2019-01-30-ipc-in-c-programming-language/"/>
    <id>https://haldir65.github.io/2019/01/30/2019-01-30-ipc-in-c-programming-language/</id>
    <published>2019-01-30T07:57:28.000Z</published>
    <updated>2020-03-18T22:24:14.516Z</updated>
    
    <content type="html"><![CDATA[<p><strong><em>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½</em></strong><br><img src="https://api1.foster66.xyz/static/imgs/Prayercard_ZH-CN13472871640_1920x1080.jpg" alt=""></p><p>æœ¬æ–‡å¤šæ•°æ¥è‡ª<a href="https://www.zfl9.com/c-multi-proc.html">cè¯­è¨€å¤šè¿›ç¨‹ç¼–ç¨‹</a></p><p>å½“Linuxå¯åŠ¨çš„æ—¶å€™ï¼Œinitæ˜¯ç³»ç»Ÿåˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸€è¿›ç¨‹ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æˆ‘ä»¬å…³é—­è®¡ç®—æœºï¼›è™½ç„¶åé¢systemdå–ä»£äº†initè¿›ç¨‹ã€‚åé¢çš„æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯initè¿›ç¨‹forkå‡ºæ¥çš„,linuxä¸‹ä½¿ç”¨pstreeå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ä»¥systemdä¸ºæ ¹èŠ‚ç‚¹çš„<br>å½“è¿›ç¨‹è°ƒç”¨forkçš„æ—¶å€™ï¼ŒLinuxåœ¨å†…å­˜ä¸­å¼€è¾Ÿå‡ºä¸€ç‰‡æ–°çš„å†…å­˜ç©ºé—´ç»™æ–°çš„è¿›ç¨‹ï¼Œå¹¶å°†è€çš„è¿›ç¨‹ç©ºé—´ä¸­çš„å†…å®¹å¤åˆ¶åˆ°æ–°çš„ç©ºé—´ä¸­ï¼Œæ­¤åä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œï¼›è€è¿›ç¨‹æˆä¸ºæ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹(parent process)ï¼Œè€Œç›¸åº”çš„ï¼Œæ–°è¿›ç¨‹å°±æ˜¯è€è¿›ç¨‹çš„å­è¿›ç¨‹(child process)ï¼›</p><a id="more"></a><h2 id="forkçš„æœ€ç®€å•å®ä¾‹"><a href="#forkçš„æœ€ç®€å•å®ä¾‹" class="headerlink" title="forkçš„æœ€ç®€å•å®ä¾‹"></a>forkçš„æœ€ç®€å•å®ä¾‹</h2><p>forkæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šæœ‰ä¸¤æ¬¡è¿”å›ï¼Œåˆ†åˆ«æ˜¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚</p><pre><code class="C">#include &lt;stdint.h&gt;#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;void print_process_message(){    __pid_t myprocess_id = getpid();    __uid_t uid = getuid();    __gid_t ugid = getgid();    printf(&quot;getpid = %d getuid= %d  getgid= %d \n&quot;,myprocess_id,uid, ugid);}int main(int argc, char const *argv[]){    int n =0;    printf(&quot;before fork: n = %d\n&quot;,n);    __pid_t fpid =fork();    if(fpid &lt;0 )    {        perror(&quot;fork error&quot;);        exit(EXIT_FAILURE);    }else if (fpid == 0)    {        n++;        printf(&quot;child_proc(%d, ppid=%d): n= %d\n&quot;,getpid(),getppid(),n);    } else    {        n--;        printf(&quot;parent_proc(%d): n= %d\n&quot;,getpid(),n);    }    print_process_message();    printf(&quot;quit_proc(%d) ...\n&quot;,getpid());    return 0;}</code></pre><h3 id="forkå’Œvfrok"><a href="#forkå’Œvfrok" class="headerlink" title="forkå’Œvfrok"></a>forkå’Œvfrok</h3><p>forkåˆ›å»ºå­è¿›ç¨‹ï¼ŒæŠŠçˆ¶è¿›ç¨‹æ•°æ®ç©ºé—´ã€å †å’Œæ ˆå¤åˆ¶ä¸€ä»½ï¼›<br>vforkåˆ›å»ºå­è¿›ç¨‹ï¼Œä¸çˆ¶è¿›ç¨‹å†…å­˜æ•°æ®å…±äº«ï¼›<br>ä½†æ˜¯åæ¥çš„forkä¹Ÿå­¦èªæ˜äº†ï¼Œä¸æ˜¯ä¸€å¼€å§‹è°ƒç”¨forkå°±å¤åˆ¶æ•°æ®ï¼Œè€Œæ˜¯åªæœ‰åœ¨å­è¿›ç¨‹è¦ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œå¤åˆ¶ï¼Œå³copy-on-writeï¼›<br>æ‰€ä»¥æˆ‘ä»¬ç°åœ¨ä¹Ÿå¾ˆå°‘å»ç”¨vforkï¼Œå› ä¸ºvforkçš„ä¼˜åŠ¿å·²ç»ä¸å¤å­˜åœ¨äº†ï¼›</p><h2 id="å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ä»¥åŠwait"><a href="#å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ä»¥åŠwait" class="headerlink" title="å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ä»¥åŠwait"></a>å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ä»¥åŠwait</h2><p>æ­£å¸¸çš„æ“ä½œæµç¨‹ï¼šå­è¿›ç¨‹ç»ˆç»“æ—¶ä¼šé€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œå¹¶é€šè¿‡return codeå‘Šè¯‰å†…æ ¸è‡ªå·±çš„é€€å‡ºä¿¡æ¯ï¼Œçˆ¶è¿›ç¨‹çŸ¥é“åï¼Œæœ‰è´£ä»»å¯¹è¯¥å­è¿›ç¨‹ä½¿ç”¨<strong><em>wait</em></strong>ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªwaitå‡½æ•°èƒ½å¤Ÿä»å†…æ ¸ä¸­å–å‡ºå­è¿›ç¨‹çš„é€€å‡ºä¿¡æ¯ï¼Œå¹¶æ¸…ç©ºè¯¥ä¿¡æ¯åœ¨å†…æ ¸ä¸­æ‰€å æ®çš„ç©ºé—´ï¼›</p><p><strong><em>ä¸æ­£å¸¸çš„æµç¨‹ï¼š</em></strong><br>çˆ¶è¿›ç¨‹æ—©äºå­è¿›ç¨‹æŒ‚æ‰ï¼Œé‚£ä¹ˆå­è¿›ç¨‹å°±æˆäº†å­¤å„¿è¿›ç¨‹</p><p>å¦‚æœç¨‹åºå†™çš„ç³Ÿç³•ï¼Œçˆ¶è¿›ç¨‹å¿˜è®°å¯¹å­è¿›ç¨‹è°ƒç”¨waitï¼Œå­è¿›ç¨‹å°±æˆä¸ºåƒµå°¸(zombie)è¿›ç¨‹ã€‚ï¼ˆåœ¨htopé‡Œé¢çœ‹åˆ°stateæ˜¯Zï¼‰<br>å½“è¿›ç¨‹é€€å‡ºï¼Œé‡Šæ”¾å¤§å¤šæ•°èµ„æºå’Œå®ƒçš„çˆ¶è¿›ç¨‹æ”¶é›†å®ƒçš„è¿”å›å€¼ã€é‡Šæ”¾å‰©ä½™èµ„æºè¿™ä¸¤æ®µæ—¶é—´ä¹‹é—´ï¼Œå­è¿›ç¨‹å¤„äºä¸€ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼Œè¢«ç§°ä¸ºåƒµå°¸è¿›ç¨‹ï¼›<br>æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šç»è¿‡ä¸€ä¸ªçŸ­æš‚çš„åƒµå°¸çŠ¶æ€ï¼Œåƒµå°¸è¿›ç¨‹çš„æœ€å¤§å±å®³å°±æ˜¯ä¼šå ç”¨å®è´µçš„PIDèµ„æºï¼Œå¦‚æœä¸åŠæ—¶æ¸…ç†ï¼Œä¼šå¯¼è‡´æ— æ³•å†åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼›</p><p><strong><em>è§£å†³åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•æ˜¯å¹²æ‰åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹</em></strong>ï¼Œåƒµå°¸è¿›ç¨‹ä¹Ÿå°±å˜æˆäº†å­¤å„¿è¿›ç¨‹ï¼Œæœ€ç»ˆè¢«initè¿›ç¨‹æ¥ç®¡ï¼Œinitè¿›ç¨‹ä¼šè´Ÿè´£waitè¿™äº›å­¤å„¿è¿›ç¨‹ï¼Œé‡Šæ”¾å ç”¨çš„èµ„æºã€‚</p><h2 id="waitå’Œwaitpidå‡½æ•°"><a href="#waitå’Œwaitpidå‡½æ•°" class="headerlink" title="waitå’Œwaitpidå‡½æ•°"></a>waitå’Œwaitpidå‡½æ•°</h2><p>pid_t wait(int <em>status);ï¼šç­‰å¾…ä»»æ„å­è¿›ç¨‹é€€å‡ºï¼Œå¹¶æ•è·é€€å‡ºçŠ¶æ€<br>pid_t waitpid(pid_t pid, int </em>status, int options);ï¼šç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œå¹¶æ•è·é€€å‡ºçŠ¶æ€<br>è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯é€€å‡ºçš„å­è¿›ç¨‹çš„id</p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;sys/types.h&gt;#include &lt;wait.h&gt;int main(int argc, char const *argv[],char *envp[]){    pid_t fpid = fork(), pid;    if(fpid &lt; 0)    {        perror(&quot;fork error&quot;);        exit(EXIT_FAILURE);    }    else if(fpid ==0 )    {        sleep(5);        exit(5);    } else {        int stat;        for(;;){            pid = waitpid(fpid,&amp;stat,WNOHANG); //statç”¨äºè®°å½•å­è¿›ç¨‹çš„è¿”å›ç»“æœ            if(pid&gt;0) {                break;            }else {                printf(&quot;wait child proc ... \n&quot;);                sleep(1);            }        }        if(WIFEXITED(stat))//è¿™ä¸ªå‡½æ•°å¦‚æœå­è¿›ç¨‹æ­£å¸¸é€€å‡ºçš„è¯å°±è¿”å›çœŸ        {            printf(&quot;child_proc(%d): exit_code :%d\n&quot;,pid,WEXITSTATUS(stat));        }    }    return 0;}</code></pre><p><strong>å¤„ç†å­è¿›ç¨‹çš„é€€å‡ºæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</strong><br>ç¬¬ä¸€ç§ï¼šé€šè¿‡ä¿¡å·å¤„ç†å‡½æ•°signal()ï¼Œå¦‚å¯ä»¥å¿½ç•¥å­è¿›ç¨‹çš„SIGCHLDä¿¡å·æ¥é˜²æ­¢åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿï¼šsignal(SIGCHLD, SIG_IGN);<br>ç¬¬äºŒç§ï¼šé€šè¿‡è°ƒç”¨wait()ã€waitpid()å‡½æ•°ï¼Œæ¥å›æ”¶å­è¿›ç¨‹ï¼Œé˜²æ­¢äº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼Œå ç”¨<strong>PIDç­‰å®è´µçš„ç³»ç»Ÿèµ„æº</strong>ï¼›</p><p>ç»å¸¸åœ¨parent processä¸­çœ‹åˆ°wait(NULL)çš„æ“ä½œï¼Œæ„æ€å°±æ˜¯è®©çˆ¶è¿›ç¨‹ç­‰child process è¿”å›exit statusã€‚<br><a href="https://stackoverflow.com/questions/42426816/how-does-waitnull-exactly-work?rq=1">wait(NULL)æ˜¯ä»€ä¹ˆæ„æ€</a></p><pre><code>wait(NULL) will block parent process until any of its children has finished. If child terminates before parent process reaches wait(NULL) then the child process turns to a zombie process until its parent waits on it and its released from memory.If parent process doesn&#39;t wait for its child, and parent finishes first, then the child process becomes orphan and is assigned to init as its child. And init will wait and release the process entry in the process table.In other words: parent process will be blocked until child process returns an exit status to the operating system which is then returned to parent process. If child finishes before parent reaches wait(NULL) then it will read the exit status, release the process entry in the process table and continue execution until it finishes as well.</code></pre><h3 id="execç³»åˆ—å‡½æ•°"><a href="#execç³»åˆ—å‡½æ•°" class="headerlink" title="execç³»åˆ—å‡½æ•°"></a>execç³»åˆ—å‡½æ•°</h3><p><strong>forkå‡ºæ¥ä¸€ä¸ªæ–°çš„è¿›ç¨‹å½“ç„¶æ˜¯è¦å¹²æ´»çš„</strong>ï¼Œå°±è¦ç”¨åˆ°execç³»ç»Ÿè°ƒç”¨<br>execç³»ç»Ÿè°ƒç”¨æ˜¯ä»¥æ–°çš„è¿›ç¨‹ç©ºé—´æ›¿æ¢ç°åœ¨çš„è¿›ç¨‹ç©ºé—´ï¼Œä½†æ˜¯pidä¸å˜ï¼Œè¿˜æ˜¯åŸæ¥çš„pidï¼Œç›¸å½“äºæ¢äº†ä¸ªèº«ä½“ï¼Œä½†æ˜¯åå­—ä¸å˜ï¼›<br>è°ƒç”¨execåï¼Œç³»ç»Ÿä¼šç”³è¯·ä¸€å—æ–°çš„è¿›ç¨‹ç©ºé—´æ¥å­˜æ”¾è¢«è°ƒç”¨çš„ç¨‹åºï¼Œç„¶åå½“å‰è¿›ç¨‹ä¼šæºå¸¦pidè·³è½¬åˆ°æ–°çš„è¿›ç¨‹ç©ºé—´ï¼Œå¹¶ä»mainå‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œæ—§çš„è¿›ç¨‹ç©ºé—´è¢«å›æ”¶ï¼›<br>execç”¨è¢«æ‰§è¡Œçš„ç¨‹åºå®Œå…¨æ›¿æ¢è°ƒç”¨å®ƒçš„ç¨‹åºçš„å½±åƒã€‚forkåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹å°±äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„PIDï¼Œ<br>execå¯åŠ¨ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ›¿æ¢åŸæœ‰çš„è¿›ç¨‹ï¼Œå› æ­¤è¿™ä¸ªæ–°çš„è¢«execæ‰§è¡Œçš„è¿›ç¨‹çš„PIDä¸ä¼šæ”¹å˜ï¼Œ</p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;int main(int arg,char **args){    char *argv[]={&quot;ls&quot;,&quot;-al&quot;,&quot;/usr/include/linux&quot;,NULL};//ä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶çš„å‚æ•°æ•°ç»„ï¼Œè¿™é‡ŒåŒ…å«æ‰§è¡Œæ–‡ä»¶çš„å‚æ•°     char *envp[]={0,NULL};//ä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶æ–°çš„ç¯å¢ƒå˜é‡æ•°ç»„    execve(&quot;/bin/ls&quot;,argv,envp);}</code></pre><p>è¿™ä¸ªå‡½æ•°çš„å‚æ•°</p><pre><code>int   execve( char *pathname,char *argv[],char *envp[])</code></pre><h3 id="exit-å¯ä»¥æ³¨å†Œè¿›ç¨‹é€€å‡ºçš„æ—¶å€™çš„å›è°ƒå‡½æ•°"><a href="#exit-å¯ä»¥æ³¨å†Œè¿›ç¨‹é€€å‡ºçš„æ—¶å€™çš„å›è°ƒå‡½æ•°" class="headerlink" title="exit(å¯ä»¥æ³¨å†Œè¿›ç¨‹é€€å‡ºçš„æ—¶å€™çš„å›è°ƒå‡½æ•°)"></a>exit(å¯ä»¥æ³¨å†Œè¿›ç¨‹é€€å‡ºçš„æ—¶å€™çš„å›è°ƒå‡½æ•°)</h3><p>exitæ˜¯ç³»ç»Ÿè°ƒç”¨çº§åˆ«çš„ï¼Œç”¨äºè¿›ç¨‹è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œéšæ—¶ç»“æŸè¿›ç¨‹ï¼›<br>returnæ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œç”¨äºè°ƒç”¨å †æ ˆçš„è¿”å›ï¼Œè¿”å›ä¸Šä¸€å±‚è°ƒç”¨ï¼›<br>åœ¨mainå‡½æ•°ä¸­è°ƒç”¨exit(0)ç­‰ä»·äºreturn 0ï¼›<br>_exit()å‡½æ•°çš„ä½œç”¨æœ€ä¸ºç®€å•ï¼šç›´æ¥ä½¿è¿›ç¨‹åœæ­¢è¿è¡Œï¼Œæ¸…é™¤å…¶ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¹¶é”€æ¯å…¶åœ¨å†…æ ¸ä¸­çš„å„ç§æ•°æ®ç»“æ„ï¼›<br>exit()å‡½æ•°åˆ™åœ¨è¿™äº›åŸºç¡€ä¸Šä½œäº†ä¸€äº›åŒ…è£…ï¼Œåœ¨æ‰§è¡Œé€€å‡ºä¹‹å‰åŠ äº†è‹¥å¹²é“å·¥åºï¼›<br>exit()å‡½æ•°ä¸_exit()å‡½æ•°æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºexit()è¦æ£€æŸ¥æ–‡ä»¶çš„æ‰“å¼€æƒ…å†µï¼ŒæŠŠæ–‡ä»¶ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å›æ–‡ä»¶ï¼Œå°±æ˜¯â€æ¸…ç†I/Oç¼“å†²â€ï¼›</p><p>æŒ‰ç…§ANSI Cçš„è§„å®šï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç™»è®°è‡³å¤š32ä¸ªå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å°†ç”±exitè‡ªåŠ¨è°ƒç”¨ï¼›ï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨è°ƒç”¨exitçš„æ—¶å€™ä¼šè°ƒç”¨è¿™äº›å›è°ƒå‡½æ•°ï¼‰<br>åˆ†ä¸ºatexitå’Œon_exit</p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/wait.h&gt;#include &lt;signal.h&gt;void func1(void){    printf(&quot;&lt;atexit&gt; func1 getpid = %d \n&quot;,getpid());}void func2(void){    printf(&quot;&lt;atexit&gt; func2 getpid = %d \n&quot;,getpid());}void func3(void){    printf(&quot;&lt;atexit&gt; func3 getpid = %d \n&quot;,getpid());}void func(int status, void *str){    printf(&quot;&lt;on_exit&gt; exit_code: %d, arg: %s getpid = %d \n&quot;, status, (char *)str,getpid());}int main(void){    signal(SIGCHLD, SIG_IGN);    on_exit(func, &quot;on_exit3&quot;);    on_exit(func, &quot;on_exit2&quot;);    on_exit(func, &quot;on_exit1&quot;);    atexit(func3);    atexit(func2);    atexit(func1);    pid_t pid;    pid = fork();    if(pid &lt; 0){        perror(&quot;fork error&quot;);        exit(EXIT_FAILURE);    }else if(pid == 0){        exit(0);    }else{        sleep(3);    }    return 0;}</code></pre><p><strong><em>è¾“å‡ºï¼š</em></strong></p><pre><code>&lt;atexit&gt; func1 getpid = 13508&lt;atexit&gt; func2 getpid = 13508&lt;atexit&gt; func3 getpid = 13508&lt;on_exit&gt; exit_code: 0, arg: on_exit1 getpid = 13508&lt;on_exit&gt; exit_code: 0, arg: on_exit2 getpid = 13508&lt;on_exit&gt; exit_code: 0, arg: on_exit3 getpid = 13508&lt;atexit&gt; func1 getpid = 13507&lt;atexit&gt; func2 getpid = 13507&lt;atexit&gt; func3 getpid = 13507&lt;on_exit&gt; exit_code: 0, arg: on_exit1 getpid = 13507&lt;on_exit&gt; exit_code: 0, arg: on_exit2 getpid = 13507</code></pre><p>ä¹Ÿå°±æ˜¯è¯´forkå‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç»ˆæ­¢å¤„ç†å‡½æ•°ã€ä¿¡å·å¤„ç†è®¾ç½®ï¼›</p><h2 id="Daemonå®ˆæŠ¤è¿›ç¨‹"><a href="#Daemonå®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="Daemonå®ˆæŠ¤è¿›ç¨‹"></a>Daemonå®ˆæŠ¤è¿›ç¨‹</h2><p>Linux Daemonè¿›ç¨‹æ˜¯è¿è¡Œåœ¨åå°çš„ä¸€ç§ç‰¹æ®Šè¿›ç¨‹ã€‚<br>ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯initè¿›ç¨‹ï¼Œå› ä¸ºå®ƒçœŸæ­£çš„çˆ¶è¿›ç¨‹åœ¨forkå‡ºå­è¿›ç¨‹åå°±å…ˆäºå­è¿›ç¨‹exité€€å‡ºäº†ï¼Œ<strong><em>æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç”±initç»§æ‰¿çš„å­¤å„¿è¿›ç¨‹ï¼›</em></strong><br>å®ˆæŠ¤è¿›ç¨‹æ˜¯éäº¤äº’å¼ç¨‹åºï¼Œæ²¡æœ‰æ§åˆ¶ç»ˆç«¯ï¼Œæ‰€ä»¥ä»»ä½•è¾“å‡ºï¼Œæ— è®ºæ˜¯å‘æ ‡å‡†è¾“å‡ºè®¾å¤‡stdoutè¿˜æ˜¯æ ‡å‡†å‡ºé”™è®¾å¤‡stderrçš„è¾“å‡ºéƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼›<br>å®ˆæŠ¤è¿›ç¨‹çš„åç§°é€šå¸¸ä»¥dç»“å°¾ï¼Œæ¯”å¦‚sshdã€xinetdã€crondç­‰ï¼›</p><p>å¤´æ–‡ä»¶ï¼šunistd.h<br><strong><em>int daemon(int nochdir, int noclose);</em></strong></p><h2 id="systemå’Œpopen"><a href="#systemå’Œpopen" class="headerlink" title="systemå’Œpopen"></a>systemå’Œpopen</h2><p><strong><em>systemæ˜¯å»æ‰§è¡Œä¸€ä¸ªshellå‘½ä»¤</em></strong><br>system()å‡½æ•°è°ƒç”¨/bin/shæ¥æ‰§è¡Œå‚æ•°æŒ‡å®šçš„å‘½ä»¤ï¼Œ/bin/shä¸€èˆ¬æ˜¯ä¸€ä¸ªè½¯è¿æ¥ï¼ŒæŒ‡å‘æŸä¸ªå…·ä½“çš„shellï¼Œæ¯”å¦‚bashï¼›</p><pre><code class="C">system(&quot;cat /etc/sysctl.conf&quot;);ï¼›</code></pre><p>å®é™…ä¸Šsystem()å‡½æ•°æ‰§è¡Œäº†ä¸‰æ­¥æ“ä½œï¼š<br>forkä¸€ä¸ªå­è¿›ç¨‹ï¼›<br>åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨execå‡½æ•°å»æ‰§è¡Œcommandï¼›<br>åœ¨çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨waitå»ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼›<br>ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹æ˜¯system()ï¼Œå¹¶ä¸èƒ½è·å–å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºç»“æœï¼Œåªèƒ½å¾—åˆ°æ‰§è¡Œçš„è¿”å›å€¼ï¼›</p><p><strong>popen</strong><br>æ ‡å‡†I/Oå‡½æ•°åº“æä¾›äº†popenå‡½æ•°ï¼Œå®ƒå¯åŠ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹å»æ‰§è¡Œä¸€ä¸ªshellå‘½ä»¤è¡Œï¼›<br>è¿™é‡Œæˆ‘ä»¬ç§°è°ƒç”¨popençš„è¿›ç¨‹ä¸ºçˆ¶è¿›ç¨‹ï¼Œç”±popenå¯åŠ¨çš„è¿›ç¨‹ç§°ä¸ºå­è¿›ç¨‹ï¼›</p><p>popenå‡½æ•°è¿˜åˆ›å»ºä¸€ä¸ªç®¡é“ç”¨äºçˆ¶å­è¿›ç¨‹é—´é€šä¿¡ï¼›çˆ¶è¿›ç¨‹è¦ä¹ˆä»ç®¡é“è¯»ä¿¡æ¯ï¼Œè¦ä¹ˆå‘ç®¡é“å†™ä¿¡æ¯ï¼Œè‡³äºæ˜¯è¯»è¿˜æ˜¯å†™å–å†³äºçˆ¶è¿›ç¨‹è°ƒç”¨popenæ—¶ä¼ é€’çš„å‚æ•°ï¼›</p><pre><code class="C">#include &lt;stdio.h&gt;FILE *popen(const char *command, const char *type);/*å‡½æ•°åŠŸèƒ½ï¼špopen()ä¼šè°ƒç”¨fork()äº§ç”Ÿå­è¿›ç¨‹ï¼Œç„¶åä»å­è¿›ç¨‹ä¸­è°ƒç”¨/bin/sh -cæ¥æ‰§è¡Œå‚æ•°commandçš„æŒ‡ä»¤;          å‚æ•°typeå¯ä½¿ç”¨&quot;r&quot;ä»£è¡¨è¯»å–ï¼Œ&quot;w&quot;ä»£è¡¨å†™å…¥;          ä¾ç…§æ­¤typeå€¼ï¼Œpopen()ä¼šå»ºç«‹ç®¡é“è¿åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè®¾å¤‡æˆ–æ ‡å‡†è¾“å…¥è®¾å¤‡ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ;          éšåè¿›ç¨‹ä¾¿å¯åˆ©ç”¨æ­¤æ–‡ä»¶æŒ‡é’ˆæ¥è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºè®¾å¤‡æˆ–æ˜¯å†™å…¥åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è®¾å¤‡ä¸­;è¿”å›å€¼ï¼šè‹¥æˆåŠŸåˆ™è¿”å›æ–‡ä»¶æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›NULLï¼Œé”™è¯¯åŸå› å­˜äºerrnoä¸­*/int pclose(FILE *stream);/*å‡½æ•°åŠŸèƒ½ï¼špclose()ç”¨æ¥å…³é—­ç”±popenæ‰€å»ºç«‹çš„ç®¡é“åŠæ–‡ä»¶æŒ‡é’ˆï¼›å‚æ•°streamä¸ºå…ˆå‰ç”±popen()æ‰€è¿”å›çš„æ–‡ä»¶æŒ‡é’ˆ;è¿”å›å€¼ï¼šè‹¥æˆåŠŸåˆ™è¿”å›shellçš„ç»ˆæ­¢çŠ¶æ€(ä¹Ÿå³å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€)ï¼Œè‹¥å‡ºé”™è¿”å›-1ï¼Œé”™è¯¯åŸå› å­˜äºerrnoä¸­;*/</code></pre><p><strong>è¿™é‡Œæ­£å¼ä½¿ç”¨åˆ°äº†è¿›ç¨‹ä¹‹é—´çš„ç®¡é“é€šä¿¡</strong></p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;int main(int argc, char *argv[]){    if(argc &lt; 2){        fprintf(stderr, &quot;usage: %s &lt;cmd&gt;\n&quot;, argv[0]);        exit(EXIT_FAILURE);    }    char output[1024+1];    FILE *pp = popen(argv[1], &quot;r&quot;);    if(pp == NULL){        perror(&quot;popen error&quot;);        exit(EXIT_FAILURE);    }    int nread = fread(output, 1, 1024, pp); //çˆ¶è¿›ç¨‹é€šè¿‡æ–‡ä»¶æŒ‡é’ˆè¯»å–å­è¿›ç¨‹çš„è¾“å‡ºè®¾å¤‡ã€‚    int status = pclose(pp);    if(status &lt; 0){        perror(&quot;pclose error&quot;);        exit(EXIT_FAILURE);    }    output[nread] = &#39;\0&#39;;    if(WIFEXITED(status)){        printf(&quot;status: %d\n%s&quot;, WEXITSTATUS(status), output);    }    return 0;}</code></pre><h2 id="signalä¿¡å·"><a href="#signalä¿¡å·" class="headerlink" title="signalä¿¡å·"></a>signalä¿¡å·</h2><p>ä¿¡å·(signal)æ˜¯ä¸€ç§è½¯ä¸­æ–­ï¼Œä¿¡å·æœºåˆ¶æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼Œé‡‡ç”¨<strong>å¼‚æ­¥é€šä¿¡æ–¹å¼</strong><br>ç”¨kill -lã€€å¯ä»¥æŸ¥çœ‹å¯ä»¥å‘å‡ºçš„ä¿¡å·</p><pre><code>$ kill -l           HUP INT QUIT ILL TRAP ABRT BUS FPE KILL USR1 SEGV USR2 PIPE ALRM TERM 16 CHLD CONT STOP TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH POLL 30 SYS</code></pre><p>æŒ‘å‡ ä¸ªé‡è¦çš„:<br>SIGINT(2) ä¸­æ–­ã€€ï¼ˆCTRL + Cï¼‰<br>SIGKILL(9) killä¿¡å·ï¼ˆå¼ºæ€ï¼Œè¿›ç¨‹ä¸èƒ½é˜»æ­¢ï¼‰<br>SIGPIPE(13) ç®¡é“ç ´æŸï¼Œæ²¡æœ‰è¯»ç«¯çš„ç®¡é“å†™æ•°æ®,å°±æ˜¯é‚£ä¸ªbrokenpipeã€‚<strong>é»˜è®¤æ˜¯æ€è¿›ç¨‹çš„ï¼Œæ‰€ä»¥ç½‘ç»œç¼–ç¨‹ä¸­è¦å¤„ç†è¿™ä¸ªä¿¡å·ã€‚</strong>ï¼ˆå½“æœåŠ¡å™¨closeä¸€ä¸ªè¿æ¥æ—¶ï¼Œè‹¥clientç«¯æ¥ç€å‘æ•°æ®ã€‚æ ¹æ®TCPåè®®çš„è§„å®šï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªRSTå“åº”ï¼Œclientå†å¾€è¿™ä¸ªæœåŠ¡å™¨å‘é€æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¸€ä¸ªSIGPIPEä¿¡å·ç»™è¿›ç¨‹ï¼Œå‘Šè¯‰è¿›ç¨‹è¿™ä¸ªè¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä¸è¦å†å†™äº†ã€‚ï¼‰<br>SIGTERMï¼ˆï¼‘ï¼•ï¼‰ã€€ç»ˆæ­¢ä¿¡å·ï¼Œè¿™ä¸ªä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®ƒå¯ä»¥è¢«æ•è·å’Œè§£é‡Šï¼ˆæˆ–å¿½ç•¥ï¼‰çš„è¿‡ç¨‹ã€‚ç±»ä¼¼äºå’Œè¿™ä¸ªè¿›ç¨‹å•†é‡ä¸€ä¸‹ï¼Œè®©å®ƒé€€å‡ºã€‚ä¸å¬è¯çš„è¯å¯ä»¥ç”¨ï¼™æ€æ‰ã€‚<br>SIGCHLD(ï¼‘ï¼—) å­è¿›ç¨‹é€€å‡ºã€‚ã€€é»˜è®¤å¿½ç•¥<br>SIGSTOPï¼ˆï¼‘ï¼™ï¼‰ã€€è¿›ç¨‹åœæ­¢ã€€ä¸èƒ½è¢«å¿½ç•¥ã€å¤„ç†å’Œé˜»å¡<br>SIGPWR(30) å…³æœºã€€é»˜è®¤å¿½ç•¥<br>è¿›ç¨‹å¯ä»¥æ³¨å†Œæ”¶åˆ°ä¿¡å·æ—¶çš„å¤„ç†å‡½æ•°</p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;signal.h&gt;#include &lt;unistd.h&gt;void handle_signal(int signum){    printf(&quot;received signal: %d\n&quot;, signum);    exit(0);}int main(void){    signal(SIGINT, handle_signal);    for(;;){        printf(&quot;running ... \n&quot;);        sleep(1);    }    return 0;}</code></pre><p>è¿™é‡Œæ·»ä¸€å¥ï¼Œcpythonå› ä¸ºæ˜¯ç”¨ï¼£è¯­è¨€å†™çš„ï¼Œåœ¨å¤„ç†ä¿¡å·è¿™æ–¹é¢å‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚<br><a href="https://stackabuse.com/handling-unix-signals-in-python/">æ³¨å†Œsignal_handler</a></p><blockquote><p>ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ä»‹ç»è¿›ç¨‹çš„åŸºç¡€çŸ¥è¯†åˆ°æ­¤ç»“æŸ</p></blockquote><h2 id="è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"><a href="#è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡" class="headerlink" title="è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"></a>è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</h2><h3 id="ä½¿ç”¨ç®¡é“"><a href="#ä½¿ç”¨ç®¡é“" class="headerlink" title="ä½¿ç”¨ç®¡é“"></a>ä½¿ç”¨ç®¡é“</h3><p>ç®¡é“æ˜¯FIFOçš„<br>ä¸‹é¢æ˜¯åˆ›å»ºä¸€ä¸ªåŒ¿åç®¡é“çš„ä»£ç </p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;errno.h&gt;#include &lt;unistd.h&gt;int main(int argc, char *argv[]){    if(argc &lt; 3){        fprintf(stderr, &quot;usage: %s parent_sendmsg child_sendmsg\n&quot;, argv[0]);        exit(EXIT_FAILURE);    }    int pipes[2];    if(pipe(pipes) &lt; 0){        perror(&quot;pipe&quot;);        exit(EXIT_FAILURE);    }    pid_t pid = fork();    if(pid &lt; 0){        perror(&quot;fork&quot;);        exit(EXIT_FAILURE);    }else if(pid &gt; 0){        char buf[BUFSIZ + 1];        int nbuf;        strcpy(buf, argv[1]);        write(pipes[1], buf, strlen(buf));        sleep(1); //è¿™é‡Œsleepæ˜¯ä¸ºäº†è®©å­è¿›ç¨‹æœ‰æ—¶é—´æŠŠç®¡é“ä¸­çš„æ•°æ®è¯»èµ°ï¼Œä¸ç„¶æ•°æ®å°±ä¼šè¢«åº•ä¸‹çš„çˆ¶è¿›ç¨‹çš„readè¯»èµ°.        //å› ä¸ºå®è´¨ä¸Šå†…æ ¸ä¸­åªæœ‰ä¸€ä¸ªç®¡é“ç¼“å†²åŒºï¼Œæ˜¯çˆ¶è¿›ç¨‹åˆ›å»ºçš„ï¼Œåªä¸è¿‡å­è¿›ç¨‹åŒæ—¶æ‹¥æœ‰äº†å®ƒçš„å¼•ç”¨        nbuf = read(pipes[0], buf, BUFSIZ);        buf[nbuf] = 0;        printf(&quot;parent_proc(%d) recv_from_child: %s\n&quot;, getpid(), buf);        close(pipes[0]);        close(pipes[1]);    }else if(pid == 0){        char buf[BUFSIZ + 1];        int nbuf = read(pipes[0], buf, BUFSIZ);        buf[nbuf] = 0;        printf(&quot;child_proc(%d) recv_from_parent: %s\n&quot;, getpid(), buf);        strcpy(buf, argv[2]);        write(pipes[1], buf, strlen(buf));        close(pipes[0]);        close(pipes[1]);    }    return 0;}</code></pre><blockquote><p>./a.out parent_say_tochild child_say_to_parent</p></blockquote><p>å®é™…ä¸­ä¸ºäº†å®ç°åŒå‘é€šä¿¡ï¼Œåº”è¯¥å‡†å¤‡ä¸¤æ ¹ç®¡é“ï¼Œä¸€æ ¹è´Ÿè´£ä»çˆ¶è¿›ç¨‹å¾€å­è¿›ç¨‹å†™æ•°æ®ï¼ˆåŒæ—¶å­è¿›ç¨‹ä»è¿™é‡Œè¯»å–æ•°æ®ï¼‰ï¼Œä¸€æ ¹è´Ÿè´£ä»å­è¿›ç¨‹å¾€çˆ¶è¿›ç¨‹å†™æ•°æ®ï¼ˆçˆ¶è¿›ç¨‹ä¹Ÿä»è¿™é‡Œè¯»æ•°æ®ï¼‰</p><p>ç®¡é“é»˜è®¤æ˜¯é˜»å¡æ¨¡å¼çš„ï¼Œfcntl(fd, F_SETFL, flags | O_NONBLOCK);å¯ä»¥è®¾ç½®éé˜»å¡çš„ç®¡é“ï¼Œè¿™ä¸ªè·Ÿsocketå¾ˆåƒã€‚</p><h3 id="å‘½åç®¡é“"><a href="#å‘½åç®¡é“" class="headerlink" title="å‘½åç®¡é“"></a>å‘½åç®¡é“</h3><p>ä¸Šé¢è¯´çš„åŒ¿åç®¡é“è¦æ±‚è¿™äº›è¿›ç¨‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªç¥–å…ˆåˆ›å»ºçš„ã€‚æ‰€ä»¥åœ¨ä¸ç›¸å¹²çš„è¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®å°±ä¸æ–¹ä¾¿äº†ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‘½åç®¡é“<br>å‘½åç®¡é“ä¹Ÿè¢«ç§°ä¸ºFIFOæ–‡ä»¶<br>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ä¹‹ä¸€æ¥åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼ŒåŸå‹å¦‚ä¸‹ï¼š</p><pre><code class="C">å¤´æ–‡ä»¶ï¼šsys/types.hã€sys/stat.hint mkfifo(const char *filename, mode_t mode);int mknod(const char *filename, mode_t mode | S_IFIFO, (dev_t)0);è¿”å›å€¼ï¼šæ‰§è¡ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½®errno</code></pre><p>æ³¨æ„è¿™æ ·çš„æ–¹å¼æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºäº†ä¸€ä¸ªçœŸå®çš„æ–‡ä»¶, å¯ä»¥å¯¹å…¶è¿›è¡Œè¯»å†™æ“ä½œ(æ³¨æ„ä¸èƒ½åŒæ—¶è¯»å†™)<br>sender.c</p><pre><code class="c">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;errno.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/stat.h&gt;#include &lt;fcntl.h&gt;int main(int argc, char *argv[]){    if(argc &lt; 3){        fprintf(stderr, &quot;usage: %s fifo_file filename\n&quot;, argv[0]);        exit(EXIT_FAILURE);    }    int fifo = open(argv[1], O_WRONLY);    if(fifo &lt; 0){        perror(&quot;open&quot;);        exit(EXIT_FAILURE);    }    FILE *fp = fopen(argv[2], &quot;rb&quot;);    if(fp == NULL){        perror(&quot;fopen&quot;);        exit(EXIT_FAILURE);    }    char buf[BUFSIZ];    int nbuf;    while((nbuf = fread(buf, 1, BUFSIZ, fp)) &gt; 0){        write(fifo, buf, nbuf);    }    fclose(fp);    close(fifo);    return 0;}</code></pre><p>receiver.c</p><pre><code class="c">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/stat.h&gt;#include &lt;fcntl.h&gt;#include &lt;errno.h&gt;int main(int argc, char *argv[]){    if(argc &lt; 3){        fprintf(stderr, &quot;usage: %s fifo_file filename\n&quot;, argv[0]);        exit(EXIT_FAILURE);    }    int fifo = open(argv[1], O_RDONLY);    if(fifo &lt; 0){        perror(&quot;fifo&quot;);        exit(EXIT_FAILURE);    }    FILE *fp = fopen(argv[2], &quot;wb&quot;);    if(fp == NULL){        perror(&quot;fopen&quot;);        exit(EXIT_FAILURE);    }    char buf[BUFSIZ];    int nbuf;    while((nbuf = read(fifo, buf, BUFSIZ)) &gt; 0){        printf(&quot;i got something %s\n&quot;, buf);        fwrite(buf, nbuf, 1, fp);    }    close(fifo);    fclose(fp);    return 0;}</code></pre><pre><code>mkfifo fifo ##ä½¿ç”¨mkfifoè¿™ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªç®¡é“æ–‡ä»¶./bin/sender fifo /var/log/syslog ###æŠŠ/var/log/syslogè¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„å†…å®¹è¯»å‡ºæ¥ï¼Œé€šè¿‡fifoè¿™ä¸ªæ–‡ä»¶ä¼ åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚æ³¨æ„åˆ°è¿™é‡Œå¡åœ¨è¿™é‡Œäº†./bin/receiver fifo syslog.copy ##ä»ç®¡é“æ–‡ä»¶ä¸­è¯»å–è¾“å‡ºï¼Œå†™åˆ°syslog.copyæ–‡ä»¶ä¸­.æ³¨æ„åˆ°è¿™é‡Œè¯»å®Œäº†ä¹‹åå‰é¢å¡ä½çš„è¿›ç¨‹æˆåŠŸé€€å‡ºäº†</code></pre><p>è¿™é‡Œè¿˜è¦æåˆ°å‘½åç®¡é“çš„å®‰å…¨é—®é¢˜ï¼Œæœ‰å¯èƒ½å­˜åœ¨å¤šä¸ªè¿›ç¨‹åŒæ—¶å¾€ä¸€ä¸ªFIFOæ–‡ä»¶å†™æ•°æ®ï¼Œè¿™æ ·ä¼šå­˜åœ¨æ•°æ®é¡ºåºé”™ä¹±çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯æ¯æ¬¡å†™å…¥çš„æ•°æ®çš„å¤§å°ä¿æŒåœ¨PIPE_BUFå¤§å°ä»¥å†…ï¼Œè¦ä¹ˆå…¨éƒ¨å†™å…¥ï¼Œè¦ä¹ˆä¸€ä¸ªå­—èŠ‚ä¹Ÿä¸å†™å…¥ã€‚</p><h2 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h2><p><strong><em>æ¦‚å¿µ:</em></strong></p><blockquote><p>ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜<br>é¡¾åæ€ä¹‰ï¼Œå…±äº«å†…å­˜å°±æ˜¯å…è®¸ä¸¤ä¸ªä¸ç›¸å…³çš„è¿›ç¨‹è®¿é—®åŒä¸€ä¸ªé€»è¾‘å†…å­˜ï¼›å…±äº«å†…å­˜æ˜¯åœ¨ä¸¤ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¹‹é—´å…±äº«å’Œä¼ é€’æ•°æ®çš„ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ–¹å¼ï¼›<br>ä¸åŒè¿›ç¨‹ä¹‹é—´å…±äº«çš„å†…å­˜é€šå¸¸å®‰æ’ä¸ºåŒä¸€æ®µç‰©ç†å†…å­˜ï¼Œè¿›ç¨‹å¯ä»¥å°†åŒä¸€æ®µå…±äº«å†…å­˜è¿æ¥åˆ°å®ƒä»¬è‡ªå·±çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥è®¿é—®å…±äº«å†…å­˜ä¸­çš„åœ°å€ï¼›<br>è€Œå¦‚æœæŸä¸ªè¿›ç¨‹å‘å…±äº«å†…å­˜å†™å…¥æ•°æ®ï¼Œæ‰€åšçš„æ”¹åŠ¨å°†ç«‹å³å½±å“åˆ°å¯ä»¥è®¿é—®åŒä¸€æ®µå…±äº«å†…å­˜çš„ä»»ä½•å…¶ä»–è¿›ç¨‹ï¼›<br>ç‰¹åˆ«æé†’ï¼šå…±äº«å†…å­˜å¹¶æœªæä¾›åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹ç»“æŸå¯¹å…±äº«å†…å­˜çš„å†™æ“ä½œä¹‹å‰ï¼Œå¹¶æ— è‡ªåŠ¨æœºåˆ¶å¯ä»¥é˜»æ­¢ç¬¬äºŒä¸ªè¿›ç¨‹å¼€å§‹å¯¹å®ƒè¿›è¡Œè¯»å–ï¼›æ‰€ä»¥æˆ‘ä»¬é€šå¸¸éœ€è¦ç”¨å…¶ä»–çš„æœºåˆ¶æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—®ï¼Œä¾‹å¦‚ä¿¡å·é‡ã€äº’æ–¥é”ï¼›</p></blockquote><p><strong><em>å…±äº«å†…å­˜çš„å‡½æ•°æ¥å£</em></strong><br><strong><br>å¤´æ–‡ä»¶ï¼šsys/types.hã€sys/ipc.hã€sys/shm.h<br>int shmget(key_t shm_key, size_t shm_size, int shm_flg);ï¼šåˆ›å»ºå…±äº«å†…å­˜<br>shm_keyç”¨æ¥æ ‡è¯†ä¸€å—å…±äº«å†…å­˜ï¼š<br>shm_sizeï¼šè¾“å…¥å‚æ•°ï¼Œå…±äº«å†…å­˜çš„å¤§å°ï¼ˆå•ä½ï¼šbyteï¼‰ï¼šæ³¨æ„å†…å­˜åˆ†é…çš„å•ä½æ˜¯é¡µï¼ˆä¸€èˆ¬ä¸º4kbï¼Œå¯é€šè¿‡getpagesize()è·å–ï¼‰ï¼›ä¹Ÿå°±æ˜¯è¯´å¦‚æœshm_sizeä¸º1ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ†é…4096å­—èŠ‚çš„å†…å­˜ï¼›åªè·å–å…±äº«å†…å­˜æ—¶ï¼Œshm_sizeå¯æŒ‡å®šä¸º0ï¼›</strong></p><h2 id="Unix-domain-socket"><a href="#Unix-domain-socket" class="headerlink" title="Unix domain socket"></a>Unix domain socket</h2><p>socketåŸæœ¬æ˜¯ä¸ºäº†ç½‘ç»œé€šè®¯è®¾è®¡çš„ï¼Œä½†æ˜¯åæ¥åœ¨socketçš„æ¡†æ¶ä¸Šå‘å±•å‡ºä¸€ç§IPCæœºåˆ¶ï¼Œå°±æ˜¯UNIX Domain Socketï¼›<br>è™½ç„¶ç½‘ç»œsocketä¹Ÿå¯ç”¨äºåŒä¸€å°ä¸»æœºçš„è¿›ç¨‹é—´é€šè®¯ï¼ˆé€šè¿‡loopbackåœ°å€127.0.0.1ï¼‰ï¼Œä½†æ˜¯UNIX Domain Socketç”¨äºIPCæ›´æœ‰æ•ˆç‡ï¼š</p><ol><li>ä¸éœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼›</li><li>ä¸éœ€è¦æ‰“åŒ…æ‹†åŒ…ï¼›</li><li>ä¸éœ€è¦è®¡ç®—æ ¡éªŒå’Œï¼›</li><li>ä¸éœ€è¦ç»´æŠ¤åºå·å’Œåº”ç­”ï¼›</li></ol><p>è¿™æ˜¯å› ä¸ºIPCæœºåˆ¶æœ¬è´¨ä¸Šæ˜¯å¯é çš„é€šè®¯ï¼Œè€Œç½‘ç»œåè®®æ˜¯ä¸ºä¸å¯é çš„é€šè®¯è®¾è®¡çš„ï¼›<br>UNIX Domain Socketä¹Ÿæä¾›é¢å‘æµå’Œé¢å‘æ•°æ®æŠ¥ä¸¤ç§APIæ¥å£ï¼Œç±»ä¼¼TCPå’ŒUDPï¼Œä½†æ˜¯é¢å‘æ•°æ®æŠ¥çš„UNIX Domain Socketä¹Ÿæ˜¯å¯é çš„ï¼Œæ¶ˆæ¯æ—¢ä¸ä¼šä¸¢å¤±ä¹Ÿä¸ä¼šé¡ºåºé”™ä¹±ï¼›<br>ä½¿ç”¨UNIX Domain Socketçš„è¿‡ç¨‹å’Œç½‘ç»œsocketååˆ†ç›¸ä¼¼ï¼Œä¹Ÿè¦å…ˆè°ƒç”¨socket()åˆ›å»ºä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œaddress familyæŒ‡å®šä¸ºAF_UNIXï¼Œtypeå¯ä»¥é€‰æ‹©SOCK_STREAMæˆ–SOCK_DGRAMï¼Œprotocolå‚æ•°ä»ç„¶æŒ‡å®šä¸º0å³å¯ï¼›<br>UNIX Domain Socketä¸ç½‘ç»œsocketç¼–ç¨‹æœ€æ˜æ˜¾çš„ä¸åŒåœ¨äºåœ°å€æ ¼å¼ä¸åŒï¼Œç”¨ç»“æ„ä½“<code>sockaddr_un</code>è¡¨ç¤ºï¼›<br>ç½‘ç»œç¼–ç¨‹çš„socketåœ°å€æ˜¯IPåœ°å€åŠ ç«¯å£å·ï¼Œè€ŒUNIX Domain Socketçš„åœ°å€æ˜¯ä¸€ä¸ªsocketç±»å‹çš„æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œè¿™ä¸ªsocketæ–‡ä»¶ç”±bind()è°ƒç”¨åˆ›å»ºï¼Œå¦‚æœè°ƒç”¨bind()æ—¶è¯¥æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™bind()é”™è¯¯è¿”å›ï¼›</p><p>unix_domain_server.c</p><pre><code class="C">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;errno.h&gt;#include &lt;unistd.h&gt;#include &lt;ctype.h&gt;#include &lt;sys/stat.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;sys/un.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;netinet/in.h&gt;#include &lt;netinet/tcp.h&gt;#include &lt;netdb.h&gt;#include &lt;fcntl.h&gt;#include &lt;sys/ioctl.h&gt;#include &lt;signal.h&gt;#include &lt;sys/wait.h&gt;#define SOCK_PATH &quot;/run/echo.sock&quot;#define BUF_SIZE 1024int listenfd;void handle_signal(int signo);int main(void){    signal(SIGINT, handle_signal);    signal(SIGHUP, handle_signal);    signal(SIGTERM, handle_signal);    if((listenfd = socket(AF_UNIX, SOCK_STREAM, 0)) &lt; 0){        perror(&quot;socket&quot;);        exit(EXIT_FAILURE);    }    struct sockaddr_un servaddr;    memset(&amp;servaddr, 0, sizeof(servaddr));    servaddr.sun_family = AF_UNIX;    strcpy(servaddr.sun_path, SOCK_PATH);    unlink(SOCK_PATH);    if(bind(listenfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) &lt; 0){ //å› ä¸ºè¿™é‡Œè¦åœ¨/var/ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œè¿™ä¸ªç¨‹åºéœ€è¦sudoè¿è¡Œ        perror(&quot;bind&quot;);        exit(EXIT_FAILURE);    }    chmod(SOCK_PATH, 00640);    if(listen(listenfd, SOMAXCONN) &lt; 0){        perror(&quot;listen&quot;);        exit(EXIT_FAILURE);    }    int connfd, nbuf;    char buf[BUF_SIZE + 1];    for(;;){        if((connfd = accept(listenfd, NULL, NULL)) &lt; 0){            perror(&quot;accept&quot;);            continue;        }        nbuf = recv(connfd, buf, BUF_SIZE, 0);        buf[nbuf] = 0;        printf(&quot;new msg: \&quot;%s\&quot;\n&quot;, buf);        send(connfd, buf, nbuf, 0);        close(connfd);    }    return 0;}void handle_signal(int signo){    if(signo == SIGINT){        fprintf(stderr, &quot;received signal: SIGINT(%d)\n&quot;, signo);    }else if(signo == SIGHUP){        fprintf(stderr, &quot;received signal: SIGHUP(%d)\n&quot;, signo);    }else if(signo == SIGTERM){        fprintf(stderr, &quot;received signal: SIGTERM(%d)\n&quot;, signo);    }    close(listenfd);    unlink(SOCK_PATH);    exit(EXIT_SUCCESS);}</code></pre><p>unix_domain_client.c</p><pre><code class="c">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;errno.h&gt;#include &lt;unistd.h&gt;#include &lt;ctype.h&gt;#include &lt;sys/stat.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;sys/un.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;netinet/in.h&gt;#include &lt;netinet/tcp.h&gt;#include &lt;netdb.h&gt;#include &lt;fcntl.h&gt;#include &lt;sys/ioctl.h&gt;#include &lt;signal.h&gt;#include &lt;sys/wait.h&gt;#define SOCK_PATH &quot;/run/echo.sock&quot;#define BUF_SIZE 1024int main(int argc, char *argv[]){    if(argc &lt; 2){        fprintf(stderr, &quot;usage: %s msg\n&quot;, argv[0]);        exit(EXIT_FAILURE);    }    int sockfd;    if((sockfd = socket(AF_UNIX, SOCK_STREAM, 0)) &lt; 0){        perror(&quot;socket&quot;);        exit(EXIT_FAILURE);    }    struct sockaddr_un servaddr;    memset(&amp;servaddr, 0, sizeof(servaddr));    servaddr.sun_family = AF_UNIX;    strcpy(servaddr.sun_path, SOCK_PATH);    if(connect(sockfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) &lt; 0){        perror(&quot;connect&quot;);        exit(EXIT_FAILURE);    }    char buf[BUF_SIZE + 1];    int nbuf;    nbuf = strlen(argv[1]);    send(sockfd, argv[1], nbuf, 0);    nbuf = recv(sockfd, buf, BUF_SIZE, 0);    buf[nbuf] = 0;    printf(&quot;echo msg: \&quot;%s\&quot;\n&quot;, buf);    close(sockfd);    return 0;}</code></pre><p>ä¸Šè¿°ç¨‹åºå®ç°äº†é€šè¿‡uninx domain socketçš„client-server æ•°æ®ä¼ è¾“ï¼Œå°±åƒæ˜¯é€šè¿‡/var/echo.sockè¿™ä¸ªæ–‡ä»¶ä¼ è¾“æ•°æ®ã€‚å°è±¡ä¸­uwsiä¹Ÿæ˜¯è¿™æ ·å®ç°nginxå’Œdjangoè¿›ç¨‹çš„é€šä¿¡ã€‚</p><h3 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h3><p>ä¿¡å·é‡æ˜¯ç”¨æ¥è°ƒåè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®çš„ï¼Œç¨‹åºå¯¹ä¿¡å·é‡çš„æ“ä½œéƒ½æ˜¯<code>åŸå­æ“ä½œ</code>ï¼Œå¹¶ä¸”åªèƒ½å¯¹å®ƒè¿›è¡Œç­‰å¾…å’Œå‘é€æ“ä½œã€‚<br>å½“è¯·æ±‚ä¸€ä¸ªä½¿ç”¨ä¿¡å·é‡æ¥è¡¨ç¤ºçš„èµ„æºæ—¶ï¼Œè¿›ç¨‹éœ€è¦å…ˆè¯»å–ä¿¡å·é‡çš„å€¼æ¥åˆ¤æ–­èµ„æºæ˜¯å¦å¯ç”¨ã€‚å¤§äº0ï¼Œèµ„æºå¯ä»¥è¯·æ±‚ï¼Œç­‰äº0ï¼Œæ— èµ„æºå¯ç”¨ï¼Œè¿›ç¨‹ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ç›´è‡³èµ„æºå¯ç”¨ã€‚<br>å½“è¿›ç¨‹ä¸å†ä½¿ç”¨ä¸€ä¸ªä¿¡å·é‡æ§åˆ¶çš„å…±äº«èµ„æºæ—¶ï¼Œä¿¡å·é‡çš„å€¼+1ï¼Œå¯¹ä¿¡å·é‡çš„å€¼è¿›è¡Œçš„å¢å‡<br>æ“ä½œå‡ä¸ºåŸå­æ“ä½œï¼Œè¿™æ˜¯ç”±äºä¿¡å·é‡ä¸»è¦çš„ä½œç”¨æ˜¯ç»´æŠ¤èµ„æºçš„äº’æ–¥æˆ–å¤šè¿›ç¨‹çš„åŒæ­¥è®¿é—®ã€‚è€Œåœ¨ä¿¡å·é‡çš„åˆ›å»ºåŠåˆå§‹åŒ–ä¸Šï¼Œä¸èƒ½ä¿è¯æ“ä½œå‡ä¸ºåŸå­æ€§ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><strong>ç°åœ¨æŠŠè¿›ç¨‹ä¹‹é—´ä¼ é€’ä¿¡æ¯çš„å„ç§é€”å¾„ï¼ˆåŒ…æ‹¬å„ç§IPCæœºåˆ¶ï¼‰æ€»ç»“å¦‚ä¸‹ï¼š<br>çˆ¶è¿›ç¨‹é€šè¿‡forkå¯ä»¥å°†æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦ä¼ é€’ç»™å­è¿›ç¨‹<br>å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨waitå¯ä»¥å¾—åˆ°å­è¿›ç¨‹çš„ç»ˆæ­¢ä¿¡æ¯<br>å‡ ä¸ªè¿›ç¨‹å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å†™æŸä¸ªå…±äº«æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç»™æ–‡ä»¶åŠ é”æ¥å®ç°è¿›ç¨‹é—´åŒæ­¥<br>è¿›ç¨‹ä¹‹é—´äº’å‘ä¿¡å·ï¼Œä¸€èˆ¬ä½¿ç”¨SIGUSR1å’ŒSIGUSR2å®ç°ç”¨æˆ·è‡ªå®šä¹‰åŠŸèƒ½<br>ç®¡é“<br>FIFO<br>mmapå‡½æ•°ï¼Œå‡ ä¸ªè¿›ç¨‹å¯ä»¥æ˜ å°„åŒä¸€å†…å­˜åŒº<br>SYS V IPCï¼Œä»¥å‰çš„SYS V UNIXç³»ç»Ÿå®ç°çš„IPCæœºåˆ¶ï¼ŒåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡å’Œå…±äº«å†…å­˜ï¼Œç°åœ¨å·²ç»åŸºæœ¬åºŸå¼ƒ<br>Linuxå†…æ ¸ç»§æ‰¿å’Œå…¼å®¹äº†ä¸°å¯Œçš„Unixç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ã€‚æœ‰ä¼ ç»Ÿçš„ç®¡é“ï¼ˆPipeï¼‰ã€ä¿¡å·ï¼ˆSignalï¼‰å’Œè·Ÿè¸ªï¼ˆTraceï¼‰ï¼Œè¿™ä¸‰é¡¹é€šä¿¡æ‰‹æ®µåªèƒ½ç”¨äºçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´ï¼Œæˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼›åæ¥åˆå¢åŠ äº†å‘½ä»¤ç®¡é“ï¼ˆNamed Pipeï¼‰ï¼Œä½¿å¾—è¿›ç¨‹é—´é€šä¿¡ä¸å†å±€é™äºçˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼›ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå•†ä¸šåº”ç”¨ä¸­çš„äº‹åŠ¡å¤„ç†ï¼Œåœ¨AT&amp;Tçš„Unixç³»ç»ŸVä¸­ï¼Œåˆå¢åŠ äº†ä¸‰ç§ç§°ä¸ºâ€œSystem V IPCâ€çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯æŠ¥æ–‡é˜Ÿåˆ—ï¼ˆMessageï¼‰ã€å…±äº«å†…å­˜ï¼ˆShare Memoryï¼‰å’Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼›åæ¥BSD Unixå¯¹â€œSystem V IPCâ€æœºåˆ¶è¿›è¡Œäº†é‡è¦çš„æ‰©å……ï¼Œæä¾›äº†ä¸€ç§ç§°ä¸ºæ’å£ï¼ˆSocketï¼‰çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ã€‚<br>UNIX Domain Socketæ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„IPCæœºåˆ¶</strong></p><p><a href="https://www.zhihu.com/question/39440766/answer/89210950">Linuxç°æœ‰çš„æ‰€æœ‰è¿›ç¨‹é—´IPCæ–¹å¼</a></p><ol><li>ç®¡é“ï¼šåœ¨åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªpageå¤§å°çš„å†…å­˜ï¼Œç¼“å­˜åŒºå¤§å°æ¯”è¾ƒæœ‰é™ï¼›</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿¡æ¯å¤åˆ¶ä¸¤æ¬¡ï¼Œé¢å¤–çš„CPUæ¶ˆè€—ï¼›ä¸åˆé€‚é¢‘ç¹æˆ–ä¿¡æ¯é‡å¤§çš„é€šä¿¡ï¼›</li><li>å…±äº«å†…å­˜ï¼šæ— é¡»å¤åˆ¶ï¼Œå…±äº«ç¼“å†²åŒºç›´æ¥ä»˜é™„åŠ åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œé€Ÿåº¦å¿«ï¼›ä½†è¿›ç¨‹é—´çš„åŒæ­¥é—®é¢˜æ“ä½œç³»ç»Ÿæ— æ³•å®ç°ï¼Œå¿…é¡»å„è¿›ç¨‹åˆ©ç”¨åŒæ­¥å·¥å…·è§£å†³ï¼›</li><li>å¥—æ¥å­—ï¼šä½œä¸ºæ›´é€šç”¨çš„æ¥å£ï¼Œä¼ è¾“æ•ˆç‡ä½ï¼Œä¸»è¦ç”¨äºä¸é€šæœºå™¨æˆ–è·¨ç½‘ç»œçš„é€šä¿¡ï¼›</li><li>ä¿¡å·é‡ï¼šå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚</li><li>ä¿¡å·: ä¸é€‚ç”¨äºä¿¡æ¯äº¤æ¢ï¼Œæ›´é€‚ç”¨äºè¿›ç¨‹ä¸­æ–­æ§åˆ¶ï¼Œæ¯”å¦‚éæ³•å†…å­˜è®¿é—®ï¼Œæ€æ­»æŸä¸ªè¿›ç¨‹ç­‰ï¼›</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.zfl9.com/c-multi-proc.html">cè¯­è¨€å¤šè¿›ç¨‹ç¼–ç¨‹</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;&lt;em&gt;è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½&lt;/em&gt;&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://api1.foster66.xyz/static/imgs/Prayercard_ZH-CN13472871640_1920x1080.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡å¤šæ•°æ¥è‡ª&lt;a href=&quot;https://www.zfl9.com/c-multi-proc.html&quot;&gt;cè¯­è¨€å¤šè¿›ç¨‹ç¼–ç¨‹&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å½“Linuxå¯åŠ¨çš„æ—¶å€™ï¼Œinitæ˜¯ç³»ç»Ÿåˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸€è¿›ç¨‹ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æˆ‘ä»¬å…³é—­è®¡ç®—æœºï¼›è™½ç„¶åé¢systemdå–ä»£äº†initè¿›ç¨‹ã€‚åé¢çš„æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯initè¿›ç¨‹forkå‡ºæ¥çš„,linuxä¸‹ä½¿ç”¨pstreeå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ä»¥systemdä¸ºæ ¹èŠ‚ç‚¹çš„&lt;br&gt;å½“è¿›ç¨‹è°ƒç”¨forkçš„æ—¶å€™ï¼ŒLinuxåœ¨å†…å­˜ä¸­å¼€è¾Ÿå‡ºä¸€ç‰‡æ–°çš„å†…å­˜ç©ºé—´ç»™æ–°çš„è¿›ç¨‹ï¼Œå¹¶å°†è€çš„è¿›ç¨‹ç©ºé—´ä¸­çš„å†…å®¹å¤åˆ¶åˆ°æ–°çš„ç©ºé—´ä¸­ï¼Œæ­¤åä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œï¼›è€è¿›ç¨‹æˆä¸ºæ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹(parent process)ï¼Œè€Œç›¸åº”çš„ï¼Œæ–°è¿›ç¨‹å°±æ˜¯è€è¿›ç¨‹çš„å­è¿›ç¨‹(child process)ï¼›&lt;/p&gt;
    
    </summary>
    
    
      <category term="linux" scheme="https://haldir65.github.io/tags/linux/"/>
    
      <category term="c" scheme="https://haldir65.github.io/tags/c/"/>
    
  </entry>
  
</feed>
